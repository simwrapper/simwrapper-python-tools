function Os(s,e){if(!s)throw new Error(e||"loader assertion failed.")}const xr=!!(typeof process!="object"||String(process)!=="[object process]"||process.browser),ui=typeof process<"u"&&process.version&&/v([0-9]*)/.exec(process.version);ui&&parseFloat(ui[1]);const hi=globalThis,fi=globalThis.process||{},Ol=globalThis.navigator||{};function ua(s){if(typeof window<"u"&&window.process?.type==="renderer"||typeof process<"u"&&process.versions?.electron)return!0;const t=typeof navigator<"u"&&navigator.userAgent;return!!(t&&t.indexOf("Electron")>=0)}function ht(){return!(typeof process=="object"&&String(process)==="[object process]"&&!process?.browser)||ua()}function kl(s){return ht()?ua()?"Electron":(Ol.userAgent||"").indexOf("Edge")>-1?"Edge":globalThis.chrome?"Chrome":globalThis.safari?"Safari":globalThis.mozInnerScreenX?"Firefox":"Unknown":"Node"}const ha="4.1.0";function Nl(s){try{const e=window[s],t="__storage_test__";return e.setItem(t,t),e.removeItem(t),e}catch{return null}}class Dl{constructor(e,t,n="sessionStorage"){this.storage=Nl(n),this.id=e,this.config=t,this._loadConfiguration()}getConfiguration(){return this.config}setConfiguration(e){if(Object.assign(this.config,e),this.storage){const t=JSON.stringify(this.config);this.storage.setItem(this.id,t)}}_loadConfiguration(){let e={};if(this.storage){const t=this.storage.getItem(this.id);e=t?JSON.parse(t):{}}return Object.assign(this.config,e),this}}function Fl(s){let e;return s<10?e=`${s.toFixed(2)}ms`:s<100?e=`${s.toFixed(1)}ms`:s<1e3?e=`${s.toFixed(0)}ms`:e=`${(s/1e3).toFixed(2)}s`,e}function Bl(s,e=8){const t=Math.max(e-s.length,0);return`${" ".repeat(t)}${s}`}var ks;(function(s){s[s.BLACK=30]="BLACK",s[s.RED=31]="RED",s[s.GREEN=32]="GREEN",s[s.YELLOW=33]="YELLOW",s[s.BLUE=34]="BLUE",s[s.MAGENTA=35]="MAGENTA",s[s.CYAN=36]="CYAN",s[s.WHITE=37]="WHITE",s[s.BRIGHT_BLACK=90]="BRIGHT_BLACK",s[s.BRIGHT_RED=91]="BRIGHT_RED",s[s.BRIGHT_GREEN=92]="BRIGHT_GREEN",s[s.BRIGHT_YELLOW=93]="BRIGHT_YELLOW",s[s.BRIGHT_BLUE=94]="BRIGHT_BLUE",s[s.BRIGHT_MAGENTA=95]="BRIGHT_MAGENTA",s[s.BRIGHT_CYAN=96]="BRIGHT_CYAN",s[s.BRIGHT_WHITE=97]="BRIGHT_WHITE"})(ks||(ks={}));const Ul=10;function di(s){return typeof s!="string"?s:(s=s.toUpperCase(),ks[s]||ks.WHITE)}function Ll(s,e,t){return!ht&&typeof s=="string"&&(e&&(s=`\x1B[${di(e)}m${s}\x1B[39m`),t&&(s=`\x1B[${di(t)+Ul}m${s}\x1B[49m`)),s}function Vl(s,e=["constructor"]){const t=Object.getPrototypeOf(s),n=Object.getOwnPropertyNames(t),r=s;for(const i of n){const o=r[i];typeof o=="function"&&(e.find(a=>i===a)||(r[i]=o.bind(s)))}}function Er(s,e){if(!s)throw new Error("Assertion failed")}function pt(){let s;if(ht()&&hi.performance)s=hi?.performance?.now?.();else if("hrtime"in fi){const e=fi?.hrtime?.();s=e[0]*1e3+e[1]/1e6}else s=Date.now();return s}const gt={debug:ht()&&console.debug||console.log,log:console.log,info:console.info,warn:console.warn,error:console.error},$l={enabled:!0,level:0};function _t(){}const pi={},gi={once:!0};class os{constructor({id:e}={id:""}){this.VERSION=ha,this._startTs=pt(),this._deltaTs=pt(),this.userData={},this.LOG_THROTTLE_TIMEOUT=0,this.id=e,this.userData={},this._storage=new Dl(`__probe-${this.id}__`,$l),this.timeStamp(`${this.id} started`),Vl(this),Object.seal(this)}set level(e){this.setLevel(e)}get level(){return this.getLevel()}isEnabled(){return this._storage.config.enabled}getLevel(){return this._storage.config.level}getTotal(){return Number((pt()-this._startTs).toPrecision(10))}getDelta(){return Number((pt()-this._deltaTs).toPrecision(10))}set priority(e){this.level=e}get priority(){return this.level}getPriority(){return this.level}enable(e=!0){return this._storage.setConfiguration({enabled:e}),this}setLevel(e){return this._storage.setConfiguration({level:e}),this}get(e){return this._storage.config[e]}set(e,t){this._storage.setConfiguration({[e]:t})}settings(){console.table?console.table(this._storage.config):console.log(this._storage.config)}assert(e,t){if(!e)throw new Error(t||"Assertion failed")}warn(e){return this._getLogFunction(0,e,gt.warn,arguments,gi)}error(e){return this._getLogFunction(0,e,gt.error,arguments)}deprecated(e,t){return this.warn(`\`${e}\` is deprecated and will be removed in a later version. Use \`${t}\` instead`)}removed(e,t){return this.error(`\`${e}\` has been removed. Use \`${t}\` instead`)}probe(e,t){return this._getLogFunction(e,t,gt.log,arguments,{time:!0,once:!0})}log(e,t){return this._getLogFunction(e,t,gt.debug,arguments)}info(e,t){return this._getLogFunction(e,t,console.info,arguments)}once(e,t){return this._getLogFunction(e,t,gt.debug||gt.info,arguments,gi)}table(e,t,n){return t?this._getLogFunction(e,t,console.table||_t,n&&[n],{tag:jl(t)}):_t}time(e,t){return this._getLogFunction(e,t,console.time?console.time:console.info)}timeEnd(e,t){return this._getLogFunction(e,t,console.timeEnd?console.timeEnd:console.info)}timeStamp(e,t){return this._getLogFunction(e,t,console.timeStamp||_t)}group(e,t,n={collapsed:!1}){const r=_i({logLevel:e,message:t,opts:n}),{collapsed:i}=n;return r.method=(i?console.groupCollapsed:console.group)||console.info,this._getLogFunction(r)}groupCollapsed(e,t,n={}){return this.group(e,t,Object.assign({},n,{collapsed:!0}))}groupEnd(e){return this._getLogFunction(e,"",console.groupEnd||_t)}withGroup(e,t,n){this.group(e,t)();try{n()}finally{this.groupEnd(e)()}}trace(){console.trace&&console.trace()}_shouldLog(e){return this.isEnabled()&&this.getLevel()>=fa(e)}_getLogFunction(e,t,n,r,i){if(this._shouldLog(e)){i=_i({logLevel:e,message:t,args:r,opts:i}),n=n||i.method,Er(n),i.total=this.getTotal(),i.delta=this.getDelta(),this._deltaTs=pt();const o=i.tag||i.message;if(i.once&&o)if(!pi[o])pi[o]=pt();else return _t;return t=Wl(this.id,i.message,i),n.bind(console,t,...i.args)}return _t}}os.VERSION=ha;function fa(s){if(!s)return 0;let e;switch(typeof s){case"number":e=s;break;case"object":e=s.logLevel||s.priority||0;break;default:return 0}return Er(Number.isFinite(e)&&e>=0),e}function _i(s){const{logLevel:e,message:t}=s;s.logLevel=fa(e);const n=s.args?Array.from(s.args):[];for(;n.length&&n.shift()!==t;);switch(typeof e){case"string":case"function":t!==void 0&&n.unshift(t),s.message=e;break;case"object":Object.assign(s,e);break}typeof s.message=="function"&&(s.message=s.message());const r=typeof s.message;return Er(r==="string"||r==="object"),Object.assign(s,{args:n},s.opts)}function Wl(s,e,t){if(typeof e=="string"){const n=t.time?Bl(Fl(t.total)):"";e=t.time?`${s}: ${n}  ${e}`:`${s}: ${e}`,e=Ll(e,t.color,t.background)}return e}function jl(s){for(const e in s)for(const t in s[e])return t||"untitled";return"empty"}const fn="4.3.3",Hl=fn[0]>="0"&&fn[0]<="9"?`v${fn}`:"";function zl(){const s=new os({id:"loaders.gl"});return globalThis.loaders=globalThis.loaders||{},globalThis.loaders.log=s,globalThis.loaders.version=Hl,globalThis.probe=globalThis.probe||{},globalThis.probe.loaders=s,s}const Xl=zl();function Yl(s,e){return da(s||{},e)}function da(s,e,t=0){if(t>3)return e;const n={...s};for(const[r,i]of Object.entries(e))i&&typeof i=="object"&&!Array.isArray(i)?n[r]=da(n[r]||{},e[r],t+1):n[r]=e[r];return n}const ql="latest";function Kl(){return globalThis._loadersgl_?.version||(globalThis._loadersgl_=globalThis._loadersgl_||{},globalThis._loadersgl_.version="4.3.3"),globalThis._loadersgl_.version}const Zl=Kl();function Qe(s,e){if(!s)throw new Error(e||"loaders.gl assertion failed.")}const nt=typeof process!="object"||String(process)!=="[object process]"||process.browser,Ql=typeof window<"u"&&typeof window.orientation<"u",mi=typeof process<"u"&&process.version&&/v([0-9]*)/.exec(process.version);mi&&parseFloat(mi[1]);class Jl{name;workerThread;isRunning=!0;result;_resolve=()=>{};_reject=()=>{};constructor(e,t){this.name=e,this.workerThread=t,this.result=new Promise((n,r)=>{this._resolve=n,this._reject=r})}postMessage(e,t){this.workerThread.postMessage({source:"loaders.gl",type:e,payload:t})}done(e){Qe(this.isRunning),this.isRunning=!1,this._resolve(e)}error(e){Qe(this.isRunning),this.isRunning=!1,this._reject(e)}}class dn{terminate(){}}const pn=new Map;function Gl(s){Qe(s.source&&!s.url||!s.source&&s.url);let e=pn.get(s.source||s.url);return e||(s.url&&(e=eu(s.url),pn.set(s.url,e)),s.source&&(e=pa(s.source),pn.set(s.source,e))),Qe(e),e}function eu(s){if(!s.startsWith("http"))return s;const e=tu(s);return pa(e)}function pa(s){const e=new Blob([s],{type:"application/javascript"});return URL.createObjectURL(e)}function tu(s){return`try {
  importScripts('${s}');
} catch (error) {
  console.error(error);
  throw error;
}`}function ga(s,e=!0,t){const n=t||new Set;if(s){if(bi(s))n.add(s);else if(bi(s.buffer))n.add(s.buffer);else if(!ArrayBuffer.isView(s)){if(e&&typeof s=="object")for(const r in s)ga(s[r],e,n)}}return t===void 0?Array.from(n):[]}function bi(s){return s?s instanceof ArrayBuffer||typeof MessagePort<"u"&&s instanceof MessagePort||typeof ImageBitmap<"u"&&s instanceof ImageBitmap||typeof OffscreenCanvas<"u"&&s instanceof OffscreenCanvas:!1}const gn=()=>{};class zn{name;source;url;terminated=!1;worker;onMessage;onError;_loadableURL="";static isSupported(){return typeof Worker<"u"&&nt||typeof dn<"u"&&!nt}constructor(e){const{name:t,source:n,url:r}=e;Qe(n||r),this.name=t,this.source=n,this.url=r,this.onMessage=gn,this.onError=i=>console.log(i),this.worker=nt?this._createBrowserWorker():this._createNodeWorker()}destroy(){this.onMessage=gn,this.onError=gn,this.worker.terminate(),this.terminated=!0}get isRunning(){return!!this.onMessage}postMessage(e,t){t=t||ga(e),this.worker.postMessage(e,t)}_getErrorFromErrorEvent(e){let t="Failed to load ";return t+=`worker ${this.name} from ${this.url}. `,e.message&&(t+=`${e.message} in `),e.lineno&&(t+=`:${e.lineno}:${e.colno}`),new Error(t)}_createBrowserWorker(){this._loadableURL=Gl({source:this.source,url:this.url});const e=new Worker(this._loadableURL,{name:this.name});return e.onmessage=t=>{t.data?this.onMessage(t.data):this.onError(new Error("No data received"))},e.onerror=t=>{this.onError(this._getErrorFromErrorEvent(t)),this.terminated=!0},e.onmessageerror=t=>console.error(t),e}_createNodeWorker(){let e;if(this.url){const n=this.url.includes(":/")||this.url.startsWith("/")?this.url:`./${this.url}`;e=new dn(n,{eval:!1})}else if(this.source)e=new dn(this.source,{eval:!0});else throw new Error("no worker");return e.on("message",t=>{this.onMessage(t)}),e.on("error",t=>{this.onError(t)}),e.on("exit",t=>{}),e}}class su{name="unnamed";source;url;maxConcurrency=1;maxMobileConcurrency=1;onDebug=()=>{};reuseWorkers=!0;props={};jobQueue=[];idleQueue=[];count=0;isDestroyed=!1;static isSupported(){return zn.isSupported()}constructor(e){this.source=e.source,this.url=e.url,this.setProps(e)}destroy(){this.idleQueue.forEach(e=>e.destroy()),this.isDestroyed=!0}setProps(e){this.props={...this.props,...e},e.name!==void 0&&(this.name=e.name),e.maxConcurrency!==void 0&&(this.maxConcurrency=e.maxConcurrency),e.maxMobileConcurrency!==void 0&&(this.maxMobileConcurrency=e.maxMobileConcurrency),e.reuseWorkers!==void 0&&(this.reuseWorkers=e.reuseWorkers),e.onDebug!==void 0&&(this.onDebug=e.onDebug)}async startJob(e,t=(r,i,o)=>r.done(o),n=(r,i)=>r.error(i)){const r=new Promise(i=>(this.jobQueue.push({name:e,onMessage:t,onError:n,onStart:i}),this));return this._startQueuedJob(),await r}async _startQueuedJob(){if(!this.jobQueue.length)return;const e=this._getAvailableWorker();if(!e)return;const t=this.jobQueue.shift();if(t){this.onDebug({message:"Starting job",name:t.name,workerThread:e,backlog:this.jobQueue.length});const n=new Jl(t.name,e);e.onMessage=r=>t.onMessage(n,r.type,r.payload),e.onError=r=>t.onError(n,r),t.onStart(n);try{await n.result}catch(r){console.error(`Worker exception: ${r}`)}finally{this.returnWorkerToQueue(e)}}}returnWorkerToQueue(e){!nt||this.isDestroyed||!this.reuseWorkers||this.count>this._getMaxConcurrency()?(e.destroy(),this.count--):this.idleQueue.push(e),this.isDestroyed||this._startQueuedJob()}_getAvailableWorker(){if(this.idleQueue.length>0)return this.idleQueue.shift()||null;if(this.count<this._getMaxConcurrency()){this.count++;const e=`${this.name.toLowerCase()} (#${this.count} of ${this.maxConcurrency})`;return new zn({name:e,source:this.source,url:this.url})}return null}_getMaxConcurrency(){return Ql?this.maxMobileConcurrency:this.maxConcurrency}}const nu={maxConcurrency:3,maxMobileConcurrency:1,reuseWorkers:!0,onDebug:()=>{}};class ze{props;workerPools=new Map;static _workerFarm;static isSupported(){return zn.isSupported()}static getWorkerFarm(e={}){return ze._workerFarm=ze._workerFarm||new ze({}),ze._workerFarm.setProps(e),ze._workerFarm}constructor(e){this.props={...nu},this.setProps(e),this.workerPools=new Map}destroy(){for(const e of this.workerPools.values())e.destroy();this.workerPools=new Map}setProps(e){this.props={...this.props,...e};for(const t of this.workerPools.values())t.setProps(this._getWorkerPoolProps())}getWorkerPool(e){const{name:t,source:n,url:r}=e;let i=this.workerPools.get(t);return i||(i=new su({name:t,source:n,url:r}),i.setProps(this._getWorkerPoolProps()),this.workerPools.set(t,i)),i}_getWorkerPoolProps(){return{maxConcurrency:this.props.maxConcurrency,maxMobileConcurrency:this.props.maxMobileConcurrency,reuseWorkers:this.props.reuseWorkers,onDebug:this.props.onDebug}}}function ru(s,e={}){const t=e[s.id]||{},n=nt?`${s.id}-worker.js`:`${s.id}-worker-node.js`;let r=t.workerUrl;if(!r&&s.id==="compression"&&(r=e.workerUrl),e._workerType==="test"&&(nt?r=`modules/${s.module}/dist/${n}`:r=`modules/${s.module}/src/workers/${s.id}-worker-node.ts`),!r){let i=s.version;i==="latest"&&(i=ql);const o=i?`@${i}`:"";r=`https://unpkg.com/@loaders.gl/${s.module}${o}/dist/${n}`}return Qe(r),r}function iu(s,e=Zl){Qe(s,"no worker provided");const t=s.version;return!(!e||!t)}function ou(s,e){return!ze.isSupported()||!nt&&!e?._nodeWorkers?!1:s.worker&&e?.worker}async function au(s,e,t,n,r){const i=s.id,o=ru(s,t),c=ze.getWorkerFarm(t).getWorkerPool({name:i,url:o});t=JSON.parse(JSON.stringify(t)),n=JSON.parse(JSON.stringify(n||{}));const l=await c.startJob("process-on-worker",cu.bind(null,r));return l.postMessage("process",{input:e,options:t,context:n}),await(await l.result).result}async function cu(s,e,t,n){switch(t){case"done":e.done(n);break;case"error":e.error(new Error(n.error));break;case"process":const{id:r,input:i,options:o}=n;try{const a=await s(i,o);e.postMessage("done",{id:r,result:a})}catch(a){const c=a instanceof Error?a.message:"unknown error";e.postMessage("error",{id:r,error:c})}break;default:console.warn(`parse-with-worker unknown message ${t}`)}}function lu(s,e,t){if(t=t||s.byteLength,s.byteLength<t||e.byteLength<t)return!1;const n=new Uint8Array(s),r=new Uint8Array(e);for(let i=0;i<n.length;++i)if(n[i]!==r[i])return!1;return!0}function uu(...s){return hu(s)}function hu(s){const e=s.map(i=>i instanceof ArrayBuffer?new Uint8Array(i):i),t=e.reduce((i,o)=>i+o.byteLength,0),n=new Uint8Array(t);let r=0;for(const i of e)n.set(i,r),r+=i.byteLength;return n.buffer}async function fu(s){const e=[];for await(const t of s)e.push(t);return uu(...e)}function yi(){let s;if(typeof window<"u"&&window.performance)s=window.performance.now();else if(typeof process<"u"&&process.hrtime){const e=process.hrtime();s=e[0]*1e3+e[1]/1e6}else s=Date.now();return s}class Ti{constructor(e,t){this.sampleSize=1,this.time=0,this.count=0,this.samples=0,this.lastTiming=0,this.lastSampleTime=0,this.lastSampleCount=0,this._count=0,this._time=0,this._samples=0,this._startTime=0,this._timerPending=!1,this.name=e,this.type=t,this.reset()}reset(){return this.time=0,this.count=0,this.samples=0,this.lastTiming=0,this.lastSampleTime=0,this.lastSampleCount=0,this._count=0,this._time=0,this._samples=0,this._startTime=0,this._timerPending=!1,this}setSampleSize(e){return this.sampleSize=e,this}incrementCount(){return this.addCount(1),this}decrementCount(){return this.subtractCount(1),this}addCount(e){return this._count+=e,this._samples++,this._checkSampling(),this}subtractCount(e){return this._count-=e,this._samples++,this._checkSampling(),this}addTime(e){return this._time+=e,this.lastTiming=e,this._samples++,this._checkSampling(),this}timeStart(){return this._startTime=yi(),this._timerPending=!0,this}timeEnd(){return this._timerPending?(this.addTime(yi()-this._startTime),this._timerPending=!1,this._checkSampling(),this):this}getSampleAverageCount(){return this.sampleSize>0?this.lastSampleCount/this.sampleSize:0}getSampleAverageTime(){return this.sampleSize>0?this.lastSampleTime/this.sampleSize:0}getSampleHz(){return this.lastSampleTime>0?this.sampleSize/(this.lastSampleTime/1e3):0}getAverageCount(){return this.samples>0?this.count/this.samples:0}getAverageTime(){return this.samples>0?this.time/this.samples:0}getHz(){return this.time>0?this.samples/(this.time/1e3):0}_checkSampling(){this._samples===this.sampleSize&&(this.lastSampleTime=this._time,this.lastSampleCount=this._count,this.count+=this._count,this.time+=this._time,this.samples+=this._samples,this._time=0,this._count=0,this._samples=0)}}class tn{constructor(e){this.stats={},this.id=e.id,this.stats={},this._initializeStats(e.stats),Object.seal(this)}get(e,t="count"){return this._getOrCreate({name:e,type:t})}get size(){return Object.keys(this.stats).length}reset(){for(const e of Object.values(this.stats))e.reset();return this}forEach(e){for(const t of Object.values(this.stats))e(t)}getTable(){const e={};return this.forEach(t=>{e[t.name]={time:t.time||0,count:t.count||0,average:t.getAverageTime()||0,hz:t.getHz()||0}}),e}_initializeStats(e=[]){e.forEach(t=>this._getOrCreate(t))}_getOrCreate(e){const{name:t,type:n}=e;let r=this.stats[t];return r||(e instanceof Ti?r=e:r=new Ti(t,n),this.stats[t]=r),r}}let du="";const wi={};function pu(s){for(const e in wi)if(s.startsWith(e)){const t=wi[e];s=s.replace(e,t)}return!s.startsWith("http://")&&!s.startsWith("https://")&&(s=`${du}${s}`),s}function gu(s){return s&&typeof s=="object"&&s.isBuffer}function _a(s){if(gu(s))return s;if(s instanceof ArrayBuffer)return s;if(ArrayBuffer.isView(s))return s.byteOffset===0&&s.byteLength===s.buffer.byteLength?s.buffer:s.buffer.slice(s.byteOffset,s.byteOffset+s.byteLength);if(typeof s=="string"){const e=s;return new TextEncoder().encode(e).buffer}if(s&&typeof s=="object"&&s._toArrayBuffer)return s._toArrayBuffer();throw new Error("toArrayBuffer")}function ma(s){const e=s?s.lastIndexOf("/"):-1;return e>=0?s.substr(e+1):""}function _u(s){const e=s?s.lastIndexOf("/"):-1;return e>=0?s.substr(0,e):""}const mu=s=>typeof s=="boolean",Kt=s=>typeof s=="function",as=s=>s!==null&&typeof s=="object",vi=s=>as(s)&&s.constructor==={}.constructor,bu=s=>!!s&&typeof s[Symbol.iterator]=="function",yu=s=>s&&typeof s[Symbol.asyncIterator]=="function",ft=s=>typeof Response<"u"&&s instanceof Response||s&&s.arrayBuffer&&s.text&&s.json,dt=s=>typeof Blob<"u"&&s instanceof Blob,Tu=s=>s&&typeof s=="object"&&s.isBuffer,wu=s=>typeof ReadableStream<"u"&&s instanceof ReadableStream||as(s)&&Kt(s.tee)&&Kt(s.cancel)&&Kt(s.getReader),vu=s=>as(s)&&Kt(s.read)&&Kt(s.pipe)&&mu(s.readable),ba=s=>wu(s)||vu(s);class Au extends Error{constructor(e,t){super(e),this.reason=t.reason,this.url=t.url,this.response=t.response}reason;url;response}const xu=/^data:([-\w.]+\/[-\w.+]+)(;|,)/,Eu=/^([-\w.]+\/[-\w.+]+)/;function Ai(s,e){return s.toLowerCase()===e.toLowerCase()}function Su(s){const e=Eu.exec(s);return e?e[1]:s}function xi(s){const e=xu.exec(s);return e?e[1]:""}const ya=/\?.*/;function Ru(s){const e=s.match(ya);return e&&e[0]}function Sr(s){return s.replace(ya,"")}function Iu(s){if(s.length<50)return s;const e=s.slice(s.length-15);return`${s.substr(0,32)}...${e}`}function sn(s){return ft(s)?s.url:dt(s)?s.name||"":typeof s=="string"?s:""}function Rr(s){if(ft(s)){const e=s,t=e.headers.get("content-type")||"",n=Sr(e.url);return Su(t)||xi(n)}return dt(s)?s.type||"":typeof s=="string"?xi(s):""}function Cu(s){return ft(s)?s.headers["content-length"]||-1:dt(s)?s.size:typeof s=="string"?s.length:s instanceof ArrayBuffer||ArrayBuffer.isView(s)?s.byteLength:-1}async function Ta(s){if(ft(s))return s;const e={},t=Cu(s);t>=0&&(e["content-length"]=String(t));const n=sn(s),r=Rr(s);r&&(e["content-type"]=r);const i=await Ou(s);i&&(e["x-first-bytes"]=i),typeof s=="string"&&(s=new TextEncoder().encode(s));const o=new Response(s,{headers:e});return Object.defineProperty(o,"url",{value:n}),o}async function Pu(s){if(!s.ok)throw await Mu(s)}async function Mu(s){const e=Iu(s.url);let t=`Failed to fetch resource (${s.status}) ${s.statusText}: ${e}`;t=t.length>100?`${t.slice(0,100)}...`:t;const n={reason:s.statusText,url:s.url,response:s};try{const r=s.headers.get("Content-Type");n.reason=!s.bodyUsed&&r?.includes("application/json")?await s.json():await s.text()}catch{}return new Au(t,n)}async function Ou(s){if(typeof s=="string")return`data:,${s.slice(0,5)}`;if(s instanceof Blob){const t=s.slice(0,5);return await new Promise(n=>{const r=new FileReader;r.onload=i=>n(i?.target?.result),r.readAsDataURL(t)})}if(s instanceof ArrayBuffer){const t=s.slice(0,5);return`data:base64,${ku(t)}`}return null}function ku(s){let e="";const t=new Uint8Array(s);for(let n=0;n<t.byteLength;n++)e+=String.fromCharCode(t[n]);return btoa(e)}function Nu(s){return!Du(s)&&!Fu(s)}function Du(s){return s.startsWith("http:")||s.startsWith("https:")}function Fu(s){return s.startsWith("data:")}async function Ei(s,e){if(typeof s=="string"){const t=pu(s);return Nu(t)&&globalThis.loaders?.fetchNode?globalThis.loaders?.fetchNode(t,e):await fetch(t,e)}return await Ta(s)}const Si=new os({id:"loaders.gl"});class Bu{log(){return()=>{}}info(){return()=>{}}warn(){return()=>{}}error(){return()=>{}}}class Uu{console;constructor(){this.console=console}log(...e){return this.console.log.bind(this.console,...e)}info(...e){return this.console.info.bind(this.console,...e)}warn(...e){return this.console.warn.bind(this.console,...e)}error(...e){return this.console.error.bind(this.console,...e)}}const wa={fetch:null,mimeType:void 0,nothrow:!1,log:new Uu,useLocalLibraries:!1,CDN:"https://unpkg.com/@loaders.gl",worker:!0,maxConcurrency:3,maxMobileConcurrency:1,reuseWorkers:xr,_nodeWorkers:!1,_workerType:"",limit:0,_limitMB:0,batchSize:"auto",batchDebounceMs:0,metadata:!1,transforms:[]},Lu={throws:"nothrow",dataType:"(no longer used)",uri:"baseUri",method:"fetch.method",headers:"fetch.headers",body:"fetch.body",mode:"fetch.mode",credentials:"fetch.credentials",cache:"fetch.cache",redirect:"fetch.redirect",referrer:"fetch.referrer",referrerPolicy:"fetch.referrerPolicy",integrity:"fetch.integrity",keepalive:"fetch.keepalive",signal:"fetch.signal"};function va(){globalThis.loaders=globalThis.loaders||{};const{loaders:s}=globalThis;return s._state||(s._state={}),s._state}function Aa(){const s=va();return s.globalOptions=s.globalOptions||{...wa},s.globalOptions}function Vu(s,e,t,n){return t=t||[],t=Array.isArray(t)?t:[t],$u(s,t),ju(e,s,n)}function $u(s,e){Ri(s,null,wa,Lu,e);for(const t of e){const n=s&&s[t.id]||{},r=t.options&&t.options[t.id]||{},i=t.deprecatedOptions&&t.deprecatedOptions[t.id]||{};Ri(n,t.id,r,i,e)}}function Ri(s,e,t,n,r){const i=e||"Top level",o=e?`${e}.`:"";for(const a in s){const c=!e&&as(s[a]),l=a==="baseUri"&&!e,u=a==="workerUrl"&&e;if(!(a in t)&&!l&&!u){if(a in n)Si.warn(`${i} loader option '${o}${a}' no longer supported, use '${n[a]}'`)();else if(!c){const h=Wu(a,r);Si.warn(`${i} loader option '${o}${a}' not recognized. ${h}`)()}}}}function Wu(s,e){const t=s.toLowerCase();let n="";for(const r of e)for(const i in r.options){if(s===i)return`Did you mean '${r.id}.${i}'?`;const o=i.toLowerCase();(t.startsWith(o)||o.startsWith(t))&&(n=n||`Did you mean '${r.id}.${i}'?`)}return n}function ju(s,e,t){const r={...s.options||{}};return Hu(r,t),r.log===null&&(r.log=new Bu),Ii(r,Aa()),Ii(r,e),r}function Ii(s,e){for(const t in e)if(t in e){const n=e[t];vi(n)&&vi(s[t])?s[t]={...s[t],...e[t]}:s[t]=e[t]}}function Hu(s,e){e&&!("baseUri"in s)&&(s.baseUri=e)}function Ir(s){return s?(Array.isArray(s)&&(s=s[0]),Array.isArray(s?.extensions)):!1}function Cr(s){Os(s,"null loader"),Os(Ir(s),"invalid loader");let e;return Array.isArray(s)&&(e=s[1],s=s[0],s={...s,options:{...s.options,...e}}),(s?.parseTextSync||s?.parseText)&&(s.text=!0),s.text||(s.binary=!0),s}const xa=()=>{const s=va();return s.loaderRegistry=s.loaderRegistry||[],s.loaderRegistry};function zu(s){const e=xa();s=Array.isArray(s)?s:[s];for(const t of s){const n=Cr(t);e.find(r=>n===r)||e.unshift(n)}}function Xu(){return xa()}const Yu=/\.([^.]+)$/;async function qu(s,e=[],t,n){if(!Ea(s))return null;let r=Ci(s,e,{...t,nothrow:!0},n);if(r)return r;if(dt(s)&&(s=await s.slice(0,10).arrayBuffer(),r=Ci(s,e,t,n)),!r&&!t?.nothrow)throw new Error(Sa(s));return r}function Ci(s,e=[],t,n){if(!Ea(s))return null;if(e&&!Array.isArray(e))return Cr(e);let r=[];e&&(r=r.concat(e)),t?.ignoreRegisteredLoaders||r.push(...Xu()),Zu(r);const i=Ku(s,r,t,n);if(!i&&!t?.nothrow)throw new Error(Sa(s));return i}function Ku(s,e,t,n){const r=sn(s),i=Rr(s),o=Sr(r)||n?.url;let a=null,c="";return t?.mimeType&&(a=_n(e,t?.mimeType),c=`match forced by supplied MIME type ${t?.mimeType}`),a=a||Qu(e,o),c=c||(a?`matched url ${o}`:""),a=a||_n(e,i),c=c||(a?`matched MIME type ${i}`:""),a=a||Gu(e,s),c=c||(a?`matched initial data ${Ra(s)}`:""),t?.fallbackMimeType&&(a=a||_n(e,t?.fallbackMimeType),c=c||(a?`matched fallback MIME type ${i}`:"")),c&&Xl.log(1,`selectLoader selected ${a?.name}: ${c}.`),a}function Ea(s){return!(s instanceof Response&&s.status===204)}function Sa(s){const e=sn(s),t=Rr(s);let n="No valid loader found (";n+=e?`${ma(e)}, `:"no url provided, ",n+=`MIME type: ${t?`"${t}"`:"not provided"}, `;const r=s?Ra(s):"";return n+=r?` first bytes: "${r}"`:"first bytes: not available",n+=")",n}function Zu(s){for(const e of s)Cr(e)}function Qu(s,e){const t=e&&Yu.exec(e),n=t&&t[1];return n?Ju(s,n):null}function Ju(s,e){e=e.toLowerCase();for(const t of s)for(const n of t.extensions)if(n.toLowerCase()===e)return t;return null}function _n(s,e){for(const t of s)if(t.mimeTypes?.some(n=>Ai(e,n))||Ai(e,`application/x.${t.id}`))return t;return null}function Gu(s,e){if(!e)return null;for(const t of s)if(typeof e=="string"){if(eh(e,t))return t}else if(ArrayBuffer.isView(e)){if(Pi(e.buffer,e.byteOffset,t))return t}else if(e instanceof ArrayBuffer&&Pi(e,0,t))return t;return null}function eh(s,e){return e.testText?e.testText(s):(Array.isArray(e.tests)?e.tests:[e.tests]).some(n=>s.startsWith(n))}function Pi(s,e,t){return(Array.isArray(t.tests)?t.tests:[t.tests]).some(r=>th(s,e,t,r))}function th(s,e,t,n){if(n instanceof ArrayBuffer)return lu(n,s,n.byteLength);switch(typeof n){case"function":return n(s);case"string":const r=Xn(s,e,n.length);return n===r;default:return!1}}function Ra(s,e=5){return typeof s=="string"?s.slice(0,e):ArrayBuffer.isView(s)?Xn(s.buffer,s.byteOffset,e):s instanceof ArrayBuffer?Xn(s,0,e):""}function Xn(s,e,t){if(s.byteLength<e+t)return"";const n=new DataView(s);let r="";for(let i=0;i<t;i++)r+=String.fromCharCode(n.getUint8(e+i));return r}const sh=256*1024;function*nh(s,e){const t=e?.chunkSize||sh;let n=0;const r=new TextEncoder;for(;n<s.length;){const i=Math.min(s.length-n,t),o=s.slice(n,n+i);n+=i,yield r.encode(o)}}const rh=256*1024;function*ih(s,e={}){const{chunkSize:t=rh}=e;let n=0;for(;n<s.byteLength;){const r=Math.min(s.byteLength-n,t),i=new ArrayBuffer(r),o=new Uint8Array(s,n,r);new Uint8Array(i).set(o),n+=r,yield i}}const oh=1024*1024;async function*ah(s,e){const t=e?.chunkSize||oh;let n=0;for(;n<s.size;){const r=n+t,i=await s.slice(n,r).arrayBuffer();n=r,yield i}}function Mi(s,e){return xr?ch(s,e):lh(s)}async function*ch(s,e){const t=s.getReader();let n;try{for(;;){const r=n||t.read();e?._streamReadAhead&&(n=t.read());const{done:i,value:o}=await r;if(i)return;yield _a(o)}}catch{t.releaseLock()}}async function*lh(s,e){for await(const t of s)yield _a(t)}function uh(s,e){if(typeof s=="string")return nh(s,e);if(s instanceof ArrayBuffer)return ih(s,e);if(dt(s))return ah(s,e);if(ba(s))return Mi(s,e);if(ft(s))return Mi(s.body,e);throw new Error("makeIterator")}const Ia="Cannot convert supplied data type";function hh(s,e,t){if(e.text&&typeof s=="string")return s;if(Tu(s)&&(s=s.buffer),s instanceof ArrayBuffer){const n=s;return e.text&&!e.binary?new TextDecoder("utf8").decode(n):n}if(ArrayBuffer.isView(s)){if(e.text&&!e.binary)return new TextDecoder("utf8").decode(s);let n=s.buffer;const r=s.byteLength||s.length;return(s.byteOffset!==0||r!==n.byteLength)&&(n=n.slice(s.byteOffset,s.byteOffset+r)),n}throw new Error(Ia)}async function fh(s,e,t){const n=s instanceof ArrayBuffer||ArrayBuffer.isView(s);if(typeof s=="string"||n)return hh(s,e);if(dt(s)&&(s=await Ta(s)),ft(s)){const r=s;return await Pu(r),e.binary?await r.arrayBuffer():await r.text()}if(ba(s)&&(s=uh(s,t)),bu(s)||yu(s))return fu(s);throw new Error(Ia)}function Ca(s,e){const t=Aa(),n=s||t;return typeof n.fetch=="function"?n.fetch:as(n.fetch)?r=>Ei(r,n.fetch):e?.fetch?e?.fetch:Ei}function dh(s,e,t){if(t)return t;const n={fetch:Ca(e,s),...s};if(n.url){const r=Sr(n.url);n.baseUrl=r,n.queryString=Ru(n.url),n.filename=ma(r),n.baseUrl=_u(r)}return Array.isArray(n.loaders)||(n.loaders=null),n}function ph(s,e){if(s&&!Array.isArray(s))return s;let t;if(s&&(t=Array.isArray(s)?s:[s]),e&&e.loaders){const n=Array.isArray(e.loaders)?e.loaders:[e.loaders];t=t?[...t,...n]:n}return t&&t.length?t:void 0}async function Ns(s,e,t,n){e&&!Array.isArray(e)&&!Ir(e)&&(n=void 0,t=e,e=void 0),s=await s,t=t||{};const r=sn(s),o=ph(e,n),a=await qu(s,o,t);return a?(t=Vu(t,a,o,r),n=dh({url:r,_parse:Ns,loaders:o},t,n||null),await gh(a,s,t,n)):null}async function gh(s,e,t,n){if(iu(s),t=Yl(s.options,t),ft(e)){const i=e,{ok:o,redirected:a,status:c,statusText:l,type:u,url:h}=i,f=Object.fromEntries(i.headers.entries());n.response={headers:f,ok:o,redirected:a,status:c,statusText:l,type:u,url:h}}e=await fh(e,s,t);const r=s;if(r.parseTextSync&&typeof e=="string")return r.parseTextSync(e,t,n);if(ou(s,t))return await au(s,e,t,n,Ns);if(r.parseText&&typeof e=="string")return await r.parseText(e,t,n);if(r.parse)return await r.parse(e,t,n);throw Qe(!r.parseSync),new Error(`${s.id} loader - no parser found and worker is disabled`)}async function Yn(s,e,t,n){let r,i;!Array.isArray(e)&&!Ir(e)?(r=[],i=e):(r=e,i=t);const o=Ca(i);let a=s;return typeof s=="string"&&(a=await o(s)),dt(s)&&(a=await o(s)),Array.isArray(r)?await Ns(a,r,i):await Ns(a,r,i)}const _h="4.3.3",mh=globalThis.loaders?.parseImageNode,qn=typeof Image<"u",Kn=typeof ImageBitmap<"u",bh=!!mh,Zn=xr?!0:bh;function yh(s){switch(s){case"auto":return Kn||qn||Zn;case"imagebitmap":return Kn;case"image":return qn;case"data":return Zn;default:throw new Error(`@loaders.gl/images: image ${s} not supported in this environment`)}}function Th(){if(Kn)return"imagebitmap";if(qn)return"image";if(Zn)return"data";throw new Error("Install '@loaders.gl/polyfills' to parse images under Node.js")}function wh(s){const e=Ah(s);if(!e)throw new Error("Not an image");return e}function vh(s){switch(wh(s)){case"data":return s;case"image":case"imagebitmap":const e=document.createElement("canvas"),t=e.getContext("2d");if(!t)throw new Error("getImageData");return e.width=s.width,e.height=s.height,t.drawImage(s,0,0),t.getImageData(0,0,s.width,s.height);default:throw new Error("getImageData")}}function Ah(s){return typeof ImageBitmap<"u"&&s instanceof ImageBitmap?"imagebitmap":typeof Image<"u"&&s instanceof Image?"image":s&&typeof s=="object"&&s.data&&s.width&&s.height?"data":null}const xh=/^data:image\/svg\+xml/,Eh=/\.svg((\?|#).*)?$/;function Pr(s){return s&&(xh.test(s)||Eh.test(s))}function Sh(s,e){if(Pr(e)){let n=new TextDecoder().decode(s);try{typeof unescape=="function"&&typeof encodeURIComponent=="function"&&(n=unescape(encodeURIComponent(n)))}catch(i){throw new Error(i.message)}return`data:image/svg+xml;base64,${btoa(n)}`}return Pa(s,e)}function Pa(s,e){if(Pr(e))throw new Error("SVG cannot be parsed directly to imagebitmap");return new Blob([new Uint8Array(s)])}async function Ma(s,e,t){const n=Sh(s,t),r=self.URL||self.webkitURL,i=typeof n!="string"&&r.createObjectURL(n);try{return await Rh(i||n,e)}finally{i&&r.revokeObjectURL(i)}}async function Rh(s,e){const t=new Image;return t.src=s,e.image&&e.image.decode&&t.decode?(await t.decode(),t):await new Promise((n,r)=>{try{t.onload=()=>n(t),t.onerror=i=>{const o=i instanceof Error?i.message:"error";r(new Error(o))}}catch(i){r(i)}})}const Ih={};let Oi=!0;async function Ch(s,e,t){let n;Pr(t)?n=await Ma(s,e,t):n=Pa(s,t);const r=e&&e.imagebitmap;return await Ph(n,r)}async function Ph(s,e=null){if((Mh(e)||!Oi)&&(e=null),e)try{return await createImageBitmap(s,e)}catch(t){console.warn(t),Oi=!1}return await createImageBitmap(s)}function Mh(s){for(const e in s||Ih)return!1;return!0}function Oh(s){return!Fh(s,"ftyp",4)||(s[8]&96)===0?null:kh(s)}function kh(s){switch(Nh(s,8,12).replace("\0"," ").trim()){case"avif":case"avis":return{extension:"avif",mimeType:"image/avif"};default:return null}}function Nh(s,e,t){return String.fromCharCode(...s.slice(e,t))}function Dh(s){return[...s].map(e=>e.charCodeAt(0))}function Fh(s,e,t=0){const n=Dh(e);for(let r=0;r<n.length;++r)if(n[r]!==s[r+t])return!1;return!0}const Oe=!1,Zt=!0;function Oa(s){const e=cs(s);return Uh(e)||$h(e)||Lh(e)||Vh(e)||Bh(e)}function Bh(s){const e=new Uint8Array(s instanceof DataView?s.buffer:s),t=Oh(e);return t?{mimeType:t.mimeType,width:0,height:0}:null}function Uh(s){const e=cs(s);return e.byteLength>=24&&e.getUint32(0,Oe)===2303741511?{mimeType:"image/png",width:e.getUint32(16,Oe),height:e.getUint32(20,Oe)}:null}function Lh(s){const e=cs(s);return e.byteLength>=10&&e.getUint32(0,Oe)===1195984440?{mimeType:"image/gif",width:e.getUint16(6,Zt),height:e.getUint16(8,Zt)}:null}function Vh(s){const e=cs(s);return e.byteLength>=14&&e.getUint16(0,Oe)===16973&&e.getUint32(2,Zt)===e.byteLength?{mimeType:"image/bmp",width:e.getUint32(18,Zt),height:e.getUint32(22,Zt)}:null}function $h(s){const e=cs(s);if(!(e.byteLength>=3&&e.getUint16(0,Oe)===65496&&e.getUint8(2)===255))return null;const{tableMarkers:n,sofMarkers:r}=Wh();let i=2;for(;i+9<e.byteLength;){const o=e.getUint16(i,Oe);if(r.has(o))return{mimeType:"image/jpeg",height:e.getUint16(i+5,Oe),width:e.getUint16(i+7,Oe)};if(!n.has(o))return null;i+=2,i+=e.getUint16(i,Oe)}return null}function Wh(){const s=new Set([65499,65476,65484,65501,65534]);for(let t=65504;t<65520;++t)s.add(t);return{tableMarkers:s,sofMarkers:new Set([65472,65473,65474,65475,65477,65478,65479,65481,65482,65483,65485,65486,65487,65502])}}function cs(s){if(s instanceof DataView)return s;if(ArrayBuffer.isView(s))return new DataView(s.buffer);if(s instanceof ArrayBuffer)return new DataView(s);throw new Error("toDataView")}async function jh(s,e){const{mimeType:t}=Oa(s)||{},n=globalThis.loaders?.parseImageNode;return Os(n),await n(s,t)}async function Hh(s,e,t){e=e||{};const r=(e.image||{}).type||"auto",{url:i}=t||{},o=zh(r);let a;switch(o){case"imagebitmap":a=await Ch(s,e,i);break;case"image":a=await Ma(s,e,i);break;case"data":a=await jh(s);break;default:Os(!1)}return r==="data"&&(a=vh(a)),a}function zh(s){switch(s){case"auto":case"data":return Th();default:return yh(s),s}}const Xh=["png","jpg","jpeg","gif","webp","bmp","ico","svg","avif"],Yh=["image/png","image/jpeg","image/gif","image/webp","image/avif","image/bmp","image/vnd.microsoft.icon","image/svg+xml"],qh={image:{type:"auto",decode:!0}},Kh={dataType:null,batchType:null,id:"image",module:"images",name:"Images",version:_h,mimeTypes:Yh,extensions:Xh,parse:Hh,tests:[s=>!!Oa(new DataView(s))],options:qh},Y=new os({id:"deck"});let Qn={};function Zh(s){Qn=s}function fe(s,e,t,n){Y.level>0&&Qn[s]&&Qn[s].call(null,e,t,n)}function Qh(s){const e=s[0],t=s[s.length-1];return e==="{"&&t==="}"||e==="["&&t==="]"}const Jh={dataType:null,batchType:null,id:"JSON",name:"JSON",module:"",version:"",options:{},extensions:["json","geojson"],mimeTypes:["application/json","application/geo+json"],testText:Qh,parseTextSync:JSON.parse};function Gh(){const s="9.1.14",e=globalThis.deck&&globalThis.deck.VERSION;if(e&&e!==s)throw new Error(`deck.gl - multiple versions detected: ${e} vs ${s}`);return e||(Y.log(1,`deck.gl ${s}`)(),globalThis.deck={...globalThis.deck,VERSION:s,version:s,log:Y,_registerLoggers:Zh},zu([Jh,[Kh,{imagebitmap:{premultiplyAlpha:"none"}}]])),s}const ef=Gh();function Mr(s,e){if(!s)throw new Error(e||"shadertools: assertion failed.")}const mn={number:{type:"number",validate(s,e){return Number.isFinite(s)&&typeof e=="object"&&(e.max===void 0||s<=e.max)&&(e.min===void 0||s>=e.min)}},array:{type:"array",validate(s,e){return Array.isArray(s)||ArrayBuffer.isView(s)}}};function tf(s){const e={};for(const[t,n]of Object.entries(s))e[t]=sf(n);return e}function sf(s){let e=ki(s);if(e!=="object")return{value:s,...mn[e],type:e};if(typeof s=="object")return s?s.type!==void 0?{...s,...mn[s.type],type:s.type}:s.value===void 0?{type:"object",value:s}:(e=ki(s.value),{...s,...mn[e],type:e}):{type:"object",value:null};throw new Error("props")}function ki(s){return Array.isArray(s)||ArrayBuffer.isView(s)?"array":typeof s}const nf=`#ifdef MODULE_LOGDEPTH
  logdepth_adjustPosition(gl_Position);
#endif
`,rf=`#ifdef MODULE_MATERIAL
  fragColor = material_filterColor(fragColor);
#endif

#ifdef MODULE_LIGHTING
  fragColor = lighting_filterColor(fragColor);
#endif

#ifdef MODULE_FOG
  fragColor = fog_filterColor(fragColor);
#endif

#ifdef MODULE_PICKING
  fragColor = picking_filterHighlightColor(fragColor);
  fragColor = picking_filterPickingColor(fragColor);
#endif

#ifdef MODULE_LOGDEPTH
  logdepth_setFragDepth();
#endif
`,of={vertex:nf,fragment:rf},Ni=/void\s+main\s*\([^)]*\)\s*\{\n?/,Di=/}\n?[^{}]*$/,bn=[],Ss="__LUMA_INJECT_DECLARATIONS__";function af(s){const e={vertex:{},fragment:{}};for(const t in s){let n=s[t];const r=cf(t);typeof n=="string"&&(n={order:0,injection:n}),e[r][t]=n}return e}function cf(s){const e=s.slice(0,2);switch(e){case"vs":return"vertex";case"fs":return"fragment";default:throw new Error(e)}}function Ds(s,e,t,n=!1){const r=e==="vertex";for(const i in t){const o=t[i];o.sort((c,l)=>c.order-l.order),bn.length=o.length;for(let c=0,l=o.length;c<l;++c)bn[c]=o[c].injection;const a=`${bn.join(`
`)}
`;switch(i){case"vs:#decl":r&&(s=s.replace(Ss,a));break;case"vs:#main-start":r&&(s=s.replace(Ni,c=>c+a));break;case"vs:#main-end":r&&(s=s.replace(Di,c=>a+c));break;case"fs:#decl":r||(s=s.replace(Ss,a));break;case"fs:#main-start":r||(s=s.replace(Ni,c=>c+a));break;case"fs:#main-end":r||(s=s.replace(Di,c=>a+c));break;default:s=s.replace(i,c=>c+a)}}return s=s.replace(Ss,""),n&&(s=s.replace(/\}\s*$/,i=>i+of[e])),s}function Fs(s){s.map(e=>lf(e))}function lf(s){if(s.instance)return;Fs(s.dependencies||[]);const{propTypes:e={},deprecations:t=[],inject:n={}}=s,r={normalizedInjections:af(n),parsedDeprecations:uf(t)};e&&(r.propValidators=tf(e)),s.instance=r;let i={};e&&(i=Object.entries(e).reduce((o,[a,c])=>{const l=c?.value;return l&&(o[a]=l),o},{})),s.defaultUniforms={...s.defaultUniforms,...i}}function ka(s,e,t){s.deprecations?.forEach(n=>{n.regex?.test(e)&&(n.deprecated?t.deprecated(n.old,n.new)():t.removed(n.old,n.new)())})}function uf(s){return s.forEach(e=>{switch(e.type){case"function":e.regex=new RegExp(`\\b${e.old}\\(`);break;default:e.regex=new RegExp(`${e.type} ${e.old};`)}}),s}function Or(s){Fs(s);const e={},t={};Na({modules:s,level:0,moduleMap:e,moduleDepth:t});const n=Object.keys(t).sort((r,i)=>t[i]-t[r]).map(r=>e[r]);return Fs(n),n}function Na(s){const{modules:e,level:t,moduleMap:n,moduleDepth:r}=s;if(t>=5)throw new Error("Possible loop in shader dependency graph");for(const i of e)n[i.name]=i,(r[i.name]===void 0||r[i.name]<t)&&(r[i.name]=t);for(const i of e)i.dependencies&&Na({modules:i.dependencies,level:t+1,moduleMap:n,moduleDepth:r})}function hf(s){switch(s?.gpu.toLowerCase()){case"apple":return`#define APPLE_GPU
// Apple optimizes away the calculation necessary for emulated fp64
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
#define LUMA_FP32_TAN_PRECISION_WORKAROUND 1
// Intel GPU doesn't have full 32 bits precision in same cases, causes overflow
#define LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND 1
`;case"nvidia":return`#define NVIDIA_GPU
// Nvidia optimizes away the calculation necessary for emulated fp64
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
`;case"intel":return`#define INTEL_GPU
// Intel optimizes away the calculation necessary for emulated fp64
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
// Intel's built-in 'tan' function doesn't have acceptable precision
#define LUMA_FP32_TAN_PRECISION_WORKAROUND 1
// Intel GPU doesn't have full 32 bits precision in same cases, causes overflow
#define LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND 1
`;case"amd":return`#define AMD_GPU
`;default:return`#define DEFAULT_GPU
// Prevent driver from optimizing away the calculation necessary for emulated fp64
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
// Headless Chrome's software shader 'tan' function doesn't have acceptable precision
#define LUMA_FP32_TAN_PRECISION_WORKAROUND 1
// If the GPU doesn't have full 32 bits precision, will causes overflow
#define LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND 1
`}}function ff(s,e){if(Number(s.match(/^#version[ \t]+(\d+)/m)?.[1]||100)!==300)throw new Error("luma.gl v9 only supports GLSL 3.00 shader sources");switch(e){case"vertex":return s=Fi(s,df),s;case"fragment":return s=Fi(s,pf),s;default:throw new Error(e)}}const Da=[[/^(#version[ \t]+(100|300[ \t]+es))?[ \t]*\n/,`#version 300 es
`],[/\btexture(2D|2DProj|Cube)Lod(EXT)?\(/g,"textureLod("],[/\btexture(2D|2DProj|Cube)(EXT)?\(/g,"texture("]],df=[...Da,[Jn("attribute"),"in $1"],[Jn("varying"),"out $1"]],pf=[...Da,[Jn("varying"),"in $1"]];function Fi(s,e){for(const[t,n]of e)s=s.replace(t,n);return s}function Jn(s){return new RegExp(`\\b${s}[ \\t]+(\\w+[ \\t]+\\w+(\\[\\w+\\])?;)`,"g")}function Fa(s,e){let t="";for(const n in s){const r=s[n];if(t+=`void ${r.signature} {
`,r.header&&(t+=`  ${r.header}`),e[n]){const i=e[n];i.sort((o,a)=>o.order-a.order);for(const o of i)t+=`  ${o.injection}
`}r.footer&&(t+=`  ${r.footer}`),t+=`}
`}return t}function Ba(s){const e={vertex:{},fragment:{}};for(const t of s){let n,r;typeof t!="string"?(n=t,r=n.hook):(n={},r=t),r=r.trim();const[i,o]=r.split(":"),a=r.replace(/\(.+/,""),c=Object.assign(n,{signature:o});switch(i){case"vs":e.vertex[a]=c;break;case"fs":e.fragment[a]=c;break;default:throw new Error(i)}}return e}function gf(s,e){return{name:_f(s,e),language:"glsl",version:mf(s)}}function _f(s,e="unnamed"){const n=/#define[^\S\r\n]*SHADER_NAME[^\S\r\n]*([A-Za-z0-9_-]+)\s*/.exec(s);return n?n[1]:e}function mf(s){let e=100;const t=s.match(/[^\s]+/g);if(t&&t.length>=2&&t[0]==="#version"){const n=parseInt(t[1],10);Number.isFinite(n)&&(e=n)}if(e!==100&&e!==300)throw new Error(`Invalid GLSL version ${e}`);return e}const Ua=`

${Ss}
`,bf=`precision highp float;
`;function yf(s){const e=Or(s.modules||[]);return{source:wf(s.platformInfo,{...s,source:s.source,stage:"vertex",modules:e}),getUniforms:La(e)}}function Tf(s){const{vs:e,fs:t}=s,n=Or(s.modules||[]);return{vs:Bi(s.platformInfo,{...s,source:e,stage:"vertex",modules:n}),fs:Bi(s.platformInfo,{...s,source:t,stage:"fragment",modules:n}),getUniforms:La(n)}}function wf(s,e){const{source:t,stage:n,modules:r,hookFunctions:i=[],inject:o={},log:a}=e;Mr(typeof t=="string","shader source must be a string");const c=t;let l="";const u=Ba(i),h={},f={},g={};for(const w in o){const A=typeof o[w]=="string"?{injection:o[w],order:0}:o[w],S=/^(v|f)s:(#)?([\w-]+)$/.exec(w);if(S){const I=S[2],x=S[3];I?x==="decl"?f[w]=[A]:g[w]=[A]:h[w]=[A]}else g[w]=[A]}const _=r;for(const w of _){a&&ka(w,c,a);const A=Va(w,"wgsl");l+=A;const S=w.injections?.[n]||{};for(const I in S){const x=/^(v|f)s:#([\w-]+)$/.exec(I);if(x){const P=x[2]==="decl"?f:g;P[I]=P[I]||[],P[I].push(S[I])}else h[I]=h[I]||[],h[I].push(S[I])}}return l+=Ua,l=Ds(l,n,f),l+=Fa(u[n],h),l+=c,l=Ds(l,n,g),l}function Bi(s,e){const{id:t,source:n,stage:r,language:i="glsl",modules:o,defines:a={},hookFunctions:c=[],inject:l={},prologue:u=!0,log:h}=e;Mr(typeof n=="string","shader source must be a string");const f=i==="glsl"?gf(n).version:-1,g=s.shaderLanguageVersion,_=f===100?"#version 100":"#version 300 es",A=n.split(`
`).slice(1).join(`
`),S={};o.forEach(D=>{Object.assign(S,D.defines)}),Object.assign(S,a);let I="";switch(i){case"wgsl":break;case"glsl":I=u?`${_}

// ----- PROLOGUE -------------------------
${vf({id:t,source:n,stage:r})}
${`#define SHADER_TYPE_${r.toUpperCase()}`}

${hf(s)}
${r==="fragment"?bf:""}

// ----- APPLICATION DEFINES -------------------------

${Af(S)}

`:`${_}
`;break}const x=Ba(c),E={},P={},M={};for(const D in l){const B=typeof l[D]=="string"?{injection:l[D],order:0}:l[D],N=/^(v|f)s:(#)?([\w-]+)$/.exec(D);if(N){const U=N[2],L=N[3];U?L==="decl"?P[D]=[B]:M[D]=[B]:E[D]=[B]}else M[D]=[B]}for(const D of o){h&&ka(D,A,h);const B=Va(D,r);I+=B;const N=D.instance?.normalizedInjections[r]||{};for(const U in N){const L=/^(v|f)s:#([\w-]+)$/.exec(U);if(L){const Q=L[2]==="decl"?P:M;Q[U]=Q[U]||[],Q[U].push(N[U])}else E[U]=E[U]||[],E[U].push(N[U])}}return I+="// ----- MAIN SHADER SOURCE -------------------------",I+=Ua,I=Ds(I,r,P),I+=Fa(x[r],E),I+=A,I=Ds(I,r,M),i==="glsl"&&f!==g&&(I=ff(I,r)),I.trim()}function La(s){return function(t){const n={};for(const r of s){const i=r.getUniforms?.(t,n);Object.assign(n,i)}return n}}function vf(s){const{id:e,source:t,stage:n}=s;return e&&t.indexOf("SHADER_NAME")===-1?`
#define SHADER_NAME ${e}_${n}`:""}function Af(s={}){let e="";for(const t in s){const n=s[t];(n||Number.isFinite(n))&&(e+=`#define ${t.toUpperCase()} ${s[t]}
`)}return e}function Va(s,e){let t;switch(e){case"vertex":t=s.vs||"";break;case"fragment":t=s.fs||"";break;case"wgsl":t=s.source||"";break;default:Mr(!1)}if(!s.name)throw new Error("Shader module must have a name");const n=s.name.toUpperCase().replace(/[^0-9a-z]/gi,"_");let r=`// ----- MODULE ${s.name} ---------------

`;return e!=="wgsl"&&(r+=`#define MODULE_${n}
`),r+=`${t}
`,r}const xf=/^\s*\#\s*ifdef\s*([a-zA-Z_]+)\s*$/,Ef=/^\s*\#\s*endif\s*$/;function Sf(s,e){const t=s.split(`
`),n=[];let r=!0,i=null;for(const o of t){const a=o.match(xf),c=o.match(Ef);a?(i=a[1],r=!!e?.defines?.[i]):c?r=!0:r&&n.push(o)}return n.join(`
`)}class tt{static defaultShaderAssembler;_hookFunctions=[];_defaultModules=[];static getDefaultShaderAssembler(){return tt.defaultShaderAssembler=tt.defaultShaderAssembler||new tt,tt.defaultShaderAssembler}addDefaultModule(e){this._defaultModules.find(t=>t.name===(typeof e=="string"?e:e.name))||this._defaultModules.push(e)}removeDefaultModule(e){const t=typeof e=="string"?e:e.name;this._defaultModules=this._defaultModules.filter(n=>n.name!==t)}addShaderHook(e,t){t&&(e=Object.assign(t,{hook:e})),this._hookFunctions.push(e)}assembleWGSLShader(e){const t=this._getModuleList(e.modules),n=this._hookFunctions,{source:r,getUniforms:i}=yf({...e,source:e.source,modules:t,hookFunctions:n});return{source:e.platformInfo.shaderLanguage==="wgsl"?Sf(r):r,getUniforms:i,modules:t}}assembleGLSLShaderPair(e){const t=this._getModuleList(e.modules),n=this._hookFunctions;return{...Tf({...e,vs:e.vs,fs:e.fs,modules:t,hookFunctions:n}),modules:t}}_getModuleList(e=[]){const t=new Array(this._defaultModules.length+e.length),n={};let r=0;for(let i=0,o=this._defaultModules.length;i<o;++i){const a=this._defaultModules[i],c=a.name;t[r++]=a,n[c]=!0}for(let i=0,o=e.length;i<o;++i){const a=e[i],c=a.name;n[c]||(t[r++]=a,n[c]=!0)}return t.length=r,Fs(t),t}}const Rf=`out vec4 transform_output;
void main() {
  transform_output = vec4(0);
}`,If=`#version 300 es
${Rf}`;function Cf(s){const{input:e,inputChannels:t,output:n}={};if(!e)return If;if(!t)throw new Error("inputChannels");const r=Pf(t),i=Mf(e,t);return`#version 300 es
in ${r} ${e};
out vec4 ${n};
void main() {
  ${n} = ${i};
}`}function Pf(s){switch(s){case 1:return"float";case 2:return"vec2";case 3:return"vec3";case 4:return"vec4";default:throw new Error(`invalid channels: ${s}`)}}function Mf(s,e){switch(e){case 1:return`vec4(${s}, 0.0, 0.0, 1.0)`;case 2:return`vec4(${s}, 0.0, 1.0)`;case 3:return`vec4(${s}, 1.0)`;case 4:return s;default:throw new Error(`invalid channels: ${e}`)}}class Of{stats=new Map;getStats(e){return this.get(e)}get(e){return this.stats.has(e)||this.stats.set(e,new tn({id:e})),this.stats.get(e)}}const $a=new Of,C=new os({id:"luma.gl"}),yn={};function nn(s="id"){yn[s]=yn[s]||1;const e=yn[s]++;return`${s}-${e}`}let X=class{static defaultProps={id:"undefined",handle:void 0,userData:void 0};toString(){return`${this[Symbol.toStringTag]||this.constructor.name}:"${this.id}"`}id;props;userData={};_device;destroyed=!1;allocatedBytes=0;_attachedResources=new Set;constructor(e,t,n){if(!e)throw new Error("no device");this._device=e,this.props=kf(t,n);const r=this.props.id!=="undefined"?this.props.id:nn(this[Symbol.toStringTag]);this.props.id=r,this.id=r,this.userData=this.props.userData||{},this.addStats()}destroy(){this.destroyResource()}delete(){return this.destroy(),this}getProps(){return this.props}attachResource(e){this._attachedResources.add(e)}detachResource(e){this._attachedResources.delete(e)}destroyAttachedResource(e){this._attachedResources.delete(e)&&e.destroy()}destroyAttachedResources(){for(const e of Object.values(this._attachedResources))e.destroy();this._attachedResources=new Set}destroyResource(){this.destroyAttachedResources(),this.removeStats(),this.destroyed=!0}removeStats(){const e=this._device.statsManager.getStats("Resource Counts"),t=this[Symbol.toStringTag];e.get(`${t}s Active`).decrementCount()}trackAllocatedMemory(e,t=this[Symbol.toStringTag]){const n=this._device.statsManager.getStats("Resource Counts");n.get("GPU Memory").addCount(e),n.get(`${t} Memory`).addCount(e),this.allocatedBytes=e}trackDeallocatedMemory(e=this[Symbol.toStringTag]){const t=this._device.statsManager.getStats("Resource Counts");t.get("GPU Memory").subtractCount(this.allocatedBytes),t.get(`${e} Memory`).subtractCount(this.allocatedBytes),this.allocatedBytes=0}addStats(){const e=this._device.statsManager.getStats("Resource Counts"),t=this[Symbol.toStringTag];e.get("Resources Created").incrementCount(),e.get(`${t}s Created`).incrementCount(),e.get(`${t}s Active`).incrementCount()}};function kf(s,e){const t={...e};for(const n in s)s[n]!==void 0&&(t[n]=s[n]);return t}class q extends X{static defaultProps={...X.defaultProps,usage:0,byteLength:0,byteOffset:0,data:null,indexType:"uint16",mappedAtCreation:!1};static MAP_READ=1;static MAP_WRITE=2;static COPY_SRC=4;static COPY_DST=8;static INDEX=16;static VERTEX=32;static UNIFORM=64;static STORAGE=128;static INDIRECT=256;static QUERY_RESOLVE=512;get[Symbol.toStringTag](){return"Buffer"}usage;indexType;updateTimestamp;constructor(e,t){const n={...t};(t.usage||0)&q.INDEX&&!t.indexType&&(t.data instanceof Uint32Array?n.indexType="uint32":t.data instanceof Uint16Array&&(n.indexType="uint16")),delete n.data,super(e,n,q.defaultProps),this.usage=n.usage||0,this.indexType=n.indexType,this.updateTimestamp=e.incrementTimestamp()}clone(e){return this.device.createBuffer({...this.props,...e})}readSyncWebGL(e,t){throw new Error("not implemented")}static DEBUG_DATA_MAX_LENGTH=32;debugData=new ArrayBuffer(0);_setDebugData(e,t,n){const r=ArrayBuffer.isView(e)?e.buffer:e,i=Math.min(e?e.byteLength:n,q.DEBUG_DATA_MAX_LENGTH);r===null?this.debugData=new ArrayBuffer(i):t===0&&n===r.byteLength?this.debugData=r.slice(0,i):this.debugData=r.slice(t,t+i)}}function Wa(s){const e=Ui[s],t=Nf(e),n=s.includes("norm"),r=!n&&!s.startsWith("float"),i=s.startsWith("s");return{dataType:Ui[s],byteLength:t,integer:r,signed:i,normalized:n}}function Nf(s){return Df[s]}const Ui={uint8:"uint8",sint8:"sint8",unorm8:"uint8",snorm8:"sint8",uint16:"uint16",sint16:"sint16",unorm16:"uint16",snorm16:"sint16",float16:"float16",float32:"float32",uint32:"uint32",sint32:"sint32"},Df={uint8:1,sint8:1,uint16:2,sint16:2,float16:2,float32:4,uint32:4,sint32:4},ae="texture-compression-bc",H="texture-compression-astc",Ce="texture-compression-etc2",Ff="texture-compression-etc1-webgl",fs="texture-compression-pvrtc-webgl",Tn="texture-compression-atc-webgl",ds="float32-renderable-webgl",wn="float16-renderable-webgl",Bf="rgb9e5ufloat-renderable-webgl",vn="snorm8-renderable-webgl",Vt="norm16-renderable-webgl",An="snorm16-renderable-webgl",ps="float32-filterable",Li="float16-filterable-webgl";function ja(s){const e=Uf[s];if(!e)throw new Error(`Unsupported texture format ${s}`);return e}const Uf={r8unorm:{},r8snorm:{render:vn},r8uint:{},r8sint:{},rg8unorm:{},rg8snorm:{render:vn},rg8uint:{},rg8sint:{},r16uint:{},r16sint:{},r16float:{render:wn,filter:"float16-filterable-webgl"},"r16unorm-webgl":{f:Vt},"r16snorm-webgl":{f:An},"rgba4unorm-webgl":{channels:"rgba",bitsPerChannel:[4,4,4,4],packed:!0},"rgb565unorm-webgl":{channels:"rgb",bitsPerChannel:[5,6,5,0],packed:!0},"rgb5a1unorm-webgl":{channels:"rgba",bitsPerChannel:[5,5,5,1],packed:!0},"rgb8unorm-webgl":{},"rgb8snorm-webgl":{},rgba8unorm:{},"rgba8unorm-srgb":{},rgba8snorm:{render:vn},rgba8uint:{},rgba8sint:{},bgra8unorm:{},"bgra8unorm-srgb":{},rg16uint:{},rg16sint:{},rg16float:{render:wn,filter:Li},"rg16unorm-webgl":{render:Vt},"rg16snorm-webgl":{render:An},r32uint:{},r32sint:{},r32float:{render:ds,filter:ps},rgb9e5ufloat:{channels:"rgb",packed:!0,render:Bf},rg11b10ufloat:{channels:"rgb",bitsPerChannel:[11,11,10,0],packed:!0,p:1,render:ds},rgb10a2unorm:{channels:"rgba",bitsPerChannel:[10,10,10,2],packed:!0,p:1},"rgb10a2uint-webgl":{channels:"rgba",bitsPerChannel:[10,10,10,2],packed:!0,p:1,wgpu:!1},"rgb16unorm-webgl":{f:Vt},"rgb16snorm-webgl":{f:Vt},rg32uint:{},rg32sint:{},rg32float:{render:!1,filter:ps},rgba16uint:{},rgba16sint:{},rgba16float:{render:wn,filter:Li},"rgba16unorm-webgl":{render:Vt},"rgba16snorm-webgl":{render:An},"rgb32float-webgl":{render:ds,filter:ps},rgba32uint:{},rgba32sint:{},rgba32float:{render:ds,filter:ps},stencil8:{attachment:"stencil",bitsPerChannel:[8,0,0,0],dataType:"uint8"},depth16unorm:{attachment:"depth",bitsPerChannel:[16,0,0,0],dataType:"uint16"},depth24plus:{attachment:"depth",bitsPerChannel:[24,0,0,0],dataType:"uint32"},depth32float:{attachment:"depth",bitsPerChannel:[32,0,0,0],dataType:"float32"},"depth24plus-stencil8":{attachment:"depth-stencil",bitsPerChannel:[24,8,0,0],packed:!0},"depth32float-stencil8":{attachment:"depth-stencil",bitsPerChannel:[32,8,0,0],packed:!0},"bc1-rgb-unorm-webgl":{f:ae},"bc1-rgb-unorm-srgb-webgl":{f:ae},"bc1-rgba-unorm":{f:ae},"bc1-rgba-unorm-srgb":{f:ae},"bc2-rgba-unorm":{f:ae},"bc2-rgba-unorm-srgb":{f:ae},"bc3-rgba-unorm":{f:ae},"bc3-rgba-unorm-srgb":{f:ae},"bc4-r-unorm":{f:ae},"bc4-r-snorm":{f:ae},"bc5-rg-unorm":{f:ae},"bc5-rg-snorm":{f:ae},"bc6h-rgb-ufloat":{f:ae},"bc6h-rgb-float":{f:ae},"bc7-rgba-unorm":{f:ae},"bc7-rgba-unorm-srgb":{f:ae},"etc2-rgb8unorm":{f:Ce},"etc2-rgb8unorm-srgb":{f:Ce},"etc2-rgb8a1unorm":{f:Ce},"etc2-rgb8a1unorm-srgb":{f:Ce},"etc2-rgba8unorm":{f:Ce},"etc2-rgba8unorm-srgb":{f:Ce},"eac-r11unorm":{f:Ce},"eac-r11snorm":{f:Ce},"eac-rg11unorm":{f:Ce},"eac-rg11snorm":{f:Ce},"astc-4x4-unorm":{f:H},"astc-4x4-unorm-srgb":{f:H},"astc-5x4-unorm":{f:H},"astc-5x4-unorm-srgb":{f:H},"astc-5x5-unorm":{f:H},"astc-5x5-unorm-srgb":{f:H},"astc-6x5-unorm":{f:H},"astc-6x5-unorm-srgb":{f:H},"astc-6x6-unorm":{f:H},"astc-6x6-unorm-srgb":{f:H},"astc-8x5-unorm":{f:H},"astc-8x5-unorm-srgb":{f:H},"astc-8x6-unorm":{f:H},"astc-8x6-unorm-srgb":{f:H},"astc-8x8-unorm":{f:H},"astc-8x8-unorm-srgb":{f:H},"astc-10x5-unorm":{f:H},"astc-10x5-unorm-srgb":{f:H},"astc-10x6-unorm":{f:H},"astc-10x6-unorm-srgb":{f:H},"astc-10x8-unorm":{f:H},"astc-10x8-unorm-srgb":{f:H},"astc-10x10-unorm":{f:H},"astc-10x10-unorm-srgb":{f:H},"astc-12x10-unorm":{f:H},"astc-12x10-unorm-srgb":{f:H},"astc-12x12-unorm":{f:H},"astc-12x12-unorm-srgb":{f:H},"pvrtc-rgb4unorm-webgl":{f:fs},"pvrtc-rgba4unorm-webgl":{f:fs},"pvrtc-rbg2unorm-webgl":{f:fs},"pvrtc-rgba2unorm-webgl":{f:fs},"etc1-rbg-unorm-webgl":{f:Ff},"atc-rgb-unorm-webgl":{f:Tn},"atc-rgba-unorm-webgl":{f:Tn},"atc-rgbai-unorm-webgl":{f:Tn}},Lf=["bc1","bc2","bc3","bc4","bc5","bc6","bc7","etc1","etc2","eac","atc","astc","pvrtc"],Vf=/^(r|rg|rgb|rgba|bgra)([0-9]*)([a-z]*)(-srgb)?(-webgl)?$/;function Ha(s){return Lf.some(e=>s.startsWith(e))}function kr(s){let e=$f(s);if(Ha(s)){e.channels="rgb",e.components=3,e.bytesPerPixel=1,e.srgb=!1,e.compressed=!0;const n=Wf(s);n&&(e.blockWidth=n.blockWidth,e.blockHeight=n.blockHeight)}const t=Vf.exec(s);if(t){const[,n,r,i,o,a]=t,c=`${i}${r}`,l=Wa(c),u=l.byteLength*8,h=n.length,f=[u,h>=2?u:0,h>=3?u:0,h>=4?u:0];e={format:s,attachment:e.attachment,dataType:l.dataType,components:h,channels:n,integer:l.integer,signed:l.signed,normalized:l.normalized,bitsPerChannel:f,bytesPerPixel:l.byteLength*n.length,packed:e.packed,srgb:e.srgb},a==="-webgl"&&(e.webgl=!0),o==="-srgb"&&(e.srgb=!0)}return s.endsWith("-webgl")&&(e.webgl=!0),s.endsWith("-srgb")&&(e.srgb=!0),e}function $f(s){const e=ja(s),t=e.bytesPerPixel||1,n=e.bitsPerChannel||[8,8,8,8];return delete e.bitsPerChannel,delete e.bytesPerPixel,delete e.f,delete e.render,delete e.filter,delete e.blend,delete e.store,{...e,format:s,attachment:e.attachment||"color",channels:e.channels||"r",components:e.components||e.channels?.length||1,bytesPerPixel:t,bitsPerChannel:n,dataType:e.dataType||"uint8",srgb:e.srgb??!1,packed:e.packed??!1,webgl:e.webgl??!1,integer:e.integer??!1,signed:e.signed??!1,normalized:e.normalized??!1,compressed:e.compressed??!1}}function Wf(s){const t=/.*-(\d+)x(\d+)-.*/.exec(s);if(t){const[,n,r]=t;return{blockWidth:Number(n),blockHeight:Number(r)}}return null}function jf(s){const e=ja(s),t={format:s,create:e.f??!0,render:e.render??!0,filter:e.filter??!0,blend:e.blend??!0,store:e.store??!0},n=kr(s),r=s.startsWith("depth")||s.startsWith("stencil"),i=n?.signed,o=n?.integer,a=n?.webgl;return t.render&&=!i,t.filter&&=!r&&!i&&!o&&!a,t}class Hf{}class zf{features;disabledFeatures;constructor(e=[],t){this.features=new Set(e),this.disabledFeatures=t||{}}*[Symbol.iterator](){yield*this.features}has(e){return!this.disabledFeatures?.[e]&&this.features.has(e)}}class Ke{static defaultProps={id:null,powerPreference:"high-performance",failIfMajorPerformanceCaveat:!1,createCanvasContext:void 0,onError:e=>C.error(e.message)(),_reuseDevices:!1,_requestMaxLimits:!0,_factoryDestroyPolicy:"unused",_initializeFeatures:!0,_disabledFeatures:{"compilation-status-async-webgl":!0},_resourceDefaults:{},webgl:{},debug:C.get("debug")||void 0,debugShaders:C.get("debug-shaders")||void 0,debugFramebuffers:!!C.get("debug-framebuffers"),debugWebGL:!!C.get("debug-webgl"),debugSpectorJS:void 0,debugSpectorJSUrl:void 0,_handle:void 0};get[Symbol.toStringTag](){return"Device"}constructor(e){this.props={...Ke.defaultProps,...e},this.id=this.props.id||nn(this[Symbol.toStringTag].toLowerCase())}id;props;userData={};statsManager=$a;timestamp=0;_reused=!1;_lumaData={};getTextureFormatCapabilities(e){const t=jf(e),n=o=>(typeof o=="string"?this.features.has(o):o)??!0,r=n(t.create),i={format:e,create:r,render:r&&n(t.render),filter:r&&n(t.filter),blend:r&&n(t.blend),store:r&&n(t.store)};return this._getDeviceSpecificTextureFormatCapabilities(i)}isTextureFormatSupported(e,t){return this.getTextureFormatCapabilities(e).create}isTextureFormatFilterable(e){return this.getTextureFormatCapabilities(e).filter}isTextureFormatRenderable(e){return this.getTextureFormatCapabilities(e).render}isTextureFormatCompressed(e){return Ha(e)}loseDevice(){return!1}reportError(e){this.props.onError(e)}getDefaultCanvasContext(){if(!this.canvasContext)throw new Error("Device has no default CanvasContext. See props.createCanvasContext");return this.canvasContext}createCommandEncoder(e={}){throw new Error("not implemented")}incrementTimestamp(){return this.timestamp++}onError(e){this.props.onError(e)}getCanvasContext(){return this.getDefaultCanvasContext()}readPixelsToArrayWebGL(e,t){throw new Error("not implemented")}readPixelsToBufferWebGL(e,t){throw new Error("not implemented")}setParametersWebGL(e){throw new Error("not implemented")}getParametersWebGL(e){throw new Error("not implemented")}withParametersWebGL(e,t){throw new Error("not implemented")}clearWebGL(e){throw new Error("not implemented")}resetWebGL(){throw new Error("not implemented")}static _getCanvasContextProps(e){return e.createCanvasContext===!0?{}:e.createCanvasContext}_normalizeBufferProps(e){(e instanceof ArrayBuffer||ArrayBuffer.isView(e))&&(e={data:e});const t={...e};return(e.usage||0)&q.INDEX&&!e.indexType&&(e.data instanceof Uint32Array?t.indexType="uint32":e.data instanceof Uint16Array?t.indexType="uint16":C.warn("indices buffer content must be of integer type")()),t}}const Xf=ht()&&typeof document<"u",Yf=()=>Xf&&document.readyState==="complete",qf="set luma.log.level=1 (or higher) to trace rendering",Vi="No matching device found. Ensure `@luma.gl/webgl` and/or `@luma.gl/webgpu` modules are imported.";class wt{static defaultProps={...Ke.defaultProps,type:"best-available",adapters:void 0,waitForPageLoad:!0};static pageLoaded=Kf().then(()=>{C.probe(2,"DOM is loaded")()});stats=$a;log=C;VERSION="9.1.9";spector;preregisteredAdapters=new Map;constructor(){if(globalThis.luma){if(globalThis.luma.VERSION!==this.VERSION)throw C.error(`Found luma.gl ${globalThis.luma.VERSION} while initialzing ${this.VERSION}`)(),C.error("'yarn why @luma.gl/core' can help identify the source of the conflict")(),new Error("luma.gl - multiple versions detected: see console log");C.error("This version of luma.gl has already been initialized")()}C.log(1,`${this.VERSION} - ${qf}`)(),globalThis.luma=this}registerAdapters(e){for(const t of e)this.preregisteredAdapters.set(t.type,t)}getSupportedAdapters(e=[]){const t=this.getAdapterMap(e);return Array.from(t).map(([,n])=>n).filter(n=>n.isSupported?.()).map(n=>n.type)}getBestAvailableAdapter(e=[]){const t=this.getAdapterMap(e);return t.get("webgpu")?.isSupported?.()?"webgpu":t.get("webgl")?.isSupported?.()?"webgl":null}setDefaultDeviceProps(e){Object.assign(wt.defaultProps,e)}async createDevice(e={}){e={...wt.defaultProps,...e},e.waitForPageLoad&&await wt.pageLoaded;const t=this.getAdapterMap(e.adapters);let n=e.type||"";n==="best-available"&&(n=this.getBestAvailableAdapter(e.adapters)||n);const o=await(this.getAdapterMap(e.adapters)||t).get(n)?.create?.(e);if(o)return o;throw new Error(Vi)}async attachDevice(e){const t=this.getAdapterMap(e.adapters);let n="";e.handle instanceof WebGL2RenderingContext&&(n="webgl"),e.createCanvasContext&&await wt.pageLoaded,e.handle===null&&(n="unknown");const i=await t.get(n)?.attach?.(null);if(i)return i;throw new Error(Vi)}enforceWebGL2(e=!0,t=[]){const r=this.getAdapterMap(t).get("webgl");r||C.warn("enforceWebGL2: webgl adapter not found")(),r?.enforceWebGL2?.(e)}getAdapterMap(e=[]){const t=new Map(this.preregisteredAdapters);for(const n of e)t.set(n.type,n);return t}registerDevices(e){C.warn("luma.registerDevices() is deprecated, use luma.registerAdapters() instead");for(const t of e){const n=t.adapter;n&&this.preregisteredAdapters.set(n.type,n)}}}const Gn=new wt;function Kf(){return Yf()||typeof window>"u"?Promise.resolve():new Promise(s=>{window.addEventListener("load",()=>s())})}class Zf{}class Nr{static defaultProps={canvas:null,width:800,height:600,useDevicePixels:!0,autoResize:!0,container:null,visible:!0,alphaMode:"opaque",colorSpace:"srgb"};id;props;canvas;htmlCanvas;offscreenCanvas;type;width=1;height=1;resizeObserver;_canvasSizeInfo={clientWidth:0,clientHeight:0,devicePixelRatio:1};toString(){return`${this[Symbol.toStringTag]}(${this.id})`}constructor(e){if(this.props={...Nr.defaultProps,...e},e=this.props,!ht()){this.id="node-canvas-context",this.type="node",this.width=this.props.width,this.height=this.props.height,this.canvas=null;return}if(e.canvas)typeof e.canvas=="string"?this.canvas=Jf(e.canvas):this.canvas=e.canvas;else{const t=Gf(e),n=Qf(e?.container||null);n.insertBefore(t,n.firstChild),this.canvas=t,e?.visible||(this.canvas.style.visibility="hidden")}this.canvas instanceof HTMLCanvasElement?(this.id=this.canvas.id,this.type="html-canvas",this.htmlCanvas=this.canvas):(this.id="offscreen-canvas",this.type="offscreen-canvas",this.offscreenCanvas=this.canvas),this.canvas instanceof HTMLCanvasElement&&e.autoResize&&(this.resizeObserver=new ResizeObserver(t=>{for(const n of t)n.target===this.canvas&&this.update()}),this.resizeObserver.observe(this.canvas))}getDevicePixelRatio(e){return typeof OffscreenCanvas<"u"&&this.canvas instanceof OffscreenCanvas||(e=e===void 0?this.props.useDevicePixels:e,!e||e<=0)?1:e===!0?typeof window<"u"&&window.devicePixelRatio||1:e}getPixelSize(){switch(this.type){case"node":return[this.width,this.height];case"offscreen-canvas":return[this.canvas.width,this.canvas.height];case"html-canvas":const e=this.getDevicePixelRatio(),t=this.canvas;return t.parentElement?[t.clientWidth*e,t.clientHeight*e]:[this.canvas.width,this.canvas.height];default:throw new Error(this.type)}}getAspect(){const[e,t]=this.getPixelSize();return e/t}cssToDeviceRatio(){try{const[e]=this.getDrawingBufferSize(),t=this._canvasSizeInfo.clientWidth||this.htmlCanvas?.clientWidth;return t?e/t:1}catch{return 1}}cssToDevicePixels(e,t=!0){const n=this.cssToDeviceRatio(),[r,i]=this.getDrawingBufferSize();return ed(e,n,r,i,t)}setDevicePixelRatio(e,t={}){if(!this.htmlCanvas)return;let n="width"in t?t.width:this.htmlCanvas.clientWidth,r="height"in t?t.height:this.htmlCanvas.clientHeight;(!n||!r)&&(C.log(1,"Canvas clientWidth/clientHeight is 0")(),e=1,n=this.htmlCanvas.width||1,r=this.htmlCanvas.height||1);const i=this._canvasSizeInfo;if(i.clientWidth!==n||i.clientHeight!==r||i.devicePixelRatio!==e){let o=e;const a=Math.floor(n*o),c=Math.floor(r*o);if(this.htmlCanvas.width=a,this.htmlCanvas.height=c,this.device.gl){const[u,h]=this.getDrawingBufferSize();(u!==a||h!==c)&&(o=Math.min(u/n,h/r),this.htmlCanvas.width=Math.floor(n*o),this.htmlCanvas.height=Math.floor(r*o),C.warn("Device pixel ratio clamped")()),this._canvasSizeInfo.clientWidth=n,this._canvasSizeInfo.clientHeight=r,this._canvasSizeInfo.devicePixelRatio=e}}}getDrawingBufferSize(){const e=this.device.gl;return e?[e.drawingBufferWidth,e.drawingBufferHeight]:this.getPixelSize()}_setAutoCreatedCanvasId(e){this.htmlCanvas?.id==="lumagl-auto-created-canvas"&&(this.htmlCanvas.id=e)}}function Qf(s){if(typeof s=="string"){const e=document.getElementById(s);if(!e)throw new Error(`${s} is not an HTML element`);return e}else if(s)return s;return document.body}function Jf(s){const e=document.getElementById(s);if(!(e instanceof HTMLCanvasElement))throw new Error("Object is not a canvas element");return e}function Gf(s){const{width:e,height:t}=s,n=document.createElement("canvas");return n.id=nn("lumagl-auto-created-canvas"),n.width=e||1,n.height=t||1,n.style.width=Number.isFinite(e)?`${e}px`:"100%",n.style.height=Number.isFinite(t)?`${t}px`:"100%",n}function ed(s,e,t,n,r){const i=s,o=$i(i[0],e,t);let a=Wi(i[1],e,n,r),c=$i(i[0]+1,e,t);const l=c===t-1?c:c-1;c=Wi(i[1]+1,e,n,r);let u;return r?(c=c===0?c:c+1,u=a,a=c):u=c===n-1?c:c-1,{x:o,y:a,width:Math.max(l-o+1,1),height:Math.max(u-a+1,1)}}function $i(s,e,t){return Math.min(Math.round(s*e),t-1)}function Wi(s,e,t,n){return n?Math.max(0,t-1-Math.round(s*e)):Math.min(Math.round(s*e),t-1)}class z extends X{static COPY_SRC=1;static COPY_DST=2;static TEXTURE=4;static STORAGE=8;static RENDER_ATTACHMENT=16;static CubeFaces=["+X","-X","+Y","-Y","+Z","-Z"];static defaultProps={...X.defaultProps,data:null,dimension:"2d",format:"rgba8unorm",width:void 0,height:void 0,depth:1,mipmaps:!1,compressed:!1,usage:0,mipLevels:void 0,samples:void 0,sampler:{},view:void 0,flipY:void 0};get[Symbol.toStringTag](){return"Texture"}toString(){return`Texture(${this.id},${this.format},${this.width}x${this.height})`}dimension;format;width;height;depth;mipLevels;updateTimestamp;constructor(e,t){if(t=z.normalizeProps(e,t),super(e,t,z.defaultProps),this.dimension=this.props.dimension,this.format=this.props.format,this.width=this.props.width,this.height=this.props.height,this.depth=this.props.depth,this.props.width===void 0||this.props.height===void 0){const n=z.getTextureDataSize(this.props.data);this.width=n?.width||1,this.height=n?.height||1}this.props.mipmaps&&this.props.mipLevels===void 0&&(this.props.mipLevels="pyramid"),this.mipLevels=this.props.mipLevels==="pyramid"?z.getMipLevelCount(this.width,this.height):this.props.mipLevels||1,this.updateTimestamp=e.incrementTimestamp()}clone(e){return this.device.createTexture({...this.props,...e})}static isExternalImage(e){return typeof ImageData<"u"&&e instanceof ImageData||typeof ImageBitmap<"u"&&e instanceof ImageBitmap||typeof HTMLImageElement<"u"&&e instanceof HTMLImageElement||typeof HTMLVideoElement<"u"&&e instanceof HTMLVideoElement||typeof VideoFrame<"u"&&e instanceof VideoFrame||typeof HTMLCanvasElement<"u"&&e instanceof HTMLCanvasElement||typeof OffscreenCanvas<"u"&&e instanceof OffscreenCanvas}static getExternalImageSize(e){if(typeof ImageData<"u"&&e instanceof ImageData||typeof ImageBitmap<"u"&&e instanceof ImageBitmap||typeof HTMLCanvasElement<"u"&&e instanceof HTMLCanvasElement||typeof OffscreenCanvas<"u"&&e instanceof OffscreenCanvas)return{width:e.width,height:e.height};if(typeof HTMLImageElement<"u"&&e instanceof HTMLImageElement)return{width:e.naturalWidth,height:e.naturalHeight};if(typeof HTMLVideoElement<"u"&&e instanceof HTMLVideoElement)return{width:e.videoWidth,height:e.videoHeight};if(typeof VideoFrame<"u"&&e instanceof VideoFrame)return{width:e.displayWidth,height:e.displayHeight};throw new Error("Unknown image type")}static isTextureLevelData(e){const t=e?.data;return ArrayBuffer.isView(t)}static getTextureDataSize(e){if(!e||ArrayBuffer.isView(e))return null;if(Array.isArray(e))return z.getTextureDataSize(e[0]);if(z.isExternalImage(e))return z.getExternalImageSize(e);if(e&&typeof e=="object"&&e.constructor===Object){const n=Object.values(e)[0];return{width:n.width,height:n.height}}throw new Error("texture size deduction failed")}static normalizeTextureData(e,t){let n;return ArrayBuffer.isView(e)?n=[{data:e,width:t.width,height:t.height}]:Array.isArray(e)?n=e:n=[e],n}static getMipLevelCount(e,t){return Math.floor(Math.log2(Math.max(e,t)))+1}static getCubeFaceDepth(e){switch(e){case"+X":return 0;case"-X":return 1;case"+Y":return 2;case"-Y":return 3;case"+Z":return 4;case"-Z":return 5;default:throw new Error(e)}}static defaultCopyExternalImageOptions={image:void 0,sourceX:0,sourceY:0,width:void 0,height:void 0,depth:1,mipLevel:0,x:0,y:0,z:0,aspect:"all",colorSpace:"srgb",premultipliedAlpha:!1,flipY:!1};static normalizeProps(e,t){const n={...t},r=e?.props?._resourceDefaults?.texture||{};Object.assign(n,r);const{width:i,height:o}=n;return typeof i=="number"&&(n.width=Math.max(1,Math.ceil(i))),typeof o=="number"&&(n.height=Math.max(1,Math.ceil(o))),n}}class rn extends X{static defaultProps={...X.defaultProps,format:void 0,dimension:void 0,aspect:"all",baseMipLevel:0,mipLevelCount:void 0,baseArrayLayer:0,arrayLayerCount:void 0};get[Symbol.toStringTag](){return"TextureView"}constructor(e,t){super(e,t,rn.defaultProps)}}function td(s,e,t){let n="";const r=e.split(/\r?\n/),i=s.slice().sort((o,a)=>o.lineNum-a.lineNum);switch(t?.showSourceCode||"no"){case"all":let o=0;for(let a=1;a<=r.length;a++)for(n+=za(r[a-1],a,t);i.length>o&&i[o].lineNum===a;){const c=i[o++];n+=ji(c,r,c.lineNum,{...t,inlineSource:!1})}return n;case"issues":case"no":for(const a of s)n+=ji(a,r,a.lineNum,{inlineSource:t?.showSourceCode!=="no"});return n}}function ji(s,e,t,n){if(n?.inlineSource){const i=sd(e,t),o=s.linePos>0?`${" ".repeat(s.linePos+5)}^^^
`:"";return`
${i}${o}${s.type.toUpperCase()}: ${s.message}

`}const r=s.type==="error"?"red":"#8B4000";return n?.html?`<div class='luma-compiler-log-error' style="color:${r};"><b> ${s.type.toUpperCase()}: ${s.message}</b></div>`:`${s.type.toUpperCase()}: ${s.message}`}function sd(s,e,t){let n="";for(let r=e-2;r<=e;r++){const i=s[r-1];i!==void 0&&(n+=za(i,e,t))}return n}function za(s,e,t){const n=t?.html?rd(s):s;return`${nd(String(e),4)}: ${n}${t?.html?"<br/>":`
`}`}function nd(s,e){let t="";for(let n=s.length;n<e;++n)t+=" ";return t+s}function rd(s){return s.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;")}class on extends X{static defaultProps={...X.defaultProps,language:"auto",stage:void 0,source:"",sourceMap:null,entryPoint:"main",debugShaders:void 0};get[Symbol.toStringTag](){return"Shader"}stage;source;compilationStatus="pending";constructor(e,t){t={...t,debugShaders:t.debugShaders||e.props.debugShaders||"errors"},super(e,{id:id(t),...t},on.defaultProps),this.stage=this.props.stage,this.source=this.props.source}getCompilationInfoSync(){return null}getTranslatedSource(){return null}async debugShader(){const e=this.props.debugShaders;switch(e){case"never":return;case"errors":if(this.compilationStatus==="success")return;break}const t=await this.getCompilationInfo();e==="warnings"&&t?.length===0||this._displayShaderLog(t)}_displayShaderLog(e){if(typeof document>"u"||!document?.createElement)return;const t=Xa(this.source),n=`${this.stage} ${t}`;let r=td(e,this.source,{showSourceCode:"all",html:!0});const i=this.getTranslatedSource();i&&(r+=`<br /><br /><h1>Translated Source</h1><br /><br /><code style="user-select:text;"><pre>${i}</pre></code>`);const o=document.createElement("Button");o.innerHTML=`
<h1>Shader Compilation Error in ${n}</h1><br /><br />
<code style="user-select:text;"><pre>
${r}
</pre></code>`,o.style.top="10px",o.style.left="10px",o.style.position="absolute",o.style.zIndex="9999",o.style.width="100%",o.style.textAlign="left",document.body.appendChild(o),document.getElementsByClassName("luma-compiler-log-error")[0]?.scrollIntoView(),o.onclick=()=>{const c=`data:text/plain,${encodeURIComponent(this.source)}`;navigator.clipboard.writeText(c)}}}function id(s){return Xa(s.source)||s.id||nn(`unnamed ${s.stage}-shader`)}function Xa(s,e="unnamed"){const n=/#define[\s*]SHADER_NAME[\s*]([A-Za-z0-9_-]+)[\s*]/.exec(s);return n?n[1]:e}class ss extends X{static defaultProps={...X.defaultProps,type:"color-sampler",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge",addressModeW:"clamp-to-edge",magFilter:"nearest",minFilter:"nearest",mipmapFilter:"none",lodMinClamp:0,lodMaxClamp:32,compare:"less-equal",maxAnisotropy:1};get[Symbol.toStringTag](){return"Sampler"}constructor(e,t){t=ss.normalizeProps(e,t),super(e,t,ss.defaultProps)}static normalizeProps(e,t){const n=e?.props?._resourceDefaults?.sampler||{};return{...t,...n}}}class an extends X{static defaultProps={...X.defaultProps,width:1,height:1,colorAttachments:[],depthStencilAttachment:null};get[Symbol.toStringTag](){return"Framebuffer"}width;height;constructor(e,t={}){super(e,t,an.defaultProps),this.width=this.props.width,this.height=this.props.height}clone(e){const t=this.colorAttachments.map(r=>r.texture.clone(e)),n=this.depthStencilAttachment&&this.depthStencilAttachment.texture.clone(e);return this.device.createFramebuffer({...this.props,colorAttachments:t,depthStencilAttachment:n})}resize(e){let t=!e;if(e){const[n,r]=Array.isArray(e)?e:[e.width,e.height];t=t||r!==this.height||n!==this.width,this.width=n,this.height=r}t&&(C.log(2,`Resizing framebuffer ${this.id} to ${this.width}x${this.height}`)(),this.resizeAttachments(this.width,this.height))}autoCreateAttachmentTextures(){if(this.props.colorAttachments.length===0&&!this.props.depthStencilAttachment)throw new Error("Framebuffer has noattachments");this.colorAttachments=this.props.colorAttachments.map((t,n)=>{if(typeof t=="string"){const r=this.createColorTexture(t,n);return this.attachResource(r),r.view}return t instanceof z?t.view:t});const e=this.props.depthStencilAttachment;if(e)if(typeof e=="string"){const t=this.createDepthStencilTexture(e);this.attachResource(t),this.depthStencilAttachment=t.view}else e instanceof z?this.depthStencilAttachment=e.view:this.depthStencilAttachment=e}createColorTexture(e,t){return this.device.createTexture({id:`${this.id}-color-attachment-${t}`,usage:z.RENDER_ATTACHMENT,format:e,width:this.width,height:this.height,sampler:{magFilter:"linear",minFilter:"linear"}})}createDepthStencilTexture(e){return this.device.createTexture({id:`${this.id}-depth-stencil-attachment`,usage:z.RENDER_ATTACHMENT,format:e,width:this.width,height:this.height,mipmaps:!1})}resizeAttachments(e,t){for(let n=0;n<this.colorAttachments.length;++n)if(this.colorAttachments[n]){const r=this.colorAttachments[n].texture.clone({width:e,height:t});this.destroyAttachedResource(this.colorAttachments[n]),this.colorAttachments[n]=r.view,this.attachResource(r.view)}if(this.depthStencilAttachment){const n=this.depthStencilAttachment.texture.clone({width:e,height:t});this.destroyAttachedResource(this.depthStencilAttachment),this.depthStencilAttachment=n.view,this.attachResource(n)}this.updateAttachments()}}class Pt extends X{static defaultProps={...X.defaultProps,vs:null,vertexEntryPoint:"vertexMain",vsConstants:{},fs:null,fragmentEntryPoint:"fragmentMain",fsConstants:{},shaderLayout:null,bufferLayout:[],topology:"triangle-list",parameters:{},bindings:{},uniforms:{}};get[Symbol.toStringTag](){return"RenderPipeline"}shaderLayout;bufferLayout;linkStatus="pending";hash="";constructor(e,t){super(e,t,Pt.defaultProps),this.shaderLayout=this.props.shaderLayout,this.bufferLayout=this.props.bufferLayout||[]}setUniformsWebGL(e){throw new Error("Use uniform blocks")}}class et extends X{static defaultClearColor=[0,0,0,1];static defaultClearDepth=1;static defaultClearStencil=0;static defaultProps={...X.defaultProps,framebuffer:null,parameters:void 0,clearColor:et.defaultClearColor,clearColors:void 0,clearDepth:et.defaultClearDepth,clearStencil:et.defaultClearStencil,depthReadOnly:!1,stencilReadOnly:!1,discard:!1,occlusionQuerySet:void 0,timestampQuerySet:void 0,beginTimestampIndex:void 0,endTimestampIndex:void 0};get[Symbol.toStringTag](){return"RenderPass"}constructor(e,t){t=et.normalizeProps(e,t),super(e,t,et.defaultProps)}static normalizeProps(e,t){return{...e.props._resourceDefaults?.renderPass,...t}}}class Bs extends X{static defaultProps={...X.defaultProps,shader:void 0,entryPoint:void 0,constants:{},shaderLayout:void 0};get[Symbol.toStringTag](){return"ComputePipeline"}hash="";shaderLayout;constructor(e,t){super(e,t,Bs.defaultProps),this.shaderLayout=t.shaderLayout}}class Dr extends X{static defaultProps={...X.defaultProps,measureExecutionTime:void 0};get[Symbol.toStringTag](){return"CommandEncoder"}constructor(e,t){super(e,t,Dr.defaultProps)}}class Fr extends X{static defaultProps={...X.defaultProps};get[Symbol.toStringTag](){return"CommandBuffer"}constructor(e,t){super(e,t,Fr.defaultProps)}}function od(s){const[e,t]=cd[s],n=e==="i32"||e==="u32",r=e!=="u32",i=ld[e]*t,o=ad(e,t);return{dataType:e,components:t,defaultVertexFormat:o,byteLength:i,integer:n,signed:r}}function ad(s,e){let t;switch(s){case"f32":t="float32";break;case"i32":t="sint32";break;case"u32":t="uint32";break;case"f16":return e<=2?"float16x2":"float16x4"}return e===1?t:`${t}x${e}`}const cd={f32:["f32",1],"vec2<f32>":["f32",2],"vec3<f32>":["f32",3],"vec4<f32>":["f32",4],f16:["f16",1],"vec2<f16>":["f16",2],"vec3<f16>":["f16",3],"vec4<f16>":["f16",4],i32:["i32",1],"vec2<i32>":["i32",2],"vec3<i32>":["i32",3],"vec4<i32>":["i32",4],u32:["u32",1],"vec2<u32>":["u32",2],"vec3<u32>":["u32",3],"vec4<u32>":["u32",4]},ld={f32:4,f16:2,i32:4,u32:4};function Ya(s){let e;s.endsWith("-webgl")&&(s.replace("-webgl",""),e=!0);const[t,n]=s.split("x"),r=t,i=n?parseInt(n):1,o=Wa(r),a={type:r,components:i,byteLength:o.byteLength*i,integer:o.integer,signed:o.signed,normalized:o.normalized};return e&&(a.webglOnly=!0),a}function qa(s,e){const t={};for(const n of s.attributes){const r=hd(s,e,n.name);r&&(t[n.name]=r)}return t}function ud(s,e,t=16){const n=qa(s,e),r=new Array(t).fill(null);for(const i of Object.values(n))r[i.location]=i;return r}function hd(s,e,t){const n=fd(s,t),r=dd(e,t);if(!n)return null;const i=od(n.type),o=r?.vertexFormat||i.defaultVertexFormat,a=Ya(o);return{attributeName:r?.attributeName||n.name,bufferName:r?.bufferName||n.name,location:n.location,shaderType:n.type,shaderDataType:i.dataType,shaderComponents:i.components,vertexFormat:o,bufferDataType:a.type,bufferComponents:a.components,normalized:a.normalized,integer:i.integer,stepMode:r?.stepMode||n.stepMode||"vertex",byteOffset:r?.byteOffset||0,byteStride:r?.byteStride||0}}function fd(s,e){const t=s.attributes.find(n=>n.name===e);return t||C.warn(`shader layout attribute "${e}" not present in shader`),t||null}function dd(s,e){pd(s);let t=gd(s,e);return t||(t=_d(s,e),t)?t:(C.warn(`layout for attribute "${e}" not present in buffer layout`),null)}function pd(s){for(const e of s)(e.attributes&&e.format||!e.attributes&&!e.format)&&C.warn(`BufferLayout ${name} must have either 'attributes' or 'format' field`)}function gd(s,e){for(const t of s)if(t.format&&t.name===e)return{attributeName:t.name,bufferName:e,stepMode:t.stepMode,vertexFormat:t.format,byteOffset:0,byteStride:t.byteStride||0};return null}function _d(s,e){for(const t of s){let n=t.byteStride;if(typeof t.byteStride!="number")for(const i of t.attributes||[]){const o=Ya(i.format);n+=o.byteLength}const r=t.attributes?.find(i=>i.attribute===e);if(r)return{attributeName:r.attribute,bufferName:t.name,stepMode:t.stepMode,vertexFormat:r.format,byteOffset:r.byteOffset,byteStride:n}}return null}class Br extends X{static defaultProps={...X.defaultProps,renderPipeline:null};get[Symbol.toStringTag](){return"VertexArray"}maxVertexAttributes;attributeInfos;indexBuffer=null;attributes;constructor(e,t){super(e,t,Br.defaultProps),this.maxVertexAttributes=e.limits.maxVertexAttributes,this.attributes=new Array(this.maxVertexAttributes).fill(null);const{shaderLayout:n,bufferLayout:r}=t.renderPipeline||{};if(!n||!r)throw new Error("VertexArray");this.attributeInfos=ud(n,r,this.maxVertexAttributes)}setConstantWebGL(e,t){this.device.reportError(new Error("constant attributes not supported"))}}class Ur extends X{static defaultProps={...X.defaultProps,layout:void 0,buffers:{}};get[Symbol.toStringTag](){return"TransformFeedback"}constructor(e,t){super(e,t,Ur.defaultProps)}}class Lr extends X{static defaultProps={...X.defaultProps,type:void 0,count:void 0};get[Symbol.toStringTag](){return"QuerySet"}constructor(e,t){super(e,t,Lr.defaultProps)}}const md={f32:{type:"f32",components:1},i32:{type:"i32",components:1},u32:{type:"u32",components:1},"vec2<f32>":{type:"f32",components:2},"vec3<f32>":{type:"f32",components:3},"vec4<f32>":{type:"f32",components:4},"vec2<i32>":{type:"i32",components:2},"vec3<i32>":{type:"i32",components:3},"vec4<i32>":{type:"i32",components:4},"vec2<u32>":{type:"u32",components:2},"vec3<u32>":{type:"u32",components:3},"vec4<u32>":{type:"u32",components:4},"mat2x2<f32>":{type:"f32",components:4},"mat2x3<f32>":{type:"f32",components:6},"mat2x4<f32>":{type:"f32",components:8},"mat3x2<f32>":{type:"f32",components:6},"mat3x3<f32>":{type:"f32",components:9},"mat3x4<f32>":{type:"f32",components:12},"mat4x2<f32>":{type:"f32",components:8},"mat4x3<f32>":{type:"f32",components:12},"mat4x4<f32>":{type:"f32",components:16}};function bd(s){return md[s]}function yd(s,e){switch(e){case 1:return s;case 2:return s+s%2;default:return s+(4-s%4)%4}}let gs;function Ka(s){return(!gs||gs.byteLength<s)&&(gs=new ArrayBuffer(s)),gs}function Td(s,e){const t=Ka(s.BYTES_PER_ELEMENT*e);return new s(t,0,e)}function wd(s){return ArrayBuffer.isView(s)&&!(s instanceof DataView)}function Us(s){return Array.isArray(s)?s.length===0||typeof s[0]=="number":wd(s)}const Hi=1024;class vd{layout={};byteLength;constructor(e){let t=0;for(const[r,i]of Object.entries(e)){const o=bd(i),{type:a,components:c}=o;t=yd(t,c);const l=t;t+=c,this.layout[r]={type:a,size:c,offset:l}}t+=(4-t%4)%4;const n=t*4;this.byteLength=Math.max(n,Hi)}getData(e){const t=Math.max(this.byteLength,Hi),n=Ka(t),r={i32:new Int32Array(n),u32:new Uint32Array(n),f32:new Float32Array(n),f16:new Uint16Array(n)};for(const[i,o]of Object.entries(e)){const a=this.layout[i];if(!a){C.warn(`Supplied uniform value ${i} not present in uniform block layout`)();continue}const{type:c,size:l,offset:u}=a,h=r[c];if(l===1){if(typeof o!="number"&&typeof o!="boolean"){C.warn(`Supplied value for single component uniform ${i} is not a number: ${o}`)();continue}h[u]=Number(o)}else{if(!Us(o)){C.warn(`Supplied value for multi component / array uniform ${i} is not a numeric array: ${o}`)();continue}h.set(o,u)}}return new Uint8Array(n)}has(e){return!!this.layout[e]}get(e){return this.layout[e]}}function Ad(s,e,t=16){if(s!==e)return!1;const n=s,r=e;if(!Us(n))return!1;if(Us(r)&&n.length===r.length){for(let i=0;i<n.length;++i)if(r[i]!==n[i])return!1}return!0}function xd(s){return Us(s)?s.slice():s}class Ed{name;uniforms={};modifiedUniforms={};modified=!0;bindingLayout={};needsRedraw="initialized";constructor(e){if(this.name=e?.name||"unnamed",e?.name&&e?.shaderLayout){const t=e?.shaderLayout.bindings?.find(r=>r.type==="uniform"&&r.name===e?.name);if(!t)throw new Error(e?.name);const n=t;for(const r of n.uniforms||[])this.bindingLayout[r.name]=r}}setUniforms(e){for(const[t,n]of Object.entries(e))this._setUniform(t,n),this.needsRedraw||this.setNeedsRedraw(`${this.name}.${t}=${n}`)}setNeedsRedraw(e){this.needsRedraw=this.needsRedraw||e}getAllUniforms(){return this.modifiedUniforms={},this.needsRedraw=!1,this.uniforms||{}}_setUniform(e,t){Ad(this.uniforms[e],t)||(this.uniforms[e]=xd(t),this.modifiedUniforms[e]=!0,this.modified=!0)}}class Sd{uniformBlocks=new Map;uniformBufferLayouts=new Map;uniformBuffers=new Map;constructor(e){for(const[t,n]of Object.entries(e)){const r=t,i=new vd(n.uniformTypes||{});this.uniformBufferLayouts.set(r,i);const o=new Ed({name:t});o.setUniforms(n.defaultUniforms||{}),this.uniformBlocks.set(r,o)}}destroy(){for(const e of this.uniformBuffers.values())e.destroy()}setUniforms(e){for(const[t,n]of Object.entries(e))this.uniformBlocks.get(t)?.setUniforms(n);this.updateUniformBuffers()}getUniformBufferByteLength(e){return this.uniformBufferLayouts.get(e)?.byteLength||0}getUniformBufferData(e){const t=this.uniformBlocks.get(e)?.getAllUniforms()||{};return this.uniformBufferLayouts.get(e)?.getData(t)}createUniformBuffer(e,t,n){n&&this.setUniforms(n);const r=this.getUniformBufferByteLength(t),i=e.createBuffer({usage:q.UNIFORM|q.COPY_DST,byteLength:r}),o=this.getUniformBufferData(t);return i.write(o),i}getManagedUniformBuffer(e,t){if(!this.uniformBuffers.get(t)){const n=this.getUniformBufferByteLength(t),r=e.createBuffer({usage:q.UNIFORM|q.COPY_DST,byteLength:n});this.uniformBuffers.set(t,r)}return this.uniformBuffers.get(t)}updateUniformBuffers(){let e=!1;for(const t of this.uniformBlocks.keys()){const n=this.updateUniformBuffer(t);e||=n}return e&&C.log(3,`UniformStore.updateUniformBuffers(): ${e}`)(),e}updateUniformBuffer(e){const t=this.uniformBlocks.get(e);let n=this.uniformBuffers.get(e),r=!1;if(n&&t?.needsRedraw){r||=t.needsRedraw;const i=this.getUniformBufferData(e);n=this.uniformBuffers.get(e),n?.write(i);const o=this.uniformBlocks.get(e)?.getAllUniforms();C.log(4,`Writing to uniform buffer ${String(e)}`,i,o)()}return r}}function Za(s){const e=ArrayBuffer.isView(s)?s.constructor:s;switch(e){case Float32Array:return"float32";case Uint16Array:return"uint16";case Uint32Array:return"uint32";case Uint8Array:case Uint8ClampedArray:return"uint8";case Int8Array:return"sint8";case Int16Array:return"sint16";case Int32Array:return"sint32";default:throw new Error(e.constructor.name)}}function Qa(s){switch(s){case"float32":return Float32Array;case"uint32":return Uint32Array;case"sint32":return Int32Array;case"uint16":case"unorm16":return Uint16Array;case"sint16":case"snorm16":return Int16Array;case"uint8":case"unorm8":return Uint8Array;case"sint8":case"snorm8":return Int8Array;default:throw new Error(s)}}function Rd(s,e,t){if(!e||e>4)throw new Error(`size ${e}`);const n=e;let r=Za(s);if(r==="uint8"&&t&&n===1)return"unorm8-webgl";if(r==="uint8"&&t&&n===3)return"unorm8x3-webgl";if(r==="uint8"||r==="sint8"){if(n===1||n===3)throw new Error(`size: ${e}`);return t&&(r=r.replace("int","norm")),`${r}x${n}`}if(r==="uint16"||r==="sint16"){if(n===1||n===3)throw new Error(`size: ${e}`);return t&&(r=r.replace("int","norm")),`${r}x${n}`}return n===1?r:`${r}x${n}`}class xn{bufferLayouts;constructor(e){this.bufferLayouts=e}getBufferLayout(e){return this.bufferLayouts.find(t=>t.name===e)||null}getAttributeNamesForBuffer(e){return e.attributes?e.attributes?.map(t=>t.attribute):[e.name]}mergeBufferLayouts(e,t){const n=[...e];for(const r of t){const i=n.findIndex(o=>o.name===r.name);i<0?n.push(r):n[i]=r}return n}getBufferIndex(e){const t=this.bufferLayouts.findIndex(n=>n.name===e);return t===-1&&C.warn(`BufferLayout: Missing buffer for "${e}".`)(),t}}function Id(s,e){const t=Object.fromEntries(s.attributes.map(r=>[r.name,r.location])),n=e.slice();return n.sort((r,i)=>{const o=r.attributes?r.attributes.map(u=>u.attribute):[r.name],a=i.attributes?i.attributes.map(u=>u.attribute):[i.name],c=Math.min(...o.map(u=>t[u])),l=Math.min(...a.map(u=>t[u]));return c-l}),n}class be{constructor(e,t){this.name=e,this.attributes=t,this.size=0}get isArray(){return!1}get isStruct(){return!1}get isTemplate(){return!1}get isPointer(){return!1}getTypeName(){return this.name}}class zi{constructor(e,t,n){this.name=e,this.type=t,this.attributes=n,this.offset=0,this.size=0}get isArray(){return this.type.isArray}get isStruct(){return this.type.isStruct}get isTemplate(){return this.type.isTemplate}get align(){return this.type.isStruct?this.type.align:0}get members(){return this.type.isStruct?this.type.members:null}get format(){return this.type.isArray||this.type.isTemplate?this.type.format:null}get count(){return this.type.isArray?this.type.count:0}get stride(){return this.type.isArray?this.type.stride:this.size}}class Xe extends be{constructor(e,t){super(e,t),this.members=[],this.align=0,this.startLine=-1,this.endLine=-1,this.inUse=!1}get isStruct(){return!0}}class Ze extends be{constructor(e,t){super(e,t),this.count=0,this.stride=0}get isArray(){return!0}getTypeName(){return`array<${this.format.getTypeName()}, ${this.count}>`}}class er extends be{constructor(e,t,n){super(e,n),this.format=t}get isPointer(){return!0}getTypeName(){return`&${this.format.getTypeName()}`}}class ct extends be{constructor(e,t,n,r){super(e,n),this.format=t,this.access=r}get isTemplate(){return!0}getTypeName(){let e=this.name;if(this.format!==null){if(e==="vec2"||e==="vec3"||e==="vec4"||e==="mat2x2"||e==="mat2x3"||e==="mat2x4"||e==="mat3x2"||e==="mat3x3"||e==="mat3x4"||e==="mat4x2"||e==="mat4x3"||e==="mat4x4"){if(this.format.name==="f32")return e+="f",e;if(this.format.name==="i32")return e+="i",e;if(this.format.name==="u32")return e+="u",e;if(this.format.name==="bool")return e+="b",e;if(this.format.name==="f16")return e+="h",e}e+=`<${this.format.name}>`}else if(e==="vec2"||e==="vec3"||e==="vec4")return e;return e}}var He;(s=>{s[s.Uniform=0]="Uniform",s[s.Storage=1]="Storage",s[s.Texture=2]="Texture",s[s.Sampler=3]="Sampler",s[s.StorageTexture=4]="StorageTexture"})(He||(He={}));class _s{constructor(e,t,n,r,i,o,a){this.name=e,this.type=t,this.group=n,this.binding=r,this.attributes=i,this.resourceType=o,this.access=a}get isArray(){return this.type.isArray}get isStruct(){return this.type.isStruct}get isTemplate(){return this.type.isTemplate}get size(){return this.type.size}get align(){return this.type.isStruct?this.type.align:0}get members(){return this.type.isStruct?this.type.members:null}get format(){return this.type.isArray||this.type.isTemplate?this.type.format:null}get count(){return this.type.isArray?this.type.count:0}get stride(){return this.type.isArray?this.type.stride:this.size}}class Cd{constructor(e,t){this.name=e,this.type=t}}class Pd{constructor(e,t,n,r){this.name=e,this.type=t,this.locationType=n,this.location=r,this.interpolation=null}}class Xi{constructor(e,t,n,r){this.name=e,this.type=t,this.locationType=n,this.location=r}}class Md{constructor(e,t,n,r){this.name=e,this.type=t,this.attributes=n,this.id=r}}class Od{constructor(e,t,n){this.name=e,this.type=t,this.attributes=n}}class kd{constructor(e,t=null,n){this.stage=null,this.inputs=[],this.outputs=[],this.arguments=[],this.returnType=null,this.resources=[],this.overrides=[],this.startLine=-1,this.endLine=-1,this.inUse=!1,this.calls=new Set,this.name=e,this.stage=t,this.attributes=n}}class Nd{constructor(){this.vertex=[],this.fragment=[],this.compute=[]}}function Dd(s){var e=(32768&s)>>15,t=(31744&s)>>10,n=1023&s;return t==0?(e?-1:1)*Math.pow(2,-14)*(n/Math.pow(2,10)):t==31?n?NaN:1/0*(e?-1:1):(e?-1:1)*Math.pow(2,t-15)*(1+n/Math.pow(2,10))}const Ja=new Float32Array(1),Fd=new Int32Array(Ja.buffer),ce=new Uint16Array(1);function Bd(s){Ja[0]=s;const e=Fd[0],t=e>>31&1;let n=e>>23&255,r=8388607&e;if(n===255)return ce[0]=t<<15|31744|(r!==0?512:0),ce[0];if(n===0){if(r===0)return ce[0]=t<<15,ce[0];r|=8388608;let i=113;for(;!(8388608&r);)r<<=1,i--;return n=127-i,r&=8388607,n>0?(r=(r>>126-n)+(r>>127-n&1),ce[0]=t<<15|n<<10|r>>13,ce[0]):(ce[0]=t<<15,ce[0])}return n=n-127+15,n>=31?(ce[0]=t<<15|31744,ce[0]):n<=0?n<-10?(ce[0]=t<<15,ce[0]):(r=(8388608|r)>>1-n,ce[0]=t<<15|r>>13,ce[0]):(r>>=13,ce[0]=t<<15|n<<10|r,ce[0])}const Vr=new Uint32Array(1),Ga=new Float32Array(Vr.buffer,0,1);function Yi(s){const e=112+(s>>6&31)<<23|(63&s)<<17;return Vr[0]=e,Ga[0]}function Ud(s,e,t,n,r,i,o,a,c){const l=n*(o>>=r)*(i>>=r)+t*o+e*a;switch(c){case"r8unorm":return[$(s,l,"8unorm",1)[0]];case"r8snorm":return[$(s,l,"8snorm",1)[0]];case"r8uint":return[$(s,l,"8uint",1)[0]];case"r8sint":return[$(s,l,"8sint",1)[0]];case"rg8unorm":{const u=$(s,l,"8unorm",2);return[u[0],u[1]]}case"rg8snorm":{const u=$(s,l,"8snorm",2);return[u[0],u[1]]}case"rg8uint":{const u=$(s,l,"8uint",2);return[u[0],u[1]]}case"rg8sint":{const u=$(s,l,"8sint",2);return[u[0],u[1]]}case"rgba8unorm-srgb":case"rgba8unorm":{const u=$(s,l,"8unorm",4);return[u[0],u[1],u[2],u[3]]}case"rgba8snorm":{const u=$(s,l,"8snorm",4);return[u[0],u[1],u[2],u[3]]}case"rgba8uint":{const u=$(s,l,"8uint",4);return[u[0],u[1],u[2],u[3]]}case"rgba8sint":{const u=$(s,l,"8sint",4);return[u[0],u[1],u[2],u[3]]}case"bgra8unorm-srgb":case"bgra8unorm":{const u=$(s,l,"8unorm",4);return[u[2],u[1],u[0],u[3]]}case"r16uint":return[$(s,l,"16uint",1)[0]];case"r16sint":return[$(s,l,"16sint",1)[0]];case"r16float":return[$(s,l,"16float",1)[0]];case"rg16uint":{const u=$(s,l,"16uint",2);return[u[0],u[1]]}case"rg16sint":{const u=$(s,l,"16sint",2);return[u[0],u[1]]}case"rg16float":{const u=$(s,l,"16float",2);return[u[0],u[1]]}case"rgba16uint":{const u=$(s,l,"16uint",4);return[u[0],u[1],u[2],u[3]]}case"rgba16sint":{const u=$(s,l,"16sint",4);return[u[0],u[1],u[2],u[3]]}case"rgba16float":{const u=$(s,l,"16float",4);return[u[0],u[1],u[2],u[3]]}case"r32uint":return[$(s,l,"32uint",1)[0]];case"r32sint":return[$(s,l,"32sint",1)[0]];case"depth16unorm":case"depth24plus":case"depth24plus-stencil8":case"depth32float":case"depth32float-stencil8":case"r32float":return[$(s,l,"32float",1)[0]];case"rg32uint":{const u=$(s,l,"32uint",2);return[u[0],u[1]]}case"rg32sint":{const u=$(s,l,"32sint",2);return[u[0],u[1]]}case"rg32float":{const u=$(s,l,"32float",2);return[u[0],u[1]]}case"rgba32uint":{const u=$(s,l,"32uint",4);return[u[0],u[1],u[2],u[3]]}case"rgba32sint":{const u=$(s,l,"32sint",4);return[u[0],u[1],u[2],u[3]]}case"rgba32float":{const u=$(s,l,"32float",4);return[u[0],u[1],u[2],u[3]]}case"rg11b10ufloat":{const u=new Uint32Array(s.buffer,l,1)[0],h=(4192256&u)>>11,f=(4290772992&u)>>22;return[Yi(2047&u),Yi(h),(function(g){const _=112+(g>>5&31)<<23|(31&g)<<18;return Vr[0]=_,Ga[0]})(f),1]}}return null}function $(s,e,t,n){const r=[0,0,0,0];for(let i=0;i<n;++i)switch(t){case"8unorm":r[i]=s[e]/255,e++;break;case"8snorm":r[i]=s[e]/255*2-1,e++;break;case"8uint":r[i]=s[e],e++;break;case"8sint":r[i]=s[e]-127,e++;break;case"16uint":r[i]=s[e]|s[e+1]<<8,e+=2;break;case"16sint":r[i]=(s[e]|s[e+1]<<8)-32768,e+=2;break;case"16float":r[i]=Dd(s[e]|s[e+1]<<8),e+=2;break;case"32uint":case"32sint":r[i]=s[e]|s[e+1]<<8|s[e+2]<<16|s[e+3]<<24,e+=4;break;case"32float":r[i]=new Float32Array(s.buffer,e,1)[0],e+=4}return r}function j(s,e,t,n,r){for(let i=0;i<n;++i)switch(t){case"8unorm":s[e]=255*r[i],e++;break;case"8snorm":s[e]=.5*(r[i]+1)*255,e++;break;case"8uint":s[e]=r[i],e++;break;case"8sint":s[e]=r[i]+127,e++;break;case"16uint":new Uint16Array(s.buffer,e,1)[0]=r[i],e+=2;break;case"16sint":new Int16Array(s.buffer,e,1)[0]=r[i],e+=2;break;case"16float":{const o=Bd(r[i]);new Uint16Array(s.buffer,e,1)[0]=o,e+=2;break}case"32uint":new Uint32Array(s.buffer,e,1)[0]=r[i],e+=4;break;case"32sint":new Int32Array(s.buffer,e,1)[0]=r[i],e+=4;break;case"32float":new Float32Array(s.buffer,e,1)[0]=r[i],e+=4}return r}const En={r8unorm:{bytesPerBlock:1,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r8snorm:{bytesPerBlock:1,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r8uint:{bytesPerBlock:1,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r8sint:{bytesPerBlock:1,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},rg8unorm:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg8snorm:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg8uint:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg8sint:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rgba8unorm:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},"rgba8unorm-srgb":{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba8snorm:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba8uint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba8sint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},bgra8unorm:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},"bgra8unorm-srgb":{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},r16uint:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r16sint:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r16float:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},rg16uint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg16sint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg16float:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rgba16uint:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba16sint:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba16float:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},r32uint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r32sint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r32float:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},rg32uint:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg32sint:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg32float:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rgba32uint:{bytesPerBlock:16,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba32sint:{bytesPerBlock:16,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba32float:{bytesPerBlock:16,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgb10a2uint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgb10a2unorm:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rg11b10ufloat:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},stencil8:{bytesPerBlock:1,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!1,hasStencil:!0,channels:1},depth16unorm:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!0,hasStencil:!1,channels:1},depth24plus:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!0,hasStencil:!1,depthOnlyFormat:"depth32float",channels:1},"depth24plus-stencil8":{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!0,hasStencil:!0,depthOnlyFormat:"depth32float",channels:1},depth32float:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!0,hasStencil:!1,channels:1},"depth32float-stencil8":{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!0,hasStencil:!0,stencilOnlyFormat:"depth32float",channels:1},rgb9e5ufloat:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},"bc1-rgba-unorm":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc1-rgba-unorm-srgb":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc2-rgba-unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc2-rgba-unorm-srgb":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc3-rgba-unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc3-rgba-unorm-srgb":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc4-r-unorm":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:1},"bc4-r-snorm":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:1},"bc5-rg-unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:2},"bc5-rg-snorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:2},"bc6h-rgb-ufloat":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc6h-rgb-float":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc7-rgba-unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc7-rgba-unorm-srgb":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgb8unorm":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgb8unorm-srgb":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgb8a1unorm":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgb8a1unorm-srgb":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgba8unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgba8unorm-srgb":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"eac-r11unorm":{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!0,channels:1},"eac-r11snorm":{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!0,channels:1},"eac-rg11unorm":{bytesPerBlock:16,blockWidth:1,blockHeight:1,isCompressed:!0,channels:2},"eac-rg11snorm":{bytesPerBlock:16,blockWidth:1,blockHeight:1,isCompressed:!0,channels:2},"astc-4x4-unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"astc-4x4-unorm-srgb":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"astc-5x4-unorm":{bytesPerBlock:16,blockWidth:5,blockHeight:4,isCompressed:!0,channels:4},"astc-5x4-unorm-srgb":{bytesPerBlock:16,blockWidth:5,blockHeight:4,isCompressed:!0,channels:4},"astc-5x5-unorm":{bytesPerBlock:16,blockWidth:5,blockHeight:5,isCompressed:!0,channels:4},"astc-5x5-unorm-srgb":{bytesPerBlock:16,blockWidth:5,blockHeight:5,isCompressed:!0,channels:4},"astc-6x5-unorm":{bytesPerBlock:16,blockWidth:6,blockHeight:5,isCompressed:!0,channels:4},"astc-6x5-unorm-srgb":{bytesPerBlock:16,blockWidth:6,blockHeight:5,isCompressed:!0,channels:4},"astc-6x6-unorm":{bytesPerBlock:16,blockWidth:6,blockHeight:6,isCompressed:!0,channels:4},"astc-6x6-unorm-srgb":{bytesPerBlock:16,blockWidth:6,blockHeight:6,isCompressed:!0,channels:4},"astc-8x5-unorm":{bytesPerBlock:16,blockWidth:8,blockHeight:5,isCompressed:!0,channels:4},"astc-8x5-unorm-srgb":{bytesPerBlock:16,blockWidth:8,blockHeight:5,isCompressed:!0,channels:4},"astc-8x6-unorm":{bytesPerBlock:16,blockWidth:8,blockHeight:6,isCompressed:!0,channels:4},"astc-8x6-unorm-srgb":{bytesPerBlock:16,blockWidth:8,blockHeight:6,isCompressed:!0,channels:4},"astc-8x8-unorm":{bytesPerBlock:16,blockWidth:8,blockHeight:8,isCompressed:!0,channels:4},"astc-8x8-unorm-srgb":{bytesPerBlock:16,blockWidth:8,blockHeight:8,isCompressed:!0,channels:4},"astc-10x5-unorm":{bytesPerBlock:16,blockWidth:10,blockHeight:5,isCompressed:!0,channels:4},"astc-10x5-unorm-srgb":{bytesPerBlock:16,blockWidth:10,blockHeight:5,isCompressed:!0,channels:4},"astc-10x6-unorm":{bytesPerBlock:16,blockWidth:10,blockHeight:6,isCompressed:!0,channels:4},"astc-10x6-unorm-srgb":{bytesPerBlock:16,blockWidth:10,blockHeight:6,isCompressed:!0,channels:4},"astc-10x8-unorm":{bytesPerBlock:16,blockWidth:10,blockHeight:8,isCompressed:!0,channels:4},"astc-10x8-unorm-srgb":{bytesPerBlock:16,blockWidth:10,blockHeight:8,isCompressed:!0,channels:4},"astc-10x10-unorm":{bytesPerBlock:16,blockWidth:10,blockHeight:10,isCompressed:!0,channels:4},"astc-10x10-unorm-srgb":{bytesPerBlock:16,blockWidth:10,blockHeight:10,isCompressed:!0,channels:4},"astc-12x10-unorm":{bytesPerBlock:16,blockWidth:12,blockHeight:10,isCompressed:!0,channels:4},"astc-12x10-unorm-srgb":{bytesPerBlock:16,blockWidth:12,blockHeight:10,isCompressed:!0,channels:4},"astc-12x12-unorm":{bytesPerBlock:16,blockWidth:12,blockHeight:12,isCompressed:!0,channels:4},"astc-12x12-unorm-srgb":{bytesPerBlock:16,blockWidth:12,blockHeight:12,isCompressed:!0,channels:4}};class ve{constructor(){this.id=ve._id++,this.line=0}get isAstNode(){return!0}get astNodeType(){return""}search(e){e(this)}searchBlock(e,t){if(e){t(Ls.instance);for(const n of e)n instanceof Array?this.searchBlock(n,t):n.search(t);t(Vs.instance)}}constEvaluate(e,t){throw new Error("Cannot evaluate node")}constEvaluateString(e){return this.constEvaluate(e).toString()}}ve._id=0;class Ls extends ve{}Ls.instance=new Ls;class Vs extends ve{}Vs.instance=new Vs;const ec=new Set(["all","all","any","select","arrayLength","abs","acos","acosh","asin","asinh","atan","atanh","atan2","ceil","clamp","cos","cosh","countLeadingZeros","countOneBits","countTrailingZeros","cross","degrees","determinant","distance","dot","dot4U8Packed","dot4I8Packed","exp","exp2","extractBits","faceForward","firstLeadingBit","firstTrailingBit","floor","fma","fract","frexp","insertBits","inverseSqrt","ldexp","length","log","log2","max","min","mix","modf","normalize","pow","quantizeToF16","radians","reflect","refract","reverseBits","round","saturate","sign","sin","sinh","smoothStep","sqrt","step","tan","tanh","transpose","trunc","dpdx","dpdxCoarse","dpdxFine","dpdy","dpdyCoarse","dpdyFine","fwidth","fwidthCoarse","fwidthFine","textureDimensions","textureGather","textureGatherCompare","textureLoad","textureNumLayers","textureNumLevels","textureNumSamples","textureSample","textureSampleBias","textureSampleCompare","textureSampleCompareLevel","textureSampleGrad","textureSampleLevel","textureSampleBaseClampToEdge","textureStore","atomicLoad","atomicStore","atomicAdd","atomicSub","atomicMax","atomicMin","atomicAnd","atomicOr","atomicXor","atomicExchange","atomicCompareExchangeWeak","pack4x8snorm","pack4x8unorm","pack4xI8","pack4xU8","pack4x8Clamp","pack4xU8Clamp","pack2x16snorm","pack2x16unorm","pack2x16float","unpack4x8snorm","unpack4x8unorm","unpack4xI8","unpack4xU8","unpack2x16snorm","unpack2x16unorm","unpack2x16float","storageBarrier","textureBarrier","workgroupBarrier","workgroupUniformLoad","subgroupAdd","subgroupExclusiveAdd","subgroupInclusiveAdd","subgroupAll","subgroupAnd","subgroupAny","subgroupBallot","subgroupBroadcast","subgroupBroadcastFirst","subgroupElect","subgroupMax","subgroupMin","subgroupMul","subgroupExclusiveMul","subgroupInclusiveMul","subgroupOr","subgroupShuffle","subgroupShuffleDown","subgroupShuffleUp","subgroupShuffleXor","subgroupXor","quadBroadcast","quadSwapDiagonal","quadSwapX","quadSwapY"]);class K extends ve{constructor(){super()}}class ns extends K{constructor(e,t,n,r,i,o){super(),this.calls=new Set,this.name=e,this.args=t,this.returnType=n,this.body=r,this.startLine=i,this.endLine=o}get astNodeType(){return"function"}search(e){if(this.attributes)for(const t of this.attributes)e(t);e(this);for(const t of this.args)e(t);this.searchBlock(this.body,e)}}class Ld extends K{constructor(e){super(),this.expression=e}get astNodeType(){return"staticAssert"}search(e){this.expression.search(e)}}class tc extends K{constructor(e,t){super(),this.condition=e,this.body=t}get astNodeType(){return"while"}search(e){this.condition.search(e),this.searchBlock(this.body,e)}}class tr extends K{constructor(e,t){super(),this.body=e,this.loopId=t}get astNodeType(){return"continuing"}search(e){this.searchBlock(this.body,e)}}class sc extends K{constructor(e,t,n,r){super(),this.init=e,this.condition=t,this.increment=n,this.body=r}get astNodeType(){return"for"}search(e){var t,n,r;(t=this.init)===null||t===void 0||t.search(e),(n=this.condition)===null||n===void 0||n.search(e),(r=this.increment)===null||r===void 0||r.search(e),this.searchBlock(this.body,e)}}class Ue extends K{constructor(e,t,n,r,i){super(),this.attributes=null,this.name=e,this.type=t,this.storage=n,this.access=r,this.value=i}get astNodeType(){return"var"}search(e){var t;e(this),(t=this.value)===null||t===void 0||t.search(e)}}class $r extends K{constructor(e,t,n){super(),this.attributes=null,this.name=e,this.type=t,this.value=n}get astNodeType(){return"override"}search(e){var t;(t=this.value)===null||t===void 0||t.search(e)}}class Qt extends K{constructor(e,t,n,r,i){super(),this.attributes=null,this.name=e,this.type=t,this.storage=n,this.access=r,this.value=i}get astNodeType(){return"let"}search(e){var t;e(this),(t=this.value)===null||t===void 0||t.search(e)}}class Rs extends K{constructor(e,t,n,r,i){super(),this.attributes=null,this.name=e,this.type=t,this.storage=n,this.access=r,this.value=i}get astNodeType(){return"const"}constEvaluate(e,t){return this.value.constEvaluate(e,t)}search(e){var t;e(this),(t=this.value)===null||t===void 0||t.search(e)}}var vt,Ht,v,b;(s=>{s.increment="++",s.decrement="--"})(vt||(vt={})),(s=>{s.parse=function(e){const t=e;if(t=="parse")throw new Error("Invalid value for IncrementOperator");return s[t]}})(vt||(vt={}));class nc extends K{constructor(e,t){super(),this.operator=e,this.variable=t}get astNodeType(){return"increment"}search(e){this.variable.search(e)}}(s=>{s.assign="=",s.addAssign="+=",s.subtractAssin="-=",s.multiplyAssign="*=",s.divideAssign="/=",s.moduloAssign="%=",s.andAssign="&=",s.orAssign="|=",s.xorAssign="^=",s.shiftLeftAssign="<<=",s.shiftRightAssign=">>="})(Ht||(Ht={})),(s=>{s.parse=function(e){const t=e;if(t=="parse")throw new Error("Invalid value for AssignOperator");return t}})(Ht||(Ht={}));class rc extends K{constructor(e,t,n){super(),this.operator=e,this.variable=t,this.value=n}get astNodeType(){return"assign"}search(e){this.variable.search(e),this.value.search(e)}}class Wr extends K{constructor(e,t){super(),this.name=e,this.args=t}get astNodeType(){return"call"}isBuiltin(){return ec.has(this.name)}search(e){for(const t of this.args)t.search(e);e(this)}}class ic extends K{constructor(e,t){super(),this.body=e,this.continuing=t}get astNodeType(){return"loop"}search(e){var t;this.searchBlock(this.body,e),(t=this.continuing)===null||t===void 0||t.search(e)}}class oc extends K{constructor(e,t){super(),this.condition=e,this.cases=t}get astNodeType(){return"switch"}search(e){e(this);for(const t of this.cases)t.search(e)}}class ac extends K{constructor(e,t,n,r){super(),this.condition=e,this.body=t,this.elseif=n,this.else=r}get astNodeType(){return"if"}search(e){this.condition.search(e),this.searchBlock(this.body,e),this.searchBlock(this.elseif,e),this.searchBlock(this.else,e)}}class cc extends K{constructor(e){super(),this.value=e}get astNodeType(){return"return"}search(e){var t;(t=this.value)===null||t===void 0||t.search(e)}}class Vd extends K{constructor(e){super(),this.name=e}get astNodeType(){return"enable"}}class $d extends K{constructor(e){super(),this.extensions=e}get astNodeType(){return"requires"}}class lc extends K{constructor(e,t){super(),this.severity=e,this.rule=t}get astNodeType(){return"diagnostic"}}class jr extends K{constructor(e,t){super(),this.name=e,this.type=t}get astNodeType(){return"alias"}}class Wd extends K{constructor(){super()}get astNodeType(){return"discard"}}class uc extends K{constructor(){super(),this.condition=null,this.loopId=-1}get astNodeType(){return"break"}}class hc extends K{constructor(){super(),this.loopId=-1}get astNodeType(){return"continue"}}class R extends K{constructor(e){super(),this.attributes=null,this.name=e}get astNodeType(){return"type"}get isStruct(){return!1}get isArray(){return!1}static maxFormatType(e){let t=e[0];if(t.name==="f32")return t;for(let n=1;n<e.length;++n){const r=R._priority.get(t.name);R._priority.get(e[n].name)<r&&(t=e[n])}return t.name==="x32"?R.i32:t}getTypeName(){return this.name}}R.x32=new R("x32"),R.f32=new R("f32"),R.i32=new R("i32"),R.u32=new R("u32"),R.f16=new R("f16"),R.bool=new R("bool"),R.void=new R("void"),R._priority=new Map([["f32",0],["f16",1],["u32",2],["i32",3],["x32",3]]);class qi extends R{constructor(e){super(e)}}class Fe extends R{constructor(e,t,n,r){super(e),this.members=t,this.startLine=n,this.endLine=r}get astNodeType(){return"struct"}get isStruct(){return!0}getMemberIndex(e){for(let t=0;t<this.members.length;t++)if(this.members[t].name==e)return t;return-1}search(e){for(const t of this.members)e(t)}}class T extends R{constructor(e,t,n){super(e),this.format=t,this.access=n}get astNodeType(){return"template"}getTypeName(){let e=this.name;if(this.format!==null){if(e==="vec2"||e==="vec3"||e==="vec4"||e==="mat2x2"||e==="mat2x3"||e==="mat2x4"||e==="mat3x2"||e==="mat3x3"||e==="mat3x4"||e==="mat4x2"||e==="mat4x3"||e==="mat4x4"){if(this.format.name==="f32")return e+="f",e;if(this.format.name==="i32")return e+="i",e;if(this.format.name==="u32")return e+="u",e;if(this.format.name==="bool")return e+="b",e;if(this.format.name==="f16")return e+="h",e}e+=`<${this.format.name}>`}else if(e==="vec2"||e==="vec3"||e==="vec4")return e;return e}}T.vec2f=new T("vec2",R.f32,null),T.vec3f=new T("vec3",R.f32,null),T.vec4f=new T("vec4",R.f32,null),T.vec2i=new T("vec2",R.i32,null),T.vec3i=new T("vec3",R.i32,null),T.vec4i=new T("vec4",R.i32,null),T.vec2u=new T("vec2",R.u32,null),T.vec3u=new T("vec3",R.u32,null),T.vec4u=new T("vec4",R.u32,null),T.vec2h=new T("vec2",R.f16,null),T.vec3h=new T("vec3",R.f16,null),T.vec4h=new T("vec4",R.f16,null),T.vec2b=new T("vec2",R.bool,null),T.vec3b=new T("vec3",R.bool,null),T.vec4b=new T("vec4",R.bool,null),T.mat2x2f=new T("mat2x2",R.f32,null),T.mat2x3f=new T("mat2x3",R.f32,null),T.mat2x4f=new T("mat2x4",R.f32,null),T.mat3x2f=new T("mat3x2",R.f32,null),T.mat3x3f=new T("mat3x3",R.f32,null),T.mat3x4f=new T("mat3x4",R.f32,null),T.mat4x2f=new T("mat4x2",R.f32,null),T.mat4x3f=new T("mat4x3",R.f32,null),T.mat4x4f=new T("mat4x4",R.f32,null),T.mat2x2h=new T("mat2x2",R.f16,null),T.mat2x3h=new T("mat2x3",R.f16,null),T.mat2x4h=new T("mat2x4",R.f16,null),T.mat3x2h=new T("mat3x2",R.f16,null),T.mat3x3h=new T("mat3x3",R.f16,null),T.mat3x4h=new T("mat3x4",R.f16,null),T.mat4x2h=new T("mat4x2",R.f16,null),T.mat4x3h=new T("mat4x3",R.f16,null),T.mat4x4h=new T("mat4x4",R.f16,null),T.mat2x2i=new T("mat2x2",R.i32,null),T.mat2x3i=new T("mat2x3",R.i32,null),T.mat2x4i=new T("mat2x4",R.i32,null),T.mat3x2i=new T("mat3x2",R.i32,null),T.mat3x3i=new T("mat3x3",R.i32,null),T.mat3x4i=new T("mat3x4",R.i32,null),T.mat4x2i=new T("mat4x2",R.i32,null),T.mat4x3i=new T("mat4x3",R.i32,null),T.mat4x4i=new T("mat4x4",R.i32,null),T.mat2x2u=new T("mat2x2",R.u32,null),T.mat2x3u=new T("mat2x3",R.u32,null),T.mat2x4u=new T("mat2x4",R.u32,null),T.mat3x2u=new T("mat3x2",R.u32,null),T.mat3x3u=new T("mat3x3",R.u32,null),T.mat3x4u=new T("mat3x4",R.u32,null),T.mat4x2u=new T("mat4x2",R.u32,null),T.mat4x3u=new T("mat4x3",R.u32,null),T.mat4x4u=new T("mat4x4",R.u32,null);class Is extends R{constructor(e,t,n,r){super(e),this.storage=t,this.type=n,this.access=r}get astNodeType(){return"pointer"}}class Jt extends R{constructor(e,t,n,r){super(e),this.attributes=t,this.format=n,this.count=r}get astNodeType(){return"array"}get isArray(){return!0}}class zt extends R{constructor(e,t,n){super(e),this.format=t,this.access=n}get astNodeType(){return"sampler"}}class Ie extends ve{constructor(){super(),this.postfix=null}}class lt extends Ie{constructor(e){super(),this.value=e}get astNodeType(){return"stringExpr"}toString(){return this.value}constEvaluateString(){return this.value}}class Me extends Ie{constructor(e,t){super(),this.type=e,this.args=t}get astNodeType(){return"createExpr"}search(e){if(e(this),this.args)for(const t of this.args)t.search(e)}constEvaluate(e,t){return t&&(t[0]=this.type),e.evalExpression(this,e.context)}}class Hr extends Ie{constructor(e,t){super(),this.cachedReturnValue=null,this.name=e,this.args=t}get astNodeType(){return"callExpr"}setCachedReturnValue(e){this.cachedReturnValue=e}get isBuiltin(){return ec.has(this.name)}constEvaluate(e,t){return e.evalExpression(this,e.context)}search(e){for(const t of this.args)t.search(e);e(this)}}class _e extends Ie{constructor(e){super(),this.name=e}get astNodeType(){return"varExpr"}search(e){e(this),this.postfix&&this.postfix.search(e)}constEvaluate(e,t){return e.evalExpression(this,e.context)}}class fc extends Ie{constructor(e,t){super(),this.name=e,this.initializer=t}get astNodeType(){return"constExpr"}constEvaluate(e,t){if(this.initializer){const n=e.evalExpression(this.initializer,e.context);return n!==null&&this.postfix?n.getSubData(e,this.postfix,e.context):n}return null}search(e){this.initializer.search(e)}}class re extends Ie{constructor(e,t){super(),this.value=e,this.type=t}get astNodeType(){return"literalExpr"}constEvaluate(e,t){return t!==void 0&&(t[0]=this.type),this.value}get isScalar(){return this.value instanceof m}get isVector(){return this.value instanceof p||this.value instanceof k}get scalarValue(){return this.value instanceof m?this.value.value:(console.error("Value is not scalar."),0)}get vectorValue(){return this.value instanceof p||this.value instanceof k?this.value.data:(console.error("Value is not a vector or matrix."),new Float32Array(0))}}class dc extends Ie{constructor(e,t){super(),this.type=e,this.value=t}get astNodeType(){return"bitcastExpr"}search(e){this.value.search(e)}}class Mt extends Ie{constructor(e){super(),this.index=e}search(e){this.index.search(e)}}class pc extends Ie{constructor(){super()}}class se extends pc{constructor(e,t){super(),this.operator=e,this.right=t}get astNodeType(){return"unaryOp"}constEvaluate(e,t){return e.evalExpression(this,e.context)}search(e){this.right.search(e)}}class Ee extends pc{constructor(e,t,n){super(),this.operator=e,this.left=t,this.right=n}get astNodeType(){return"binaryOp"}_getPromotedType(e,t){return e.name===t.name?e:e.name==="f32"||t.name==="f32"?R.f32:e.name==="u32"||t.name==="u32"?R.u32:R.i32}constEvaluate(e,t){return e.evalExpression(this,e.context)}search(e){this.left.search(e),this.right.search(e)}}class gc extends ve{constructor(e){super(),this.body=e}search(e){e(this),this.searchBlock(this.body,e)}}class Cs extends Ie{constructor(){super()}get astNodeType(){return"default"}}class _c extends gc{constructor(e,t){super(t),this.selectors=e}get astNodeType(){return"case"}search(e){this.searchBlock(this.body,e)}}class mc extends gc{constructor(e){super(e)}get astNodeType(){return"default"}search(e){this.searchBlock(this.body,e)}}class Ki extends ve{constructor(e,t,n){super(),this.name=e,this.type=t,this.attributes=n}get astNodeType(){return"argument"}}class jd extends ve{constructor(e,t){super(),this.condition=e,this.body=t}get astNodeType(){return"elseif"}search(e){this.condition.search(e),this.searchBlock(this.body,e)}}class Zi extends ve{constructor(e,t,n){super(),this.name=e,this.type=t,this.attributes=n}get astNodeType(){return"member"}}class bc extends ve{constructor(e,t){super(),this.name=e,this.value=t}get astNodeType(){return"attribute"}}class we{constructor(e,t){this.parent=null,this.typeInfo=e,this.parent=t,this.id=we._id++}clone(){throw`Clone: Not implemented for ${this.constructor.name}`}setDataValue(e,t,n,r){console.error(`SetDataValue: Not implemented for ${this.constructor.name}`)}getSubData(e,t,n){return console.error(`GetDataValue: Not implemented for ${this.constructor.name}`),null}toString(){return`<${this.typeInfo.getTypeName()}>`}}we._id=0;class sr extends we{constructor(){super(new be("void",null),null)}toString(){return"void"}}sr.void=new sr;class mt extends we{constructor(e){super(new er("pointer",e.typeInfo,null),null),this.reference=e}clone(){return this}setDataValue(e,t,n,r){this.reference.setDataValue(e,t,n,r)}getSubData(e,t,n){return t?this.reference.getSubData(e,t,n):this}toString(){return`&${this.reference.toString()}`}}class m extends we{constructor(e,t,n=null){super(t,n),e instanceof Int32Array||e instanceof Uint32Array||e instanceof Float32Array?this.data=e:this.typeInfo.name==="x32"?e-Math.floor(e)!==0?this.data=new Float32Array([e]):this.data=e>=0?new Uint32Array([e]):new Int32Array([e]):this.typeInfo.name==="i32"||this.typeInfo.name==="bool"?this.data=new Int32Array([e]):this.typeInfo.name==="u32"?this.data=new Uint32Array([e]):this.typeInfo.name==="f32"||this.typeInfo.name==="f16"?this.data=new Float32Array([e]):console.error("ScalarData2: Invalid type",t)}clone(){if(this.data instanceof Float32Array)return new m(new Float32Array(this.data),this.typeInfo,null);if(this.data instanceof Int32Array)return new m(new Int32Array(this.data),this.typeInfo,null);if(this.data instanceof Uint32Array)return new m(new Uint32Array(this.data),this.typeInfo,null);throw"ScalarData: Invalid data type"}get value(){return this.data[0]}set value(e){this.data[0]=e}setDataValue(e,t,n,r){if(n)return void console.error("SetDataValue: Scalar data does not support postfix",n);if(!(t instanceof m))return void console.error("SetDataValue: Invalid value",t);let i=t.data[0];this.typeInfo.name==="i32"||this.typeInfo.name==="u32"?i=Math.floor(i):this.typeInfo.name==="bool"&&(i=i?1:0),this.data[0]=i}getSubData(e,t,n){return t?(console.error("getSubData: Scalar data does not support postfix",t),null):this}toString(){return`${this.value}`}}function Hd(s,e,t){const n=e.length;return n===2?t==="f32"?new p(new Float32Array(e),s.getTypeInfo("vec2f")):t==="i32"||t==="bool"?new p(new Int32Array(e),s.getTypeInfo("vec2i")):t==="u32"?new p(new Uint32Array(e),s.getTypeInfo("vec2u")):t==="f16"?new p(new Float32Array(e),s.getTypeInfo("vec2h")):(console.error(`getSubData: Unknown format ${t}`),null):n===3?t==="f32"?new p(new Float32Array(e),s.getTypeInfo("vec3f")):t==="i32"||t==="bool"?new p(new Int32Array(e),s.getTypeInfo("vec3i")):t==="u32"?new p(new Uint32Array(e),s.getTypeInfo("vec3u")):t==="f16"?new p(new Float32Array(e),s.getTypeInfo("vec3h")):(console.error(`getSubData: Unknown format ${t}`),null):n===4?t==="f32"?new p(new Float32Array(e),s.getTypeInfo("vec4f")):t==="i32"||t==="bool"?new p(new Int32Array(e),s.getTypeInfo("vec4i")):t==="u32"?new p(new Uint32Array(e),s.getTypeInfo("vec4u")):t==="f16"?new p(new Float32Array(e),s.getTypeInfo("vec4h")):(console.error(`getSubData: Unknown format ${t}`),null):(console.error(`getSubData: Invalid vector size ${e.length}`),null)}class p extends we{constructor(e,t,n=null){if(super(t,n),e instanceof Float32Array||e instanceof Uint32Array||e instanceof Int32Array)this.data=e;else{const r=this.typeInfo.name;r==="vec2f"||r==="vec3f"||r==="vec4f"?this.data=new Float32Array(e):r==="vec2i"||r==="vec3i"||r==="vec4i"?this.data=new Int32Array(e):r==="vec2u"||r==="vec3u"||r==="vec4u"?this.data=new Uint32Array(e):r==="vec2h"||r==="vec3h"||r==="vec4h"?this.data=new Float32Array(e):r==="vec2b"||r==="vec3b"||r==="vec4b"?this.data=new Int32Array(e):r==="vec2"||r==="vec3"||r==="vec4"?this.data=new Float32Array(e):console.error(`VectorData: Invalid type ${r}`)}}clone(){if(this.data instanceof Float32Array)return new p(new Float32Array(this.data),this.typeInfo,null);if(this.data instanceof Int32Array)return new p(new Int32Array(this.data),this.typeInfo,null);if(this.data instanceof Uint32Array)return new p(new Uint32Array(this.data),this.typeInfo,null);throw"VectorData: Invalid data type"}setDataValue(e,t,n,r){n instanceof lt?console.error("TODO: Set vector postfix"):t instanceof p?this.data=t.data:console.error("SetDataValue: Invalid value",t)}getSubData(e,t,n){if(t===null)return this;let r=e.getTypeInfo("f32");if(this.typeInfo instanceof ct)r=this.typeInfo.format||r;else{const o=this.typeInfo.name;o==="vec2f"||o==="vec3f"||o==="vec4f"?r=e.getTypeInfo("f32"):o==="vec2i"||o==="vec3i"||o==="vec4i"?r=e.getTypeInfo("i32"):o==="vec2b"||o==="vec3b"||o==="vec4b"?r=e.getTypeInfo("bool"):o==="vec2u"||o==="vec3u"||o==="vec4u"?r=e.getTypeInfo("u32"):o==="vec2h"||o==="vec3h"||o==="vec4h"?r=e.getTypeInfo("f16"):console.error(`GetSubData: Unknown type ${o}`)}let i=this;for(;t!==null&&i!==null;){if(t instanceof Mt){const o=t.index;let a=-1;if(o instanceof re){if(!(o.value instanceof m))return console.error(`GetSubData: Invalid array index ${o.value}`),null;a=o.value.value}else{const c=e.evalExpression(o,n);if(!(c instanceof m))return console.error("GetSubData: Unknown index type",o),null;a=c.value}if(a<0||a>=i.data.length)return console.error("GetSubData: Index out of range",a),null;if(i.data instanceof Float32Array){const c=new Float32Array(i.data.buffer,i.data.byteOffset+4*a,1);return new m(c,r)}if(i.data instanceof Int32Array){const c=new Int32Array(i.data.buffer,i.data.byteOffset+4*a,1);return new m(c,r)}if(i.data instanceof Uint32Array){const c=new Uint32Array(i.data.buffer,i.data.byteOffset+4*a,1);return new m(c,r)}throw"GetSubData: Invalid data type"}if(!(t instanceof lt))return console.error("GetSubData: Unknown postfix",t),null;{const o=t.value.toLowerCase();if(o.length===1){let c=0;if(o==="x"||o==="r")c=0;else if(o==="y"||o==="g")c=1;else if(o==="z"||o==="b")c=2;else{if(o!=="w"&&o!=="a")return console.error(`GetSubData: Unknown member ${o}`),null;c=3}if(this.data instanceof Float32Array){let l=new Float32Array(this.data.buffer,this.data.byteOffset+4*c,1);return new m(l,r,this)}if(this.data instanceof Int32Array){let l=new Int32Array(this.data.buffer,this.data.byteOffset+4*c,1);return new m(l,r,this)}if(this.data instanceof Uint32Array){let l=new Uint32Array(this.data.buffer,this.data.byteOffset+4*c,1);return new m(l,r,this)}}const a=[];for(const c of o)c==="x"||c==="r"?a.push(this.data[0]):c==="y"||c==="g"?a.push(this.data[1]):c==="z"||c==="b"?a.push(this.data[2]):c==="w"||c==="a"?a.push(this.data[3]):console.error(`GetDataValue: Unknown member ${c}`);i=Hd(e,a,r.name)}t=t.postfix}return i}toString(){let e=`${this.data[0]}`;for(let t=1;t<this.data.length;++t)e+=`, ${this.data[t]}`;return e}}class k extends we{constructor(e,t,n=null){super(t,n),e instanceof Float32Array?this.data=e:this.data=new Float32Array(e)}clone(){return new k(new Float32Array(this.data),this.typeInfo,null)}setDataValue(e,t,n,r){n instanceof lt?console.error("TODO: Set matrix postfix"):t instanceof k?this.data=t.data:console.error("SetDataValue: Invalid value",t)}getSubData(e,t,n){if(t===null)return this;const r=this.typeInfo.name;if(e.getTypeInfo("f32"),this.typeInfo instanceof ct)this.typeInfo.format;else if(r.endsWith("f"))e.getTypeInfo("f32");else if(r.endsWith("i"))e.getTypeInfo("i32");else if(r.endsWith("u"))e.getTypeInfo("u32");else{if(!r.endsWith("h"))return console.error(`GetDataValue: Unknown type ${r}`),null;e.getTypeInfo("f16")}if(t instanceof Mt){const i=t.index;let o=-1;if(i instanceof re){if(!(i.value instanceof m))return console.error(`GetDataValue: Invalid array index ${i.value}`),null;o=i.value.value}else{const l=e.evalExpression(i,n);if(!(l instanceof m))return console.error("GetDataValue: Unknown index type",i),null;o=l.value}if(o<0||o>=this.data.length)return console.error("GetDataValue: Index out of range",o),null;const a=r.endsWith("h")?"h":"f";let c;if(r==="mat2x2"||r==="mat2x2f"||r==="mat2x2h"||r==="mat3x2"||r==="mat3x2f"||r==="mat3x2h"||r==="mat4x2"||r==="mat4x2f"||r==="mat4x2h")c=new p(new Float32Array(this.data.buffer,this.data.byteOffset+2*o*4,2),e.getTypeInfo(`vec2${a}`));else if(r==="mat2x3"||r==="mat2x3f"||r==="mat2x3h"||r==="mat3x3"||r==="mat3x3f"||r==="mat3x3h"||r==="mat4x3"||r==="mat4x3f"||r==="mat4x3h")c=new p(new Float32Array(this.data.buffer,this.data.byteOffset+3*o*4,3),e.getTypeInfo(`vec3${a}`));else{if(r!=="mat2x4"&&r!=="mat2x4f"&&r!=="mat2x4h"&&r!=="mat3x4"&&r!=="mat3x4f"&&r!=="mat3x4h"&&r!=="mat4x4"&&r!=="mat4x4f"&&r!=="mat4x4h")return console.error(`GetDataValue: Unknown type ${r}`),null;c=new p(new Float32Array(this.data.buffer,this.data.byteOffset+4*o*4,4),e.getTypeInfo(`vec4${a}`))}return t.postfix?c.getSubData(e,t.postfix,n):c}return console.error("GetDataValue: Invalid postfix",t),null}toString(){let e=`${this.data[0]}`;for(let t=1;t<this.data.length;++t)e+=`, ${this.data[t]}`;return e}}class G extends we{constructor(e,t,n=0,r=null){super(t,r),this.buffer=e instanceof ArrayBuffer?e:e.buffer,this.offset=n}clone(){const e=new Uint8Array(new Uint8Array(this.buffer,this.offset,this.typeInfo.size));return new G(e.buffer,this.typeInfo,0,null)}setDataValue(e,t,n,r){if(t===null)return void console.log("setDataValue: NULL data.");let i=this.offset,o=this.typeInfo;for(;n;){if(n instanceof Mt)if(o instanceof Ze){const a=n.index;if(a instanceof re){if(!(a.value instanceof m))return void console.error(`SetDataValue: Invalid index type ${a.value}`);i+=a.value.value*o.stride}else{const c=e.evalExpression(a,r);if(!(c instanceof m))return void console.error("SetDataValue: Unknown index type",a);i+=c.value*o.stride}o=o.format}else console.error(`SetDataValue: Type ${o.getTypeName()} is not an array`);else{if(!(n instanceof lt))return void console.error("SetDataValue: Unknown postfix type",n);{const a=n.value;if(o instanceof Xe){let c=!1;for(const l of o.members)if(l.name===a){i+=l.offset,o=l.type,c=!0;break}if(!c)return void console.error(`SetDataValue: Member ${a} not found`)}else if(o instanceof be){const c=o.getTypeName();let l=0;if(a==="x"||a==="r")l=0;else if(a==="y"||a==="g")l=1;else if(a==="z"||a==="b")l=2;else{if(a!=="w"&&a!=="a")return void console.error(`SetDataValue: Unknown member ${a}`);l=3}if(!(t instanceof m))return void console.error("SetDataValue: Invalid value",t);const u=t.value;return c==="vec2f"?void(new Float32Array(this.buffer,i,2)[l]=u):c==="vec3f"?void(new Float32Array(this.buffer,i,3)[l]=u):c==="vec4f"?void(new Float32Array(this.buffer,i,4)[l]=u):c==="vec2i"?void(new Int32Array(this.buffer,i,2)[l]=u):c==="vec3i"?void(new Int32Array(this.buffer,i,3)[l]=u):c==="vec4i"?void(new Int32Array(this.buffer,i,4)[l]=u):c==="vec2u"?void(new Uint32Array(this.buffer,i,2)[l]=u):c==="vec3u"?void(new Uint32Array(this.buffer,i,3)[l]=u):c==="vec4u"?void(new Uint32Array(this.buffer,i,4)[l]=u):void console.error(`SetDataValue: Type ${c} is not a struct`)}}}n=n.postfix}this.setData(e,t,o,i,r)}setData(e,t,n,r,i){const o=n.getTypeName();if(o!=="f32"&&o!=="f16")if(o!=="i32"&&o!=="atomic<i32>"&&o!=="x32")if(o!=="u32"&&o!=="atomic<u32>")if(o!=="bool"){if(o==="vec2f"||o==="vec2h"){const a=new Float32Array(this.buffer,r,2);return void(t instanceof p?(a[0]=t.data[0],a[1]=t.data[1]):(a[0]=t[0],a[1]=t[1]))}if(o==="vec3f"||o==="vec3h"){const a=new Float32Array(this.buffer,r,3);return void(t instanceof p?(a[0]=t.data[0],a[1]=t.data[1],a[2]=t.data[2]):(a[0]=t[0],a[1]=t[1],a[2]=t[2]))}if(o==="vec4f"||o==="vec4h"){const a=new Float32Array(this.buffer,r,4);return void(t instanceof p?(a[0]=t.data[0],a[1]=t.data[1],a[2]=t.data[2],a[3]=t.data[3]):(a[0]=t[0],a[1]=t[1],a[2]=t[2],a[3]=t[3]))}if(o==="vec2i"){const a=new Int32Array(this.buffer,r,2);return void(t instanceof p?(a[0]=t.data[0],a[1]=t.data[1]):(a[0]=t[0],a[1]=t[1]))}if(o==="vec3i"){const a=new Int32Array(this.buffer,r,3);return void(t instanceof p?(a[0]=t.data[0],a[1]=t.data[1],a[2]=t.data[2]):(a[0]=t[0],a[1]=t[1],a[2]=t[2]))}if(o==="vec4i"){const a=new Int32Array(this.buffer,r,4);return void(t instanceof p?(a[0]=t.data[0],a[1]=t.data[1],a[2]=t.data[2],a[3]=t.data[3]):(a[0]=t[0],a[1]=t[1],a[2]=t[2],a[3]=t[3]))}if(o==="vec2u"){const a=new Uint32Array(this.buffer,r,2);return void(t instanceof p?(a[0]=t.data[0],a[1]=t.data[1]):(a[0]=t[0],a[1]=t[1]))}if(o==="vec3u"){const a=new Uint32Array(this.buffer,r,3);return void(t instanceof p?(a[0]=t.data[0],a[1]=t.data[1],a[2]=t.data[2]):(a[0]=t[0],a[1]=t[1],a[2]=t[2]))}if(o==="vec4u"){const a=new Uint32Array(this.buffer,r,4);return void(t instanceof p?(a[0]=t.data[0],a[1]=t.data[1],a[2]=t.data[2],a[3]=t.data[3]):(a[0]=t[0],a[1]=t[1],a[2]=t[2],a[3]=t[3]))}if(o==="vec2b"){const a=new Uint32Array(this.buffer,r,2);return void(t instanceof p?(a[0]=t.data[0],a[1]=t.data[1]):(a[0]=t[0],a[1]=t[1]))}if(o==="vec3b"){const a=new Uint32Array(this.buffer,r,3);return void(t instanceof p?(a[0]=t.data[0],a[1]=t.data[1],a[2]=t.data[2]):(a[0]=t[0],a[1]=t[1],a[2]=t[2]))}if(o==="vec4b"){const a=new Uint32Array(this.buffer,r,4);return void(t instanceof p?(a[0]=t.data[0],a[1]=t.data[1],a[2]=t.data[2],a[3]=t.data[3]):(a[0]=t[0],a[1]=t[1],a[2]=t[2],a[3]=t[3]))}if(o==="mat2x2f"||o==="mat2x2h"){const a=new Float32Array(this.buffer,r,4);return void(t instanceof k?(a[0]=t.data[0],a[1]=t.data[1],a[2]=t.data[2],a[3]=t.data[3]):(a[0]=t[0],a[1]=t[1],a[2]=t[2],a[3]=t[3]))}if(o==="mat2x3f"||o==="mat2x3h"){const a=new Float32Array(this.buffer,r,6);return void(t instanceof k?(a[0]=t.data[0],a[1]=t.data[1],a[2]=t.data[2],a[3]=t.data[3],a[4]=t.data[4],a[5]=t.data[5]):(a[0]=t[0],a[1]=t[1],a[2]=t[2],a[3]=t[3],a[4]=t[4],a[5]=t[5]))}if(o==="mat2x4f"||o==="mat2x4h"){const a=new Float32Array(this.buffer,r,8);return void(t instanceof k?(a[0]=t.data[0],a[1]=t.data[1],a[2]=t.data[2],a[3]=t.data[3],a[4]=t.data[4],a[5]=t.data[5],a[6]=t.data[6],a[7]=t.data[7]):(a[0]=t[0],a[1]=t[1],a[2]=t[2],a[3]=t[3],a[4]=t[4],a[5]=t[5],a[6]=t[6],a[7]=t[7]))}if(o==="mat3x2f"||o==="mat3x2h"){const a=new Float32Array(this.buffer,r,6);return void(t instanceof k?(a[0]=t.data[0],a[1]=t.data[1],a[2]=t.data[2],a[3]=t.data[3],a[4]=t.data[4],a[5]=t.data[5]):(a[0]=t[0],a[1]=t[1],a[2]=t[2],a[3]=t[3],a[4]=t[4],a[5]=t[5]))}if(o==="mat3x3f"||o==="mat3x3h"){const a=new Float32Array(this.buffer,r,9);return void(t instanceof k?(a[0]=t.data[0],a[1]=t.data[1],a[2]=t.data[2],a[3]=t.data[3],a[4]=t.data[4],a[5]=t.data[5],a[6]=t.data[6],a[7]=t.data[7],a[8]=t.data[8]):(a[0]=t[0],a[1]=t[1],a[2]=t[2],a[3]=t[3],a[4]=t[4],a[5]=t[5],a[6]=t[6],a[7]=t[7],a[8]=t[8]))}if(o==="mat3x4f"||o==="mat3x4h"){const a=new Float32Array(this.buffer,r,12);return void(t instanceof k?(a[0]=t.data[0],a[1]=t.data[1],a[2]=t.data[2],a[3]=t.data[3],a[4]=t.data[4],a[5]=t.data[5],a[6]=t.data[6],a[7]=t.data[7],a[8]=t.data[8],a[9]=t.data[9],a[10]=t.data[10],a[11]=t.data[11]):(a[0]=t[0],a[1]=t[1],a[2]=t[2],a[3]=t[3],a[4]=t[4],a[5]=t[5],a[6]=t[6],a[7]=t[7],a[8]=t[8],a[9]=t[9],a[10]=t[10],a[11]=t[11]))}if(o==="mat4x2f"||o==="mat4x2h"){const a=new Float32Array(this.buffer,r,8);return void(t instanceof k?(a[0]=t.data[0],a[1]=t.data[1],a[2]=t.data[2],a[3]=t.data[3],a[4]=t.data[4],a[5]=t.data[5],a[6]=t.data[6],a[7]=t.data[7]):(a[0]=t[0],a[1]=t[1],a[2]=t[2],a[3]=t[3],a[4]=t[4],a[5]=t[5],a[6]=t[6],a[7]=t[7]))}if(o==="mat4x3f"||o==="mat4x3h"){const a=new Float32Array(this.buffer,r,12);return void(t instanceof k?(a[0]=t.data[0],a[1]=t.data[1],a[2]=t.data[2],a[3]=t.data[3],a[4]=t.data[4],a[5]=t.data[5],a[6]=t.data[6],a[7]=t.data[7],a[8]=t.data[8],a[9]=t.data[9],a[10]=t.data[10],a[11]=t.data[11]):(a[0]=t[0],a[1]=t[1],a[2]=t[2],a[3]=t[3],a[4]=t[4],a[5]=t[5],a[6]=t[6],a[7]=t[7],a[8]=t[8],a[9]=t[9],a[10]=t[10],a[11]=t[11]))}if(o==="mat4x4f"||o==="mat4x4h"){const a=new Float32Array(this.buffer,r,16);return void(t instanceof k?(a[0]=t.data[0],a[1]=t.data[1],a[2]=t.data[2],a[3]=t.data[3],a[4]=t.data[4],a[5]=t.data[5],a[6]=t.data[6],a[7]=t.data[7],a[8]=t.data[8],a[9]=t.data[9],a[10]=t.data[10],a[11]=t.data[11],a[12]=t.data[12],a[13]=t.data[13],a[14]=t.data[14],a[15]=t.data[15]):(a[0]=t[0],a[1]=t[1],a[2]=t[2],a[3]=t[3],a[4]=t[4],a[5]=t[5],a[6]=t[6],a[7]=t[7],a[8]=t[8],a[9]=t[9],a[10]=t[10],a[11]=t[11],a[12]=t[12],a[13]=t[13],a[14]=t[14],a[15]=t[15]))}if(t instanceof G){if(n===t.typeInfo)return void new Uint8Array(this.buffer,r,t.buffer.byteLength).set(new Uint8Array(t.buffer));console.error("SetDataValue: Type mismatch",o,t.typeInfo.getTypeName())}else console.error(`SetData: Unknown type ${o}`)}else t instanceof m&&(new Int32Array(this.buffer,r,1)[0]=t.value);else t instanceof m&&(new Uint32Array(this.buffer,r,1)[0]=t.value);else t instanceof m&&(new Int32Array(this.buffer,r,1)[0]=t.value);else t instanceof m&&(new Float32Array(this.buffer,r,1)[0]=t.value)}getSubData(e,t,n){var r,i,o;if(t===null)return this;let a=this.offset,c=this.typeInfo;for(;t;){if(t instanceof Mt){const u=t.index,h=u instanceof Ie?e.evalExpression(u,n):u;let f=0;if(h instanceof m?f=h.value:typeof h=="number"?f=h:console.error("GetDataValue: Invalid index type",u),c instanceof Ze)a+=f*c.stride,c=c.format;else{const g=c.getTypeName();g==="mat4x4"||g==="mat4x4f"||g==="mat4x4h"?(a+=16*f,c=e.getTypeInfo("vec4f")):console.error(`getDataValue: Type ${c.getTypeName()} is not an array`)}}else{if(!(t instanceof lt))return console.error("GetDataValue: Unknown postfix type",t),null;{const u=t.value;if(c instanceof Xe){let h=!1;for(const f of c.members)if(f.name===u){a+=f.offset,c=f.type,h=!0;break}if(!h)return console.error(`GetDataValue: Member ${u} not found`),null}else if(c instanceof be){const h=c.getTypeName();if(h==="vec2f"||h==="vec3f"||h==="vec4f"||h==="vec2i"||h==="vec3i"||h==="vec4i"||h==="vec2u"||h==="vec3u"||h==="vec4u"||h==="vec2b"||h==="vec3b"||h==="vec4b"||h==="vec2h"||h==="vec3h"||h==="vec4h"||h==="vec2"||h==="vec3"||h==="vec4"){if(u.length>0&&u.length<5){let f="f";const g=[];for(let _=0;_<u.length;++_){const w=u[_].toLowerCase();let A=0;if(w==="x"||w==="r")A=0;else if(w==="y"||w==="g")A=1;else if(w==="z"||w==="b")A=2;else{if(w!=="w"&&w!=="a")return console.error(`Unknown member ${u}`),null;A=3}if(u.length===1){if(h.endsWith("f"))return this.buffer.byteLength<a+4*A+4?(console.log("Insufficient buffer data"),null):new m(new Float32Array(this.buffer,a+4*A,1),e.getTypeInfo("f32"),this);if(h.endsWith("h"))return new m(new Float32Array(this.buffer,a+4*A,1),e.getTypeInfo("f16"),this);if(h.endsWith("i"))return new m(new Int32Array(this.buffer,a+4*A,1),e.getTypeInfo("i32"),this);if(h.endsWith("b"))return new m(new Int32Array(this.buffer,a+4*A,1),e.getTypeInfo("bool"),this);if(h.endsWith("u"))return new m(new Uint32Array(this.buffer,a+4*A,1),e.getTypeInfo("i32"),this)}if(h==="vec2f")g.push(new Float32Array(this.buffer,a,2)[A]);else if(h==="vec3f"){if(a+12>=this.buffer.byteLength)return console.log("Insufficient buffer data"),null;const S=new Float32Array(this.buffer,a,3);g.push(S[A])}else if(h==="vec4f")g.push(new Float32Array(this.buffer,a,4)[A]);else if(h==="vec2i")f="i",g.push(new Int32Array(this.buffer,a,2)[A]);else if(h==="vec3i")f="i",g.push(new Int32Array(this.buffer,a,3)[A]);else if(h==="vec4i")f="i",g.push(new Int32Array(this.buffer,a,4)[A]);else if(h==="vec2u"){f="u";const S=new Uint32Array(this.buffer,a,2);g.push(S[A])}else h==="vec3u"?(f="u",g.push(new Uint32Array(this.buffer,a,3)[A])):h==="vec4u"&&(f="u",g.push(new Uint32Array(this.buffer,a,4)[A]))}return g.length===2?c=e.getTypeInfo(`vec2${f}`):g.length===3?c=e.getTypeInfo(`vec3${f}`):g.length===4?c=e.getTypeInfo(`vec4${f}`):console.error(`GetDataValue: Invalid vector length ${g.length}`),new p(g,c,null)}return console.error(`GetDataValue: Unknown member ${u}`),null}return console.error(`GetDataValue: Type ${h} is not a struct`),null}}}t=t.postfix}const l=c.getTypeName();return l==="f32"?new m(new Float32Array(this.buffer,a,1),c,this):l==="i32"?new m(new Int32Array(this.buffer,a,1),c,this):l==="u32"?new m(new Uint32Array(this.buffer,a,1),c,this):l==="vec2f"?new p(new Float32Array(this.buffer,a,2),c,this):l==="vec3f"?new p(new Float32Array(this.buffer,a,3),c,this):l==="vec4f"?new p(new Float32Array(this.buffer,a,4),c,this):l==="vec2i"?new p(new Int32Array(this.buffer,a,2),c,this):l==="vec3i"?new p(new Int32Array(this.buffer,a,3),c,this):l==="vec4i"?new p(new Int32Array(this.buffer,a,4),c,this):l==="vec2u"?new p(new Uint32Array(this.buffer,a,2),c,this):l==="vec3u"?new p(new Uint32Array(this.buffer,a,3),c,this):l==="vec4u"?new p(new Uint32Array(this.buffer,a,4),c,this):c instanceof ct&&c.name==="atomic"?((r=c.format)===null||r===void 0?void 0:r.name)==="u32"?new m(new Uint32Array(this.buffer,a,1)[0],c.format,this):((i=c.format)===null||i===void 0?void 0:i.name)==="i32"?new m(new Int32Array(this.buffer,a,1)[0],c.format,this):(console.error(`GetDataValue: Invalid atomic format ${(o=c.format)===null||o===void 0?void 0:o.name}`),null):new G(this.buffer,c,a,this)}toString(){let e="";if(this.typeInfo instanceof Ze)if(this.typeInfo.format.name==="f32"){const t=new Float32Array(this.buffer,this.offset);e=`[${t[0]}`;for(let n=1;n<t.length;++n)e+=`, ${t[n]}`}else if(this.typeInfo.format.name==="i32"){const t=new Int32Array(this.buffer,this.offset);e=`[${t[0]}`;for(let n=1;n<t.length;++n)e+=`, ${t[n]}`}else if(this.typeInfo.format.name==="u32"){const t=new Uint32Array(this.buffer,this.offset);e=`[${t[0]}`;for(let n=1;n<t.length;++n)e+=`, ${t[n]}`}else if(this.typeInfo.format.name==="vec2f"){const t=new Float32Array(this.buffer,this.offset);e=`[${t[0]}, ${t[1]}]`;for(let n=1;n<t.length/2;++n)e+=`, [${t[2*n]}, ${t[2*n+1]}]`}else if(this.typeInfo.format.name==="vec3f"){const t=new Float32Array(this.buffer,this.offset);e=`[${t[0]}, ${t[1]}, ${t[2]}]`;for(let n=4;n<t.length;n+=4)e+=`, [${t[n]}, ${t[n+1]}, ${t[n+2]}]`}else if(this.typeInfo.format.name==="vec4f"){const t=new Float32Array(this.buffer,this.offset);e=`[${t[0]}, ${t[1]}, ${t[2]}, ${t[3]}]`;for(let n=4;n<t.length;n+=4)e+=`, [${t[n]}, ${t[n+1]}, ${t[n+2]}, ${t[n+3]}]`}else e="[...]";else this.typeInfo instanceof Xe?e+="{...}":e="[...]";return e}}class Be extends we{constructor(e,t,n,r){super(t,null),this.data=e,this.descriptor=n,this.view=r}clone(){return new Be(this.data,this.typeInfo,this.descriptor,this.view)}get width(){var e,t;const n=this.descriptor.size;return n instanceof Array&&n.length>0?(e=n[0])!==null&&e!==void 0?e:0:n instanceof Object&&(t=n.width)!==null&&t!==void 0?t:0}get height(){var e,t;const n=this.descriptor.size;return n instanceof Array&&n.length>1?(e=n[1])!==null&&e!==void 0?e:0:n instanceof Object&&(t=n.height)!==null&&t!==void 0?t:0}get depthOrArrayLayers(){var e,t;const n=this.descriptor.size;return n instanceof Array&&n.length>2?(e=n[2])!==null&&e!==void 0?e:0:n instanceof Object&&(t=n.depthOrArrayLayers)!==null&&t!==void 0?t:0}get format(){var e;return this.descriptor&&(e=this.descriptor.format)!==null&&e!==void 0?e:"rgba8unorm"}get sampleCount(){var e;return this.descriptor&&(e=this.descriptor.sampleCount)!==null&&e!==void 0?e:1}get mipLevelCount(){var e;return this.descriptor&&(e=this.descriptor.mipLevelCount)!==null&&e!==void 0?e:1}get dimension(){var e;return this.descriptor&&(e=this.descriptor.dimension)!==null&&e!==void 0?e:"2d"}getMipLevelSize(e){if(e>=this.mipLevelCount)return[0,0,0];const t=[this.width,this.height,this.depthOrArrayLayers];for(let n=0;n<t.length;++n)t[n]=Math.max(1,t[n]>>e);return t}get texelByteSize(){const e=this.format,t=En[e];return t?t.isDepthStencil?4:t.bytesPerBlock:0}get bytesPerRow(){return this.width*this.texelByteSize}get isDepthStencil(){const e=this.format,t=En[e];return!!t&&t.isDepthStencil}getGpuSize(){const e=this.format,t=En[e],n=this.width;if(!e||n<=0||!t)return-1;const r=this.height,i=this.depthOrArrayLayers,o=this.dimension;return n/t.blockWidth*(o==="1d"?1:r/t.blockHeight)*t.bytesPerBlock*i}getPixel(e,t,n=0,r=0){const i=this.texelByteSize,o=this.bytesPerRow,a=this.height,c=this.data[r];return Ud(new Uint8Array(c),e,t,n,r,a,o,i,this.format)}setPixel(e,t,n,r,i){const o=this.texelByteSize,a=this.bytesPerRow,c=this.height,l=this.data[r];(function(u,h,f,g,_,w,A,S,I,x){const E=g*(A>>=_)*(w>>=_)+f*A+h*S;switch(I){case"r8unorm":return void j(u,E,"8unorm",1,x);case"r8snorm":return void j(u,E,"8snorm",1,x);case"r8uint":return void j(u,E,"8uint",1,x);case"r8sint":return void j(u,E,"8sint",1,x);case"rg8unorm":return void j(u,E,"8unorm",2,x);case"rg8snorm":return void j(u,E,"8snorm",2,x);case"rg8uint":return void j(u,E,"8uint",2,x);case"rg8sint":return void j(u,E,"8sint",2,x);case"rgba8unorm-srgb":case"rgba8unorm":case"bgra8unorm-srgb":case"bgra8unorm":return void j(u,E,"8unorm",4,x);case"rgba8snorm":return void j(u,E,"8snorm",4,x);case"rgba8uint":return void j(u,E,"8uint",4,x);case"rgba8sint":return void j(u,E,"8sint",4,x);case"r16uint":return void j(u,E,"16uint",1,x);case"r16sint":return void j(u,E,"16sint",1,x);case"r16float":return void j(u,E,"16float",1,x);case"rg16uint":return void j(u,E,"16uint",2,x);case"rg16sint":return void j(u,E,"16sint",2,x);case"rg16float":return void j(u,E,"16float",2,x);case"rgba16uint":return void j(u,E,"16uint",4,x);case"rgba16sint":return void j(u,E,"16sint",4,x);case"rgba16float":return void j(u,E,"16float",4,x);case"r32uint":return void j(u,E,"32uint",1,x);case"r32sint":return void j(u,E,"32sint",1,x);case"depth16unorm":case"depth24plus":case"depth24plus-stencil8":case"depth32float":case"depth32float-stencil8":case"r32float":return void j(u,E,"32float",1,x);case"rg32uint":return void j(u,E,"32uint",2,x);case"rg32sint":return void j(u,E,"32sint",2,x);case"rg32float":return void j(u,E,"32float",2,x);case"rgba32uint":return void j(u,E,"32uint",4,x);case"rgba32sint":return void j(u,E,"32sint",4,x);case"rgba32float":return void j(u,E,"32float",4,x);case"rg11b10ufloat":console.error("TODO: rg11b10ufloat not supported for writing")}})(new Uint8Array(l),e,t,n,r,c,a,o,this.format,i)}}(s=>{s[s.token=0]="token",s[s.keyword=1]="keyword",s[s.reserved=2]="reserved"})(b||(b={}));class y{constructor(e,t,n){this.name=e,this.type=t,this.rule=n}toString(){return this.name}}class d{}v=d,d.none=new y("",b.reserved,""),d.eof=new y("EOF",b.token,""),d.reserved={asm:new y("asm",b.reserved,"asm"),bf16:new y("bf16",b.reserved,"bf16"),do:new y("do",b.reserved,"do"),enum:new y("enum",b.reserved,"enum"),f16:new y("f16",b.reserved,"f16"),f64:new y("f64",b.reserved,"f64"),handle:new y("handle",b.reserved,"handle"),i8:new y("i8",b.reserved,"i8"),i16:new y("i16",b.reserved,"i16"),i64:new y("i64",b.reserved,"i64"),mat:new y("mat",b.reserved,"mat"),premerge:new y("premerge",b.reserved,"premerge"),regardless:new y("regardless",b.reserved,"regardless"),typedef:new y("typedef",b.reserved,"typedef"),u8:new y("u8",b.reserved,"u8"),u16:new y("u16",b.reserved,"u16"),u64:new y("u64",b.reserved,"u64"),unless:new y("unless",b.reserved,"unless"),using:new y("using",b.reserved,"using"),vec:new y("vec",b.reserved,"vec"),void:new y("void",b.reserved,"void")},d.keywords={array:new y("array",b.keyword,"array"),atomic:new y("atomic",b.keyword,"atomic"),bool:new y("bool",b.keyword,"bool"),f32:new y("f32",b.keyword,"f32"),i32:new y("i32",b.keyword,"i32"),mat2x2:new y("mat2x2",b.keyword,"mat2x2"),mat2x3:new y("mat2x3",b.keyword,"mat2x3"),mat2x4:new y("mat2x4",b.keyword,"mat2x4"),mat3x2:new y("mat3x2",b.keyword,"mat3x2"),mat3x3:new y("mat3x3",b.keyword,"mat3x3"),mat3x4:new y("mat3x4",b.keyword,"mat3x4"),mat4x2:new y("mat4x2",b.keyword,"mat4x2"),mat4x3:new y("mat4x3",b.keyword,"mat4x3"),mat4x4:new y("mat4x4",b.keyword,"mat4x4"),ptr:new y("ptr",b.keyword,"ptr"),sampler:new y("sampler",b.keyword,"sampler"),sampler_comparison:new y("sampler_comparison",b.keyword,"sampler_comparison"),struct:new y("struct",b.keyword,"struct"),texture_1d:new y("texture_1d",b.keyword,"texture_1d"),texture_2d:new y("texture_2d",b.keyword,"texture_2d"),texture_2d_array:new y("texture_2d_array",b.keyword,"texture_2d_array"),texture_3d:new y("texture_3d",b.keyword,"texture_3d"),texture_cube:new y("texture_cube",b.keyword,"texture_cube"),texture_cube_array:new y("texture_cube_array",b.keyword,"texture_cube_array"),texture_multisampled_2d:new y("texture_multisampled_2d",b.keyword,"texture_multisampled_2d"),texture_storage_1d:new y("texture_storage_1d",b.keyword,"texture_storage_1d"),texture_storage_2d:new y("texture_storage_2d",b.keyword,"texture_storage_2d"),texture_storage_2d_array:new y("texture_storage_2d_array",b.keyword,"texture_storage_2d_array"),texture_storage_3d:new y("texture_storage_3d",b.keyword,"texture_storage_3d"),texture_depth_2d:new y("texture_depth_2d",b.keyword,"texture_depth_2d"),texture_depth_2d_array:new y("texture_depth_2d_array",b.keyword,"texture_depth_2d_array"),texture_depth_cube:new y("texture_depth_cube",b.keyword,"texture_depth_cube"),texture_depth_cube_array:new y("texture_depth_cube_array",b.keyword,"texture_depth_cube_array"),texture_depth_multisampled_2d:new y("texture_depth_multisampled_2d",b.keyword,"texture_depth_multisampled_2d"),texture_external:new y("texture_external",b.keyword,"texture_external"),u32:new y("u32",b.keyword,"u32"),vec2:new y("vec2",b.keyword,"vec2"),vec3:new y("vec3",b.keyword,"vec3"),vec4:new y("vec4",b.keyword,"vec4"),bitcast:new y("bitcast",b.keyword,"bitcast"),block:new y("block",b.keyword,"block"),break:new y("break",b.keyword,"break"),case:new y("case",b.keyword,"case"),continue:new y("continue",b.keyword,"continue"),continuing:new y("continuing",b.keyword,"continuing"),default:new y("default",b.keyword,"default"),diagnostic:new y("diagnostic",b.keyword,"diagnostic"),discard:new y("discard",b.keyword,"discard"),else:new y("else",b.keyword,"else"),enable:new y("enable",b.keyword,"enable"),fallthrough:new y("fallthrough",b.keyword,"fallthrough"),false:new y("false",b.keyword,"false"),fn:new y("fn",b.keyword,"fn"),for:new y("for",b.keyword,"for"),function:new y("function",b.keyword,"function"),if:new y("if",b.keyword,"if"),let:new y("let",b.keyword,"let"),const:new y("const",b.keyword,"const"),loop:new y("loop",b.keyword,"loop"),while:new y("while",b.keyword,"while"),private:new y("private",b.keyword,"private"),read:new y("read",b.keyword,"read"),read_write:new y("read_write",b.keyword,"read_write"),return:new y("return",b.keyword,"return"),requires:new y("requires",b.keyword,"requires"),storage:new y("storage",b.keyword,"storage"),switch:new y("switch",b.keyword,"switch"),true:new y("true",b.keyword,"true"),alias:new y("alias",b.keyword,"alias"),type:new y("type",b.keyword,"type"),uniform:new y("uniform",b.keyword,"uniform"),var:new y("var",b.keyword,"var"),override:new y("override",b.keyword,"override"),workgroup:new y("workgroup",b.keyword,"workgroup"),write:new y("write",b.keyword,"write"),r8unorm:new y("r8unorm",b.keyword,"r8unorm"),r8snorm:new y("r8snorm",b.keyword,"r8snorm"),r8uint:new y("r8uint",b.keyword,"r8uint"),r8sint:new y("r8sint",b.keyword,"r8sint"),r16uint:new y("r16uint",b.keyword,"r16uint"),r16sint:new y("r16sint",b.keyword,"r16sint"),r16float:new y("r16float",b.keyword,"r16float"),rg8unorm:new y("rg8unorm",b.keyword,"rg8unorm"),rg8snorm:new y("rg8snorm",b.keyword,"rg8snorm"),rg8uint:new y("rg8uint",b.keyword,"rg8uint"),rg8sint:new y("rg8sint",b.keyword,"rg8sint"),r32uint:new y("r32uint",b.keyword,"r32uint"),r32sint:new y("r32sint",b.keyword,"r32sint"),r32float:new y("r32float",b.keyword,"r32float"),rg16uint:new y("rg16uint",b.keyword,"rg16uint"),rg16sint:new y("rg16sint",b.keyword,"rg16sint"),rg16float:new y("rg16float",b.keyword,"rg16float"),rgba8unorm:new y("rgba8unorm",b.keyword,"rgba8unorm"),rgba8unorm_srgb:new y("rgba8unorm_srgb",b.keyword,"rgba8unorm_srgb"),rgba8snorm:new y("rgba8snorm",b.keyword,"rgba8snorm"),rgba8uint:new y("rgba8uint",b.keyword,"rgba8uint"),rgba8sint:new y("rgba8sint",b.keyword,"rgba8sint"),bgra8unorm:new y("bgra8unorm",b.keyword,"bgra8unorm"),bgra8unorm_srgb:new y("bgra8unorm_srgb",b.keyword,"bgra8unorm_srgb"),rgb10a2unorm:new y("rgb10a2unorm",b.keyword,"rgb10a2unorm"),rg11b10float:new y("rg11b10float",b.keyword,"rg11b10float"),rg32uint:new y("rg32uint",b.keyword,"rg32uint"),rg32sint:new y("rg32sint",b.keyword,"rg32sint"),rg32float:new y("rg32float",b.keyword,"rg32float"),rgba16uint:new y("rgba16uint",b.keyword,"rgba16uint"),rgba16sint:new y("rgba16sint",b.keyword,"rgba16sint"),rgba16float:new y("rgba16float",b.keyword,"rgba16float"),rgba32uint:new y("rgba32uint",b.keyword,"rgba32uint"),rgba32sint:new y("rgba32sint",b.keyword,"rgba32sint"),rgba32float:new y("rgba32float",b.keyword,"rgba32float"),static_assert:new y("static_assert",b.keyword,"static_assert")},d.tokens={decimal_float_literal:new y("decimal_float_literal",b.token,/((-?[0-9]*\.[0-9]+|-?[0-9]+\.[0-9]*)((e|E)(\+|-)?[0-9]+)?[fh]?)|(-?[0-9]+(e|E)(\+|-)?[0-9]+[fh]?)|(-?[0-9]+[fh])/),hex_float_literal:new y("hex_float_literal",b.token,/-?0x((([0-9a-fA-F]*\.[0-9a-fA-F]+|[0-9a-fA-F]+\.[0-9a-fA-F]*)((p|P)(\+|-)?[0-9]+[fh]?)?)|([0-9a-fA-F]+(p|P)(\+|-)?[0-9]+[fh]?))/),int_literal:new y("int_literal",b.token,/-?0x[0-9a-fA-F]+|0i?|-?[1-9][0-9]*i?/),uint_literal:new y("uint_literal",b.token,/0x[0-9a-fA-F]+u|0u|[1-9][0-9]*u/),name:new y("name",b.token,/([_\p{XID_Start}][\p{XID_Continue}]+)|([\p{XID_Start}])/u),ident:new y("ident",b.token,/[_a-zA-Z][0-9a-zA-Z_]*/),and:new y("and",b.token,"&"),and_and:new y("and_and",b.token,"&&"),arrow:new y("arrow ",b.token,"->"),attr:new y("attr",b.token,"@"),forward_slash:new y("forward_slash",b.token,"/"),bang:new y("bang",b.token,"!"),bracket_left:new y("bracket_left",b.token,"["),bracket_right:new y("bracket_right",b.token,"]"),brace_left:new y("brace_left",b.token,"{"),brace_right:new y("brace_right",b.token,"}"),colon:new y("colon",b.token,":"),comma:new y("comma",b.token,","),equal:new y("equal",b.token,"="),equal_equal:new y("equal_equal",b.token,"=="),not_equal:new y("not_equal",b.token,"!="),greater_than:new y("greater_than",b.token,">"),greater_than_equal:new y("greater_than_equal",b.token,">="),shift_right:new y("shift_right",b.token,">>"),less_than:new y("less_than",b.token,"<"),less_than_equal:new y("less_than_equal",b.token,"<="),shift_left:new y("shift_left",b.token,"<<"),modulo:new y("modulo",b.token,"%"),minus:new y("minus",b.token,"-"),minus_minus:new y("minus_minus",b.token,"--"),period:new y("period",b.token,"."),plus:new y("plus",b.token,"+"),plus_plus:new y("plus_plus",b.token,"++"),or:new y("or",b.token,"|"),or_or:new y("or_or",b.token,"||"),paren_left:new y("paren_left",b.token,"("),paren_right:new y("paren_right",b.token,")"),semicolon:new y("semicolon",b.token,";"),star:new y("star",b.token,"*"),tilde:new y("tilde",b.token,"~"),underscore:new y("underscore",b.token,"_"),xor:new y("xor",b.token,"^"),plus_equal:new y("plus_equal",b.token,"+="),minus_equal:new y("minus_equal",b.token,"-="),times_equal:new y("times_equal",b.token,"*="),division_equal:new y("division_equal",b.token,"/="),modulo_equal:new y("modulo_equal",b.token,"%="),and_equal:new y("and_equal",b.token,"&="),or_equal:new y("or_equal",b.token,"|="),xor_equal:new y("xor_equal",b.token,"^="),shift_right_equal:new y("shift_right_equal",b.token,">>="),shift_left_equal:new y("shift_left_equal",b.token,"<<=")},d.simpleTokens={"@":v.tokens.attr,"{":v.tokens.brace_left,"}":v.tokens.brace_right,":":v.tokens.colon,",":v.tokens.comma,"(":v.tokens.paren_left,")":v.tokens.paren_right,";":v.tokens.semicolon},d.literalTokens={"&":v.tokens.and,"&&":v.tokens.and_and,"->":v.tokens.arrow,"/":v.tokens.forward_slash,"!":v.tokens.bang,"[":v.tokens.bracket_left,"]":v.tokens.bracket_right,"=":v.tokens.equal,"==":v.tokens.equal_equal,"!=":v.tokens.not_equal,">":v.tokens.greater_than,">=":v.tokens.greater_than_equal,">>":v.tokens.shift_right,"<":v.tokens.less_than,"<=":v.tokens.less_than_equal,"<<":v.tokens.shift_left,"%":v.tokens.modulo,"-":v.tokens.minus,"--":v.tokens.minus_minus,".":v.tokens.period,"+":v.tokens.plus,"++":v.tokens.plus_plus,"|":v.tokens.or,"||":v.tokens.or_or,"*":v.tokens.star,"~":v.tokens.tilde,_:v.tokens.underscore,"^":v.tokens.xor,"+=":v.tokens.plus_equal,"-=":v.tokens.minus_equal,"*=":v.tokens.times_equal,"/=":v.tokens.division_equal,"%=":v.tokens.modulo_equal,"&=":v.tokens.and_equal,"|=":v.tokens.or_equal,"^=":v.tokens.xor_equal,">>=":v.tokens.shift_right_equal,"<<=":v.tokens.shift_left_equal},d.regexTokens={decimal_float_literal:v.tokens.decimal_float_literal,hex_float_literal:v.tokens.hex_float_literal,int_literal:v.tokens.int_literal,uint_literal:v.tokens.uint_literal,ident:v.tokens.ident},d.storage_class=[v.keywords.function,v.keywords.private,v.keywords.workgroup,v.keywords.uniform,v.keywords.storage],d.access_mode=[v.keywords.read,v.keywords.write,v.keywords.read_write],d.sampler_type=[v.keywords.sampler,v.keywords.sampler_comparison],d.sampled_texture_type=[v.keywords.texture_1d,v.keywords.texture_2d,v.keywords.texture_2d_array,v.keywords.texture_3d,v.keywords.texture_cube,v.keywords.texture_cube_array],d.multisampled_texture_type=[v.keywords.texture_multisampled_2d],d.storage_texture_type=[v.keywords.texture_storage_1d,v.keywords.texture_storage_2d,v.keywords.texture_storage_2d_array,v.keywords.texture_storage_3d],d.depth_texture_type=[v.keywords.texture_depth_2d,v.keywords.texture_depth_2d_array,v.keywords.texture_depth_cube,v.keywords.texture_depth_cube_array,v.keywords.texture_depth_multisampled_2d],d.texture_external_type=[v.keywords.texture_external],d.any_texture_type=[...v.sampled_texture_type,...v.multisampled_texture_type,...v.storage_texture_type,...v.depth_texture_type,...v.texture_external_type],d.texel_format=[v.keywords.r8unorm,v.keywords.r8snorm,v.keywords.r8uint,v.keywords.r8sint,v.keywords.r16uint,v.keywords.r16sint,v.keywords.r16float,v.keywords.rg8unorm,v.keywords.rg8snorm,v.keywords.rg8uint,v.keywords.rg8sint,v.keywords.r32uint,v.keywords.r32sint,v.keywords.r32float,v.keywords.rg16uint,v.keywords.rg16sint,v.keywords.rg16float,v.keywords.rgba8unorm,v.keywords.rgba8unorm_srgb,v.keywords.rgba8snorm,v.keywords.rgba8uint,v.keywords.rgba8sint,v.keywords.bgra8unorm,v.keywords.bgra8unorm_srgb,v.keywords.rgb10a2unorm,v.keywords.rg11b10float,v.keywords.rg32uint,v.keywords.rg32sint,v.keywords.rg32float,v.keywords.rgba16uint,v.keywords.rgba16sint,v.keywords.rgba16float,v.keywords.rgba32uint,v.keywords.rgba32sint,v.keywords.rgba32float],d.const_literal=[v.tokens.int_literal,v.tokens.uint_literal,v.tokens.decimal_float_literal,v.tokens.hex_float_literal,v.keywords.true,v.keywords.false],d.literal_or_ident=[v.tokens.ident,v.tokens.int_literal,v.tokens.uint_literal,v.tokens.decimal_float_literal,v.tokens.hex_float_literal,v.tokens.name],d.element_count_expression=[v.tokens.int_literal,v.tokens.uint_literal,v.tokens.ident],d.template_types=[v.keywords.vec2,v.keywords.vec3,v.keywords.vec4,v.keywords.mat2x2,v.keywords.mat2x3,v.keywords.mat2x4,v.keywords.mat3x2,v.keywords.mat3x3,v.keywords.mat3x4,v.keywords.mat4x2,v.keywords.mat4x3,v.keywords.mat4x4,v.keywords.atomic,v.keywords.bitcast,...v.any_texture_type],d.attribute_name=[v.tokens.ident,v.keywords.block,v.keywords.diagnostic],d.assignment_operators=[v.tokens.equal,v.tokens.plus_equal,v.tokens.minus_equal,v.tokens.times_equal,v.tokens.division_equal,v.tokens.modulo_equal,v.tokens.and_equal,v.tokens.or_equal,v.tokens.xor_equal,v.tokens.shift_right_equal,v.tokens.shift_left_equal],d.increment_operators=[v.tokens.plus_plus,v.tokens.minus_minus];class Qi{constructor(e,t,n,r,i){this.type=e,this.lexeme=t,this.line=n,this.start=r,this.end=i}toString(){return this.lexeme}isTemplateType(){return d.template_types.indexOf(this.type)!=-1}isArrayType(){return this.type==d.keywords.array}isArrayOrTemplateType(){return this.isArrayType()||this.isTemplateType()}}class zd{constructor(e){this._tokens=[],this._start=0,this._current=0,this._line=1,this._source=e??""}scanTokens(){for(;!this._isAtEnd();)if(this._start=this._current,!this.scanToken())throw`Invalid syntax at line ${this._line}`;return this._tokens.push(new Qi(d.eof,"",this._line,this._current,this._current)),this._tokens}scanToken(){let e=this._advance();if(e==`
`)return this._line++,!0;if(this._isWhitespace(e))return!0;if(e=="/"){if(this._peekAhead()=="/"){for(;e!=`
`;){if(this._isAtEnd())return!0;e=this._advance()}return this._line++,!0}if(this._peekAhead()=="*"){this._advance();let o=1;for(;o>0;){if(this._isAtEnd())return!0;if(e=this._advance(),e==`
`)this._line++;else if(e=="*"){if(this._peekAhead()=="/"&&(this._advance(),o--,o==0))return!0}else e=="/"&&this._peekAhead()=="*"&&(this._advance(),o++)}return!0}}const t=d.simpleTokens[e];if(t)return this._addToken(t),!0;let n=d.none;const r=this._isAlpha(e),i=e==="_";if(this._isAlphaNumeric(e)){let o=this._peekAhead();for(;this._isAlphaNumeric(o);)e+=this._advance(),o=this._peekAhead()}if(r){const o=d.keywords[e];if(o)return this._addToken(o),!0}if(r||i)return this._addToken(d.tokens.ident),!0;for(;;){let o=this._findType(e);const a=this._peekAhead();if(e=="-"&&this._tokens.length>0){if(a=="=")return this._current++,e+=a,this._addToken(d.tokens.minus_equal),!0;if(a=="-")return this._current++,e+=a,this._addToken(d.tokens.minus_minus),!0;const c=this._tokens.length-1;if((d.literal_or_ident.indexOf(this._tokens[c].type)!=-1||this._tokens[c].type==d.tokens.paren_right)&&a!=">")return this._addToken(o),!0}if(e==">"&&(a==">"||a=="=")){let c=!1,l=this._tokens.length-1;for(let u=0;u<5&&l>=0&&d.assignment_operators.indexOf(this._tokens[l].type)===-1;++u,--l)if(this._tokens[l].type===d.tokens.less_than){l>0&&this._tokens[l-1].isArrayOrTemplateType()&&(c=!0);break}if(c)return this._addToken(o),!0}if(o===d.none){let c=e,l=0;const u=2;for(let h=0;h<u;++h)if(c+=this._peekAhead(h),o=this._findType(c),o!==d.none){l=h;break}if(o===d.none)return n!==d.none&&(this._current--,this._addToken(n),!0);e=c,this._current+=l+1}if(n=o,this._isAtEnd())break;e+=this._advance()}return n!==d.none&&(this._addToken(n),!0)}_findType(e){for(const n in d.regexTokens){const r=d.regexTokens[n];if(this._match(e,r.rule))return r}return d.literalTokens[e]||d.none}_match(e,t){const n=t.exec(e);return n&&n.index==0&&n[0]==e}_isAtEnd(){return this._current>=this._source.length}_isAlpha(e){return!this._isNumeric(e)&&!this._isWhitespace(e)&&e!=="_"&&e!=="."&&e!=="("&&e!==")"&&e!=="["&&e!=="]"&&e!=="{"&&e!=="}"&&e!==","&&e!==";"&&e!==":"&&e!=="="&&e!=="!"&&e!=="<"&&e!==">"&&e!=="+"&&e!=="-"&&e!=="*"&&e!=="/"&&e!=="%"&&e!=="&"&&e!=="|"&&e!=="^"&&e!=="~"&&e!=="@"&&e!=="#"&&e!=="?"&&e!=="'"&&e!=="`"&&e!=='"'&&e!=="\\"&&e!==`
`&&e!=="\r"&&e!=="	"&&e!=="\0"}_isNumeric(e){return e>="0"&&e<="9"}_isAlphaNumeric(e){return this._isAlpha(e)||this._isNumeric(e)||e==="_"}_isWhitespace(e){return e==" "||e=="	"||e=="\r"}_advance(e=0){let t=this._source[this._current];return e=e||0,e++,this._current+=e,t}_peekAhead(e=0){return e=e||0,this._current+e>=this._source.length?"\0":this._source[this._current+e]}_addToken(e){const t=this._source.substring(this._start,this._current);this._tokens.push(new Qi(e,t,this._line,this._start,this._current))}}function O(s){return Array.isArray(s)||s?.buffer instanceof ArrayBuffer}const $s=new Float32Array(1),Xd=new Uint32Array($s.buffer),Yd=new Uint32Array($s.buffer),Ws=new Int32Array(1),qd=new Float32Array(Ws.buffer),Kd=new Uint32Array(Ws.buffer),js=new Uint32Array(1),Zd=new Float32Array(js.buffer),Qd=new Int32Array(js.buffer);function Ji(s,e,t){if(e===t)return s;if(e==="f32"){if(t==="i32"||t==="x32")return $s[0]=s,Xd[0];if(t==="u32")return $s[0]=s,Yd[0]}else if(e==="i32"||e==="x32"){if(t==="f32")return Ws[0]=s,qd[0];if(t==="u32")return Ws[0]=s,Kd[0]}else if(e==="u32"){if(t==="f32")return js[0]=s,Zd[0];if(t==="i32"||t==="x32")return js[0]=s,Qd[0]}return console.error(`Unsupported cast from ${e} to ${t}`),s}class Jd{constructor(e){this.resources=null,this.inUse=!1,this.info=null,this.node=e}}class ms{constructor(e,t){this.align=e,this.size=t}}class ke{constructor(){this.uniforms=[],this.storage=[],this.textures=[],this.samplers=[],this.aliases=[],this.overrides=[],this.structs=[],this.entry=new Nd,this.functions=[],this._types=new Map,this._functions=new Map}_isStorageTexture(e){return e.name=="texture_storage_1d"||e.name=="texture_storage_2d"||e.name=="texture_storage_2d_array"||e.name=="texture_storage_3d"}updateAST(e){for(const t of e)t instanceof ns&&this._functions.set(t.name,new Jd(t));for(const t of e)if(t instanceof Fe){const n=this.getTypeInfo(t,null);n instanceof Xe&&this.structs.push(n)}for(const t of e)if(t instanceof jr)this.aliases.push(this._getAliasInfo(t));else{if(t instanceof $r){const n=t,r=this._getAttributeNum(n.attributes,"id",0),i=n.type!=null?this.getTypeInfo(n.type,n.attributes):null;this.overrides.push(new Md(n.name,i,n.attributes,r));continue}if(this._isUniformVar(t)){const n=t,r=this._getAttributeNum(n.attributes,"group",0),i=this._getAttributeNum(n.attributes,"binding",0),o=this.getTypeInfo(n.type,n.attributes),a=new _s(n.name,o,r,i,n.attributes,He.Uniform,n.access);a.access||(a.access="read"),this.uniforms.push(a);continue}if(this._isStorageVar(t)){const n=t,r=this._getAttributeNum(n.attributes,"group",0),i=this._getAttributeNum(n.attributes,"binding",0),o=this.getTypeInfo(n.type,n.attributes),a=this._isStorageTexture(o),c=new _s(n.name,o,r,i,n.attributes,a?He.StorageTexture:He.Storage,n.access);c.access||(c.access="read"),this.storage.push(c);continue}if(this._isTextureVar(t)){const n=t,r=this._getAttributeNum(n.attributes,"group",0),i=this._getAttributeNum(n.attributes,"binding",0),o=this.getTypeInfo(n.type,n.attributes),a=this._isStorageTexture(o),c=new _s(n.name,o,r,i,n.attributes,a?He.StorageTexture:He.Texture,n.access);c.access||(c.access="read"),a?this.storage.push(c):this.textures.push(c);continue}if(this._isSamplerVar(t)){const n=t,r=this._getAttributeNum(n.attributes,"group",0),i=this._getAttributeNum(n.attributes,"binding",0),o=this.getTypeInfo(n.type,n.attributes),a=new _s(n.name,o,r,i,n.attributes,He.Sampler,n.access);this.samplers.push(a);continue}}for(const t of e)if(t instanceof ns){const n=this._getAttribute(t,"vertex"),r=this._getAttribute(t,"fragment"),i=this._getAttribute(t,"compute"),o=n||r||i,a=new kd(t.name,o?.name,t.attributes);a.attributes=t.attributes,a.startLine=t.startLine,a.endLine=t.endLine,this.functions.push(a),this._functions.get(t.name).info=a,o&&(this._functions.get(t.name).inUse=!0,a.inUse=!0,a.resources=this._findResources(t,!!o),a.inputs=this._getInputs(t.args),a.outputs=this._getOutputs(t.returnType),this.entry[o.name].push(a)),a.arguments=t.args.map(c=>new Od(c.name,this.getTypeInfo(c.type,c.attributes),c.attributes)),a.returnType=t.returnType?this.getTypeInfo(t.returnType,t.attributes):null;continue}for(const t of this._functions.values())t.info&&(t.info.inUse=t.inUse,this._addCalls(t.node,t.info.calls));for(const t of this._functions.values())t.node.search(n=>{var r,i,o;if(n instanceof bc){if(n.value)if(O(n.value))for(const a of n.value)for(const c of this.overrides)a===c.name&&((r=t.info)===null||r===void 0||r.overrides.push(c));else for(const a of this.overrides)n.value===a.name&&((i=t.info)===null||i===void 0||i.overrides.push(a))}else if(n instanceof _e)for(const a of this.overrides)n.name===a.name&&((o=t.info)===null||o===void 0||o.overrides.push(a))});for(const t of this.uniforms)this._markStructsInUse(t.type);for(const t of this.storage)this._markStructsInUse(t.type)}getFunctionInfo(e){for(const t of this.functions)if(t.name==e)return t;return null}getStructInfo(e){for(const t of this.structs)if(t.name==e)return t;return null}getOverrideInfo(e){for(const t of this.overrides)if(t.name==e)return t;return null}_markStructsInUse(e){if(e)if(e.isStruct){if(e.inUse=!0,e.members)for(const t of e.members)this._markStructsInUse(t.type)}else if(e.isArray)this._markStructsInUse(e.format);else if(e.isTemplate)e.format&&this._markStructsInUse(e.format);else{const t=this._getAlias(e.name);t&&this._markStructsInUse(t)}}_addCalls(e,t){var n;for(const r of e.calls){const i=(n=this._functions.get(r.name))===null||n===void 0?void 0:n.info;i&&t.add(i)}}findResource(e,t,n){if(n){for(const r of this.entry.compute)if(r.name===n){for(const i of r.resources)if(i.group==e&&i.binding==t)return i}for(const r of this.entry.vertex)if(r.name===n){for(const i of r.resources)if(i.group==e&&i.binding==t)return i}for(const r of this.entry.fragment)if(r.name===n){for(const i of r.resources)if(i.group==e&&i.binding==t)return i}}for(const r of this.uniforms)if(r.group==e&&r.binding==t)return r;for(const r of this.storage)if(r.group==e&&r.binding==t)return r;for(const r of this.textures)if(r.group==e&&r.binding==t)return r;for(const r of this.samplers)if(r.group==e&&r.binding==t)return r;return null}_findResource(e){for(const t of this.uniforms)if(t.name==e)return t;for(const t of this.storage)if(t.name==e)return t;for(const t of this.textures)if(t.name==e)return t;for(const t of this.samplers)if(t.name==e)return t;return null}_markStructsFromAST(e){const t=this.getTypeInfo(e,null);this._markStructsInUse(t)}_findResources(e,t){const n=[],r=this,i=[];return e.search(o=>{if(o instanceof Ls)i.push({});else if(o instanceof Vs)i.pop();else if(o instanceof Ue){const a=o;t&&a.type!==null&&this._markStructsFromAST(a.type),i.length>0&&(i[i.length-1][a.name]=a)}else if(o instanceof Me){const a=o;t&&a.type!==null&&this._markStructsFromAST(a.type)}else if(o instanceof Qt){const a=o;t&&a.type!==null&&this._markStructsFromAST(a.type),i.length>0&&(i[i.length-1][a.name]=a)}else if(o instanceof _e){const a=o;if(i.length>0&&i[i.length-1][a.name])return;const c=r._findResource(a.name);c&&n.push(c)}else if(o instanceof Hr){const a=o,c=r._functions.get(a.name);c&&(t&&(c.inUse=!0),e.calls.add(c.node),c.resources===null&&(c.resources=r._findResources(c.node,t)),n.push(...c.resources))}else if(o instanceof Wr){const a=o,c=r._functions.get(a.name);c&&(t&&(c.inUse=!0),e.calls.add(c.node),c.resources===null&&(c.resources=r._findResources(c.node,t)),n.push(...c.resources))}}),[...new Map(n.map(o=>[o.name,o])).values()]}getBindGroups(){const e=[];function t(n,r){n>=e.length&&(e.length=n+1),e[n]===void 0&&(e[n]=[]),r>=e[n].length&&(e[n].length=r+1)}for(const n of this.uniforms)t(n.group,n.binding),e[n.group][n.binding]=n;for(const n of this.storage)t(n.group,n.binding),e[n.group][n.binding]=n;for(const n of this.textures)t(n.group,n.binding),e[n.group][n.binding]=n;for(const n of this.samplers)t(n.group,n.binding),e[n.group][n.binding]=n;return e}_getOutputs(e,t=void 0){if(t===void 0&&(t=[]),e instanceof Fe)this._getStructOutputs(e,t);else{const n=this._getOutputInfo(e);n!==null&&t.push(n)}return t}_getStructOutputs(e,t){for(const n of e.members)if(n.type instanceof Fe)this._getStructOutputs(n.type,t);else{const r=this._getAttribute(n,"location")||this._getAttribute(n,"builtin");if(r!==null){const i=this.getTypeInfo(n.type,n.type.attributes),o=this._parseInt(r.value),a=new Xi(n.name,i,r.name,o);t.push(a)}}}_getOutputInfo(e){const t=this._getAttribute(e,"location")||this._getAttribute(e,"builtin");if(t!==null){const n=this.getTypeInfo(e,e.attributes),r=this._parseInt(t.value);return new Xi("",n,t.name,r)}return null}_getInputs(e,t=void 0){t===void 0&&(t=[]);for(const n of e)if(n.type instanceof Fe)this._getStructInputs(n.type,t);else{const r=this._getInputInfo(n);r!==null&&t.push(r)}return t}_getStructInputs(e,t){for(const n of e.members)if(n.type instanceof Fe)this._getStructInputs(n.type,t);else{const r=this._getInputInfo(n);r!==null&&t.push(r)}}_getInputInfo(e){const t=this._getAttribute(e,"location")||this._getAttribute(e,"builtin");if(t!==null){const n=this._getAttribute(e,"interpolation"),r=this.getTypeInfo(e.type,e.attributes),i=this._parseInt(t.value),o=new Pd(e.name,r,t.name,i);return n!==null&&(o.interpolation=this._parseString(n.value)),o}return null}_parseString(e){return e instanceof Array&&(e=e[0]),e}_parseInt(e){e instanceof Array&&(e=e[0]);const t=parseInt(e);return isNaN(t)?e:t}_getAlias(e){for(const t of this.aliases)if(t.name==e)return t.type;return null}_getAliasInfo(e){return new Cd(e.name,this.getTypeInfo(e.type,null))}getTypeInfoByName(e){for(const t of this.structs)if(t.name==e)return t;for(const t of this.aliases)if(t.name==e)return t.type;return null}getTypeInfo(e,t=null){if(this._types.has(e))return this._types.get(e);if(e instanceof Is){const r=e.type?this.getTypeInfo(e.type,e.attributes):null,i=new er(e.name,r,t);return this._types.set(e,i),this._updateTypeInfo(i),i}if(e instanceof Jt){const r=e,i=r.format?this.getTypeInfo(r.format,r.attributes):null,o=new Ze(r.name,t);return o.format=i,o.count=r.count,this._types.set(e,o),this._updateTypeInfo(o),o}if(e instanceof Fe){const r=e,i=new Xe(r.name,t);i.startLine=r.startLine,i.endLine=r.endLine;for(const o of r.members){const a=this.getTypeInfo(o.type,o.attributes);i.members.push(new zi(o.name,a,o.attributes))}return this._types.set(e,i),this._updateTypeInfo(i),i}if(e instanceof zt){const r=e,i=r.format instanceof R,o=r.format?i?this.getTypeInfo(r.format,null):new be(r.format,null):null,a=new ct(r.name,o,t,r.access);return this._types.set(e,a),this._updateTypeInfo(a),a}if(e instanceof T){const r=e,i=r.format?this.getTypeInfo(r.format,null):null,o=new ct(r.name,i,t,r.access);return this._types.set(e,o),this._updateTypeInfo(o),o}const n=new be(e.name,t);return this._types.set(e,n),this._updateTypeInfo(n),n}_updateTypeInfo(e){var t,n,r;const i=this._getTypeSize(e);if(e.size=(t=i?.size)!==null&&t!==void 0?t:0,e instanceof Ze&&e.format){const o=this._getTypeSize(e.format);e.stride=Math.max((n=o?.size)!==null&&n!==void 0?n:0,(r=o?.align)!==null&&r!==void 0?r:0),this._updateTypeInfo(e.format)}e instanceof er&&this._updateTypeInfo(e.format),e instanceof Xe&&this._updateStructInfo(e)}_updateStructInfo(e){var t;let n=0,r=0,i=0,o=0;for(let a=0,c=e.members.length;a<c;++a){const l=e.members[a],u=this._getTypeSize(l);if(!u)continue;(t=this._getAlias(l.type.name))!==null&&t!==void 0||l.type;const h=u.align,f=u.size;n=this._roundUp(h,n+r),r=f,i=n,o=Math.max(o,h),l.offset=n,l.size=f,this._updateTypeInfo(l.type)}e.size=this._roundUp(o,i+r),e.align=o}_getTypeSize(e){var t,n;if(e==null)return null;const r=this._getAttributeNum(e.attributes,"size",0),i=this._getAttributeNum(e.attributes,"align",0);if(e instanceof zi&&(e=e.type),e instanceof be){const o=this._getAlias(e.name);o!==null&&(e=o)}{const o=ke._typeInfo[e.name];if(o!==void 0){const a=((t=e.format)===null||t===void 0?void 0:t.name)==="f16"?2:1;return new ms(Math.max(i,o.align/a),Math.max(r,o.size/a))}}{const o=ke._typeInfo[e.name.substring(0,e.name.length-1)];if(o){const a=e.name[e.name.length-1]==="h"?2:1;return new ms(Math.max(i,o.align/a),Math.max(r,o.size/a))}}if(e instanceof Ze){let o=e,a=8,c=8;const l=this._getTypeSize(o.format);return l!==null&&(c=l.size,a=l.align),c=o.count*this._getAttributeNum((n=e?.attributes)!==null&&n!==void 0?n:null,"stride",this._roundUp(a,c)),r&&(c=r),new ms(Math.max(i,a),Math.max(r,c))}if(e instanceof Xe){let o=0,a=0,c=0,l=0,u=0;for(const h of e.members){const f=this._getTypeSize(h.type);f!==null&&(o=Math.max(f.align,o),c=this._roundUp(f.align,c+l),l=f.size,u=c)}return a=this._roundUp(o,u+l),new ms(Math.max(i,o),Math.max(r,a))}return null}_isUniformVar(e){return e instanceof Ue&&e.storage=="uniform"}_isStorageVar(e){return e instanceof Ue&&e.storage=="storage"}_isTextureVar(e){return e instanceof Ue&&e.type!==null&&ke._textureTypes.indexOf(e.type.name)!=-1}_isSamplerVar(e){return e instanceof Ue&&e.type!==null&&ke._samplerTypes.indexOf(e.type.name)!=-1}_getAttribute(e,t){const n=e;if(!n||!n.attributes)return null;const r=n.attributes;for(let i of r)if(i.name==t)return i;return null}_getAttributeNum(e,t,n){if(e===null)return n;for(let r of e)if(r.name==t){let i=r!==null&&r.value!==null?r.value:n;return i instanceof Array&&(i=i[0]),typeof i=="number"?i:typeof i=="string"?parseInt(i):n}return n}_roundUp(e,t){return Math.ceil(t/e)*e}}ke._typeInfo={f16:{align:2,size:2},i32:{align:4,size:4},u32:{align:4,size:4},f32:{align:4,size:4},atomic:{align:4,size:4},vec2:{align:8,size:8},vec3:{align:16,size:12},vec4:{align:16,size:16},mat2x2:{align:8,size:16},mat3x2:{align:8,size:24},mat4x2:{align:8,size:32},mat2x3:{align:16,size:32},mat3x3:{align:16,size:48},mat4x3:{align:16,size:64},mat2x4:{align:16,size:32},mat3x4:{align:16,size:48},mat4x4:{align:16,size:64}},ke._textureTypes=d.any_texture_type.map(s=>s.name),ke._samplerTypes=d.sampler_type.map(s=>s.name);let zr=0;class Xr{constructor(e,t,n){this.id=zr++,this.name=e,this.value=t,this.node=n}clone(){return new Xr(this.name,this.value,this.node)}}class Yr{constructor(e){this.id=zr++,this.name=e.name,this.node=e}clone(){return new Yr(this.node)}}class qr{constructor(e){this.parent=null,this.variables=new Map,this.functions=new Map,this.currentFunctionName="",this.id=zr++,e&&(this.parent=e,this.currentFunctionName=e.currentFunctionName)}getVariable(e){var t;return this.variables.has(e)?(t=this.variables.get(e))!==null&&t!==void 0?t:null:this.parent?this.parent.getVariable(e):null}getFunction(e){var t;return this.functions.has(e)?(t=this.functions.get(e))!==null&&t!==void 0?t:null:this.parent?this.parent.getFunction(e):null}createVariable(e,t,n){this.variables.set(e,new Xr(e,t,n??null))}setVariable(e,t,n){const r=this.getVariable(e);r!==null?r.value=t:this.createVariable(e,t,n)}getVariableValue(e){var t;const n=this.getVariable(e);return(t=n?.value)!==null&&t!==void 0?t:null}clone(){return new qr(this)}}class Gd{evalExpression(e,t){return null}getTypeInfo(e){return null}getVariableName(e,t){return""}}class ep{constructor(e){this.exec=e}getTypeInfo(e){return this.exec.getTypeInfo(e)}All(e,t){const n=this.exec.evalExpression(e.args[0],t);let r=!0;if(n instanceof p)return n.data.forEach(i=>{i||(r=!1)}),new m(r?1:0,this.getTypeInfo("bool"));throw new Error(`All() expects a vector argument. Line ${e.line}`)}Any(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof p){const r=n.data.some(i=>i);return new m(r?1:0,this.getTypeInfo("bool"))}throw new Error(`Any() expects a vector argument. Line ${e.line}`)}Select(e,t){const n=this.exec.evalExpression(e.args[2],t);if(!(n instanceof m))throw new Error(`Select() expects a bool condition. Line ${e.line}`);return n.value?this.exec.evalExpression(e.args[1],t):this.exec.evalExpression(e.args[0],t)}ArrayLength(e,t){let n=e.args[0];n instanceof se&&(n=n.right);const r=this.exec.evalExpression(n,t);if(r instanceof G&&r.typeInfo.size===0){const i=r.typeInfo,o=r.buffer.byteLength/i.stride;return new m(o,this.getTypeInfo("u32"))}return new m(r.typeInfo.size,this.getTypeInfo("u32"))}Abs(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof p)return new p(n.data.map(i=>Math.abs(i)),n.typeInfo);const r=n;return new m(Math.abs(r.value),r.typeInfo)}Acos(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof p)return new p(n.data.map(i=>Math.acos(i)),n.typeInfo);const r=n;return new m(Math.acos(r.value),n.typeInfo)}Acosh(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof p)return new p(n.data.map(i=>Math.acosh(i)),n.typeInfo);const r=n;return new m(Math.acosh(r.value),n.typeInfo)}Asin(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof p)return new p(n.data.map(i=>Math.asin(i)),n.typeInfo);const r=n;return new m(Math.asin(r.value),n.typeInfo)}Asinh(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof p)return new p(n.data.map(i=>Math.asinh(i)),n.typeInfo);const r=n;return new m(Math.asinh(r.value),n.typeInfo)}Atan(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof p)return new p(n.data.map(i=>Math.atan(i)),n.typeInfo);const r=n;return new m(Math.atan(r.value),n.typeInfo)}Atanh(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof p)return new p(n.data.map(i=>Math.atanh(i)),n.typeInfo);const r=n;return new m(Math.atanh(r.value),n.typeInfo)}Atan2(e,t){const n=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t);if(n instanceof p&&r instanceof p)return new p(n.data.map((a,c)=>Math.atan2(a,r.data[c])),n.typeInfo);const i=n,o=r;return new m(Math.atan2(i.value,o.value),n.typeInfo)}Ceil(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof p)return new p(n.data.map(i=>Math.ceil(i)),n.typeInfo);const r=n;return new m(Math.ceil(r.value),n.typeInfo)}_clamp(e,t,n){return Math.min(Math.max(e,t),n)}Clamp(e,t){const n=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t),i=this.exec.evalExpression(e.args[2],t);if(n instanceof p&&r instanceof p&&i instanceof p)return new p(n.data.map((l,u)=>this._clamp(l,r.data[u],i.data[u])),n.typeInfo);const o=n,a=r,c=i;return new m(this._clamp(o.value,a.value,c.value),n.typeInfo)}Cos(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof p)return new p(n.data.map(i=>Math.cos(i)),n.typeInfo);const r=n;return new m(Math.cos(r.value),n.typeInfo)}Cosh(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof p)return new p(n.data.map(i=>Math.cosh(i)),n.typeInfo);const r=n;return new m(Math.cos(r.value),n.typeInfo)}CountLeadingZeros(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof p)return new p(n.data.map(i=>Math.clz32(i)),n.typeInfo);const r=n;return new m(Math.clz32(r.value),n.typeInfo)}_countOneBits(e){let t=0;for(;e!==0;)1&e&&t++,e>>=1;return t}CountOneBits(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof p)return new p(n.data.map(i=>this._countOneBits(i)),n.typeInfo);const r=n;return new m(this._countOneBits(r.value),n.typeInfo)}_countTrailingZeros(e){if(e===0)return 32;let t=0;for(;!(1&e);)e>>=1,t++;return t}CountTrailingZeros(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof p)return new p(n.data.map(i=>this._countTrailingZeros(i)),n.typeInfo);const r=n;return new m(this._countTrailingZeros(r.value),n.typeInfo)}Cross(e,t){const n=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t);if(n instanceof p&&r instanceof p){if(n.data.length!==3||r.data.length!==3)return console.error(`Cross() expects 3D vectors. Line ${e.line}`),null;const i=n.data,o=r.data;return new p([i[1]*o[2]-o[1]*i[2],i[2]*o[0]-o[2]*i[0],i[0]*o[1]-o[0]*i[1]],n.typeInfo)}return console.error(`Cross() expects vector arguments. Line ${e.line}`),null}Degrees(e,t){const n=this.exec.evalExpression(e.args[0],t),r=180/Math.PI;return n instanceof p?new p(n.data.map(i=>i*r),n.typeInfo):new m(n.value*r,this.getTypeInfo("f32"))}Determinant(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof k){const r=n.data,i=n.typeInfo.getTypeName(),o=i.endsWith("h")?this.getTypeInfo("f16"):this.getTypeInfo("f32");if(i==="mat2x2"||i==="mat2x2f"||i==="mat2x2h")return new m(r[0]*r[3]-r[1]*r[2],o);if(i==="mat2x3"||i==="mat2x3f"||i==="mat2x3h")return new m(r[0]*(r[4]*r[8]-r[5]*r[7])-r[1]*(r[3]*r[8]-r[5]*r[6])+r[2]*(r[3]*r[7]-r[4]*r[6]),o);if(i==="mat2x4"||i==="mat2x4f"||i==="mat2x4h")console.error(`TODO: Determinant for ${i}`);else if(i==="mat3x2"||i==="mat3x2f"||i==="mat3x2h")console.error(`TODO: Determinant for ${i}`);else{if(i==="mat3x3"||i==="mat3x3f"||i==="mat3x3h")return new m(r[0]*(r[4]*r[8]-r[5]*r[7])-r[1]*(r[3]*r[8]-r[5]*r[6])+r[2]*(r[3]*r[7]-r[4]*r[6]),o);i==="mat3x4"||i==="mat3x4f"||i==="mat3x4h"||i==="mat4x2"||i==="mat4x2f"||i==="mat4x2h"||i==="mat4x3"||i==="mat4x3f"||i==="mat4x3h"?console.error(`TODO: Determinant for ${i}`):i!=="mat4x4"&&i!=="mat4x4f"&&i!=="mat4x4h"||console.error(`TODO: Determinant for ${i}`)}}return console.error(`Determinant expects a matrix argument. Line ${e.line}`),null}Distance(e,t){const n=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t);if(n instanceof p&&r instanceof p){let a=0;for(let c=0;c<n.data.length;++c)a+=(n.data[c]-r.data[c])*(n.data[c]-r.data[c]);return new m(Math.sqrt(a),this.getTypeInfo("f32"))}const i=n,o=r;return new m(Math.abs(i.value-o.value),n.typeInfo)}_dot(e,t){let n=0;for(let r=0;r<e.length;++r)n+=t[r]*e[r];return n}Dot(e,t){const n=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t);return n instanceof p&&r instanceof p?new m(this._dot(n.data,r.data),this.getTypeInfo("f32")):(console.error(`Dot() expects vector arguments. Line ${e.line}`),null)}Dot4U8Packed(e,t){return console.error(`TODO: dot4U8Packed. Line ${e.line}`),null}Dot4I8Packed(e,t){return console.error(`TODO: dot4I8Packed. Line ${e.line}`),null}Exp(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof p)return new p(n.data.map(i=>Math.exp(i)),n.typeInfo);const r=n;return new m(Math.exp(r.value),n.typeInfo)}Exp2(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof p)return new p(n.data.map(i=>Math.pow(2,i)),n.typeInfo);const r=n;return new m(Math.pow(2,r.value),n.typeInfo)}ExtractBits(e,t){const n=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t),i=this.exec.evalExpression(e.args[2],t);if(r.typeInfo.name!=="u32"&&r.typeInfo.name!=="x32")return console.error(`ExtractBits() expects an i32 offset argument. Line ${e.line}`),null;if(i.typeInfo.name!=="u32"&&i.typeInfo.name!=="x32")return console.error(`ExtractBits() expects an i32 count argument. Line ${e.line}`),null;const o=r.value,a=i.value;if(n instanceof p)return new p(n.data.map(l=>l>>o&(1<<a)-1),n.typeInfo);if(n.typeInfo.name!=="i32"&&n.typeInfo.name!=="x32")return console.error(`ExtractBits() expects an i32 argument. Line ${e.line}`),null;const c=n.value;return new m(c>>o&(1<<a)-1,this.getTypeInfo("i32"))}FaceForward(e,t){const n=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t),i=this.exec.evalExpression(e.args[2],t);if(n instanceof p&&r instanceof p&&i instanceof p){const o=this._dot(r.data,i.data);return new p(o<0?Array.from(n.data):n.data.map(a=>-a),n.typeInfo)}return console.error(`FaceForward() expects vector arguments. Line ${e.line}`),null}_firstLeadingBit(e){return e===0?-1:31-Math.clz32(e)}FirstLeadingBit(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof p)return new p(n.data.map(i=>this._firstLeadingBit(i)),n.typeInfo);const r=n;return new m(this._firstLeadingBit(r.value),n.typeInfo)}_firstTrailingBit(e){return e===0?-1:Math.log2(e&-e)}FirstTrailingBit(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof p)return new p(n.data.map(i=>this._firstTrailingBit(i)),n.typeInfo);const r=n;return new m(this._firstTrailingBit(r.value),n.typeInfo)}Floor(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof p)return new p(n.data.map(i=>Math.floor(i)),n.typeInfo);const r=n;return new m(Math.floor(r.value),n.typeInfo)}Fma(e,t){const n=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t),i=this.exec.evalExpression(e.args[2],t);if(n instanceof p&&r instanceof p&&i instanceof p)return n.data.length!==r.data.length||n.data.length!==i.data.length?(console.error(`Fma() expects vectors of the same length. Line ${e.line}`),null):new p(n.data.map((l,u)=>l*r.data[u]+i.data[u]),n.typeInfo);const o=n,a=r,c=i;return new m(o.value*a.value+c.value,o.typeInfo)}Fract(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof p)return new p(n.data.map(i=>i-Math.floor(i)),n.typeInfo);const r=n;return new m(r.value-Math.floor(r.value),n.typeInfo)}Frexp(e,t){return console.error(`TODO: frexp. Line ${e.line}`),null}InsertBits(e,t){const n=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t),i=this.exec.evalExpression(e.args[2],t),o=this.exec.evalExpression(e.args[3],t);if(i.typeInfo.name!=="u32"&&i.typeInfo.name!=="x32")return console.error(`InsertBits() expects an i32 offset argument. Line ${e.line}`),null;const a=i.value,c=(1<<o.value)-1<<a,l=~c;if(n instanceof p&&r instanceof p)return new p(n.data.map((f,g)=>f&l|r.data[g]<<a&c),n.typeInfo);const u=n.value,h=r.value;return new m(u&l|h<<a&c,n.typeInfo)}InverseSqrt(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof p)return new p(n.data.map(i=>1/Math.sqrt(i)),n.typeInfo);const r=n;return new m(1/Math.sqrt(r.value),n.typeInfo)}Ldexp(e,t){return console.error(`TODO: ldexp. Line ${e.line}`),null}Length(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof p){let i=0;return n.data.forEach(o=>{i+=o*o}),new m(Math.sqrt(i),this.getTypeInfo("f32"))}const r=n;return new m(Math.abs(r.value),n.typeInfo)}Log(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof p)return new p(n.data.map(i=>Math.log(i)),n.typeInfo);const r=n;return new m(Math.log(r.value),n.typeInfo)}Log2(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof p)return new p(n.data.map(i=>Math.log2(i)),n.typeInfo);const r=n;return new m(Math.log2(r.value),n.typeInfo)}Max(e,t){const n=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t);if(n instanceof p&&r instanceof p)return new p(n.data.map((a,c)=>Math.max(a,r.data[c])),n.typeInfo);const i=n,o=r;return new m(Math.max(i.value,o.value),n.typeInfo)}Min(e,t){const n=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t);if(n instanceof p&&r instanceof p)return new p(n.data.map((a,c)=>Math.min(a,r.data[c])),n.typeInfo);const i=n,o=r;return new m(Math.min(i.value,o.value),n.typeInfo)}Mix(e,t){const n=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t),i=this.exec.evalExpression(e.args[2],t);if(n instanceof p&&r instanceof p&&i instanceof p)return new p(n.data.map((c,l)=>n.data[l]*(1-i.data[l])+r.data[l]*i.data[l]),n.typeInfo);const o=r,a=i;return new m(n.value*(1-a.value)+o.value*a.value,n.typeInfo)}Modf(e,t){const n=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t);if(n instanceof p&&r instanceof p)return new p(n.data.map((o,a)=>o%r.data[a]),n.typeInfo);const i=r;return new m(n.value%i.value,n.typeInfo)}Normalize(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof p){const r=this.Length(e,t).value;return new p(n.data.map(i=>i/r),n.typeInfo)}return console.error(`Normalize() expects a vector argument. Line ${e.line}`),null}Pow(e,t){const n=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t);if(n instanceof p&&r instanceof p)return new p(n.data.map((a,c)=>Math.pow(a,r.data[c])),n.typeInfo);const i=n,o=r;return new m(Math.pow(i.value,o.value),n.typeInfo)}QuantizeToF16(e,t){const n=this.exec.evalExpression(e.args[0],t);return n instanceof p?new p(n.data.map(r=>r),n.typeInfo):new m(n.value,n.typeInfo)}Radians(e,t){const n=this.exec.evalExpression(e.args[0],t);return n instanceof p?new p(n.data.map(r=>r*Math.PI/180),n.typeInfo):new m(n.value*Math.PI/180,this.getTypeInfo("f32"))}Reflect(e,t){let n=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t);if(n instanceof p&&r instanceof p){const i=this._dot(n.data,r.data);return new p(n.data.map((o,a)=>o-2*i*r.data[a]),n.typeInfo)}return console.error(`Reflect() expects vector arguments. Line ${e.line}`),null}Refract(e,t){let n=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t),i=this.exec.evalExpression(e.args[2],t);if(n instanceof p&&r instanceof p&&i instanceof m){const o=this._dot(r.data,n.data);return new p(n.data.map((a,c)=>{const l=1-i.value*i.value*(1-o*o);if(l<0)return 0;const u=Math.sqrt(l);return i.value*a-(i.value*o+u)*r.data[c]}),n.typeInfo)}return console.error(`Refract() expects vector arguments and a scalar argument. Line ${e.line}`),null}ReverseBits(e,t){return console.error(`TODO: reverseBits. Line ${e.line}`),null}Round(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof p)return new p(n.data.map(i=>Math.round(i)),n.typeInfo);const r=n;return new m(Math.round(r.value),n.typeInfo)}Saturate(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof p)return new p(n.data.map(i=>Math.min(Math.max(i,0),1)),n.typeInfo);const r=n;return new m(Math.min(Math.max(r.value,0),1),n.typeInfo)}Sign(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof p)return new p(n.data.map(i=>Math.sign(i)),n.typeInfo);const r=n;return new m(Math.sign(r.value),n.typeInfo)}Sin(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof p)return new p(n.data.map(i=>Math.sin(i)),n.typeInfo);const r=n;return new m(Math.sin(r.value),n.typeInfo)}Sinh(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof p)return new p(n.data.map(i=>Math.sinh(i)),n.typeInfo);const r=n;return new m(Math.sinh(r.value),n.typeInfo)}_smoothstep(e,t,n){const r=Math.min(Math.max((n-e)/(t-e),0),1);return r*r*(3-2*r)}SmoothStep(e,t){const n=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t),i=this.exec.evalExpression(e.args[2],t);if(i instanceof p&&n instanceof p&&r instanceof p)return new p(i.data.map((l,u)=>this._smoothstep(n.data[u],r.data[u],l)),i.typeInfo);const o=n,a=r,c=i;return new m(this._smoothstep(o.value,a.value,c.value),i.typeInfo)}Sqrt(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof p)return new p(n.data.map(i=>Math.sqrt(i)),n.typeInfo);const r=n;return new m(Math.sqrt(r.value),n.typeInfo)}Step(e,t){const n=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t);if(r instanceof p&&n instanceof p)return new p(r.data.map((o,a)=>o<n.data[a]?0:1),r.typeInfo);const i=n;return new m(r.value<i.value?0:1,i.typeInfo)}Tan(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof p)return new p(n.data.map(i=>Math.tan(i)),n.typeInfo);const r=n;return new m(Math.tan(r.value),n.typeInfo)}Tanh(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof p)return new p(n.data.map(i=>Math.tanh(i)),n.typeInfo);const r=n;return new m(Math.tanh(r.value),n.typeInfo)}_getTransposeType(e){const t=e.getTypeName();return t==="mat2x2f"||t==="mat2x2h"?e:t==="mat2x3f"?this.getTypeInfo("mat3x2f"):t==="mat2x3h"?this.getTypeInfo("mat3x2h"):t==="mat2x4f"?this.getTypeInfo("mat4x2f"):t==="mat2x4h"?this.getTypeInfo("mat4x2h"):t==="mat3x2f"?this.getTypeInfo("mat2x3f"):t==="mat3x2h"?this.getTypeInfo("mat2x3h"):t==="mat3x3f"||t==="mat3x3h"?e:t==="mat3x4f"?this.getTypeInfo("mat4x3f"):t==="mat3x4h"?this.getTypeInfo("mat4x3h"):t==="mat4x2f"?this.getTypeInfo("mat2x4f"):t==="mat4x2h"?this.getTypeInfo("mat2x4h"):t==="mat4x3f"?this.getTypeInfo("mat3x4f"):t==="mat4x3h"?this.getTypeInfo("mat3x4h"):(t==="mat4x4f"||t==="mat4x4h"||console.error(`Invalid matrix type ${t}`),e)}Transpose(e,t){const n=this.exec.evalExpression(e.args[0],t);if(!(n instanceof k))return console.error(`Transpose() expects a matrix argument. Line ${e.line}`),null;const r=this._getTransposeType(n.typeInfo);if(n.typeInfo.name==="mat2x2"||n.typeInfo.name==="mat2x2f"||n.typeInfo.name==="mat2x2h"){const i=n.data;return new k([i[0],i[2],i[1],i[3]],r)}if(n.typeInfo.name==="mat2x3"||n.typeInfo.name==="mat2x3f"||n.typeInfo.name==="mat2x3h"){const i=n.data;return new k([i[0],i[3],i[6],i[1],i[4],i[7]],r)}if(n.typeInfo.name==="mat2x4"||n.typeInfo.name==="mat2x4f"||n.typeInfo.name==="mat2x4h"){const i=n.data;return new k([i[0],i[4],i[8],i[12],i[1],i[5],i[9],i[13]],r)}if(n.typeInfo.name==="mat3x2"||n.typeInfo.name==="mat3x2f"||n.typeInfo.name==="mat3x2h"){const i=n.data;return new k([i[0],i[3],i[1],i[4],i[2],i[5]],r)}if(n.typeInfo.name==="mat3x3"||n.typeInfo.name==="mat3x3f"||n.typeInfo.name==="mat3x3h"){const i=n.data;return new k([i[0],i[3],i[6],i[1],i[4],i[7],i[2],i[5],i[8]],r)}if(n.typeInfo.name==="mat3x4"||n.typeInfo.name==="mat3x4f"||n.typeInfo.name==="mat3x4h"){const i=n.data;return new k([i[0],i[4],i[8],i[12],i[1],i[5],i[9],i[13],i[2],i[6],i[10],i[14]],r)}if(n.typeInfo.name==="mat4x2"||n.typeInfo.name==="mat4x2f"||n.typeInfo.name==="mat4x2h"){const i=n.data;return new k([i[0],i[4],i[1],i[5],i[2],i[6]],r)}if(n.typeInfo.name==="mat4x3"||n.typeInfo.name==="mat4x3f"||n.typeInfo.name==="mat4x3h"){const i=n.data;return new k([i[0],i[4],i[8],i[1],i[5],i[9],i[2],i[6],i[10]],r)}if(n.typeInfo.name==="mat4x4"||n.typeInfo.name==="mat4x4f"||n.typeInfo.name==="mat4x4h"){const i=n.data;return new k([i[0],i[4],i[8],i[12],i[1],i[5],i[9],i[13],i[2],i[6],i[10],i[14],i[3],i[7],i[11],i[15]],r)}return console.error(`Invalid matrix type ${n.typeInfo.name}`),null}Trunc(e,t){const n=this.exec.evalExpression(e.args[0],t);if(n instanceof p)return new p(n.data.map(i=>Math.trunc(i)),n.typeInfo);const r=n;return new m(Math.trunc(r.value),n.typeInfo)}Dpdx(e,t){return console.error(`TODO: dpdx. Line ${e.line}`),null}DpdxCoarse(e,t){return console.error(`TODO: dpdxCoarse. Line ${e.line}`),null}DpdxFine(e,t){return console.error("TODO: dpdxFine"),null}Dpdy(e,t){return console.error("TODO: dpdy"),null}DpdyCoarse(e,t){return console.error("TODO: dpdyCoarse"),null}DpdyFine(e,t){return console.error("TODO: dpdyFine"),null}Fwidth(e,t){return console.error("TODO: fwidth"),null}FwidthCoarse(e,t){return console.error("TODO: fwidthCoarse"),null}FwidthFine(e,t){return console.error("TODO: fwidthFine"),null}TextureDimensions(e,t){const n=e.args[0],r=e.args.length>1?this.exec.evalExpression(e.args[1],t).value:0;if(n instanceof _e){const i=n.name,o=t.getVariableValue(i);if(o instanceof Be){if(r<0||r>=o.mipLevelCount)return console.error(`Invalid mip level for textureDimensions. Line ${e.line}`),null;const a=o.getMipLevelSize(r),c=o.dimension;return c==="1d"?new m(a[0],this.getTypeInfo("u32")):c==="3d"?new p(a,this.getTypeInfo("vec3u")):c==="2d"?new p(a.slice(0,2),this.getTypeInfo("vec2u")):(console.error(`Invalid texture dimension ${c} not found. Line ${e.line}`),null)}return console.error(`Texture ${i} not found. Line ${e.line}`),null}return console.error(`Invalid texture argument for textureDimensions. Line ${e.line}`),null}TextureGather(e,t){return console.error("TODO: textureGather"),null}TextureGatherCompare(e,t){return console.error("TODO: textureGatherCompare"),null}TextureLoad(e,t){const n=e.args[0],r=this.exec.evalExpression(e.args[1],t),i=e.args.length>2?this.exec.evalExpression(e.args[2],t).value:0;if(!(r instanceof p)||r.data.length!==2)return console.error(`Invalid UV argument for textureLoad. Line ${e.line}`),null;if(n instanceof _e){const o=n.name,a=t.getVariableValue(o);if(a instanceof Be){const c=Math.floor(r.data[0]),l=Math.floor(r.data[1]);if(c<0||c>=a.width||l<0||l>=a.height)return console.error(`Texture ${o} out of bounds. Line ${e.line}`),null;const u=a.getPixel(c,l,0,i);return u===null?(console.error(`Invalid texture format for textureLoad. Line ${e.line}`),null):new p(u,this.getTypeInfo("vec4f"))}return console.error(`Texture ${o} not found. Line ${e.line}`),null}return console.error(`Invalid texture argument for textureLoad. Line ${e.line}`),null}TextureNumLayers(e,t){const n=e.args[0];if(n instanceof _e){const r=n.name,i=t.getVariableValue(r);return i instanceof Be?new m(i.depthOrArrayLayers,this.getTypeInfo("u32")):(console.error(`Texture ${r} not found. Line ${e.line}`),null)}return console.error(`Invalid texture argument for textureNumLayers. Line ${e.line}`),null}TextureNumLevels(e,t){const n=e.args[0];if(n instanceof _e){const r=n.name,i=t.getVariableValue(r);return i instanceof Be?new m(i.mipLevelCount,this.getTypeInfo("u32")):(console.error(`Texture ${r} not found. Line ${e.line}`),null)}return console.error(`Invalid texture argument for textureNumLevels. Line ${e.line}`),null}TextureNumSamples(e,t){const n=e.args[0];if(n instanceof _e){const r=n.name,i=t.getVariableValue(r);return i instanceof Be?new m(i.sampleCount,this.getTypeInfo("u32")):(console.error(`Texture ${r} not found. Line ${e.line}`),null)}return console.error(`Invalid texture argument for textureNumSamples. Line ${e.line}`),null}TextureSample(e,t){return console.error("TODO: textureSample"),null}TextureSampleBias(e,t){return console.error("TODO: textureSampleBias"),null}TextureSampleCompare(e,t){return console.error("TODO: textureSampleCompare"),null}TextureSampleCompareLevel(e,t){return console.error("TODO: textureSampleCompareLevel"),null}TextureSampleGrad(e,t){return console.error("TODO: textureSampleGrad"),null}TextureSampleLevel(e,t){return console.error("TODO: textureSampleLevel"),null}TextureSampleBaseClampToEdge(e,t){return console.error("TODO: textureSampleBaseClampToEdge"),null}TextureStore(e,t){const n=e.args[0],r=this.exec.evalExpression(e.args[1],t),i=e.args.length===4?this.exec.evalExpression(e.args[2],t).value:0,o=e.args.length===4?this.exec.evalExpression(e.args[3],t).data:this.exec.evalExpression(e.args[2],t).data;if(o.length!==4)return console.error(`Invalid value argument for textureStore. Line ${e.line}`),null;if(!(r instanceof p)||r.data.length!==2)return console.error(`Invalid UV argument for textureStore. Line ${e.line}`),null;if(n instanceof _e){const a=n.name,c=t.getVariableValue(a);if(c instanceof Be){const l=c.getMipLevelSize(0),u=Math.floor(r.data[0]),h=Math.floor(r.data[1]);return u<0||u>=l[0]||h<0||h>=l[1]?(console.error(`Texture ${a} out of bounds. Line ${e.line}`),null):(c.setPixel(u,h,0,i,Array.from(o)),null)}return console.error(`Texture ${a} not found. Line ${e.line}`),null}return console.error(`Invalid texture argument for textureStore. Line ${e.line}`),null}AtomicLoad(e,t){let n=e.args[0];n instanceof se&&(n=n.right);const r=this.exec.getVariableName(n,t);return t.getVariable(r).value.getSubData(this.exec,n.postfix,t)}AtomicStore(e,t){let n=e.args[0];n instanceof se&&(n=n.right);const r=this.exec.getVariableName(n,t),i=t.getVariable(r);let o=e.args[1];const a=this.exec.evalExpression(o,t),c=i.value.getSubData(this.exec,n.postfix,t);return c instanceof m&&a instanceof m&&(c.value=a.value),i.value instanceof G&&i.value.setDataValue(this.exec,c,n.postfix,t),null}AtomicAdd(e,t){let n=e.args[0];n instanceof se&&(n=n.right);const r=this.exec.getVariableName(n,t),i=t.getVariable(r);let o=e.args[1];const a=this.exec.evalExpression(o,t),c=i.value.getSubData(this.exec,n.postfix,t),l=new m(c.value,c.typeInfo);return c instanceof m&&a instanceof m&&(c.value+=a.value),i.value instanceof G&&i.value.setDataValue(this.exec,c,n.postfix,t),l}AtomicSub(e,t){let n=e.args[0];n instanceof se&&(n=n.right);const r=this.exec.getVariableName(n,t),i=t.getVariable(r);let o=e.args[1];const a=this.exec.evalExpression(o,t),c=i.value.getSubData(this.exec,n.postfix,t),l=new m(c.value,c.typeInfo);return c instanceof m&&a instanceof m&&(c.value-=a.value),i.value instanceof G&&i.value.setDataValue(this.exec,c,n.postfix,t),l}AtomicMax(e,t){let n=e.args[0];n instanceof se&&(n=n.right);const r=this.exec.getVariableName(n,t),i=t.getVariable(r);let o=e.args[1];const a=this.exec.evalExpression(o,t),c=i.value.getSubData(this.exec,n.postfix,t),l=new m(c.value,c.typeInfo);return c instanceof m&&a instanceof m&&(c.value=Math.max(c.value,a.value)),i.value instanceof G&&i.value.setDataValue(this.exec,c,n.postfix,t),l}AtomicMin(e,t){let n=e.args[0];n instanceof se&&(n=n.right);const r=this.exec.getVariableName(n,t),i=t.getVariable(r);let o=e.args[1];const a=this.exec.evalExpression(o,t),c=i.value.getSubData(this.exec,n.postfix,t),l=new m(c.value,c.typeInfo);return c instanceof m&&a instanceof m&&(c.value=Math.min(c.value,a.value)),i.value instanceof G&&i.value.setDataValue(this.exec,c,n.postfix,t),l}AtomicAnd(e,t){let n=e.args[0];n instanceof se&&(n=n.right);const r=this.exec.getVariableName(n,t),i=t.getVariable(r);let o=e.args[1];const a=this.exec.evalExpression(o,t),c=i.value.getSubData(this.exec,n.postfix,t),l=new m(c.value,c.typeInfo);return c instanceof m&&a instanceof m&&(c.value=c.value&a.value),i.value instanceof G&&i.value.setDataValue(this.exec,c,n.postfix,t),l}AtomicOr(e,t){let n=e.args[0];n instanceof se&&(n=n.right);const r=this.exec.getVariableName(n,t),i=t.getVariable(r);let o=e.args[1];const a=this.exec.evalExpression(o,t),c=i.value.getSubData(this.exec,n.postfix,t),l=new m(c.value,c.typeInfo);return c instanceof m&&a instanceof m&&(c.value=c.value|a.value),i.value instanceof G&&i.value.setDataValue(this.exec,c,n.postfix,t),l}AtomicXor(e,t){let n=e.args[0];n instanceof se&&(n=n.right);const r=this.exec.getVariableName(n,t),i=t.getVariable(r);let o=e.args[1];const a=this.exec.evalExpression(o,t),c=i.value.getSubData(this.exec,n.postfix,t),l=new m(c.value,c.typeInfo);return c instanceof m&&a instanceof m&&(c.value=c.value^a.value),i.value instanceof G&&i.value.setDataValue(this.exec,c,n.postfix,t),l}AtomicExchange(e,t){let n=e.args[0];n instanceof se&&(n=n.right);const r=this.exec.getVariableName(n,t),i=t.getVariable(r);let o=e.args[1];const a=this.exec.evalExpression(o,t),c=i.value.getSubData(this.exec,n.postfix,t),l=new m(c.value,c.typeInfo);return c instanceof m&&a instanceof m&&(c.value=a.value),i.value instanceof G&&i.value.setDataValue(this.exec,c,n.postfix,t),l}AtomicCompareExchangeWeak(e,t){return console.error("TODO: atomicCompareExchangeWeak"),null}Pack4x8snorm(e,t){return console.error("TODO: pack4x8snorm"),null}Pack4x8unorm(e,t){return console.error("TODO: pack4x8unorm"),null}Pack4xI8(e,t){return console.error("TODO: pack4xI8"),null}Pack4xU8(e,t){return console.error("TODO: pack4xU8"),null}Pack4x8Clamp(e,t){return console.error("TODO: pack4x8Clamp"),null}Pack4xU8Clamp(e,t){return console.error("TODO: pack4xU8Clamp"),null}Pack2x16snorm(e,t){return console.error("TODO: pack2x16snorm"),null}Pack2x16unorm(e,t){return console.error("TODO: pack2x16unorm"),null}Pack2x16float(e,t){return console.error("TODO: pack2x16float"),null}Unpack4x8snorm(e,t){return console.error("TODO: unpack4x8snorm"),null}Unpack4x8unorm(e,t){return console.error("TODO: unpack4x8unorm"),null}Unpack4xI8(e,t){return console.error("TODO: unpack4xI8"),null}Unpack4xU8(e,t){return console.error("TODO: unpack4xU8"),null}Unpack2x16snorm(e,t){return console.error("TODO: unpack2x16snorm"),null}Unpack2x16unorm(e,t){return console.error("TODO: unpack2x16unorm"),null}Unpack2x16float(e,t){return console.error("TODO: unpack2x16float"),null}StorageBarrier(e,t){return null}TextureBarrier(e,t){return null}WorkgroupBarrier(e,t){return null}WorkgroupUniformLoad(e,t){return null}SubgroupAdd(e,t){return console.error("TODO: subgroupAdd"),null}SubgroupExclusiveAdd(e,t){return console.error("TODO: subgroupExclusiveAdd"),null}SubgroupInclusiveAdd(e,t){return console.error("TODO: subgroupInclusiveAdd"),null}SubgroupAll(e,t){return console.error("TODO: subgroupAll"),null}SubgroupAnd(e,t){return console.error("TODO: subgroupAnd"),null}SubgroupAny(e,t){return console.error("TODO: subgroupAny"),null}SubgroupBallot(e,t){return console.error("TODO: subgroupBallot"),null}SubgroupBroadcast(e,t){return console.error("TODO: subgroupBroadcast"),null}SubgroupBroadcastFirst(e,t){return console.error("TODO: subgroupBroadcastFirst"),null}SubgroupElect(e,t){return console.error("TODO: subgroupElect"),null}SubgroupMax(e,t){return console.error("TODO: subgroupMax"),null}SubgroupMin(e,t){return console.error("TODO: subgroupMin"),null}SubgroupMul(e,t){return console.error("TODO: subgroupMul"),null}SubgroupExclusiveMul(e,t){return console.error("TODO: subgroupExclusiveMul"),null}SubgroupInclusiveMul(e,t){return console.error("TODO: subgroupInclusiveMul"),null}SubgroupOr(e,t){return console.error("TODO: subgroupOr"),null}SubgroupShuffle(e,t){return console.error("TODO: subgroupShuffle"),null}SubgroupShuffleDown(e,t){return console.error("TODO: subgroupShuffleDown"),null}SubgroupShuffleUp(e,t){return console.error("TODO: subgroupShuffleUp"),null}SubgroupShuffleXor(e,t){return console.error("TODO: subgroupShuffleXor"),null}SubgroupXor(e,t){return console.error("TODO: subgroupXor"),null}QuadBroadcast(e,t){return console.error("TODO: quadBroadcast"),null}QuadSwapDiagonal(e,t){return console.error("TODO: quadSwapDiagonal"),null}QuadSwapX(e,t){return console.error("TODO: quadSwapX"),null}QuadSwapY(e,t){return console.error("TODO: quadSwapY"),null}}const Sn={vec2:2,vec2f:2,vec2i:2,vec2u:2,vec2b:2,vec2h:2,vec3:3,vec3f:3,vec3i:3,vec3u:3,vec3b:3,vec3h:3,vec4:4,vec4f:4,vec4i:4,vec4u:4,vec4b:4,vec4h:4},he={mat2x2:[2,2,4],mat2x2f:[2,2,4],mat2x2h:[2,2,4],mat2x3:[2,3,6],mat2x3f:[2,3,6],mat2x3h:[2,3,6],mat2x4:[2,4,8],mat2x4f:[2,4,8],mat2x4h:[2,4,8],mat3x2:[3,2,6],mat3x2f:[3,2,6],mat3x2h:[3,2,6],mat3x3:[3,3,9],mat3x3f:[3,3,9],mat3x3h:[3,3,9],mat3x4:[3,4,12],mat3x4f:[3,4,12],mat3x4h:[3,4,12],mat4x2:[4,2,8],mat4x2f:[4,2,8],mat4x2h:[4,2,8],mat4x3:[4,3,12],mat4x3f:[4,3,12],mat4x3h:[4,3,12],mat4x4:[4,4,16],mat4x4f:[4,4,16],mat4x4h:[4,4,16]};class le extends Gd{constructor(e,t){var n;super(),this.ast=e??[],this.reflection=new ke,this.reflection.updateAST(this.ast),this.context=(n=t?.clone())!==null&&n!==void 0?n:new qr,this.builtins=new ep(this),this.typeInfo={bool:this.getTypeInfo(R.bool),i32:this.getTypeInfo(R.i32),u32:this.getTypeInfo(R.u32),f32:this.getTypeInfo(R.f32),f16:this.getTypeInfo(R.f16),vec2f:this.getTypeInfo(T.vec2f),vec2u:this.getTypeInfo(T.vec2u),vec2i:this.getTypeInfo(T.vec2i),vec2h:this.getTypeInfo(T.vec2h),vec3f:this.getTypeInfo(T.vec3f),vec3u:this.getTypeInfo(T.vec3u),vec3i:this.getTypeInfo(T.vec3i),vec3h:this.getTypeInfo(T.vec3h),vec4f:this.getTypeInfo(T.vec4f),vec4u:this.getTypeInfo(T.vec4u),vec4i:this.getTypeInfo(T.vec4i),vec4h:this.getTypeInfo(T.vec4h),mat2x2f:this.getTypeInfo(T.mat2x2f),mat2x3f:this.getTypeInfo(T.mat2x3f),mat2x4f:this.getTypeInfo(T.mat2x4f),mat3x2f:this.getTypeInfo(T.mat3x2f),mat3x3f:this.getTypeInfo(T.mat3x3f),mat3x4f:this.getTypeInfo(T.mat3x4f),mat4x2f:this.getTypeInfo(T.mat4x2f),mat4x3f:this.getTypeInfo(T.mat4x3f),mat4x4f:this.getTypeInfo(T.mat4x4f)}}getVariableValue(e){var t,n;const r=(n=(t=this.context.getVariable(e))===null||t===void 0?void 0:t.value)!==null&&n!==void 0?n:null;if(r===null)return null;if(r instanceof m)return r.value;if(r instanceof p||r instanceof k)return Array.from(r.data);if(r instanceof G&&r.typeInfo instanceof Ze){if(r.typeInfo.format.name==="u32")return Array.from(new Uint32Array(r.buffer,r.offset,r.typeInfo.count));if(r.typeInfo.format.name==="i32")return Array.from(new Int32Array(r.buffer,r.offset,r.typeInfo.count));if(r.typeInfo.format.name==="f32")return Array.from(new Float32Array(r.buffer,r.offset,r.typeInfo.count))}return console.error(`Unsupported return variable type ${r.typeInfo.name}`),null}execute(e){(e=e??{}).constants&&this._setOverrides(e.constants,this.context),this._execStatements(this.ast,this.context)}dispatchWorkgroups(e,t,n,r){const i=this.context.clone();(r=r??{}).constants&&this._setOverrides(r.constants,i),this._execStatements(this.ast,i);const o=i.getFunction(e);if(!o)return void console.error(`Function ${e} not found`);if(typeof t=="number")t=[t,1,1];else{if(t.length===0)return void console.error("Invalid dispatch count");t.length===1?t=[t[0],1,1]:t.length===2?t=[t[0],t[1],1]:t.length>3&&(t=[t[0],t[1],t[2]])}const a=t[0],c=t[1],l=t[2],u=this.getTypeInfo("vec3u");i.setVariable("@num_workgroups",new p(t,u));const h=this.reflection.getFunctionInfo(e);h===null&&console.error(`Function ${e} not found in reflection data`);for(const f in n)for(const g in n[f]){const _=n[f][g];i.variables.forEach(w=>{var A;const S=w.node;if(S?.attributes){let I=null,x=null;for(const E of S.attributes)E.name==="binding"?I=E.value:E.name==="group"&&(x=E.value);if(g==I&&f==x){let E=!1;for(const P of h.resources)if(P.name===w.name&&P.group===parseInt(f)&&P.binding===parseInt(g)){E=!0;break}if(E)if(_.texture!==void 0&&_.descriptor!==void 0){const P=new Be(_.texture,this.getTypeInfo(S.type),_.descriptor,(A=_.texture.view)!==null&&A!==void 0?A:null);w.value=P}else _.uniform!==void 0?w.value=new G(_.uniform,this.getTypeInfo(S.type)):w.value=new G(_,this.getTypeInfo(S.type))}}})}for(let f=0;f<l;++f)for(let g=0;g<c;++g)for(let _=0;_<a;++_)i.setVariable("@workgroup_id",new p([_,g,f],this.getTypeInfo("vec3u"))),this._dispatchWorkgroup(o,[_,g,f],i)}execStatement(e,t){if(e instanceof cc)return this.evalExpression(e.value,t);if(e instanceof uc){if(e.condition){const n=this.evalExpression(e.condition,t);if(!(n instanceof m))throw new Error("Invalid break-if condition");if(!n.value)return null}return le._breakObj}if(e instanceof hc)return le._continueObj;if(e instanceof Qt)this._let(e,t);else if(e instanceof Ue)this._var(e,t);else if(e instanceof Rs)this._const(e,t);else if(e instanceof ns)this._function(e,t);else{if(e instanceof ac)return this._if(e,t);if(e instanceof oc)return this._switch(e,t);if(e instanceof sc)return this._for(e,t);if(e instanceof tc)return this._while(e,t);if(e instanceof ic)return this._loop(e,t);if(e instanceof tr){const n=t.clone();return n.currentFunctionName=t.currentFunctionName,this._execStatements(e.body,n)}if(e instanceof rc)this._assign(e,t);else if(e instanceof nc)this._increment(e,t);else{if(e instanceof Fe)return null;if(e instanceof $r){const n=e.name;t.getVariable(n)===null&&t.setVariable(n,new m(0,this.getTypeInfo("u32")))}else if(e instanceof Wr)this._call(e,t);else{if(e instanceof lc||e instanceof jr)return null;console.error("Invalid statement type.",e,`Line ${e.line}`)}}}return null}evalExpression(e,t){return e instanceof Ee?this._evalBinaryOp(e,t):e instanceof re?this._evalLiteral(e,t):e instanceof _e?this._evalVariable(e,t):e instanceof Hr?this._evalCall(e,t):e instanceof Me?this._evalCreate(e,t):e instanceof fc?this._evalConst(e,t):e instanceof dc?this._evalBitcast(e,t):e instanceof se?this._evalUnaryOp(e,t):(console.error("Invalid expression type",e,`Line ${e.line}`),null)}getTypeInfo(e){var t;if(e instanceof R){const r=this.reflection.getTypeInfo(e);if(r!==null)return r}let n=(t=this.typeInfo[e])!==null&&t!==void 0?t:null;return n!==null||(n=this.reflection.getTypeInfoByName(e)),n}_setOverrides(e,t){for(const n in e){const r=e[n],i=this.reflection.getOverrideInfo(n);i!==null?(i.type===null&&(i.type=this.getTypeInfo("u32")),i.type.name==="u32"||i.type.name==="i32"||i.type.name==="f32"||i.type.name==="f16"?t.setVariable(n,new m(r,i.type)):i.type.name==="bool"?t.setVariable(n,new m(r?1:0,i.type)):i.type.name==="vec2"||i.type.name==="vec3"||i.type.name==="vec4"||i.type.name==="vec2f"||i.type.name==="vec3f"||i.type.name==="vec4f"||i.type.name==="vec2i"||i.type.name==="vec3i"||i.type.name==="vec4i"||i.type.name==="vec2u"||i.type.name==="vec3u"||i.type.name==="vec4u"||i.type.name==="vec2h"||i.type.name==="vec3h"||i.type.name==="vec4h"?t.setVariable(n,new p(r,i.type)):console.error(`Invalid constant type for ${n}`)):console.error(`Override ${n} does not exist in the shader.`)}}_dispatchWorkgroup(e,t,n){const r=[1,1,1];for(const u of e.node.attributes)if(u.name==="workgroup_size"){if(u.value.length>0){const h=n.getVariableValue(u.value[0]);r[0]=h instanceof m?h.value:parseInt(u.value[0])}if(u.value.length>1){const h=n.getVariableValue(u.value[1]);r[1]=h instanceof m?h.value:parseInt(u.value[1])}if(u.value.length>2){const h=n.getVariableValue(u.value[2]);r[2]=h instanceof m?h.value:parseInt(u.value[2])}}const i=this.getTypeInfo("vec3u"),o=this.getTypeInfo("u32");n.setVariable("@workgroup_size",new p(r,i));const a=r[0],c=r[1],l=r[2];for(let u=0,h=0;u<l;++u)for(let f=0;f<c;++f)for(let g=0;g<a;++g,++h){const _=[g,f,u],w=[g+t[0]*r[0],f+t[1]*r[1],u+t[2]*r[2]];n.setVariable("@local_invocation_id",new p(_,i)),n.setVariable("@global_invocation_id",new p(w,i)),n.setVariable("@local_invocation_index",new m(h,o)),this._dispatchExec(e,n)}}_dispatchExec(e,t){for(const n of e.node.args)for(const r of n.attributes)if(r.name==="builtin"){const i=`@${r.value}`,o=t.getVariable(i);o!==void 0&&t.variables.set(n.name,o)}this._execStatements(e.node.body,t)}getVariableName(e,t){for(;e instanceof se;)e=e.right;return e instanceof _e?e.name:(console.error("Unknown variable type",e,"Line",e.line),null)}_execStatements(e,t){for(const n of e){if(n instanceof Array){const i=t.clone(),o=this._execStatements(n,i);if(o)return o;continue}const r=this.execStatement(n,t);if(r)return r}return null}_call(e,t){const n=t.clone();n.currentFunctionName=e.name;const r=t.getFunction(e.name);if(r){for(let i=0;i<r.node.args.length;++i){const o=r.node.args[i],a=this.evalExpression(e.args[i],n);n.setVariable(o.name,a,o)}this._execStatements(r.node.body,n)}else e.isBuiltin?this._callBuiltinFunction(e,n):this.getTypeInfo(e.name)&&this._evalCreate(e,t)}_increment(e,t){const n=this.getVariableName(e.variable,t),r=t.getVariable(n);r?e.operator==="++"?r.value instanceof m?r.value.value++:console.error(`Variable ${n} is not a scalar. Line ${e.line}`):e.operator==="--"?r.value instanceof m?r.value.value--:console.error(`Variable ${n} is not a scalar. Line ${e.line}`):console.error(`Unknown increment operator ${e.operator}. Line ${e.line}`):console.error(`Variable ${n} not found. Line ${e.line}`)}_getVariableData(e,t){if(e instanceof _e){const n=this.getVariableName(e,t),r=t.getVariable(n);return r===null?(console.error(`Variable ${n} not found. Line ${e.line}`),null):r.value.getSubData(this,e.postfix,t)}if(e instanceof se){if(e.operator==="*"){const n=this._getVariableData(e.right,t);return n instanceof mt?n.reference.getSubData(this,e.postfix,t):(console.error(`Variable ${e.right} is not a pointer. Line ${e.line}`),null)}if(e.operator==="&"){const n=this._getVariableData(e.right,t);return new mt(n)}}return null}_assign(e,t){let n=null,r="<var>",i=null;if(e.variable instanceof se){const c=this._getVariableData(e.variable,t),l=this.evalExpression(e.value,t),u=e.operator;if(u==="="){if(c instanceof m||c instanceof p||c instanceof k){if(l instanceof m||l instanceof p||l instanceof k&&c.data.length===l.data.length)return void c.data.set(l.data);console.error(`Invalid assignment. Line ${e.line}`)}else if(c instanceof G&&l instanceof G&&c.buffer.byteLength-c.offset>=l.buffer.byteLength-l.offset)return void(c.buffer.byteLength%4==0?new Uint32Array(c.buffer,c.offset,c.typeInfo.size/4).set(new Uint32Array(l.buffer,l.offset,l.typeInfo.size/4)):new Uint8Array(c.buffer,c.offset,c.typeInfo.size).set(new Uint8Array(l.buffer,l.offset,l.typeInfo.size)));return console.error(`Invalid assignment. Line ${e.line}`),null}if(u==="+=")return c instanceof m||c instanceof p||c instanceof k?l instanceof m||l instanceof p||l instanceof k?void c.data.set(l.data.map((h,f)=>c.data[f]+h)):void console.error(`Invalid assignment . Line ${e.line}`):void console.error(`Invalid assignment. Line ${e.line}`);if(u==="-=")return(c instanceof m||c instanceof p||c instanceof k)&&(l instanceof m||l instanceof p||l instanceof k)?void c.data.set(l.data.map((h,f)=>c.data[f]-h)):void console.error(`Invalid assignment. Line ${e.line}`)}if(e.variable instanceof se){if(e.variable.operator==="*"){r=this.getVariableName(e.variable.right,t);const c=t.getVariable(r);if(!(c&&c.value instanceof mt))return void console.error(`Variable ${r} is not a pointer. Line ${e.line}`);n=c.value.reference;let l=e.variable.postfix;if(!l){let u=e.variable.right;for(;u instanceof se;){if(u.postfix){l=u.postfix;break}u=u.right}}l&&(n=n.getSubData(this,l,t))}}else{i=e.variable.postfix,r=this.getVariableName(e.variable,t);const c=t.getVariable(r);if(c===null)return void console.error(`Variable ${r} not found. Line ${e.line}`);n=c.value}if(n instanceof mt&&(n=n.reference),n===null)return void console.error(`Variable ${r} not found. Line ${e.line}`);const o=this.evalExpression(e.value,t),a=e.operator;if(a!=="="){const c=n.getSubData(this,i,t);if(c instanceof p&&o instanceof m){const l=c.data,u=o.value;if(a==="+=")for(let h=0;h<l.length;++h)l[h]+=u;else if(a==="-=")for(let h=0;h<l.length;++h)l[h]-=u;else if(a==="*=")for(let h=0;h<l.length;++h)l[h]*=u;else if(a==="/=")for(let h=0;h<l.length;++h)l[h]/=u;else if(a==="%=")for(let h=0;h<l.length;++h)l[h]%=u;else if(a==="&=")for(let h=0;h<l.length;++h)l[h]&=u;else if(a==="|=")for(let h=0;h<l.length;++h)l[h]|=u;else if(a==="^=")for(let h=0;h<l.length;++h)l[h]^=u;else if(a==="<<=")for(let h=0;h<l.length;++h)l[h]<<=u;else if(a===">>=")for(let h=0;h<l.length;++h)l[h]>>=u;else console.error(`Invalid operator ${a}. Line ${e.line}`)}else if(c instanceof p&&o instanceof p){const l=c.data,u=o.data;if(l.length!==u.length)return void console.error(`Vector length mismatch. Line ${e.line}`);if(a==="+=")for(let h=0;h<l.length;++h)l[h]+=u[h];else if(a==="-=")for(let h=0;h<l.length;++h)l[h]-=u[h];else if(a==="*=")for(let h=0;h<l.length;++h)l[h]*=u[h];else if(a==="/=")for(let h=0;h<l.length;++h)l[h]/=u[h];else if(a==="%=")for(let h=0;h<l.length;++h)l[h]%=u[h];else if(a==="&=")for(let h=0;h<l.length;++h)l[h]&=u[h];else if(a==="|=")for(let h=0;h<l.length;++h)l[h]|=u[h];else if(a==="^=")for(let h=0;h<l.length;++h)l[h]^=u[h];else if(a==="<<=")for(let h=0;h<l.length;++h)l[h]<<=u[h];else if(a===">>=")for(let h=0;h<l.length;++h)l[h]>>=u[h];else console.error(`Invalid operator ${a}. Line ${e.line}`)}else{if(!(c instanceof m&&o instanceof m))return void console.error(`Invalid type for ${e.operator} operator. Line ${e.line}`);a==="+="?c.value+=o.value:a==="-="?c.value-=o.value:a==="*="?c.value*=o.value:a==="/="?c.value/=o.value:a==="%="?c.value%=o.value:a==="&="?c.value&=o.value:a==="|="?c.value|=o.value:a==="^="?c.value^=o.value:a==="<<="?c.value<<=o.value:a===">>="?c.value>>=o.value:console.error(`Invalid operator ${a}. Line ${e.line}`)}return void(n instanceof G&&n.setDataValue(this,c,i,t))}if(n instanceof G)n.setDataValue(this,o,i,t);else if(i){if(!(n instanceof p||n instanceof k))return void console.error(`Variable ${r} is not a vector or matrix. Line ${e.line}`);if(i instanceof Mt){const c=this.evalExpression(i.index,t).value;if(n instanceof p){if(!(o instanceof m))return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);n.data[c]=o.value}else{if(!(n instanceof k))return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);{const l=this.evalExpression(i.index,t).value;if(l<0)return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);if(!(o instanceof p))return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);{const u=n.typeInfo.getTypeName();if(u==="mat2x2"||u==="mat2x2f"||u==="mat2x2h"){if(!(l<2&&o.data.length===2))return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);n.data[2*l]=o.data[0],n.data[2*l+1]=o.data[1]}else if(u==="mat2x3"||u==="mat2x3f"||u==="mat2x3h"){if(!(l<2&&o.data.length===3))return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);n.data[3*l]=o.data[0],n.data[3*l+1]=o.data[1],n.data[3*l+2]=o.data[2]}else if(u==="mat2x4"||u==="mat2x4f"||u==="mat2x4h"){if(!(l<2&&o.data.length===4))return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);n.data[4*l]=o.data[0],n.data[4*l+1]=o.data[1],n.data[4*l+2]=o.data[2],n.data[4*l+3]=o.data[3]}else if(u==="mat3x2"||u==="mat3x2f"||u==="mat3x2h"){if(!(l<3&&o.data.length===2))return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);n.data[2*l]=o.data[0],n.data[2*l+1]=o.data[1]}else if(u==="mat3x3"||u==="mat3x3f"||u==="mat3x3h"){if(!(l<3&&o.data.length===3))return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);n.data[3*l]=o.data[0],n.data[3*l+1]=o.data[1],n.data[3*l+2]=o.data[2]}else if(u==="mat3x4"||u==="mat3x4f"||u==="mat3x4h"){if(!(l<3&&o.data.length===4))return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);n.data[4*l]=o.data[0],n.data[4*l+1]=o.data[1],n.data[4*l+2]=o.data[2],n.data[4*l+3]=o.data[3]}else if(u==="mat4x2"||u==="mat4x2f"||u==="mat4x2h"){if(!(l<4&&o.data.length===2))return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);n.data[2*l]=o.data[0],n.data[2*l+1]=o.data[1]}else if(u==="mat4x3"||u==="mat4x3f"||u==="mat4x3h"){if(!(l<4&&o.data.length===3))return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);n.data[3*l]=o.data[0],n.data[3*l+1]=o.data[1],n.data[3*l+2]=o.data[2]}else{if(u!=="mat4x4"&&u!=="mat4x4f"&&u!=="mat4x4h")return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);if(!(l<4&&o.data.length===4))return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);n.data[4*l]=o.data[0],n.data[4*l+1]=o.data[1],n.data[4*l+2]=o.data[2],n.data[4*l+3]=o.data[3]}}}}}else if(i instanceof lt){const c=i.value;if(!(n instanceof p))return void console.error(`Invalid assignment to ${c}. Variable ${r} is not a vector. Line ${e.line}`);if(o instanceof m){if(c.length>1)return void console.error(`Invalid assignment to ${c} for variable ${r}. Line ${e.line}`);if(c==="x")n.data[0]=o.value;else if(c==="y"){if(n.data.length<2)return void console.error(`Invalid assignment to ${c} for variable ${r}. Line ${e.line}`);n.data[1]=o.value}else if(c==="z"){if(n.data.length<3)return void console.error(`Invalid assignment to ${c} for variable ${r}. Line ${e.line}`);n.data[2]=o.value}else if(c==="w"){if(n.data.length<4)return void console.error(`Invalid assignment to ${c} for variable ${r}. Line ${e.line}`);n.data[3]=o.value}}else{if(!(o instanceof p))return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);if(c.length!==o.data.length)return void console.error(`Invalid assignment to ${c} for variable ${r}. Line ${e.line}`);for(let l=0;l<c.length;++l){const u=c[l];if(u==="x"||u==="r")n.data[0]=o.data[l];else if(u==="y"||u==="g"){if(o.data.length<2)return void console.error(`Invalid assignment to ${u} for variable ${r}. Line ${e.line}`);n.data[1]=o.data[l]}else if(u==="z"||u==="b"){if(o.data.length<3)return void console.error(`Invalid assignment to ${u} for variable ${r}. Line ${e.line}`);n.data[2]=o.data[l]}else{if(u!=="w"&&u!=="a")return void console.error(`Invalid assignment to ${u} for variable ${r}. Line ${e.line}`);if(o.data.length<4)return void console.error(`Invalid assignment to ${u} for variable ${r}. Line ${e.line}`);n.data[3]=o.data[l]}}}}}else n instanceof m&&o instanceof m?n.value=o.value:n instanceof p&&o instanceof p||n instanceof k&&o instanceof k?n.data.set(o.data):console.error(`Invalid assignment to ${r}. Line ${e.line}`)}_function(e,t){const n=new Yr(e);t.functions.set(e.name,n)}_const(e,t){let n=null;e.value!==null&&(n=this.evalExpression(e.value,t)),t.createVariable(e.name,n,e)}_let(e,t){let n=null;if(e.value!==null){if(n=this.evalExpression(e.value,t),n===null)return void console.error(`Invalid value for variable ${e.name}. Line ${e.line}`);e.value instanceof se||(n=n.clone())}else{const r=e.type.name;if(r==="f32"||r==="i32"||r==="u32"||r==="bool"||r==="f16"||r==="vec2"||r==="vec3"||r==="vec4"||r==="vec2f"||r==="vec3f"||r==="vec4f"||r==="vec2i"||r==="vec3i"||r==="vec4i"||r==="vec2u"||r==="vec3u"||r==="vec4u"||r==="vec2h"||r==="vec3h"||r==="vec4h"||r==="vec2b"||r==="vec3b"||r==="vec4b"||r==="mat2x2"||r==="mat2x3"||r==="mat2x4"||r==="mat3x2"||r==="mat3x3"||r==="mat3x4"||r==="mat4x2"||r==="mat4x3"||r==="mat4x4"||r==="mat2x2f"||r==="mat2x3f"||r==="mat2x4f"||r==="mat3x2f"||r==="mat3x3f"||r==="mat3x4f"||r==="mat4x2f"||r==="mat4x3f"||r==="mat4x4f"||r==="mat2x2h"||r==="mat2x3h"||r==="mat2x4h"||r==="mat3x2h"||r==="mat3x3h"||r==="mat3x4h"||r==="mat4x2h"||r==="mat4x3h"||r==="mat4x4h"||r==="array"){const i=new Me(e.type,[]);n=this._evalCreate(i,t)}}t.createVariable(e.name,n,e)}_var(e,t){let n=null;if(e.value!==null){if(n=this.evalExpression(e.value,t),n===null)return void console.error(`Invalid value for variable ${e.name}. Line ${e.line}`);e.value instanceof se||(n=n.clone())}else{if(e.type===null)return void console.error(`Variable ${e.name} has no type. Line ${e.line}`);const r=e.type.name;if(r==="f32"||r==="i32"||r==="u32"||r==="bool"||r==="f16"||r==="vec2"||r==="vec3"||r==="vec4"||r==="vec2f"||r==="vec3f"||r==="vec4f"||r==="vec2i"||r==="vec3i"||r==="vec4i"||r==="vec2u"||r==="vec3u"||r==="vec4u"||r==="vec2h"||r==="vec3h"||r==="vec4h"||r==="vec2b"||r==="vec3b"||r==="vec4b"||r==="mat2x2"||r==="mat2x3"||r==="mat2x4"||r==="mat3x2"||r==="mat3x3"||r==="mat3x4"||r==="mat4x2"||r==="mat4x3"||r==="mat4x4"||r==="mat2x2f"||r==="mat2x3f"||r==="mat2x4f"||r==="mat3x2f"||r==="mat3x3f"||r==="mat3x4f"||r==="mat4x2f"||r==="mat4x3f"||r==="mat4x4f"||r==="mat2x2h"||r==="mat2x3h"||r==="mat2x4h"||r==="mat3x2h"||r==="mat3x3h"||r==="mat3x4h"||r==="mat4x2h"||r==="mat4x3h"||r==="mat4x4h"||e.type instanceof Jt||e.type instanceof Fe||e.type instanceof T){const i=new Me(e.type,[]);n=this._evalCreate(i,t)}}t.createVariable(e.name,n,e)}_switch(e,t){t=t.clone();const n=this.evalExpression(e.condition,t);if(!(n instanceof m))return console.error(`Invalid if condition. Line ${e.line}`),null;let r=null;for(const i of e.cases)if(i instanceof _c)for(const o of i.selectors){if(o instanceof Cs){r=i;continue}const a=this.evalExpression(o,t);if(!(a instanceof m))return console.error(`Invalid case selector. Line ${e.line}`),null;if(a.value===n.value)return this._execStatements(i.body,t)}else i instanceof mc&&(r=i);return r?this._execStatements(r.body,t):null}_if(e,t){t=t.clone();const n=this.evalExpression(e.condition,t);if(!(n instanceof m))return console.error(`Invalid if condition. Line ${e.line}`),null;if(n.value)return this._execStatements(e.body,t);for(const r of e.elseif){const i=this.evalExpression(r.condition,t);if(!(i instanceof m))return console.error(`Invalid if condition. Line ${e.line}`),null;if(i.value)return this._execStatements(r.body,t)}return e.else?this._execStatements(e.else,t):null}_getScalarValue(e){return e instanceof m?e.value:(console.error("Expected scalar value.",e),0)}_for(e,t){for(t=t.clone(),this.execStatement(e.init,t);this._getScalarValue(this.evalExpression(e.condition,t));){const n=this._execStatements(e.body,t);if(n===le._breakObj)break;if(n!==null&&n!==le._continueObj)return n;this.execStatement(e.increment,t)}return null}_loop(e,t){for(t=t.clone();;){const n=this._execStatements(e.body,t);if(n===le._breakObj)break;if(n===le._continueObj){if(e.continuing&&this._execStatements(e.continuing.body,t)===le._breakObj)break}else if(n!==null)return n}return null}_while(e,t){for(t=t.clone();this._getScalarValue(this.evalExpression(e.condition,t));){const n=this._execStatements(e.body,t);if(n===le._breakObj)break;if(n!==le._continueObj&&n!==null)return n}return null}_evalBitcast(e,t){const n=this.evalExpression(e.value,t),r=e.type;if(n instanceof m){const i=Ji(n.value,n.typeInfo.name,r.name);return new m(i,this.getTypeInfo(r))}if(n instanceof p){const i=n.typeInfo.getTypeName();let o="";if(i.endsWith("f"))o="f32";else if(i.endsWith("i"))o="i32";else if(i.endsWith("u"))o="u32";else if(i.endsWith("b"))o="bool";else{if(!i.endsWith("h"))return console.error(`Unknown vector type ${i}. Line ${e.line}`),null;o="f16"}const a=r.getTypeName();let c="";if(a.endsWith("f"))c="f32";else if(a.endsWith("i"))c="i32";else if(a.endsWith("u"))c="u32";else if(a.endsWith("b"))c="bool";else{if(!a.endsWith("h"))return console.error(`Unknown vector type ${c}. Line ${e.line}`),null;c="f16"}const l=(function(u,h,f){if(h===f)return u;const g=new Array(u.length);for(let _=0;_<u.length;_++)g[_]=Ji(u[_],h,f);return g})(Array.from(n.data),o,c);return new p(l,this.getTypeInfo(r))}return console.error(`TODO: bitcast for ${n.typeInfo.name}. Line ${e.line}`),null}_evalConst(e,t){return t.getVariableValue(e.name).clone().getSubData(this,e.postfix,t)}_evalCreate(e,t){var n;if(e instanceof Me){if(e.type===null)return sr.void;switch(e.type.getTypeName()){case"bool":case"i32":case"u32":case"f32":case"f16":return this._callConstructorValue(e,t);case"vec2":case"vec3":case"vec4":case"vec2f":case"vec3f":case"vec4f":case"vec2h":case"vec3h":case"vec4h":case"vec2i":case"vec3i":case"vec4i":case"vec2u":case"vec3u":case"vec4u":case"vec2b":case"vec3b":case"vec4b":return this._callConstructorVec(e,t);case"mat2x2":case"mat2x2f":case"mat2x2h":case"mat2x3":case"mat2x3f":case"mat2x3h":case"mat2x4":case"mat2x4f":case"mat2x4h":case"mat3x2":case"mat3x2f":case"mat3x2h":case"mat3x3":case"mat3x3f":case"mat3x3h":case"mat3x4":case"mat3x4f":case"mat3x4h":case"mat4x2":case"mat4x2f":case"mat4x2h":case"mat4x3":case"mat4x3f":case"mat4x3h":case"mat4x4":case"mat4x4f":case"mat4x4h":return this._callConstructorMatrix(e,t)}}const r=e instanceof Me?e.type.name:e.name,i=e instanceof Me?this.getTypeInfo(e.type):this.getTypeInfo(e.name);if(i===null)return console.error(`Unknown type ${r}. Line ${e.line}`),null;if(i.size===0)return null;const o=new G(new ArrayBuffer(i.size),i,0);if(i instanceof Xe){if(e.args)for(let a=0;a<e.args.length;++a){const c=i.members[a],l=e.args[a],u=this.evalExpression(l,t);o.setData(this,u,c.type,c.offset,t)}}else if(i instanceof Ze){let a=0;if(e.args)for(let c=0;c<e.args.length;++c){const l=e.args[c],u=this.evalExpression(l,t);i.format===null&&(((n=u.typeInfo)===null||n===void 0?void 0:n.name)==="x32"?i.format=this.getTypeInfo("i32"):i.format=u.typeInfo),o.setData(this,u,i.format,a,t),a+=i.stride}}else console.error(`Unknown type "${r}". Line ${e.line}`);return e instanceof Me?o.getSubData(this,e.postfix,t):o}_evalLiteral(e,t){const n=this.getTypeInfo(e.type),r=n.name;return r==="x32"||r==="u32"||r==="f32"||r==="f16"||r==="i32"||r==="bool"?new m(e.scalarValue,n):r==="vec2"||r==="vec3"||r==="vec4"||r==="vec2f"||r==="vec3f"||r==="vec4f"||r==="vec2h"||r==="vec3h"||r==="vec4h"||r==="vec2i"||r==="vec3i"||r==="vec4i"||r==="vec2u"||r==="vec3u"||r==="vec4u"?this._callConstructorVec(e,t):r==="mat2x2"||r==="mat2x3"||r==="mat2x4"||r==="mat3x2"||r==="mat3x3"||r==="mat3x4"||r==="mat4x2"||r==="mat4x3"||r==="mat4x4"||r==="mat2x2f"||r==="mat2x3f"||r==="mat2x4f"||r==="mat3x2f"||r==="mat3x3f"||r==="mat3x4f"||r==="mat4x2f"||r==="mat4x3f"||r==="mat4x4f"||r==="mat2x2h"||r==="mat2x3h"||r==="mat2x4h"||r==="mat3x2h"||r==="mat3x3h"||r==="mat3x4h"||r==="mat4x2h"||r==="mat4x3h"||r==="mat4x4h"?this._callConstructorMatrix(e,t):e.value}_evalVariable(e,t){const n=t.getVariableValue(e.name);return n===null?n:n.getSubData(this,e.postfix,t)}_maxFormatTypeInfo(e){let t=e[0];if(t.name==="f32")return t;for(let n=1;n<e.length;++n){const r=le._priority.get(t.name);le._priority.get(e[n].name)<r&&(t=e[n])}return t.name==="x32"?this.getTypeInfo("i32"):t}_evalUnaryOp(e,t){const n=this.evalExpression(e.right,t);if(e.operator==="&")return new mt(n);if(e.operator==="*")return n instanceof mt?n.reference.getSubData(this,e.postfix,t):(console.error(`Invalid dereference. Line ${e.line}`),null);const r=n instanceof m?n.value:n instanceof p?Array.from(n.data):null;switch(e.operator){case"+":{if(O(r)){const a=r.map((c,l)=>+c);return new p(a,n.typeInfo)}const i=r,o=this._maxFormatTypeInfo([n.typeInfo,n.typeInfo]);return new m(+i,o)}case"-":{if(O(r)){const a=r.map((c,l)=>-c);return new p(a,n.typeInfo)}const i=r,o=this._maxFormatTypeInfo([n.typeInfo,n.typeInfo]);return new m(-i,o)}case"!":{if(O(r)){const a=r.map((c,l)=>c?0:1);return new p(a,n.typeInfo)}const i=r,o=this._maxFormatTypeInfo([n.typeInfo,n.typeInfo]);return new m(i?0:1,o)}case"~":{if(O(r)){const a=r.map((c,l)=>~c);return new p(a,n.typeInfo)}const i=r,o=this._maxFormatTypeInfo([n.typeInfo,n.typeInfo]);return new m(~i,o)}}return console.error(`Invalid unary operator ${e.operator}. Line ${e.line}`),null}_evalBinaryOp(e,t){const n=this.evalExpression(e.left,t),r=this.evalExpression(e.right,t),i=n instanceof m?n.value:n instanceof p||n instanceof k?Array.from(n.data):null,o=r instanceof m?r.value:r instanceof p||r instanceof k?Array.from(r.data):null;switch(e.operator){case"+":{if(O(i)&&O(o)){const u=i,h=o;if(u.length!==h.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const f=u.map((g,_)=>g+h[_]);return new p(f,n.typeInfo)}if(O(i)){const u=o,h=i.map((f,g)=>f+u);return new p(h,n.typeInfo)}if(O(o)){const u=i,h=o.map((f,g)=>u+f);return new p(h,r.typeInfo)}const a=i,c=o,l=this._maxFormatTypeInfo([n.typeInfo,r.typeInfo]);return new m(a+c,l)}case"-":{if(O(i)&&O(o)){const u=i,h=o;if(u.length!==h.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const f=u.map((g,_)=>g-h[_]);return new p(f,n.typeInfo)}if(O(i)){const u=o,h=i.map((f,g)=>f-u);return new p(h,n.typeInfo)}if(O(o)){const u=i,h=o.map((f,g)=>u-f);return new p(h,r.typeInfo)}const a=i,c=o,l=this._maxFormatTypeInfo([n.typeInfo,r.typeInfo]);return new m(a-c,l)}case"*":{if(O(i)&&O(o)){const u=i,h=o;if(n instanceof k&&r instanceof k){const f=(function(A,S,I,x){if(he[S.name]===void 0||he[x.name]===void 0)return null;const E=he[S.name][0],P=he[S.name][1],M=he[x.name][0];if(E!==he[x.name][1])return null;const D=new Array(M*P);for(let B=0;B<P;B++)for(let N=0;N<M;N++){let U=0;for(let L=0;L<E;L++)U+=A[L*P+B]*I[N*E+L];D[B*M+N]=U}return D})(u,n.typeInfo,h,r.typeInfo);if(f===null)return console.error(`Matrix multiplication failed. Line ${e.line}.`),null;const g=he[r.typeInfo.name][0],_=he[n.typeInfo.name][1],w=this.getTypeInfo(`mat${g}x${_}f`);return new k(f,w)}if(n instanceof k&&r instanceof p){const f=(function(g,_,w,A){if(he[_.name]===void 0||Sn[A.name]===void 0)return null;const S=he[_.name][0],I=he[_.name][1];if(S!==w.length)return null;const x=new Array(I);for(let E=0;E<I;E++){let P=0;for(let M=0;M<S;M++)P+=g[M*I+E]*w[M];x[E]=P}return x})(u,n.typeInfo,h,r.typeInfo);return f===null?(console.error(`Matrix vector multiplication failed. Line ${e.line}.`),null):new p(f,r.typeInfo)}if(n instanceof p&&r instanceof k){const f=(function(g,_,w,A){if(Sn[_.name]===void 0||he[A.name]===void 0)return null;const S=he[A.name][0],I=he[A.name][1];if(I!==g.length)return null;const x=[];for(let E=0;E<S;E++){let P=0;for(let M=0;M<I;M++)P+=g[M]*w[M*S+E];x[E]=P}return x})(u,n.typeInfo,h,r.typeInfo);return f===null?(console.error(`Matrix vector multiplication failed. Line ${e.line}.`),null):new p(f,n.typeInfo)}{if(u.length!==h.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const f=u.map((g,_)=>g*h[_]);return new p(f,n.typeInfo)}}if(O(i)){const u=o,h=i.map((f,g)=>f*u);return n instanceof k?new k(h,n.typeInfo):new p(h,n.typeInfo)}if(O(o)){const u=i,h=o.map((f,g)=>u*f);return r instanceof k?new k(h,r.typeInfo):new p(h,r.typeInfo)}const a=i,c=o,l=this._maxFormatTypeInfo([n.typeInfo,r.typeInfo]);return new m(a*c,l)}case"%":{if(O(i)&&O(o)){const u=i,h=o;if(u.length!==h.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const f=u.map((g,_)=>g%h[_]);return new p(f,n.typeInfo)}if(O(i)){const u=o,h=i.map((f,g)=>f%u);return new p(h,n.typeInfo)}if(O(o)){const u=i,h=o.map((f,g)=>u%f);return new p(h,r.typeInfo)}const a=i,c=o,l=this._maxFormatTypeInfo([n.typeInfo,r.typeInfo]);return new m(a%c,l)}case"/":{if(O(i)&&O(o)){const u=i,h=o;if(u.length!==h.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const f=u.map((g,_)=>g/h[_]);return new p(f,n.typeInfo)}if(O(i)){const u=o,h=i.map((f,g)=>f/u);return new p(h,n.typeInfo)}if(O(o)){const u=i,h=o.map((f,g)=>u/f);return new p(h,r.typeInfo)}const a=i,c=o,l=this._maxFormatTypeInfo([n.typeInfo,r.typeInfo]);return new m(a/c,l)}case"&":{if(O(i)&&O(o)){const u=i,h=o;if(u.length!==h.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const f=u.map((g,_)=>g&h[_]);return new p(f,n.typeInfo)}if(O(i)){const u=o,h=i.map((f,g)=>f&u);return new p(h,n.typeInfo)}if(O(o)){const u=i,h=o.map((f,g)=>u&f);return new p(h,r.typeInfo)}const a=i,c=o,l=this._maxFormatTypeInfo([n.typeInfo,r.typeInfo]);return new m(a&c,l)}case"|":{if(O(i)&&O(o)){const u=i,h=o;if(u.length!==h.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const f=u.map((g,_)=>g|h[_]);return new p(f,n.typeInfo)}if(O(i)){const u=o,h=i.map((f,g)=>f|u);return new p(h,n.typeInfo)}if(O(o)){const u=i,h=o.map((f,g)=>u|f);return new p(h,r.typeInfo)}const a=i,c=o,l=this._maxFormatTypeInfo([n.typeInfo,r.typeInfo]);return new m(a|c,l)}case"^":{if(O(i)&&O(o)){const u=i,h=o;if(u.length!==h.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const f=u.map((g,_)=>g^h[_]);return new p(f,n.typeInfo)}if(O(i)){const u=o,h=i.map((f,g)=>f^u);return new p(h,n.typeInfo)}if(O(o)){const u=i,h=o.map((f,g)=>u^f);return new p(h,r.typeInfo)}const a=i,c=o,l=this._maxFormatTypeInfo([n.typeInfo,r.typeInfo]);return new m(a^c,l)}case"<<":{if(O(i)&&O(o)){const u=i,h=o;if(u.length!==h.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const f=u.map((g,_)=>g<<h[_]);return new p(f,n.typeInfo)}if(O(i)){const u=o,h=i.map((f,g)=>f<<u);return new p(h,n.typeInfo)}if(O(o)){const u=i,h=o.map((f,g)=>u<<f);return new p(h,r.typeInfo)}const a=i,c=o,l=this._maxFormatTypeInfo([n.typeInfo,r.typeInfo]);return new m(a<<c,l)}case">>":{if(O(i)&&O(o)){const u=i,h=o;if(u.length!==h.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const f=u.map((g,_)=>g>>h[_]);return new p(f,n.typeInfo)}if(O(i)){const u=o,h=i.map((f,g)=>f>>u);return new p(h,n.typeInfo)}if(O(o)){const u=i,h=o.map((f,g)=>u>>f);return new p(h,r.typeInfo)}const a=i,c=o,l=this._maxFormatTypeInfo([n.typeInfo,r.typeInfo]);return new m(a>>c,l)}case">":if(O(i)&&O(o)){const a=i,c=o;if(a.length!==c.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const l=a.map((u,h)=>u>c[h]?1:0);return new p(l,n.typeInfo)}if(O(i)){const a=o,c=i.map((l,u)=>l>a?1:0);return new p(c,n.typeInfo)}if(O(o)){const a=i,c=o.map((l,u)=>a>l?1:0);return new p(c,r.typeInfo)}return new m(i>o?1:0,this.getTypeInfo("bool"));case"<":if(O(i)&&O(o)){const a=i,c=o;if(a.length!==c.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const l=a.map((u,h)=>u<c[h]?1:0);return new p(l,n.typeInfo)}if(O(i)){const a=o,c=i.map((l,u)=>l<a?1:0);return new p(c,n.typeInfo)}if(O(o)){const a=i,c=o.map((l,u)=>a<l?1:0);return new p(c,r.typeInfo)}return new m(i<o?1:0,this.getTypeInfo("bool"));case"==":if(O(i)&&O(o)){const a=i,c=o;if(a.length!==c.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const l=a.map((u,h)=>u===c[h]?1:0);return new p(l,n.typeInfo)}if(O(i)){const a=o,c=i.map((l,u)=>l==a?1:0);return new p(c,n.typeInfo)}if(O(o)){const a=i,c=o.map((l,u)=>a==l?1:0);return new p(c,r.typeInfo)}return new m(i===o?1:0,this.getTypeInfo("bool"));case"!=":if(O(i)&&O(o)){const a=i,c=o;if(a.length!==c.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const l=a.map((u,h)=>u!==c[h]?1:0);return new p(l,n.typeInfo)}if(O(i)){const a=o,c=i.map((l,u)=>l!==a?1:0);return new p(c,n.typeInfo)}if(O(o)){const a=i,c=o.map((l,u)=>a!==l?1:0);return new p(c,r.typeInfo)}return new m(i!==o?1:0,this.getTypeInfo("bool"));case">=":if(O(i)&&O(o)){const a=i,c=o;if(a.length!==c.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const l=a.map((u,h)=>u>=c[h]?1:0);return new p(l,n.typeInfo)}if(O(i)){const a=o,c=i.map((l,u)=>l>=a?1:0);return new p(c,n.typeInfo)}if(O(o)){const a=i,c=o.map((l,u)=>a>=l?1:0);return new p(c,r.typeInfo)}return new m(i>=o?1:0,this.getTypeInfo("bool"));case"<=":if(O(i)&&O(o)){const a=i,c=o;if(a.length!==c.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const l=a.map((u,h)=>u<=c[h]?1:0);return new p(l,n.typeInfo)}if(O(i)){const a=o,c=i.map((l,u)=>l<=a?1:0);return new p(c,n.typeInfo)}if(O(o)){const a=i,c=o.map((l,u)=>a<=l?1:0);return new p(c,r.typeInfo)}return new m(i<=o?1:0,this.getTypeInfo("bool"));case"&&":if(O(i)&&O(o)){const a=i,c=o;if(a.length!==c.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const l=a.map((u,h)=>u&&c[h]?1:0);return new p(l,n.typeInfo)}if(O(i)){const a=o,c=i.map((l,u)=>l&&a?1:0);return new p(c,n.typeInfo)}if(O(o)){const a=i,c=o.map((l,u)=>a&&l?1:0);return new p(c,r.typeInfo)}return new m(i&&o?1:0,this.getTypeInfo("bool"));case"||":if(O(i)&&O(o)){const a=i,c=o;if(a.length!==c.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;const l=a.map((u,h)=>u||c[h]?1:0);return new p(l,n.typeInfo)}if(O(i)){const a=o,c=i.map((l,u)=>l||a?1:0);return new p(c,n.typeInfo)}if(O(o)){const a=i,c=o.map((l,u)=>a||l?1:0);return new p(c,r.typeInfo)}return new m(i||o?1:0,this.getTypeInfo("bool"))}return console.error(`Unknown operator ${e.operator}. Line ${e.line}`),null}_evalCall(e,t){if(e.cachedReturnValue!==null)return e.cachedReturnValue;const n=t.clone();n.currentFunctionName=e.name;const r=t.getFunction(e.name);if(!r)return e.isBuiltin?this._callBuiltinFunction(e,n):this.getTypeInfo(e.name)?this._evalCreate(e,t):(console.error(`Unknown function "${e.name}". Line ${e.line}`),null);for(let i=0;i<r.node.args.length;++i){const o=r.node.args[i],a=this.evalExpression(e.args[i],n);n.createVariable(o.name,a,o)}return this._execStatements(r.node.body,n)}_callBuiltinFunction(e,t){switch(e.name){case"all":return this.builtins.All(e,t);case"any":return this.builtins.Any(e,t);case"select":return this.builtins.Select(e,t);case"arrayLength":return this.builtins.ArrayLength(e,t);case"abs":return this.builtins.Abs(e,t);case"acos":return this.builtins.Acos(e,t);case"acosh":return this.builtins.Acosh(e,t);case"asin":return this.builtins.Asin(e,t);case"asinh":return this.builtins.Asinh(e,t);case"atan":return this.builtins.Atan(e,t);case"atanh":return this.builtins.Atanh(e,t);case"atan2":return this.builtins.Atan2(e,t);case"ceil":return this.builtins.Ceil(e,t);case"clamp":return this.builtins.Clamp(e,t);case"cos":return this.builtins.Cos(e,t);case"cosh":return this.builtins.Cosh(e,t);case"countLeadingZeros":return this.builtins.CountLeadingZeros(e,t);case"countOneBits":return this.builtins.CountOneBits(e,t);case"countTrailingZeros":return this.builtins.CountTrailingZeros(e,t);case"cross":return this.builtins.Cross(e,t);case"degrees":return this.builtins.Degrees(e,t);case"determinant":return this.builtins.Determinant(e,t);case"distance":return this.builtins.Distance(e,t);case"dot":return this.builtins.Dot(e,t);case"dot4U8Packed":return this.builtins.Dot4U8Packed(e,t);case"dot4I8Packed":return this.builtins.Dot4I8Packed(e,t);case"exp":return this.builtins.Exp(e,t);case"exp2":return this.builtins.Exp2(e,t);case"extractBits":return this.builtins.ExtractBits(e,t);case"faceForward":return this.builtins.FaceForward(e,t);case"firstLeadingBit":return this.builtins.FirstLeadingBit(e,t);case"firstTrailingBit":return this.builtins.FirstTrailingBit(e,t);case"floor":return this.builtins.Floor(e,t);case"fma":return this.builtins.Fma(e,t);case"fract":return this.builtins.Fract(e,t);case"frexp":return this.builtins.Frexp(e,t);case"insertBits":return this.builtins.InsertBits(e,t);case"inverseSqrt":return this.builtins.InverseSqrt(e,t);case"ldexp":return this.builtins.Ldexp(e,t);case"length":return this.builtins.Length(e,t);case"log":return this.builtins.Log(e,t);case"log2":return this.builtins.Log2(e,t);case"max":return this.builtins.Max(e,t);case"min":return this.builtins.Min(e,t);case"mix":return this.builtins.Mix(e,t);case"modf":return this.builtins.Modf(e,t);case"normalize":return this.builtins.Normalize(e,t);case"pow":return this.builtins.Pow(e,t);case"quantizeToF16":return this.builtins.QuantizeToF16(e,t);case"radians":return this.builtins.Radians(e,t);case"reflect":return this.builtins.Reflect(e,t);case"refract":return this.builtins.Refract(e,t);case"reverseBits":return this.builtins.ReverseBits(e,t);case"round":return this.builtins.Round(e,t);case"saturate":return this.builtins.Saturate(e,t);case"sign":return this.builtins.Sign(e,t);case"sin":return this.builtins.Sin(e,t);case"sinh":return this.builtins.Sinh(e,t);case"smoothstep":return this.builtins.SmoothStep(e,t);case"sqrt":return this.builtins.Sqrt(e,t);case"step":return this.builtins.Step(e,t);case"tan":return this.builtins.Tan(e,t);case"tanh":return this.builtins.Tanh(e,t);case"transpose":return this.builtins.Transpose(e,t);case"trunc":return this.builtins.Trunc(e,t);case"dpdx":return this.builtins.Dpdx(e,t);case"dpdxCoarse":return this.builtins.DpdxCoarse(e,t);case"dpdxFine":return this.builtins.DpdxFine(e,t);case"dpdy":return this.builtins.Dpdy(e,t);case"dpdyCoarse":return this.builtins.DpdyCoarse(e,t);case"dpdyFine":return this.builtins.DpdyFine(e,t);case"fwidth":return this.builtins.Fwidth(e,t);case"fwidthCoarse":return this.builtins.FwidthCoarse(e,t);case"fwidthFine":return this.builtins.FwidthFine(e,t);case"textureDimensions":return this.builtins.TextureDimensions(e,t);case"textureGather":return this.builtins.TextureGather(e,t);case"textureGatherCompare":return this.builtins.TextureGatherCompare(e,t);case"textureLoad":return this.builtins.TextureLoad(e,t);case"textureNumLayers":return this.builtins.TextureNumLayers(e,t);case"textureNumLevels":return this.builtins.TextureNumLevels(e,t);case"textureNumSamples":return this.builtins.TextureNumSamples(e,t);case"textureSample":return this.builtins.TextureSample(e,t);case"textureSampleBias":return this.builtins.TextureSampleBias(e,t);case"textureSampleCompare":return this.builtins.TextureSampleCompare(e,t);case"textureSampleCompareLevel":return this.builtins.TextureSampleCompareLevel(e,t);case"textureSampleGrad":return this.builtins.TextureSampleGrad(e,t);case"textureSampleLevel":return this.builtins.TextureSampleLevel(e,t);case"textureSampleBaseClampToEdge":return this.builtins.TextureSampleBaseClampToEdge(e,t);case"textureStore":return this.builtins.TextureStore(e,t);case"atomicLoad":return this.builtins.AtomicLoad(e,t);case"atomicStore":return this.builtins.AtomicStore(e,t);case"atomicAdd":return this.builtins.AtomicAdd(e,t);case"atomicSub":return this.builtins.AtomicSub(e,t);case"atomicMax":return this.builtins.AtomicMax(e,t);case"atomicMin":return this.builtins.AtomicMin(e,t);case"atomicAnd":return this.builtins.AtomicAnd(e,t);case"atomicOr":return this.builtins.AtomicOr(e,t);case"atomicXor":return this.builtins.AtomicXor(e,t);case"atomicExchange":return this.builtins.AtomicExchange(e,t);case"atomicCompareExchangeWeak":return this.builtins.AtomicCompareExchangeWeak(e,t);case"pack4x8snorm":return this.builtins.Pack4x8snorm(e,t);case"pack4x8unorm":return this.builtins.Pack4x8unorm(e,t);case"pack4xI8":return this.builtins.Pack4xI8(e,t);case"pack4xU8":return this.builtins.Pack4xU8(e,t);case"pack4x8Clamp":return this.builtins.Pack4x8Clamp(e,t);case"pack4xU8Clamp":return this.builtins.Pack4xU8Clamp(e,t);case"pack2x16snorm":return this.builtins.Pack2x16snorm(e,t);case"pack2x16unorm":return this.builtins.Pack2x16unorm(e,t);case"pack2x16float":return this.builtins.Pack2x16float(e,t);case"unpack4x8snorm":return this.builtins.Unpack4x8snorm(e,t);case"unpack4x8unorm":return this.builtins.Unpack4x8unorm(e,t);case"unpack4xI8":return this.builtins.Unpack4xI8(e,t);case"unpack4xU8":return this.builtins.Unpack4xU8(e,t);case"unpack2x16snorm":return this.builtins.Unpack2x16snorm(e,t);case"unpack2x16unorm":return this.builtins.Unpack2x16unorm(e,t);case"unpack2x16float":return this.builtins.Unpack2x16float(e,t);case"storageBarrier":return this.builtins.StorageBarrier(e,t);case"textureBarrier":return this.builtins.TextureBarrier(e,t);case"workgroupBarrier":return this.builtins.WorkgroupBarrier(e,t);case"workgroupUniformLoad":return this.builtins.WorkgroupUniformLoad(e,t);case"subgroupAdd":return this.builtins.SubgroupAdd(e,t);case"subgroupExclusiveAdd":return this.builtins.SubgroupExclusiveAdd(e,t);case"subgroupInclusiveAdd":return this.builtins.SubgroupInclusiveAdd(e,t);case"subgroupAll":return this.builtins.SubgroupAll(e,t);case"subgroupAnd":return this.builtins.SubgroupAnd(e,t);case"subgroupAny":return this.builtins.SubgroupAny(e,t);case"subgroupBallot":return this.builtins.SubgroupBallot(e,t);case"subgroupBroadcast":return this.builtins.SubgroupBroadcast(e,t);case"subgroupBroadcastFirst":return this.builtins.SubgroupBroadcastFirst(e,t);case"subgroupElect":return this.builtins.SubgroupElect(e,t);case"subgroupMax":return this.builtins.SubgroupMax(e,t);case"subgroupMin":return this.builtins.SubgroupMin(e,t);case"subgroupMul":return this.builtins.SubgroupMul(e,t);case"subgroupExclusiveMul":return this.builtins.SubgroupExclusiveMul(e,t);case"subgroupInclusiveMul":return this.builtins.SubgroupInclusiveMul(e,t);case"subgroupOr":return this.builtins.SubgroupOr(e,t);case"subgroupShuffle":return this.builtins.SubgroupShuffle(e,t);case"subgroupShuffleDown":return this.builtins.SubgroupShuffleDown(e,t);case"subgroupShuffleUp":return this.builtins.SubgroupShuffleUp(e,t);case"subgroupShuffleXor":return this.builtins.SubgroupShuffleXor(e,t);case"subgroupXor":return this.builtins.SubgroupXor(e,t);case"quadBroadcast":return this.builtins.QuadBroadcast(e,t);case"quadSwapDiagonal":return this.builtins.QuadSwapDiagonal(e,t);case"quadSwapX":return this.builtins.QuadSwapX(e,t);case"quadSwapY":return this.builtins.QuadSwapY(e,t)}const n=t.getFunction(e.name);if(n){const r=t.clone();for(let i=0;i<n.node.args.length;++i){const o=n.node.args[i],a=this.evalExpression(e.args[i],r);r.setVariable(o.name,a,o)}return this._execStatements(n.node.body,r)}return null}_callConstructorValue(e,t){if(!e.args||e.args.length===0)return new m(0,this.getTypeInfo(e.type));const n=this.evalExpression(e.args[0],t);return n.typeInfo=this.getTypeInfo(e.type),n.getSubData(this,e.postfix,t).clone()}_callConstructorVec(e,t){const n=this.getTypeInfo(e.type),r=e.type.getTypeName(),i=Sn[r];if(i===void 0)return console.error(`Invalid vec constructor ${r}. Line ${e.line}`),null;const o=[];if(e instanceof re)if(e.isVector){const a=e.vectorValue;for(const c of a)o.push(c)}else o.push(e.scalarValue);else if(e.args)for(const a of e.args){const c=this.evalExpression(a,t);if(c instanceof p){const l=c.data;for(let u=0;u<l.length;++u){let h=l[u];o.push(h)}}else if(c instanceof m){let l=c.value;o.push(l)}}if(e.type instanceof T&&e.type.format===null&&(e.type.format=T.f32),o.length===0){const a=new Array(i).fill(0);return new p(a,n).getSubData(this,e.postfix,t)}if(o.length===1)for(;o.length<i;)o.push(o[0]);return o.length<i?(console.error(`Invalid vec constructor. Line ${e.line}`),null):new p(o.length>i?o.slice(0,i):o,n).getSubData(this,e.postfix,t)}_callConstructorMatrix(e,t){const n=this.getTypeInfo(e.type),r=e.type.getTypeName(),i=he[r];if(i===void 0)return console.error(`Invalid matrix constructor ${r}. Line ${e.line}`),null;const o=[];if(e instanceof re)if(e.isVector){const a=e.vectorValue;for(const c of a)o.push(c)}else o.push(e.scalarValue);else if(e.args)for(const a of e.args){const c=this.evalExpression(a,t);c instanceof p?o.push(...c.data):c instanceof m?o.push(c.value):c instanceof k&&o.push(...c.data)}if(n instanceof ct&&n.format===null&&(n.format=this.getTypeInfo("f32")),o.length===0){const a=new Array(i[2]).fill(0);return new k(a,n).getSubData(this,e.postfix,t)}return o.length!==i[2]?(console.error(`Invalid matrix constructor. Line ${e.line}`),null):new k(o,n).getSubData(this,e.postfix,t)}}le._breakObj=new we(new be("BREAK",null),null),le._continueObj=new we(new be("CONTINUE",null),null),le._priority=new Map([["f32",0],["f16",1],["u32",2],["i32",3],["x32",3]]);class tp{constructor(){this.constants=new Map,this.aliases=new Map,this.structs=new Map}}class sp{constructor(){this._tokens=[],this._current=0,this._currentLine=1,this._deferArrayCountEval=[],this._currentLoop=[],this._context=new tp,this._exec=new le,this._forwardTypeCount=0}parse(e){this._initialize(e),this._deferArrayCountEval.length=0;const t=[];for(;!this._isAtEnd();){const n=this._global_decl_or_directive();if(!n)break;t.push(n)}if(this._deferArrayCountEval.length>0){for(const n of this._deferArrayCountEval){const r=n.arrayType,i=n.countNode;if(i instanceof _e){const o=i.name,a=this._context.constants.get(o);if(a)try{const c=a.constEvaluate(this._exec);r.count=c}catch{}}}this._deferArrayCountEval.length=0}if(this._forwardTypeCount>0)for(const n of t)n.search(r=>{r instanceof Zi||r instanceof Is?r.type=this._forwardType(r.type):r instanceof Jt?r.format=this._forwardType(r.format):r instanceof Ue||r instanceof Qt||r instanceof Rs?r.type=this._forwardType(r.type):r instanceof ns?r.returnType=this._forwardType(r.returnType):r instanceof Ki&&(r.type=this._forwardType(r.type))});return t}_forwardType(e){if(e instanceof qi){const t=this._getType(e.name);if(t)return t}else e instanceof Is?e.type=this._forwardType(e.type):e instanceof Jt&&(e.format=this._forwardType(e.format));return e}_initialize(e){if(e)if(typeof e=="string"){const t=new zd(e);this._tokens=t.scanTokens()}else this._tokens=e;else this._tokens=[];this._current=0}_updateNode(e,t){return e.line=t??this._currentLine,e}_error(e,t){return{token:e,message:t,toString:()=>`${t}`}}_isAtEnd(){return this._current>=this._tokens.length||this._peek().type==d.eof}_match(e){if(e instanceof y)return!!this._check(e)&&(this._advance(),!0);for(let t=0,n=e.length;t<n;++t){const r=e[t];if(this._check(r))return this._advance(),!0}return!1}_consume(e,t){if(this._check(e))return this._advance();throw this._error(this._peek(),`${t}. Line:${this._currentLine}`)}_check(e){if(this._isAtEnd())return!1;const t=this._peek();if(e instanceof Array){const n=t.type;let r=!1;for(const i of e){if(n===i)return!0;i===d.tokens.name&&(r=!0)}if(r){const i=d.tokens.name.rule.exec(t.lexeme);if(i&&i.index==0&&i[0]==t.lexeme)return!0}return!1}if(t.type===e)return!0;if(e===d.tokens.name){const n=d.tokens.name.rule.exec(t.lexeme);return n&&n.index==0&&n[0]==t.lexeme}return!1}_advance(){var e,t;return this._currentLine=(t=(e=this._peek())===null||e===void 0?void 0:e.line)!==null&&t!==void 0?t:-1,this._isAtEnd()||this._current++,this._previous()}_peek(){return this._tokens[this._current]}_previous(){return this._tokens[this._current-1]}_global_decl_or_directive(){for(;this._match(d.tokens.semicolon)&&!this._isAtEnd(););if(this._match(d.keywords.alias)){const t=this._type_alias();return this._consume(d.tokens.semicolon,"Expected ';'"),this._exec.reflection.updateAST([t]),t}if(this._match(d.keywords.diagnostic)){const t=this._diagnostic();return this._consume(d.tokens.semicolon,"Expected ';'"),this._exec.reflection.updateAST([t]),t}if(this._match(d.keywords.requires)){const t=this._requires_directive();return this._consume(d.tokens.semicolon,"Expected ';'"),this._exec.reflection.updateAST([t]),t}if(this._match(d.keywords.enable)){const t=this._enable_directive();return this._consume(d.tokens.semicolon,"Expected ';'"),this._exec.reflection.updateAST([t]),t}const e=this._attribute();if(this._check(d.keywords.var)){const t=this._global_variable_decl();return t!=null&&(t.attributes=e),this._consume(d.tokens.semicolon,"Expected ';'."),this._exec.reflection.updateAST([t]),t}if(this._check(d.keywords.override)){const t=this._override_variable_decl();return t!=null&&(t.attributes=e),this._consume(d.tokens.semicolon,"Expected ';'."),this._exec.reflection.updateAST([t]),t}if(this._check(d.keywords.let)){const t=this._global_let_decl();return t!=null&&(t.attributes=e),this._consume(d.tokens.semicolon,"Expected ';'."),this._exec.reflection.updateAST([t]),t}if(this._check(d.keywords.const)){const t=this._global_const_decl();return t!=null&&(t.attributes=e),this._consume(d.tokens.semicolon,"Expected ';'."),this._exec.reflection.updateAST([t]),t}if(this._check(d.keywords.struct)){const t=this._struct_decl();return t!=null&&(t.attributes=e),this._exec.reflection.updateAST([t]),t}if(this._check(d.keywords.fn)){const t=this._function_decl();return t!=null&&(t.attributes=e),this._exec.reflection.updateAST([t]),t}return null}_function_decl(){if(!this._match(d.keywords.fn))return null;const e=this._currentLine,t=this._consume(d.tokens.ident,"Expected function name.").toString();this._consume(d.tokens.paren_left,"Expected '(' for function arguments.");const n=[];if(!this._check(d.tokens.paren_right))do{if(this._check(d.tokens.paren_right))break;const a=this._attribute(),c=this._consume(d.tokens.name,"Expected argument name.").toString();this._consume(d.tokens.colon,"Expected ':' for argument type.");const l=this._attribute(),u=this._type_decl();u!=null&&(u.attributes=l,n.push(this._updateNode(new Ki(c,u,a))))}while(this._match(d.tokens.comma));this._consume(d.tokens.paren_right,"Expected ')' after function arguments.");let r=null;if(this._match(d.tokens.arrow)){const a=this._attribute();r=this._type_decl(),r!=null&&(r.attributes=a)}const i=this._compound_statement(),o=this._currentLine;return this._updateNode(new ns(t,n,r,i,e,o),e)}_compound_statement(){const e=[];for(this._consume(d.tokens.brace_left,"Expected '{' for block.");!this._check(d.tokens.brace_right);){const t=this._statement();t!==null&&e.push(t)}return this._consume(d.tokens.brace_right,"Expected '}' for block."),e}_statement(){for(;this._match(d.tokens.semicolon)&&!this._isAtEnd(););if(this._check(d.tokens.attr)&&this._attribute(),this._check(d.keywords.if))return this._if_statement();if(this._check(d.keywords.switch))return this._switch_statement();if(this._check(d.keywords.loop))return this._loop_statement();if(this._check(d.keywords.for))return this._for_statement();if(this._check(d.keywords.while))return this._while_statement();if(this._check(d.keywords.continuing))return this._continuing_statement();if(this._check(d.keywords.static_assert))return this._static_assert_statement();if(this._check(d.tokens.brace_left))return this._compound_statement();let e=null;if(this._check(d.keywords.return))e=this._return_statement();else if(this._check([d.keywords.var,d.keywords.let,d.keywords.const]))e=this._variable_statement();else if(this._match(d.keywords.discard))e=this._updateNode(new Wd);else if(this._match(d.keywords.break)){const t=this._updateNode(new uc);if(this._currentLoop.length>0){const n=this._currentLoop[this._currentLoop.length-1];t.loopId=n.id}e=t,this._check(d.keywords.if)&&(this._advance(),t.condition=this._optional_paren_expression())}else if(this._match(d.keywords.continue)){const t=this._updateNode(new hc);if(!(this._currentLoop.length>0))throw this._error(this._peek(),`Continue statement must be inside a loop. Line: ${t.line}`);{const n=this._currentLoop[this._currentLoop.length-1];t.loopId=n.id}e=t}else e=this._increment_decrement_statement()||this._func_call_statement()||this._assignment_statement();return e!=null&&this._consume(d.tokens.semicolon,"Expected ';' after statement."),e}_static_assert_statement(){if(!this._match(d.keywords.static_assert))return null;const e=this._currentLine,t=this._optional_paren_expression();return this._updateNode(new Ld(t),e)}_while_statement(){if(!this._match(d.keywords.while))return null;const e=this._updateNode(new tc(null,null));return this._currentLoop.push(e),e.condition=this._optional_paren_expression(),this._check(d.tokens.attr)&&this._attribute(),e.body=this._compound_statement(),this._currentLoop.pop(),e}_continuing_statement(){const e=this._currentLoop.length>0?this._currentLoop[this._currentLoop.length-1].id:-1;if(!this._match(d.keywords.continuing))return null;const t=this._currentLine,n=this._compound_statement();return this._updateNode(new tr(n,e),t)}_for_statement(){if(!this._match(d.keywords.for))return null;this._consume(d.tokens.paren_left,"Expected '('.");const e=this._updateNode(new sc(null,null,null,null));return this._currentLoop.push(e),e.init=this._check(d.tokens.semicolon)?null:this._for_init(),this._consume(d.tokens.semicolon,"Expected ';'."),e.condition=this._check(d.tokens.semicolon)?null:this._short_circuit_or_expression(),this._consume(d.tokens.semicolon,"Expected ';'."),e.increment=this._check(d.tokens.paren_right)?null:this._for_increment(),this._consume(d.tokens.paren_right,"Expected ')'."),this._check(d.tokens.attr)&&this._attribute(),e.body=this._compound_statement(),this._currentLoop.pop(),e}_for_init(){return this._variable_statement()||this._func_call_statement()||this._assignment_statement()}_for_increment(){return this._func_call_statement()||this._increment_decrement_statement()||this._assignment_statement()}_variable_statement(){if(this._check(d.keywords.var)){const e=this._variable_decl();if(e===null)throw this._error(this._peek(),"Variable declaration expected.");let t=null;return this._match(d.tokens.equal)&&(t=this._short_circuit_or_expression()),this._updateNode(new Ue(e.name,e.type,e.storage,e.access,t),e.line)}if(this._match(d.keywords.let)){const e=this._currentLine,t=this._consume(d.tokens.name,"Expected name for let.").toString();let n=null;if(this._match(d.tokens.colon)){const i=this._attribute();n=this._type_decl(),n!=null&&(n.attributes=i)}this._consume(d.tokens.equal,"Expected '=' for let.");const r=this._short_circuit_or_expression();return this._updateNode(new Qt(t,n,null,null,r),e)}if(this._match(d.keywords.const)){const e=this._currentLine,t=this._consume(d.tokens.name,"Expected name for const.").toString();let n=null;if(this._match(d.tokens.colon)){const i=this._attribute();n=this._type_decl(),n!=null&&(n.attributes=i)}this._consume(d.tokens.equal,"Expected '=' for const.");const r=this._short_circuit_or_expression();return n===null&&r instanceof re&&(n=r.type),this._updateNode(new Rs(t,n,null,null,r),e)}return null}_increment_decrement_statement(){const e=this._current,t=this._unary_expression();if(t==null)return null;if(!this._check(d.increment_operators))return this._current=e,null;const n=this._consume(d.increment_operators,"Expected increment operator");return this._updateNode(new nc(n.type===d.tokens.plus_plus?vt.increment:vt.decrement,t))}_assignment_statement(){let e=null;const t=this._currentLine;if(this._check(d.tokens.brace_right))return null;let n=this._match(d.tokens.underscore);if(n||(e=this._unary_expression()),!n&&e==null)return null;const r=this._consume(d.assignment_operators,"Expected assignment operator."),i=this._short_circuit_or_expression();return this._updateNode(new rc(Ht.parse(r.lexeme),e,i),t)}_func_call_statement(){if(!this._check(d.tokens.ident))return null;const e=this._currentLine,t=this._current,n=this._consume(d.tokens.ident,"Expected function name."),r=this._argument_expression_list();return r===null?(this._current=t,null):this._updateNode(new Wr(n.lexeme,r),e)}_loop_statement(){if(!this._match(d.keywords.loop))return null;this._check(d.tokens.attr)&&this._attribute(),this._consume(d.tokens.brace_left,"Expected '{' for loop.");const e=this._updateNode(new ic([],null));this._currentLoop.push(e);let t=this._statement();for(;t!==null;){if(Array.isArray(t))for(let n of t)e.body.push(n);else e.body.push(t);if(t instanceof tr){e.continuing=t;break}t=this._statement()}return this._currentLoop.pop(),this._consume(d.tokens.brace_right,"Expected '}' for loop."),e}_switch_statement(){if(!this._match(d.keywords.switch))return null;const e=this._updateNode(new oc(null,[]));if(this._currentLoop.push(e),e.condition=this._optional_paren_expression(),this._check(d.tokens.attr)&&this._attribute(),this._consume(d.tokens.brace_left,"Expected '{' for switch."),e.cases=this._switch_body(),e.cases==null||e.cases.length==0)throw this._error(this._previous(),"Expected 'case' or 'default'.");return this._consume(d.tokens.brace_right,"Expected '}' for switch."),this._currentLoop.pop(),e}_switch_body(){const e=[];let t=!1;for(;this._check([d.keywords.default,d.keywords.case]);){if(this._match(d.keywords.case)){const n=this._case_selectors();for(const i of n)if(i instanceof Cs){if(t)throw this._error(this._previous(),"Multiple default cases in switch statement.");t=!0;break}this._match(d.tokens.colon),this._check(d.tokens.attr)&&this._attribute(),this._consume(d.tokens.brace_left,"Exected '{' for switch case.");const r=this._case_body();this._consume(d.tokens.brace_right,"Exected '}' for switch case."),e.push(this._updateNode(new _c(n,r)))}if(this._match(d.keywords.default)){if(t)throw this._error(this._previous(),"Multiple default cases in switch statement.");this._match(d.tokens.colon),this._check(d.tokens.attr)&&this._attribute(),this._consume(d.tokens.brace_left,"Exected '{' for switch default.");const n=this._case_body();this._consume(d.tokens.brace_right,"Exected '}' for switch default."),e.push(this._updateNode(new mc(n)))}}return e}_case_selectors(){const e=[];for(this._match(d.keywords.default)?e.push(this._updateNode(new Cs)):e.push(this._shift_expression());this._match(d.tokens.comma);)this._match(d.keywords.default)?e.push(this._updateNode(new Cs)):e.push(this._shift_expression());return e}_case_body(){if(this._match(d.keywords.fallthrough))return this._consume(d.tokens.semicolon,"Expected ';'"),[];let e=this._statement();if(e==null)return[];e instanceof Array||(e=[e]);const t=this._case_body();return t.length==0?e:[...e,t[0]]}_if_statement(){if(!this._match(d.keywords.if))return null;const e=this._currentLine,t=this._optional_paren_expression();this._check(d.tokens.attr)&&this._attribute();const n=this._compound_statement();let r=[];this._match_elseif()&&(this._check(d.tokens.attr)&&this._attribute(),r=this._elseif_statement(r));let i=null;return this._match(d.keywords.else)&&(this._check(d.tokens.attr)&&this._attribute(),i=this._compound_statement()),this._updateNode(new ac(t,n,r,i),e)}_match_elseif(){return this._tokens[this._current].type===d.keywords.else&&this._tokens[this._current+1].type===d.keywords.if&&(this._advance(),this._advance(),!0)}_elseif_statement(e=[]){const t=this._optional_paren_expression(),n=this._compound_statement();return e.push(this._updateNode(new jd(t,n))),this._match_elseif()&&(this._check(d.tokens.attr)&&this._attribute(),this._elseif_statement(e)),e}_return_statement(){if(!this._match(d.keywords.return))return null;const e=this._short_circuit_or_expression();return this._updateNode(new cc(e))}_short_circuit_or_expression(){let e=this._short_circuit_and_expr();for(;this._match(d.tokens.or_or);)e=this._updateNode(new Ee(this._previous().toString(),e,this._short_circuit_and_expr()));return e}_short_circuit_and_expr(){let e=this._inclusive_or_expression();for(;this._match(d.tokens.and_and);)e=this._updateNode(new Ee(this._previous().toString(),e,this._inclusive_or_expression()));return e}_inclusive_or_expression(){let e=this._exclusive_or_expression();for(;this._match(d.tokens.or);)e=this._updateNode(new Ee(this._previous().toString(),e,this._exclusive_or_expression()));return e}_exclusive_or_expression(){let e=this._and_expression();for(;this._match(d.tokens.xor);)e=this._updateNode(new Ee(this._previous().toString(),e,this._and_expression()));return e}_and_expression(){let e=this._equality_expression();for(;this._match(d.tokens.and);)e=this._updateNode(new Ee(this._previous().toString(),e,this._equality_expression()));return e}_equality_expression(){const e=this._relational_expression();return this._match([d.tokens.equal_equal,d.tokens.not_equal])?this._updateNode(new Ee(this._previous().toString(),e,this._relational_expression())):e}_relational_expression(){let e=this._shift_expression();for(;this._match([d.tokens.less_than,d.tokens.greater_than,d.tokens.less_than_equal,d.tokens.greater_than_equal]);)e=this._updateNode(new Ee(this._previous().toString(),e,this._shift_expression()));return e}_shift_expression(){let e=this._additive_expression();for(;this._match([d.tokens.shift_left,d.tokens.shift_right]);)e=this._updateNode(new Ee(this._previous().toString(),e,this._additive_expression()));return e}_additive_expression(){let e=this._multiplicative_expression();for(;this._match([d.tokens.plus,d.tokens.minus]);)e=this._updateNode(new Ee(this._previous().toString(),e,this._multiplicative_expression()));return e}_multiplicative_expression(){let e=this._unary_expression();for(;this._match([d.tokens.star,d.tokens.forward_slash,d.tokens.modulo]);)e=this._updateNode(new Ee(this._previous().toString(),e,this._unary_expression()));return e}_unary_expression(){return this._match([d.tokens.minus,d.tokens.bang,d.tokens.tilde,d.tokens.star,d.tokens.and])?this._updateNode(new se(this._previous().toString(),this._unary_expression())):this._singular_expression()}_singular_expression(){const e=this._primary_expression(),t=this._postfix_expression();return t&&(e.postfix=t),e}_postfix_expression(){if(this._match(d.tokens.bracket_left)){const e=this._short_circuit_or_expression();this._consume(d.tokens.bracket_right,"Expected ']'.");const t=this._updateNode(new Mt(e)),n=this._postfix_expression();return n&&(t.postfix=n),t}if(this._match(d.tokens.period)){const e=this._consume(d.tokens.name,"Expected member name."),t=this._postfix_expression(),n=this._updateNode(new lt(e.lexeme));return t&&(n.postfix=t),n}return null}_getStruct(e){return this._context.aliases.has(e)?this._context.aliases.get(e).type:this._context.structs.has(e)?this._context.structs.get(e):null}_getType(e){const t=this._getStruct(e);if(t!==null)return t;switch(e){case"void":return R.void;case"bool":return R.bool;case"i32":return R.i32;case"u32":return R.u32;case"f32":return R.f32;case"f16":return R.f16;case"vec2f":return T.vec2f;case"vec3f":return T.vec3f;case"vec4f":return T.vec4f;case"vec2i":return T.vec2i;case"vec3i":return T.vec3i;case"vec4i":return T.vec4i;case"vec2u":return T.vec2u;case"vec3u":return T.vec3u;case"vec4u":return T.vec4u;case"vec2h":return T.vec2h;case"vec3h":return T.vec3h;case"vec4h":return T.vec4h;case"mat2x2f":return T.mat2x2f;case"mat2x3f":return T.mat2x3f;case"mat2x4f":return T.mat2x4f;case"mat3x2f":return T.mat3x2f;case"mat3x3f":return T.mat3x3f;case"mat3x4f":return T.mat3x4f;case"mat4x2f":return T.mat4x2f;case"mat4x3f":return T.mat4x3f;case"mat4x4f":return T.mat4x4f;case"mat2x2h":return T.mat2x2h;case"mat2x3h":return T.mat2x3h;case"mat2x4h":return T.mat2x4h;case"mat3x2h":return T.mat3x2h;case"mat3x3h":return T.mat3x3h;case"mat3x4h":return T.mat3x4h;case"mat4x2h":return T.mat4x2h;case"mat4x3h":return T.mat4x3h;case"mat4x4h":return T.mat4x4h;case"mat2x2i":return T.mat2x2i;case"mat2x3i":return T.mat2x3i;case"mat2x4i":return T.mat2x4i;case"mat3x2i":return T.mat3x2i;case"mat3x3i":return T.mat3x3i;case"mat3x4i":return T.mat3x4i;case"mat4x2i":return T.mat4x2i;case"mat4x3i":return T.mat4x3i;case"mat4x4i":return T.mat4x4i;case"mat2x2u":return T.mat2x2u;case"mat2x3u":return T.mat2x3u;case"mat2x4u":return T.mat2x4u;case"mat3x2u":return T.mat3x2u;case"mat3x3u":return T.mat3x3u;case"mat3x4u":return T.mat3x4u;case"mat4x2u":return T.mat4x2u;case"mat4x3u":return T.mat4x3u;case"mat4x4u":return T.mat4x4u}return null}_validateTypeRange(e,t){if(t.name==="i32"){if(e<-2147483648||e>2147483647)throw this._error(this._previous(),`Value out of range for i32: ${e}. Line: ${this._currentLine}.`)}else if(t.name==="u32"&&(e<0||e>4294967295))throw this._error(this._previous(),`Value out of range for u32: ${e}. Line: ${this._currentLine}.`)}_primary_expression(){if(this._match(d.tokens.ident)){const n=this._previous().toString();if(this._check(d.tokens.paren_left)){const r=this._argument_expression_list(),i=this._getType(n);return i!==null?this._updateNode(new Me(i,r)):this._updateNode(new Hr(n,r))}if(this._context.constants.has(n)){const r=this._context.constants.get(n);return this._updateNode(new fc(n,r.value))}return this._updateNode(new _e(n))}if(this._match(d.tokens.int_literal)){const n=this._previous().toString();let r=n.endsWith("i")||n.endsWith("i")?R.i32:n.endsWith("u")||n.endsWith("U")?R.u32:R.x32;const i=parseInt(n);return this._validateTypeRange(i,r),this._updateNode(new re(new m(i,this._exec.getTypeInfo(r)),r))}if(this._match(d.tokens.uint_literal)){const n=parseInt(this._previous().toString());return this._validateTypeRange(n,R.u32),this._updateNode(new re(new m(n,this._exec.getTypeInfo(R.u32)),R.u32))}if(this._match([d.tokens.decimal_float_literal,d.tokens.hex_float_literal])){let n=this._previous().toString(),r=n.endsWith("h");r&&(n=n.substring(0,n.length-1));const i=parseFloat(n);this._validateTypeRange(i,r?R.f16:R.f32);const o=r?R.f16:R.f32;return this._updateNode(new re(new m(i,this._exec.getTypeInfo(o)),o))}if(this._match([d.keywords.true,d.keywords.false])){let n=this._previous().toString()===d.keywords.true.rule;return this._updateNode(new re(new m(n?1:0,this._exec.getTypeInfo(R.bool)),R.bool))}if(this._check(d.tokens.paren_left))return this._paren_expression();if(this._match(d.keywords.bitcast)){this._consume(d.tokens.less_than,"Expected '<'.");const n=this._type_decl();this._consume(d.tokens.greater_than,"Expected '>'.");const r=this._paren_expression();return this._updateNode(new dc(n,r))}const e=this._type_decl(),t=this._argument_expression_list();return this._updateNode(new Me(e,t))}_argument_expression_list(){if(!this._match(d.tokens.paren_left))return null;const e=[];do{if(this._check(d.tokens.paren_right))break;const t=this._short_circuit_or_expression();e.push(t)}while(this._match(d.tokens.comma));return this._consume(d.tokens.paren_right,"Expected ')' for agument list"),e}_optional_paren_expression(){this._match(d.tokens.paren_left);const e=this._short_circuit_or_expression();return this._match(d.tokens.paren_right),e}_paren_expression(){this._consume(d.tokens.paren_left,"Expected '('.");const e=this._short_circuit_or_expression();return this._consume(d.tokens.paren_right,"Expected ')'."),e}_struct_decl(){if(!this._match(d.keywords.struct))return null;const e=this._currentLine,t=this._consume(d.tokens.ident,"Expected name for struct.").toString();this._consume(d.tokens.brace_left,"Expected '{' for struct body.");const n=[];for(;!this._check(d.tokens.brace_right);){const o=this._attribute(),a=this._consume(d.tokens.name,"Expected variable name.").toString();this._consume(d.tokens.colon,"Expected ':' for struct member type.");const c=this._attribute(),l=this._type_decl();l!=null&&(l.attributes=c),this._check(d.tokens.brace_right)?this._match(d.tokens.comma):this._consume(d.tokens.comma,"Expected ',' for struct member."),n.push(this._updateNode(new Zi(a,l,o)))}this._consume(d.tokens.brace_right,"Expected '}' after struct body.");const r=this._currentLine,i=this._updateNode(new Fe(t,n,e,r),e);return this._context.structs.set(t,i),i}_global_variable_decl(){const e=this._variable_decl();if(!e)return null;if(this._match(d.tokens.equal)){const t=this._const_expression();e.value=t}if(e.type!==null&&e.value instanceof re){if(e.value.type.name!=="x32"&&e.type.getTypeName()!==e.value.type.getTypeName())throw this._error(this._peek(),`Invalid cast from ${e.value.type.name} to ${e.type.name}. Line:${this._currentLine}`);e.value.isScalar&&this._validateTypeRange(e.value.scalarValue,e.type),e.value.type=e.type}else e.type===null&&e.value instanceof re&&(e.type=e.value.type.name==="x32"?R.i32:e.value.type,e.value.isScalar&&this._validateTypeRange(e.value.scalarValue,e.type));return e}_override_variable_decl(){const e=this._override_decl();return e&&this._match(d.tokens.equal)&&(e.value=this._const_expression()),e}_global_const_decl(){var e;if(!this._match(d.keywords.const))return null;const t=this._consume(d.tokens.name,"Expected variable name"),n=this._currentLine;let r=null;if(this._match(d.tokens.colon)){const c=this._attribute();r=this._type_decl(),r!=null&&(r.attributes=c)}let i=null;this._consume(d.tokens.equal,"const declarations require an assignment");const o=this._short_circuit_or_expression();try{let c=[R.f32],l=o.constEvaluate(this._exec,c);l instanceof m&&this._validateTypeRange(l.value,c[0]),c[0]instanceof T&&c[0].format===null&&l.typeInfo instanceof ct&&l.typeInfo.format!==null&&(l.typeInfo.format.name==="f16"?c[0].format=R.f16:l.typeInfo.format.name==="f32"?c[0].format=R.f32:l.typeInfo.format.name==="i32"?c[0].format=R.i32:l.typeInfo.format.name==="u32"?c[0].format=R.u32:l.typeInfo.format.name==="bool"?c[0].format=R.bool:console.error(`TODO: impelement template format type ${l.typeInfo.format.name}`)),i=this._updateNode(new re(l,c[0])),this._exec.context.setVariable(t.toString(),l)}catch{i=o}if(r!==null&&i instanceof re){if(i.type.name!=="x32"&&r.getTypeName()!==i.type.getTypeName())throw this._error(this._peek(),`Invalid cast from ${i.type.name} to ${r.name}. Line:${this._currentLine}`);i.type=r,i.isScalar&&this._validateTypeRange(i.scalarValue,i.type)}else r===null&&i instanceof re&&(r=(e=i?.type)!==null&&e!==void 0?e:R.f32,r===R.x32&&(r=R.i32));const a=this._updateNode(new Rs(t.toString(),r,"","",i),n);return this._context.constants.set(a.name,a),a}_global_let_decl(){if(!this._match(d.keywords.let))return null;const e=this._currentLine,t=this._consume(d.tokens.name,"Expected variable name");let n=null;if(this._match(d.tokens.colon)){const i=this._attribute();n=this._type_decl(),n!=null&&(n.attributes=i)}let r=null;if(this._match(d.tokens.equal)&&(r=this._const_expression()),n!==null&&r instanceof re){if(r.type.name!=="x32"&&n.getTypeName()!==r.type.getTypeName())throw this._error(this._peek(),`Invalid cast from ${r.type.name} to ${n.name}. Line:${this._currentLine}`);r.type=n}else n===null&&r instanceof re&&(n=r.type.name==="x32"?R.i32:r.type);return r instanceof re&&r.isScalar&&this._validateTypeRange(r.scalarValue,n),this._updateNode(new Qt(t.toString(),n,"","",r),e)}_const_expression(){return this._short_circuit_or_expression()}_variable_decl(){if(!this._match(d.keywords.var))return null;const e=this._currentLine;let t="",n="";this._match(d.tokens.less_than)&&(t=this._consume(d.storage_class,"Expected storage_class.").toString(),this._match(d.tokens.comma)&&(n=this._consume(d.access_mode,"Expected access_mode.").toString()),this._consume(d.tokens.greater_than,"Expected '>'."));const r=this._consume(d.tokens.name,"Expected variable name");let i=null;if(this._match(d.tokens.colon)){const o=this._attribute();i=this._type_decl(),i!=null&&(i.attributes=o)}return this._updateNode(new Ue(r.toString(),i,t,n,null),e)}_override_decl(){if(!this._match(d.keywords.override))return null;const e=this._consume(d.tokens.name,"Expected variable name");let t=null;if(this._match(d.tokens.colon)){const n=this._attribute();t=this._type_decl(),t!=null&&(t.attributes=n)}return this._updateNode(new $r(e.toString(),t,null))}_diagnostic(){this._consume(d.tokens.paren_left,"Expected '('");const e=this._consume(d.tokens.ident,"Expected severity control name.");this._consume(d.tokens.comma,"Expected ','");let t=this._consume(d.tokens.ident,"Expected diagnostic rule name.").toString();return this._match(d.tokens.period)&&(t+=`.${this._consume(d.tokens.ident,"Expected diagnostic message.").toString()}`),this._consume(d.tokens.paren_right,"Expected ')'"),this._updateNode(new lc(e.toString(),t))}_enable_directive(){const e=this._consume(d.tokens.ident,"identity expected.");return this._updateNode(new Vd(e.toString()))}_requires_directive(){const e=[this._consume(d.tokens.ident,"identity expected.").toString()];for(;this._match(d.tokens.comma);){const t=this._consume(d.tokens.ident,"identity expected.");e.push(t.toString())}return this._updateNode(new $d(e))}_type_alias(){const e=this._consume(d.tokens.ident,"identity expected.");this._consume(d.tokens.equal,"Expected '=' for type alias.");let t=this._type_decl();if(t===null)throw this._error(this._peek(),"Expected Type for Alias.");this._context.aliases.has(t.name)&&(t=this._context.aliases.get(t.name).type);const n=this._updateNode(new jr(e.toString(),t));return this._context.aliases.set(n.name,n),n}_type_decl(){if(this._check([d.tokens.ident,...d.texel_format,d.keywords.bool,d.keywords.f32,d.keywords.i32,d.keywords.u32])){const n=this._advance().toString();if(this._context.structs.has(n))return this._context.structs.get(n);if(this._context.aliases.has(n))return this._context.aliases.get(n).type;if(!this._getType(n)){const r=this._updateNode(new qi(n));return this._forwardTypeCount++,r}return this._updateNode(new R(n))}let e=this._texture_sampler_types();if(e)return e;if(this._check(d.template_types)){let n=this._advance().toString(),r=null,i=null;return this._match(d.tokens.less_than)&&(r=this._type_decl(),i=null,this._match(d.tokens.comma)&&(i=this._consume(d.access_mode,"Expected access_mode for pointer").toString()),this._consume(d.tokens.greater_than,"Expected '>' for type.")),this._updateNode(new T(n,r,i))}if(this._match(d.keywords.ptr)){let n=this._previous().toString();this._consume(d.tokens.less_than,"Expected '<' for pointer.");const r=this._consume(d.storage_class,"Expected storage_class for pointer");this._consume(d.tokens.comma,"Expected ',' for pointer.");const i=this._type_decl();let o=null;return this._match(d.tokens.comma)&&(o=this._consume(d.access_mode,"Expected access_mode for pointer").toString()),this._consume(d.tokens.greater_than,"Expected '>' for pointer."),this._updateNode(new Is(n,r.toString(),i,o))}const t=this._attribute();if(this._match(d.keywords.array)){let n=null,r=-1;const i=this._previous();let o=null;if(this._match(d.tokens.less_than)){n=this._type_decl(),this._context.aliases.has(n.name)&&(n=this._context.aliases.get(n.name).type);let c="";if(this._match(d.tokens.comma)){o=this._shift_expression();try{c=o.constEvaluate(this._exec).toString(),o=null}catch{c="1"}}this._consume(d.tokens.greater_than,"Expected '>' for array."),r=c?parseInt(c):0}const a=this._updateNode(new Jt(i.toString(),t,n,r));return o&&this._deferArrayCountEval.push({arrayType:a,countNode:o}),a}return null}_texture_sampler_types(){if(this._match(d.sampler_type))return this._updateNode(new zt(this._previous().toString(),null,null));if(this._match(d.depth_texture_type))return this._updateNode(new zt(this._previous().toString(),null,null));if(this._match(d.sampled_texture_type)||this._match(d.multisampled_texture_type)){const e=this._previous();this._consume(d.tokens.less_than,"Expected '<' for sampler type.");const t=this._type_decl();return this._consume(d.tokens.greater_than,"Expected '>' for sampler type."),this._updateNode(new zt(e.toString(),t,null))}if(this._match(d.storage_texture_type)){const e=this._previous();this._consume(d.tokens.less_than,"Expected '<' for sampler type.");const t=this._consume(d.texel_format,"Invalid texel format.").toString();this._consume(d.tokens.comma,"Expected ',' after texel format.");const n=this._consume(d.access_mode,"Expected access mode for storage texture type.").toString();return this._consume(d.tokens.greater_than,"Expected '>' for sampler type."),this._updateNode(new zt(e.toString(),t,n))}return null}_attribute(){let e=[];for(;this._match(d.tokens.attr);){const t=this._consume(d.attribute_name,"Expected attribute name"),n=this._updateNode(new bc(t.toString(),null));if(this._match(d.tokens.paren_left)){if(n.value=this._consume(d.literal_or_ident,"Expected attribute value").toString(),this._check(d.tokens.comma)){this._advance();do{const r=this._consume(d.literal_or_ident,"Expected attribute value").toString();n.value instanceof Array||(n.value=[n.value]),n.value.push(r)}while(this._match(d.tokens.comma))}this._consume(d.tokens.paren_right,"Expected ')'")}e.push(n)}return e.length==0?null:e}}class np extends ke{constructor(e){super(),e&&this.update(e)}update(e){const t=new sp().parse(e);this.updateAST(t)}}function rp(s){const e={attributes:[],bindings:[]};let t;try{t=ip(s)}catch(i){return C.error(i.message)(),e}for(const i of t.uniforms){const o=[];for(const a of i.type?.members||[])o.push({name:a.name,type:Gi(a.type)});e.bindings.push({type:"uniform",name:i.name,group:i.group,location:i.binding,members:o})}for(const i of t.textures)e.bindings.push({type:"texture",name:i.name,group:i.group,location:i.binding});for(const i of t.samplers)e.bindings.push({type:"sampler",name:i.name,group:i.group,location:i.binding});const n=t.entry.vertex[0],r=n?.inputs.length||0;for(let i=0;i<r;i++){const o=n.inputs[i];if(o.locationType==="location"){const a=Gi(o.type);e.attributes.push({name:o.name,location:Number(o.location),type:a})}}return e}function Gi(s){return s.format?`${s.name}<${s.format.name}>`:s.name}function ip(s){try{return new np(s)}catch(e){if(e instanceof Error)throw e;let t="WGSL parse error";throw typeof e=="object"&&e?.message&&(t+=`: ${e.message} `),typeof e=="object"&&e?.token&&(t+=e.token.line||""),new Error(t,{cause:e})}}const op={EPSILON:1e-12,debug:!1,precision:4,printTypes:!1,printDegrees:!1,printRowMajor:!0,_cartographicRadians:!1};globalThis.mathgl=globalThis.mathgl||{config:{...op}};const ye=globalThis.mathgl.config;function ap(s,{precision:e=ye.precision}={}){return s=cp(s),`${parseFloat(s.toPrecision(e))}`}function Ot(s){return Array.isArray(s)||ArrayBuffer.isView(s)&&!(s instanceof DataView)}function Ye(s,e,t){return up(s,n=>Math.max(e,Math.min(t,n)))}function Hs(s,e,t){return Ot(s)?s.map((n,r)=>Hs(n,e[r],t)):t*e+(1-t)*s}function rs(s,e,t){const n=ye.EPSILON;try{if(s===e)return!0;if(Ot(s)&&Ot(e)){if(s.length!==e.length)return!1;for(let r=0;r<s.length;++r)if(!rs(s[r],e[r]))return!1;return!0}return s&&s.equals?s.equals(e):e&&e.equals?e.equals(s):typeof s=="number"&&typeof e=="number"?Math.abs(s-e)<=ye.EPSILON*Math.max(1,Math.abs(s),Math.abs(e)):!1}finally{ye.EPSILON=n}}function cp(s){return Math.round(s/ye.EPSILON)*ye.EPSILON}function lp(s){return s.clone?s.clone():new Array(s.length)}function up(s,e,t){if(Ot(s)){const n=s;t=t||lp(n);for(let r=0;r<t.length&&r<n.length;++r){const i=typeof s=="number"?s:s[r];t[r]=e(i,r,t)}return t}return e(s)}class yc extends Array{clone(){return new this.constructor().copy(this)}fromArray(e,t=0){for(let n=0;n<this.ELEMENTS;++n)this[n]=e[n+t];return this.check()}toArray(e=[],t=0){for(let n=0;n<this.ELEMENTS;++n)e[t+n]=this[n];return e}toObject(e){return e}from(e){return Array.isArray(e)?this.copy(e):this.fromObject(e)}to(e){return e===this?this:Ot(e)?this.toArray(e):this.toObject(e)}toTarget(e){return e?this.to(e):this}toFloat32Array(){return new Float32Array(this)}toString(){return this.formatString(ye)}formatString(e){let t="";for(let n=0;n<this.ELEMENTS;++n)t+=(n>0?", ":"")+ap(this[n],e);return`${e.printTypes?this.constructor.name:""}[${t}]`}equals(e){if(!e||this.length!==e.length)return!1;for(let t=0;t<this.ELEMENTS;++t)if(!rs(this[t],e[t]))return!1;return!0}exactEquals(e){if(!e||this.length!==e.length)return!1;for(let t=0;t<this.ELEMENTS;++t)if(this[t]!==e[t])return!1;return!0}negate(){for(let e=0;e<this.ELEMENTS;++e)this[e]=-this[e];return this.check()}lerp(e,t,n){if(n===void 0)return this.lerp(this,e,t);for(let r=0;r<this.ELEMENTS;++r){const i=e[r],o=typeof t=="number"?t:t[r];this[r]=i+n*(o-i)}return this.check()}min(e){for(let t=0;t<this.ELEMENTS;++t)this[t]=Math.min(e[t],this[t]);return this.check()}max(e){for(let t=0;t<this.ELEMENTS;++t)this[t]=Math.max(e[t],this[t]);return this.check()}clamp(e,t){for(let n=0;n<this.ELEMENTS;++n)this[n]=Math.min(Math.max(this[n],e[n]),t[n]);return this.check()}add(...e){for(const t of e)for(let n=0;n<this.ELEMENTS;++n)this[n]+=t[n];return this.check()}subtract(...e){for(const t of e)for(let n=0;n<this.ELEMENTS;++n)this[n]-=t[n];return this.check()}scale(e){if(typeof e=="number")for(let t=0;t<this.ELEMENTS;++t)this[t]*=e;else for(let t=0;t<this.ELEMENTS&&t<e.length;++t)this[t]*=e[t];return this.check()}multiplyByScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]*=e;return this.check()}check(){if(ye.debug&&!this.validate())throw new Error(`math.gl: ${this.constructor.name} some fields set to invalid numbers'`);return this}validate(){let e=this.length===this.ELEMENTS;for(let t=0;t<this.ELEMENTS;++t)e=e&&Number.isFinite(this[t]);return e}sub(e){return this.subtract(e)}setScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]=e;return this.check()}addScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]+=e;return this.check()}subScalar(e){return this.addScalar(-e)}multiplyScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]*=e;return this.check()}divideScalar(e){return this.multiplyByScalar(1/e)}clampScalar(e,t){for(let n=0;n<this.ELEMENTS;++n)this[n]=Math.min(Math.max(this[n],e),t);return this.check()}get elements(){return this}}function hp(s,e){if(s.length!==e)return!1;for(let t=0;t<s.length;++t)if(!Number.isFinite(s[t]))return!1;return!0}function ge(s){if(!Number.isFinite(s))throw new Error(`Invalid number ${JSON.stringify(s)}`);return s}function Rn(s,e,t=""){if(ye.debug&&!hp(s,e))throw new Error(`math.gl: ${t} some fields set to invalid numbers'`);return s}function eo(s,e){if(!s)throw new Error(`math.gl assertion ${e}`)}class fp extends yc{get x(){return this[0]}set x(e){this[0]=ge(e)}get y(){return this[1]}set y(e){this[1]=ge(e)}len(){return Math.sqrt(this.lengthSquared())}magnitude(){return this.len()}lengthSquared(){let e=0;for(let t=0;t<this.ELEMENTS;++t)e+=this[t]*this[t];return e}magnitudeSquared(){return this.lengthSquared()}distance(e){return Math.sqrt(this.distanceSquared(e))}distanceSquared(e){let t=0;for(let n=0;n<this.ELEMENTS;++n){const r=this[n]-e[n];t+=r*r}return ge(t)}dot(e){let t=0;for(let n=0;n<this.ELEMENTS;++n)t+=this[n]*e[n];return ge(t)}normalize(){const e=this.magnitude();if(e!==0)for(let t=0;t<this.ELEMENTS;++t)this[t]/=e;return this.check()}multiply(...e){for(const t of e)for(let n=0;n<this.ELEMENTS;++n)this[n]*=t[n];return this.check()}divide(...e){for(const t of e)for(let n=0;n<this.ELEMENTS;++n)this[n]/=t[n];return this.check()}lengthSq(){return this.lengthSquared()}distanceTo(e){return this.distance(e)}distanceToSquared(e){return this.distanceSquared(e)}getComponent(e){return eo(e>=0&&e<this.ELEMENTS,"index is out of range"),ge(this[e])}setComponent(e,t){return eo(e>=0&&e<this.ELEMENTS,"index is out of range"),this[e]=t,this.check()}addVectors(e,t){return this.copy(e).add(t)}subVectors(e,t){return this.copy(e).subtract(t)}multiplyVectors(e,t){return this.copy(e).multiply(t)}addScaledVector(e,t){return this.add(new this.constructor(e).multiplyScalar(t))}}const te=1e-6;let kt=typeof Float32Array<"u"?Float32Array:Array;function dp(){const s=new kt(2);return kt!=Float32Array&&(s[0]=0,s[1]=0),s}function to(s,e,t){return s[0]=e[0]+t[0],s[1]=e[1]+t[1],s}function pp(s,e){return s[0]=-e[0],s[1]=-e[1],s}function Tc(s,e,t,n){const r=e[0],i=e[1];return s[0]=r+n*(t[0]-r),s[1]=i+n*(t[1]-i),s}function gp(s,e,t){const n=e[0],r=e[1];return s[0]=t[0]*n+t[4]*r+t[12],s[1]=t[1]*n+t[5]*r+t[13],s}(function(){const s=dp();return function(e,t,n,r,i,o){let a,c;for(t||(t=2),n||(n=0),r?c=Math.min(r*t+n,e.length):c=e.length,a=n;a<c;a+=t)s[0]=e[a],s[1]=e[a+1],i(s,s,o),e[a]=s[0],e[a+1]=s[1];return e}})();function _p(s,e,t){const n=e[0],r=e[1],i=t[3]*n+t[7]*r||1;return s[0]=(t[0]*n+t[4]*r)/i,s[1]=(t[1]*n+t[5]*r)/i,s}function wc(s,e,t){const n=e[0],r=e[1],i=e[2],o=t[3]*n+t[7]*r+t[11]*i||1;return s[0]=(t[0]*n+t[4]*r+t[8]*i)/o,s[1]=(t[1]*n+t[5]*r+t[9]*i)/o,s[2]=(t[2]*n+t[6]*r+t[10]*i)/o,s}function mp(s,e,t){const n=e[0],r=e[1];return s[0]=t[0]*n+t[2]*r,s[1]=t[1]*n+t[3]*r,s[2]=e[2],s}function bp(){const s=new kt(3);return kt!=Float32Array&&(s[0]=0,s[1]=0,s[2]=0),s}function yp(s){const e=s[0],t=s[1],n=s[2];return Math.sqrt(e*e+t*t+n*n)}function G3(s,e,t){return s[0]=e[0]+t[0],s[1]=e[1]+t[1],s[2]=e[2]+t[2],s}function Tp(s,e,t){return s[0]=e[0]-t[0],s[1]=e[1]-t[1],s[2]=e[2]-t[2],s}function wp(s,e,t){return s[0]=e[0]*t[0],s[1]=e[1]*t[1],s[2]=e[2]*t[2],s}function vp(s,e){const t=e[0]-s[0],n=e[1]-s[1],r=e[2]-s[2];return Math.sqrt(t*t+n*n+r*r)}function Ap(s){const e=s[0],t=s[1],n=s[2];return e*e+t*t+n*n}function xp(s,e){return s[0]=-e[0],s[1]=-e[1],s[2]=-e[2],s}function Ep(s,e){return s[0]*e[0]+s[1]*e[1]+s[2]*e[2]}function Sp(s,e,t){const n=e[0],r=e[1],i=e[2],o=t[0],a=t[1],c=t[2];return s[0]=r*c-i*a,s[1]=i*o-n*c,s[2]=n*a-r*o,s}function ew(s,e,t,n){const r=e[0],i=e[1],o=e[2];return s[0]=r+n*(t[0]-r),s[1]=i+n*(t[1]-i),s[2]=o+n*(t[2]-o),s}function vc(s,e,t){const n=e[0],r=e[1],i=e[2];let o=t[3]*n+t[7]*r+t[11]*i+t[15];return o=o||1,s[0]=(t[0]*n+t[4]*r+t[8]*i+t[12])/o,s[1]=(t[1]*n+t[5]*r+t[9]*i+t[13])/o,s[2]=(t[2]*n+t[6]*r+t[10]*i+t[14])/o,s}function Rp(s,e,t){const n=e[0],r=e[1],i=e[2];return s[0]=n*t[0]+r*t[3]+i*t[6],s[1]=n*t[1]+r*t[4]+i*t[7],s[2]=n*t[2]+r*t[5]+i*t[8],s}function Ip(s,e,t){const n=t[0],r=t[1],i=t[2],o=t[3],a=e[0],c=e[1],l=e[2];let u=r*l-i*c,h=i*a-n*l,f=n*c-r*a,g=r*f-i*h,_=i*u-n*f,w=n*h-r*u;const A=o*2;return u*=A,h*=A,f*=A,g*=2,_*=2,w*=2,s[0]=a+u+g,s[1]=c+h+_,s[2]=l+f+w,s}function Cp(s,e,t,n){const r=[],i=[];return r[0]=e[0]-t[0],r[1]=e[1]-t[1],r[2]=e[2]-t[2],i[0]=r[0],i[1]=r[1]*Math.cos(n)-r[2]*Math.sin(n),i[2]=r[1]*Math.sin(n)+r[2]*Math.cos(n),s[0]=i[0]+t[0],s[1]=i[1]+t[1],s[2]=i[2]+t[2],s}function Pp(s,e,t,n){const r=[],i=[];return r[0]=e[0]-t[0],r[1]=e[1]-t[1],r[2]=e[2]-t[2],i[0]=r[2]*Math.sin(n)+r[0]*Math.cos(n),i[1]=r[1],i[2]=r[2]*Math.cos(n)-r[0]*Math.sin(n),s[0]=i[0]+t[0],s[1]=i[1]+t[1],s[2]=i[2]+t[2],s}function Mp(s,e,t,n){const r=[],i=[];return r[0]=e[0]-t[0],r[1]=e[1]-t[1],r[2]=e[2]-t[2],i[0]=r[0]*Math.cos(n)-r[1]*Math.sin(n),i[1]=r[0]*Math.sin(n)+r[1]*Math.cos(n),i[2]=r[2],s[0]=i[0]+t[0],s[1]=i[1]+t[1],s[2]=i[2]+t[2],s}function Op(s,e){const t=s[0],n=s[1],r=s[2],i=e[0],o=e[1],a=e[2],c=Math.sqrt((t*t+n*n+r*r)*(i*i+o*o+a*a)),l=c&&Ep(s,e)/c;return Math.acos(Math.min(Math.max(l,-1),1))}const kp=Tp,tw=wp,sw=vp,nw=yp,rw=Ap;(function(){const s=bp();return function(e,t,n,r,i,o){let a,c;for(t||(t=3),n||(n=0),r?c=Math.min(r*t+n,e.length):c=e.length,a=n;a<c;a+=t)s[0]=e[a],s[1]=e[a+1],s[2]=e[a+2],i(s,s,o),e[a]=s[0],e[a+1]=s[1],e[a+2]=s[2];return e}})();const In=[0,0,0];let bs;class Ne extends fp{static get ZERO(){return bs||(bs=new Ne(0,0,0),Object.freeze(bs)),bs}constructor(e=0,t=0,n=0){super(-0,-0,-0),arguments.length===1&&Ot(e)?this.copy(e):(ye.debug&&(ge(e),ge(t),ge(n)),this[0]=e,this[1]=t,this[2]=n)}set(e,t,n){return this[0]=e,this[1]=t,this[2]=n,this.check()}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this.check()}fromObject(e){return ye.debug&&(ge(e.x),ge(e.y),ge(e.z)),this[0]=e.x,this[1]=e.y,this[2]=e.z,this.check()}toObject(e){return e.x=this[0],e.y=this[1],e.z=this[2],e}get ELEMENTS(){return 3}get z(){return this[2]}set z(e){this[2]=ge(e)}angle(e){return Op(this,e)}cross(e){return Sp(this,this,e),this.check()}rotateX({radians:e,origin:t=In}){return Cp(this,this,t,e),this.check()}rotateY({radians:e,origin:t=In}){return Pp(this,this,t,e),this.check()}rotateZ({radians:e,origin:t=In}){return Mp(this,this,t,e),this.check()}transform(e){return this.transformAsPoint(e)}transformAsPoint(e){return vc(this,this,e),this.check()}transformAsVector(e){return wc(this,this,e),this.check()}transformByMatrix3(e){return Rp(this,this,e),this.check()}transformByMatrix2(e){return mp(this,this,e),this.check()}transformByQuaternion(e){return Ip(this,this,e),this.check()}}class Np extends yc{toString(){let e="[";if(ye.printRowMajor){e+="row-major:";for(let t=0;t<this.RANK;++t)for(let n=0;n<this.RANK;++n)e+=` ${this[n*this.RANK+t]}`}else{e+="column-major:";for(let t=0;t<this.ELEMENTS;++t)e+=` ${this[t]}`}return e+="]",e}getElementIndex(e,t){return t*this.RANK+e}getElement(e,t){return this[t*this.RANK+e]}setElement(e,t,n){return this[t*this.RANK+e]=ge(n),this}getColumn(e,t=new Array(this.RANK).fill(-0)){const n=e*this.RANK;for(let r=0;r<this.RANK;++r)t[r]=this[n+r];return t}setColumn(e,t){const n=e*this.RANK;for(let r=0;r<this.RANK;++r)this[n+r]=t[r];return this}}function Dp(s){return s[0]=1,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=1,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=1,s[11]=0,s[12]=0,s[13]=0,s[14]=0,s[15]=1,s}function Fp(s,e){if(s===e){const t=e[1],n=e[2],r=e[3],i=e[6],o=e[7],a=e[11];s[1]=e[4],s[2]=e[8],s[3]=e[12],s[4]=t,s[6]=e[9],s[7]=e[13],s[8]=n,s[9]=i,s[11]=e[14],s[12]=r,s[13]=o,s[14]=a}else s[0]=e[0],s[1]=e[4],s[2]=e[8],s[3]=e[12],s[4]=e[1],s[5]=e[5],s[6]=e[9],s[7]=e[13],s[8]=e[2],s[9]=e[6],s[10]=e[10],s[11]=e[14],s[12]=e[3],s[13]=e[7],s[14]=e[11],s[15]=e[15];return s}function nr(s,e){const t=e[0],n=e[1],r=e[2],i=e[3],o=e[4],a=e[5],c=e[6],l=e[7],u=e[8],h=e[9],f=e[10],g=e[11],_=e[12],w=e[13],A=e[14],S=e[15],I=t*a-n*o,x=t*c-r*o,E=t*l-i*o,P=n*c-r*a,M=n*l-i*a,D=r*l-i*c,B=u*w-h*_,N=u*A-f*_,U=u*S-g*_,L=h*A-f*w,Z=h*S-g*w,Q=f*S-g*A;let V=I*Q-x*Z+E*L+P*U-M*N+D*B;return V?(V=1/V,s[0]=(a*Q-c*Z+l*L)*V,s[1]=(r*Z-n*Q-i*L)*V,s[2]=(w*D-A*M+S*P)*V,s[3]=(f*M-h*D-g*P)*V,s[4]=(c*U-o*Q-l*N)*V,s[5]=(t*Q-r*U+i*N)*V,s[6]=(A*E-_*D-S*x)*V,s[7]=(u*D-f*E+g*x)*V,s[8]=(o*Z-a*U+l*B)*V,s[9]=(n*U-t*Z-i*B)*V,s[10]=(_*M-w*E+S*I)*V,s[11]=(h*E-u*M-g*I)*V,s[12]=(a*N-o*L-c*B)*V,s[13]=(t*L-n*N+r*B)*V,s[14]=(w*x-_*P-A*I)*V,s[15]=(u*P-h*x+f*I)*V,s):null}function Bp(s){const e=s[0],t=s[1],n=s[2],r=s[3],i=s[4],o=s[5],a=s[6],c=s[7],l=s[8],u=s[9],h=s[10],f=s[11],g=s[12],_=s[13],w=s[14],A=s[15],S=e*o-t*i,I=e*a-n*i,x=t*a-n*o,E=l*_-u*g,P=l*w-h*g,M=u*w-h*_,D=e*M-t*P+n*E,B=i*M-o*P+a*E,N=l*x-u*I+h*S,U=g*x-_*I+w*S;return c*D-r*B+A*N-f*U}function rt(s,e,t){const n=e[0],r=e[1],i=e[2],o=e[3],a=e[4],c=e[5],l=e[6],u=e[7],h=e[8],f=e[9],g=e[10],_=e[11],w=e[12],A=e[13],S=e[14],I=e[15];let x=t[0],E=t[1],P=t[2],M=t[3];return s[0]=x*n+E*a+P*h+M*w,s[1]=x*r+E*c+P*f+M*A,s[2]=x*i+E*l+P*g+M*S,s[3]=x*o+E*u+P*_+M*I,x=t[4],E=t[5],P=t[6],M=t[7],s[4]=x*n+E*a+P*h+M*w,s[5]=x*r+E*c+P*f+M*A,s[6]=x*i+E*l+P*g+M*S,s[7]=x*o+E*u+P*_+M*I,x=t[8],E=t[9],P=t[10],M=t[11],s[8]=x*n+E*a+P*h+M*w,s[9]=x*r+E*c+P*f+M*A,s[10]=x*i+E*l+P*g+M*S,s[11]=x*o+E*u+P*_+M*I,x=t[12],E=t[13],P=t[14],M=t[15],s[12]=x*n+E*a+P*h+M*w,s[13]=x*r+E*c+P*f+M*A,s[14]=x*i+E*l+P*g+M*S,s[15]=x*o+E*u+P*_+M*I,s}function zs(s,e,t){const n=t[0],r=t[1],i=t[2];let o,a,c,l,u,h,f,g,_,w,A,S;return e===s?(s[12]=e[0]*n+e[4]*r+e[8]*i+e[12],s[13]=e[1]*n+e[5]*r+e[9]*i+e[13],s[14]=e[2]*n+e[6]*r+e[10]*i+e[14],s[15]=e[3]*n+e[7]*r+e[11]*i+e[15]):(o=e[0],a=e[1],c=e[2],l=e[3],u=e[4],h=e[5],f=e[6],g=e[7],_=e[8],w=e[9],A=e[10],S=e[11],s[0]=o,s[1]=a,s[2]=c,s[3]=l,s[4]=u,s[5]=h,s[6]=f,s[7]=g,s[8]=_,s[9]=w,s[10]=A,s[11]=S,s[12]=o*n+u*r+_*i+e[12],s[13]=a*n+h*r+w*i+e[13],s[14]=c*n+f*r+A*i+e[14],s[15]=l*n+g*r+S*i+e[15]),s}function Kr(s,e,t){const n=t[0],r=t[1],i=t[2];return s[0]=e[0]*n,s[1]=e[1]*n,s[2]=e[2]*n,s[3]=e[3]*n,s[4]=e[4]*r,s[5]=e[5]*r,s[6]=e[6]*r,s[7]=e[7]*r,s[8]=e[8]*i,s[9]=e[9]*i,s[10]=e[10]*i,s[11]=e[11]*i,s[12]=e[12],s[13]=e[13],s[14]=e[14],s[15]=e[15],s}function Up(s,e,t,n){let r=n[0],i=n[1],o=n[2],a=Math.sqrt(r*r+i*i+o*o),c,l,u,h,f,g,_,w,A,S,I,x,E,P,M,D,B,N,U,L,Z,Q,V,Ae;return a<te?null:(a=1/a,r*=a,i*=a,o*=a,l=Math.sin(t),c=Math.cos(t),u=1-c,h=e[0],f=e[1],g=e[2],_=e[3],w=e[4],A=e[5],S=e[6],I=e[7],x=e[8],E=e[9],P=e[10],M=e[11],D=r*r*u+c,B=i*r*u+o*l,N=o*r*u-i*l,U=r*i*u-o*l,L=i*i*u+c,Z=o*i*u+r*l,Q=r*o*u+i*l,V=i*o*u-r*l,Ae=o*o*u+c,s[0]=h*D+w*B+x*N,s[1]=f*D+A*B+E*N,s[2]=g*D+S*B+P*N,s[3]=_*D+I*B+M*N,s[4]=h*U+w*L+x*Z,s[5]=f*U+A*L+E*Z,s[6]=g*U+S*L+P*Z,s[7]=_*U+I*L+M*Z,s[8]=h*Q+w*V+x*Ae,s[9]=f*Q+A*V+E*Ae,s[10]=g*Q+S*V+P*Ae,s[11]=_*Q+I*V+M*Ae,e!==s&&(s[12]=e[12],s[13]=e[13],s[14]=e[14],s[15]=e[15]),s)}function Ac(s,e,t){const n=Math.sin(t),r=Math.cos(t),i=e[4],o=e[5],a=e[6],c=e[7],l=e[8],u=e[9],h=e[10],f=e[11];return e!==s&&(s[0]=e[0],s[1]=e[1],s[2]=e[2],s[3]=e[3],s[12]=e[12],s[13]=e[13],s[14]=e[14],s[15]=e[15]),s[4]=i*r+l*n,s[5]=o*r+u*n,s[6]=a*r+h*n,s[7]=c*r+f*n,s[8]=l*r-i*n,s[9]=u*r-o*n,s[10]=h*r-a*n,s[11]=f*r-c*n,s}function Lp(s,e,t){const n=Math.sin(t),r=Math.cos(t),i=e[0],o=e[1],a=e[2],c=e[3],l=e[8],u=e[9],h=e[10],f=e[11];return e!==s&&(s[4]=e[4],s[5]=e[5],s[6]=e[6],s[7]=e[7],s[12]=e[12],s[13]=e[13],s[14]=e[14],s[15]=e[15]),s[0]=i*r-l*n,s[1]=o*r-u*n,s[2]=a*r-h*n,s[3]=c*r-f*n,s[8]=i*n+l*r,s[9]=o*n+u*r,s[10]=a*n+h*r,s[11]=c*n+f*r,s}function xc(s,e,t){const n=Math.sin(t),r=Math.cos(t),i=e[0],o=e[1],a=e[2],c=e[3],l=e[4],u=e[5],h=e[6],f=e[7];return e!==s&&(s[8]=e[8],s[9]=e[9],s[10]=e[10],s[11]=e[11],s[12]=e[12],s[13]=e[13],s[14]=e[14],s[15]=e[15]),s[0]=i*r+l*n,s[1]=o*r+u*n,s[2]=a*r+h*n,s[3]=c*r+f*n,s[4]=l*r-i*n,s[5]=u*r-o*n,s[6]=h*r-a*n,s[7]=f*r-c*n,s}function Vp(s,e){const t=e[0],n=e[1],r=e[2],i=e[3],o=t+t,a=n+n,c=r+r,l=t*o,u=n*o,h=n*a,f=r*o,g=r*a,_=r*c,w=i*o,A=i*a,S=i*c;return s[0]=1-h-_,s[1]=u+S,s[2]=f-A,s[3]=0,s[4]=u-S,s[5]=1-l-_,s[6]=g+w,s[7]=0,s[8]=f+A,s[9]=g-w,s[10]=1-l-h,s[11]=0,s[12]=0,s[13]=0,s[14]=0,s[15]=1,s}function $p(s,e,t,n,r,i,o){const a=1/(t-e),c=1/(r-n),l=1/(i-o);return s[0]=i*2*a,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=i*2*c,s[6]=0,s[7]=0,s[8]=(t+e)*a,s[9]=(r+n)*c,s[10]=(o+i)*l,s[11]=-1,s[12]=0,s[13]=0,s[14]=o*i*2*l,s[15]=0,s}function Wp(s,e,t,n,r){const i=1/Math.tan(e/2);if(s[0]=i/t,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=i,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[11]=-1,s[12]=0,s[13]=0,s[15]=0,r!=null&&r!==1/0){const o=1/(n-r);s[10]=(r+n)*o,s[14]=2*r*n*o}else s[10]=-1,s[14]=-2*n;return s}const Ec=Wp;function jp(s,e,t,n,r,i,o){const a=1/(e-t),c=1/(n-r),l=1/(i-o);return s[0]=-2*a,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=-2*c,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=2*l,s[11]=0,s[12]=(e+t)*a,s[13]=(r+n)*c,s[14]=(o+i)*l,s[15]=1,s}const Hp=jp;function zp(s,e,t,n){let r,i,o,a,c,l,u,h,f,g;const _=e[0],w=e[1],A=e[2],S=n[0],I=n[1],x=n[2],E=t[0],P=t[1],M=t[2];return Math.abs(_-E)<te&&Math.abs(w-P)<te&&Math.abs(A-M)<te?Dp(s):(h=_-E,f=w-P,g=A-M,r=1/Math.sqrt(h*h+f*f+g*g),h*=r,f*=r,g*=r,i=I*g-x*f,o=x*h-S*g,a=S*f-I*h,r=Math.sqrt(i*i+o*o+a*a),r?(r=1/r,i*=r,o*=r,a*=r):(i=0,o=0,a=0),c=f*a-g*o,l=g*i-h*a,u=h*o-f*i,r=Math.sqrt(c*c+l*l+u*u),r?(r=1/r,c*=r,l*=r,u*=r):(c=0,l=0,u=0),s[0]=i,s[1]=c,s[2]=h,s[3]=0,s[4]=o,s[5]=l,s[6]=f,s[7]=0,s[8]=a,s[9]=u,s[10]=g,s[11]=0,s[12]=-(i*_+o*w+a*A),s[13]=-(c*_+l*w+u*A),s[14]=-(h*_+f*w+g*A),s[15]=1,s)}function iw(s,e){const t=s[0],n=s[1],r=s[2],i=s[3],o=s[4],a=s[5],c=s[6],l=s[7],u=s[8],h=s[9],f=s[10],g=s[11],_=s[12],w=s[13],A=s[14],S=s[15],I=e[0],x=e[1],E=e[2],P=e[3],M=e[4],D=e[5],B=e[6],N=e[7],U=e[8],L=e[9],Z=e[10],Q=e[11],V=e[12],Ae=e[13],ci=e[14],li=e[15];return Math.abs(t-I)<=te*Math.max(1,Math.abs(t),Math.abs(I))&&Math.abs(n-x)<=te*Math.max(1,Math.abs(n),Math.abs(x))&&Math.abs(r-E)<=te*Math.max(1,Math.abs(r),Math.abs(E))&&Math.abs(i-P)<=te*Math.max(1,Math.abs(i),Math.abs(P))&&Math.abs(o-M)<=te*Math.max(1,Math.abs(o),Math.abs(M))&&Math.abs(a-D)<=te*Math.max(1,Math.abs(a),Math.abs(D))&&Math.abs(c-B)<=te*Math.max(1,Math.abs(c),Math.abs(B))&&Math.abs(l-N)<=te*Math.max(1,Math.abs(l),Math.abs(N))&&Math.abs(u-U)<=te*Math.max(1,Math.abs(u),Math.abs(U))&&Math.abs(h-L)<=te*Math.max(1,Math.abs(h),Math.abs(L))&&Math.abs(f-Z)<=te*Math.max(1,Math.abs(f),Math.abs(Z))&&Math.abs(g-Q)<=te*Math.max(1,Math.abs(g),Math.abs(Q))&&Math.abs(_-V)<=te*Math.max(1,Math.abs(_),Math.abs(V))&&Math.abs(w-Ae)<=te*Math.max(1,Math.abs(w),Math.abs(Ae))&&Math.abs(A-ci)<=te*Math.max(1,Math.abs(A),Math.abs(ci))&&Math.abs(S-li)<=te*Math.max(1,Math.abs(S),Math.abs(li))}function Xp(){const s=new kt(4);return kt!=Float32Array&&(s[0]=0,s[1]=0,s[2]=0,s[3]=0),s}function Yp(s,e,t){return s[0]=e[0]*t,s[1]=e[1]*t,s[2]=e[2]*t,s[3]=e[3]*t,s}function ls(s,e,t){const n=e[0],r=e[1],i=e[2],o=e[3];return s[0]=t[0]*n+t[4]*r+t[8]*i+t[12]*o,s[1]=t[1]*n+t[5]*r+t[9]*i+t[13]*o,s[2]=t[2]*n+t[6]*r+t[10]*i+t[14]*o,s[3]=t[3]*n+t[7]*r+t[11]*i+t[15]*o,s}(function(){const s=Xp();return function(e,t,n,r,i,o){let a,c;for(t||(t=4),n||(n=0),r?c=Math.min(r*t+n,e.length):c=e.length,a=n;a<c;a+=t)s[0]=e[a],s[1]=e[a+1],s[2]=e[a+2],s[3]=e[a+3],i(s,s,o),e[a]=s[0],e[a+1]=s[1],e[a+2]=s[2],e[a+3]=s[3];return e}})();var rr;(function(s){s[s.COL0ROW0=0]="COL0ROW0",s[s.COL0ROW1=1]="COL0ROW1",s[s.COL0ROW2=2]="COL0ROW2",s[s.COL0ROW3=3]="COL0ROW3",s[s.COL1ROW0=4]="COL1ROW0",s[s.COL1ROW1=5]="COL1ROW1",s[s.COL1ROW2=6]="COL1ROW2",s[s.COL1ROW3=7]="COL1ROW3",s[s.COL2ROW0=8]="COL2ROW0",s[s.COL2ROW1=9]="COL2ROW1",s[s.COL2ROW2=10]="COL2ROW2",s[s.COL2ROW3=11]="COL2ROW3",s[s.COL3ROW0=12]="COL3ROW0",s[s.COL3ROW1=13]="COL3ROW1",s[s.COL3ROW2=14]="COL3ROW2",s[s.COL3ROW3=15]="COL3ROW3"})(rr||(rr={}));const qp=45*Math.PI/180,Kp=1,Cn=.1,Pn=500,Zp=Object.freeze([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);class De extends Np{static get IDENTITY(){return Jp()}static get ZERO(){return Qp()}get ELEMENTS(){return 16}get RANK(){return 4}get INDICES(){return rr}constructor(e){super(-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0),arguments.length===1&&Array.isArray(e)?this.copy(e):this.identity()}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this[3]=e[3],this[4]=e[4],this[5]=e[5],this[6]=e[6],this[7]=e[7],this[8]=e[8],this[9]=e[9],this[10]=e[10],this[11]=e[11],this[12]=e[12],this[13]=e[13],this[14]=e[14],this[15]=e[15],this.check()}set(e,t,n,r,i,o,a,c,l,u,h,f,g,_,w,A){return this[0]=e,this[1]=t,this[2]=n,this[3]=r,this[4]=i,this[5]=o,this[6]=a,this[7]=c,this[8]=l,this[9]=u,this[10]=h,this[11]=f,this[12]=g,this[13]=_,this[14]=w,this[15]=A,this.check()}setRowMajor(e,t,n,r,i,o,a,c,l,u,h,f,g,_,w,A){return this[0]=e,this[1]=i,this[2]=l,this[3]=g,this[4]=t,this[5]=o,this[6]=u,this[7]=_,this[8]=n,this[9]=a,this[10]=h,this[11]=w,this[12]=r,this[13]=c,this[14]=f,this[15]=A,this.check()}toRowMajor(e){return e[0]=this[0],e[1]=this[4],e[2]=this[8],e[3]=this[12],e[4]=this[1],e[5]=this[5],e[6]=this[9],e[7]=this[13],e[8]=this[2],e[9]=this[6],e[10]=this[10],e[11]=this[14],e[12]=this[3],e[13]=this[7],e[14]=this[11],e[15]=this[15],e}identity(){return this.copy(Zp)}fromObject(e){return this.check()}fromQuaternion(e){return Vp(this,e),this.check()}frustum(e){const{left:t,right:n,bottom:r,top:i,near:o=Cn,far:a=Pn}=e;return a===1/0?Gp(this,t,n,r,i,o):$p(this,t,n,r,i,o,a),this.check()}lookAt(e){const{eye:t,center:n=[0,0,0],up:r=[0,1,0]}=e;return zp(this,t,n,r),this.check()}ortho(e){const{left:t,right:n,bottom:r,top:i,near:o=Cn,far:a=Pn}=e;return Hp(this,t,n,r,i,o,a),this.check()}orthographic(e){const{fovy:t=qp,aspect:n=Kp,focalDistance:r=1,near:i=Cn,far:o=Pn}=e;so(t);const a=t/2,c=r*Math.tan(a),l=c*n;return this.ortho({left:-l,right:l,bottom:-c,top:c,near:i,far:o})}perspective(e){const{fovy:t=45*Math.PI/180,aspect:n=1,near:r=.1,far:i=500}=e;return so(t),Ec(this,t,n,r,i),this.check()}determinant(){return Bp(this)}getScale(e=[-0,-0,-0]){return e[0]=Math.sqrt(this[0]*this[0]+this[1]*this[1]+this[2]*this[2]),e[1]=Math.sqrt(this[4]*this[4]+this[5]*this[5]+this[6]*this[6]),e[2]=Math.sqrt(this[8]*this[8]+this[9]*this[9]+this[10]*this[10]),e}getTranslation(e=[-0,-0,-0]){return e[0]=this[12],e[1]=this[13],e[2]=this[14],e}getRotation(e,t){e=e||[-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0],t=t||[-0,-0,-0];const n=this.getScale(t),r=1/n[0],i=1/n[1],o=1/n[2];return e[0]=this[0]*r,e[1]=this[1]*i,e[2]=this[2]*o,e[3]=0,e[4]=this[4]*r,e[5]=this[5]*i,e[6]=this[6]*o,e[7]=0,e[8]=this[8]*r,e[9]=this[9]*i,e[10]=this[10]*o,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}getRotationMatrix3(e,t){e=e||[-0,-0,-0,-0,-0,-0,-0,-0,-0],t=t||[-0,-0,-0];const n=this.getScale(t),r=1/n[0],i=1/n[1],o=1/n[2];return e[0]=this[0]*r,e[1]=this[1]*i,e[2]=this[2]*o,e[3]=this[4]*r,e[4]=this[5]*i,e[5]=this[6]*o,e[6]=this[8]*r,e[7]=this[9]*i,e[8]=this[10]*o,e}transpose(){return Fp(this,this),this.check()}invert(){return nr(this,this),this.check()}multiplyLeft(e){return rt(this,e,this),this.check()}multiplyRight(e){return rt(this,this,e),this.check()}rotateX(e){return Ac(this,this,e),this.check()}rotateY(e){return Lp(this,this,e),this.check()}rotateZ(e){return xc(this,this,e),this.check()}rotateXYZ(e){return this.rotateX(e[0]).rotateY(e[1]).rotateZ(e[2])}rotateAxis(e,t){return Up(this,this,e,t),this.check()}scale(e){return Kr(this,this,Array.isArray(e)?e:[e,e,e]),this.check()}translate(e){return zs(this,this,e),this.check()}transform(e,t){return e.length===4?(t=ls(t||[-0,-0,-0,-0],e,this),Rn(t,4),t):this.transformAsPoint(e,t)}transformAsPoint(e,t){const{length:n}=e;let r;switch(n){case 2:r=gp(t||[-0,-0],e,this);break;case 3:r=vc(t||[-0,-0,-0],e,this);break;default:throw new Error("Illegal vector")}return Rn(r,e.length),r}transformAsVector(e,t){let n;switch(e.length){case 2:n=_p(t||[-0,-0],e,this);break;case 3:n=wc(t||[-0,-0,-0],e,this);break;default:throw new Error("Illegal vector")}return Rn(n,e.length),n}transformPoint(e,t){return this.transformAsPoint(e,t)}transformVector(e,t){return this.transformAsPoint(e,t)}transformDirection(e,t){return this.transformAsVector(e,t)}makeRotationX(e){return this.identity().rotateX(e)}makeTranslation(e,t,n){return this.identity().translate([e,t,n])}}let ys,Ts;function Qp(){return ys||(ys=new De([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]),Object.freeze(ys)),ys}function Jp(){return Ts||(Ts=new De,Object.freeze(Ts)),Ts}function so(s){if(s>Math.PI*2)throw Error("expected radians")}function Gp(s,e,t,n,r,i){const o=2*i/(t-e),a=2*i/(r-n),c=(t+e)/(t-e),l=(r+n)/(r-n),u=-1,h=-1,f=-2*i;return s[0]=o,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=a,s[6]=0,s[7]=0,s[8]=c,s[9]=l,s[10]=u,s[11]=h,s[12]=0,s[13]=0,s[14]=f,s[15]=0,s}function Sc(s,e=[],t=0){const n=Math.fround(s),r=s-n;return e[t]=n,e[t+1]=r,e}function eg(s){return s-Math.fround(s)}function tg(s){const e=new Float32Array(32);for(let t=0;t<4;++t)for(let n=0;n<4;++n){const r=t*4+n;Sc(s[n*4+t],e,r*2)}return e}const sg=`#ifdef LUMA_FP32_TAN_PRECISION_WORKAROUND

// All these functions are for substituting tan() function from Intel GPU only
const float TWO_PI = 6.2831854820251465;
const float PI_2 = 1.5707963705062866;
const float PI_16 = 0.1963495463132858;

const float SIN_TABLE_0 = 0.19509032368659973;
const float SIN_TABLE_1 = 0.3826834261417389;
const float SIN_TABLE_2 = 0.5555702447891235;
const float SIN_TABLE_3 = 0.7071067690849304;

const float COS_TABLE_0 = 0.9807852506637573;
const float COS_TABLE_1 = 0.9238795042037964;
const float COS_TABLE_2 = 0.8314695954322815;
const float COS_TABLE_3 = 0.7071067690849304;

const float INVERSE_FACTORIAL_3 = 1.666666716337204e-01; // 1/3!
const float INVERSE_FACTORIAL_5 = 8.333333767950535e-03; // 1/5!
const float INVERSE_FACTORIAL_7 = 1.9841270113829523e-04; // 1/7!
const float INVERSE_FACTORIAL_9 = 2.75573188446287533e-06; // 1/9!

float sin_taylor_fp32(float a) {
  float r, s, t, x;

  if (a == 0.0) {
    return 0.0;
  }

  x = -a * a;
  s = a;
  r = a;

  r = r * x;
  t = r * INVERSE_FACTORIAL_3;
  s = s + t;

  r = r * x;
  t = r * INVERSE_FACTORIAL_5;
  s = s + t;

  r = r * x;
  t = r * INVERSE_FACTORIAL_7;
  s = s + t;

  r = r * x;
  t = r * INVERSE_FACTORIAL_9;
  s = s + t;

  return s;
}

void sincos_taylor_fp32(float a, out float sin_t, out float cos_t) {
  if (a == 0.0) {
    sin_t = 0.0;
    cos_t = 1.0;
  }
  sin_t = sin_taylor_fp32(a);
  cos_t = sqrt(1.0 - sin_t * sin_t);
}

float tan_taylor_fp32(float a) {
    float sin_a;
    float cos_a;

    if (a == 0.0) {
        return 0.0;
    }

    // 2pi range reduction
    float z = floor(a / TWO_PI);
    float r = a - TWO_PI * z;

    float t;
    float q = floor(r / PI_2 + 0.5);
    int j = int(q);

    if (j < -2 || j > 2) {
        return 1.0 / 0.0;
    }

    t = r - PI_2 * q;

    q = floor(t / PI_16 + 0.5);
    int k = int(q);
    int abs_k = int(abs(float(k)));

    if (abs_k > 4) {
        return 1.0 / 0.0;
    } else {
        t = t - PI_16 * q;
    }

    float u = 0.0;
    float v = 0.0;

    float sin_t, cos_t;
    float s, c;
    sincos_taylor_fp32(t, sin_t, cos_t);

    if (k == 0) {
        s = sin_t;
        c = cos_t;
    } else {
        if (abs(float(abs_k) - 1.0) < 0.5) {
            u = COS_TABLE_0;
            v = SIN_TABLE_0;
        } else if (abs(float(abs_k) - 2.0) < 0.5) {
            u = COS_TABLE_1;
            v = SIN_TABLE_1;
        } else if (abs(float(abs_k) - 3.0) < 0.5) {
            u = COS_TABLE_2;
            v = SIN_TABLE_2;
        } else if (abs(float(abs_k) - 4.0) < 0.5) {
            u = COS_TABLE_3;
            v = SIN_TABLE_3;
        }
        if (k > 0) {
            s = u * sin_t + v * cos_t;
            c = u * cos_t - v * sin_t;
        } else {
            s = u * sin_t - v * cos_t;
            c = u * cos_t + v * sin_t;
        }
    }

    if (j == 0) {
        sin_a = s;
        cos_a = c;
    } else if (j == 1) {
        sin_a = c;
        cos_a = -s;
    } else if (j == -1) {
        sin_a = -c;
        cos_a = s;
    } else {
        sin_a = -s;
        cos_a = -c;
    }
    return sin_a / cos_a;
}
#endif

float tan_fp32(float a) {
#ifdef LUMA_FP32_TAN_PRECISION_WORKAROUND
  return tan_taylor_fp32(a);
#else
  return tan(a);
#endif
}
`,ng={name:"fp32",vs:sg},rg=`
uniform fp64arithmeticUniforms {
  uniform float ONE;
} fp64;

/*
About LUMA_FP64_CODE_ELIMINATION_WORKAROUND

The purpose of this workaround is to prevent shader compilers from
optimizing away necessary arithmetic operations by swapping their sequences
or transform the equation to some 'equivalent' form.

The method is to multiply an artifical variable, ONE, which will be known to
the compiler to be 1 only at runtime. The whole expression is then represented
as a polynomial with respective to ONE. In the coefficients of all terms, only one a
and one b should appear

err = (a + b) * ONE^6 - a * ONE^5 - (a + b) * ONE^4 + a * ONE^3 - b - (a + b) * ONE^2 + a * ONE
*/

// Divide float number to high and low floats to extend fraction bits
vec2 split(float a) {
  const float SPLIT = 4097.0;
  float t = a * SPLIT;
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
  float a_hi = t * fp64.ONE - (t - a);
  float a_lo = a * fp64.ONE - a_hi;
#else
  float a_hi = t - (t - a);
  float a_lo = a - a_hi;
#endif
  return vec2(a_hi, a_lo);
}

// Divide float number again when high float uses too many fraction bits
vec2 split2(vec2 a) {
  vec2 b = split(a.x);
  b.y += a.y;
  return b;
}

// Special sum operation when a > b
vec2 quickTwoSum(float a, float b) {
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
  float sum = (a + b) * fp64.ONE;
  float err = b - (sum - a) * fp64.ONE;
#else
  float sum = a + b;
  float err = b - (sum - a);
#endif
  return vec2(sum, err);
}

// General sum operation
vec2 twoSum(float a, float b) {
  float s = (a + b);
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
  float v = (s * fp64.ONE - a) * fp64.ONE;
  float err = (a - (s - v) * fp64.ONE) * fp64.ONE * fp64.ONE * fp64.ONE + (b - v);
#else
  float v = s - a;
  float err = (a - (s - v)) + (b - v);
#endif
  return vec2(s, err);
}

vec2 twoSub(float a, float b) {
  float s = (a - b);
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
  float v = (s * fp64.ONE - a) * fp64.ONE;
  float err = (a - (s - v) * fp64.ONE) * fp64.ONE * fp64.ONE * fp64.ONE - (b + v);
#else
  float v = s - a;
  float err = (a - (s - v)) - (b + v);
#endif
  return vec2(s, err);
}

vec2 twoSqr(float a) {
  float prod = a * a;
  vec2 a_fp64 = split(a);
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
  float err = ((a_fp64.x * a_fp64.x - prod) * fp64.ONE + 2.0 * a_fp64.x *
    a_fp64.y * fp64.ONE * fp64.ONE) + a_fp64.y * a_fp64.y * fp64.ONE * fp64.ONE * fp64.ONE;
#else
  float err = ((a_fp64.x * a_fp64.x - prod) + 2.0 * a_fp64.x * a_fp64.y) + a_fp64.y * a_fp64.y;
#endif
  return vec2(prod, err);
}

vec2 twoProd(float a, float b) {
  float prod = a * b;
  vec2 a_fp64 = split(a);
  vec2 b_fp64 = split(b);
  float err = ((a_fp64.x * b_fp64.x - prod) + a_fp64.x * b_fp64.y +
    a_fp64.y * b_fp64.x) + a_fp64.y * b_fp64.y;
  return vec2(prod, err);
}

vec2 sum_fp64(vec2 a, vec2 b) {
  vec2 s, t;
  s = twoSum(a.x, b.x);
  t = twoSum(a.y, b.y);
  s.y += t.x;
  s = quickTwoSum(s.x, s.y);
  s.y += t.y;
  s = quickTwoSum(s.x, s.y);
  return s;
}

vec2 sub_fp64(vec2 a, vec2 b) {
  vec2 s, t;
  s = twoSub(a.x, b.x);
  t = twoSub(a.y, b.y);
  s.y += t.x;
  s = quickTwoSum(s.x, s.y);
  s.y += t.y;
  s = quickTwoSum(s.x, s.y);
  return s;
}

vec2 mul_fp64(vec2 a, vec2 b) {
  vec2 prod = twoProd(a.x, b.x);
  // y component is for the error
  prod.y += a.x * b.y;
#if defined(LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND)
  prod = split2(prod);
#endif
  prod = quickTwoSum(prod.x, prod.y);
  prod.y += a.y * b.x;
#if defined(LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND)
  prod = split2(prod);
#endif
  prod = quickTwoSum(prod.x, prod.y);
  return prod;
}

vec2 div_fp64(vec2 a, vec2 b) {
  float xn = 1.0 / b.x;
#if defined(LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND)
  vec2 yn = mul_fp64(a, vec2(xn, 0));
#else
  vec2 yn = a * xn;
#endif
  float diff = (sub_fp64(a, mul_fp64(b, yn))).x;
  vec2 prod = twoProd(xn, diff);
  return sum_fp64(yn, prod);
}

vec2 sqrt_fp64(vec2 a) {
  if (a.x == 0.0 && a.y == 0.0) return vec2(0.0, 0.0);
  if (a.x < 0.0) return vec2(0.0 / 0.0, 0.0 / 0.0);

  float x = 1.0 / sqrt(a.x);
  float yn = a.x * x;
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
  vec2 yn_sqr = twoSqr(yn) * fp64.ONE;
#else
  vec2 yn_sqr = twoSqr(yn);
#endif
  float diff = sub_fp64(a, yn_sqr).x;
  vec2 prod = twoProd(x * 0.5, diff);
#if defined(LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND)
  return sum_fp64(split(yn), prod);
#else
  return sum_fp64(vec2(yn, 0.0), prod);
#endif
}
`,ig={ONE:1},og={name:"fp64arithmetic",vs:rg,defaultUniforms:ig,uniformTypes:{ONE:"f32"},fp64ify:Sc,fp64LowPart:eg,fp64ifyMatrix4:tg},ag=[0,1,1,1],cg=`uniform pickingUniforms {
  float isActive;
  float isAttribute;
  float isHighlightActive;
  float useFloatColors;
  vec3 highlightedObjectColor;
  vec4 highlightColor;
} picking;

out vec4 picking_vRGBcolor_Avalid;

// Normalize unsigned byte color to 0-1 range
vec3 picking_normalizeColor(vec3 color) {
  return picking.useFloatColors > 0.5 ? color : color / 255.0;
}

// Normalize unsigned byte color to 0-1 range
vec4 picking_normalizeColor(vec4 color) {
  return picking.useFloatColors > 0.5 ? color : color / 255.0;
}

bool picking_isColorZero(vec3 color) {
  return dot(color, vec3(1.0)) < 0.00001;
}

bool picking_isColorValid(vec3 color) {
  return dot(color, vec3(1.0)) > 0.00001;
}

// Check if this vertex is highlighted 
bool isVertexHighlighted(vec3 vertexColor) {
  vec3 highlightedObjectColor = picking_normalizeColor(picking.highlightedObjectColor);
  return
    bool(picking.isHighlightActive) && picking_isColorZero(abs(vertexColor - highlightedObjectColor));
}

// Set the current picking color
void picking_setPickingColor(vec3 pickingColor) {
  pickingColor = picking_normalizeColor(pickingColor);

  if (bool(picking.isActive)) {
    // Use alpha as the validity flag. If pickingColor is [0, 0, 0] fragment is non-pickable
    picking_vRGBcolor_Avalid.a = float(picking_isColorValid(pickingColor));

    if (!bool(picking.isAttribute)) {
      // Stores the picking color so that the fragment shader can render it during picking
      picking_vRGBcolor_Avalid.rgb = pickingColor;
    }
  } else {
    // Do the comparison with selected item color in vertex shader as it should mean fewer compares
    picking_vRGBcolor_Avalid.a = float(isVertexHighlighted(pickingColor));
  }
}

void picking_setPickingAttribute(float value) {
  if (bool(picking.isAttribute)) {
    picking_vRGBcolor_Avalid.r = value;
  }
}

void picking_setPickingAttribute(vec2 value) {
  if (bool(picking.isAttribute)) {
    picking_vRGBcolor_Avalid.rg = value;
  }
}

void picking_setPickingAttribute(vec3 value) {
  if (bool(picking.isAttribute)) {
    picking_vRGBcolor_Avalid.rgb = value;
  }
}
`,lg=`uniform pickingUniforms {
  float isActive;
  float isAttribute;
  float isHighlightActive;
  float useFloatColors;
  vec3 highlightedObjectColor;
  vec4 highlightColor;
} picking;

in vec4 picking_vRGBcolor_Avalid;

/*
 * Returns highlight color if this item is selected.
 */
vec4 picking_filterHighlightColor(vec4 color) {
  // If we are still picking, we don't highlight
  if (picking.isActive > 0.5) {
    return color;
  }

  bool selected = bool(picking_vRGBcolor_Avalid.a);

  if (selected) {
    // Blend in highlight color based on its alpha value
    float highLightAlpha = picking.highlightColor.a;
    float blendedAlpha = highLightAlpha + color.a * (1.0 - highLightAlpha);
    float highLightRatio = highLightAlpha / blendedAlpha;

    vec3 blendedRGB = mix(color.rgb, picking.highlightColor.rgb, highLightRatio);
    return vec4(blendedRGB, blendedAlpha);
  } else {
    return color;
  }
}

/*
 * Returns picking color if picking enabled else unmodified argument.
 */
vec4 picking_filterPickingColor(vec4 color) {
  if (bool(picking.isActive)) {
    if (picking_vRGBcolor_Avalid.a == 0.0) {
      discard;
    }
    return picking_vRGBcolor_Avalid;
  }
  return color;
}

/*
 * Returns picking color if picking is enabled if not
 * highlight color if this item is selected, otherwise unmodified argument.
 */
vec4 picking_filterColor(vec4 color) {
  vec4 highlightColor = picking_filterHighlightColor(color);
  return picking_filterPickingColor(highlightColor);
}
`,no={props:{},uniforms:{},name:"picking",uniformTypes:{isActive:"f32",isAttribute:"f32",isHighlightActive:"f32",useFloatColors:"f32",highlightedObjectColor:"vec3<f32>",highlightColor:"vec4<f32>"},defaultUniforms:{isActive:!1,isAttribute:!1,isHighlightActive:!1,useFloatColors:!0,highlightedObjectColor:[0,0,0],highlightColor:ag},vs:cg,fs:lg,getUniforms:ug};function ug(s={},e){const t={};if(s.highlightedObjectColor!==void 0)if(s.highlightedObjectColor===null)t.isHighlightActive=!1;else{t.isHighlightActive=!0;const n=s.highlightedObjectColor.slice(0,3);t.highlightedObjectColor=n}if(s.highlightColor){const n=Array.from(s.highlightColor,r=>r/255);Number.isFinite(n[3])||(n[3]=1),t.highlightColor=n}return s.isActive!==void 0&&(t.isActive=!!s.isActive,t.isAttribute=!!s.isAttribute),s.useFloatColors!==void 0&&(t.useFloatColors=!!s.useFloatColors),t}const ro=`uniform layerUniforms {
  uniform float opacity;
} layer;
`,hg={name:"layer",vs:ro,fs:ro,getUniforms:s=>({opacity:Math.pow(s.opacity,1/2.2)}),uniformTypes:{opacity:"f32"}},fg=`const SMOOTH_EDGE_RADIUS: f32 = 0.5;

struct VertexGeometry {
  position: vec4<f32>,
  worldPosition: vec3<f32>,
  worldPositionAlt: vec3<f32>,
  normal: vec3<f32>,
  uv: vec2<f32>,
  pickingColor: vec3<f32>,
};

var<private> geometry_: VertexGeometry = VertexGeometry(
  vec4<f32>(0.0, 0.0, 1.0, 0.0),
  vec3<f32>(0.0, 0.0, 0.0),
  vec3<f32>(0.0, 0.0, 0.0),
  vec3<f32>(0.0, 0.0, 0.0),
  vec2<f32>(0.0, 0.0),
  vec3<f32>(0.0, 0.0, 0.0)
);

struct FragmentGeometry {
  uv: vec2<f32>,
};

var<private> fragmentGeometry: FragmentGeometry;

fn smoothedge(edge: f32, x: f32) -> f32 {
  return smoothstep(edge - SMOOTH_EDGE_RADIUS, edge + SMOOTH_EDGE_RADIUS, x);
}
`,Rc="#define SMOOTH_EDGE_RADIUS 0.5",dg=`${Rc}

struct VertexGeometry {
  vec4 position;
  vec3 worldPosition;
  vec3 worldPositionAlt;
  vec3 normal;
  vec2 uv;
  vec3 pickingColor;
} geometry = VertexGeometry(
  vec4(0.0, 0.0, 1.0, 0.0),
  vec3(0.0),
  vec3(0.0),
  vec3(0.0),
  vec2(0.0),
  vec3(0.0)
);
`,pg=`${Rc}

struct FragmentGeometry {
  vec2 uv;
} geometry;

float smoothedge(float edge, float x) {
  return smoothstep(edge - SMOOTH_EDGE_RADIUS, edge + SMOOTH_EDGE_RADIUS, x);
}
`,Ic={name:"geometry",source:fg,vs:dg,fs:pg},gg=25;var ne;(function(s){s[s.Start=1]="Start",s[s.Move=2]="Move",s[s.End=4]="End",s[s.Cancel=8]="Cancel"})(ne||(ne={}));var ie;(function(s){s[s.None=0]="None",s[s.Left=1]="Left",s[s.Right=2]="Right",s[s.Up=4]="Up",s[s.Down=8]="Down",s[s.Horizontal=3]="Horizontal",s[s.Vertical=12]="Vertical",s[s.All=15]="All"})(ie||(ie={}));var F;(function(s){s[s.Possible=1]="Possible",s[s.Began=2]="Began",s[s.Changed=4]="Changed",s[s.Ended=8]="Ended",s[s.Recognized=8]="Recognized",s[s.Cancelled=16]="Cancelled",s[s.Failed=32]="Failed"})(F||(F={}));const _g="compute",mg="auto",ir="manipulation",Ps="none",or="pan-x",ar="pan-y";function bg(s){if(s.includes(Ps))return Ps;const e=s.includes(or),t=s.includes(ar);return e&&t?Ps:e||t?e?or:ar:s.includes(ir)?ir:mg}class yg{constructor(e,t){this.actions="",this.manager=e,this.set(t)}set(e){e===_g&&(e=this.compute()),this.manager.element&&(this.manager.element.style.touchAction=e,this.actions=e)}update(){this.set(this.manager.options.touchAction)}compute(){let e=[];for(const t of this.manager.recognizers)t.options.enable&&(e=e.concat(t.getTouchAction()));return bg(e.join(" "))}}function Xs(s){return s.trim().split(/\s+/g)}function Mn(s,e,t){if(s)for(const n of Xs(e))s.addEventListener(n,t,!1)}function On(s,e,t){if(s)for(const n of Xs(e))s.removeEventListener(n,t,!1)}function io(s){return(s.ownerDocument||s).defaultView}function Tg(s,e){let t=s;for(;t;){if(t===e)return!0;t=t.parentNode}return!1}function Cc(s){const e=s.length;if(e===1)return{x:Math.round(s[0].clientX),y:Math.round(s[0].clientY)};let t=0,n=0,r=0;for(;r<e;)t+=s[r].clientX,n+=s[r].clientY,r++;return{x:Math.round(t/e),y:Math.round(n/e)}}function oo(s){const e=[];let t=0;for(;t<s.pointers.length;)e[t]={clientX:Math.round(s.pointers[t].clientX),clientY:Math.round(s.pointers[t].clientY)},t++;return{timeStamp:Date.now(),pointers:e,center:Cc(e),deltaX:s.deltaX,deltaY:s.deltaY}}function Pc(s,e){const t=e.x-s.x,n=e.y-s.y;return Math.sqrt(t*t+n*n)}function ao(s,e){const t=e.clientX-s.clientX,n=e.clientY-s.clientY;return Math.sqrt(t*t+n*n)}function wg(s,e){const t=e.x-s.x,n=e.y-s.y;return Math.atan2(n,t)*180/Math.PI}function co(s,e){const t=e.clientX-s.clientX,n=e.clientY-s.clientY;return Math.atan2(n,t)*180/Math.PI}function Mc(s,e){return s===e?ie.None:Math.abs(s)>=Math.abs(e)?s<0?ie.Left:ie.Right:e<0?ie.Up:ie.Down}function vg(s,e){const t=e.center;let n=s.offsetDelta,r=s.prevDelta;const i=s.prevInput;return(e.eventType===ne.Start||i?.eventType===ne.End)&&(r=s.prevDelta={x:i?.deltaX||0,y:i?.deltaY||0},n=s.offsetDelta={x:t.x,y:t.y}),{deltaX:r.x+(t.x-n.x),deltaY:r.y+(t.y-n.y)}}function Oc(s,e,t){return{x:e/s||0,y:t/s||0}}function Ag(s,e){return ao(e[0],e[1])/ao(s[0],s[1])}function xg(s,e){return co(e[1],e[0])-co(s[1],s[0])}function Eg(s,e){const t=s.lastInterval||e,n=e.timeStamp-t.timeStamp;let r,i,o,a;if(e.eventType!==ne.Cancel&&(n>gg||t.velocity===void 0)){const c=e.deltaX-t.deltaX,l=e.deltaY-t.deltaY,u=Oc(n,c,l);i=u.x,o=u.y,r=Math.abs(u.x)>Math.abs(u.y)?u.x:u.y,a=Mc(c,l),s.lastInterval=e}else r=t.velocity,i=t.velocityX,o=t.velocityY,a=t.direction;e.velocity=r,e.velocityX=i,e.velocityY=o,e.direction=a}function Sg(s,e){const{session:t}=s,{pointers:n}=e,{length:r}=n;t.firstInput||(t.firstInput=oo(e)),r>1&&!t.firstMultiple?t.firstMultiple=oo(e):r===1&&(t.firstMultiple=!1);const{firstInput:i,firstMultiple:o}=t,a=o?o.center:i.center,c=e.center=Cc(n);e.timeStamp=Date.now(),e.deltaTime=e.timeStamp-i.timeStamp,e.angle=wg(a,c),e.distance=Pc(a,c);const{deltaX:l,deltaY:u}=vg(t,e);e.deltaX=l,e.deltaY=u,e.offsetDirection=Mc(e.deltaX,e.deltaY);const h=Oc(e.deltaTime,e.deltaX,e.deltaY);e.overallVelocityX=h.x,e.overallVelocityY=h.y,e.overallVelocity=Math.abs(h.x)>Math.abs(h.y)?h.x:h.y,e.scale=o?Ag(o.pointers,n):1,e.rotation=o?xg(o.pointers,n):0,e.maxPointers=t.prevInput?e.pointers.length>t.prevInput.maxPointers?e.pointers.length:t.prevInput.maxPointers:e.pointers.length;let f=s.element;return Tg(e.srcEvent.target,f)&&(f=e.srcEvent.target),e.target=f,Eg(t,e),e}function Rg(s,e,t){const n=t.pointers.length,r=t.changedPointers.length,i=e&ne.Start&&n-r===0,o=e&(ne.End|ne.Cancel)&&n-r===0;t.isFirst=!!i,t.isFinal=!!o,i&&(s.session={}),t.eventType=e;const a=Sg(s,t);s.emit("hammer.input",a),s.recognize(a),s.session.prevInput=a}let Ig=class{constructor(e){this.evEl="",this.evWin="",this.evTarget="",this.domHandler=t=>{this.manager.options.enable&&this.handler(t)},this.manager=e,this.element=e.element,this.target=e.options.inputTarget||e.element}callback(e,t){Rg(this.manager,e,t)}init(){Mn(this.element,this.evEl,this.domHandler),Mn(this.target,this.evTarget,this.domHandler),Mn(io(this.element),this.evWin,this.domHandler)}destroy(){On(this.element,this.evEl,this.domHandler),On(this.target,this.evTarget,this.domHandler),On(io(this.element),this.evWin,this.domHandler)}};const Cg={pointerdown:ne.Start,pointermove:ne.Move,pointerup:ne.End,pointercancel:ne.Cancel,pointerout:ne.Cancel},Pg="pointerdown",Mg="pointermove pointerup pointercancel";class Og extends Ig{constructor(e){super(e),this.evEl=Pg,this.evWin=Mg,this.store=this.manager.session.pointerEvents=[],this.init()}handler(e){const{store:t}=this;let n=!1;const r=Cg[e.type],i=e.pointerType,o=i==="touch";let a=t.findIndex(c=>c.pointerId===e.pointerId);r&ne.Start&&(e.buttons||o)?a<0&&(t.push(e),a=t.length-1):r&(ne.End|ne.Cancel)&&(n=!0),!(a<0)&&(t[a]=e,this.callback(r,{pointers:t,changedPointers:[e],eventType:r,pointerType:i,srcEvent:e}),n&&t.splice(a,1))}}const kg=["","webkit","Moz","MS","ms","o"];function Ng(s,e){const t=e[0].toUpperCase()+e.slice(1);for(const n of kg){const r=n?n+t:e;if(r in s)return r}}const Dg=1,lo=2,uo={touchAction:"compute",enable:!0,inputTarget:null,cssProps:{userSelect:"none",userDrag:"none",touchCallout:"none",tapHighlightColor:"rgba(0,0,0,0)"}};class Fg{constructor(e,t){this.options={...uo,...t,cssProps:{...uo.cssProps,...t.cssProps},inputTarget:t.inputTarget||e},this.handlers={},this.session={},this.recognizers=[],this.oldCssProps={},this.element=e,this.input=new Og(this),this.touchAction=new yg(this,this.options.touchAction),this.toggleCssProps(!0)}set(e){return Object.assign(this.options,e),e.touchAction&&this.touchAction.update(),e.inputTarget&&(this.input.destroy(),this.input.target=e.inputTarget,this.input.init()),this}stop(e){this.session.stopped=e?lo:Dg}recognize(e){const{session:t}=this;if(t.stopped)return;this.session.prevented&&e.srcEvent.preventDefault();let n;const{recognizers:r}=this;let{curRecognizer:i}=t;(!i||i&&i.state&F.Recognized)&&(i=t.curRecognizer=null);let o=0;for(;o<r.length;)n=r[o],t.stopped!==lo&&(!i||n===i||n.canRecognizeWith(i))?n.recognize(e):n.reset(),!i&&n.state&(F.Began|F.Changed|F.Ended)&&(i=t.curRecognizer=n),o++}get(e){const{recognizers:t}=this;for(let n=0;n<t.length;n++)if(t[n].options.event===e)return t[n];return null}add(e){if(Array.isArray(e)){for(const n of e)this.add(n);return this}const t=this.get(e.options.event);return t&&this.remove(t),this.recognizers.push(e),e.manager=this,this.touchAction.update(),e}remove(e){if(Array.isArray(e)){for(const n of e)this.remove(n);return this}const t=typeof e=="string"?this.get(e):e;if(t){const{recognizers:n}=this,r=n.indexOf(t);r!==-1&&(n.splice(r,1),this.touchAction.update())}return this}on(e,t){if(!e||!t)return;const{handlers:n}=this;for(const r of Xs(e))n[r]=n[r]||[],n[r].push(t)}off(e,t){if(!e)return;const{handlers:n}=this;for(const r of Xs(e))t?n[r]&&n[r].splice(n[r].indexOf(t),1):delete n[r]}emit(e,t){const n=this.handlers[e]&&this.handlers[e].slice();if(!n||!n.length)return;const r=t;r.type=e,r.preventDefault=function(){t.srcEvent.preventDefault()};let i=0;for(;i<n.length;)n[i](r),i++}destroy(){this.toggleCssProps(!1),this.handlers={},this.session={},this.input.destroy(),this.element=null}toggleCssProps(e){const{element:t}=this;if(t){for(const[n,r]of Object.entries(this.options.cssProps)){const i=Ng(t.style,n);e?(this.oldCssProps[i]=t.style[i],t.style[i]=r):t.style[i]=this.oldCssProps[i]||""}e||(this.oldCssProps={})}}}let Bg=1;function Ug(){return Bg++}function ho(s){return s&F.Cancelled?"cancel":s&F.Ended?"end":s&F.Changed?"move":s&F.Began?"start":""}class kc{constructor(e){this.options=e,this.id=Ug(),this.state=F.Possible,this.simultaneous={},this.requireFail=[]}set(e){return Object.assign(this.options,e),this.manager.touchAction.update(),this}recognizeWith(e){if(Array.isArray(e)){for(const r of e)this.recognizeWith(r);return this}let t;if(typeof e=="string"){if(t=this.manager.get(e),!t)throw new Error(`Cannot find recognizer ${e}`)}else t=e;const{simultaneous:n}=this;return n[t.id]||(n[t.id]=t,t.recognizeWith(this)),this}dropRecognizeWith(e){if(Array.isArray(e)){for(const n of e)this.dropRecognizeWith(n);return this}let t;return typeof e=="string"?t=this.manager.get(e):t=e,t&&delete this.simultaneous[t.id],this}requireFailure(e){if(Array.isArray(e)){for(const r of e)this.requireFailure(r);return this}let t;if(typeof e=="string"){if(t=this.manager.get(e),!t)throw new Error(`Cannot find recognizer ${e}`)}else t=e;const{requireFail:n}=this;return n.indexOf(t)===-1&&(n.push(t),t.requireFailure(this)),this}dropRequireFailure(e){if(Array.isArray(e)){for(const n of e)this.dropRequireFailure(n);return this}let t;if(typeof e=="string"?t=this.manager.get(e):t=e,t){const n=this.requireFail.indexOf(t);n>-1&&this.requireFail.splice(n,1)}return this}hasRequireFailures(){return!!this.requireFail.find(e=>e.options.enable)}canRecognizeWith(e){return!!this.simultaneous[e.id]}emit(e){if(!e)return;const{state:t}=this;t<F.Ended&&this.manager.emit(this.options.event+ho(t),e),this.manager.emit(this.options.event,e),e.additionalEvent&&this.manager.emit(e.additionalEvent,e),t>=F.Ended&&this.manager.emit(this.options.event+ho(t),e)}tryEmit(e){this.canEmit()?this.emit(e):this.state=F.Failed}canEmit(){let e=0;for(;e<this.requireFail.length;){if(!(this.requireFail[e].state&(F.Failed|F.Possible)))return!1;e++}return!0}recognize(e){const t={...e};if(!this.options.enable){this.reset(),this.state=F.Failed;return}this.state&(F.Recognized|F.Cancelled|F.Failed)&&(this.state=F.Possible),this.state=this.process(t),this.state&(F.Began|F.Changed|F.Ended|F.Cancelled)&&this.tryEmit(t)}getEventNames(){return[this.options.event]}reset(){}}class Nc extends kc{attrTest(e){const t=this.options.pointers;return t===0||e.pointers.length===t}process(e){const{state:t}=this,{eventType:n}=e,r=t&(F.Began|F.Changed),i=this.attrTest(e);return r&&(n&ne.Cancel||!i)?t|F.Cancelled:r||i?n&ne.End?t|F.Ended:t&F.Began?t|F.Changed:F.Began:F.Failed}}class fo extends kc{constructor(e={}){super({enable:!0,event:"tap",pointers:1,taps:1,interval:300,time:250,threshold:9,posThreshold:10,...e}),this.pTime=null,this.pCenter=null,this._timer=null,this._input=null,this.count=0}getTouchAction(){return[ir]}process(e){const{options:t}=this,n=e.pointers.length===t.pointers,r=e.distance<t.threshold,i=e.deltaTime<t.time;if(this.reset(),e.eventType&ne.Start&&this.count===0)return this.failTimeout();if(r&&i&&n){if(e.eventType!==ne.End)return this.failTimeout();const o=this.pTime?e.timeStamp-this.pTime<t.interval:!0,a=!this.pCenter||Pc(this.pCenter,e.center)<t.posThreshold;if(this.pTime=e.timeStamp,this.pCenter=e.center,!a||!o?this.count=1:this.count+=1,this._input=e,this.count%t.taps===0)return this.hasRequireFailures()?(this._timer=setTimeout(()=>{this.state=F.Recognized,this.tryEmit(this._input)},t.interval),F.Began):F.Recognized}return F.Failed}failTimeout(){return this._timer=setTimeout(()=>{this.state=F.Failed},this.options.interval),F.Failed}reset(){clearTimeout(this._timer)}emit(e){this.state===F.Recognized&&(e.tapCount=this.count,this.manager.emit(this.options.event,e))}}const Lg=["","start","move","end","cancel","up","down","left","right"];class po extends Nc{constructor(e={}){super({enable:!0,pointers:1,event:"pan",threshold:10,direction:ie.All,...e}),this.pX=null,this.pY=null}getTouchAction(){const{options:{direction:e}}=this,t=[];return e&ie.Horizontal&&t.push(ar),e&ie.Vertical&&t.push(or),t}getEventNames(){return Lg.map(e=>this.options.event+e)}directionTest(e){const{options:t}=this;let n=!0,{distance:r}=e,{direction:i}=e;const o=e.deltaX,a=e.deltaY;return i&t.direction||(t.direction&ie.Horizontal?(i=o===0?ie.None:o<0?ie.Left:ie.Right,n=o!==this.pX,r=Math.abs(e.deltaX)):(i=a===0?ie.None:a<0?ie.Up:ie.Down,n=a!==this.pY,r=Math.abs(e.deltaY))),e.direction=i,n&&r>t.threshold&&!!(i&t.direction)}attrTest(e){return super.attrTest(e)&&(!!(this.state&F.Began)||!(this.state&F.Began)&&this.directionTest(e))}emit(e){this.pX=e.deltaX,this.pY=e.deltaY;const t=ie[e.direction].toLowerCase();t&&(e.additionalEvent=this.options.event+t),super.emit(e)}}const Vg=["","start","move","end","cancel","in","out"];class $g extends Nc{constructor(e={}){super({enable:!0,event:"pinch",threshold:0,pointers:2,...e})}getTouchAction(){return[Ps]}getEventNames(){return Vg.map(e=>this.options.event+e)}attrTest(e){return super.attrTest(e)&&(Math.abs(e.scale-1)>this.options.threshold||!!(this.state&F.Began))}emit(e){if(e.scale!==1){const t=e.scale<1?"in":"out";e.additionalEvent=this.options.event+t}super.emit(e)}}class cn{constructor(e,t,n){this.element=e,this.callback=t,this.options=n}}const Wg=typeof navigator<"u"&&navigator.userAgent?navigator.userAgent.toLowerCase():"",jg=Wg.indexOf("firefox")!==-1,go=4.000244140625,Hg=40,zg=.25;class Xg extends cn{constructor(e,t,n){super(e,t,{enable:!0,...n}),this.handleEvent=r=>{if(!this.options.enable)return;let i=r.deltaY;globalThis.WheelEvent&&(jg&&r.deltaMode===globalThis.WheelEvent.DOM_DELTA_PIXEL&&(i/=globalThis.devicePixelRatio),r.deltaMode===globalThis.WheelEvent.DOM_DELTA_LINE&&(i*=Hg)),i!==0&&i%go===0&&(i=Math.floor(i/go)),r.shiftKey&&i&&(i=i*zg),this.callback({type:"wheel",center:{x:r.clientX,y:r.clientY},delta:-i,srcEvent:r,pointerType:"mouse",target:r.target})},e.addEventListener("wheel",this.handleEvent,{passive:!1})}destroy(){this.element.removeEventListener("wheel",this.handleEvent)}enableEventType(e,t){e==="wheel"&&(this.options.enable=t)}}const _o=["mousedown","mousemove","mouseup","mouseover","mouseout","mouseleave"];class Yg extends cn{constructor(e,t,n){super(e,t,{enable:!0,...n}),this.handleEvent=i=>{this.handleOverEvent(i),this.handleOutEvent(i),this.handleEnterEvent(i),this.handleLeaveEvent(i),this.handleMoveEvent(i)},this.pressed=!1;const{enable:r}=this.options;this.enableMoveEvent=r,this.enableLeaveEvent=r,this.enableEnterEvent=r,this.enableOutEvent=r,this.enableOverEvent=r,_o.forEach(i=>e.addEventListener(i,this.handleEvent))}destroy(){_o.forEach(e=>this.element.removeEventListener(e,this.handleEvent))}enableEventType(e,t){switch(e){case"pointermove":this.enableMoveEvent=t;break;case"pointerover":this.enableOverEvent=t;break;case"pointerout":this.enableOutEvent=t;break;case"pointerenter":this.enableEnterEvent=t;break;case"pointerleave":this.enableLeaveEvent=t;break}}handleOverEvent(e){this.enableOverEvent&&e.type==="mouseover"&&this._emit("pointerover",e)}handleOutEvent(e){this.enableOutEvent&&e.type==="mouseout"&&this._emit("pointerout",e)}handleEnterEvent(e){this.enableEnterEvent&&e.type==="mouseenter"&&this._emit("pointerenter",e)}handleLeaveEvent(e){this.enableLeaveEvent&&e.type==="mouseleave"&&this._emit("pointerleave",e)}handleMoveEvent(e){if(this.enableMoveEvent)switch(e.type){case"mousedown":e.button>=0&&(this.pressed=!0);break;case"mousemove":e.buttons===0&&(this.pressed=!1),this.pressed||this._emit("pointermove",e);break;case"mouseup":this.pressed=!1;break}}_emit(e,t){this.callback({type:e,center:{x:t.clientX,y:t.clientY},srcEvent:t,pointerType:"mouse",target:t.target})}}const mo=["keydown","keyup"];class qg extends cn{constructor(e,t,n){super(e,t,{enable:!0,tabIndex:0,...n}),this.handleEvent=r=>{const i=r.target||r.srcElement;i.tagName==="INPUT"&&i.type==="text"||i.tagName==="TEXTAREA"||(this.enableDownEvent&&r.type==="keydown"&&this.callback({type:"keydown",srcEvent:r,key:r.key,target:r.target}),this.enableUpEvent&&r.type==="keyup"&&this.callback({type:"keyup",srcEvent:r,key:r.key,target:r.target}))},this.enableDownEvent=this.options.enable,this.enableUpEvent=this.options.enable,e.tabIndex=this.options.tabIndex,e.style.outline="none",mo.forEach(r=>e.addEventListener(r,this.handleEvent))}destroy(){mo.forEach(e=>this.element.removeEventListener(e,this.handleEvent))}enableEventType(e,t){e==="keydown"&&(this.enableDownEvent=t),e==="keyup"&&(this.enableUpEvent=t)}}class Kg extends cn{constructor(e,t,n){super(e,t,n),this.handleEvent=r=>{this.options.enable&&this.callback({type:"contextmenu",center:{x:r.clientX,y:r.clientY},srcEvent:r,pointerType:"mouse",target:r.target})},e.addEventListener("contextmenu",this.handleEvent)}destroy(){this.element.removeEventListener("contextmenu",this.handleEvent)}enableEventType(e,t){e==="contextmenu"&&(this.options.enable=t)}}const bo=1,cr=2,yo=4,Zg={pointerdown:bo,pointermove:cr,pointerup:yo,mousedown:bo,mousemove:cr,mouseup:yo},Qg=0,Jg=1,Gg=2,e_=1,t_=2,s_=4;function n_(s){const e=Zg[s.srcEvent.type];if(!e)return null;const{buttons:t,button:n}=s.srcEvent;let r=!1,i=!1,o=!1;return e===cr?(r=!!(t&e_),i=!!(t&s_),o=!!(t&t_)):(r=n===Qg,i=n===Jg,o=n===Gg),{leftButton:r,middleButton:i,rightButton:o}}function r_(s,e){const t=s.center;if(!t)return null;const n=e.getBoundingClientRect(),r=n.width/e.offsetWidth||1,i=n.height/e.offsetHeight||1,o={x:(t.x-n.left-e.clientLeft)/r,y:(t.y-n.top-e.clientTop)/i};return{center:t,offsetCenter:o}}const i_={srcElement:"root",priority:0};class o_{constructor(e,t){this.handleEvent=n=>{if(this.isEmpty())return;const r=this._normalizeEvent(n);let i=n.srcEvent.target;for(;i&&i!==r.rootElement;){if(this._emit(r,i),r.handled)return;i=i.parentNode}this._emit(r,"root")},this.eventManager=e,this.recognizerName=t,this.handlers=[],this.handlersByElement=new Map,this._active=!1}isEmpty(){return!this._active}add(e,t,n,r=!1,i=!1){const{handlers:o,handlersByElement:a}=this,c={...i_,...n};let l=a.get(c.srcElement);l||(l=[],a.set(c.srcElement,l));const u={type:e,handler:t,srcElement:c.srcElement,priority:c.priority};r&&(u.once=!0),i&&(u.passive=!0),o.push(u),this._active=this._active||!u.passive;let h=l.length-1;for(;h>=0&&!(l[h].priority>=u.priority);)h--;l.splice(h+1,0,u)}remove(e,t){const{handlers:n,handlersByElement:r}=this;for(let i=n.length-1;i>=0;i--){const o=n[i];if(o.type===e&&o.handler===t){n.splice(i,1);const a=r.get(o.srcElement);a.splice(a.indexOf(o),1),a.length===0&&r.delete(o.srcElement)}}this._active=n.some(i=>!i.passive)}_emit(e,t){const n=this.handlersByElement.get(t);if(n){let r=!1;const i=()=>{e.handled=!0},o=()=>{e.handled=!0,r=!0},a=[];for(let c=0;c<n.length;c++){const{type:l,handler:u,once:h}=n[c];if(u({...e,type:l,stopPropagation:i,stopImmediatePropagation:o}),h&&a.push(n[c]),r)break}for(let c=0;c<a.length;c++){const{type:l,handler:u}=a[c];this.remove(l,u)}}}_normalizeEvent(e){const t=this.eventManager.getElement();return{...e,...n_(e),...r_(e,t),preventDefault:()=>{e.srcEvent.preventDefault()},stopImmediatePropagation:null,stopPropagation:null,handled:!1,rootElement:t}}}function a_(s){if("recognizer"in s)return s;let e;const t=Array.isArray(s)?[...s]:[s];if(typeof t[0]=="function"){const n=t.shift(),r=t.shift()||{};e=new n(r)}else e=t.shift();return{recognizer:e,recognizeWith:typeof t[0]=="string"?[t[0]]:t[0],requireFailure:typeof t[1]=="string"?[t[1]]:t[1]}}class c_{constructor(e=null,t={}){if(this._onBasicInput=n=>{this.manager.emit(n.srcEvent.type,n)},this._onOtherEvent=n=>{this.manager.emit(n.type,n)},this.options={recognizers:[],events:{},touchAction:"compute",tabIndex:0,cssProps:{},...t},this.events=new Map,this.element=e,!!e){this.manager=new Fg(e,this.options);for(const n of this.options.recognizers){const{recognizer:r,recognizeWith:i,requireFailure:o}=a_(n);this.manager.add(r),i&&r.recognizeWith(i),o&&r.requireFailure(o)}this.manager.on("hammer.input",this._onBasicInput),this.wheelInput=new Xg(e,this._onOtherEvent,{enable:!1}),this.moveInput=new Yg(e,this._onOtherEvent,{enable:!1}),this.keyInput=new qg(e,this._onOtherEvent,{enable:!1,tabIndex:t.tabIndex}),this.contextmenuInput=new Kg(e,this._onOtherEvent,{enable:!1}),this.on(this.options.events)}}getElement(){return this.element}destroy(){this.element&&(this.wheelInput.destroy(),this.moveInput.destroy(),this.keyInput.destroy(),this.contextmenuInput.destroy(),this.manager.destroy())}on(e,t,n){this._addEventHandler(e,t,n,!1)}once(e,t,n){this._addEventHandler(e,t,n,!0)}watch(e,t,n){this._addEventHandler(e,t,n,!1,!0)}off(e,t){this._removeEventHandler(e,t)}_toggleRecognizer(e,t){const{manager:n}=this;if(!n)return;const r=n.get(e);r&&(r.set({enable:t}),n.touchAction.update()),this.wheelInput?.enableEventType(e,t),this.moveInput?.enableEventType(e,t),this.keyInput?.enableEventType(e,t),this.contextmenuInput?.enableEventType(e,t)}_addEventHandler(e,t,n,r,i){if(typeof e!="string"){n=t;for(const[l,u]of Object.entries(e))this._addEventHandler(l,u,n,r,i);return}const{manager:o,events:a}=this;if(!o)return;let c=a.get(e);if(!c){const l=this._getRecognizerName(e)||e;c=new o_(this,l),a.set(e,c),o&&o.on(e,c.handleEvent)}c.add(e,t,n,r,i),c.isEmpty()||this._toggleRecognizer(c.recognizerName,!0)}_removeEventHandler(e,t){if(typeof e!="string"){for(const[i,o]of Object.entries(e))this._removeEventHandler(i,o);return}const{events:n}=this,r=n.get(e);if(r&&(r.remove(e,t),r.isEmpty())){const{recognizerName:i}=r;let o=!1;for(const a of n.values())if(a.recognizerName===i&&!a.isEmpty()){o=!0;break}o||this._toggleRecognizer(i,!1)}}_getRecognizerName(e){return this.manager.recognizers.find(t=>t.getEventNames().includes(e))?.options.event}}const W={DEFAULT:-1,LNGLAT:1,METER_OFFSETS:2,LNGLAT_OFFSETS:3,CARTESIAN:0};Object.defineProperty(W,"IDENTITY",{get:()=>(Y.deprecated("COORDINATE_SYSTEM.IDENTITY","COORDINATE_SYSTEM.CARTESIAN")(),0)});const me={WEB_MERCATOR:1,GLOBE:2,WEB_MERCATOR_AUTO_OFFSET:4,IDENTITY:0},Ys={common:0,meters:1,pixels:2},lr={click:"onClick",dblclick:"onClick",panstart:"onDragStart",panmove:"onDrag",panend:"onDragEnd"},To={multipan:[po,{threshold:10,direction:ie.Vertical,pointers:2}],pinch:[$g,{},null,["multipan"]],pan:[po,{threshold:1},["pinch"],["multipan"]],dblclick:[fo,{event:"dblclick",taps:2}],click:[fo,{event:"click"},null,["dblclick"]]};function l_(s,e){if(s===e)return!0;if(Array.isArray(s)){const t=s.length;if(!e||e.length!==t)return!1;for(let n=0;n<t;n++)if(s[n]!==e[n])return!1;return!0}return!1}function us(s){let e={},t;return n=>{for(const r in n)if(!l_(n[r],e[r])){t=s(n),e=n;break}return t}}const wo=[0,0,0,0],u_=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0],Dc=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],h_=[0,0,0],Fc=[0,0,0],f_=us(g_);function Bc(s,e,t=Fc){t.length<3&&(t=[t[0],t[1],0]);let n=t,r,i=!0;switch(e===W.LNGLAT_OFFSETS||e===W.METER_OFFSETS?r=t:r=s.isGeospatial?[Math.fround(s.longitude),Math.fround(s.latitude),0]:null,s.projectionMode){case me.WEB_MERCATOR:(e===W.LNGLAT||e===W.CARTESIAN)&&(r=[0,0,0],i=!1);break;case me.WEB_MERCATOR_AUTO_OFFSET:e===W.LNGLAT?n=r:e===W.CARTESIAN&&(n=[Math.fround(s.center[0]),Math.fround(s.center[1]),0],r=s.unprojectPosition(n),n[0]-=t[0],n[1]-=t[1],n[2]-=t[2]);break;case me.IDENTITY:n=s.position.map(Math.fround),n[2]=n[2]||0;break;case me.GLOBE:i=!1,r=null;break;default:i=!1}return{geospatialOrigin:r,shaderCoordinateOrigin:n,offsetMode:i}}function d_(s,e,t){const{viewMatrixUncentered:n,projectionMatrix:r}=s;let{viewMatrix:i,viewProjectionMatrix:o}=s,a=wo,c=wo,l=s.cameraPosition;const{geospatialOrigin:u,shaderCoordinateOrigin:h,offsetMode:f}=Bc(s,e,t);return f&&(c=s.projectPosition(u||h),l=[l[0]-c[0],l[1]-c[1],l[2]-c[2]],c[3]=1,a=ls([],c,o),i=n||i,o=rt([],r,i),o=rt([],o,u_)),{viewMatrix:i,viewProjectionMatrix:o,projectionCenter:a,originCommon:c,cameraPosCommon:l,shaderCoordinateOrigin:h,geospatialOrigin:u}}function p_({viewport:s,devicePixelRatio:e=1,modelMatrix:t=null,coordinateSystem:n=W.DEFAULT,coordinateOrigin:r=Fc,autoWrapLongitude:i=!1}){n===W.DEFAULT&&(n=s.isGeospatial?W.LNGLAT:W.CARTESIAN);const o=f_({viewport:s,devicePixelRatio:e,coordinateSystem:n,coordinateOrigin:r});return o.wrapLongitude=i,o.modelMatrix=t||Dc,o}function g_({viewport:s,devicePixelRatio:e,coordinateSystem:t,coordinateOrigin:n}){const{projectionCenter:r,viewProjectionMatrix:i,originCommon:o,cameraPosCommon:a,shaderCoordinateOrigin:c,geospatialOrigin:l}=d_(s,t,n),u=s.getDistanceScales(),h=[s.width*e,s.height*e],f=ls([],[0,0,-s.focalDistance,1],s.projectionMatrix)[3]||1,g={coordinateSystem:t,projectionMode:s.projectionMode,coordinateOrigin:c,commonOrigin:o.slice(0,3),center:r,pseudoMeters:!!s._pseudoMeters,viewportSize:h,devicePixelRatio:e,focalDistance:f,commonUnitsPerMeter:u.unitsPerMeter,commonUnitsPerWorldUnit:u.unitsPerMeter,commonUnitsPerWorldUnit2:h_,scale:s.scale,wrapLongitude:!1,viewProjectionMatrix:i,modelMatrix:Dc,cameraPosition:a};if(l){const _=s.getDistanceScales(l);switch(t){case W.METER_OFFSETS:g.commonUnitsPerWorldUnit=_.unitsPerMeter,g.commonUnitsPerWorldUnit2=_.unitsPerMeter2;break;case W.LNGLAT:case W.LNGLAT_OFFSETS:s._pseudoMeters||(g.commonUnitsPerMeter=_.unitsPerMeter),g.commonUnitsPerWorldUnit=_.unitsPerDegree,g.commonUnitsPerWorldUnit2=_.unitsPerDegree2;break;case W.CARTESIAN:g.commonUnitsPerWorldUnit=[1,1,_.unitsPerMeter[2]],g.commonUnitsPerWorldUnit2=[0,0,_.unitsPerMeter2[2]];break}}return g}const __=Object.keys(W).map(s=>`const COORDINATE_SYSTEM_${s}: i32 = ${W[s]};`).join(""),m_=Object.keys(me).map(s=>`const PROJECTION_MODE_${s}: i32 = ${me[s]};`).join(""),b_=Object.keys(Ys).map(s=>`const UNIT_${s.toUpperCase()}: i32 = ${Ys[s]};`).join(""),y_=`${__}
${m_}
${b_}

const TILE_SIZE: f32 = 512.0;
const PI: f32 = 3.1415926536;
const WORLD_SCALE: f32 = TILE_SIZE / (PI * 2.0);
const ZERO_64_LOW: vec3<f32> = vec3<f32>(0.0, 0.0, 0.0);
const EARTH_RADIUS: f32 = 6370972.0; // meters
const GLOBE_RADIUS: f32 = 256.0;

// -----------------------------------------------------------------------------
// Uniform block (converted from GLSL uniform block)
// -----------------------------------------------------------------------------
struct ProjectUniforms {
  wrapLongitude: i32,
  coordinateSystem: i32,
  commonUnitsPerMeter: vec3<f32>,
  projectionMode: i32,
  scale: f32,
  commonUnitsPerWorldUnit: vec3<f32>,
  commonUnitsPerWorldUnit2: vec3<f32>,
  center: vec4<f32>,
  modelMatrix: mat4x4<f32>,
  viewProjectionMatrix: mat4x4<f32>,
  viewportSize: vec2<f32>,
  devicePixelRatio: f32,
  focalDistance: f32,
  cameraPosition: vec3<f32>,
  coordinateOrigin: vec3<f32>,
  commonOrigin: vec3<f32>,
  pseudoMeters: i32,
};

@group(0) @binding(0)
var<uniform> project: ProjectUniforms;

// -----------------------------------------------------------------------------
// Geometry data
// (In your GLSL code, "geometry" was assumed to be available globally. In WGSL,
// you might supply this via vertex attributes or a uniform. Here we define a
// uniform struct for demonstration.)
// -----------------------------------------------------------------------------

// Structure to carry additional geometry data used by deck.gl filters.
struct Geometry {
  worldPosition: vec3<f32>,
  worldPositionAlt: vec3<f32>,
  position: vec4<f32>,
  uv: vec2<f32>,
  pickingColor: vec3<f32>,
};

// @group(0) @binding(1)
var<private> geometry: Geometry;
`,T_=`${y_}

// -----------------------------------------------------------------------------
// Functions
// -----------------------------------------------------------------------------

// Returns an adjustment factor for commonUnitsPerMeter
fn _project_size_at_latitude(lat: f32) -> f32 {
  let y = clamp(lat, -89.9, 89.9);
  return 1.0 / cos(radians(y));
}

// Overloaded version: scales a value in meters at a given latitude.
fn _project_size_at_latitude_m(meters: f32, lat: f32) -> f32 {
  return meters * project.commonUnitsPerMeter.z * _project_size_at_latitude(lat);
}

// Computes a non-linear scale factor based on geometry.
// (Note: This function relies on "geometry" being provided.)
fn project_size() -> f32 {
  if (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR &&
      project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT &&
      project.pseudoMeters == 0) {
    if (geometry.position.w == 0.0) {
      return _project_size_at_latitude(geometry.worldPosition.y);
    }
    let y: f32 = geometry.position.y / TILE_SIZE * 2.0 - 1.0;
    let y2 = y * y;
    let y4 = y2 * y2;
    let y6 = y4 * y2;
    return 1.0 + 4.9348 * y2 + 4.0587 * y4 + 1.5642 * y6;
  }
  return 1.0;
}

// Overloads to scale offsets (meters to world units)
fn project_size_float(meters: f32) -> f32 {
  return meters * project.commonUnitsPerMeter.z * project_size();
}

fn project_size_vec2(meters: vec2<f32>) -> vec2<f32> {
  return meters * project.commonUnitsPerMeter.xy * project_size();
}

fn project_size_vec3(meters: vec3<f32>) -> vec3<f32> {
  return meters * project.commonUnitsPerMeter * project_size();
}

fn project_size_vec4(meters: vec4<f32>) -> vec4<f32> {
  return vec4<f32>(meters.xyz * project.commonUnitsPerMeter, meters.w);
}

// Returns a rotation matrix aligning the z‑axis with the given up vector.
fn project_get_orientation_matrix(up: vec3<f32>) -> mat3x3<f32> {
  let uz = normalize(up);
  let ux = select(
    vec3<f32>(1.0, 0.0, 0.0),
    normalize(vec3<f32>(uz.y, -uz.x, 0.0)),
    abs(uz.z) == 1.0
  );
  let uy = cross(uz, ux);
  return mat3x3<f32>(ux, uy, uz);
}

// Since WGSL does not support "out" parameters, we return a struct.
struct RotationResult {
  needsRotation: bool,
  transform: mat3x3<f32>,
};

fn project_needs_rotation(commonPosition: vec3<f32>) -> RotationResult {
  if (project.projectionMode == PROJECTION_MODE_GLOBE) {
    return RotationResult(true, project_get_orientation_matrix(commonPosition));
  } else {
    return RotationResult(false, mat3x3<f32>());  // identity alternative if needed
  };
}

// Projects a normal vector from the current coordinate system to world space.
fn project_normal(vector: vec3<f32>) -> vec3<f32> {
  let normal_modelspace = project.modelMatrix * vec4<f32>(vector, 0.0);
  var n = normalize(normal_modelspace.xyz * project.commonUnitsPerMeter);
  let rotResult = project_needs_rotation(geometry.position.xyz);
  if (rotResult.needsRotation) {
    n = rotResult.transform * n;
  }
  return n;
}

// Applies a scale offset based on y-offset (dy)
fn project_offset_(offset: vec4<f32>) -> vec4<f32> {
  let dy: f32 = offset.y;
  let commonUnitsPerWorldUnit = project.commonUnitsPerWorldUnit + project.commonUnitsPerWorldUnit2 * dy;
  return vec4<f32>(offset.xyz * commonUnitsPerWorldUnit, offset.w);
}

// Projects lng/lat coordinates to a unit tile [0,1]
fn project_mercator_(lnglat: vec2<f32>) -> vec2<f32> {
  var x = lnglat.x;
  if (project.wrapLongitude != 0) {
    x = ((x + 180.0) % 360.0) - 180.0;
  }
  let y = clamp(lnglat.y, -89.9, 89.9);
  return vec2<f32>(
    radians(x) + PI,
    PI + log(tan(PI * 0.25 + radians(y) * 0.5))
  ) * WORLD_SCALE;
}

// Projects lng/lat/z coordinates for a globe projection.
fn project_globe_(lnglatz: vec3<f32>) -> vec3<f32> {
  let lambda = radians(lnglatz.x);
  let phi = radians(lnglatz.y);
  let cosPhi = cos(phi);
  let D = (lnglatz.z / EARTH_RADIUS + 1.0) * GLOBE_RADIUS;
  return vec3<f32>(
    sin(lambda) * cosPhi,
    -cos(lambda) * cosPhi,
    sin(phi)
  ) * D;
}

// Projects positions (with an optional 64-bit low part) from the input
// coordinate system to the common space.
fn project_position_vec4_f64(position: vec4<f32>, position64Low: vec3<f32>) -> vec4<f32> {
  var position_world = project.modelMatrix * position;

  // Work around for a Mac+NVIDIA bug:
  if (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR) {
    if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
      return vec4<f32>(
        project_mercator_(position_world.xy),
        _project_size_at_latitude_m(position_world.z, position_world.y),
        position_world.w
      );
    }
    if (project.coordinateSystem == COORDINATE_SYSTEM_CARTESIAN) {
      position_world = vec4f(position_world.xyz + project.coordinateOrigin, position_world.w);
    }
  }
  if (project.projectionMode == PROJECTION_MODE_GLOBE) {
    if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
      return vec4<f32>(
        project_globe_(position_world.xyz),
        position_world.w
      );
    }
  }
  if (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET) {
    if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
      if (abs(position_world.y - project.coordinateOrigin.y) > 0.25) {
        return vec4<f32>(
          project_mercator_(position_world.xy) - project.commonOrigin.xy,
          project_size_float(position_world.z),
          position_world.w
        );
      }
    }
  }
  if (project.projectionMode == PROJECTION_MODE_IDENTITY ||
      (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET &&
       (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT ||
        project.coordinateSystem == COORDINATE_SYSTEM_CARTESIAN))) {
    position_world = vec4f(position_world.xyz - project.coordinateOrigin, position_world.w);
  }

  return project_offset_(position_world) +
         project_offset_(project.modelMatrix * vec4<f32>(position64Low, 0.0));
}

// Overloaded versions for different input types.
fn project_position_vec4_f32(position: vec4<f32>) -> vec4<f32> {
  return project_position_vec4_f64(position, ZERO_64_LOW);
}

fn project_position_vec3_f64(position: vec3<f32>, position64Low: vec3<f32>) -> vec3<f32> {
  let projected_position = project_position_vec4_f64(vec4<f32>(position, 1.0), position64Low);
  return projected_position.xyz;
}

fn project_position_vec3_f32(position: vec3<f32>) -> vec3<f32> {
  let projected_position = project_position_vec4_f64(vec4<f32>(position, 1.0), ZERO_64_LOW);
  return projected_position.xyz;
}

fn project_position_vec2_f32(position: vec2<f32>) -> vec2<f32> {
  let projected_position = project_position_vec4_f64(vec4<f32>(position, 0.0, 1.0), ZERO_64_LOW);
  return projected_position.xy;
}

// Transforms a common space position to clip space.
fn project_common_position_to_clipspace_with_projection(position: vec4<f32>, viewProjectionMatrix: mat4x4<f32>, center: vec4<f32>) -> vec4<f32> {
  return viewProjectionMatrix * position + center;
}

// Uses the project viewProjectionMatrix and center.
fn project_common_position_to_clipspace(position: vec4<f32>) -> vec4<f32> {
  return project_common_position_to_clipspace_with_projection(position, project.viewProjectionMatrix, project.center);
}

// Returns a clip space offset corresponding to a given number of screen pixels.
fn project_pixel_size_to_clipspace(pixels: vec2<f32>) -> vec2<f32> {
  let offset = pixels / project.viewportSize * project.devicePixelRatio * 2.0;
  return offset * project.focalDistance;
}

fn project_meter_size_to_pixel(meters: f32) -> f32 {
  return project_size_float(meters) * project.scale;
}

fn project_unit_size_to_pixel(size: f32, unit: i32) -> f32 {
  if (unit == UNIT_METERS) {
    return project_meter_size_to_pixel(size);
  } else if (unit == UNIT_COMMON) {
    return size * project.scale;
  }
  // UNIT_PIXELS: no scaling applied.
  return size;
}

fn project_pixel_size_float(pixels: f32) -> f32 {
  return pixels / project.scale;
}

fn project_pixel_size_vec2(pixels: vec2<f32>) -> vec2<f32> {
  return pixels / project.scale;
}
`,w_=Object.keys(W).map(s=>`const int COORDINATE_SYSTEM_${s} = ${W[s]};`).join(""),v_=Object.keys(me).map(s=>`const int PROJECTION_MODE_${s} = ${me[s]};`).join(""),A_=Object.keys(Ys).map(s=>`const int UNIT_${s.toUpperCase()} = ${Ys[s]};`).join(""),x_=`${w_}
${v_}
${A_}
uniform projectUniforms {
bool wrapLongitude;
int coordinateSystem;
vec3 commonUnitsPerMeter;
int projectionMode;
float scale;
vec3 commonUnitsPerWorldUnit;
vec3 commonUnitsPerWorldUnit2;
vec4 center;
mat4 modelMatrix;
mat4 viewProjectionMatrix;
vec2 viewportSize;
float devicePixelRatio;
float focalDistance;
vec3 cameraPosition;
vec3 coordinateOrigin;
vec3 commonOrigin;
bool pseudoMeters;
} project;
const float TILE_SIZE = 512.0;
const float PI = 3.1415926536;
const float WORLD_SCALE = TILE_SIZE / (PI * 2.0);
const vec3 ZERO_64_LOW = vec3(0.0);
const float EARTH_RADIUS = 6370972.0;
const float GLOBE_RADIUS = 256.0;
float project_size_at_latitude(float lat) {
float y = clamp(lat, -89.9, 89.9);
return 1.0 / cos(radians(y));
}
float project_size() {
if (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR &&
project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT &&
project.pseudoMeters == false) {
if (geometry.position.w == 0.0) {
return project_size_at_latitude(geometry.worldPosition.y);
}
float y = geometry.position.y / TILE_SIZE * 2.0 - 1.0;
float y2 = y * y;
float y4 = y2 * y2;
float y6 = y4 * y2;
return 1.0 + 4.9348 * y2 + 4.0587 * y4 + 1.5642 * y6;
}
return 1.0;
}
float project_size_at_latitude(float meters, float lat) {
return meters * project.commonUnitsPerMeter.z * project_size_at_latitude(lat);
}
float project_size(float meters) {
return meters * project.commonUnitsPerMeter.z * project_size();
}
vec2 project_size(vec2 meters) {
return meters * project.commonUnitsPerMeter.xy * project_size();
}
vec3 project_size(vec3 meters) {
return meters * project.commonUnitsPerMeter * project_size();
}
vec4 project_size(vec4 meters) {
return vec4(meters.xyz * project.commonUnitsPerMeter, meters.w);
}
mat3 project_get_orientation_matrix(vec3 up) {
vec3 uz = normalize(up);
vec3 ux = abs(uz.z) == 1.0 ? vec3(1.0, 0.0, 0.0) : normalize(vec3(uz.y, -uz.x, 0));
vec3 uy = cross(uz, ux);
return mat3(ux, uy, uz);
}
bool project_needs_rotation(vec3 commonPosition, out mat3 transform) {
if (project.projectionMode == PROJECTION_MODE_GLOBE) {
transform = project_get_orientation_matrix(commonPosition);
return true;
}
return false;
}
vec3 project_normal(vec3 vector) {
vec4 normal_modelspace = project.modelMatrix * vec4(vector, 0.0);
vec3 n = normalize(normal_modelspace.xyz * project.commonUnitsPerMeter);
mat3 rotation;
if (project_needs_rotation(geometry.position.xyz, rotation)) {
n = rotation * n;
}
return n;
}
vec4 project_offset_(vec4 offset) {
float dy = offset.y;
vec3 commonUnitsPerWorldUnit = project.commonUnitsPerWorldUnit + project.commonUnitsPerWorldUnit2 * dy;
return vec4(offset.xyz * commonUnitsPerWorldUnit, offset.w);
}
vec2 project_mercator_(vec2 lnglat) {
float x = lnglat.x;
if (project.wrapLongitude) {
x = mod(x + 180., 360.0) - 180.;
}
float y = clamp(lnglat.y, -89.9, 89.9);
return vec2(
radians(x) + PI,
PI + log(tan_fp32(PI * 0.25 + radians(y) * 0.5))
) * WORLD_SCALE;
}
vec3 project_globe_(vec3 lnglatz) {
float lambda = radians(lnglatz.x);
float phi = radians(lnglatz.y);
float cosPhi = cos(phi);
float D = (lnglatz.z / EARTH_RADIUS + 1.0) * GLOBE_RADIUS;
return vec3(
sin(lambda) * cosPhi,
-cos(lambda) * cosPhi,
sin(phi)
) * D;
}
vec4 project_position(vec4 position, vec3 position64Low) {
vec4 position_world = project.modelMatrix * position;
if (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR) {
if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
return vec4(
project_mercator_(position_world.xy),
project_size_at_latitude(position_world.z, position_world.y),
position_world.w
);
}
if (project.coordinateSystem == COORDINATE_SYSTEM_CARTESIAN) {
position_world.xyz += project.coordinateOrigin;
}
}
if (project.projectionMode == PROJECTION_MODE_GLOBE) {
if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
return vec4(
project_globe_(position_world.xyz),
position_world.w
);
}
}
if (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET) {
if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
if (abs(position_world.y - project.coordinateOrigin.y) > 0.25) {
return vec4(
project_mercator_(position_world.xy) - project.commonOrigin.xy,
project_size(position_world.z),
position_world.w
);
}
}
}
if (project.projectionMode == PROJECTION_MODE_IDENTITY ||
(project.projectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET &&
(project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT ||
project.coordinateSystem == COORDINATE_SYSTEM_CARTESIAN))) {
position_world.xyz -= project.coordinateOrigin;
}
return project_offset_(position_world) + project_offset_(project.modelMatrix * vec4(position64Low, 0.0));
}
vec4 project_position(vec4 position) {
return project_position(position, ZERO_64_LOW);
}
vec3 project_position(vec3 position, vec3 position64Low) {
vec4 projected_position = project_position(vec4(position, 1.0), position64Low);
return projected_position.xyz;
}
vec3 project_position(vec3 position) {
vec4 projected_position = project_position(vec4(position, 1.0), ZERO_64_LOW);
return projected_position.xyz;
}
vec2 project_position(vec2 position) {
vec4 projected_position = project_position(vec4(position, 0.0, 1.0), ZERO_64_LOW);
return projected_position.xy;
}
vec4 project_common_position_to_clipspace(vec4 position, mat4 viewProjectionMatrix, vec4 center) {
return viewProjectionMatrix * position + center;
}
vec4 project_common_position_to_clipspace(vec4 position) {
return project_common_position_to_clipspace(position, project.viewProjectionMatrix, project.center);
}
vec2 project_pixel_size_to_clipspace(vec2 pixels) {
vec2 offset = pixels / project.viewportSize * project.devicePixelRatio * 2.0;
return offset * project.focalDistance;
}
float project_size_to_pixel(float meters) {
return project_size(meters) * project.scale;
}
float project_size_to_pixel(float size, int unit) {
if (unit == UNIT_METERS) return project_size_to_pixel(size);
if (unit == UNIT_COMMON) return size * project.scale;
return size;
}
float project_pixel_size(float pixels) {
return pixels / project.scale;
}
vec2 project_pixel_size(vec2 pixels) {
return pixels / project.scale;
}
`,E_={};function S_(s=E_){return"viewport"in s?p_(s):{}}const Zr={name:"project",dependencies:[ng,Ic],source:T_,vs:x_,getUniforms:S_,uniformTypes:{wrapLongitude:"f32",coordinateSystem:"i32",commonUnitsPerMeter:"vec3<f32>",projectionMode:"i32",scale:"f32",commonUnitsPerWorldUnit:"vec3<f32>",commonUnitsPerWorldUnit2:"vec3<f32>",center:"vec4<f32>",modelMatrix:"mat4x4<f32>",viewProjectionMatrix:"mat4x4<f32>",viewportSize:"vec2<f32>",devicePixelRatio:"f32",focalDistance:"f32",cameraPosition:"vec3<f32>",coordinateOrigin:"vec3<f32>",commonOrigin:"vec3<f32>",pseudoMeters:"f32"}},R_=`// Define a structure to hold both the clip-space position and the common position.
struct ProjectResult {
  clipPosition: vec4<f32>,
  commonPosition: vec4<f32>,
};

// This function mimics the GLSL version with the 'out' parameter by returning both values.
fn project_position_to_clipspace_and_commonspace(
    position: vec3<f32>,
    position64Low: vec3<f32>,
    offset: vec3<f32>
) -> ProjectResult {
  // Compute the projected position.
  let projectedPosition: vec3<f32> = project_position_vec3_f64(position, position64Low);

  // Start with the provided offset.
  var finalOffset: vec3<f32> = offset;

  // Get whether a rotation is needed and the rotation matrix.
  let rotationResult = project_needs_rotation(projectedPosition);

  // If rotation is needed, update the offset.
  if (rotationResult.needsRotation) {
    finalOffset = rotationResult.transform * offset;
  }

  // Compute the common position.
  let commonPosition: vec4<f32> = vec4<f32>(projectedPosition + finalOffset, 1.0);

  // Convert to clip-space.
  let clipPosition: vec4<f32> = project_common_position_to_clipspace(commonPosition);

  return ProjectResult(clipPosition, commonPosition);
}

// A convenience overload that returns only the clip-space position.
fn project_position_to_clipspace(
    position: vec3<f32>,
    position64Low: vec3<f32>,
    offset: vec3<f32>
) -> vec4<f32> {
  return project_position_to_clipspace_and_commonspace(position, position64Low, offset).clipPosition;
}
`,I_=`vec4 project_position_to_clipspace(
  vec3 position, vec3 position64Low, vec3 offset, out vec4 commonPosition
) {
  vec3 projectedPosition = project_position(position, position64Low);
  mat3 rotation;
  if (project_needs_rotation(projectedPosition, rotation)) {
    // offset is specified as ENU
    // when in globe projection, rotate offset so that the ground alighs with the surface of the globe
    offset = rotation * offset;
  }
  commonPosition = vec4(projectedPosition + offset, 1.0);
  return project_common_position_to_clipspace(commonPosition);
}

vec4 project_position_to_clipspace(
  vec3 position, vec3 position64Low, vec3 offset
) {
  vec4 commonPosition;
  return project_position_to_clipspace(position, position64Low, offset, commonPosition);
}
`,aw={name:"project32",dependencies:[Zr],source:R_,vs:I_};function C_(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function It(s,e){const t=ls([],e,s);return Yp(t,t,1/t[3]),t}function vo(s,e){const t=s%e;return t<0?e+t:t}function ur(s,e,t){return s<e?e:s>t?t:s}function P_(s){return Math.log(s)*Math.LOG2E}const Qr=Math.log2||P_;function Le(s,e){if(!s)throw new Error(e||"@math.gl/web-mercator: assertion failed.")}const Se=Math.PI,Uc=Se/4,Te=Se/180,hr=180/Se,Nt=512,qs=4003e4,ws=85.051129,M_=1.5;function cw(s){return Math.pow(2,s)}function O_(s){return Qr(s)}function Ks(s){const[e,t]=s;Le(Number.isFinite(e)),Le(Number.isFinite(t)&&t>=-90&&t<=90,"invalid latitude");const n=e*Te,r=t*Te,i=Nt*(n+Se)/(2*Se),o=Nt*(Se+Math.log(Math.tan(Uc+r*.5)))/(2*Se);return[i,o]}function Dt(s){const[e,t]=s,n=e/Nt*(2*Se)-Se,r=2*(Math.atan(Math.exp(t/Nt*(2*Se)-Se))-Uc);return[n*hr,r*hr]}function k_(s){const{latitude:e}=s;Le(Number.isFinite(e));const t=Math.cos(e*Te);return O_(qs*t)-9}function kn(s){const e=Math.cos(s*Te);return Nt/qs/e}function fr(s){const{latitude:e,longitude:t,highPrecision:n=!1}=s;Le(Number.isFinite(e)&&Number.isFinite(t));const r=Nt,i=Math.cos(e*Te),o=r/360,a=o/i,c=r/qs/i,l={unitsPerMeter:[c,c,c],metersPerUnit:[1/c,1/c,1/c],unitsPerDegree:[o,a,c],degreesPerUnit:[1/o,1/a,1/c]};if(n){const u=Te*Math.tan(e*Te)/i,h=o*u/2,f=r/qs*u,g=f/a*c;l.unitsPerDegree2=[0,h,f],l.unitsPerMeter2=[g,0,g]}return l}function Lc(s,e){const[t,n,r]=s,[i,o,a]=e,{unitsPerMeter:c,unitsPerMeter2:l}=fr({longitude:t,latitude:n,highPrecision:!0}),u=Ks(s);u[0]+=i*(c[0]+l[0]*o),u[1]+=o*(c[1]+l[1]*o);const h=Dt(u),f=(r||0)+(a||0);return Number.isFinite(r)||Number.isFinite(a)?[h[0],h[1],f]:h}function N_(s){const{height:e,pitch:t,bearing:n,altitude:r,scale:i,center:o}=s,a=C_();zs(a,a,[0,0,-r]),Ac(a,a,-t*Te),xc(a,a,n*Te);const c=i/e;return Kr(a,a,[c,c,c]),o&&zs(a,a,xp([],o)),a}function Vc(s){const{width:e,height:t,altitude:n,pitch:r=0,offset:i,center:o,scale:a,nearZMultiplier:c=1,farZMultiplier:l=1}=s;let{fovy:u=Zs(M_)}=s;n!==void 0&&(u=Zs(n));const h=u*Te,f=r*Te,g=$c(u);let _=g;o&&(_+=o[2]*a/Math.cos(f)/t);const w=h*(.5+(i?i[1]:0)/t),A=Math.sin(w)*_/Math.sin(ur(Math.PI/2-f-w,.01,Math.PI-.01)),S=Math.sin(f)*A+_,I=_*10,x=Math.min(S*l,I);return{fov:h,aspect:e/t,focalDistance:g,near:c,far:x}}function lw(s){const{fov:e,aspect:t,near:n,far:r}=Vc(s);return Ec([],e,t,n,r)}function Zs(s){return 2*Math.atan(.5/s)*hr}function $c(s){return .5/Math.tan(.5*s*Te)}function Wc(s,e){const[t,n,r=0]=s;return Le(Number.isFinite(t)&&Number.isFinite(n)&&Number.isFinite(r)),It(e,[t,n,r,1])}function Jr(s,e,t=0){const[n,r,i]=s;if(Le(Number.isFinite(n)&&Number.isFinite(r),"invalid pixel coordinate"),Number.isFinite(i))return It(e,[n,r,i,1]);const o=It(e,[n,r,0,1]),a=It(e,[n,r,1,1]),c=o[2],l=a[2],u=c===l?0:((t||0)-c)/(l-c);return Tc([],o,a,u)}function D_(s){const{width:e,height:t,bounds:n,minExtent:r=0,maxZoom:i=24,offset:o=[0,0]}=s,[[a,c],[l,u]]=n,h=F_(s.padding),f=Ks([a,ur(u,-ws,ws)]),g=Ks([l,ur(c,-ws,ws)]),_=[Math.max(Math.abs(g[0]-f[0]),r),Math.max(Math.abs(g[1]-f[1]),r)],w=[e-h.left-h.right-Math.abs(o[0])*2,t-h.top-h.bottom-Math.abs(o[1])*2];Le(w[0]>0&&w[1]>0);const A=w[0]/_[0],S=w[1]/_[1],I=(h.right-h.left)/2/A,x=(h.top-h.bottom)/2/S,E=[(g[0]+f[0])/2+I,(g[1]+f[1])/2+x],P=Dt(E),M=Math.min(i,Qr(Math.abs(Math.min(A,S))));return Le(Number.isFinite(M)),{longitude:P[0],latitude:P[1],zoom:M}}function F_(s=0){return typeof s=="number"?{top:s,bottom:s,left:s,right:s}:(Le(Number.isFinite(s.top)&&Number.isFinite(s.bottom)&&Number.isFinite(s.left)&&Number.isFinite(s.right)),s)}const Ao=Math.PI/180;function B_(s,e=0){const{width:t,height:n,unproject:r}=s,i={targetZ:e},o=r([0,n],i),a=r([t,n],i);let c,l;const u=s.fovy?.5*s.fovy*Ao:Math.atan(.5/s.altitude),h=(90-s.pitch)*Ao;return u>h-.01?(c=xo(s,0,e),l=xo(s,t,e)):(c=r([0,0],i),l=r([t,0],i)),[o,a,l,c]}function xo(s,e,t){const{pixelUnprojectionMatrix:n}=s,r=It(n,[e,0,1,1]),i=It(n,[e,s.height,1,1]),a=(t*s.distanceScales.unitsPerMeter[2]-r[2])/(i[2]-r[2]),c=Tc([],r,i,a),l=Dt(c);return l.push(t),l}const Eo=512;function U_(s){const{width:e,height:t,pitch:n=0}=s;let{longitude:r,latitude:i,zoom:o,bearing:a=0}=s;(r<-180||r>180)&&(r=vo(r+180,360)-180),(a<-180||a>180)&&(a=vo(a+180,360)-180);const c=Qr(t/Eo);if(o<=c)o=c,i=0;else{const l=t/2/Math.pow(2,o),u=Dt([0,l])[1];if(i<u)i=u;else{const h=Dt([0,Eo-l])[1];i>h&&(i=h)}}return{width:e,height:t,longitude:r,latitude:i,zoom:o,pitch:n,bearing:a}}const jc=`
uniform shadowUniforms {
  bool drawShadowMap;
  bool useShadowMap;
  vec4 color;
  highp int lightId;
  float lightCount;
  mat4 viewProjectionMatrix0;
  mat4 viewProjectionMatrix1;
  vec4 projectCenter0;
  vec4 projectCenter1;
} shadow;
`,L_=`
const int max_lights = 2;

out vec3 shadow_vPosition[max_lights];

vec4 shadow_setVertexPosition(vec4 position_commonspace) {
  mat4 viewProjectionMatrices[max_lights];
  viewProjectionMatrices[0] = shadow.viewProjectionMatrix0;
  viewProjectionMatrices[1] = shadow.viewProjectionMatrix1;
  vec4 projectCenters[max_lights];
  projectCenters[0] = shadow.projectCenter0;
  projectCenters[1] = shadow.projectCenter1;

  if (shadow.drawShadowMap) {
    return project_common_position_to_clipspace(position_commonspace, viewProjectionMatrices[shadow.lightId], projectCenters[shadow.lightId]);
  }
  if (shadow.useShadowMap) {
    for (int i = 0; i < max_lights; i++) {
      if(i < int(shadow.lightCount)) {
        vec4 shadowMap_position = project_common_position_to_clipspace(position_commonspace, viewProjectionMatrices[i], projectCenters[i]);
        shadow_vPosition[i] = (shadowMap_position.xyz / shadowMap_position.w + 1.0) / 2.0;
      }
    }
  }
  return gl_Position;
}
`,V_=`
${jc}
${L_}
`,$_=`
const int max_lights = 2;
uniform sampler2D shadow_uShadowMap0;
uniform sampler2D shadow_uShadowMap1;

in vec3 shadow_vPosition[max_lights];

const vec4 bitPackShift = vec4(1.0, 255.0, 65025.0, 16581375.0);
const vec4 bitUnpackShift = 1.0 / bitPackShift;
const vec4 bitMask = vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0,  0.0);

float shadow_getShadowWeight(vec3 position, sampler2D shadowMap) {
  vec4 rgbaDepth = texture(shadowMap, position.xy);

  float z = dot(rgbaDepth, bitUnpackShift);
  return smoothstep(0.001, 0.01, position.z - z);
}

vec4 shadow_filterShadowColor(vec4 color) {
  if (shadow.drawShadowMap) {
    vec4 rgbaDepth = fract(gl_FragCoord.z * bitPackShift);
    rgbaDepth -= rgbaDepth.gbaa * bitMask;
    return rgbaDepth;
  }
  if (shadow.useShadowMap) {
    float shadowAlpha = 0.0;
    shadowAlpha += shadow_getShadowWeight(shadow_vPosition[0], shadow_uShadowMap0);
    if(shadow.lightCount > 1.0) {
      shadowAlpha += shadow_getShadowWeight(shadow_vPosition[1], shadow_uShadowMap1);
    }
    shadowAlpha *= shadow.color.a / shadow.lightCount;
    float blendedAlpha = shadowAlpha + color.a * (1.0 - shadowAlpha);

    return vec4(
      mix(color.rgb, shadow.color.rgb, shadowAlpha / blendedAlpha),
      blendedAlpha
    );
  }
  return color;
}
`,W_=`
${jc}
${$_}
`,j_=us(q_),H_=us(K_),z_=[0,0,0,1],X_=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0];function Y_(s,e){const[t,n,r]=s,i=Jr([t,n,r],e);return Number.isFinite(r)?i:[i[0],i[1],0]}function q_({viewport:s,center:e}){return new De(s.viewProjectionMatrix).invert().transform(e)}function K_({viewport:s,shadowMatrices:e}){const t=[],n=s.pixelUnprojectionMatrix,r=s.isGeospatial?void 0:1,i=[[0,0,r],[s.width,0,r],[0,s.height,r],[s.width,s.height,r],[0,0,-1],[s.width,0,-1],[0,s.height,-1],[s.width,s.height,-1]].map(o=>Y_(o,n));for(const o of e){const a=o.clone().translate(new Ne(s.center).negate()),c=i.map(u=>a.transform(u)),l=new De().ortho({left:Math.min(...c.map(u=>u[0])),right:Math.max(...c.map(u=>u[0])),bottom:Math.min(...c.map(u=>u[1])),top:Math.max(...c.map(u=>u[1])),near:Math.min(...c.map(u=>-u[2])),far:Math.max(...c.map(u=>-u[2]))});t.push(l.multiplyRight(o))}return t}function Z_(s){const{shadowEnabled:e=!0,project:t}=s;if(!e||!t||!s.shadowMatrices||!s.shadowMatrices.length)return{drawShadowMap:!1,useShadowMap:!1,shadow_uShadowMap0:s.dummyShadowMap,shadow_uShadowMap1:s.dummyShadowMap};const n=Zr.getUniforms(t),r=j_({viewport:t.viewport,center:n.center}),i=[],o=H_({shadowMatrices:s.shadowMatrices,viewport:t.viewport}).slice();for(let c=0;c<s.shadowMatrices.length;c++){const l=o[c],u=l.clone().translate(new Ne(t.viewport.center).negate());n.coordinateSystem===W.LNGLAT&&n.projectionMode===me.WEB_MERCATOR?(o[c]=u,i[c]=r):(o[c]=l.clone().multiplyRight(X_),i[c]=u.transform(r))}const a={drawShadowMap:!!s.drawToShadowMap,useShadowMap:s.shadowMaps?s.shadowMaps.length>0:!1,color:s.shadowColor||z_,lightId:s.shadowLightId||0,lightCount:s.shadowMatrices.length,shadow_uShadowMap0:s.dummyShadowMap,shadow_uShadowMap1:s.dummyShadowMap};for(let c=0;c<o.length;c++)a[`viewProjectionMatrix${c}`]=o[c],a[`projectCenter${c}`]=i[c];for(let c=0;c<2;c++)a[`shadow_uShadowMap${c}`]=s.shadowMaps&&s.shadowMaps[c]||s.dummyShadowMap;return a}const So={name:"shadow",dependencies:[Zr],vs:V_,fs:W_,inject:{"vs:DECKGL_FILTER_GL_POSITION":`
    position = shadow_setVertexPosition(geometry.position);
    `,"fs:DECKGL_FILTER_COLOR":`
    color = shadow_filterShadowColor(color);
    `},getUniforms:Z_,uniformTypes:{drawShadowMap:"f32",useShadowMap:"f32",color:"vec4<f32>",lightId:"i32",lightCount:"f32",viewProjectionMatrix0:"mat4x4<f32>",viewProjectionMatrix1:"mat4x4<f32>",projectCenter0:"vec4<f32>",projectCenter1:"vec4<f32>"}},uw={...no,defaultUniforms:{...no.defaultUniforms,useFloatColors:!1},inject:{"vs:DECKGL_FILTER_GL_POSITION":`
    // for picking depth values
    picking_setPickingAttribute(position.z / position.w);
  `,"vs:DECKGL_FILTER_COLOR":`
  picking_setPickingColor(geometry.pickingColor);
  `,"fs:DECKGL_FILTER_COLOR":{order:99,injection:`
  // use highlight color if this fragment belongs to the selected object.
  color = picking_filterHighlightColor(color);

  // use picking color if rendering to picking FBO.
  color = picking_filterPickingColor(color);
    `}}},Q_=[Ic],J_=["vs:DECKGL_FILTER_SIZE(inout vec3 size, VertexGeometry geometry)","vs:DECKGL_FILTER_GL_POSITION(inout vec4 position, VertexGeometry geometry)","vs:DECKGL_FILTER_COLOR(inout vec4 color, VertexGeometry geometry)","fs:DECKGL_FILTER_COLOR(inout vec4 color, FragmentGeometry geometry)"],G_=[];function em(s){const e=tt.getDefaultShaderAssembler();for(const n of Q_)e.addDefaultModule(n);const t=s==="glsl"?J_:G_;for(const n of t)e.addShaderHook(n);return e}const tm=[255,255,255],sm=1;let nm=0;class rm{constructor(e={}){this.type="ambient";const{color:t=tm}=e,{intensity:n=sm}=e;this.id=e.id||`ambient-${nm++}`,this.color=t,this.intensity=n}}const im=[255,255,255],om=1,am=[0,0,-1];let cm=0;class Ro{constructor(e={}){this.type="directional";const{color:t=im}=e,{intensity:n=om}=e,{direction:r=am}=e,{_shadow:i=!1}=e;this.id=e.id||`directional-${cm++}`,this.color=t,this.intensity=n,this.type="directional",this.direction=new Ne(r).normalize().toArray(),this.shadow=i}getProjectedLight(e){return this}}class lm{constructor(e,t={id:"pass"}){const{id:n}=t;this.id=n,this.device=e,this.props={...t}}setProps(e){Object.assign(this.props,e)}render(e){}cleanup(){}}class Gr extends lm{constructor(){super(...arguments),this._lastRenderIndex=-1}render(e){const[t,n]=this.device.canvasContext.getDrawingBufferSize(),r=e.clearCanvas??!0,i=e.clearColor??(r?[0,0,0,0]:!1),o=r?1:!1,a=r?0:!1,c=e.colorMask??15,l={viewport:[0,0,t,n]};e.colorMask&&(l.colorMask=c),e.scissorRect&&(l.scissorRect=e.scissorRect);const u=this.device.beginRenderPass({framebuffer:e.target,parameters:l,clearColor:i,clearDepth:o,clearStencil:a});try{return this._drawLayers(u,e)}finally{u.end(),this.device.submit()}}_drawLayers(e,t){const{target:n,shaderModuleProps:r,viewports:i,views:o,onViewportActive:a,clearStack:c=!0}=t;t.pass=t.pass||"unknown",c&&(this._lastRenderIndex=-1);const l=[];for(const u of i){const h=o&&o[u.id];a?.(u);const f=this._getDrawLayerParams(u,t),g=u.subViewports||[u];for(const _ of g){const w=this._drawLayersInViewport(e,{target:n,shaderModuleProps:r,viewport:_,view:h,pass:t.pass,layers:t.layers},f);l.push(w)}}return l}_getDrawLayerParams(e,{layers:t,pass:n,isPicking:r=!1,layerFilter:i,cullRect:o,effects:a,shaderModuleProps:c},l=!1){const u=[],h=Hc(this._lastRenderIndex+1),f={layer:t[0],viewport:e,isPicking:r,renderPass:n,cullRect:o},g={};for(let _=0;_<t.length;_++){const w=t[_],A=this._shouldDrawLayer(w,f,i,g),S={shouldDrawLayer:A};A&&!l&&(S.shouldDrawLayer=!0,S.layerRenderIndex=h(w,A),S.shaderModuleProps=this._getShaderModuleProps(w,a,n,c),S.layerParameters={...w.context.deck?.props.parameters,...this.getLayerParameters(w,_,e)}),u[_]=S}return u}_drawLayersInViewport(e,{layers:t,shaderModuleProps:n,pass:r,target:i,viewport:o,view:a},c){const l=um(this.device,{shaderModuleProps:n,target:i,viewport:o});if(a&&a.props.clear){const h=a.props.clear===!0?{color:!0,depth:!0}:a.props.clear;this.device.beginRenderPass({framebuffer:i,parameters:{viewport:l,scissorRect:l},clearColor:h.color?[0,0,0,0]:!1,clearDepth:h.depth?1:!1}).end()}const u={totalCount:t.length,visibleCount:0,compositeCount:0,pickableCount:0};e.setParameters({viewport:l});for(let h=0;h<t.length;h++){const f=t[h],g=c[h],{shouldDrawLayer:_}=g;if(_&&f.props.pickable&&u.pickableCount++,f.isComposite&&u.compositeCount++,f.isDrawable&&g.shouldDrawLayer){const{layerRenderIndex:w,shaderModuleProps:A,layerParameters:S}=g;u.visibleCount++,this._lastRenderIndex=Math.max(this._lastRenderIndex,w),A.project&&(A.project.viewport=o),f.context.renderPass=e;try{f._drawLayer({renderPass:e,shaderModuleProps:A,uniforms:{layerIndex:w},parameters:S})}catch(I){f.raiseError(I,`drawing ${f} to ${r}`)}}}return u}shouldDrawLayer(e){return!0}getShaderModuleProps(e,t,n){return null}getLayerParameters(e,t,n){return e.props.parameters}_shouldDrawLayer(e,t,n,r){if(!(e.props.visible&&this.shouldDrawLayer(e)))return!1;t.layer=e;let o=e.parent;for(;o;){if(!o.props.visible||!o.filterSubLayer(t))return!1;t.layer=o,o=o.parent}if(n){const a=t.layer.id;if(a in r||(r[a]=n(t)),!r[a])return!1}return e.activateViewport(t.viewport),!0}_getShaderModuleProps(e,t,n,r){const i=this.device.canvasContext.cssToDeviceRatio(),o=e.internalState?.propsInTransition||e.props,a={layer:o,picking:{isActive:!1},project:{viewport:e.context.viewport,devicePixelRatio:i,modelMatrix:o.modelMatrix,coordinateSystem:o.coordinateSystem,coordinateOrigin:o.coordinateOrigin,autoWrapLongitude:e.wrapLongitude}};if(t)for(const c of t)Io(a,c.getShaderModuleProps?.(e,a));return Io(a,this.getShaderModuleProps(e,t,a),r)}}function Hc(s=0,e={}){const t={},n=(r,i)=>{const o=r.props._offset,a=r.id,c=r.parent&&r.parent.id;let l;if(c&&!(c in e)&&n(r.parent,!1),c in t){const u=t[c]=t[c]||Hc(e[c],e);l=u(r,i),t[a]=u}else Number.isFinite(o)?(l=o+(e[c]||0),t[a]=null):l=s;return i&&l>=s&&(s=l+1),e[a]=l,l};return n}function um(s,{shaderModuleProps:e,target:t,viewport:n}){const r=e?.project?.devicePixelRatio??s.canvasContext.cssToDeviceRatio(),[,i]=s.canvasContext.getDrawingBufferSize(),o=t?t.height:i,a=n;return[a.x*r,o-(a.y+a.height)*r,a.width*r,a.height*r]}function Io(s,...e){for(const t of e)if(t)for(const n in t)s[n]?Object.assign(s[n],t[n]):s[n]=t[n];return s}class hm extends Gr{constructor(e,t){super(e,t);const n=e.createTexture({format:"rgba8unorm",width:1,height:1,sampler:{minFilter:"linear",magFilter:"linear",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge"},mipmaps:!0}),r=e.createTexture({format:"depth16unorm",width:1,height:1,mipmaps:!1});this.fbo=e.createFramebuffer({id:"shadowmap",width:1,height:1,colorAttachments:[n],depthStencilAttachment:r})}delete(){this.fbo&&(this.fbo.destroy(),this.fbo=null)}getShadowMap(){return this.fbo.colorAttachments[0].texture}render(e){const t=this.fbo,n=this.device.canvasContext.cssToDeviceRatio(),r=e.viewports[0],i=r.width*n,o=r.height*n,a=[1,1,1,1];(i!==t.width||o!==t.height)&&t.resize({width:i,height:o}),super.render({...e,clearColor:a,target:t,pass:"shadow"})}getLayerParameters(e,t,n){return{...e.props.parameters,blend:!1,depthWriteEnabled:!0,depthCompare:"less-equal"}}shouldDrawLayer(e){return e.props.shadowEnabled!==!1}getShaderModuleProps(e,t,n){return{shadow:{project:n.project,drawToShadowMap:!0}}}}const fm={color:[255,255,255],intensity:1},Co=[{color:[255,255,255],intensity:1,direction:[-1,3,-1]},{color:[255,255,255],intensity:.9,direction:[1,-8,-2.5]}],dm=[0,0,0,200/255];class zc{constructor(e={}){this.id="lighting-effect",this.shadowColor=dm,this.shadow=!1,this.directionalLights=[],this.pointLights=[],this.shadowPasses=[],this.dummyShadowMap=null,this.setProps(e)}setup(e){this.context=e;const{device:t,deck:n}=e;this.shadow&&!this.dummyShadowMap&&(this._createShadowPasses(t),n._addDefaultShaderModule(So),this.dummyShadowMap=t.createTexture({width:1,height:1}))}setProps(e){this.ambientLight=void 0,this.directionalLights=[],this.pointLights=[];for(const t in e){const n=e[t];switch(n.type){case"ambient":this.ambientLight=n;break;case"directional":this.directionalLights.push(n);break;case"point":this.pointLights.push(n);break}}this._applyDefaultLights(),this.shadow=this.directionalLights.some(t=>t.shadow),this.context&&this.setup(this.context),this.props=e}preRender({layers:e,layerFilter:t,viewports:n,onViewportActive:r,views:i}){if(this.shadow){this.shadowMatrices=this._calculateMatrices();for(let o=0;o<this.shadowPasses.length;o++)this.shadowPasses[o].render({layers:e,layerFilter:t,viewports:n,onViewportActive:r,views:i,shaderModuleProps:{shadow:{shadowLightId:o,dummyShadowMap:this.dummyShadowMap,shadowMatrices:this.shadowMatrices}}})}}getShaderModuleProps(e,t){const n=this.shadow?{project:t.project,shadowMaps:this.shadowPasses.map(o=>o.getShadowMap()),dummyShadowMap:this.dummyShadowMap,shadowColor:this.shadowColor,shadowMatrices:this.shadowMatrices}:{},r={enabled:!0,ambientLight:this.ambientLight,directionalLights:this.directionalLights.map(o=>o.getProjectedLight({layer:e})),pointLights:this.pointLights.map(o=>o.getProjectedLight({layer:e}))},i=e.props.material;return{shadow:n,lighting:r,phongMaterial:i,gouraudMaterial:i}}cleanup(e){for(const t of this.shadowPasses)t.delete();this.shadowPasses.length=0,this.dummyShadowMap&&(this.dummyShadowMap.destroy(),this.dummyShadowMap=null,e.deck._removeDefaultShaderModule(So))}_calculateMatrices(){const e=[];for(const t of this.directionalLights){const n=new De().lookAt({eye:new Ne(t.direction).negate()});e.push(n)}return e}_createShadowPasses(e){for(let t=0;t<this.directionalLights.length;t++){const n=new hm(e);this.shadowPasses[t]=n}}_applyDefaultLights(){const{ambientLight:e,pointLights:t,directionalLights:n}=this;!e&&t.length===0&&n.length===0&&(this.ambientLight=new rm(fm),this.directionalLights.push(new Ro(Co[0]),new Ro(Co[1])))}}class pm{constructor(e={}){this._pool=[],this.opts={overAlloc:2,poolSize:100},this.setOptions(e)}setOptions(e){Object.assign(this.opts,e)}allocate(e,t,{size:n=1,type:r,padding:i=0,copy:o=!1,initialize:a=!1,maxCount:c}){const l=r||e&&e.constructor||Float32Array,u=t*n+i;if(ArrayBuffer.isView(e)){if(u<=e.length)return e;if(u*e.BYTES_PER_ELEMENT<=e.buffer.byteLength)return new l(e.buffer,0,u)}let h=1/0;c&&(h=c*n+i);const f=this._allocate(l,u,a,h);return e&&o?f.set(e):a||f.fill(0,0,4),this._release(e),f}release(e){this._release(e)}_allocate(e,t,n,r){let i=Math.max(Math.ceil(t*this.opts.overAlloc),1);i>r&&(i=r);const o=this._pool,a=e.BYTES_PER_ELEMENT*i,c=o.findIndex(l=>l.byteLength>=a);if(c>=0){const l=new e(o.splice(c,1)[0],0,i);return n&&l.fill(0),l}return new e(i)}_release(e){if(!ArrayBuffer.isView(e))return;const t=this._pool,{buffer:n}=e,{byteLength:r}=n,i=t.findIndex(o=>o.byteLength>=r);i<0?t.push(n):(i>0||t.length<this.opts.poolSize)&&t.splice(i,0,n),t.length>this.opts.poolSize&&t.shift()}}const is=new pm;function Xt(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function hw(s,e){const t=s%e;return t<0?e+t:t}function gm(s){return[s[12],s[13],s[14]]}function _m(s){return{left:bt(s[3]+s[0],s[7]+s[4],s[11]+s[8],s[15]+s[12]),right:bt(s[3]-s[0],s[7]-s[4],s[11]-s[8],s[15]-s[12]),bottom:bt(s[3]+s[1],s[7]+s[5],s[11]+s[9],s[15]+s[13]),top:bt(s[3]-s[1],s[7]-s[5],s[11]-s[9],s[15]-s[13]),near:bt(s[3]+s[2],s[7]+s[6],s[11]+s[10],s[15]+s[14]),far:bt(s[3]-s[2],s[7]-s[6],s[11]-s[10],s[15]-s[14])}}const Po=new Ne;function bt(s,e,t,n){Po.set(s,e,t);const r=Po.len();return{distance:n/r,normal:new Ne(-s/r,-e/r,-t/r)}}function mm(s){return s-Math.fround(s)}let $t;function Nn(s,e){const{size:t=1,startIndex:n=0}=e,r=e.endIndex!==void 0?e.endIndex:s.length,i=(r-n)/t;$t=is.allocate($t,i,{type:Float32Array,size:t*2});let o=n,a=0;for(;o<r;){for(let c=0;c<t;c++){const l=s[o++];$t[a+c]=l,$t[a+c+t]=mm(l)}a+=t*2}return $t.subarray(0,i*t*2)}function bm(s){let e=null,t=!1;for(const n of s)n&&(e?(t||(e=[[e[0][0],e[0][1]],[e[1][0],e[1][1]]],t=!0),e[0][0]=Math.min(e[0][0],n[0][0]),e[0][1]=Math.min(e[0][1],n[0][1]),e[1][0]=Math.max(e[1][0],n[1][0]),e[1][1]=Math.max(e[1][1],n[1][1])):e=n);return e}const ym=Math.PI/180,Tm=Xt(),Mo=[0,0,0],wm={unitsPerMeter:[1,1,1],metersPerUnit:[1,1,1]};function vm({width:s,height:e,orthographic:t,fovyRadians:n,focalDistance:r,padding:i,near:o,far:a}){const c=s/e,l=t?new De().orthographic({fovy:n,aspect:c,focalDistance:r,near:o,far:a}):new De().perspective({fovy:n,aspect:c,near:o,far:a});if(i){const{left:u=0,right:h=0,top:f=0,bottom:g=0}=i,_=Ye((u+s-h)/2,0,s)-s/2,w=Ye((f+e-g)/2,0,e)-e/2;l[8]-=_*2/s,l[9]+=w*2/e}return l}class hs{constructor(e={}){this._frustumPlanes={},this.id=e.id||this.constructor.displayName||"viewport",this.x=e.x||0,this.y=e.y||0,this.width=e.width||1,this.height=e.height||1,this.zoom=e.zoom||0,this.padding=e.padding,this.distanceScales=e.distanceScales||wm,this.focalDistance=e.focalDistance||1,this.position=e.position||Mo,this.modelMatrix=e.modelMatrix||null;const{longitude:t,latitude:n}=e;this.isGeospatial=Number.isFinite(n)&&Number.isFinite(t),this._initProps(e),this._initMatrices(e),this.equals=this.equals.bind(this),this.project=this.project.bind(this),this.unproject=this.unproject.bind(this),this.projectPosition=this.projectPosition.bind(this),this.unprojectPosition=this.unprojectPosition.bind(this),this.projectFlat=this.projectFlat.bind(this),this.unprojectFlat=this.unprojectFlat.bind(this)}get subViewports(){return null}get metersPerPixel(){return this.distanceScales.metersPerUnit[2]/this.scale}get projectionMode(){return this.isGeospatial?this.zoom<12?me.WEB_MERCATOR:me.WEB_MERCATOR_AUTO_OFFSET:me.IDENTITY}equals(e){return e instanceof hs?this===e?!0:e.width===this.width&&e.height===this.height&&e.scale===this.scale&&rs(e.projectionMatrix,this.projectionMatrix)&&rs(e.viewMatrix,this.viewMatrix):!1}project(e,{topLeft:t=!0}={}){const n=this.projectPosition(e),r=Wc(n,this.pixelProjectionMatrix),[i,o]=r,a=t?o:this.height-o;return e.length===2?[i,a]:[i,a,r[2]]}unproject(e,{topLeft:t=!0,targetZ:n}={}){const[r,i,o]=e,a=t?i:this.height-i,c=n&&n*this.distanceScales.unitsPerMeter[2],l=Jr([r,a,o],this.pixelUnprojectionMatrix,c),[u,h,f]=this.unprojectPosition(l);return Number.isFinite(o)?[u,h,f]:Number.isFinite(n)?[u,h,n]:[u,h]}projectPosition(e){const[t,n]=this.projectFlat(e),r=(e[2]||0)*this.distanceScales.unitsPerMeter[2];return[t,n,r]}unprojectPosition(e){const[t,n]=this.unprojectFlat(e),r=(e[2]||0)*this.distanceScales.metersPerUnit[2];return[t,n,r]}projectFlat(e){if(this.isGeospatial){const t=Ks(e);return t[1]=Ye(t[1],-318,830),t}return e}unprojectFlat(e){return this.isGeospatial?Dt(e):e}getBounds(e={}){const t={targetZ:e.z||0},n=this.unproject([0,0],t),r=this.unproject([this.width,0],t),i=this.unproject([0,this.height],t),o=this.unproject([this.width,this.height],t);return[Math.min(n[0],r[0],i[0],o[0]),Math.min(n[1],r[1],i[1],o[1]),Math.max(n[0],r[0],i[0],o[0]),Math.max(n[1],r[1],i[1],o[1])]}getDistanceScales(e){return e&&this.isGeospatial?fr({longitude:e[0],latitude:e[1],highPrecision:!0}):this.distanceScales}containsPixel({x:e,y:t,width:n=1,height:r=1}){return e<this.x+this.width&&this.x<e+n&&t<this.y+this.height&&this.y<t+r}getFrustumPlanes(){return this._frustumPlanes.near?this._frustumPlanes:(Object.assign(this._frustumPlanes,_m(this.viewProjectionMatrix)),this._frustumPlanes)}panByPosition(e,t){return null}_initProps(e){const t=e.longitude,n=e.latitude;this.isGeospatial&&(Number.isFinite(e.zoom)||(this.zoom=k_({latitude:n})+Math.log2(this.focalDistance)),this.distanceScales=e.distanceScales||fr({latitude:n,longitude:t}));const r=Math.pow(2,this.zoom);this.scale=r;const{position:i,modelMatrix:o}=e;let a=Mo;if(i&&(a=o?new De(o).transformAsVector(i,[]):i),this.isGeospatial){const c=this.projectPosition([t,n,0]);this.center=new Ne(a).scale(this.distanceScales.unitsPerMeter).add(c)}else this.center=this.projectPosition(a)}_initMatrices(e){const{viewMatrix:t=Tm,projectionMatrix:n=null,orthographic:r=!1,fovyRadians:i,fovy:o=75,near:a=.1,far:c=1e3,padding:l=null,focalDistance:u=1}=e;this.viewMatrixUncentered=t,this.viewMatrix=new De().multiplyRight(t).translate(new Ne(this.center).negate()),this.projectionMatrix=n||vm({width:this.width,height:this.height,orthographic:r,fovyRadians:i||o*ym,focalDistance:u,padding:l,near:a,far:c});const h=Xt();rt(h,h,this.projectionMatrix),rt(h,h,this.viewMatrix),this.viewProjectionMatrix=h,this.viewMatrixInverse=nr([],this.viewMatrix)||this.viewMatrix,this.cameraPosition=gm(this.viewMatrixInverse);const f=Xt(),g=Xt();Kr(f,f,[this.width/2,-this.height/2,1]),zs(f,f,[1,-1,0]),rt(g,f,this.viewProjectionMatrix),this.pixelProjectionMatrix=g,this.pixelUnprojectionMatrix=nr(Xt(),this.pixelProjectionMatrix),this.pixelUnprojectionMatrix||Y.warn("Pixel project matrix not invertible")()}}hs.displayName="Viewport";class Ft extends hs{constructor(e={}){const{latitude:t=0,longitude:n=0,zoom:r=0,pitch:i=0,bearing:o=0,nearZMultiplier:a=.1,farZMultiplier:c=1.01,nearZ:l,farZ:u,orthographic:h=!1,projectionMatrix:f,repeat:g=!1,worldOffset:_=0,position:w,padding:A,legacyMeterSizes:S=!1}=e;let{width:I,height:x,altitude:E=1.5}=e;const P=Math.pow(2,r);I=I||1,x=x||1;let M,D=null;if(f)E=f[5]/2,M=Zs(E);else{e.fovy?(M=e.fovy,E=$c(M)):M=Zs(E);let N;if(A){const{top:U=0,bottom:L=0}=A;N=[0,Ye((U+x-L)/2,0,x)-x/2]}D=Vc({width:I,height:x,scale:P,center:w&&[0,0,w[2]*kn(t)],offset:N,pitch:i,fovy:M,nearZMultiplier:a,farZMultiplier:c}),Number.isFinite(l)&&(D.near=l),Number.isFinite(u)&&(D.far=u)}let B=N_({height:x,pitch:i,bearing:o,scale:P,altitude:E});_&&(B=new De().translate([512*_,0,0]).multiplyLeft(B)),super({...e,width:I,height:x,viewMatrix:B,longitude:n,latitude:t,zoom:r,...D,fovy:M,focalDistance:E}),this.latitude=t,this.longitude=n,this.zoom=r,this.pitch=i,this.bearing=o,this.altitude=E,this.fovy=M,this.orthographic=h,this._subViewports=g?[]:null,this._pseudoMeters=S,Object.freeze(this)}get subViewports(){if(this._subViewports&&!this._subViewports.length){const e=this.getBounds(),t=Math.floor((e[0]+180)/360),n=Math.ceil((e[2]-180)/360);for(let r=t;r<=n;r++){const i=r?new Ft({...this,worldOffset:r}):this;this._subViewports.push(i)}}return this._subViewports}projectPosition(e){if(this._pseudoMeters)return super.projectPosition(e);const[t,n]=this.projectFlat(e),r=(e[2]||0)*kn(e[1]);return[t,n,r]}unprojectPosition(e){if(this._pseudoMeters)return super.unprojectPosition(e);const[t,n]=this.unprojectFlat(e),r=(e[2]||0)/kn(n);return[t,n,r]}addMetersToLngLat(e,t){return Lc(e,t)}panByPosition(e,t){const n=Jr(t,this.pixelUnprojectionMatrix),r=this.projectFlat(e),i=to([],r,pp([],n)),o=to([],this.center,i),[a,c]=this.unprojectFlat(o);return{longitude:a,latitude:c}}getBounds(e={}){const t=B_(this,e.z||0);return[Math.min(t[0][0],t[1][0],t[2][0],t[3][0]),Math.min(t[0][1],t[1][1],t[2][1],t[3][1]),Math.max(t[0][0],t[1][0],t[2][0],t[3][0]),Math.max(t[0][1],t[1][1],t[2][1],t[3][1])]}fitBounds(e,t={}){const{width:n,height:r}=this,{longitude:i,latitude:o,zoom:a}=D_({width:n,height:r,bounds:e,...t});return new Ft({width:n,height:r,longitude:i,latitude:o,zoom:a})}}Ft.displayName="WebMercatorViewport";const Oo=[0,0,0];function Dn(s,e,t=!1){const n=e.projectPosition(s);if(t&&e instanceof Ft){const[r,i,o=0]=s,a=e.getDistanceScales([r,i]);n[2]=o*a.unitsPerMeter[2]}return n}function Am(s){const{viewport:e,modelMatrix:t,coordinateOrigin:n}=s;let{coordinateSystem:r,fromCoordinateSystem:i,fromCoordinateOrigin:o}=s;return r===W.DEFAULT&&(r=e.isGeospatial?W.LNGLAT:W.CARTESIAN),i===void 0&&(i=r),o===void 0&&(o=n),{viewport:e,coordinateSystem:r,coordinateOrigin:n,modelMatrix:t,fromCoordinateSystem:i,fromCoordinateOrigin:o}}function Xc(s,{viewport:e,modelMatrix:t,coordinateSystem:n,coordinateOrigin:r,offsetMode:i}){let[o,a,c=0]=s;switch(t&&([o,a,c]=ls([],[o,a,c,1],t)),n){case W.LNGLAT:return Dn([o,a,c],e,i);case W.LNGLAT_OFFSETS:return Dn([o+r[0],a+r[1],c+(r[2]||0)],e,i);case W.METER_OFFSETS:return Dn(Lc(r,[o,a,c]),e,i);case W.CARTESIAN:default:return e.isGeospatial?[o+r[0],a+r[1],c+r[2]]:e.projectPosition([o,a,c])}}function xm(s,e){const{viewport:t,coordinateSystem:n,coordinateOrigin:r,modelMatrix:i,fromCoordinateSystem:o,fromCoordinateOrigin:a}=Am(e),{autoOffset:c=!0}=e,{geospatialOrigin:l=Oo,shaderCoordinateOrigin:u=Oo,offsetMode:h=!1}=c?Bc(t,n,r):{},f=Xc(s,{viewport:t,modelMatrix:i,coordinateSystem:o,coordinateOrigin:a,offsetMode:h});if(h){const g=t.projectPosition(l||u);kp(f,f,g)}return f}let Em=1,Sm=1;class Yc{time=0;channels=new Map;animations=new Map;playing=!1;lastEngineTime=-1;constructor(){}addChannel(e){const{delay:t=0,duration:n=Number.POSITIVE_INFINITY,rate:r=1,repeat:i=1}=e,o=Em++,a={time:0,delay:t,duration:n,rate:r,repeat:i};return this._setChannelTime(a,this.time),this.channels.set(o,a),o}removeChannel(e){this.channels.delete(e);for(const[t,n]of this.animations)n.channel===e&&this.detachAnimation(t)}isFinished(e){const t=this.channels.get(e);return t===void 0?!1:this.time>=t.delay+t.duration*t.repeat}getTime(e){if(e===void 0)return this.time;const t=this.channels.get(e);return t===void 0?-1:t.time}setTime(e){this.time=Math.max(0,e);const t=this.channels.values();for(const r of t)this._setChannelTime(r,this.time);const n=this.animations.values();for(const r of n){const{animation:i,channel:o}=r;i.setTime(this.getTime(o))}}play(){this.playing=!0}pause(){this.playing=!1,this.lastEngineTime=-1}reset(){this.setTime(0)}attachAnimation(e,t){const n=Sm++;return this.animations.set(n,{animation:e,channel:t}),e.setTime(this.getTime(t)),n}detachAnimation(e){this.animations.delete(e)}update(e){this.playing&&(this.lastEngineTime===-1&&(this.lastEngineTime=e),this.setTime(this.time+(e-this.lastEngineTime)),this.lastEngineTime=e)}_setChannelTime(e,t){const n=t-e.delay,r=e.duration*e.repeat;n>=r?e.time=e.duration*e.rate:(e.time=Math.max(0,n)%e.duration,e.time*=e.rate)}}function Rm(s){return typeof window<"u"&&window.requestAnimationFrame?window.requestAnimationFrame(s):setTimeout(s,1e3/60)}function Im(s){return typeof window<"u"&&window.cancelAnimationFrame?window.cancelAnimationFrame(s):clearTimeout(s)}let Cm=0;const Pm={device:null,onAddHTML:()=>"",onInitialize:async()=>null,onRender:()=>{},onFinalize:()=>{},onError:s=>console.error(s),stats:Gn.stats.get(`animation-loop-${Cm++}`),useDevicePixels:!0,autoResizeViewport:!1,autoResizeDrawingBuffer:!1};class Mm{device=null;canvas=null;props;animationProps=null;timeline=null;stats;cpuTime;gpuTime;frameRate;display;needsRedraw="initialized";_initialized=!1;_running=!1;_animationFrameId=null;_nextFramePromise=null;_resolveNextFrame=null;_cpuStartTime=0;_error=null;constructor(e){if(this.props={...Pm,...e},e=this.props,!e.device)throw new Error("No device provided");const{useDevicePixels:t=!0}=this.props;this.stats=e.stats||new tn({id:"animation-loop-stats"}),this.cpuTime=this.stats.get("CPU Time"),this.gpuTime=this.stats.get("GPU Time"),this.frameRate=this.stats.get("Frame Rate"),this.setProps({autoResizeViewport:e.autoResizeViewport,autoResizeDrawingBuffer:e.autoResizeDrawingBuffer,useDevicePixels:t}),this.start=this.start.bind(this),this.stop=this.stop.bind(this),this._onMousemove=this._onMousemove.bind(this),this._onMouseleave=this._onMouseleave.bind(this)}destroy(){this.stop(),this._setDisplay(null)}delete(){this.destroy()}setError(e){if(this.props.onError(e),this._error=Error(),this.device?.canvasContext?.canvas instanceof HTMLCanvasElement){const n=document.createElement("h1");n.innerHTML=e.message,n.style.position="absolute",n.style.top="20%",n.style.left="10px",n.style.color="black",n.style.backgroundColor="red",document.body.appendChild(n)}}setNeedsRedraw(e){return this.needsRedraw=this.needsRedraw||e,this}setProps(e){return"autoResizeViewport"in e&&(this.props.autoResizeViewport=e.autoResizeViewport||!1),"autoResizeDrawingBuffer"in e&&(this.props.autoResizeDrawingBuffer=e.autoResizeDrawingBuffer||!1),"useDevicePixels"in e&&(this.props.useDevicePixels=e.useDevicePixels||!1),this}async start(){if(this._running)return this;this._running=!0;try{let e;return this._initialized||(this._initialized=!0,await this._initDevice(),this._initialize(),await this.props.onInitialize(this._getAnimationProps())),this._running?(e!==!1&&(this._cancelAnimationFrame(),this._requestAnimationFrame()),this):null}catch(e){const t=e instanceof Error?e:new Error("Unknown error");throw this.props.onError(t),t}}stop(){return this._running&&(this.animationProps&&!this._error&&this.props.onFinalize(this.animationProps),this._cancelAnimationFrame(),this._nextFramePromise=null,this._resolveNextFrame=null,this._running=!1),this}redraw(){return this.device?.isLost||this._error?this:(this._beginFrameTimers(),this._setupFrame(),this._updateAnimationProps(),this._renderFrame(this._getAnimationProps()),this._clearNeedsRedraw(),this._resolveNextFrame&&(this._resolveNextFrame(this),this._nextFramePromise=null,this._resolveNextFrame=null),this._endFrameTimers(),this)}attachTimeline(e){return this.timeline=e,this.timeline}detachTimeline(){this.timeline=null}waitForRender(){return this.setNeedsRedraw("waitForRender"),this._nextFramePromise||(this._nextFramePromise=new Promise(e=>{this._resolveNextFrame=e})),this._nextFramePromise}async toDataURL(){if(this.setNeedsRedraw("toDataURL"),await this.waitForRender(),this.canvas instanceof HTMLCanvasElement)return this.canvas.toDataURL();throw new Error("OffscreenCanvas")}_initialize(){this._startEventHandling(),this._initializeAnimationProps(),this._updateAnimationProps(),this._resizeCanvasDrawingBuffer(),this._resizeViewport()}_setDisplay(e){this.display&&(this.display.destroy(),this.display.animationLoop=null),e&&(e.animationLoop=this),this.display=e}_requestAnimationFrame(){this._running&&(this._animationFrameId=Rm(this._animationFrame.bind(this)))}_cancelAnimationFrame(){this._animationFrameId!==null&&(Im(this._animationFrameId),this._animationFrameId=null)}_animationFrame(){this._running&&(this.redraw(),this._requestAnimationFrame())}_renderFrame(e){if(this.display){this.display._renderFrame(e);return}this.props.onRender(this._getAnimationProps()),this.device?.submit()}_clearNeedsRedraw(){this.needsRedraw=!1}_setupFrame(){this._resizeCanvasDrawingBuffer(),this._resizeViewport()}_initializeAnimationProps(){const e=this.device?.canvasContext?.canvas;if(!this.device||!e)throw new Error("loop");this.animationProps={animationLoop:this,device:this.device,canvas:e,timeline:this.timeline,useDevicePixels:this.props.useDevicePixels,needsRedraw:!1,width:1,height:1,aspect:1,time:0,startTime:Date.now(),engineTime:0,tick:0,tock:0,_mousePosition:null}}_getAnimationProps(){if(!this.animationProps)throw new Error("animationProps");return this.animationProps}_updateAnimationProps(){if(!this.animationProps)return;const{width:e,height:t,aspect:n}=this._getSizeAndAspect();(e!==this.animationProps.width||t!==this.animationProps.height)&&this.setNeedsRedraw("drawing buffer resized"),n!==this.animationProps.aspect&&this.setNeedsRedraw("drawing buffer aspect changed"),this.animationProps.width=e,this.animationProps.height=t,this.animationProps.aspect=n,this.animationProps.needsRedraw=this.needsRedraw,this.animationProps.engineTime=Date.now()-this.animationProps.startTime,this.timeline&&this.timeline.update(this.animationProps.engineTime),this.animationProps.tick=Math.floor(this.animationProps.time/1e3*60),this.animationProps.tock++,this.animationProps.time=this.timeline?this.timeline.getTime():this.animationProps.engineTime}async _initDevice(){if(this.device=await this.props.device,!this.device)throw new Error("No device provided");this.canvas=this.device.canvasContext?.canvas||null}_createInfoDiv(){if(this.canvas&&this.props.onAddHTML){const e=document.createElement("div");document.body.appendChild(e),e.style.position="relative";const t=document.createElement("div");t.style.position="absolute",t.style.left="10px",t.style.bottom="10px",t.style.width="300px",t.style.background="white",this.canvas instanceof HTMLCanvasElement&&e.appendChild(this.canvas),e.appendChild(t);const n=this.props.onAddHTML(t);n&&(t.innerHTML=n)}}_getSizeAndAspect(){if(!this.device)return{width:1,height:1,aspect:1};const[e,t]=this.device?.canvasContext?.getPixelSize()||[1,1];let n=1;const r=this.device?.canvasContext?.canvas;return r&&r.clientHeight?n=r.clientWidth/r.clientHeight:e>0&&t>0&&(n=e/t),{width:e,height:t,aspect:n}}_resizeViewport(){this.props.autoResizeViewport&&this.device.gl&&this.device.gl.viewport(0,0,this.device.gl.drawingBufferWidth,this.device.gl.drawingBufferHeight)}_resizeCanvasDrawingBuffer(){this.props.autoResizeDrawingBuffer&&this.device?.canvasContext?.resize({useDevicePixels:this.props.useDevicePixels})}_beginFrameTimers(){this.frameRate.timeEnd(),this.frameRate.timeStart(),this.cpuTime.timeStart()}_endFrameTimers(){this.cpuTime.timeEnd()}_startEventHandling(){this.canvas&&(this.canvas.addEventListener("mousemove",this._onMousemove.bind(this)),this.canvas.addEventListener("mouseleave",this._onMouseleave.bind(this)))}_onMousemove(e){e instanceof MouseEvent&&(this._getAnimationProps()._mousePosition=[e.offsetX,e.offsetY])}_onMouseleave(e){this._getAnimationProps()._mousePosition=null}}const Fn={};function ln(s="id"){Fn[s]=Fn[s]||1;const e=Fn[s]++;return`${s}-${e}`}class ko{id;userData={};topology;bufferLayout=[];vertexCount;indices;attributes;constructor(e){if(this.id=e.id||ln("geometry"),this.topology=e.topology,this.indices=e.indices||null,this.attributes=e.attributes,this.vertexCount=e.vertexCount,this.bufferLayout=e.bufferLayout||[],this.indices&&!(this.indices.usage&q.INDEX))throw new Error("Index buffer must have INDEX usage")}destroy(){this.indices?.destroy();for(const e of Object.values(this.attributes))e.destroy()}getVertexCount(){return this.vertexCount}getAttributes(){return this.attributes}getIndexes(){return this.indices||null}_calculateVertexCount(e){return e.byteLength/12}}function Om(s,e){if(e instanceof ko)return e;const t=km(s,e),{attributes:n,bufferLayout:r}=Nm(s,e);return new ko({topology:e.topology||"triangle-list",bufferLayout:r,vertexCount:e.vertexCount,indices:t,attributes:n})}function km(s,e){if(!e.indices)return;const t=e.indices.value;return s.createBuffer({usage:q.INDEX,data:t})}function Nm(s,e){const t=[],n={};for(const[i,o]of Object.entries(e.attributes)){let a=i;switch(i){case"POSITION":a="positions";break;case"NORMAL":a="normals";break;case"TEXCOORD_0":a="texCoords";break;case"COLOR_0":a="colors";break}if(o){n[a]=s.createBuffer({data:o.value,id:`${i}-buffer`});const{value:c,size:l,normalized:u}=o;t.push({name:a,format:Rd(c,l,u)})}}const r=e._calculateVertexCount(e.attributes,e.indices);return{attributes:n,bufferLayout:t,vertexCount:r}}class ei{static defaultProps={...Pt.defaultProps};static getDefaultPipelineFactory(e){return e._lumaData.defaultPipelineFactory=e._lumaData.defaultPipelineFactory||new ei(e),e._lumaData.defaultPipelineFactory}device;destroyPolicy;_hashCounter=0;_hashes={};_renderPipelineCache={};_computePipelineCache={};constructor(e){this.device=e,this.destroyPolicy=e.props._factoryDestroyPolicy}createRenderPipeline(e){const t={...Pt.defaultProps,...e},n=this._hashRenderPipeline(t);if(!this._renderPipelineCache[n]){const r=this.device.createRenderPipeline({...t,id:t.id?`${t.id}-cached`:void 0});r.hash=n,this._renderPipelineCache[n]={pipeline:r,useCount:0}}return this._renderPipelineCache[n].useCount++,this._renderPipelineCache[n].pipeline}createComputePipeline(e){const t={...Bs.defaultProps,...e},n=this._hashComputePipeline(t);if(!this._computePipelineCache[n]){const r=this.device.createComputePipeline({...t,id:t.id?`${t.id}-cached`:void 0});r.hash=n,this._computePipelineCache[n]={pipeline:r,useCount:0}}return this._computePipelineCache[n].useCount++,this._computePipelineCache[n].pipeline}release(e){const t=e.hash,n=e instanceof Bs?this._computePipelineCache:this._renderPipelineCache;n[t].useCount--,n[t].useCount===0&&this.destroyPolicy==="unused"&&(n[t].pipeline.destroy(),delete n[t])}_hashComputePipeline(e){return`${this._getHash(e.shader.source)}`}_hashRenderPipeline(e){const t=e.vs?this._getHash(e.vs.source):0,n=e.fs?this._getHash(e.fs.source):0,r="-",i=this._getHash(JSON.stringify(e.bufferLayout));switch(this.device.type){case"webgl":return`${t}/${n}V${r}BL${i}`;default:const o=this._getHash(JSON.stringify(e.parameters));return`${t}/${n}V${r}T${e.topology}P${o}BL${i}`}}_getHash(e){return this._hashes[e]===void 0&&(this._hashes[e]=this._hashCounter++),this._hashes[e]}}class ti{static defaultProps={...on.defaultProps};static getDefaultShaderFactory(e){return e._lumaData.defaultShaderFactory||=new ti(e),e._lumaData.defaultShaderFactory}device;destroyPolicy;_cache={};constructor(e){this.device=e,this.destroyPolicy=e.props._factoryDestroyPolicy}createShader(e){const t=this._hashShader(e);let n=this._cache[t];if(!n){const r=this.device.createShader({...e,id:e.id?`${e.id}-cached`:void 0});this._cache[t]=n={shader:r,useCount:0}}return n.useCount++,n.shader}release(e){const t=this._hashShader(e),n=this._cache[t];n&&(n.useCount--,n.useCount===0&&this.destroyPolicy==="unused"&&(delete this._cache[t],n.shader.destroy()))}_hashShader(e){return`${e.stage}:${e.source}`}}function Dm(s,e){const t={},n="Values";if(s.attributes.length===0&&!s.varyings?.length)return{"No attributes or varyings":{[n]:"N/A"}};for(const r of s.attributes)if(r){const i=`${r.location} ${r.name}: ${r.type}`;t[`in ${i}`]={[n]:r.stepMode||"vertex"}}for(const r of s.varyings||[]){const i=`${r.location} ${r.name}`;t[`out ${i}`]={[n]:JSON.stringify(r)}}return t}let oe=null,Bn=null;function Fm(s,{id:e,minimap:t,opaque:n,top:r="0",left:i="0",rgbaScale:o=1}){oe||(oe=document.createElement("canvas"),oe.id=e,oe.title=e,oe.style.zIndex="100",oe.style.position="absolute",oe.style.top=r,oe.style.left=i,oe.style.border="blue 5px solid",oe.style.transform="scaleY(-1)",document.body.appendChild(oe),Bn=oe.getContext("2d")),(oe.width!==s.width||oe.height!==s.height)&&(oe.width=s.width/2,oe.height=s.height/2,oe.style.width="400px",oe.style.height="400px");const a=s.device.readPixelsToArrayWebGL(s),c=Bn?.createImageData(s.width,s.height);if(c){for(let u=0;u<a.length;u+=4)c.data[0+u+0]=a[u+0]*o,c.data[0+u+1]=a[u+1]*o,c.data[0+u+2]=a[u+2]*o,c.data[0+u+3]=n?255:a[u+3]*o;Bn?.putImageData(c,0,0)}}function dr(s,e,t){if(s===e)return!0;if(!t||!s||!e)return!1;if(Array.isArray(s)){if(!Array.isArray(e)||s.length!==e.length)return!1;for(let n=0;n<s.length;n++)if(!dr(s[n],e[n],t-1))return!1;return!0}if(Array.isArray(e))return!1;if(typeof s=="object"&&typeof e=="object"){const n=Object.keys(s),r=Object.keys(e);if(n.length!==r.length)return!1;for(const i of n)if(!e.hasOwnProperty(i)||!dr(s[i],e[i],t-1))return!1;return!0}return!1}function Bm(s){return ArrayBuffer.isView(s)&&!(s instanceof DataView)}function Um(s){return Array.isArray(s)?s.length===0||typeof s[0]=="number":!1}function qc(s){return Bm(s)||Um(s)}function Lm(s){return qc(s)||typeof s=="number"||typeof s=="boolean"}function Kc(s){const e={bindings:{},uniforms:{}};return Object.keys(s).forEach(t=>{const n=s[t];Lm(n)?e.uniforms[t]=n:e.bindings[t]=n}),e}class Vm{options={disableWarnings:!1};modules;moduleUniforms;moduleBindings;constructor(e,t){Object.assign(this.options,t);const n=Or(Object.values(e).filter(r=>r.dependencies));for(const r of n)e[r.name]=r;C.log(1,"Creating ShaderInputs with modules",Object.keys(e))(),this.modules=e,this.moduleUniforms={},this.moduleBindings={};for(const[r,i]of Object.entries(e))this._addModule(i),i.name&&r!==i.name&&!this.options.disableWarnings&&C.warn(`Module name: ${r} vs ${i.name}`)()}destroy(){}setProps(e){for(const t of Object.keys(e)){const n=t,r=e[n]||{},i=this.modules[n];if(!i){this.options.disableWarnings||C.warn(`Module ${t} not found`)();continue}const o=this.moduleUniforms[n],a=this.moduleBindings[n],c=i.getUniforms?.(r,o)||r,{uniforms:l,bindings:u}=Kc(c);this.moduleUniforms[n]={...o,...l},this.moduleBindings[n]={...a,...u}}}getModules(){return Object.values(this.modules)}getUniformValues(){return this.moduleUniforms}getBindingValues(){const e={};for(const t of Object.values(this.moduleBindings))Object.assign(e,t);return e}getDebugTable(){const e={};for(const[t,n]of Object.entries(this.moduleUniforms))for(const[r,i]of Object.entries(n))e[`${t}.${r}`]={type:this.modules[t].uniformTypes?.[r],value:String(i)};return e}_addModule(e){const t=e.name;this.moduleUniforms[t]=e.defaultUniforms||{},this.moduleBindings[t]={}}}let $m="";async function Wm(s,e){const t=new Image;return t.crossOrigin="anonymous",t.src=s.startsWith("http")?s:$m+s,await t.decode(),e?await createImageBitmap(t,e):await createImageBitmap(t)}class Un{device;id;texture;sampler;view;ready;isReady=!1;destroyed=!1;resolveReady=()=>{};rejectReady=()=>{};get[Symbol.toStringTag](){return"AsyncTexture"}toString(){return`AsyncTexture:"${this.id}"(${this.isReady?"ready":"loading"})`}constructor(e,t){this.device=e,this.id=t.id||ln("async-texture"),typeof t?.data=="string"&&t.dimension==="2d"&&(t={...t,data:Wm(t.data)}),this.ready=new Promise((n,r)=>{this.resolveReady=()=>{this.isReady=!0,n()},this.rejectReady=r}),this.initAsync(t)}async initAsync(e){const t=e.data;let n;try{n=await Zc(t)}catch(i){this.rejectReady(i)}if(this.destroyed)return;const r={...e,data:n};this.texture=this.device.createTexture(r),this.sampler=this.texture.sampler,this.view=this.texture.view,this.isReady=!0,this.resolveReady()}destroy(){this.texture&&(this.texture.destroy(),this.texture=null),this.destroyed=!0}resize(e){if(!this.isReady)throw new Error("Cannot resize texture before it is ready");if(e.width===this.texture.width&&e.height===this.texture.height)return!1;if(this.texture){const t=this.texture;this.texture=t.clone(e),t.destroy()}return!0}}async function Zc(s){if(s=await s,Array.isArray(s))return await Promise.all(s.map(Zc));if(s&&typeof s=="object"&&s.constructor===Object){const e=s,t=await Promise.all(Object.values(e)),n=Object.keys(e),r={};for(let i=0;i<n.length;i++)r[n[i]]=t[i];return r}return s}const Je=2,jm=1e4;class Qs{static defaultProps={...Pt.defaultProps,source:void 0,vs:null,fs:null,id:"unnamed",handle:void 0,userData:{},defines:{},modules:[],moduleSettings:void 0,geometry:null,indexBuffer:null,attributes:{},constantAttributes:{},varyings:[],isInstanced:void 0,instanceCount:0,vertexCount:0,shaderInputs:void 0,pipelineFactory:void 0,shaderFactory:void 0,transformFeedback:void 0,shaderAssembler:tt.getDefaultShaderAssembler(),debugShaders:void 0,disableWarnings:void 0};device;id;source;vs;fs;pipelineFactory;shaderFactory;userData={};parameters;topology;bufferLayout;isInstanced=void 0;instanceCount=0;vertexCount;indexBuffer=null;bufferAttributes={};constantAttributes={};bindings={};uniforms={};vertexArray;transformFeedback=null;pipeline;shaderInputs;_uniformStore;_attributeInfos={};_gpuGeometry=null;_getModuleUniforms;props;_pipelineNeedsUpdate="newly created";_needsRedraw="initializing";_destroyed=!1;_lastDrawTimestamp=-1;get[Symbol.toStringTag](){return"Model"}toString(){return`Model(${this.id})`}constructor(e,t){this.props={...Qs.defaultProps,...t},t=this.props,this.id=t.id||ln("model"),this.device=e,Object.assign(this.userData,t.userData);const n=Object.fromEntries(this.props.modules?.map(c=>[c.name,c])||[]),r=t.shaderInputs||new Vm(n,{disableWarnings:this.props.disableWarnings});this.setShaderInputs(r);const i=zm(e),o=(this.props.modules?.length>0?this.props.modules:this.shaderInputs?.getModules())||[];if(this.device.type==="webgpu"&&this.props.source){const{source:c,getUniforms:l}=this.props.shaderAssembler.assembleWGSLShader({platformInfo:i,...this.props,modules:o});this.source=c,this._getModuleUniforms=l,this.props.shaderLayout||=rp(this.source)}else{const{vs:c,fs:l,getUniforms:u}=this.props.shaderAssembler.assembleGLSLShaderPair({platformInfo:i,...this.props,modules:o});this.vs=c,this.fs=l,this._getModuleUniforms=u}this.vertexCount=this.props.vertexCount,this.instanceCount=this.props.instanceCount,this.topology=this.props.topology,this.bufferLayout=this.props.bufferLayout,this.parameters=this.props.parameters,t.geometry&&this.setGeometry(t.geometry),this.pipelineFactory=t.pipelineFactory||ei.getDefaultPipelineFactory(this.device),this.shaderFactory=t.shaderFactory||ti.getDefaultShaderFactory(this.device),this.pipeline=this._updatePipeline(),this.vertexArray=e.createVertexArray({renderPipeline:this.pipeline}),this._gpuGeometry&&this._setGeometryAttributes(this._gpuGeometry),"isInstanced"in t&&(this.isInstanced=t.isInstanced),t.instanceCount&&this.setInstanceCount(t.instanceCount),t.vertexCount&&this.setVertexCount(t.vertexCount),t.indexBuffer&&this.setIndexBuffer(t.indexBuffer),t.attributes&&this.setAttributes(t.attributes),t.constantAttributes&&this.setConstantAttributes(t.constantAttributes),t.bindings&&this.setBindings(t.bindings),t.uniforms&&this.setUniformsWebGL(t.uniforms),t.moduleSettings&&this.updateModuleSettingsWebGL(t.moduleSettings),t.transformFeedback&&(this.transformFeedback=t.transformFeedback),Object.seal(this)}destroy(){this._destroyed||(this.pipelineFactory.release(this.pipeline),this.shaderFactory.release(this.pipeline.vs),this.pipeline.fs&&this.shaderFactory.release(this.pipeline.fs),this._uniformStore.destroy(),this._gpuGeometry?.destroy(),this._destroyed=!0)}needsRedraw(){this._getBindingsUpdateTimestamp()>this._lastDrawTimestamp&&this.setNeedsRedraw("contents of bound textures or buffers updated");const e=this._needsRedraw;return this._needsRedraw=!1,e}setNeedsRedraw(e){this._needsRedraw||=e}predraw(){this.updateShaderInputs(),this.pipeline=this._updatePipeline()}draw(e){const t=this._areBindingsLoading();if(t)return C.info(Je,`>>> DRAWING ABORTED ${this.id}: ${t} not loaded`)(),!1;try{e.pushDebugGroup(`${this}.predraw(${e})`),this.predraw()}finally{e.popDebugGroup()}let n;try{e.pushDebugGroup(`${this}.draw(${e})`),this._logDrawCallStart(),this.pipeline=this._updatePipeline();const r=this._getBindings();this.pipeline.setBindings(r,{disableWarnings:this.props.disableWarnings}),pr(this.uniforms)||this.pipeline.setUniformsWebGL(this.uniforms);const{indexBuffer:i}=this.vertexArray,o=i?i.byteLength/(i.indexType==="uint32"?4:2):void 0;n=this.pipeline.draw({renderPass:e,vertexArray:this.vertexArray,isInstanced:this.isInstanced,vertexCount:this.vertexCount,instanceCount:this.instanceCount,indexCount:o,transformFeedback:this.transformFeedback||void 0,parameters:this.parameters,topology:this.topology})}finally{e.popDebugGroup(),this._logDrawCallEnd()}return this._logFramebuffer(e),n?(this._lastDrawTimestamp=this.device.timestamp,this._needsRedraw=!1):this._needsRedraw="waiting for resource initialization",n}setGeometry(e){this._gpuGeometry?.destroy();const t=e&&Om(this.device,e);if(t){this.setTopology(t.topology||"triangle-list");const n=new xn(this.bufferLayout);this.bufferLayout=n.mergeBufferLayouts(t.bufferLayout,this.bufferLayout),this.vertexArray&&this._setGeometryAttributes(t)}this._gpuGeometry=t}setTopology(e){e!==this.topology&&(this.topology=e,this._setPipelineNeedsUpdate("topology"))}setBufferLayout(e){const t=new xn(this.bufferLayout);this.bufferLayout=this._gpuGeometry?t.mergeBufferLayouts(e,this._gpuGeometry.bufferLayout):e,this._setPipelineNeedsUpdate("bufferLayout"),this.pipeline=this._updatePipeline(),this.vertexArray=this.device.createVertexArray({renderPipeline:this.pipeline}),this._gpuGeometry&&this._setGeometryAttributes(this._gpuGeometry)}setParameters(e){dr(e,this.parameters,2)||(this.parameters=e,this._setPipelineNeedsUpdate("parameters"))}setInstanceCount(e){this.instanceCount=e,this.isInstanced===void 0&&e>0&&(this.isInstanced=!0),this.setNeedsRedraw("instanceCount")}setVertexCount(e){this.vertexCount=e,this.setNeedsRedraw("vertexCount")}setShaderInputs(e){this.shaderInputs=e,this._uniformStore=new Sd(this.shaderInputs.modules);for(const[t,n]of Object.entries(this.shaderInputs.modules))if(Hm(n)){const r=this._uniformStore.getManagedUniformBuffer(this.device,t);this.bindings[`${t}Uniforms`]=r}this.setNeedsRedraw("shaderInputs")}updateShaderInputs(){this._uniformStore.setUniforms(this.shaderInputs.getUniformValues()),this.setBindings(this.shaderInputs.getBindingValues()),this.setNeedsRedraw("shaderInputs")}setBindings(e){Object.assign(this.bindings,e),this.setNeedsRedraw("bindings")}setTransformFeedback(e){this.transformFeedback=e,this.setNeedsRedraw("transformFeedback")}setIndexBuffer(e){this.vertexArray.setIndexBuffer(e),this.setNeedsRedraw("indexBuffer")}setAttributes(e,t){const n=t?.disableWarnings??this.props.disableWarnings;e.indices&&C.warn(`Model:${this.id} setAttributes() - indexBuffer should be set using setIndexBuffer()`)(),this.bufferLayout=Id(this.pipeline.shaderLayout,this.bufferLayout);const r=new xn(this.bufferLayout);for(const[i,o]of Object.entries(e)){const a=r.getBufferLayout(i);if(!a){n||C.warn(`Model(${this.id}): Missing layout for buffer "${i}".`)();continue}const c=r.getAttributeNamesForBuffer(a);let l=!1;for(const u of c){const h=this._attributeInfos[u];if(h){const f=this.device.type==="webgpu"?r.getBufferIndex(h.bufferName):h.location;this.vertexArray.setBuffer(f,o),l=!0}}!l&&!n&&C.warn(`Model(${this.id}): Ignoring buffer "${o.id}" for unknown attribute "${i}"`)()}this.setNeedsRedraw("attributes")}setConstantAttributes(e,t){for(const[n,r]of Object.entries(e)){const i=this._attributeInfos[n];i?this.vertexArray.setConstantWebGL(i.location,r):(t?.disableWarnings??this.props.disableWarnings)||C.warn(`Model "${this.id}: Ignoring constant supplied for unknown attribute "${n}"`)()}this.setNeedsRedraw("constants")}setUniforms(e){this.setUniformsWebGL(e)}setUniformsWebGL(e){pr(e)||(this.pipeline.setUniformsWebGL(e),Object.assign(this.uniforms,e)),this.setNeedsRedraw("uniforms")}updateModuleSettingsWebGL(e){const{bindings:t,uniforms:n}=Kc(this._getModuleUniforms(e));Object.assign(this.bindings,t),Object.assign(this.uniforms,n),this.setNeedsRedraw("moduleSettings")}_areBindingsLoading(){for(const e of Object.values(this.bindings))if(e instanceof Un&&!e.isReady)return e.id;return!1}_getBindings(){const e={};for(const[t,n]of Object.entries(this.bindings))n instanceof Un?n.isReady&&(e[t]=n.texture):e[t]=n;return e}_getBindingsUpdateTimestamp(){let e=0;for(const t of Object.values(this.bindings))t instanceof rn?e=Math.max(e,t.texture.updateTimestamp):t instanceof q||t instanceof z?e=Math.max(e,t.updateTimestamp):t instanceof Un?e=t.texture?Math.max(e,t.texture.updateTimestamp):1/0:t instanceof ss||(e=Math.max(e,t.buffer.updateTimestamp));return e}_setGeometryAttributes(e){const t={...e.attributes};for(const[n]of Object.entries(t))!this.pipeline.shaderLayout.attributes.find(r=>r.name===n)&&n!=="positions"&&delete t[n];this.vertexCount=e.vertexCount,this.setIndexBuffer(e.indices||null),this.setAttributes(e.attributes,{disableWarnings:!0}),this.setAttributes(t,{disableWarnings:this.props.disableWarnings}),this.setNeedsRedraw("geometry attributes")}_setPipelineNeedsUpdate(e){this._pipelineNeedsUpdate||=e,this.setNeedsRedraw(e)}_updatePipeline(){if(this._pipelineNeedsUpdate){let e=null,t=null;this.pipeline&&(C.log(1,`Model ${this.id}: Recreating pipeline because "${this._pipelineNeedsUpdate}".`)(),e=this.pipeline.vs,t=this.pipeline.fs),this._pipelineNeedsUpdate=!1;const n=this.shaderFactory.createShader({id:`${this.id}-vertex`,stage:"vertex",source:this.source||this.vs,debugShaders:this.props.debugShaders});let r=null;this.source?r=n:this.fs&&(r=this.shaderFactory.createShader({id:`${this.id}-fragment`,stage:"fragment",source:this.source||this.fs,debugShaders:this.props.debugShaders})),this.pipeline=this.pipelineFactory.createRenderPipeline({...this.props,bufferLayout:this.bufferLayout,topology:this.topology,parameters:this.parameters,bindings:this._getBindings(),vs:n,fs:r}),this._attributeInfos=qa(this.pipeline.shaderLayout,this.bufferLayout),e&&this.shaderFactory.release(e),t&&this.shaderFactory.release(t)}return this.pipeline}_lastLogTime=0;_logOpen=!1;_logDrawCallStart(){const e=C.level>3?0:jm;C.level<2||Date.now()-this._lastLogTime<e||(this._lastLogTime=Date.now(),this._logOpen=!0,C.group(Je,`>>> DRAWING MODEL ${this.id}`,{collapsed:C.level<=2})())}_logDrawCallEnd(){if(this._logOpen){const e=Dm(this.pipeline.shaderLayout,this.id);C.table(Je,e)();const t=this.shaderInputs.getDebugTable();for(const[r,i]of Object.entries(this.uniforms))t[r]={value:i};C.table(Je,t)();const n=this._getAttributeDebugTable();C.table(Je,this._attributeInfos)(),C.table(Je,n)(),C.groupEnd(Je)(),this._logOpen=!1}}_drawCount=0;_logFramebuffer(e){const t=this.device.props.debugFramebuffers;if(this._drawCount++,!t)return;const n=e.props.framebuffer;n&&Fm(n,{id:n.id,minimap:!0})}_getAttributeDebugTable(){const e={};for(const[t,n]of Object.entries(this._attributeInfos)){const r=this.vertexArray.attributes[n.location];e[n.location]={name:t,type:n.shaderType,values:r?this._getBufferOrConstantValues(r,n.bufferDataType):"null"}}if(this.vertexArray.indexBuffer){const{indexBuffer:t}=this.vertexArray,n=t.indexType==="uint32"?new Uint32Array(t.debugData):new Uint16Array(t.debugData);e.indices={name:"indices",type:t.indexType,values:n.toString()}}return e}_getBufferOrConstantValues(e,t){const n=Qa(t);return(e instanceof q?new n(e.debugData):e).toString()}}function Hm(s){return!!(s.uniformTypes&&!pr(s.uniformTypes))}function zm(s){return{type:s.type,shaderLanguage:s.info.shadingLanguage,shaderLanguageVersion:s.info.shadingLanguageVersion,gpu:s.info.gpu,features:s.features}}function pr(s){for(const e in s)return!1;return!0}class Bt{device;model;transformFeedback;static defaultProps={...Qs.defaultProps,outputs:void 0,feedbackBuffers:void 0};static isSupported(e){return e?.info?.type==="webgl"}constructor(e,t=Bt.defaultProps){if(!Bt.isSupported(e))throw new Error("BufferTransform not yet implemented on WebGPU");this.device=e,this.model=new Qs(this.device,{id:t.id||"buffer-transform-model",fs:t.fs||Cf(),topology:t.topology||"point-list",varyings:t.outputs||t.varyings,...t}),this.transformFeedback=this.device.createTransformFeedback({layout:this.model.pipeline.shaderLayout,buffers:t.feedbackBuffers}),this.model.setTransformFeedback(this.transformFeedback),Object.seal(this)}destroy(){this.model&&this.model.destroy()}delete(){this.destroy()}run(e){e?.inputBuffers&&this.model.setAttributes(e.inputBuffers),e?.outputBuffers&&this.transformFeedback.setBuffers(e.outputBuffers);const t=this.device.beginRenderPass(e);this.model.draw(t),t.end()}getBuffer(e){return this.transformFeedback.getBuffer(e)}readAsync(e){const t=this.getBuffer(e);if(!t)throw new Error("BufferTransform#getBuffer");if(t instanceof q)return t.readAsync();const{buffer:n,byteOffset:r=0,byteLength:i=n.byteLength}=t;return n.readAsync(r,i)}}class fw{id;topology;vertexCount;indices;attributes;userData={};constructor(e){const{attributes:t={},indices:n=null,vertexCount:r=null}=e;this.id=e.id||ln("geometry"),this.topology=e.topology,n&&(this.indices=ArrayBuffer.isView(n)?{value:n,size:1}:n),this.attributes={};for(const[i,o]of Object.entries(t)){const a=ArrayBuffer.isView(o)?{value:o}:o;if(!ArrayBuffer.isView(a.value))throw new Error(`${this._print(i)}: must be typed array or object with value as typed array`);if((i==="POSITION"||i==="positions")&&!a.size&&(a.size=3),i==="indices"){if(this.indices)throw new Error("Multiple indices detected");this.indices=a}else this.attributes[i]=a}this.indices&&this.indices.isIndexed!==void 0&&(this.indices=Object.assign({},this.indices),delete this.indices.isIndexed),this.vertexCount=r||this._calculateVertexCount(this.attributes,this.indices)}getVertexCount(){return this.vertexCount}getAttributes(){return this.indices?{indices:this.indices,...this.attributes}:this.attributes}_print(e){return`Geometry ${this.id} attribute ${e}`}_setAttributes(e,t){return this}_calculateVertexCount(e,t){if(t)return t.value.length;let n=1/0;for(const r of Object.values(e)){const{value:i,size:o,constant:a}=r;!a&&i&&o!==void 0&&o>=1&&(n=Math.min(n,i.length/o))}return n}}const Xm={blendColorOperation:"add",blendColorSrcFactor:"one",blendColorDstFactor:"zero",blendAlphaOperation:"add",blendAlphaSrcFactor:"constant-alpha",blendAlphaDstFactor:"zero"};class Qc extends Gr{constructor(){super(...arguments),this._colorEncoderState=null}render(e){return"pickingFBO"in e?this._drawPickingBuffer(e):super.render(e)}_drawPickingBuffer({layers:e,layerFilter:t,views:n,viewports:r,onViewportActive:i,pickingFBO:o,deviceRect:{x:a,y:c,width:l,height:u},cullRect:h,effects:f,pass:g="picking",pickZ:_,shaderModuleProps:w}){this.pickZ=_;const A=this._resetColorEncoder(_),S=[a,c,l,u],I=super.render({target:o,layers:e,layerFilter:t,views:n,viewports:r,onViewportActive:i,cullRect:h,effects:f?.filter(E=>E.useInPicking),pass:g,isPicking:!0,shaderModuleProps:w,clearColor:[0,0,0,0],colorMask:15,scissorRect:S});return this._colorEncoderState=null,{decodePickingColor:A&&qm.bind(null,A),stats:I}}shouldDrawLayer(e){const{pickable:t,operation:n}=e.props;return t&&n.includes("draw")||n.includes("terrain")||n.includes("mask")}getShaderModuleProps(e,t,n){return{picking:{isActive:1,isAttribute:this.pickZ},lighting:{enabled:!1}}}getLayerParameters(e,t,n){const r={...e.props.parameters},{pickable:i,operation:o}=e.props;return!this._colorEncoderState||o.includes("terrain")?r.blend=!1:i&&o.includes("draw")&&(Object.assign(r,Xm),r.blend=!0,r.blendColor=Ym(this._colorEncoderState,e,n)),r}_resetColorEncoder(e){return this._colorEncoderState=e?null:{byLayer:new Map,byAlpha:[]},this._colorEncoderState}}function Ym(s,e,t){const{byLayer:n,byAlpha:r}=s;let i,o=n.get(e);return o?(o.viewports.push(t),i=o.a):(i=n.size+1,i<=255?(o={a:i,layer:e,viewports:[t]},n.set(e,o),r[i]=o):(Y.warn("Too many pickable layers, only picking the first 255")(),i=0)),[0,0,0,i/255]}function qm(s,e){const t=s.byAlpha[e[3]];return t&&{pickedLayer:t.layer,pickedViewports:t.viewports,pickedObjectIndex:t.layer.decodePickingColor(e)}}const Tt={NO_STATE:"Awaiting state",MATCHED:"Matched. State transferred from previous layer",INITIALIZED:"Initialized",AWAITING_GC:"Discarded. Awaiting garbage collection",AWAITING_FINALIZATION:"No longer matched. Awaiting garbage collection",FINALIZED:"Finalized! Awaiting garbage collection"},Js=Symbol.for("component"),it=Symbol.for("propTypes"),Ln=Symbol.for("deprecatedProps"),Ct=Symbol.for("asyncPropDefaults"),ut=Symbol.for("asyncPropOriginal"),qe=Symbol.for("asyncPropResolved");function Jc(s,e=()=>!0){return Array.isArray(s)?Gc(s,e,[]):e(s)?[s]:[]}function Gc(s,e,t){let n=-1;for(;++n<s.length;){const r=s[n];Array.isArray(r)?Gc(r,e,t):e(r)&&t.push(r)}return t}function Km({target:s,source:e,start:t=0,count:n=1}){const r=e.length,i=n*r;let o=0;for(let a=t;o<r;o++)s[a++]=e[o];for(;o<i;)o<i-o?(s.copyWithin(t+o,t,t+o),o*=2):(s.copyWithin(t+o,t,t+i-o),o=i);return s}class Zm{constructor(e,t,n){this._loadCount=0,this._subscribers=new Set,this.id=e,this.context=n,this.setData(t)}subscribe(e){this._subscribers.add(e)}unsubscribe(e){this._subscribers.delete(e)}inUse(){return this._subscribers.size>0}delete(){}getData(){return this.isLoaded?this._error?Promise.reject(this._error):this._content:this._loader.then(()=>this.getData())}setData(e,t){if(e===this._data&&!t)return;this._data=e;const n=++this._loadCount;let r=e;typeof e=="string"&&(r=Yn(e)),r instanceof Promise?(this.isLoaded=!1,this._loader=r.then(i=>{this._loadCount===n&&(this.isLoaded=!0,this._error=void 0,this._content=i)}).catch(i=>{this._loadCount===n&&(this.isLoaded=!0,this._error=i||!0)})):(this.isLoaded=!0,this._error=void 0,this._content=e);for(const i of this._subscribers)i.onChange(this.getData())}}class Qm{constructor(e){this.protocol=e.protocol||"resource://",this._context={device:e.device,gl:e.device?.gl,resourceManager:this},this._resources={},this._consumers={},this._pruneRequest=null}contains(e){return e.startsWith(this.protocol)?!0:e in this._resources}add({resourceId:e,data:t,forceUpdate:n=!1,persistent:r=!0}){let i=this._resources[e];i?i.setData(t,n):(i=new Zm(e,t,this._context),this._resources[e]=i),i.persistent=r}remove(e){const t=this._resources[e];t&&(t.delete(),delete this._resources[e])}unsubscribe({consumerId:e}){const t=this._consumers[e];if(t){for(const n in t){const r=t[n],i=this._resources[r.resourceId];i&&i.unsubscribe(r)}delete this._consumers[e],this.prune()}}subscribe({resourceId:e,onChange:t,consumerId:n,requestId:r="default"}){const{_resources:i,protocol:o}=this;e.startsWith(o)&&(e=e.replace(o,""),i[e]||this.add({resourceId:e,data:null,persistent:!1}));const a=i[e];if(this._track(n,r,a,t),a)return a.getData()}prune(){this._pruneRequest||(this._pruneRequest=setTimeout(()=>this._prune(),0))}finalize(){for(const e in this._resources)this._resources[e].delete()}_track(e,t,n,r){const i=this._consumers,o=i[e]=i[e]||{};let a=o[t];const c=a&&a.resourceId&&this._resources[a.resourceId];c&&(c.unsubscribe(a),this.prune()),n&&(a?(a.onChange=r,a.resourceId=n.id):a={onChange:r,resourceId:n.id},o[t]=a,n.subscribe(a))}_prune(){this._pruneRequest=null;for(const e of Object.keys(this._resources)){const t=this._resources[e];!t.persistent&&!t.inUse()&&(t.delete(),delete this._resources[e])}}}const Jm="layerManager.setLayers",Gm="layerManager.activateViewport";class eb{constructor(e,t){this._lastRenderedLayers=[],this._needsRedraw=!1,this._needsUpdate=!1,this._nextLayers=null,this._debug=!1,this._defaultShaderModulesChanged=!1,this.activateViewport=a=>{fe(Gm,this,a),a&&(this.context.viewport=a)};const{deck:n,stats:r,viewport:i,timeline:o}=t||{};this.layers=[],this.resourceManager=new Qm({device:e,protocol:"deck://"}),this.context={mousePosition:null,userData:{},layerManager:this,device:e,gl:e?.gl,deck:n,shaderAssembler:em(e?.info?.shadingLanguage||"glsl"),defaultShaderModules:[hg],renderPass:void 0,stats:r||new tn({id:"deck.gl"}),viewport:i||new hs({id:"DEFAULT-INITIAL-VIEWPORT"}),timeline:o||new Yc,resourceManager:this.resourceManager,onError:void 0},Object.seal(this)}finalize(){this.resourceManager.finalize();for(const e of this.layers)this._finalizeLayer(e)}needsRedraw(e={clearRedrawFlags:!1}){let t=this._needsRedraw;e.clearRedrawFlags&&(this._needsRedraw=!1);for(const n of this.layers){const r=n.getNeedsRedraw(e);t=t||r}return t}needsUpdate(){return this._nextLayers&&this._nextLayers!==this._lastRenderedLayers?"layers changed":this._defaultShaderModulesChanged?"shader modules changed":this._needsUpdate}setNeedsRedraw(e){this._needsRedraw=this._needsRedraw||e}setNeedsUpdate(e){this._needsUpdate=this._needsUpdate||e}getLayers({layerIds:e}={}){return e?this.layers.filter(t=>e.find(n=>t.id.indexOf(n)===0)):this.layers}setProps(e){"debug"in e&&(this._debug=e.debug),"userData"in e&&(this.context.userData=e.userData),"layers"in e&&(this._nextLayers=e.layers),"onError"in e&&(this.context.onError=e.onError)}setLayers(e,t){fe(Jm,this,t,e),this._lastRenderedLayers=e;const n=Jc(e,Boolean);for(const r of n)r.context=this.context;this._updateLayers(this.layers,n)}updateLayers(){const e=this.needsUpdate();e&&(this.setNeedsRedraw(`updating layers: ${e}`),this.setLayers(this._nextLayers||this._lastRenderedLayers,e)),this._nextLayers=null}addDefaultShaderModule(e){const{defaultShaderModules:t}=this.context;t.find(n=>n.name===e.name)||(t.push(e),this._defaultShaderModulesChanged=!0)}removeDefaultShaderModule(e){const{defaultShaderModules:t}=this.context,n=t.findIndex(r=>r.name===e.name);n>=0&&(t.splice(n,1),this._defaultShaderModulesChanged=!0)}_handleError(e,t,n){n.raiseError(t,`${e} of ${n}`)}_updateLayers(e,t){const n={};for(const o of e)n[o.id]?Y.warn(`Multiple old layers with same id ${o.id}`)():n[o.id]=o;if(this._defaultShaderModulesChanged){for(const o of e)o.setNeedsUpdate(),o.setChangeFlags({extensionsChanged:!0});this._defaultShaderModulesChanged=!1}const r=[];this._updateSublayersRecursively(t,n,r),this._finalizeOldLayers(n);let i=!1;for(const o of r)if(o.hasUniformTransition()){i=`Uniform transition in ${o}`;break}this._needsUpdate=i,this.layers=r}_updateSublayersRecursively(e,t,n){for(const r of e){r.context=this.context;const i=t[r.id];i===null&&Y.warn(`Multiple new layers with same id ${r.id}`)(),t[r.id]=null;let o=null;try{this._debug&&i!==r&&r.validateProps(),i?(this._transferLayerState(i,r),this._updateLayer(r)):this._initializeLayer(r),n.push(r),o=r.isComposite?r.getSubLayers():null}catch(a){this._handleError("matching",a,r)}o&&this._updateSublayersRecursively(o,t,n)}}_finalizeOldLayers(e){for(const t in e){const n=e[t];n&&this._finalizeLayer(n)}}_initializeLayer(e){try{e._initialize(),e.lifecycle=Tt.INITIALIZED}catch(t){this._handleError("initialization",t,e)}}_transferLayerState(e,t){t._transferState(e),t.lifecycle=Tt.MATCHED,t!==e&&(e.lifecycle=Tt.AWAITING_GC)}_updateLayer(e){try{e._update()}catch(t){this._handleError("update",t,e)}}_finalizeLayer(e){this._needsRedraw=this._needsRedraw||`finalized ${e}`,e.lifecycle=Tt.AWAITING_FINALIZATION;try{e._finalize(),e.lifecycle=Tt.FINALIZED}catch(t){this._handleError("finalization",t,e)}}}function Re(s,e,t){if(s===e)return!0;if(!t||!s||!e)return!1;if(Array.isArray(s)){if(!Array.isArray(e)||s.length!==e.length)return!1;for(let n=0;n<s.length;n++)if(!Re(s[n],e[n],t-1))return!1;return!0}if(Array.isArray(e))return!1;if(typeof s=="object"&&typeof e=="object"){const n=Object.keys(s),r=Object.keys(e);if(n.length!==r.length)return!1;for(const i of n)if(!e.hasOwnProperty(i)||!Re(s[i],e[i],t-1))return!1;return!0}return!1}class tb{constructor(e){this.views=[],this.width=100,this.height=100,this.viewState={},this.controllers={},this.timeline=e.timeline,this._viewports=[],this._viewportMap={},this._isUpdating=!1,this._needsRedraw="First render",this._needsUpdate="Initialize",this._eventManager=e.eventManager,this._eventCallbacks={onViewStateChange:e.onViewStateChange,onInteractionStateChange:e.onInteractionStateChange},Object.seal(this),this.setProps(e)}finalize(){for(const e in this.controllers){const t=this.controllers[e];t&&t.finalize()}this.controllers={}}needsRedraw(e={clearRedrawFlags:!1}){const t=this._needsRedraw;return e.clearRedrawFlags&&(this._needsRedraw=!1),t}setNeedsUpdate(e){this._needsUpdate=this._needsUpdate||e,this._needsRedraw=this._needsRedraw||e}updateViewStates(){for(const e in this.controllers){const t=this.controllers[e];t&&t.updateTransition()}}getViewports(e){return e?this._viewports.filter(t=>t.containsPixel(e)):this._viewports}getViews(){const e={};return this.views.forEach(t=>{e[t.id]=t}),e}getView(e){return this.views.find(t=>t.id===e)}getViewState(e){const t=typeof e=="string"?this.getView(e):e,n=t&&this.viewState[t.getViewStateId()]||this.viewState;return t?t.filterViewState(n):n}getViewport(e){return this._viewportMap[e]}unproject(e,t){const n=this.getViewports(),r={x:e[0],y:e[1]};for(let i=n.length-1;i>=0;--i){const o=n[i];if(o.containsPixel(r)){const a=e.slice();return a[0]-=o.x,a[1]-=o.y,o.unproject(a,t)}}return null}setProps(e){e.views&&this._setViews(e.views),e.viewState&&this._setViewState(e.viewState),("width"in e||"height"in e)&&this._setSize(e.width,e.height),this._isUpdating||this._update()}_update(){this._isUpdating=!0,this._needsUpdate&&(this._needsUpdate=!1,this._rebuildViewports()),this._needsUpdate&&(this._needsUpdate=!1,this._rebuildViewports()),this._isUpdating=!1}_setSize(e,t){(e!==this.width||t!==this.height)&&(this.width=e,this.height=t,this.setNeedsUpdate("Size changed"))}_setViews(e){e=Jc(e,Boolean),this._diffViews(e,this.views)&&this.setNeedsUpdate("views changed"),this.views=e}_setViewState(e){e?(!Re(e,this.viewState,3)&&this.setNeedsUpdate("viewState changed"),this.viewState=e):Y.warn("missing `viewState` or `initialViewState`")()}_createController(e,t){const n=t.type;return new n({timeline:this.timeline,eventManager:this._eventManager,onViewStateChange:this._eventCallbacks.onViewStateChange,onStateChange:this._eventCallbacks.onInteractionStateChange,makeViewport:i=>this.getView(e.id)?.makeViewport({viewState:i,width:this.width,height:this.height})})}_updateController(e,t,n,r){const i=e.controller;if(i&&n){const o={...t,...i,id:e.id,x:n.x,y:n.y,width:n.width,height:n.height};return(!r||r.constructor!==i.type)&&(r=this._createController(e,o)),r&&r.setProps(o),r}return null}_rebuildViewports(){const{views:e}=this,t=this.controllers;this._viewports=[],this.controllers={};let n=!1;for(let r=e.length;r--;){const i=e[r],o=this.getViewState(i),a=i.makeViewport({viewState:o,width:this.width,height:this.height});let c=t[i.id];const l=!!i.controller;l&&!c&&(n=!0),(n||!l)&&c&&(c.finalize(),c=null),this.controllers[i.id]=this._updateController(i,o,a,c),a&&this._viewports.unshift(a)}for(const r in t){const i=t[r];i&&!this.controllers[r]&&i.finalize()}this._buildViewportMap()}_buildViewportMap(){this._viewportMap={},this._viewports.forEach(e=>{e.id&&(this._viewportMap[e.id]=this._viewportMap[e.id]||e)})}_diffViews(e,t){return e.length!==t.length?!0:e.some((n,r)=>!e[r].equals(t[r]))}}const sb=/([0-9]+\.?[0-9]*)(%|px)/;function Ve(s){switch(typeof s){case"number":return{position:s,relative:!1};case"string":const e=sb.exec(s);if(e&&e.length>=3){const t=e[2]==="%",n=parseFloat(e[1]);return{position:t?n/100:n,relative:t}}default:throw new Error(`Could not parse position string ${s}`)}}function $e(s,e){return s.relative?Math.round(s.position*e):s.position}class nb{constructor(e){const{id:t,x:n=0,y:r=0,width:i="100%",height:o="100%",padding:a=null}=e;this.id=t||this.constructor.displayName||"view",this.props={...e,id:this.id},this._x=Ve(n),this._y=Ve(r),this._width=Ve(i),this._height=Ve(o),this._padding=a&&{left:Ve(a.left||0),right:Ve(a.right||0),top:Ve(a.top||0),bottom:Ve(a.bottom||0)},this.equals=this.equals.bind(this),Object.seal(this)}equals(e){return this===e?!0:this.constructor===e.constructor&&Re(this.props,e.props,2)}makeViewport({width:e,height:t,viewState:n}){n=this.filterViewState(n);const r=this.getDimensions({width:e,height:t});if(!r.height||!r.width)return null;const i=this.getViewportType(n);return new i({...n,...this.props,...r})}getViewStateId(){const{viewState:e}=this.props;return typeof e=="string"?e:e?.id||this.id}filterViewState(e){if(this.props.viewState&&typeof this.props.viewState=="object"){if(!this.props.viewState.id)return this.props.viewState;const t={...e};for(const n in this.props.viewState)n!=="id"&&(t[n]=this.props.viewState[n]);return t}return e}getDimensions({width:e,height:t}){const n={x:$e(this._x,e),y:$e(this._y,t),width:$e(this._width,e),height:$e(this._height,t)};return this._padding&&(n.padding={left:$e(this._padding.left,e),top:$e(this._padding.top,t),right:$e(this._padding.right,e),bottom:$e(this._padding.bottom,t)}),n}get controller(){const e=this.props.controller;return e?e===!0?{type:this.ControllerType}:typeof e=="function"?{type:e}:{type:this.ControllerType,...e}:null}}class un{constructor(e){this._inProgress=!1,this._handle=null,this.time=0,this.settings={duration:0},this._timeline=e}get inProgress(){return this._inProgress}start(e){this.cancel(),this.settings=e,this._inProgress=!0,this.settings.onStart?.(this)}end(){this._inProgress&&(this._timeline.removeChannel(this._handle),this._handle=null,this._inProgress=!1,this.settings.onEnd?.(this))}cancel(){this._inProgress&&(this.settings.onInterrupt?.(this),this._timeline.removeChannel(this._handle),this._handle=null,this._inProgress=!1)}update(){if(!this._inProgress)return!1;if(this._handle===null){const{_timeline:e,settings:t}=this;this._handle=e.addChannel({delay:e.getTime(),duration:t.duration})}return this.time=this._timeline.getTime(this._handle),this._onUpdate(),this.settings.onUpdate?.(this),this._timeline.isFinished(this._handle)&&this.end(),!0}_onUpdate(){}}const No=()=>{},gr={BREAK:1,SNAP_TO_END:2,IGNORE:3},rb=s=>s,ib=gr.BREAK;class ob{constructor(e){this._onTransitionUpdate=t=>{const{time:n,settings:{interpolator:r,startProps:i,endProps:o,duration:a,easing:c}}=t,l=c(n/a),u=r.interpolateProps(i,o,l);this.propsInTransition=this.getControllerState({...this.props,...u}).getViewportProps(),this.onViewStateChange({viewState:this.propsInTransition,oldViewState:this.props})},this.getControllerState=e.getControllerState,this.propsInTransition=null,this.transition=new un(e.timeline),this.onViewStateChange=e.onViewStateChange||No,this.onStateChange=e.onStateChange||No}finalize(){this.transition.cancel()}getViewportInTransition(){return this.propsInTransition}processViewStateChange(e){let t=!1;const n=this.props;if(this.props=e,!n||this._shouldIgnoreViewportChange(n,e))return!1;if(this._isTransitionEnabled(e)){let r=n;if(this.transition.inProgress){const{interruption:i,endProps:o}=this.transition.settings;r={...n,...i===gr.SNAP_TO_END?o:this.propsInTransition||n}}this._triggerTransition(r,e),t=!0}else this.transition.cancel();return t}updateTransition(){this.transition.update()}_isTransitionEnabled(e){const{transitionDuration:t,transitionInterpolator:n}=e;return(t>0||t==="auto")&&!!n}_isUpdateDueToCurrentTransition(e){return this.transition.inProgress&&this.propsInTransition?this.transition.settings.interpolator.arePropsEqual(e,this.propsInTransition):!1}_shouldIgnoreViewportChange(e,t){return this.transition.inProgress?this.transition.settings.interruption===gr.IGNORE||this._isUpdateDueToCurrentTransition(t):this._isTransitionEnabled(t)?t.transitionInterpolator.arePropsEqual(e,t):!0}_triggerTransition(e,t){const n=this.getControllerState(e),r=this.getControllerState(t).shortestPathFrom(n),i=t.transitionInterpolator,o=i.getDuration?i.getDuration(e,t):t.transitionDuration;if(o===0)return;const a=i.initializeProps(e,r);this.propsInTransition={};const c={duration:o,easing:t.transitionEasing||rb,interpolator:i,interruption:t.transitionInterruption||ib,startProps:a.start,endProps:a.end,onStart:t.onTransitionStart,onUpdate:this._onTransitionUpdate,onInterrupt:this._onTransitionEnd(t.onTransitionInterrupt),onEnd:this._onTransitionEnd(t.onTransitionEnd)};this.transition.start(c),this.onStateChange({inTransition:!0}),this.updateTransition()}_onTransitionEnd(e){return t=>{this.propsInTransition=null,this.onStateChange({inTransition:!1,isZooming:!1,isPanning:!1,isRotating:!1}),e?.(t)}}}function ue(s,e){if(!s)throw new Error(e||"deck.gl: assertion failed.")}class ab{constructor(e){const{compare:t,extract:n,required:r}=e;this._propsToCompare=t,this._propsToExtract=n||t,this._requiredProps=r}arePropsEqual(e,t){for(const n of this._propsToCompare)if(!(n in e)||!(n in t)||!rs(e[n],t[n]))return!1;return!0}initializeProps(e,t){const n={},r={};for(const i of this._propsToExtract)(i in e||i in t)&&(n[i]=e[i],r[i]=t[i]);return this._checkRequiredProps(n),this._checkRequiredProps(r),{start:n,end:r}}getDuration(e,t){return t.transitionDuration}_checkRequiredProps(e){this._requiredProps&&this._requiredProps.forEach(t=>{const n=e[t];ue(Number.isFinite(n)||Array.isArray(n),`${t} is required for transition`)})}}const cb=["longitude","latitude","zoom","bearing","pitch"],lb=["longitude","latitude","zoom"];class el extends ab{constructor(e={}){const t=Array.isArray(e)?e:e.transitionProps,n=Array.isArray(e)?{}:e;n.transitionProps=Array.isArray(t)?{compare:t,required:t}:t||{compare:cb,required:lb},super(n.transitionProps),this.opts=n}initializeProps(e,t){const n=super.initializeProps(e,t),{makeViewport:r,around:i}=this.opts;if(r&&i){const o=r(e),a=r(t),c=o.unproject(i);n.start.around=i,Object.assign(n.end,{around:a.project(c),aroundPosition:c,width:t.width,height:t.height})}return n}interpolateProps(e,t,n){const r={};for(const i of this._propsToExtract)r[i]=Hs(e[i]||0,t[i]||0,n);if(t.aroundPosition&&this.opts.makeViewport){const i=this.opts.makeViewport({...t,...r});Object.assign(r,i.panByPosition(t.aroundPosition,Hs(e.around,t.around,n)))}return r}}const We={transitionDuration:0},ub=300,vs=s=>1-(1-s)*(1-s),yt={WHEEL:["wheel"],PAN:["panstart","panmove","panend"],PINCH:["pinchstart","pinchmove","pinchend"],MULTI_PAN:["multipanstart","multipanmove","multipanend"],DOUBLE_CLICK:["dblclick"],KEYBOARD:["keydown"]},Ge={};class hb{constructor(e){this.state={},this._events={},this._interactionState={isDragging:!1},this._customEvents=[],this._eventStartBlocked=null,this._panMove=!1,this.invertPan=!1,this.dragMode="rotate",this.inertia=0,this.scrollZoom=!0,this.dragPan=!0,this.dragRotate=!0,this.doubleClickZoom=!0,this.touchZoom=!0,this.touchRotate=!1,this.keyboard=!0,this.transitionManager=new ob({...e,getControllerState:t=>new this.ControllerState(t),onViewStateChange:this._onTransition.bind(this),onStateChange:this._setInteractionState.bind(this)}),this.handleEvent=this.handleEvent.bind(this),this.eventManager=e.eventManager,this.onViewStateChange=e.onViewStateChange||(()=>{}),this.onStateChange=e.onStateChange||(()=>{}),this.makeViewport=e.makeViewport}set events(e){this.toggleEvents(this._customEvents,!1),this.toggleEvents(e,!0),this._customEvents=e,this.props&&this.setProps(this.props)}finalize(){for(const e in this._events)this._events[e]&&this.eventManager?.off(e,this.handleEvent);this.transitionManager.finalize()}handleEvent(e){this._controllerState=void 0;const t=this._eventStartBlocked;switch(e.type){case"panstart":return t?!1:this._onPanStart(e);case"panmove":return this._onPan(e);case"panend":return this._onPanEnd(e);case"pinchstart":return t?!1:this._onPinchStart(e);case"pinchmove":return this._onPinch(e);case"pinchend":return this._onPinchEnd(e);case"multipanstart":return t?!1:this._onMultiPanStart(e);case"multipanmove":return this._onMultiPan(e);case"multipanend":return this._onMultiPanEnd(e);case"dblclick":return this._onDoubleClick(e);case"wheel":return this._onWheel(e);case"keydown":return this._onKeyDown(e);default:return!1}}get controllerState(){return this._controllerState=this._controllerState||new this.ControllerState({makeViewport:this.makeViewport,...this.props,...this.state}),this._controllerState}getCenter(e){const{x:t,y:n}=this.props,{offsetCenter:r}=e;return[r.x-t,r.y-n]}isPointInBounds(e,t){const{width:n,height:r}=this.props;if(t&&t.handled)return!1;const i=e[0]>=0&&e[0]<=n&&e[1]>=0&&e[1]<=r;return i&&t&&t.stopPropagation(),i}isFunctionKeyPressed(e){const{srcEvent:t}=e;return!!(t.metaKey||t.altKey||t.ctrlKey||t.shiftKey)}isDragging(){return this._interactionState.isDragging||!1}blockEvents(e){const t=setTimeout(()=>{this._eventStartBlocked===t&&(this._eventStartBlocked=null)},e);this._eventStartBlocked=t}setProps(e){e.dragMode&&(this.dragMode=e.dragMode),this.props=e,"transitionInterpolator"in e||(e.transitionInterpolator=this._getTransitionProps().transitionInterpolator),this.transitionManager.processViewStateChange(e);const{inertia:t}=e;this.inertia=Number.isFinite(t)?t:t===!0?ub:0;const{scrollZoom:n=!0,dragPan:r=!0,dragRotate:i=!0,doubleClickZoom:o=!0,touchZoom:a=!0,touchRotate:c=!1,keyboard:l=!0}=e,u=!!this.onViewStateChange;this.toggleEvents(yt.WHEEL,u&&n),this.toggleEvents(yt.PAN,u),this.toggleEvents(yt.PINCH,u&&(a||c)),this.toggleEvents(yt.MULTI_PAN,u&&c),this.toggleEvents(yt.DOUBLE_CLICK,u&&o),this.toggleEvents(yt.KEYBOARD,u&&l),this.scrollZoom=n,this.dragPan=r,this.dragRotate=i,this.doubleClickZoom=o,this.touchZoom=a,this.touchRotate=c,this.keyboard=l}updateTransition(){this.transitionManager.updateTransition()}toggleEvents(e,t){this.eventManager&&e.forEach(n=>{this._events[n]!==t&&(this._events[n]=t,t?this.eventManager.on(n,this.handleEvent):this.eventManager.off(n,this.handleEvent))})}updateViewport(e,t=null,n={}){const r={...e.getViewportProps(),...t},i=this.controllerState!==e;if(this.state=e.getState(),this._setInteractionState(n),i){const o=this.controllerState&&this.controllerState.getViewportProps();this.onViewStateChange&&this.onViewStateChange({viewState:r,interactionState:this._interactionState,oldViewState:o,viewId:this.props.id})}}_onTransition(e){this.onViewStateChange({...e,interactionState:this._interactionState,viewId:this.props.id})}_setInteractionState(e){Object.assign(this._interactionState,e),this.onStateChange(this._interactionState)}_onPanStart(e){const t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;let n=this.isFunctionKeyPressed(e)||e.rightButton||!1;(this.invertPan||this.dragMode==="pan")&&(n=!n);const r=this.controllerState[n?"panStart":"rotateStart"]({pos:t});return this._panMove=n,this.updateViewport(r,We,{isDragging:!0}),!0}_onPan(e){return this.isDragging()?this._panMove?this._onPanMove(e):this._onPanRotate(e):!1}_onPanEnd(e){return this.isDragging()?this._panMove?this._onPanMoveEnd(e):this._onPanRotateEnd(e):!1}_onPanMove(e){if(!this.dragPan)return!1;const t=this.getCenter(e),n=this.controllerState.pan({pos:t});return this.updateViewport(n,We,{isDragging:!0,isPanning:!0}),!0}_onPanMoveEnd(e){const{inertia:t}=this;if(this.dragPan&&t&&e.velocity){const n=this.getCenter(e),r=[n[0]+e.velocityX*t/2,n[1]+e.velocityY*t/2],i=this.controllerState.pan({pos:r}).panEnd();this.updateViewport(i,{...this._getTransitionProps(),transitionDuration:t,transitionEasing:vs},{isDragging:!1,isPanning:!0})}else{const n=this.controllerState.panEnd();this.updateViewport(n,null,{isDragging:!1,isPanning:!1})}return!0}_onPanRotate(e){if(!this.dragRotate)return!1;const t=this.getCenter(e),n=this.controllerState.rotate({pos:t});return this.updateViewport(n,We,{isDragging:!0,isRotating:!0}),!0}_onPanRotateEnd(e){const{inertia:t}=this;if(this.dragRotate&&t&&e.velocity){const n=this.getCenter(e),r=[n[0]+e.velocityX*t/2,n[1]+e.velocityY*t/2],i=this.controllerState.rotate({pos:r}).rotateEnd();this.updateViewport(i,{...this._getTransitionProps(),transitionDuration:t,transitionEasing:vs},{isDragging:!1,isRotating:!0})}else{const n=this.controllerState.rotateEnd();this.updateViewport(n,null,{isDragging:!1,isRotating:!1})}return!0}_onWheel(e){if(!this.scrollZoom)return!1;const t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;e.srcEvent.preventDefault();const{speed:n=.01,smooth:r=!1}=this.scrollZoom===!0?{}:this.scrollZoom,{delta:i}=e;let o=2/(1+Math.exp(-Math.abs(i*n)));i<0&&o!==0&&(o=1/o);const a=this.controllerState.zoom({pos:t,scale:o});return this.updateViewport(a,{...this._getTransitionProps({around:t}),transitionDuration:r?250:1},{isZooming:!0,isPanning:!0}),!0}_onMultiPanStart(e){const t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;const n=this.controllerState.rotateStart({pos:t});return this.updateViewport(n,We,{isDragging:!0}),!0}_onMultiPan(e){if(!this.touchRotate||!this.isDragging())return!1;const t=this.getCenter(e);t[0]-=e.deltaX;const n=this.controllerState.rotate({pos:t});return this.updateViewport(n,We,{isDragging:!0,isRotating:!0}),!0}_onMultiPanEnd(e){if(!this.isDragging())return!1;const{inertia:t}=this;if(this.touchRotate&&t&&e.velocityY){const n=this.getCenter(e),r=[n[0],n[1]+=e.velocityY*t/2],i=this.controllerState.rotate({pos:r});this.updateViewport(i,{...this._getTransitionProps(),transitionDuration:t,transitionEasing:vs},{isDragging:!1,isRotating:!0}),this.blockEvents(t)}else{const n=this.controllerState.rotateEnd();this.updateViewport(n,null,{isDragging:!1,isRotating:!1})}return!0}_onPinchStart(e){const t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;const n=this.controllerState.zoomStart({pos:t}).rotateStart({pos:t});return Ge._startPinchRotation=e.rotation,Ge._lastPinchEvent=e,this.updateViewport(n,We,{isDragging:!0}),!0}_onPinch(e){if(!this.touchZoom&&!this.touchRotate||!this.isDragging())return!1;let t=this.controllerState;if(this.touchZoom){const{scale:n}=e,r=this.getCenter(e);t=t.zoom({pos:r,scale:n})}if(this.touchRotate){const{rotation:n}=e;t=t.rotate({deltaAngleX:Ge._startPinchRotation-n})}return this.updateViewport(t,We,{isDragging:!0,isPanning:this.touchZoom,isZooming:this.touchZoom,isRotating:this.touchRotate}),Ge._lastPinchEvent=e,!0}_onPinchEnd(e){if(!this.isDragging())return!1;const{inertia:t}=this,{_lastPinchEvent:n}=Ge;if(this.touchZoom&&t&&n&&e.scale!==n.scale){const r=this.getCenter(e);let i=this.controllerState.rotateEnd();const o=Math.log2(e.scale),a=(o-Math.log2(n.scale))/(e.deltaTime-n.deltaTime),c=Math.pow(2,o+a*t/2);i=i.zoom({pos:r,scale:c}).zoomEnd(),this.updateViewport(i,{...this._getTransitionProps({around:r}),transitionDuration:t,transitionEasing:vs},{isDragging:!1,isPanning:this.touchZoom,isZooming:this.touchZoom,isRotating:!1}),this.blockEvents(t)}else{const r=this.controllerState.zoomEnd().rotateEnd();this.updateViewport(r,null,{isDragging:!1,isPanning:!1,isZooming:!1,isRotating:!1})}return Ge._startPinchRotation=null,Ge._lastPinchEvent=null,!0}_onDoubleClick(e){if(!this.doubleClickZoom)return!1;const t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;const n=this.isFunctionKeyPressed(e),r=this.controllerState.zoom({pos:t,scale:n?.5:2});return this.updateViewport(r,this._getTransitionProps({around:t}),{isZooming:!0,isPanning:!0}),this.blockEvents(100),!0}_onKeyDown(e){if(!this.keyboard)return!1;const t=this.isFunctionKeyPressed(e),{zoomSpeed:n,moveSpeed:r,rotateSpeedX:i,rotateSpeedY:o}=this.keyboard===!0?{}:this.keyboard,{controllerState:a}=this;let c;const l={};switch(e.srcEvent.code){case"Minus":c=t?a.zoomOut(n).zoomOut(n):a.zoomOut(n),l.isZooming=!0;break;case"Equal":c=t?a.zoomIn(n).zoomIn(n):a.zoomIn(n),l.isZooming=!0;break;case"ArrowLeft":t?(c=a.rotateLeft(i),l.isRotating=!0):(c=a.moveLeft(r),l.isPanning=!0);break;case"ArrowRight":t?(c=a.rotateRight(i),l.isRotating=!0):(c=a.moveRight(r),l.isPanning=!0);break;case"ArrowUp":t?(c=a.rotateUp(o),l.isRotating=!0):(c=a.moveUp(r),l.isPanning=!0);break;case"ArrowDown":t?(c=a.rotateDown(o),l.isRotating=!0):(c=a.moveDown(r),l.isPanning=!0);break;default:return!1}return this.updateViewport(c,this._getTransitionProps(),l),!0}_getTransitionProps(e){const{transition:t}=this;return!t||!t.transitionInterpolator?We:e?{...t,transitionInterpolator:new el({...e,...t.transitionInterpolator.opts,makeViewport:this.controllerState.makeViewport})}:t}}class fb{constructor(e,t){this._viewportProps=this.applyConstraints(e),this._state=t}getViewportProps(){return this._viewportProps}getState(){return this._state}}const Do=5,db=1.2;class pb extends fb{constructor(e){const{width:t,height:n,latitude:r,longitude:i,zoom:o,bearing:a=0,pitch:c=0,altitude:l=1.5,position:u=[0,0,0],maxZoom:h=20,minZoom:f=0,maxPitch:g=60,minPitch:_=0,startPanLngLat:w,startZoomLngLat:A,startRotatePos:S,startBearing:I,startPitch:x,startZoom:E,normalize:P=!0}=e;ue(Number.isFinite(i)),ue(Number.isFinite(r)),ue(Number.isFinite(o)),super({width:t,height:n,latitude:r,longitude:i,zoom:o,bearing:a,pitch:c,altitude:l,maxZoom:h,minZoom:f,maxPitch:g,minPitch:_,normalize:P,position:u},{startPanLngLat:w,startZoomLngLat:A,startRotatePos:S,startBearing:I,startPitch:x,startZoom:E}),this.makeViewport=e.makeViewport}panStart({pos:e}){return this._getUpdatedState({startPanLngLat:this._unproject(e)})}pan({pos:e,startPos:t}){const n=this.getState().startPanLngLat||this._unproject(t);if(!n)return this;const i=this.makeViewport(this.getViewportProps()).panByPosition(n,e);return this._getUpdatedState(i)}panEnd(){return this._getUpdatedState({startPanLngLat:null})}rotateStart({pos:e}){return this._getUpdatedState({startRotatePos:e,startBearing:this.getViewportProps().bearing,startPitch:this.getViewportProps().pitch})}rotate({pos:e,deltaAngleX:t=0,deltaAngleY:n=0}){const{startRotatePos:r,startBearing:i,startPitch:o}=this.getState();if(!r||i===void 0||o===void 0)return this;let a;return e?a=this._getNewRotation(e,r,o,i):a={bearing:i+t,pitch:o+n},this._getUpdatedState(a)}rotateEnd(){return this._getUpdatedState({startBearing:null,startPitch:null})}zoomStart({pos:e}){return this._getUpdatedState({startZoomLngLat:this._unproject(e),startZoom:this.getViewportProps().zoom})}zoom({pos:e,startPos:t,scale:n}){let{startZoom:r,startZoomLngLat:i}=this.getState();if(i||(r=this.getViewportProps().zoom,i=this._unproject(t)||this._unproject(e)),!i)return this;const{maxZoom:o,minZoom:a}=this.getViewportProps();let c=r+Math.log2(n);c=Ye(c,a,o);const l=this.makeViewport({...this.getViewportProps(),zoom:c});return this._getUpdatedState({zoom:c,...l.panByPosition(i,e)})}zoomEnd(){return this._getUpdatedState({startZoomLngLat:null,startZoom:null})}zoomIn(e=2){return this._zoomFromCenter(e)}zoomOut(e=2){return this._zoomFromCenter(1/e)}moveLeft(e=100){return this._panFromCenter([e,0])}moveRight(e=100){return this._panFromCenter([-e,0])}moveUp(e=100){return this._panFromCenter([0,e])}moveDown(e=100){return this._panFromCenter([0,-e])}rotateLeft(e=15){return this._getUpdatedState({bearing:this.getViewportProps().bearing-e})}rotateRight(e=15){return this._getUpdatedState({bearing:this.getViewportProps().bearing+e})}rotateUp(e=10){return this._getUpdatedState({pitch:this.getViewportProps().pitch+e})}rotateDown(e=10){return this._getUpdatedState({pitch:this.getViewportProps().pitch-e})}shortestPathFrom(e){const t=e.getViewportProps(),n={...this.getViewportProps()},{bearing:r,longitude:i}=n;return Math.abs(r-t.bearing)>180&&(n.bearing=r<0?r+360:r-360),Math.abs(i-t.longitude)>180&&(n.longitude=i<0?i+360:i-360),n}applyConstraints(e){const{maxZoom:t,minZoom:n,zoom:r}=e;e.zoom=Ye(r,n,t);const{maxPitch:i,minPitch:o,pitch:a}=e;e.pitch=Ye(a,o,i);const{normalize:c=!0}=e;return c&&Object.assign(e,U_(e)),e}_zoomFromCenter(e){const{width:t,height:n}=this.getViewportProps();return this.zoom({pos:[t/2,n/2],scale:e})}_panFromCenter(e){const{width:t,height:n}=this.getViewportProps();return this.pan({startPos:[t/2,n/2],pos:[t/2+e[0],n/2+e[1]]})}_getUpdatedState(e){return new this.constructor({makeViewport:this.makeViewport,...this.getViewportProps(),...this.getState(),...e})}_unproject(e){const t=this.makeViewport(this.getViewportProps());return e&&t.unproject(e)}_getNewRotation(e,t,n,r){const i=e[0]-t[0],o=e[1]-t[1],a=e[1],c=t[1],{width:l,height:u}=this.getViewportProps(),h=i/l;let f=0;o>0?Math.abs(u-c)>Do&&(f=o/(c-u)*db):o<0&&c>Do&&(f=1-a/c),f=Ye(f,-1,1);const{minPitch:g,maxPitch:_}=this.getViewportProps(),w=r+180*h;let A=n;return f>0?A=n+f*(_-n):f<0&&(A=n-f*(g-n)),{pitch:A,bearing:w}}}class gb extends hb{constructor(){super(...arguments),this.ControllerState=pb,this.transition={transitionDuration:300,transitionInterpolator:new el({transitionProps:{compare:["longitude","latitude","zoom","bearing","pitch","position"],required:["longitude","latitude","zoom"]}})},this.dragMode="pan"}setProps(e){e.position=e.position||[0,0,0];const t=this.props;super.setProps(e),(!t||t.height!==e.height)&&this.updateViewport(new this.ControllerState({makeViewport:this.makeViewport,...e,...this.state}))}}class tl extends nb{constructor(e={}){super(e)}getViewportType(){return Ft}get ControllerType(){return gb}}tl.displayName="MapView";const _b=new zc;function mb(s,e){const t=s.order??1/0,n=e.order??1/0;return t-n}class bb{constructor(e){this._resolvedEffects=[],this._defaultEffects=[],this.effects=[],this._context=e,this._needsRedraw="Initial render",this._setEffects([])}addDefaultEffect(e){const t=this._defaultEffects;if(!t.find(n=>n.id===e.id)){const n=t.findIndex(r=>mb(r,e)>0);n<0?t.push(e):t.splice(n,0,e),e.setup(this._context),this._setEffects(this.effects)}}setProps(e){"effects"in e&&(Re(e.effects,this.effects,1)||this._setEffects(e.effects))}needsRedraw(e={clearRedrawFlags:!1}){const t=this._needsRedraw;return e.clearRedrawFlags&&(this._needsRedraw=!1),t}getEffects(){return this._resolvedEffects}_setEffects(e){const t={};for(const r of this.effects)t[r.id]=r;const n=[];for(const r of e){const i=t[r.id];let o=r;i&&i!==r?i.setProps?(i.setProps(r.props),o=i):i.cleanup(this._context):i||r.setup(this._context),n.push(o),delete t[r.id]}for(const r in t)t[r].cleanup(this._context);this.effects=n,this._resolvedEffects=n.concat(this._defaultEffects),e.some(r=>r instanceof zc)||this._resolvedEffects.push(_b),this._needsRedraw="effects changed"}finalize(){for(const e of this._resolvedEffects)e.cleanup(this._context);this.effects.length=0,this._resolvedEffects.length=0,this._defaultEffects.length=0}}class yb extends Gr{shouldDrawLayer(e){const{operation:t}=e.props;return t.includes("draw")||t.includes("terrain")}}const Tb="deckRenderer.renderLayers";class wb{constructor(e){this.device=e,this.layerFilter=null,this.drawPickingColors=!1,this.drawLayersPass=new yb(e),this.pickLayersPass=new Qc(e),this.renderCount=0,this._needsRedraw="Initial render",this.renderBuffers=[],this.lastPostProcessEffect=null}setProps(e){this.layerFilter!==e.layerFilter&&(this.layerFilter=e.layerFilter,this._needsRedraw="layerFilter changed"),this.drawPickingColors!==e.drawPickingColors&&(this.drawPickingColors=e.drawPickingColors,this._needsRedraw="drawPickingColors changed")}renderLayers(e){if(!e.viewports.length)return;const t=this.drawPickingColors?this.pickLayersPass:this.drawLayersPass,n={layerFilter:this.layerFilter,isPicking:this.drawPickingColors,...e};n.effects&&this._preRender(n.effects,n);const r=this.lastPostProcessEffect?this.renderBuffers[0]:n.target;this.lastPostProcessEffect&&(n.clearColor=[0,0,0,0],n.clearCanvas=!0);const i=t.render({...n,target:r});n.effects&&this._postRender(n.effects,n),this.renderCount++,fe(Tb,this,i,e)}needsRedraw(e={clearRedrawFlags:!1}){const t=this._needsRedraw;return e.clearRedrawFlags&&(this._needsRedraw=!1),t}finalize(){const{renderBuffers:e}=this;for(const t of e)t.delete();e.length=0}_preRender(e,t){this.lastPostProcessEffect=null,t.preRenderStats=t.preRenderStats||{};for(const n of e)t.preRenderStats[n.id]=n.preRender(t),n.postRender&&(this.lastPostProcessEffect=n.id);this.lastPostProcessEffect&&this._resizeRenderBuffers()}_resizeRenderBuffers(){const{renderBuffers:e}=this,t=this.device.canvasContext.getDrawingBufferSize();e.length===0&&[0,1].map(n=>{const r=this.device.createTexture({sampler:{minFilter:"linear",magFilter:"linear"}});e.push(this.device.createFramebuffer({id:`deck-renderbuffer-${n}`,colorAttachments:[r]}))});for(const n of e)n.resize(t)}_postRender(e,t){const{renderBuffers:n}=this,r={...t,inputBuffer:n[0],swapBuffer:n[1]};for(const i of e)if(i.postRender){r.target=i.id===this.lastPostProcessEffect?t.target:void 0;const o=i.postRender(r);r.inputBuffer=o,r.swapBuffer=o===n[0]?n[1]:n[0]}}}const vb={pickedColor:null,pickedObjectIndex:-1};function Ab({pickedColors:s,decodePickingColor:e,deviceX:t,deviceY:n,deviceRadius:r,deviceRect:i}){const{x:o,y:a,width:c,height:l}=i;let u=r*r,h=-1,f=0;for(let g=0;g<l;g++){const _=g+a-n,w=_*_;if(w>u)f+=4*c;else for(let A=0;A<c;A++){if(s[f+3]-1>=0){const I=A+o-t,x=I*I+w;x<=u&&(u=x,h=f)}f+=4}}if(h>=0){const g=s.slice(h,h+4),_=e(g);if(_){const w=Math.floor(h/4/c),A=h/4-w*c;return{..._,pickedColor:g,pickedX:o+A,pickedY:a+w}}Y.error("Picked non-existent layer. Is picking buffer corrupt?")()}return vb}function xb({pickedColors:s,decodePickingColor:e}){const t=new Map;if(s){for(let n=0;n<s.length;n+=4)if(s[n+3]-1>=0){const i=s.slice(n,n+4),o=i.join(",");if(!t.has(o)){const a=e(i);a?t.set(o,{...a,color:i}):Y.error("Picked non-existent layer. Is picking buffer corrupt?")()}}}return Array.from(t.values())}function sl({pickInfo:s,viewports:e,pixelRatio:t,x:n,y:r,z:i}){let o=e[0];e.length>1&&(o=Sb(s?.pickedViewports||e,{x:n,y:r}));let a;if(o){const c=[n-o.x,r-o.y];i!==void 0&&(c[2]=i),a=o.unproject(c)}return{color:null,layer:null,viewport:o,index:-1,picked:!1,x:n,y:r,pixel:[n,r],coordinate:a,devicePixel:s&&"pickedX"in s?[s.pickedX,s.pickedY]:void 0,pixelRatio:t}}function Eb(s){const{pickInfo:e,lastPickedInfo:t,mode:n,layers:r}=s,{pickedColor:i,pickedLayer:o,pickedObjectIndex:a}=e,c=o?[o]:[];if(n==="hover"){const h=t.index,f=t.layerId,g=o?o.props.id:null;if(g!==f||a!==h){if(g!==f){const _=r.find(w=>w.props.id===f);_&&c.unshift(_)}t.layerId=g,t.index=a,t.info=null}}const l=sl(s),u=new Map;return u.set(null,l),c.forEach(h=>{let f={...l};h===o&&(f.color=i,f.index=a,f.picked=!0),f=nl({layer:h,info:f,mode:n});const g=f.layer;h===o&&n==="hover"&&(t.info=f),u.set(g.id,f),n==="hover"&&g.updateAutoHighlight(f)}),u}function nl({layer:s,info:e,mode:t}){for(;s&&e;){const n=e.layer||null;e.sourceLayer=n,e.layer=s,e=s.getPickingInfo({info:e,mode:t,sourceLayer:n}),s=s.parent}return e}function Sb(s,e){for(let t=s.length-1;t>=0;t--){const n=s[t];if(n.containsPixel(e))return n}return s[0]}class Rb{constructor(e){this._pickable=!0,this.device=e,this.pickLayersPass=new Qc(e),this.lastPickedInfo={index:-1,layerId:null,info:null}}setProps(e){"layerFilter"in e&&(this.layerFilter=e.layerFilter),"_pickable"in e&&(this._pickable=e._pickable)}finalize(){this.pickingFBO&&this.pickingFBO.destroy(),this.depthFBO&&this.depthFBO.destroy()}pickObject(e){return this._pickClosestObject(e)}pickObjects(e){return this._pickVisibleObjects(e)}getLastPickedObject({x:e,y:t,layers:n,viewports:r},i=this.lastPickedInfo.info){const o=i&&i.layer&&i.layer.id,a=i&&i.viewport&&i.viewport.id,c=o?n.find(f=>f.id===o):null,l=a&&r.find(f=>f.id===a)||r[0],u=l&&l.unproject([e-l.x,t-l.y]);return{...i,...{x:e,y:t,viewport:l,coordinate:u,layer:c}}}_resizeBuffer(){if(!this.pickingFBO&&(this.pickingFBO=this.device.createFramebuffer({colorAttachments:["rgba8unorm"],depthStencilAttachment:"depth16unorm"}),this.device.isTextureFormatRenderable("rgba32float"))){const t=this.device.createFramebuffer({colorAttachments:["rgba32float"],depthStencilAttachment:"depth16unorm"});this.depthFBO=t}const{canvas:e}=this.device.getDefaultCanvasContext();this.pickingFBO?.resize({width:e.width,height:e.height}),this.depthFBO?.resize({width:e.width,height:e.height})}_getPickable(e){if(this._pickable===!1)return null;const t=e.filter(n=>this.pickLayersPass.shouldDrawLayer(n)&&!n.isComposite);return t.length?t:null}_pickClosestObject({layers:e,views:t,viewports:n,x:r,y:i,radius:o=0,depth:a=1,mode:c="query",unproject3D:l,onViewportActive:u,effects:h}){const f=this.device.canvasContext.cssToDeviceRatio(),g=this._getPickable(e);if(!g||n.length===0)return{result:[],emptyInfo:sl({viewports:n,x:r,y:i,pixelRatio:f})};this._resizeBuffer();const _=this.device.canvasContext.cssToDevicePixels([r,i],!0),w=[_.x+Math.floor(_.width/2),_.y+Math.floor(_.height/2)],A=Math.round(o*f),{width:S,height:I}=this.pickingFBO,x=this._getPickingRect({deviceX:w[0],deviceY:w[1],deviceRadius:A,deviceWidth:S,deviceHeight:I}),E={x:r-o,y:i-o,width:o*2+1,height:o*2+1};let P;const M=[],D=new Set;for(let B=0;B<a;B++){let N;if(x){const L=this._drawAndSample({layers:g,views:t,viewports:n,onViewportActive:u,deviceRect:x,cullRect:E,effects:h,pass:`picking:${c}`});N=Ab({...L,deviceX:w[0],deviceY:w[1],deviceRadius:A,deviceRect:x})}else N={pickedColor:null,pickedObjectIndex:-1};let U;if(N.pickedLayer&&l&&this.depthFBO){const{pickedColors:L}=this._drawAndSample({layers:[N.pickedLayer],views:t,viewports:n,onViewportActive:u,deviceRect:{x:N.pickedX,y:N.pickedY,width:1,height:1},cullRect:E,effects:h,pass:`picking:${c}:z`},!0);L[3]&&(U=L[0])}N.pickedLayer&&B+1<a&&(D.add(N.pickedLayer),N.pickedLayer.disablePickingIndex(N.pickedObjectIndex)),P=Eb({pickInfo:N,lastPickedInfo:this.lastPickedInfo,mode:c,layers:g,viewports:n,x:r,y:i,z:U,pixelRatio:f});for(const L of P.values())L.layer&&M.push(L);if(!N.pickedColor)break}for(const B of D)B.restorePickingColors();return{result:M,emptyInfo:P.get(null)}}_pickVisibleObjects({layers:e,views:t,viewports:n,x:r,y:i,width:o=1,height:a=1,mode:c="query",maxObjects:l=null,onViewportActive:u,effects:h}){const f=this._getPickable(e);if(!f||n.length===0)return[];this._resizeBuffer();const g=this.device.canvasContext.cssToDeviceRatio(),_=this.device.canvasContext.cssToDevicePixels([r,i],!0),w=_.x,A=_.y+_.height,S=this.device.canvasContext.cssToDevicePixels([r+o,i+a],!0),I=S.x+S.width,x=S.y,E={x:w,y:x,width:I-w,height:A-x},P=this._drawAndSample({layers:f,views:t,viewports:n,onViewportActive:u,deviceRect:E,cullRect:{x:r,y:i,width:o,height:a},effects:h,pass:`picking:${c}`}),M=xb(P),D=new Map,B=[],N=Number.isFinite(l);for(let U=0;U<M.length&&!(N&&B.length>=l);U++){const L=M[U];let Z={color:L.pickedColor,layer:null,index:L.pickedObjectIndex,picked:!0,x:r,y:i,pixelRatio:g};Z=nl({layer:L.pickedLayer,info:Z,mode:c});const Q=Z.layer.id;D.has(Q)||D.set(Q,new Set);const V=D.get(Q),Ae=Z.object??Z.index;V.has(Ae)||(V.add(Ae),B.push(Z))}return B}_drawAndSample({layers:e,views:t,viewports:n,onViewportActive:r,deviceRect:i,cullRect:o,effects:a,pass:c},l=!1){const u=l?this.depthFBO:this.pickingFBO,h={layers:e,layerFilter:this.layerFilter,views:t,viewports:n,onViewportActive:r,pickingFBO:u,deviceRect:i,cullRect:o,effects:a,pass:c,pickZ:l,preRenderStats:{},isPicking:!0};for(const I of a)I.useInPicking&&(h.preRenderStats[I.id]=I.preRender(h));const{decodePickingColor:f}=this.pickLayersPass.render(h),{x:g,y:_,width:w,height:A}=i,S=new(l?Float32Array:Uint8Array)(w*A*4);return this.device.readPixelsToArrayWebGL(u,{sourceX:g,sourceY:_,sourceWidth:w,sourceHeight:A,target:S}),{pickedColors:S,decodePickingColor:f}}_getPickingRect({deviceX:e,deviceY:t,deviceRadius:n,deviceWidth:r,deviceHeight:i}){const o=Math.max(0,e-n),a=Math.max(0,t-n),c=Math.min(r,e+n+1)-o,l=Math.min(i,t+n+1)-a;return c<=0||l<=0?null:{x:o,y:a,width:c,height:l}}}const Ib={"top-left":{top:0,left:0},"top-right":{top:0,right:0},"bottom-left":{bottom:0,left:0},"bottom-right":{bottom:0,right:0},fill:{top:0,left:0,bottom:0,right:0}},Cb="top-left",Fo="__root";class Pb{constructor({deck:e,parentElement:t}){this.defaultWidgets=[],this.widgets=[],this.resolvedWidgets=[],this.containers={},this.lastViewports={},this.deck=e,this.parentElement=t}getWidgets(){return this.resolvedWidgets}setProps(e){e.widgets&&!Re(e.widgets,this.widgets,1)&&this._setWidgets(e.widgets)}finalize(){for(const e of this.getWidgets())this._remove(e);this.defaultWidgets.length=0,this.resolvedWidgets.length=0;for(const e in this.containers)this.containers[e].remove()}addDefault(e){this.defaultWidgets.find(t=>t.id===e.id)||(this._add(e),this.defaultWidgets.push(e),this._setWidgets(this.widgets))}_setWidgets(e){const t={};for(const n of this.resolvedWidgets)t[n.id]=n;this.resolvedWidgets.length=0;for(const n of this.defaultWidgets)t[n.id]=null,this.resolvedWidgets.push(n);for(let n of e){const r=t[n.id];r?r.viewId!==n.viewId||r.placement!==n.placement?(this._remove(r),this._add(n)):n!==r&&(r.setProps(n.props),n=r):this._add(n),t[n.id]=null,this.resolvedWidgets.push(n)}for(const n in t){const r=t[n];r&&this._remove(r)}this.widgets=e}_add(e){const{viewId:t=null,placement:n=Cb}=e,r=e.onAdd({deck:this.deck,viewId:t});r&&this._getContainer(t,n).append(r),e._element=r}_remove(e){e.onRemove?.(),e._element&&e._element.remove(),e._element=void 0}_getContainer(e,t){const n=e||Fo;let r=this.containers[n];r||(r=document.createElement("div"),r.style.pointerEvents="none",r.style.position="absolute",r.style.overflow="hidden",this.parentElement?.append(r),this.containers[n]=r);let i=r.querySelector(`.${t}`);return i||(i=document.createElement("div"),i.className=t,i.style.position="absolute",i.style.zIndex="2",Object.assign(i.style,Ib[t]),r.append(i)),i}_updateContainers(){const e=this.deck.width,t=this.deck.height;for(const n in this.containers){const r=this.lastViewports[n]||null,i=n===Fo||r,o=this.containers[n];i?(o.style.display="block",o.style.left=`${r?r.x:0}px`,o.style.top=`${r?r.y:0}px`,o.style.width=`${r?r.width:e}px`,o.style.height=`${r?r.height:t}px`):o.style.display="none"}}onRedraw({viewports:e,layers:t}){const n=e.reduce((r,i)=>(r[i.id]=i,r),{});for(const r of this.getWidgets()){const{viewId:i}=r;if(i){const o=n[i];o&&(r.onViewportChange&&r.onViewportChange(o),r.onRedraw?.({viewports:[o],layers:t}))}else{if(r.onViewportChange)for(const o of e)r.onViewportChange(o);r.onRedraw?.({viewports:e,layers:t})}}this.lastViewports=n,this._updateContainers()}onHover(e,t){for(const n of this.getWidgets()){const{viewId:r}=n;(!r||r===e.viewport?.id)&&n.onHover?.(e,t)}}onEvent(e,t){const n=lr[t.type];if(n)for(const r of this.getWidgets()){const{viewId:i}=r;(!i||i===e.viewport?.id)&&r[n]?.(e,t)}}}const Mb={zIndex:"1",position:"absolute",pointerEvents:"none",color:"#a0a7b4",backgroundColor:"#29323c",padding:"10px",top:"0",left:"0",display:"none"};class Ob{constructor(){this.id="default-tooltip",this.placement="fill",this.props={},this.isVisible=!1}onAdd({deck:e}){const t=document.createElement("div");return t.className="deck-tooltip",Object.assign(t.style,Mb),this.deck=e,this.element=t,t}onRemove(){this.deck=void 0,this.element=void 0}setProps(){}onViewportChange(e){this.isVisible&&e.id===this.lastViewport?.id&&e!==this.lastViewport&&this.setTooltip(null)}onHover(e){const{deck:t}=this,n=t&&t.props.getTooltip;if(!n)return;const r=n(e);this.lastViewport=e.viewport,this.setTooltip(r,e.x,e.y)}setTooltip(e,t,n){const r=this.element;if(r){if(typeof e=="string")r.innerText=e;else if(e)e.text&&(r.innerText=e.text),e.html&&(r.innerHTML=e.html),e.className&&(r.className=e.className);else{this.isVisible=!1,r.style.display="none";return}this.isVisible=!0,r.style.display="block",r.style.transform=`translate(${t}px, ${n}px)`,e&&typeof e=="object"&&"style"in e&&Object.assign(r.style,e.style)}}}var At;(function(s){s[s.DEPTH_BUFFER_BIT=256]="DEPTH_BUFFER_BIT",s[s.STENCIL_BUFFER_BIT=1024]="STENCIL_BUFFER_BIT",s[s.COLOR_BUFFER_BIT=16384]="COLOR_BUFFER_BIT",s[s.POINTS=0]="POINTS",s[s.LINES=1]="LINES",s[s.LINE_LOOP=2]="LINE_LOOP",s[s.LINE_STRIP=3]="LINE_STRIP",s[s.TRIANGLES=4]="TRIANGLES",s[s.TRIANGLE_STRIP=5]="TRIANGLE_STRIP",s[s.TRIANGLE_FAN=6]="TRIANGLE_FAN",s[s.ZERO=0]="ZERO",s[s.ONE=1]="ONE",s[s.SRC_COLOR=768]="SRC_COLOR",s[s.ONE_MINUS_SRC_COLOR=769]="ONE_MINUS_SRC_COLOR",s[s.SRC_ALPHA=770]="SRC_ALPHA",s[s.ONE_MINUS_SRC_ALPHA=771]="ONE_MINUS_SRC_ALPHA",s[s.DST_ALPHA=772]="DST_ALPHA",s[s.ONE_MINUS_DST_ALPHA=773]="ONE_MINUS_DST_ALPHA",s[s.DST_COLOR=774]="DST_COLOR",s[s.ONE_MINUS_DST_COLOR=775]="ONE_MINUS_DST_COLOR",s[s.SRC_ALPHA_SATURATE=776]="SRC_ALPHA_SATURATE",s[s.CONSTANT_COLOR=32769]="CONSTANT_COLOR",s[s.ONE_MINUS_CONSTANT_COLOR=32770]="ONE_MINUS_CONSTANT_COLOR",s[s.CONSTANT_ALPHA=32771]="CONSTANT_ALPHA",s[s.ONE_MINUS_CONSTANT_ALPHA=32772]="ONE_MINUS_CONSTANT_ALPHA",s[s.FUNC_ADD=32774]="FUNC_ADD",s[s.FUNC_SUBTRACT=32778]="FUNC_SUBTRACT",s[s.FUNC_REVERSE_SUBTRACT=32779]="FUNC_REVERSE_SUBTRACT",s[s.BLEND_EQUATION=32777]="BLEND_EQUATION",s[s.BLEND_EQUATION_RGB=32777]="BLEND_EQUATION_RGB",s[s.BLEND_EQUATION_ALPHA=34877]="BLEND_EQUATION_ALPHA",s[s.BLEND_DST_RGB=32968]="BLEND_DST_RGB",s[s.BLEND_SRC_RGB=32969]="BLEND_SRC_RGB",s[s.BLEND_DST_ALPHA=32970]="BLEND_DST_ALPHA",s[s.BLEND_SRC_ALPHA=32971]="BLEND_SRC_ALPHA",s[s.BLEND_COLOR=32773]="BLEND_COLOR",s[s.ARRAY_BUFFER_BINDING=34964]="ARRAY_BUFFER_BINDING",s[s.ELEMENT_ARRAY_BUFFER_BINDING=34965]="ELEMENT_ARRAY_BUFFER_BINDING",s[s.LINE_WIDTH=2849]="LINE_WIDTH",s[s.ALIASED_POINT_SIZE_RANGE=33901]="ALIASED_POINT_SIZE_RANGE",s[s.ALIASED_LINE_WIDTH_RANGE=33902]="ALIASED_LINE_WIDTH_RANGE",s[s.CULL_FACE_MODE=2885]="CULL_FACE_MODE",s[s.FRONT_FACE=2886]="FRONT_FACE",s[s.DEPTH_RANGE=2928]="DEPTH_RANGE",s[s.DEPTH_WRITEMASK=2930]="DEPTH_WRITEMASK",s[s.DEPTH_CLEAR_VALUE=2931]="DEPTH_CLEAR_VALUE",s[s.DEPTH_FUNC=2932]="DEPTH_FUNC",s[s.STENCIL_CLEAR_VALUE=2961]="STENCIL_CLEAR_VALUE",s[s.STENCIL_FUNC=2962]="STENCIL_FUNC",s[s.STENCIL_FAIL=2964]="STENCIL_FAIL",s[s.STENCIL_PASS_DEPTH_FAIL=2965]="STENCIL_PASS_DEPTH_FAIL",s[s.STENCIL_PASS_DEPTH_PASS=2966]="STENCIL_PASS_DEPTH_PASS",s[s.STENCIL_REF=2967]="STENCIL_REF",s[s.STENCIL_VALUE_MASK=2963]="STENCIL_VALUE_MASK",s[s.STENCIL_WRITEMASK=2968]="STENCIL_WRITEMASK",s[s.STENCIL_BACK_FUNC=34816]="STENCIL_BACK_FUNC",s[s.STENCIL_BACK_FAIL=34817]="STENCIL_BACK_FAIL",s[s.STENCIL_BACK_PASS_DEPTH_FAIL=34818]="STENCIL_BACK_PASS_DEPTH_FAIL",s[s.STENCIL_BACK_PASS_DEPTH_PASS=34819]="STENCIL_BACK_PASS_DEPTH_PASS",s[s.STENCIL_BACK_REF=36003]="STENCIL_BACK_REF",s[s.STENCIL_BACK_VALUE_MASK=36004]="STENCIL_BACK_VALUE_MASK",s[s.STENCIL_BACK_WRITEMASK=36005]="STENCIL_BACK_WRITEMASK",s[s.VIEWPORT=2978]="VIEWPORT",s[s.SCISSOR_BOX=3088]="SCISSOR_BOX",s[s.COLOR_CLEAR_VALUE=3106]="COLOR_CLEAR_VALUE",s[s.COLOR_WRITEMASK=3107]="COLOR_WRITEMASK",s[s.UNPACK_ALIGNMENT=3317]="UNPACK_ALIGNMENT",s[s.PACK_ALIGNMENT=3333]="PACK_ALIGNMENT",s[s.MAX_TEXTURE_SIZE=3379]="MAX_TEXTURE_SIZE",s[s.MAX_VIEWPORT_DIMS=3386]="MAX_VIEWPORT_DIMS",s[s.SUBPIXEL_BITS=3408]="SUBPIXEL_BITS",s[s.RED_BITS=3410]="RED_BITS",s[s.GREEN_BITS=3411]="GREEN_BITS",s[s.BLUE_BITS=3412]="BLUE_BITS",s[s.ALPHA_BITS=3413]="ALPHA_BITS",s[s.DEPTH_BITS=3414]="DEPTH_BITS",s[s.STENCIL_BITS=3415]="STENCIL_BITS",s[s.POLYGON_OFFSET_UNITS=10752]="POLYGON_OFFSET_UNITS",s[s.POLYGON_OFFSET_FACTOR=32824]="POLYGON_OFFSET_FACTOR",s[s.TEXTURE_BINDING_2D=32873]="TEXTURE_BINDING_2D",s[s.SAMPLE_BUFFERS=32936]="SAMPLE_BUFFERS",s[s.SAMPLES=32937]="SAMPLES",s[s.SAMPLE_COVERAGE_VALUE=32938]="SAMPLE_COVERAGE_VALUE",s[s.SAMPLE_COVERAGE_INVERT=32939]="SAMPLE_COVERAGE_INVERT",s[s.COMPRESSED_TEXTURE_FORMATS=34467]="COMPRESSED_TEXTURE_FORMATS",s[s.VENDOR=7936]="VENDOR",s[s.RENDERER=7937]="RENDERER",s[s.VERSION=7938]="VERSION",s[s.IMPLEMENTATION_COLOR_READ_TYPE=35738]="IMPLEMENTATION_COLOR_READ_TYPE",s[s.IMPLEMENTATION_COLOR_READ_FORMAT=35739]="IMPLEMENTATION_COLOR_READ_FORMAT",s[s.BROWSER_DEFAULT_WEBGL=37444]="BROWSER_DEFAULT_WEBGL",s[s.STATIC_DRAW=35044]="STATIC_DRAW",s[s.STREAM_DRAW=35040]="STREAM_DRAW",s[s.DYNAMIC_DRAW=35048]="DYNAMIC_DRAW",s[s.ARRAY_BUFFER=34962]="ARRAY_BUFFER",s[s.ELEMENT_ARRAY_BUFFER=34963]="ELEMENT_ARRAY_BUFFER",s[s.BUFFER_SIZE=34660]="BUFFER_SIZE",s[s.BUFFER_USAGE=34661]="BUFFER_USAGE",s[s.CURRENT_VERTEX_ATTRIB=34342]="CURRENT_VERTEX_ATTRIB",s[s.VERTEX_ATTRIB_ARRAY_ENABLED=34338]="VERTEX_ATTRIB_ARRAY_ENABLED",s[s.VERTEX_ATTRIB_ARRAY_SIZE=34339]="VERTEX_ATTRIB_ARRAY_SIZE",s[s.VERTEX_ATTRIB_ARRAY_STRIDE=34340]="VERTEX_ATTRIB_ARRAY_STRIDE",s[s.VERTEX_ATTRIB_ARRAY_TYPE=34341]="VERTEX_ATTRIB_ARRAY_TYPE",s[s.VERTEX_ATTRIB_ARRAY_NORMALIZED=34922]="VERTEX_ATTRIB_ARRAY_NORMALIZED",s[s.VERTEX_ATTRIB_ARRAY_POINTER=34373]="VERTEX_ATTRIB_ARRAY_POINTER",s[s.VERTEX_ATTRIB_ARRAY_BUFFER_BINDING=34975]="VERTEX_ATTRIB_ARRAY_BUFFER_BINDING",s[s.CULL_FACE=2884]="CULL_FACE",s[s.FRONT=1028]="FRONT",s[s.BACK=1029]="BACK",s[s.FRONT_AND_BACK=1032]="FRONT_AND_BACK",s[s.BLEND=3042]="BLEND",s[s.DEPTH_TEST=2929]="DEPTH_TEST",s[s.DITHER=3024]="DITHER",s[s.POLYGON_OFFSET_FILL=32823]="POLYGON_OFFSET_FILL",s[s.SAMPLE_ALPHA_TO_COVERAGE=32926]="SAMPLE_ALPHA_TO_COVERAGE",s[s.SAMPLE_COVERAGE=32928]="SAMPLE_COVERAGE",s[s.SCISSOR_TEST=3089]="SCISSOR_TEST",s[s.STENCIL_TEST=2960]="STENCIL_TEST",s[s.NO_ERROR=0]="NO_ERROR",s[s.INVALID_ENUM=1280]="INVALID_ENUM",s[s.INVALID_VALUE=1281]="INVALID_VALUE",s[s.INVALID_OPERATION=1282]="INVALID_OPERATION",s[s.OUT_OF_MEMORY=1285]="OUT_OF_MEMORY",s[s.CONTEXT_LOST_WEBGL=37442]="CONTEXT_LOST_WEBGL",s[s.CW=2304]="CW",s[s.CCW=2305]="CCW",s[s.DONT_CARE=4352]="DONT_CARE",s[s.FASTEST=4353]="FASTEST",s[s.NICEST=4354]="NICEST",s[s.GENERATE_MIPMAP_HINT=33170]="GENERATE_MIPMAP_HINT",s[s.BYTE=5120]="BYTE",s[s.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",s[s.SHORT=5122]="SHORT",s[s.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",s[s.INT=5124]="INT",s[s.UNSIGNED_INT=5125]="UNSIGNED_INT",s[s.FLOAT=5126]="FLOAT",s[s.DOUBLE=5130]="DOUBLE",s[s.DEPTH_COMPONENT=6402]="DEPTH_COMPONENT",s[s.ALPHA=6406]="ALPHA",s[s.RGB=6407]="RGB",s[s.RGBA=6408]="RGBA",s[s.LUMINANCE=6409]="LUMINANCE",s[s.LUMINANCE_ALPHA=6410]="LUMINANCE_ALPHA",s[s.UNSIGNED_SHORT_4_4_4_4=32819]="UNSIGNED_SHORT_4_4_4_4",s[s.UNSIGNED_SHORT_5_5_5_1=32820]="UNSIGNED_SHORT_5_5_5_1",s[s.UNSIGNED_SHORT_5_6_5=33635]="UNSIGNED_SHORT_5_6_5",s[s.FRAGMENT_SHADER=35632]="FRAGMENT_SHADER",s[s.VERTEX_SHADER=35633]="VERTEX_SHADER",s[s.COMPILE_STATUS=35713]="COMPILE_STATUS",s[s.DELETE_STATUS=35712]="DELETE_STATUS",s[s.LINK_STATUS=35714]="LINK_STATUS",s[s.VALIDATE_STATUS=35715]="VALIDATE_STATUS",s[s.ATTACHED_SHADERS=35717]="ATTACHED_SHADERS",s[s.ACTIVE_ATTRIBUTES=35721]="ACTIVE_ATTRIBUTES",s[s.ACTIVE_UNIFORMS=35718]="ACTIVE_UNIFORMS",s[s.MAX_VERTEX_ATTRIBS=34921]="MAX_VERTEX_ATTRIBS",s[s.MAX_VERTEX_UNIFORM_VECTORS=36347]="MAX_VERTEX_UNIFORM_VECTORS",s[s.MAX_VARYING_VECTORS=36348]="MAX_VARYING_VECTORS",s[s.MAX_COMBINED_TEXTURE_IMAGE_UNITS=35661]="MAX_COMBINED_TEXTURE_IMAGE_UNITS",s[s.MAX_VERTEX_TEXTURE_IMAGE_UNITS=35660]="MAX_VERTEX_TEXTURE_IMAGE_UNITS",s[s.MAX_TEXTURE_IMAGE_UNITS=34930]="MAX_TEXTURE_IMAGE_UNITS",s[s.MAX_FRAGMENT_UNIFORM_VECTORS=36349]="MAX_FRAGMENT_UNIFORM_VECTORS",s[s.SHADER_TYPE=35663]="SHADER_TYPE",s[s.SHADING_LANGUAGE_VERSION=35724]="SHADING_LANGUAGE_VERSION",s[s.CURRENT_PROGRAM=35725]="CURRENT_PROGRAM",s[s.NEVER=512]="NEVER",s[s.LESS=513]="LESS",s[s.EQUAL=514]="EQUAL",s[s.LEQUAL=515]="LEQUAL",s[s.GREATER=516]="GREATER",s[s.NOTEQUAL=517]="NOTEQUAL",s[s.GEQUAL=518]="GEQUAL",s[s.ALWAYS=519]="ALWAYS",s[s.KEEP=7680]="KEEP",s[s.REPLACE=7681]="REPLACE",s[s.INCR=7682]="INCR",s[s.DECR=7683]="DECR",s[s.INVERT=5386]="INVERT",s[s.INCR_WRAP=34055]="INCR_WRAP",s[s.DECR_WRAP=34056]="DECR_WRAP",s[s.NEAREST=9728]="NEAREST",s[s.LINEAR=9729]="LINEAR",s[s.NEAREST_MIPMAP_NEAREST=9984]="NEAREST_MIPMAP_NEAREST",s[s.LINEAR_MIPMAP_NEAREST=9985]="LINEAR_MIPMAP_NEAREST",s[s.NEAREST_MIPMAP_LINEAR=9986]="NEAREST_MIPMAP_LINEAR",s[s.LINEAR_MIPMAP_LINEAR=9987]="LINEAR_MIPMAP_LINEAR",s[s.TEXTURE_MAG_FILTER=10240]="TEXTURE_MAG_FILTER",s[s.TEXTURE_MIN_FILTER=10241]="TEXTURE_MIN_FILTER",s[s.TEXTURE_WRAP_S=10242]="TEXTURE_WRAP_S",s[s.TEXTURE_WRAP_T=10243]="TEXTURE_WRAP_T",s[s.TEXTURE_2D=3553]="TEXTURE_2D",s[s.TEXTURE=5890]="TEXTURE",s[s.TEXTURE_CUBE_MAP=34067]="TEXTURE_CUBE_MAP",s[s.TEXTURE_BINDING_CUBE_MAP=34068]="TEXTURE_BINDING_CUBE_MAP",s[s.TEXTURE_CUBE_MAP_POSITIVE_X=34069]="TEXTURE_CUBE_MAP_POSITIVE_X",s[s.TEXTURE_CUBE_MAP_NEGATIVE_X=34070]="TEXTURE_CUBE_MAP_NEGATIVE_X",s[s.TEXTURE_CUBE_MAP_POSITIVE_Y=34071]="TEXTURE_CUBE_MAP_POSITIVE_Y",s[s.TEXTURE_CUBE_MAP_NEGATIVE_Y=34072]="TEXTURE_CUBE_MAP_NEGATIVE_Y",s[s.TEXTURE_CUBE_MAP_POSITIVE_Z=34073]="TEXTURE_CUBE_MAP_POSITIVE_Z",s[s.TEXTURE_CUBE_MAP_NEGATIVE_Z=34074]="TEXTURE_CUBE_MAP_NEGATIVE_Z",s[s.MAX_CUBE_MAP_TEXTURE_SIZE=34076]="MAX_CUBE_MAP_TEXTURE_SIZE",s[s.TEXTURE0=33984]="TEXTURE0",s[s.ACTIVE_TEXTURE=34016]="ACTIVE_TEXTURE",s[s.REPEAT=10497]="REPEAT",s[s.CLAMP_TO_EDGE=33071]="CLAMP_TO_EDGE",s[s.MIRRORED_REPEAT=33648]="MIRRORED_REPEAT",s[s.TEXTURE_WIDTH=4096]="TEXTURE_WIDTH",s[s.TEXTURE_HEIGHT=4097]="TEXTURE_HEIGHT",s[s.FLOAT_VEC2=35664]="FLOAT_VEC2",s[s.FLOAT_VEC3=35665]="FLOAT_VEC3",s[s.FLOAT_VEC4=35666]="FLOAT_VEC4",s[s.INT_VEC2=35667]="INT_VEC2",s[s.INT_VEC3=35668]="INT_VEC3",s[s.INT_VEC4=35669]="INT_VEC4",s[s.BOOL=35670]="BOOL",s[s.BOOL_VEC2=35671]="BOOL_VEC2",s[s.BOOL_VEC3=35672]="BOOL_VEC3",s[s.BOOL_VEC4=35673]="BOOL_VEC4",s[s.FLOAT_MAT2=35674]="FLOAT_MAT2",s[s.FLOAT_MAT3=35675]="FLOAT_MAT3",s[s.FLOAT_MAT4=35676]="FLOAT_MAT4",s[s.SAMPLER_2D=35678]="SAMPLER_2D",s[s.SAMPLER_CUBE=35680]="SAMPLER_CUBE",s[s.LOW_FLOAT=36336]="LOW_FLOAT",s[s.MEDIUM_FLOAT=36337]="MEDIUM_FLOAT",s[s.HIGH_FLOAT=36338]="HIGH_FLOAT",s[s.LOW_INT=36339]="LOW_INT",s[s.MEDIUM_INT=36340]="MEDIUM_INT",s[s.HIGH_INT=36341]="HIGH_INT",s[s.FRAMEBUFFER=36160]="FRAMEBUFFER",s[s.RENDERBUFFER=36161]="RENDERBUFFER",s[s.RGBA4=32854]="RGBA4",s[s.RGB5_A1=32855]="RGB5_A1",s[s.RGB565=36194]="RGB565",s[s.DEPTH_COMPONENT16=33189]="DEPTH_COMPONENT16",s[s.STENCIL_INDEX=6401]="STENCIL_INDEX",s[s.STENCIL_INDEX8=36168]="STENCIL_INDEX8",s[s.DEPTH_STENCIL=34041]="DEPTH_STENCIL",s[s.RENDERBUFFER_WIDTH=36162]="RENDERBUFFER_WIDTH",s[s.RENDERBUFFER_HEIGHT=36163]="RENDERBUFFER_HEIGHT",s[s.RENDERBUFFER_INTERNAL_FORMAT=36164]="RENDERBUFFER_INTERNAL_FORMAT",s[s.RENDERBUFFER_RED_SIZE=36176]="RENDERBUFFER_RED_SIZE",s[s.RENDERBUFFER_GREEN_SIZE=36177]="RENDERBUFFER_GREEN_SIZE",s[s.RENDERBUFFER_BLUE_SIZE=36178]="RENDERBUFFER_BLUE_SIZE",s[s.RENDERBUFFER_ALPHA_SIZE=36179]="RENDERBUFFER_ALPHA_SIZE",s[s.RENDERBUFFER_DEPTH_SIZE=36180]="RENDERBUFFER_DEPTH_SIZE",s[s.RENDERBUFFER_STENCIL_SIZE=36181]="RENDERBUFFER_STENCIL_SIZE",s[s.FRAMEBUFFER_ATTACHMENT_OBJECT_TYPE=36048]="FRAMEBUFFER_ATTACHMENT_OBJECT_TYPE",s[s.FRAMEBUFFER_ATTACHMENT_OBJECT_NAME=36049]="FRAMEBUFFER_ATTACHMENT_OBJECT_NAME",s[s.FRAMEBUFFER_ATTACHMENT_TEXTURE_LEVEL=36050]="FRAMEBUFFER_ATTACHMENT_TEXTURE_LEVEL",s[s.FRAMEBUFFER_ATTACHMENT_TEXTURE_CUBE_MAP_FACE=36051]="FRAMEBUFFER_ATTACHMENT_TEXTURE_CUBE_MAP_FACE",s[s.COLOR_ATTACHMENT0=36064]="COLOR_ATTACHMENT0",s[s.DEPTH_ATTACHMENT=36096]="DEPTH_ATTACHMENT",s[s.STENCIL_ATTACHMENT=36128]="STENCIL_ATTACHMENT",s[s.DEPTH_STENCIL_ATTACHMENT=33306]="DEPTH_STENCIL_ATTACHMENT",s[s.NONE=0]="NONE",s[s.FRAMEBUFFER_COMPLETE=36053]="FRAMEBUFFER_COMPLETE",s[s.FRAMEBUFFER_INCOMPLETE_ATTACHMENT=36054]="FRAMEBUFFER_INCOMPLETE_ATTACHMENT",s[s.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT=36055]="FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT",s[s.FRAMEBUFFER_INCOMPLETE_DIMENSIONS=36057]="FRAMEBUFFER_INCOMPLETE_DIMENSIONS",s[s.FRAMEBUFFER_UNSUPPORTED=36061]="FRAMEBUFFER_UNSUPPORTED",s[s.FRAMEBUFFER_BINDING=36006]="FRAMEBUFFER_BINDING",s[s.RENDERBUFFER_BINDING=36007]="RENDERBUFFER_BINDING",s[s.READ_FRAMEBUFFER=36008]="READ_FRAMEBUFFER",s[s.DRAW_FRAMEBUFFER=36009]="DRAW_FRAMEBUFFER",s[s.MAX_RENDERBUFFER_SIZE=34024]="MAX_RENDERBUFFER_SIZE",s[s.INVALID_FRAMEBUFFER_OPERATION=1286]="INVALID_FRAMEBUFFER_OPERATION",s[s.UNPACK_FLIP_Y_WEBGL=37440]="UNPACK_FLIP_Y_WEBGL",s[s.UNPACK_PREMULTIPLY_ALPHA_WEBGL=37441]="UNPACK_PREMULTIPLY_ALPHA_WEBGL",s[s.UNPACK_COLORSPACE_CONVERSION_WEBGL=37443]="UNPACK_COLORSPACE_CONVERSION_WEBGL",s[s.READ_BUFFER=3074]="READ_BUFFER",s[s.UNPACK_ROW_LENGTH=3314]="UNPACK_ROW_LENGTH",s[s.UNPACK_SKIP_ROWS=3315]="UNPACK_SKIP_ROWS",s[s.UNPACK_SKIP_PIXELS=3316]="UNPACK_SKIP_PIXELS",s[s.PACK_ROW_LENGTH=3330]="PACK_ROW_LENGTH",s[s.PACK_SKIP_ROWS=3331]="PACK_SKIP_ROWS",s[s.PACK_SKIP_PIXELS=3332]="PACK_SKIP_PIXELS",s[s.TEXTURE_BINDING_3D=32874]="TEXTURE_BINDING_3D",s[s.UNPACK_SKIP_IMAGES=32877]="UNPACK_SKIP_IMAGES",s[s.UNPACK_IMAGE_HEIGHT=32878]="UNPACK_IMAGE_HEIGHT",s[s.MAX_3D_TEXTURE_SIZE=32883]="MAX_3D_TEXTURE_SIZE",s[s.MAX_ELEMENTS_VERTICES=33e3]="MAX_ELEMENTS_VERTICES",s[s.MAX_ELEMENTS_INDICES=33001]="MAX_ELEMENTS_INDICES",s[s.MAX_TEXTURE_LOD_BIAS=34045]="MAX_TEXTURE_LOD_BIAS",s[s.MAX_FRAGMENT_UNIFORM_COMPONENTS=35657]="MAX_FRAGMENT_UNIFORM_COMPONENTS",s[s.MAX_VERTEX_UNIFORM_COMPONENTS=35658]="MAX_VERTEX_UNIFORM_COMPONENTS",s[s.MAX_ARRAY_TEXTURE_LAYERS=35071]="MAX_ARRAY_TEXTURE_LAYERS",s[s.MIN_PROGRAM_TEXEL_OFFSET=35076]="MIN_PROGRAM_TEXEL_OFFSET",s[s.MAX_PROGRAM_TEXEL_OFFSET=35077]="MAX_PROGRAM_TEXEL_OFFSET",s[s.MAX_VARYING_COMPONENTS=35659]="MAX_VARYING_COMPONENTS",s[s.FRAGMENT_SHADER_DERIVATIVE_HINT=35723]="FRAGMENT_SHADER_DERIVATIVE_HINT",s[s.RASTERIZER_DISCARD=35977]="RASTERIZER_DISCARD",s[s.VERTEX_ARRAY_BINDING=34229]="VERTEX_ARRAY_BINDING",s[s.MAX_VERTEX_OUTPUT_COMPONENTS=37154]="MAX_VERTEX_OUTPUT_COMPONENTS",s[s.MAX_FRAGMENT_INPUT_COMPONENTS=37157]="MAX_FRAGMENT_INPUT_COMPONENTS",s[s.MAX_SERVER_WAIT_TIMEOUT=37137]="MAX_SERVER_WAIT_TIMEOUT",s[s.MAX_ELEMENT_INDEX=36203]="MAX_ELEMENT_INDEX",s[s.RED=6403]="RED",s[s.RGB8=32849]="RGB8",s[s.RGBA8=32856]="RGBA8",s[s.RGB10_A2=32857]="RGB10_A2",s[s.TEXTURE_3D=32879]="TEXTURE_3D",s[s.TEXTURE_WRAP_R=32882]="TEXTURE_WRAP_R",s[s.TEXTURE_MIN_LOD=33082]="TEXTURE_MIN_LOD",s[s.TEXTURE_MAX_LOD=33083]="TEXTURE_MAX_LOD",s[s.TEXTURE_BASE_LEVEL=33084]="TEXTURE_BASE_LEVEL",s[s.TEXTURE_MAX_LEVEL=33085]="TEXTURE_MAX_LEVEL",s[s.TEXTURE_COMPARE_MODE=34892]="TEXTURE_COMPARE_MODE",s[s.TEXTURE_COMPARE_FUNC=34893]="TEXTURE_COMPARE_FUNC",s[s.SRGB=35904]="SRGB",s[s.SRGB8=35905]="SRGB8",s[s.SRGB8_ALPHA8=35907]="SRGB8_ALPHA8",s[s.COMPARE_REF_TO_TEXTURE=34894]="COMPARE_REF_TO_TEXTURE",s[s.RGBA32F=34836]="RGBA32F",s[s.RGB32F=34837]="RGB32F",s[s.RGBA16F=34842]="RGBA16F",s[s.RGB16F=34843]="RGB16F",s[s.TEXTURE_2D_ARRAY=35866]="TEXTURE_2D_ARRAY",s[s.TEXTURE_BINDING_2D_ARRAY=35869]="TEXTURE_BINDING_2D_ARRAY",s[s.R11F_G11F_B10F=35898]="R11F_G11F_B10F",s[s.RGB9_E5=35901]="RGB9_E5",s[s.RGBA32UI=36208]="RGBA32UI",s[s.RGB32UI=36209]="RGB32UI",s[s.RGBA16UI=36214]="RGBA16UI",s[s.RGB16UI=36215]="RGB16UI",s[s.RGBA8UI=36220]="RGBA8UI",s[s.RGB8UI=36221]="RGB8UI",s[s.RGBA32I=36226]="RGBA32I",s[s.RGB32I=36227]="RGB32I",s[s.RGBA16I=36232]="RGBA16I",s[s.RGB16I=36233]="RGB16I",s[s.RGBA8I=36238]="RGBA8I",s[s.RGB8I=36239]="RGB8I",s[s.RED_INTEGER=36244]="RED_INTEGER",s[s.RGB_INTEGER=36248]="RGB_INTEGER",s[s.RGBA_INTEGER=36249]="RGBA_INTEGER",s[s.R8=33321]="R8",s[s.RG8=33323]="RG8",s[s.R16F=33325]="R16F",s[s.R32F=33326]="R32F",s[s.RG16F=33327]="RG16F",s[s.RG32F=33328]="RG32F",s[s.R8I=33329]="R8I",s[s.R8UI=33330]="R8UI",s[s.R16I=33331]="R16I",s[s.R16UI=33332]="R16UI",s[s.R32I=33333]="R32I",s[s.R32UI=33334]="R32UI",s[s.RG8I=33335]="RG8I",s[s.RG8UI=33336]="RG8UI",s[s.RG16I=33337]="RG16I",s[s.RG16UI=33338]="RG16UI",s[s.RG32I=33339]="RG32I",s[s.RG32UI=33340]="RG32UI",s[s.R8_SNORM=36756]="R8_SNORM",s[s.RG8_SNORM=36757]="RG8_SNORM",s[s.RGB8_SNORM=36758]="RGB8_SNORM",s[s.RGBA8_SNORM=36759]="RGBA8_SNORM",s[s.RGB10_A2UI=36975]="RGB10_A2UI",s[s.TEXTURE_IMMUTABLE_FORMAT=37167]="TEXTURE_IMMUTABLE_FORMAT",s[s.TEXTURE_IMMUTABLE_LEVELS=33503]="TEXTURE_IMMUTABLE_LEVELS",s[s.UNSIGNED_INT_2_10_10_10_REV=33640]="UNSIGNED_INT_2_10_10_10_REV",s[s.UNSIGNED_INT_10F_11F_11F_REV=35899]="UNSIGNED_INT_10F_11F_11F_REV",s[s.UNSIGNED_INT_5_9_9_9_REV=35902]="UNSIGNED_INT_5_9_9_9_REV",s[s.FLOAT_32_UNSIGNED_INT_24_8_REV=36269]="FLOAT_32_UNSIGNED_INT_24_8_REV",s[s.UNSIGNED_INT_24_8=34042]="UNSIGNED_INT_24_8",s[s.HALF_FLOAT=5131]="HALF_FLOAT",s[s.RG=33319]="RG",s[s.RG_INTEGER=33320]="RG_INTEGER",s[s.INT_2_10_10_10_REV=36255]="INT_2_10_10_10_REV",s[s.CURRENT_QUERY=34917]="CURRENT_QUERY",s[s.QUERY_RESULT=34918]="QUERY_RESULT",s[s.QUERY_RESULT_AVAILABLE=34919]="QUERY_RESULT_AVAILABLE",s[s.ANY_SAMPLES_PASSED=35887]="ANY_SAMPLES_PASSED",s[s.ANY_SAMPLES_PASSED_CONSERVATIVE=36202]="ANY_SAMPLES_PASSED_CONSERVATIVE",s[s.MAX_DRAW_BUFFERS=34852]="MAX_DRAW_BUFFERS",s[s.DRAW_BUFFER0=34853]="DRAW_BUFFER0",s[s.DRAW_BUFFER1=34854]="DRAW_BUFFER1",s[s.DRAW_BUFFER2=34855]="DRAW_BUFFER2",s[s.DRAW_BUFFER3=34856]="DRAW_BUFFER3",s[s.DRAW_BUFFER4=34857]="DRAW_BUFFER4",s[s.DRAW_BUFFER5=34858]="DRAW_BUFFER5",s[s.DRAW_BUFFER6=34859]="DRAW_BUFFER6",s[s.DRAW_BUFFER7=34860]="DRAW_BUFFER7",s[s.DRAW_BUFFER8=34861]="DRAW_BUFFER8",s[s.DRAW_BUFFER9=34862]="DRAW_BUFFER9",s[s.DRAW_BUFFER10=34863]="DRAW_BUFFER10",s[s.DRAW_BUFFER11=34864]="DRAW_BUFFER11",s[s.DRAW_BUFFER12=34865]="DRAW_BUFFER12",s[s.DRAW_BUFFER13=34866]="DRAW_BUFFER13",s[s.DRAW_BUFFER14=34867]="DRAW_BUFFER14",s[s.DRAW_BUFFER15=34868]="DRAW_BUFFER15",s[s.MAX_COLOR_ATTACHMENTS=36063]="MAX_COLOR_ATTACHMENTS",s[s.COLOR_ATTACHMENT1=36065]="COLOR_ATTACHMENT1",s[s.COLOR_ATTACHMENT2=36066]="COLOR_ATTACHMENT2",s[s.COLOR_ATTACHMENT3=36067]="COLOR_ATTACHMENT3",s[s.COLOR_ATTACHMENT4=36068]="COLOR_ATTACHMENT4",s[s.COLOR_ATTACHMENT5=36069]="COLOR_ATTACHMENT5",s[s.COLOR_ATTACHMENT6=36070]="COLOR_ATTACHMENT6",s[s.COLOR_ATTACHMENT7=36071]="COLOR_ATTACHMENT7",s[s.COLOR_ATTACHMENT8=36072]="COLOR_ATTACHMENT8",s[s.COLOR_ATTACHMENT9=36073]="COLOR_ATTACHMENT9",s[s.COLOR_ATTACHMENT10=36074]="COLOR_ATTACHMENT10",s[s.COLOR_ATTACHMENT11=36075]="COLOR_ATTACHMENT11",s[s.COLOR_ATTACHMENT12=36076]="COLOR_ATTACHMENT12",s[s.COLOR_ATTACHMENT13=36077]="COLOR_ATTACHMENT13",s[s.COLOR_ATTACHMENT14=36078]="COLOR_ATTACHMENT14",s[s.COLOR_ATTACHMENT15=36079]="COLOR_ATTACHMENT15",s[s.SAMPLER_3D=35679]="SAMPLER_3D",s[s.SAMPLER_2D_SHADOW=35682]="SAMPLER_2D_SHADOW",s[s.SAMPLER_2D_ARRAY=36289]="SAMPLER_2D_ARRAY",s[s.SAMPLER_2D_ARRAY_SHADOW=36292]="SAMPLER_2D_ARRAY_SHADOW",s[s.SAMPLER_CUBE_SHADOW=36293]="SAMPLER_CUBE_SHADOW",s[s.INT_SAMPLER_2D=36298]="INT_SAMPLER_2D",s[s.INT_SAMPLER_3D=36299]="INT_SAMPLER_3D",s[s.INT_SAMPLER_CUBE=36300]="INT_SAMPLER_CUBE",s[s.INT_SAMPLER_2D_ARRAY=36303]="INT_SAMPLER_2D_ARRAY",s[s.UNSIGNED_INT_SAMPLER_2D=36306]="UNSIGNED_INT_SAMPLER_2D",s[s.UNSIGNED_INT_SAMPLER_3D=36307]="UNSIGNED_INT_SAMPLER_3D",s[s.UNSIGNED_INT_SAMPLER_CUBE=36308]="UNSIGNED_INT_SAMPLER_CUBE",s[s.UNSIGNED_INT_SAMPLER_2D_ARRAY=36311]="UNSIGNED_INT_SAMPLER_2D_ARRAY",s[s.MAX_SAMPLES=36183]="MAX_SAMPLES",s[s.SAMPLER_BINDING=35097]="SAMPLER_BINDING",s[s.PIXEL_PACK_BUFFER=35051]="PIXEL_PACK_BUFFER",s[s.PIXEL_UNPACK_BUFFER=35052]="PIXEL_UNPACK_BUFFER",s[s.PIXEL_PACK_BUFFER_BINDING=35053]="PIXEL_PACK_BUFFER_BINDING",s[s.PIXEL_UNPACK_BUFFER_BINDING=35055]="PIXEL_UNPACK_BUFFER_BINDING",s[s.COPY_READ_BUFFER=36662]="COPY_READ_BUFFER",s[s.COPY_WRITE_BUFFER=36663]="COPY_WRITE_BUFFER",s[s.COPY_READ_BUFFER_BINDING=36662]="COPY_READ_BUFFER_BINDING",s[s.COPY_WRITE_BUFFER_BINDING=36663]="COPY_WRITE_BUFFER_BINDING",s[s.FLOAT_MAT2x3=35685]="FLOAT_MAT2x3",s[s.FLOAT_MAT2x4=35686]="FLOAT_MAT2x4",s[s.FLOAT_MAT3x2=35687]="FLOAT_MAT3x2",s[s.FLOAT_MAT3x4=35688]="FLOAT_MAT3x4",s[s.FLOAT_MAT4x2=35689]="FLOAT_MAT4x2",s[s.FLOAT_MAT4x3=35690]="FLOAT_MAT4x3",s[s.UNSIGNED_INT_VEC2=36294]="UNSIGNED_INT_VEC2",s[s.UNSIGNED_INT_VEC3=36295]="UNSIGNED_INT_VEC3",s[s.UNSIGNED_INT_VEC4=36296]="UNSIGNED_INT_VEC4",s[s.UNSIGNED_NORMALIZED=35863]="UNSIGNED_NORMALIZED",s[s.SIGNED_NORMALIZED=36764]="SIGNED_NORMALIZED",s[s.VERTEX_ATTRIB_ARRAY_INTEGER=35069]="VERTEX_ATTRIB_ARRAY_INTEGER",s[s.VERTEX_ATTRIB_ARRAY_DIVISOR=35070]="VERTEX_ATTRIB_ARRAY_DIVISOR",s[s.TRANSFORM_FEEDBACK_BUFFER_MODE=35967]="TRANSFORM_FEEDBACK_BUFFER_MODE",s[s.MAX_TRANSFORM_FEEDBACK_SEPARATE_COMPONENTS=35968]="MAX_TRANSFORM_FEEDBACK_SEPARATE_COMPONENTS",s[s.TRANSFORM_FEEDBACK_VARYINGS=35971]="TRANSFORM_FEEDBACK_VARYINGS",s[s.TRANSFORM_FEEDBACK_BUFFER_START=35972]="TRANSFORM_FEEDBACK_BUFFER_START",s[s.TRANSFORM_FEEDBACK_BUFFER_SIZE=35973]="TRANSFORM_FEEDBACK_BUFFER_SIZE",s[s.TRANSFORM_FEEDBACK_PRIMITIVES_WRITTEN=35976]="TRANSFORM_FEEDBACK_PRIMITIVES_WRITTEN",s[s.MAX_TRANSFORM_FEEDBACK_INTERLEAVED_COMPONENTS=35978]="MAX_TRANSFORM_FEEDBACK_INTERLEAVED_COMPONENTS",s[s.MAX_TRANSFORM_FEEDBACK_SEPARATE_ATTRIBS=35979]="MAX_TRANSFORM_FEEDBACK_SEPARATE_ATTRIBS",s[s.INTERLEAVED_ATTRIBS=35980]="INTERLEAVED_ATTRIBS",s[s.SEPARATE_ATTRIBS=35981]="SEPARATE_ATTRIBS",s[s.TRANSFORM_FEEDBACK_BUFFER=35982]="TRANSFORM_FEEDBACK_BUFFER",s[s.TRANSFORM_FEEDBACK_BUFFER_BINDING=35983]="TRANSFORM_FEEDBACK_BUFFER_BINDING",s[s.TRANSFORM_FEEDBACK=36386]="TRANSFORM_FEEDBACK",s[s.TRANSFORM_FEEDBACK_PAUSED=36387]="TRANSFORM_FEEDBACK_PAUSED",s[s.TRANSFORM_FEEDBACK_ACTIVE=36388]="TRANSFORM_FEEDBACK_ACTIVE",s[s.TRANSFORM_FEEDBACK_BINDING=36389]="TRANSFORM_FEEDBACK_BINDING",s[s.FRAMEBUFFER_ATTACHMENT_COLOR_ENCODING=33296]="FRAMEBUFFER_ATTACHMENT_COLOR_ENCODING",s[s.FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE=33297]="FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE",s[s.FRAMEBUFFER_ATTACHMENT_RED_SIZE=33298]="FRAMEBUFFER_ATTACHMENT_RED_SIZE",s[s.FRAMEBUFFER_ATTACHMENT_GREEN_SIZE=33299]="FRAMEBUFFER_ATTACHMENT_GREEN_SIZE",s[s.FRAMEBUFFER_ATTACHMENT_BLUE_SIZE=33300]="FRAMEBUFFER_ATTACHMENT_BLUE_SIZE",s[s.FRAMEBUFFER_ATTACHMENT_ALPHA_SIZE=33301]="FRAMEBUFFER_ATTACHMENT_ALPHA_SIZE",s[s.FRAMEBUFFER_ATTACHMENT_DEPTH_SIZE=33302]="FRAMEBUFFER_ATTACHMENT_DEPTH_SIZE",s[s.FRAMEBUFFER_ATTACHMENT_STENCIL_SIZE=33303]="FRAMEBUFFER_ATTACHMENT_STENCIL_SIZE",s[s.FRAMEBUFFER_DEFAULT=33304]="FRAMEBUFFER_DEFAULT",s[s.DEPTH24_STENCIL8=35056]="DEPTH24_STENCIL8",s[s.DRAW_FRAMEBUFFER_BINDING=36006]="DRAW_FRAMEBUFFER_BINDING",s[s.READ_FRAMEBUFFER_BINDING=36010]="READ_FRAMEBUFFER_BINDING",s[s.RENDERBUFFER_SAMPLES=36011]="RENDERBUFFER_SAMPLES",s[s.FRAMEBUFFER_ATTACHMENT_TEXTURE_LAYER=36052]="FRAMEBUFFER_ATTACHMENT_TEXTURE_LAYER",s[s.FRAMEBUFFER_INCOMPLETE_MULTISAMPLE=36182]="FRAMEBUFFER_INCOMPLETE_MULTISAMPLE",s[s.UNIFORM_BUFFER=35345]="UNIFORM_BUFFER",s[s.UNIFORM_BUFFER_BINDING=35368]="UNIFORM_BUFFER_BINDING",s[s.UNIFORM_BUFFER_START=35369]="UNIFORM_BUFFER_START",s[s.UNIFORM_BUFFER_SIZE=35370]="UNIFORM_BUFFER_SIZE",s[s.MAX_VERTEX_UNIFORM_BLOCKS=35371]="MAX_VERTEX_UNIFORM_BLOCKS",s[s.MAX_FRAGMENT_UNIFORM_BLOCKS=35373]="MAX_FRAGMENT_UNIFORM_BLOCKS",s[s.MAX_COMBINED_UNIFORM_BLOCKS=35374]="MAX_COMBINED_UNIFORM_BLOCKS",s[s.MAX_UNIFORM_BUFFER_BINDINGS=35375]="MAX_UNIFORM_BUFFER_BINDINGS",s[s.MAX_UNIFORM_BLOCK_SIZE=35376]="MAX_UNIFORM_BLOCK_SIZE",s[s.MAX_COMBINED_VERTEX_UNIFORM_COMPONENTS=35377]="MAX_COMBINED_VERTEX_UNIFORM_COMPONENTS",s[s.MAX_COMBINED_FRAGMENT_UNIFORM_COMPONENTS=35379]="MAX_COMBINED_FRAGMENT_UNIFORM_COMPONENTS",s[s.UNIFORM_BUFFER_OFFSET_ALIGNMENT=35380]="UNIFORM_BUFFER_OFFSET_ALIGNMENT",s[s.ACTIVE_UNIFORM_BLOCKS=35382]="ACTIVE_UNIFORM_BLOCKS",s[s.UNIFORM_TYPE=35383]="UNIFORM_TYPE",s[s.UNIFORM_SIZE=35384]="UNIFORM_SIZE",s[s.UNIFORM_BLOCK_INDEX=35386]="UNIFORM_BLOCK_INDEX",s[s.UNIFORM_OFFSET=35387]="UNIFORM_OFFSET",s[s.UNIFORM_ARRAY_STRIDE=35388]="UNIFORM_ARRAY_STRIDE",s[s.UNIFORM_MATRIX_STRIDE=35389]="UNIFORM_MATRIX_STRIDE",s[s.UNIFORM_IS_ROW_MAJOR=35390]="UNIFORM_IS_ROW_MAJOR",s[s.UNIFORM_BLOCK_BINDING=35391]="UNIFORM_BLOCK_BINDING",s[s.UNIFORM_BLOCK_DATA_SIZE=35392]="UNIFORM_BLOCK_DATA_SIZE",s[s.UNIFORM_BLOCK_ACTIVE_UNIFORMS=35394]="UNIFORM_BLOCK_ACTIVE_UNIFORMS",s[s.UNIFORM_BLOCK_ACTIVE_UNIFORM_INDICES=35395]="UNIFORM_BLOCK_ACTIVE_UNIFORM_INDICES",s[s.UNIFORM_BLOCK_REFERENCED_BY_VERTEX_SHADER=35396]="UNIFORM_BLOCK_REFERENCED_BY_VERTEX_SHADER",s[s.UNIFORM_BLOCK_REFERENCED_BY_FRAGMENT_SHADER=35398]="UNIFORM_BLOCK_REFERENCED_BY_FRAGMENT_SHADER",s[s.OBJECT_TYPE=37138]="OBJECT_TYPE",s[s.SYNC_CONDITION=37139]="SYNC_CONDITION",s[s.SYNC_STATUS=37140]="SYNC_STATUS",s[s.SYNC_FLAGS=37141]="SYNC_FLAGS",s[s.SYNC_FENCE=37142]="SYNC_FENCE",s[s.SYNC_GPU_COMMANDS_COMPLETE=37143]="SYNC_GPU_COMMANDS_COMPLETE",s[s.UNSIGNALED=37144]="UNSIGNALED",s[s.SIGNALED=37145]="SIGNALED",s[s.ALREADY_SIGNALED=37146]="ALREADY_SIGNALED",s[s.TIMEOUT_EXPIRED=37147]="TIMEOUT_EXPIRED",s[s.CONDITION_SATISFIED=37148]="CONDITION_SATISFIED",s[s.WAIT_FAILED=37149]="WAIT_FAILED",s[s.SYNC_FLUSH_COMMANDS_BIT=1]="SYNC_FLUSH_COMMANDS_BIT",s[s.COLOR=6144]="COLOR",s[s.DEPTH=6145]="DEPTH",s[s.STENCIL=6146]="STENCIL",s[s.MIN=32775]="MIN",s[s.MAX=32776]="MAX",s[s.DEPTH_COMPONENT24=33190]="DEPTH_COMPONENT24",s[s.STREAM_READ=35041]="STREAM_READ",s[s.STREAM_COPY=35042]="STREAM_COPY",s[s.STATIC_READ=35045]="STATIC_READ",s[s.STATIC_COPY=35046]="STATIC_COPY",s[s.DYNAMIC_READ=35049]="DYNAMIC_READ",s[s.DYNAMIC_COPY=35050]="DYNAMIC_COPY",s[s.DEPTH_COMPONENT32F=36012]="DEPTH_COMPONENT32F",s[s.DEPTH32F_STENCIL8=36013]="DEPTH32F_STENCIL8",s[s.INVALID_INDEX=4294967295]="INVALID_INDEX",s[s.TIMEOUT_IGNORED=-1]="TIMEOUT_IGNORED",s[s.MAX_CLIENT_WAIT_TIMEOUT_WEBGL=37447]="MAX_CLIENT_WAIT_TIMEOUT_WEBGL",s[s.UNMASKED_VENDOR_WEBGL=37445]="UNMASKED_VENDOR_WEBGL",s[s.UNMASKED_RENDERER_WEBGL=37446]="UNMASKED_RENDERER_WEBGL",s[s.MAX_TEXTURE_MAX_ANISOTROPY_EXT=34047]="MAX_TEXTURE_MAX_ANISOTROPY_EXT",s[s.TEXTURE_MAX_ANISOTROPY_EXT=34046]="TEXTURE_MAX_ANISOTROPY_EXT",s[s.R16_EXT=33322]="R16_EXT",s[s.RG16_EXT=33324]="RG16_EXT",s[s.RGB16_EXT=32852]="RGB16_EXT",s[s.RGBA16_EXT=32859]="RGBA16_EXT",s[s.R16_SNORM_EXT=36760]="R16_SNORM_EXT",s[s.RG16_SNORM_EXT=36761]="RG16_SNORM_EXT",s[s.RGB16_SNORM_EXT=36762]="RGB16_SNORM_EXT",s[s.RGBA16_SNORM_EXT=36763]="RGBA16_SNORM_EXT",s[s.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",s[s.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777]="COMPRESSED_RGBA_S3TC_DXT1_EXT",s[s.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778]="COMPRESSED_RGBA_S3TC_DXT3_EXT",s[s.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",s[s.COMPRESSED_SRGB_S3TC_DXT1_EXT=35916]="COMPRESSED_SRGB_S3TC_DXT1_EXT",s[s.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917]="COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT",s[s.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918]="COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT",s[s.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919]="COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT",s[s.COMPRESSED_RED_RGTC1_EXT=36283]="COMPRESSED_RED_RGTC1_EXT",s[s.COMPRESSED_SIGNED_RED_RGTC1_EXT=36284]="COMPRESSED_SIGNED_RED_RGTC1_EXT",s[s.COMPRESSED_RED_GREEN_RGTC2_EXT=36285]="COMPRESSED_RED_GREEN_RGTC2_EXT",s[s.COMPRESSED_SIGNED_RED_GREEN_RGTC2_EXT=36286]="COMPRESSED_SIGNED_RED_GREEN_RGTC2_EXT",s[s.COMPRESSED_RGBA_BPTC_UNORM_EXT=36492]="COMPRESSED_RGBA_BPTC_UNORM_EXT",s[s.COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT=36493]="COMPRESSED_SRGB_ALPHA_BPTC_UNORM_EXT",s[s.COMPRESSED_RGB_BPTC_SIGNED_FLOAT_EXT=36494]="COMPRESSED_RGB_BPTC_SIGNED_FLOAT_EXT",s[s.COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT_EXT=36495]="COMPRESSED_RGB_BPTC_UNSIGNED_FLOAT_EXT",s[s.COMPRESSED_R11_EAC=37488]="COMPRESSED_R11_EAC",s[s.COMPRESSED_SIGNED_R11_EAC=37489]="COMPRESSED_SIGNED_R11_EAC",s[s.COMPRESSED_RG11_EAC=37490]="COMPRESSED_RG11_EAC",s[s.COMPRESSED_SIGNED_RG11_EAC=37491]="COMPRESSED_SIGNED_RG11_EAC",s[s.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",s[s.COMPRESSED_RGBA8_ETC2_EAC=37493]="COMPRESSED_RGBA8_ETC2_EAC",s[s.COMPRESSED_SRGB8_ETC2=37494]="COMPRESSED_SRGB8_ETC2",s[s.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37495]="COMPRESSED_SRGB8_ALPHA8_ETC2_EAC",s[s.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37496]="COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2",s[s.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37497]="COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",s[s.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",s[s.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",s[s.COMPRESSED_RGB_PVRTC_2BPPV1_IMG=35841]="COMPRESSED_RGB_PVRTC_2BPPV1_IMG",s[s.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG=35843]="COMPRESSED_RGBA_PVRTC_2BPPV1_IMG",s[s.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",s[s.COMPRESSED_RGB_ATC_WEBGL=35986]="COMPRESSED_RGB_ATC_WEBGL",s[s.COMPRESSED_RGBA_ATC_EXPLICIT_ALPHA_WEBGL=35986]="COMPRESSED_RGBA_ATC_EXPLICIT_ALPHA_WEBGL",s[s.COMPRESSED_RGBA_ATC_INTERPOLATED_ALPHA_WEBGL=34798]="COMPRESSED_RGBA_ATC_INTERPOLATED_ALPHA_WEBGL",s[s.COMPRESSED_RGBA_ASTC_4x4_KHR=37808]="COMPRESSED_RGBA_ASTC_4x4_KHR",s[s.COMPRESSED_RGBA_ASTC_5x4_KHR=37809]="COMPRESSED_RGBA_ASTC_5x4_KHR",s[s.COMPRESSED_RGBA_ASTC_5x5_KHR=37810]="COMPRESSED_RGBA_ASTC_5x5_KHR",s[s.COMPRESSED_RGBA_ASTC_6x5_KHR=37811]="COMPRESSED_RGBA_ASTC_6x5_KHR",s[s.COMPRESSED_RGBA_ASTC_6x6_KHR=37812]="COMPRESSED_RGBA_ASTC_6x6_KHR",s[s.COMPRESSED_RGBA_ASTC_8x5_KHR=37813]="COMPRESSED_RGBA_ASTC_8x5_KHR",s[s.COMPRESSED_RGBA_ASTC_8x6_KHR=37814]="COMPRESSED_RGBA_ASTC_8x6_KHR",s[s.COMPRESSED_RGBA_ASTC_8x8_KHR=37815]="COMPRESSED_RGBA_ASTC_8x8_KHR",s[s.COMPRESSED_RGBA_ASTC_10x5_KHR=37816]="COMPRESSED_RGBA_ASTC_10x5_KHR",s[s.COMPRESSED_RGBA_ASTC_10x6_KHR=37817]="COMPRESSED_RGBA_ASTC_10x6_KHR",s[s.COMPRESSED_RGBA_ASTC_10x8_KHR=37818]="COMPRESSED_RGBA_ASTC_10x8_KHR",s[s.COMPRESSED_RGBA_ASTC_10x10_KHR=37819]="COMPRESSED_RGBA_ASTC_10x10_KHR",s[s.COMPRESSED_RGBA_ASTC_12x10_KHR=37820]="COMPRESSED_RGBA_ASTC_12x10_KHR",s[s.COMPRESSED_RGBA_ASTC_12x12_KHR=37821]="COMPRESSED_RGBA_ASTC_12x12_KHR",s[s.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840]="COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR",s[s.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR=37841]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR",s[s.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR=37842]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR",s[s.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR=37843]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR",s[s.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR=37844]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR",s[s.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR=37845]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR",s[s.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR=37846]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR",s[s.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR=37847]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR",s[s.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR=37848]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR",s[s.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR=37849]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR",s[s.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR=37850]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR",s[s.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR=37851]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR",s[s.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR=37852]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR",s[s.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR=37853]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR",s[s.QUERY_COUNTER_BITS_EXT=34916]="QUERY_COUNTER_BITS_EXT",s[s.CURRENT_QUERY_EXT=34917]="CURRENT_QUERY_EXT",s[s.QUERY_RESULT_EXT=34918]="QUERY_RESULT_EXT",s[s.QUERY_RESULT_AVAILABLE_EXT=34919]="QUERY_RESULT_AVAILABLE_EXT",s[s.TIME_ELAPSED_EXT=35007]="TIME_ELAPSED_EXT",s[s.TIMESTAMP_EXT=36392]="TIMESTAMP_EXT",s[s.GPU_DISJOINT_EXT=36795]="GPU_DISJOINT_EXT",s[s.COMPLETION_STATUS_KHR=37297]="COMPLETION_STATUS_KHR",s[s.DEPTH_CLAMP_EXT=34383]="DEPTH_CLAMP_EXT",s[s.FIRST_VERTEX_CONVENTION_WEBGL=36429]="FIRST_VERTEX_CONVENTION_WEBGL",s[s.LAST_VERTEX_CONVENTION_WEBGL=36430]="LAST_VERTEX_CONVENTION_WEBGL",s[s.PROVOKING_VERTEX_WEBL=36431]="PROVOKING_VERTEX_WEBL",s[s.POLYGON_MODE_WEBGL=2880]="POLYGON_MODE_WEBGL",s[s.POLYGON_OFFSET_LINE_WEBGL=10754]="POLYGON_OFFSET_LINE_WEBGL",s[s.LINE_WEBGL=6913]="LINE_WEBGL",s[s.FILL_WEBGL=6914]="FILL_WEBGL",s[s.MAX_CLIP_DISTANCES_WEBGL=3378]="MAX_CLIP_DISTANCES_WEBGL",s[s.MAX_CULL_DISTANCES_WEBGL=33529]="MAX_CULL_DISTANCES_WEBGL",s[s.MAX_COMBINED_CLIP_AND_CULL_DISTANCES_WEBGL=33530]="MAX_COMBINED_CLIP_AND_CULL_DISTANCES_WEBGL",s[s.CLIP_DISTANCE0_WEBGL=12288]="CLIP_DISTANCE0_WEBGL",s[s.CLIP_DISTANCE1_WEBGL=12289]="CLIP_DISTANCE1_WEBGL",s[s.CLIP_DISTANCE2_WEBGL=12290]="CLIP_DISTANCE2_WEBGL",s[s.CLIP_DISTANCE3_WEBGL=12291]="CLIP_DISTANCE3_WEBGL",s[s.CLIP_DISTANCE4_WEBGL=12292]="CLIP_DISTANCE4_WEBGL",s[s.CLIP_DISTANCE5_WEBGL=12293]="CLIP_DISTANCE5_WEBGL",s[s.CLIP_DISTANCE6_WEBGL=12294]="CLIP_DISTANCE6_WEBGL",s[s.CLIP_DISTANCE7_WEBGL=12295]="CLIP_DISTANCE7_WEBGL",s[s.POLYGON_OFFSET_CLAMP_EXT=36379]="POLYGON_OFFSET_CLAMP_EXT",s[s.LOWER_LEFT_EXT=36001]="LOWER_LEFT_EXT",s[s.UPPER_LEFT_EXT=36002]="UPPER_LEFT_EXT",s[s.NEGATIVE_ONE_TO_ONE_EXT=37726]="NEGATIVE_ONE_TO_ONE_EXT",s[s.ZERO_TO_ONE_EXT=37727]="ZERO_TO_ONE_EXT",s[s.CLIP_ORIGIN_EXT=37724]="CLIP_ORIGIN_EXT",s[s.CLIP_DEPTH_MODE_EXT=37725]="CLIP_DEPTH_MODE_EXT",s[s.SRC1_COLOR_WEBGL=35065]="SRC1_COLOR_WEBGL",s[s.SRC1_ALPHA_WEBGL=34185]="SRC1_ALPHA_WEBGL",s[s.ONE_MINUS_SRC1_COLOR_WEBGL=35066]="ONE_MINUS_SRC1_COLOR_WEBGL",s[s.ONE_MINUS_SRC1_ALPHA_WEBGL=35067]="ONE_MINUS_SRC1_ALPHA_WEBGL",s[s.MAX_DUAL_SOURCE_DRAW_BUFFERS_WEBGL=35068]="MAX_DUAL_SOURCE_DRAW_BUFFERS_WEBGL",s[s.MIRROR_CLAMP_TO_EDGE_EXT=34627]="MIRROR_CLAMP_TO_EDGE_EXT"})(At||(At={}));const si={3042:!1,32773:new Float32Array([0,0,0,0]),32777:32774,34877:32774,32969:1,32968:0,32971:1,32970:0,3106:new Float32Array([0,0,0,0]),3107:[!0,!0,!0,!0],2884:!1,2885:1029,2929:!1,2931:1,2932:513,2928:new Float32Array([0,1]),2930:!0,3024:!0,35725:null,36006:null,36007:null,34229:null,34964:null,2886:2305,33170:4352,2849:1,32823:!1,32824:0,10752:0,32926:!1,32928:!1,32938:1,32939:!1,3089:!1,3088:new Int32Array([0,0,1024,1024]),2960:!1,2961:0,2968:4294967295,36005:4294967295,2962:519,2967:0,2963:4294967295,34816:519,36003:0,36004:4294967295,2964:7680,2965:7680,2966:7680,34817:7680,34818:7680,34819:7680,2978:[0,0,1024,1024],36389:null,36662:null,36663:null,35053:null,35055:null,35723:4352,36010:null,35977:!1,3333:4,3317:4,37440:!1,37441:!1,37443:37444,3330:0,3332:0,3331:0,3314:0,32878:0,3316:0,3315:0,32877:0},ee=(s,e,t)=>e?s.enable(t):s.disable(t),Bo=(s,e,t)=>s.hint(t,e),de=(s,e,t)=>s.pixelStorei(t,e),Uo=(s,e,t)=>{const n=t===36006?36009:36008;return s.bindFramebuffer(n,e)},Wt=(s,e,t)=>{const r={34964:34962,36662:36662,36663:36663,35053:35051,35055:35052}[t];s.bindBuffer(r,e)};function Vn(s){return Array.isArray(s)||ArrayBuffer.isView(s)&&!(s instanceof DataView)}const kb={3042:ee,32773:(s,e)=>s.blendColor(...e),32777:"blendEquation",34877:"blendEquation",32969:"blendFunc",32968:"blendFunc",32971:"blendFunc",32970:"blendFunc",3106:(s,e)=>s.clearColor(...e),3107:(s,e)=>s.colorMask(...e),2884:ee,2885:(s,e)=>s.cullFace(e),2929:ee,2931:(s,e)=>s.clearDepth(e),2932:(s,e)=>s.depthFunc(e),2928:(s,e)=>s.depthRange(...e),2930:(s,e)=>s.depthMask(e),3024:ee,35723:Bo,35725:(s,e)=>s.useProgram(e),36007:(s,e)=>s.bindRenderbuffer(36161,e),36389:(s,e)=>s.bindTransformFeedback?.(36386,e),34229:(s,e)=>s.bindVertexArray(e),36006:Uo,36010:Uo,34964:Wt,36662:Wt,36663:Wt,35053:Wt,35055:Wt,2886:(s,e)=>s.frontFace(e),33170:Bo,2849:(s,e)=>s.lineWidth(e),32823:ee,32824:"polygonOffset",10752:"polygonOffset",35977:ee,32926:ee,32928:ee,32938:"sampleCoverage",32939:"sampleCoverage",3089:ee,3088:(s,e)=>s.scissor(...e),2960:ee,2961:(s,e)=>s.clearStencil(e),2968:(s,e)=>s.stencilMaskSeparate(1028,e),36005:(s,e)=>s.stencilMaskSeparate(1029,e),2962:"stencilFuncFront",2967:"stencilFuncFront",2963:"stencilFuncFront",34816:"stencilFuncBack",36003:"stencilFuncBack",36004:"stencilFuncBack",2964:"stencilOpFront",2965:"stencilOpFront",2966:"stencilOpFront",34817:"stencilOpBack",34818:"stencilOpBack",34819:"stencilOpBack",2978:(s,e)=>s.viewport(...e),34383:ee,10754:ee,12288:ee,12289:ee,12290:ee,12291:ee,12292:ee,12293:ee,12294:ee,12295:ee,3333:de,3317:de,37440:de,37441:de,37443:de,3330:de,3332:de,3331:de,3314:de,32878:de,3316:de,3315:de,32877:de,framebuffer:(s,e)=>{const t=e&&"handle"in e?e.handle:e;return s.bindFramebuffer(36160,t)},blend:(s,e)=>e?s.enable(3042):s.disable(3042),blendColor:(s,e)=>s.blendColor(...e),blendEquation:(s,e)=>{const t=typeof e=="number"?[e,e]:e;s.blendEquationSeparate(...t)},blendFunc:(s,e)=>{const t=e?.length===2?[...e,...e]:e;s.blendFuncSeparate(...t)},clearColor:(s,e)=>s.clearColor(...e),clearDepth:(s,e)=>s.clearDepth(e),clearStencil:(s,e)=>s.clearStencil(e),colorMask:(s,e)=>s.colorMask(...e),cull:(s,e)=>e?s.enable(2884):s.disable(2884),cullFace:(s,e)=>s.cullFace(e),depthTest:(s,e)=>e?s.enable(2929):s.disable(2929),depthFunc:(s,e)=>s.depthFunc(e),depthMask:(s,e)=>s.depthMask(e),depthRange:(s,e)=>s.depthRange(...e),dither:(s,e)=>e?s.enable(3024):s.disable(3024),derivativeHint:(s,e)=>{s.hint(35723,e)},frontFace:(s,e)=>s.frontFace(e),mipmapHint:(s,e)=>s.hint(33170,e),lineWidth:(s,e)=>s.lineWidth(e),polygonOffsetFill:(s,e)=>e?s.enable(32823):s.disable(32823),polygonOffset:(s,e)=>s.polygonOffset(...e),sampleCoverage:(s,e)=>s.sampleCoverage(e[0],e[1]||!1),scissorTest:(s,e)=>e?s.enable(3089):s.disable(3089),scissor:(s,e)=>s.scissor(...e),stencilTest:(s,e)=>e?s.enable(2960):s.disable(2960),stencilMask:(s,e)=>{e=Vn(e)?e:[e,e];const[t,n]=e;s.stencilMaskSeparate(1028,t),s.stencilMaskSeparate(1029,n)},stencilFunc:(s,e)=>{e=Vn(e)&&e.length===3?[...e,...e]:e;const[t,n,r,i,o,a]=e;s.stencilFuncSeparate(1028,t,n,r),s.stencilFuncSeparate(1029,i,o,a)},stencilOp:(s,e)=>{e=Vn(e)&&e.length===3?[...e,...e]:e;const[t,n,r,i,o,a]=e;s.stencilOpSeparate(1028,t,n,r),s.stencilOpSeparate(1029,i,o,a)},viewport:(s,e)=>s.viewport(...e)};function J(s,e,t){return e[s]!==void 0?e[s]:t[s]}const Nb={blendEquation:(s,e,t)=>s.blendEquationSeparate(J(32777,e,t),J(34877,e,t)),blendFunc:(s,e,t)=>s.blendFuncSeparate(J(32969,e,t),J(32968,e,t),J(32971,e,t),J(32970,e,t)),polygonOffset:(s,e,t)=>s.polygonOffset(J(32824,e,t),J(10752,e,t)),sampleCoverage:(s,e,t)=>s.sampleCoverage(J(32938,e,t),J(32939,e,t)),stencilFuncFront:(s,e,t)=>s.stencilFuncSeparate(1028,J(2962,e,t),J(2967,e,t),J(2963,e,t)),stencilFuncBack:(s,e,t)=>s.stencilFuncSeparate(1029,J(34816,e,t),J(36003,e,t),J(36004,e,t)),stencilOpFront:(s,e,t)=>s.stencilOpSeparate(1028,J(2964,e,t),J(2965,e,t),J(2966,e,t)),stencilOpBack:(s,e,t)=>s.stencilOpSeparate(1029,J(34817,e,t),J(34818,e,t),J(34819,e,t))},Lo={enable:(s,e)=>s({[e]:!0}),disable:(s,e)=>s({[e]:!1}),pixelStorei:(s,e,t)=>s({[e]:t}),hint:(s,e,t)=>s({[e]:t}),useProgram:(s,e)=>s({35725:e}),bindRenderbuffer:(s,e,t)=>s({36007:t}),bindTransformFeedback:(s,e,t)=>s({36389:t}),bindVertexArray:(s,e)=>s({34229:e}),bindFramebuffer:(s,e,t)=>{switch(e){case 36160:return s({36006:t,36010:t});case 36009:return s({36006:t});case 36008:return s({36010:t});default:return null}},bindBuffer:(s,e,t)=>{const n={34962:[34964],36662:[36662],36663:[36663],35051:[35053],35052:[35055]}[e];return n?s({[n]:t}):{valueChanged:!0}},blendColor:(s,e,t,n,r)=>s({32773:new Float32Array([e,t,n,r])}),blendEquation:(s,e)=>s({32777:e,34877:e}),blendEquationSeparate:(s,e,t)=>s({32777:e,34877:t}),blendFunc:(s,e,t)=>s({32969:e,32968:t,32971:e,32970:t}),blendFuncSeparate:(s,e,t,n,r)=>s({32969:e,32968:t,32971:n,32970:r}),clearColor:(s,e,t,n,r)=>s({3106:new Float32Array([e,t,n,r])}),clearDepth:(s,e)=>s({2931:e}),clearStencil:(s,e)=>s({2961:e}),colorMask:(s,e,t,n,r)=>s({3107:[e,t,n,r]}),cullFace:(s,e)=>s({2885:e}),depthFunc:(s,e)=>s({2932:e}),depthRange:(s,e,t)=>s({2928:new Float32Array([e,t])}),depthMask:(s,e)=>s({2930:e}),frontFace:(s,e)=>s({2886:e}),lineWidth:(s,e)=>s({2849:e}),polygonOffset:(s,e,t)=>s({32824:e,10752:t}),sampleCoverage:(s,e,t)=>s({32938:e,32939:t}),scissor:(s,e,t,n,r)=>s({3088:new Int32Array([e,t,n,r])}),stencilMask:(s,e)=>s({2968:e,36005:e}),stencilMaskSeparate:(s,e,t)=>s({[e===1028?2968:36005]:t}),stencilFunc:(s,e,t,n)=>s({2962:e,2967:t,2963:n,34816:e,36003:t,36004:n}),stencilFuncSeparate:(s,e,t,n,r)=>s({[e===1028?2962:34816]:t,[e===1028?2967:36003]:n,[e===1028?2963:36004]:r}),stencilOp:(s,e,t,n)=>s({2964:e,2965:t,2966:n,34817:e,34818:t,34819:n}),stencilOpSeparate:(s,e,t,n,r)=>s({[e===1028?2964:34817]:t,[e===1028?2965:34818]:n,[e===1028?2966:34819]:r}),viewport:(s,e,t,n,r)=>s({2978:[e,t,n,r]})},Pe=(s,e)=>s.isEnabled(e),Vo={3042:Pe,2884:Pe,2929:Pe,3024:Pe,32823:Pe,32926:Pe,32928:Pe,3089:Pe,2960:Pe,35977:Pe},Db=new Set([34016,36388,36387,35983,35368,34965,35739,35738,3074,34853,34854,34855,34856,34857,34858,34859,34860,34861,34862,34863,34864,34865,34866,34867,34868,35097,32873,35869,32874,34068]);function Lt(s,e){if(Bb(e))return;const t={};for(const r in e){const i=Number(r),o=kb[r];o&&(typeof o=="string"?t[o]=!0:o(s,e[r],i))}const n=s.state&&s.state.cache;if(n)for(const r in t){const i=Nb[r];i(s,e,n)}}function rl(s,e=si){if(typeof e=="number"){const r=e,i=Vo[r];return i?i(s,r):s.getParameter(r)}const t=Array.isArray(e)?e:Object.keys(e),n={};for(const r of t){const i=Vo[r];n[r]=i?i(s,Number(r)):s.getParameter(Number(r))}return n}function Fb(s){Lt(s,si)}function Bb(s){for(const e in s)return!1;return!0}function Ub(s,e){if(s===e)return!0;const t=Array.isArray(s)||ArrayBuffer.isView(s),n=Array.isArray(e)||ArrayBuffer.isView(e);if(t&&n&&s.length===e.length){for(let r=0;r<s.length;++r)if(s[r]!==e[r])return!1;return!0}return!1}class ot{static get(e){return e.state}gl;program=null;stateStack=[];enable=!0;cache=null;log;initialized=!1;constructor(e,t){this.gl=e,this.log=t?.log||(()=>{}),this._updateCache=this._updateCache.bind(this),Object.seal(this)}push(e={}){this.stateStack.push({})}pop(){const e=this.stateStack[this.stateStack.length-1];Lt(this.gl,e),this.stateStack.pop()}trackState(e,t){if(this.cache=t.copyState?rl(e):Object.assign({},si),this.initialized)throw new Error("WebGLStateTracker");this.initialized=!0,this.gl.state=this,Vb(e);for(const n in Lo){const r=Lo[n];Lb(e,n,r)}$o(e,"getParameter"),$o(e,"isEnabled")}_updateCache(e){let t=!1,n;const r=this.stateStack.length>0?this.stateStack[this.stateStack.length-1]:null;for(const i in e){const o=e[i],a=this.cache[i];Ub(o,a)||(t=!0,n=a,r&&!(i in r)&&(r[i]=a),this.cache[i]=o)}return{valueChanged:t,oldValue:n}}}function $o(s,e){const t=s[e].bind(s);s[e]=function(r){if(r===void 0||Db.has(r))return t(r);const i=ot.get(s);return r in i.cache||(i.cache[r]=t(r)),i.enable?i.cache[r]:t(r)},Object.defineProperty(s[e],"name",{value:`${e}-from-cache`,configurable:!1})}function Lb(s,e,t){if(!s[e])return;const n=s[e].bind(s);s[e]=function(...i){const o=ot.get(s),{valueChanged:a,oldValue:c}=t(o._updateCache,...i);return a&&n(...i),c},Object.defineProperty(s[e],"name",{value:`${e}-to-cache`,configurable:!1})}function Vb(s){const e=s.useProgram.bind(s);s.useProgram=function(n){const r=ot.get(s);r.program!==n&&(e(n),r.program=n)}}function $b(s,e,t){let n="";const r={preserveDrawingBuffer:!0,...t};let i=null;if(i||=s.getContext("webgl2",r),r.failIfMajorPerformanceCaveat&&(n||="Only software GPU is available. Set `failIfMajorPerformanceCaveat: false` to allow."),!i&&!t.failIfMajorPerformanceCaveat&&(r.failIfMajorPerformanceCaveat=!1,i=s.getContext("webgl2",r),i.luma||={},i.luma.softwareRenderer=!0),i||(i=s.getContext("webgl",{}),i&&(i=null,n||="Your browser only supports WebGL1")),!i)throw n||="Your browser does not support WebGL",new Error(`Failed to create WebGL context: ${n}`);const{onContextLost:o,onContextRestored:a}=e;return s.addEventListener("webglcontextlost",c=>o(c),!1),s.addEventListener("webglcontextrestored",c=>a(c),!1),i.luma||={},i}function Ut(s,e,t){return t[e]===void 0&&(t[e]=s.getExtension(e)||null),t[e]}function Wb(s,e){const t=s.getParameter(7936),n=s.getParameter(7937);Ut(s,"WEBGL_debug_renderer_info",e);const r=e.WEBGL_debug_renderer_info,i=s.getParameter(r?r.UNMASKED_VENDOR_WEBGL:7936),o=s.getParameter(r?r.UNMASKED_RENDERER_WEBGL:7937),a=i||t,c=o||n,l=s.getParameter(7938),u=il(a,c),h=jb(a,c),f=Hb(a,c);return{type:"webgl",gpu:u,gpuType:f,gpuBackend:h,vendor:a,renderer:c,version:l,shadingLanguage:"glsl",shadingLanguageVersion:300}}function il(s,e){return/NVIDIA/i.exec(s)||/NVIDIA/i.exec(e)?"nvidia":/INTEL/i.exec(s)||/INTEL/i.exec(e)?"intel":/Apple/i.exec(s)||/Apple/i.exec(e)?"apple":/AMD/i.exec(s)||/AMD/i.exec(e)||/ATI/i.exec(s)||/ATI/i.exec(e)?"amd":/SwiftShader/i.exec(s)||/SwiftShader/i.exec(e)?"software":"unknown"}function jb(s,e){return/Metal/i.exec(s)||/Metal/i.exec(e)?"metal":/ANGLE/i.exec(s)||/ANGLE/i.exec(e)?"opengl":"unknown"}function Hb(s,e){if(/SwiftShader/i.exec(s)||/SwiftShader/i.exec(e))return"cpu";switch(il(s,e)){case"intel":return"integrated";case"software":return"cpu";case"unknown":return"unknown";default:return"discrete"}}function ol(s){switch(s){case"uint8":return 5121;case"sint8":return 5120;case"unorm8":return 5121;case"snorm8":return 5120;case"uint16":return 5123;case"sint16":return 5122;case"unorm16":return 5123;case"snorm16":return 5122;case"uint32":return 5125;case"sint32":return 5124;case"float16":return 5131;case"float32":return 5126}throw new Error(String(s))}const Yt="WEBGL_compressed_texture_s3tc",qt="WEBGL_compressed_texture_s3tc_srgb",xt="EXT_texture_compression_rgtc",Et="EXT_texture_compression_bptc",zb="WEBGL_compressed_texture_etc",Xb="WEBGL_compressed_texture_astc",Yb="WEBGL_compressed_texture_etc1",qb="WEBGL_compressed_texture_pvrtc",Kb="WEBGL_compressed_texture_atc",Wo="EXT_texture_norm16",jo="EXT_render_snorm",Zb="EXT_color_buffer_float",ni={"float32-renderable-webgl":["EXT_color_buffer_float"],"float16-renderable-webgl":["EXT_color_buffer_half_float"],"rgb9e5ufloat-renderable-webgl":["WEBGL_render_shared_exponent"],"snorm8-renderable-webgl":[jo],"norm16-renderable-webgl":[Wo],"snorm16-renderable-webgl":[Wo,jo],"float32-filterable":["OES_texture_float_linear"],"float16-filterable-webgl":["OES_texture_half_float_linear"],"texture-filterable-anisotropic-webgl":["EXT_texture_filter_anisotropic"],"texture-blend-float-webgl":["EXT_float_blend"],"texture-compression-bc":[Yt,qt,xt,Et],"texture-compression-bc5-webgl":[xt],"texture-compression-bc7-webgl":[Et],"texture-compression-etc2":[zb],"texture-compression-astc":[Xb],"texture-compression-etc1-webgl":[Yb],"texture-compression-pvrtc-webgl":[qb],"texture-compression-atc-webgl":[Kb]};function Qb(s){return s in ni}function Jb(s,e,t){return(ni[e]||[]).every(r=>Ut(s,r,t))}const ri={r8unorm:{gl:33321,rb:!0},r8snorm:{gl:36756},r8uint:{gl:33330,rb:!0},r8sint:{gl:33329,rb:!0},rg8unorm:{gl:33323,rb:!0},rg8snorm:{gl:36757},rg8uint:{gl:33336,rb:!0},rg8sint:{gl:33335,rb:!0},r16uint:{gl:33332,rb:!0},r16sint:{gl:33331,rb:!0},r16float:{gl:33325,rb:!0},"r16unorm-webgl":{gl:33322,rb:!0},"r16snorm-webgl":{gl:36760},"rgba4unorm-webgl":{gl:32854,rb:!0},"rgb565unorm-webgl":{gl:36194,rb:!0},"rgb5a1unorm-webgl":{gl:32855,rb:!0},"rgb8unorm-webgl":{gl:32849},"rgb8snorm-webgl":{gl:36758},rgba8unorm:{gl:32856},"rgba8unorm-srgb":{gl:35907},rgba8snorm:{gl:36759},rgba8uint:{gl:36220},rgba8sint:{gl:36238},bgra8unorm:{},"bgra8unorm-srgb":{},rg16uint:{gl:33338},rg16sint:{gl:33337},rg16float:{gl:33327,rb:!0},"rg16unorm-webgl":{gl:33324},"rg16snorm-webgl":{gl:36761},r32uint:{gl:33334,rb:!0},r32sint:{gl:33333,rb:!0},r32float:{gl:33326},rgb9e5ufloat:{gl:35901},rg11b10ufloat:{gl:35898,rb:!0},rgb10a2unorm:{gl:32857,rb:!0},"rgb10a2uint-webgl":{gl:36975,rb:!0},"rgb16unorm-webgl":{gl:32852},"rgb16snorm-webgl":{gl:36762},rg32uint:{gl:33340,rb:!0},rg32sint:{gl:33339,rb:!0},rg32float:{gl:33328,rb:!0},rgba16uint:{gl:36214,rb:!0},rgba16sint:{gl:36232,rb:!0},rgba16float:{gl:34842},"rgba16unorm-webgl":{gl:32859,rb:!0},"rgba16snorm-webgl":{gl:36763},"rgb32float-webgl":{gl:34837,x:Zb,dataFormat:6407,types:[5126]},rgba32uint:{gl:36208,rb:!0},rgba32sint:{gl:36226,rb:!0},rgba32float:{gl:34836,rb:!0},stencil8:{gl:36168,rb:!0},depth16unorm:{gl:33189,dataFormat:6402,types:[5123],rb:!0},depth24plus:{gl:33190,dataFormat:6402,types:[5125]},depth32float:{gl:36012,dataFormat:6402,types:[5126],rb:!0},"depth24plus-stencil8":{gl:35056,rb:!0,depthTexture:!0,dataFormat:34041,types:[34042]},"depth32float-stencil8":{gl:36013,dataFormat:34041,types:[36269],rb:!0},"bc1-rgb-unorm-webgl":{gl:33776,x:Yt},"bc1-rgb-unorm-srgb-webgl":{gl:35916,x:qt},"bc1-rgba-unorm":{gl:33777,x:Yt},"bc1-rgba-unorm-srgb":{gl:35916,x:qt},"bc2-rgba-unorm":{gl:33778,x:Yt},"bc2-rgba-unorm-srgb":{gl:35918,x:qt},"bc3-rgba-unorm":{gl:33779,x:Yt},"bc3-rgba-unorm-srgb":{gl:35919,x:qt},"bc4-r-unorm":{gl:36283,x:xt},"bc4-r-snorm":{gl:36284,x:xt},"bc5-rg-unorm":{gl:36285,x:xt},"bc5-rg-snorm":{gl:36286,x:xt},"bc6h-rgb-ufloat":{gl:36495,x:Et},"bc6h-rgb-float":{gl:36494,x:Et},"bc7-rgba-unorm":{gl:36492,x:Et},"bc7-rgba-unorm-srgb":{gl:36493,x:Et},"etc2-rgb8unorm":{gl:37492},"etc2-rgb8unorm-srgb":{gl:37494},"etc2-rgb8a1unorm":{gl:37496},"etc2-rgb8a1unorm-srgb":{gl:37497},"etc2-rgba8unorm":{gl:37493},"etc2-rgba8unorm-srgb":{gl:37495},"eac-r11unorm":{gl:37488},"eac-r11snorm":{gl:37489},"eac-rg11unorm":{gl:37490},"eac-rg11snorm":{gl:37491},"astc-4x4-unorm":{gl:37808},"astc-4x4-unorm-srgb":{gl:37840},"astc-5x4-unorm":{gl:37809},"astc-5x4-unorm-srgb":{gl:37841},"astc-5x5-unorm":{gl:37810},"astc-5x5-unorm-srgb":{gl:37842},"astc-6x5-unorm":{gl:37811},"astc-6x5-unorm-srgb":{gl:37843},"astc-6x6-unorm":{gl:37812},"astc-6x6-unorm-srgb":{gl:37844},"astc-8x5-unorm":{gl:37813},"astc-8x5-unorm-srgb":{gl:37845},"astc-8x6-unorm":{gl:37814},"astc-8x6-unorm-srgb":{gl:37846},"astc-8x8-unorm":{gl:37815},"astc-8x8-unorm-srgb":{gl:37847},"astc-10x5-unorm":{gl:37819},"astc-10x5-unorm-srgb":{gl:37851},"astc-10x6-unorm":{gl:37817},"astc-10x6-unorm-srgb":{gl:37849},"astc-10x8-unorm":{gl:37818},"astc-10x8-unorm-srgb":{gl:37850},"astc-10x10-unorm":{gl:37819},"astc-10x10-unorm-srgb":{gl:37851},"astc-12x10-unorm":{gl:37820},"astc-12x10-unorm-srgb":{gl:37852},"astc-12x12-unorm":{gl:37821},"astc-12x12-unorm-srgb":{gl:37853},"pvrtc-rgb4unorm-webgl":{gl:35840},"pvrtc-rgba4unorm-webgl":{gl:35842},"pvrtc-rbg2unorm-webgl":{gl:35841},"pvrtc-rgba2unorm-webgl":{gl:35843},"etc1-rbg-unorm-webgl":{gl:36196},"atc-rgb-unorm-webgl":{gl:35986},"atc-rgba-unorm-webgl":{gl:35986},"atc-rgbai-unorm-webgl":{gl:34798}};function Gb(s,e,t){let n=e.create;const r=ri[e.format];return r?.gl===void 0&&(n=!1),r?.x&&(n=n&&!!Ut(s,r.x,t)),{format:e.format,create:n&&e.create,render:n&&e.render,filter:n&&e.filter,blend:n&&e.blend,store:n&&e.store}}function al(s){const e=ri[s],t=sy(s),n=kr(s);return{internalFormat:t,format:e?.dataFormat||ty(n.channels,n.integer,n.normalized,t),type:n.dataType?ol(n.dataType):e?.types?.[0]||5121,compressed:n.compressed||!1}}function ey(s){switch(kr(s).attachment){case"depth":return 36096;case"stencil":return 36128;case"depth-stencil":return 33306;default:throw new Error(`Not a depth stencil format: ${s}`)}}function ty(s,e,t,n){if(n===6408||n===6407)return n;switch(s){case"r":return e&&!t?36244:6403;case"rg":return e&&!t?33320:33319;case"rgb":return e&&!t?36248:6407;case"rgba":return e&&!t?36249:6408;case"bgra":throw new Error("bgra pixels not supported by WebGL");default:return 6408}}function sy(s){const t=ri[s]?.gl;if(t===void 0)throw new Error(`Unsupported texture format ${s}`);return t}const Ho={"depth-clip-control":"EXT_depth_clamp","timer-query-webgl":"EXT_disjoint_timer_query_webgl2","compilation-status-async-webgl":"KHR_parallel_shader_compile","polygon-mode-webgl":"WEBGL_polygon_mode","provoking-vertex-webgl":"WEBGL_provoking_vertex","shader-clip-cull-distance-webgl":"WEBGL_clip_cull_distance","shader-noperspective-interpolation-webgl":"NV_shader_noperspective_interpolation","shader-conservative-depth-webgl":"EXT_conservative_depth"};class ny extends zf{gl;extensions;testedFeatures=new Set;constructor(e,t,n){super([],n),this.gl=e,this.extensions=t,Ut(e,"EXT_color_buffer_float",t)}*[Symbol.iterator](){const e=this.getFeatures();for(const t of e)this.has(t)&&(yield t);return[]}has(e){return this.disabledFeatures?.[e]?!1:(this.testedFeatures.has(e)||(this.testedFeatures.add(e),Qb(e)&&Jb(this.gl,e,this.extensions)&&this.features.add(e),this.getWebGLFeature(e)&&this.features.add(e)),this.features.has(e))}initializeFeatures(){const e=this.getFeatures().filter(t=>t!=="polygon-mode-webgl");for(const t of e)this.has(t)}getFeatures(){return[...Object.keys(Ho),...Object.keys(ni)]}getWebGLFeature(e){const t=Ho[e];return typeof t=="string"?!!Ut(this.gl,t,this.extensions):!!t}}class ry extends Hf{get maxTextureDimension1D(){return 0}get maxTextureDimension2D(){return this.getParameter(3379)}get maxTextureDimension3D(){return this.getParameter(32883)}get maxTextureArrayLayers(){return this.getParameter(35071)}get maxBindGroups(){return 0}get maxDynamicUniformBuffersPerPipelineLayout(){return 0}get maxDynamicStorageBuffersPerPipelineLayout(){return 0}get maxSampledTexturesPerShaderStage(){return this.getParameter(35660)}get maxSamplersPerShaderStage(){return this.getParameter(35661)}get maxStorageBuffersPerShaderStage(){return 0}get maxStorageTexturesPerShaderStage(){return 0}get maxUniformBuffersPerShaderStage(){return this.getParameter(35375)}get maxUniformBufferBindingSize(){return this.getParameter(35376)}get maxStorageBufferBindingSize(){return 0}get minUniformBufferOffsetAlignment(){return this.getParameter(35380)}get minStorageBufferOffsetAlignment(){return 0}get maxVertexBuffers(){return 16}get maxVertexAttributes(){return this.getParameter(34921)}get maxVertexBufferArrayStride(){return 2048}get maxInterStageShaderComponents(){return this.getParameter(35659)}get maxComputeWorkgroupStorageSize(){return 0}get maxComputeInvocationsPerWorkgroup(){return 0}get maxComputeWorkgroupSizeX(){return 0}get maxComputeWorkgroupSizeY(){return 0}get maxComputeWorkgroupSizeZ(){return 0}get maxComputeWorkgroupsPerDimension(){return 0}gl;limits={};constructor(e){super(),this.gl=e}getParameter(e){return this.limits[e]===void 0&&(this.limits[e]=this.gl.getParameter(e)),this.limits[e]||0}}class Gt extends an{device;gl;handle;colorAttachments=[];depthStencilAttachment=null;constructor(e,t){super(e,t);const n=t.handle===null;this.device=e,this.gl=e.gl,this.handle=this.props.handle||n?this.props.handle:this.gl.createFramebuffer(),n||(e.setSpectorMetadata(this.handle,{id:this.props.id,props:this.props}),this.autoCreateAttachmentTextures(),this.updateAttachments())}destroy(){super.destroy(),!this.destroyed&&this.handle!==null&&this.gl.deleteFramebuffer(this.handle)}updateAttachments(){const e=this.gl.bindFramebuffer(36160,this.handle);for(let t=0;t<this.colorAttachments.length;++t){const n=this.colorAttachments[t];if(n){const r=36064+t;this._attachTextureView(r,n)}}if(this.depthStencilAttachment){const t=ey(this.depthStencilAttachment.props.format);this._attachTextureView(t,this.depthStencilAttachment)}if(this.device.props.debug){const t=this.gl.checkFramebufferStatus(36160);if(t!==36053)throw new Error(`Framebuffer ${oy(t)}`)}this.gl.bindFramebuffer(36160,e)}_attachTextureView(e,t){const{gl:n}=this.device,{texture:r}=t,i=t.props.baseMipLevel,o=t.props.baseArrayLayer;switch(n.bindTexture(r.glTarget,r.handle),r.glTarget){case 35866:case 32879:n.framebufferTextureLayer(36160,e,r.handle,i,o);break;case 34067:const a=iy(o);n.framebufferTexture2D(36160,e,a,r.handle,i);break;case 3553:n.framebufferTexture2D(36160,e,3553,r.handle,i);break;default:throw new Error("Illegal texture type")}n.bindTexture(r.glTarget,null)}}function iy(s){return s<34069?s+34069:s}function oy(s){switch(s){case 36053:return"success";case 36054:return"Mismatched attachments";case 36055:return"No attachments";case 36057:return"Height/width mismatch";case 36061:return"Unsupported or split attachments";case 36182:return"Samples mismatch";default:return`${s}`}}class ay extends Nr{device;format="rgba8unorm";depthStencilFormat="depth24plus";presentationSize;_framebuffer=null;get[Symbol.toStringTag](){return"WebGLCanvasContext"}constructor(e,t){super(t),this.device=e,this.presentationSize=[-1,-1],this._setAutoCreatedCanvasId(`${this.device.id}-canvas`),this.update()}getCurrentFramebuffer(){return this.update(),this._framebuffer=this._framebuffer||new Gt(this.device,{handle:null}),this._framebuffer}update(){const e=this.getPixelSize();(e[0]!==this.presentationSize[0]||e[1]!==this.presentationSize[1])&&(this.presentationSize=e,this.resize())}resize(e){if(this.device.gl&&this.canvas){const t=this.getDevicePixelRatio(e?.useDevicePixels);this.setDevicePixelRatio(t,e);return}}commit(){}}async function cl(s,e){const t=document.getElementsByTagName("head")[0];if(!t)throw new Error("loadScript");const n=document.createElement("script");return n.setAttribute("type","text/javascript"),n.setAttribute("src",s),new Promise((r,i)=>{n.onload=r,n.onerror=o=>i(new Error(`Unable to load script '${s}': ${o}`)),t.appendChild(n)})}const cy=1;let pe=null,zo=!1;const ii={debugSpectorJS:C.get("debug-spectorjs"),debugSpectorJSUrl:"https://cdn.jsdelivr.net/npm/spectorjs@0.9.30/dist/spector.bundle.js",gl:void 0};async function ly(s){if(!globalThis.SPECTOR)try{await cl(s.debugSpectorJSUrl||ii.debugSpectorJSUrl)}catch(e){C.warn(String(e))}}function uy(s){if(s={...ii,...s},!s.debugSpectorJS)return null;if(!pe&&globalThis.SPECTOR&&!globalThis.luma?.spector){C.probe(cy,"SPECTOR found and initialized. Start with `luma.spector.displayUI()`")();const{Spector:e}=globalThis.SPECTOR;pe=new e,globalThis.luma&&(globalThis.luma.spector=pe)}if(!pe)return null;if(zo||(zo=!0,pe.spyCanvases(),pe?.onCaptureStarted.add(e=>C.info("Spector capture started:",e)()),pe?.onCapture.add(e=>{C.info("Spector capture complete:",e)(),pe?.getResultUI(),pe?.resultView.display(),pe?.resultView.addCapture(e)})),s.gl){const e=s.gl,t=e.device;pe?.startCapture(s.gl,500),e.device=t,new Promise(n=>setTimeout(n,2e3)).then(n=>{C.info("Spector capture stopped after 2 seconds")(),pe?.stopCapture()})}return pe}const hy="https://unpkg.com/webgl-debug@2.0.1/index.js";function ll(s){return s.luma=s.luma||{},s.luma}async function fy(){ht()&&!globalThis.WebGLDebugUtils&&(globalThis.global=globalThis.global||globalThis,globalThis.global.module={},await cl(hy))}function dy(s,e={}){return e.debugWebGL||e.traceWebGL?gy(s,e):py(s)}function py(s){const e=ll(s);return e.realContext?e.realContext:s}function gy(s,e){if(!globalThis.WebGLDebugUtils)return C.warn("webgl-debug not loaded")(),s;const t=ll(s);if(t.debugContext)return t.debugContext;globalThis.WebGLDebugUtils.init({...At,...s});const n=globalThis.WebGLDebugUtils.makeDebugContext(s,_y.bind(null,e),my.bind(null,e));for(const o in At)!(o in n)&&typeof At[o]=="number"&&(n[o]=At[o]);class r{}Object.setPrototypeOf(n,Object.getPrototypeOf(s)),Object.setPrototypeOf(r,n);const i=Object.create(r);return t.realContext=s,t.debugContext=i,i.debug=!0,i}function Xo(s,e){e=Array.from(e).map(n=>n===void 0?"undefined":n);let t=globalThis.WebGLDebugUtils.glFunctionArgsToString(s,e);return t=`${t.slice(0,100)}${t.length>100?"...":""}`,`gl.${s}(${t})`}function _y(s,e,t,n){n=Array.from(n).map(a=>a===void 0?"undefined":a);const r=globalThis.WebGLDebugUtils.glEnumToString(e),i=globalThis.WebGLDebugUtils.glFunctionArgsToString(t,n),o=`${r} in gl.${t}(${i})`;C.error(o)();debugger}function my(s,e,t){let n="";C.level>=1&&(n=Xo(e,t),s.traceWebGL&&C.log(1,n)());for(const r of t)if(r===void 0){n=n||Xo(e,t);debugger}}const $n={};function by(s="id"){$n[s]=$n[s]||1;const e=$n[s]++;return`${s}-${e}`}class es extends q{device;gl;handle;glTarget;glUsage;glIndexType=5123;byteLength;bytesUsed;constructor(e,t={}){super(e,t),this.device=e,this.gl=this.device.gl;const n=typeof t=="object"?t.handle:void 0;this.handle=n||this.gl.createBuffer(),e.setSpectorMetadata(this.handle,{...this.props,data:typeof this.props.data}),this.glTarget=yy(this.props.usage),this.glUsage=Ty(this.props.usage),this.glIndexType=this.props.indexType==="uint32"?5125:5123,t.data?this._initWithData(t.data,t.byteOffset,t.byteLength):this._initWithByteLength(t.byteLength||0)}_initWithData(e,t=0,n=e.byteLength+t){const r=this.glTarget;this.gl.bindBuffer(r,this.handle),this.gl.bufferData(r,n,this.glUsage),this.gl.bufferSubData(r,t,e),this.gl.bindBuffer(r,null),this.bytesUsed=n,this.byteLength=n,this._setDebugData(e,t,n),this.trackAllocatedMemory(n)}_initWithByteLength(e){let t=e;e===0&&(t=new Float32Array(0));const n=this.glTarget;return this.gl.bindBuffer(n,this.handle),this.gl.bufferData(n,t,this.glUsage),this.gl.bindBuffer(n,null),this.bytesUsed=e,this.byteLength=e,this._setDebugData(null,0,e),this.trackAllocatedMemory(e),this}destroy(){!this.destroyed&&this.handle&&(this.removeStats(),this.trackDeallocatedMemory(),this.gl.deleteBuffer(this.handle),this.destroyed=!0,this.handle=null)}write(e,t=0){this.gl.bindBuffer(36663,this.handle),this.gl.bufferSubData(36663,t,e),this.gl.bindBuffer(36663,null),this._setDebugData(e,t,e.byteLength)}async readAsync(e=0,t){return this.readSyncWebGL(e,t)}readSyncWebGL(e=0,t){t=t??this.byteLength-e;const n=new Uint8Array(t),r=0;return this.gl.bindBuffer(36662,this.handle),this.gl.getBufferSubData(36662,e,n,r,t),this.gl.bindBuffer(36662,null),this._setDebugData(n,e,t),n}}function yy(s){return s&q.INDEX?34963:s&q.VERTEX?34962:s&q.UNIFORM?35345:34962}function Ty(s){return s&q.INDEX||s&q.VERTEX?35044:s&q.UNIFORM?35048:35044}function wy(s){const e=s.split(/\r?\n/),t=[];for(const n of e){if(n.length<=1)continue;const r=n.split(":");if(r.length===2){const[h,f]=r;t.push({message:f.trim(),type:Yo(h),lineNum:0,linePos:0});continue}const[i,o,a,...c]=r;let l=parseInt(a,10);isNaN(l)&&(l=0);let u=parseInt(o,10);isNaN(u)&&(u=0),t.push({message:c.join(":").trim(),type:Yo(i),lineNum:l,linePos:u})}return t}function Yo(s){const e=["warning","error","info"],t=s.toLowerCase();return e.includes(t)?t:"info"}class vy extends on{device;handle;constructor(e,t){switch(super(e,t),this.device=e,this.props.stage){case"vertex":this.handle=this.props.handle||this.device.gl.createShader(35633);break;case"fragment":this.handle=this.props.handle||this.device.gl.createShader(35632);break;default:throw new Error(this.props.stage)}this._compile(this.source)}destroy(){this.handle&&(this.removeStats(),this.device.gl.deleteShader(this.handle),this.destroyed=!0)}get asyncCompilationStatus(){return this._waitForCompilationComplete().then(()=>this.compilationStatus)}async getCompilationInfo(){return await this._waitForCompilationComplete(),this.getCompilationInfoSync()}getCompilationInfoSync(){const e=this.device.gl.getShaderInfoLog(this.handle);return e?wy(e):[]}getTranslatedSource(){return this.device.getExtension("WEBGL_debug_shaders").WEBGL_debug_shaders?.getTranslatedShaderSource(this.handle)||null}async _compile(e){e=e.startsWith("#version ")?e:`#version 300 es
${e}`;const{gl:t}=this.device;if(t.shaderSource(this.handle,e),t.compileShader(this.handle),!this.device.props.debug){this.compilationStatus="pending";return}if(!this.device.features.has("compilation-status-async-webgl")){if(this._getCompilationStatus(),this.debugShader(),this.compilationStatus==="error")throw new Error(`GLSL compilation errors in ${this.props.stage} shader ${this.props.id}`);return}C.once(1,"Shader compilation is asynchronous")(),await this._waitForCompilationComplete(),C.info(2,`Shader ${this.id} - async compilation complete: ${this.compilationStatus}`)(),this._getCompilationStatus(),this.debugShader()}async _waitForCompilationComplete(){const e=async r=>await new Promise(i=>setTimeout(i,r));if(!this.device.features.has("compilation-status-async-webgl")){await e(10);return}const{gl:n}=this.device;for(;;){if(n.getShaderParameter(this.handle,37297))return;await e(10)}}_getCompilationStatus(){this.compilationStatus=this.device.gl.getShaderParameter(this.handle,35713)?"success":"error"}}function Ay(s,e,t,n){if(Ry(e))return n(s);const r=s;r.pushState();try{return xy(s,e),Lt(r.gl,t),n(s)}finally{r.popState()}}function xy(s,e){const t=s,{gl:n}=t;if(e.cullMode)switch(e.cullMode){case"none":n.disable(2884);break;case"front":n.enable(2884),n.cullFace(1028);break;case"back":n.enable(2884),n.cullFace(1029);break}if(e.frontFace&&n.frontFace(at("frontFace",e.frontFace,{ccw:2305,cw:2304})),e.unclippedDepth&&s.features.has("depth-clip-control")&&n.enable(34383),e.depthBias!==void 0&&(n.enable(32823),n.polygonOffset(e.depthBias,e.depthBiasSlopeScale||0)),e.provokingVertex&&s.features.has("provoking-vertex-webgl")){const i=t.getExtension("WEBGL_provoking_vertex").WEBGL_provoking_vertex,o=at("provokingVertex",e.provokingVertex,{first:36429,last:36430});i?.provokingVertexWEBGL(o)}if((e.polygonMode||e.polygonOffsetLine)&&s.features.has("polygon-mode-webgl")){if(e.polygonMode){const i=t.getExtension("WEBGL_polygon_mode").WEBGL_polygon_mode,o=at("polygonMode",e.polygonMode,{fill:6914,line:6913});i?.polygonModeWEBGL(1028,o),i?.polygonModeWEBGL(1029,o)}e.polygonOffsetLine&&n.enable(10754)}if(s.features.has("shader-clip-cull-distance-webgl")&&(e.clipDistance0&&n.enable(12288),e.clipDistance1&&n.enable(12289),e.clipDistance2&&n.enable(12290),e.clipDistance3&&n.enable(12291),e.clipDistance4&&n.enable(12292),e.clipDistance5&&n.enable(12293),e.clipDistance6&&n.enable(12294),e.clipDistance7&&n.enable(12295)),e.depthWriteEnabled!==void 0&&n.depthMask(Sy("depthWriteEnabled",e.depthWriteEnabled)),e.depthCompare&&(e.depthCompare!=="always"?n.enable(2929):n.disable(2929),n.depthFunc(_r("depthCompare",e.depthCompare))),e.stencilWriteMask){const r=e.stencilWriteMask;n.stencilMaskSeparate(1028,r),n.stencilMaskSeparate(1029,r)}if(e.stencilReadMask&&C.warn("stencilReadMask not supported under WebGL"),e.stencilCompare){const r=e.stencilReadMask||4294967295,i=_r("depthCompare",e.stencilCompare);e.stencilCompare!=="always"?n.enable(2960):n.disable(2960),n.stencilFuncSeparate(1028,i,0,r),n.stencilFuncSeparate(1029,i,0,r)}if(e.stencilPassOperation&&e.stencilFailOperation&&e.stencilDepthFailOperation){const r=Wn("stencilPassOperation",e.stencilPassOperation),i=Wn("stencilFailOperation",e.stencilFailOperation),o=Wn("stencilDepthFailOperation",e.stencilDepthFailOperation);n.stencilOpSeparate(1028,i,o,r),n.stencilOpSeparate(1029,i,o,r)}switch(e.blend){case!0:n.enable(3042);break;case!1:n.disable(3042);break}if(e.blendColorOperation||e.blendAlphaOperation){const r=qo("blendColorOperation",e.blendColorOperation||"add"),i=qo("blendAlphaOperation",e.blendAlphaOperation||"add");n.blendEquationSeparate(r,i);const o=As("blendColorSrcFactor",e.blendColorSrcFactor||"one"),a=As("blendColorDstFactor",e.blendColorDstFactor||"zero"),c=As("blendAlphaSrcFactor",e.blendAlphaSrcFactor||"one"),l=As("blendAlphaDstFactor",e.blendAlphaDstFactor||"zero");n.blendFuncSeparate(o,a,c,l)}}function _r(s,e){return at(s,e,{never:512,less:513,equal:514,"less-equal":515,greater:516,"not-equal":517,"greater-equal":518,always:519})}function Wn(s,e){return at(s,e,{keep:7680,zero:0,replace:7681,invert:5386,"increment-clamp":7682,"decrement-clamp":7683,"increment-wrap":34055,"decrement-wrap":34056})}function qo(s,e){return at(s,e,{add:32774,subtract:32778,"reverse-subtract":32779,min:32775,max:32776})}function As(s,e){return at(s,e,{one:1,zero:0,"src-color":768,"one-minus-src-color":769,"dst-color":774,"one-minus-dst-color":775,"src-alpha":770,"one-minus-src-alpha":771,"dst-alpha":772,"one-minus-dst-alpha":773,"src-alpha-saturated":776,"constant-color":32769,"one-minus-constant-color":32770,"constant-alpha":32771,"one-minus-constant-alpha":32772})}function Ey(s,e){return`Illegal parameter ${e} for ${s}`}function at(s,e,t){if(!(e in t))throw new Error(Ey(s,e));return t[e]}function Sy(s,e){return e}function Ry(s){let e=!0;for(const t in s){e=!1;break}return e}function ul(s){const e={};return s.addressModeU&&(e[10242]=jn(s.addressModeU)),s.addressModeV&&(e[10243]=jn(s.addressModeV)),s.addressModeW&&(e[32882]=jn(s.addressModeW)),s.magFilter&&(e[10240]=mr(s.magFilter)),(s.minFilter||s.mipmapFilter)&&(e[10241]=Iy(s.minFilter||"linear",s.mipmapFilter)),s.lodMinClamp!==void 0&&(e[33082]=s.lodMinClamp),s.lodMaxClamp!==void 0&&(e[33083]=s.lodMaxClamp),s.type==="comparison-sampler"&&(e[34892]=34894),s.compare&&(e[34893]=_r("compare",s.compare)),s.maxAnisotropy&&(e[34046]=s.maxAnisotropy),e}function jn(s){switch(s){case"clamp-to-edge":return 33071;case"repeat":return 10497;case"mirror-repeat":return 33648}}function mr(s){switch(s){case"nearest":return 9728;case"linear":return 9729}}function Iy(s,e="none"){if(!e)return mr(s);switch(e){case"none":return mr(s);case"nearest":return s==="nearest"?9984:9986;case"linear":return s==="nearest"?9985:9987}}class br extends ss{device;handle;parameters;constructor(e,t){super(e,t),this.device=e,this.parameters=ul(t),this.handle=this.handle||this.device.gl.createSampler(),this._setSamplerParameters(this.parameters)}destroy(){this.handle&&(this.device.gl.deleteSampler(this.handle),this.handle=void 0)}toString(){return`Sampler(${this.id},${JSON.stringify(this.props)})`}_setSamplerParameters(e){for(const[t,n]of Object.entries(e)){const r=Number(t);switch(r){case 33082:case 33083:this.device.gl.samplerParameterf(this.handle,r,n);break;default:this.device.gl.samplerParameteri(this.handle,r,n);break}}}}class St extends rn{device;gl;handle;texture;constructor(e,t){super(e,{...z.defaultProps,...t}),this.device=e,this.gl=this.device.gl,this.handle=null,this.texture=t.texture}}const Cy="Failed to deduce GL constant from typed array";function Py(s){switch(ArrayBuffer.isView(s)?s.constructor:s){case Float32Array:return 5126;case Uint16Array:return 5123;case Uint32Array:return 5125;case Uint8Array:return 5121;case Uint8ClampedArray:return 5121;case Int8Array:return 5120;case Int16Array:return 5122;case Int32Array:return 5124;default:throw new Error(Cy)}}function My(s,e){const{clamped:t=!0}=e||{};switch(s){case 5126:return Float32Array;case 5123:case 33635:case 32819:case 32820:return Uint16Array;case 5125:return Uint32Array;case 5121:return t?Uint8ClampedArray:Uint8Array;case 5120:return Int8Array;case 5122:return Int16Array;case 5124:return Int32Array;default:throw new Error("Failed to deduce typed array type from GL constant")}}function hl(s){switch(s){case 6406:case 33326:case 6403:case 36244:return 1;case 33339:case 33340:case 33328:case 33320:case 33319:return 2;case 6407:case 36248:case 34837:return 3;case 6408:case 36249:case 34836:return 4;default:return 0}}function Oy(s){switch(s){case 5121:return 1;case 33635:case 32819:case 32820:return 2;case 5126:return 4;default:return 0}}function Gs(s,e,t){if(ky(e))return t(s);const{nocatch:n=!0}=e,r=ot.get(s);r.push(),Lt(s,e);let i;if(n)i=t(s),r.pop();else try{i=t(s)}finally{r.pop()}return i}function ky(s){for(const e in s)return!1;return!0}function Ny(s,e,t){const{dimension:n,width:r,height:i,depth:o=0}=t,{glInternalFormat:a}=t,c=t.glTarget;switch(n){case"2d-array":case"3d":s.texStorage3D(c,e,a,r,i,o);break;default:s.texStorage2D(c,e,a,r,i)}}function Ko(s,e,t,n){const{width:r,height:i}=n,{dimension:o,depth:a=0,mipLevel:c=0}=n,{x:l=0,y:u=0,z:h=0}=n,{glFormat:f,glType:g}=n,_=fl(n.glTarget,o,a),w=n.flipY?{37440:!0}:{};Gs(s,w,()=>{switch(o){case"2d-array":case"3d":s.bindTexture(_,e),s.texSubImage3D(_,c,l,u,h,r,i,a,f,g,t),s.bindTexture(_,null);break;case"2d":case"cube":s.bindTexture(_,e),s.texSubImage2D(_,c,l,u,r,i,f,g,t),s.bindTexture(_,null);break;default:throw new Error(o)}})}function Zo(s,e,t){const{dimension:n,width:r,height:i,depth:o=0,mipLevel:a=0,byteOffset:c=0}=t,{x:l=0,y:u=0,z:h=0}=t,{glFormat:f,glType:g,compressed:_}=t,w=fl(t.glTarget,n,o);switch(n){case"2d-array":case"3d":_?s.compressedTexSubImage3D(w,a,l,u,h,r,i,o,f,e,c):s.texSubImage3D(w,a,l,u,h,r,i,o,f,g,e,c);break;case"2d":case"cube":_?s.compressedTexSubImage2D(w,a,l,u,r,i,f,e,c):s.texSubImage2D(w,a,l,u,r,i,f,g,e,c);break;default:throw new Error(n)}}function Dy(s){switch(s){case"1d":break;case"2d":return 3553;case"3d":return 32879;case"cube":return 34067;case"2d-array":return 35866}throw new Error(s)}function fl(s,e,t){return e==="cube"?34069+t:s}function Fy(s,e){const{sourceX:t=0,sourceY:n=0,sourceAttachment:r=0}=e||{};let{target:i=null,sourceWidth:o,sourceHeight:a,sourceDepth:c,sourceFormat:l,sourceType:u}=e||{};const{framebuffer:h,deleteFramebuffer:f}=dl(s),{gl:g,handle:_}=h;o||=h.width,a||=h.height;const w=h.colorAttachments[r]?.texture;if(!w)throw new Error(`Invalid framebuffer attachment ${r}`);c=w?.depth||1,l||=w?.glFormat||6408,u||=w?.glType||5121,i=Ly(i,u,l,o,a),u=u||Py(i);const A=g.bindFramebuffer(36160,_);return g.readBuffer(36064+r),g.readPixels(t,n,o,a,l,u,i),g.readBuffer(36064),g.bindFramebuffer(36160,A||null),f&&h.destroy(),i}function By(s,e){const{target:t,sourceX:n=0,sourceY:r=0,sourceFormat:i=6408,targetByteOffset:o=0}=e||{};let{sourceWidth:a,sourceHeight:c,sourceType:l}=e||{};const{framebuffer:u,deleteFramebuffer:h}=dl(s);a=a||u.width,c=c||u.height;const f=u;l=l||5121;let g=t;if(!g){const w=hl(i),A=Oy(l),S=o+a*c*w*A;g=f.device.createBuffer({byteLength:S})}const _=s.device.createCommandEncoder();return _.copyTextureToBuffer({sourceTexture:s,width:a,height:c,origin:[n,r],destinationBuffer:g,byteOffset:o}),_.destroy(),h&&u.destroy(),g}function dl(s){return s instanceof an?{framebuffer:s,deleteFramebuffer:!1}:{framebuffer:Uy(s),deleteFramebuffer:!0}}function Uy(s,e){const{device:t,width:n,height:r,id:i}=s;return t.createFramebuffer({...e,id:`framebuffer-for-${i}`,width:n,height:r,colorAttachments:[s]})}function Ly(s,e,t,n,r,i){if(s)return s;e||=5121;const o=My(e,{clamped:!1}),a=hl(t);return new o(n*r*a)}class ts extends z{device;gl;handle;sampler=void 0;view=void 0;mipmaps;compressed;glTarget;glFormat;glType;glInternalFormat;textureUnit=0;constructor(e,t){super(e,t);const n={...this.props};n.data=t.data,this.device=e,this.gl=this.device.gl,this.glTarget=Dy(this.props.dimension);const r=al(this.props.format);this.glInternalFormat=r.internalFormat,this.glFormat=r.format,this.glType=r.type,this.compressed=r.compressed,this.mipmaps=!!this.props.mipmaps,this._initialize(n),Object.seal(this)}_initialize(e){this.handle=this.props.handle||this.gl.createTexture(),this.device.setSpectorMetadata(this.handle,{...this.props,data:e.data});let{width:t,height:n}=e;if(!t||!n){const r=z.getTextureDataSize(e.data);t=r?.width||1,n=r?.height||1}if(this.width=t,this.height=n,this.depth=e.depth,this.setSampler(e.sampler),this.view=new St(this.device,{...this.props,texture:this}),this.bind(),Ny(this.gl,this.mipLevels,this),e.data)switch(e.dimension){case"1d":this.setTexture1DData(e.data);break;case"2d":this.setTexture2DData(e.data);break;case"3d":this.setTexture3DData(e.data);break;case"cube":this.setTextureCubeData(e.data);break;case"2d-array":this.setTextureArrayData(e.data);break;case"cube-array":this.setTextureCubeArrayData(e.data);break;default:throw new Error(e.dimension)}this.mipmaps&&this.generateMipmap()}destroy(){this.handle&&(this.gl.deleteTexture(this.handle),this.removeStats(),this.trackDeallocatedMemory("Texture"),this.destroyed=!0)}createView(e){return new St(this.device,{...e,texture:this})}setSampler(e={}){let t;e instanceof br?(this.sampler=e,t=e.props):(this.sampler=new br(this.device,e),t=e);const n=ul(t);this._setSamplerParameters(n)}generateMipmap(e){if(!(!(this.device.isTextureFormatRenderable(this.props.format)&&this.device.isTextureFormatFilterable(this.props.format))&&(C.warn(`${this} is not renderable or filterable, may not be able to generate mipmaps`)(),!e?.force)))try{this.gl.bindTexture(this.glTarget,this.handle),this.gl.generateMipmap(this.glTarget)}catch(n){C.warn(`Error generating mipmap for ${this}: ${n.message}`)()}finally{this.gl.bindTexture(this.glTarget,null)}}copyExternalImage(e){const t=z.getExternalImageSize(e.image),n={...z.defaultCopyExternalImageOptions,...t,...e},{image:r,depth:i,mipLevel:o,x:a,y:c,z:l,flipY:u}=n;let{width:h,height:f}=n;const{dimension:g,glTarget:_,glFormat:w,glInternalFormat:A,glType:S}=this;if(h=Math.min(h,this.width-a),f=Math.min(f,this.height-c),e.sourceX||e.sourceY)throw new Error("WebGL does not support sourceX/sourceY)");return Ko(this.device.gl,this.handle,r,{dimension:g,mipLevel:o,x:a,y:c,z:l,width:h,height:f,depth:i,glFormat:w,glType:S,glTarget:_,flipY:u}),{width:n.width,height:n.height}}setTexture1DData(e){throw new Error("setTexture1DData not supported in WebGL.")}setTexture2DData(e,t=0){this.bind();const n=z.normalizeTextureData(e,this);n.length>1&&this.props.mipmaps!==!1&&C.warn(`Texture ${this.id} mipmap and multiple LODs.`)();for(let r=0;r<n.length;r++){const i=n[r];this._setMipLevel(t,r,i)}this.unbind()}setTexture3DData(e){if(this.props.dimension!=="3d")throw new Error(this.id);ArrayBuffer.isView(e)&&(this.bind(),Zo(this.device.gl,e,this),this.unbind())}setTextureCubeData(e,t=0){if(this.props.dimension!=="cube")throw new Error(this.id);for(const n of z.CubeFaces)this.setTextureCubeFaceData(e[n],n)}setTextureArrayData(e){throw this.props.dimension!=="2d-array"?new Error(this.id):new Error("setTextureArrayData not implemented.")}setTextureCubeArrayData(e){throw new Error("setTextureCubeArrayData not supported in WebGL2.")}setTextureCubeFaceData(e,t,n=0){Array.isArray(e)&&e.length>1&&this.props.mipmaps!==!1&&C.warn(`${this.id} has mipmap and multiple LODs.`)();const r=z.CubeFaces.indexOf(t);this.setTexture2DData(e,r)}update(){throw new Error("Texture.update() not implemented. Use ExternalTexture")}setImageDataForFace(e){const{face:t,width:n,height:r,pixels:i,data:o,format:a=6408,type:c=5121}=e,{gl:l}=this,u=i||o;this.bind(),u instanceof Promise?u.then(h=>this.setImageDataForFace(Object.assign({},e,{face:t,data:h,pixels:h}))):this.width||this.height?l.texImage2D(t,0,a,n,r,0,a,c,u):l.texImage2D(t,0,a,a,c,u)}_getImageDataMap(e){for(let t=0;t<z.CubeFaces.length;++t){const n=z.CubeFaces[t];e[n]&&(e[34069+t]=e[n],delete e[n])}return e}_setSamplerParameters(e){C.log(1,`${this.id} sampler parameters`,this.device.getGLKeys(e))(),this.gl.bindTexture(this.glTarget,this.handle);for(const[t,n]of Object.entries(e)){const r=Number(t),i=n;switch(r){case 33082:case 33083:this.gl.texParameterf(this.glTarget,r,i);break;case 10241:this.gl.texParameteri(this.glTarget,r,i);break;case 10242:case 10243:this.gl.texParameteri(this.glTarget,r,i);break;case 34046:this.device.features.has("texture-filterable-anisotropic-webgl")&&this.gl.texParameteri(this.glTarget,r,i);break;default:this.gl.texParameteri(this.glTarget,r,i);break}}this.gl.bindTexture(this.glTarget,null)}_setMipLevel(e,t,n,r=this.glTarget){if(z.isExternalImage(n)){Ko(this.device.gl,this.handle,n,{...this,depth:e,mipLevel:t,glTarget:r,flipY:this.props.flipY});return}if(z.isTextureLevelData(n)){Zo(this.device.gl,n.data,{...this,depth:e,mipLevel:t,glTarget:r});return}throw new Error("Texture: invalid image data")}getActiveUnit(){return this.gl.getParameter(34016)-33984}bind(e){const{gl:t}=this;return e!==void 0&&(this.textureUnit=e,t.activeTexture(33984+e)),t.bindTexture(this.glTarget,this.handle),e}unbind(e){const{gl:t}=this;return e!==void 0&&(this.textureUnit=e,t.activeTexture(33984+e)),t.bindTexture(this.glTarget,null),e}}const Vy=[1,2,4,8];class $y extends et{device;glParameters;constructor(e,t){super(e,t),this.device=e;let n;if(!t?.parameters?.viewport)if(t?.framebuffer){const{width:i,height:o}=t.framebuffer;n=[0,0,i,o]}else{const[i,o]=e.getCanvasContext().getDrawingBufferSize();n=[0,0,i,o]}if(this.device.pushState(),this.setParameters({viewport:n,...this.props.parameters}),this.props.framebuffer?.handle)if(this.props.framebuffer){const i=this.props.framebuffer.colorAttachments.map((o,a)=>36064+a);this.device.gl.drawBuffers(i)}else this.device.gl.drawBuffers([1029]);this.clear()}end(){this.device.popState()}pushDebugGroup(e){}popDebugGroup(){}insertDebugMarker(e){}setParameters(e={}){const t={...this.glParameters};t.framebuffer=this.props.framebuffer||null,this.props.depthReadOnly&&(t.depthMask=!this.props.depthReadOnly),t.stencilMask=this.props.stencilReadOnly?0:1,t[35977]=this.props.discard,e.viewport&&(e.viewport.length>=6?(t.viewport=e.viewport.slice(0,4),t.depthRange=[e.viewport[4],e.viewport[5]]):t.viewport=e.viewport),e.scissorRect&&(t.scissorTest=!0,t.scissor=e.scissorRect),e.blendConstant&&(t.blendColor=e.blendConstant),e.stencilReference&&(console.warn("RenderPassParameters.stencilReference not yet implemented in WebGL"),e[2967]=e.stencilReference),e.colorMask&&(t.colorMask=Vy.map(n=>!!(n&e.colorMask))),this.glParameters=t,Lt(this.device.gl,t)}beginOcclusionQuery(e){this.props.occlusionQuerySet?.beginOcclusionQuery()}endOcclusionQuery(){this.props.occlusionQuerySet?.endOcclusionQuery()}clear(){const e={...this.glParameters};let t=0;this.props.clearColors&&this.props.clearColors.forEach((n,r)=>{n&&this.clearColorBuffer(r,n)}),this.props.clearColor!==!1&&this.props.clearColors===void 0&&(t|=16384,e.clearColor=this.props.clearColor),this.props.clearDepth!==!1&&(t|=256,e.clearDepth=this.props.clearDepth),this.props.clearStencil!==!1&&(t|=1024,e.clearStencil=this.props.clearStencil),t!==0&&Gs(this.device.gl,e,()=>{this.device.gl.clear(t)})}clearColorBuffer(e=0,t=[0,0,0,0]){Gs(this.device.gl,{framebuffer:this.props.framebuffer},()=>{switch(t.constructor){case Int8Array:case Int16Array:case Int32Array:this.device.gl.clearBufferiv(6144,e,t);break;case Uint8Array:case Uint8ClampedArray:case Uint16Array:case Uint32Array:this.device.gl.clearBufferuiv(6144,e,t);break;case Float32Array:this.device.gl.clearBufferfv(6144,e,t);break;default:throw new Error("clearColorBuffer: color must be typed array")}})}}function Wy(s){return jy.includes(s)}const jy=[35678,35680,35679,35682,36289,36292,36293,36298,36299,36300,36303,36306,36307,36308,36311],pl={5126:[5126,1,"float","f32","float32"],35664:[5126,2,"vec2","vec2<f32>","float32x2"],35665:[5126,3,"vec3","vec3<f32>","float32x3"],35666:[5126,4,"vec4","vec4<f32>","float32x4"],5124:[5124,1,"int","i32","sint32"],35667:[5124,2,"ivec2","vec2<i32>","sint32x2"],35668:[5124,3,"ivec3","vec3<i32>","sint32x3"],35669:[5124,4,"ivec4","vec4<i32>","sint32x4"],5125:[5125,1,"uint","u32","uint32"],36294:[5125,2,"uvec2","vec2<u32>","uint32x2"],36295:[5125,3,"uvec3","vec3<u32>","uint32x3"],36296:[5125,4,"uvec4","vec4<u32>","uint32x4"],35670:[5126,1,"bool","f32","float32"],35671:[5126,2,"bvec2","vec2<f32>","float32x2"],35672:[5126,3,"bvec3","vec3<f32>","float32x3"],35673:[5126,4,"bvec4","vec4<f32>","float32x4"],35674:[5126,8,"mat2","mat2x2<f32>"],35685:[5126,8,"mat2x3","mat2x3<f32>"],35686:[5126,8,"mat2x4","mat2x4<f32>"],35687:[5126,12,"mat3x2","mat3x2<f32>"],35675:[5126,12,"mat3","mat3x3<f32>"],35688:[5126,12,"mat3x4","mat3x4<f32>"],35689:[5126,16,"mat4x2","mat4x2<f32>"],35690:[5126,16,"mat4x3","mat4x3<f32>"],35676:[5126,16,"mat4","mat4x4<f32>"]};function gl(s){const e=pl[s];if(!e)throw new Error("uniform");const[t,n,,r]=e;return{format:r,components:n,glType:t}}function Hy(s){const e=pl[s];if(!e)throw new Error("attribute");const[,t,,n,r]=e;return{attributeType:n,vertexFormat:r,components:t}}function zy(s,e){const t={attributes:[],bindings:[]};t.attributes=Xy(s,e);const n=Ky(s,e);for(const a of n){const c=a.uniforms.map(l=>({name:l.name,format:l.format,byteOffset:l.byteOffset,byteStride:l.byteStride,arrayLength:l.arrayLength}));t.bindings.push({type:"uniform",name:a.name,group:0,location:a.location,visibility:(a.vertex?1:0)&(a.fragment?2:0),minBindingSize:a.byteLength,uniforms:c})}const r=qy(s,e);let i=0;for(const a of r)if(Wy(a.type)){const{viewDimension:c,sampleType:l}=Qy(a.type);t.bindings.push({type:"texture",name:a.name,group:0,location:i,viewDimension:c,sampleType:l}),a.textureUnit=i,i+=1}r.length&&(t.uniforms=r);const o=Yy(s,e);return o?.length&&(t.varyings=o),t}function Xy(s,e){const t=[],n=s.getProgramParameter(e,35721);for(let r=0;r<n;r++){const i=s.getActiveAttrib(e,r);if(!i)throw new Error("activeInfo");const{name:o,type:a}=i,c=s.getAttribLocation(e,o);if(c>=0){const{attributeType:l}=Hy(a),u=/instance/i.test(o)?"instance":"vertex";t.push({name:o,location:c,stepMode:u,type:l})}}return t.sort((r,i)=>r.location-i.location),t}function Yy(s,e){const t=[],n=s.getProgramParameter(e,35971);for(let r=0;r<n;r++){const i=s.getTransformFeedbackVarying(e,r);if(!i)throw new Error("activeInfo");const{name:o,type:a,size:c}=i,{glType:l,components:u}=gl(a),h={location:r,name:o,type:l,size:c*u};t.push(h)}return t.sort((r,i)=>r.location-i.location),t}function qy(s,e){const t=[],n=s.getProgramParameter(e,35718);for(let r=0;r<n;r++){const i=s.getActiveUniform(e,r);if(!i)throw new Error("activeInfo");const{name:o,size:a,type:c}=i,{name:l,isArray:u}=Jy(o);let h=s.getUniformLocation(e,l);const f={location:h,name:l,size:a,type:c,isArray:u};if(t.push(f),f.size>1)for(let g=0;g<f.size;g++){const _=`${l}[${g}]`;h=s.getUniformLocation(e,_);const w={...f,name:_,location:h};t.push(w)}}return t}function Ky(s,e){const t=(i,o)=>s.getActiveUniformBlockParameter(e,i,o),n=[],r=s.getProgramParameter(e,35382);for(let i=0;i<r;i++){const o={name:s.getActiveUniformBlockName(e,i)||"",location:t(i,35391),byteLength:t(i,35392),vertex:t(i,35396),fragment:t(i,35398),uniformCount:t(i,35394),uniforms:[]},a=t(i,35395)||[],c=s.getActiveUniforms(e,a,35383),l=s.getActiveUniforms(e,a,35384),u=s.getActiveUniforms(e,a,35387),h=s.getActiveUniforms(e,a,35388);for(let f=0;f<o.uniformCount;++f){const g=s.getActiveUniform(e,a[f]);if(!g)throw new Error("activeInfo");o.uniforms.push({name:g.name,format:gl(c[f]).format,type:c[f],arrayLength:l[f],byteOffset:u[f],byteStride:h[f]})}n.push(o)}return n.sort((i,o)=>i.location-o.location),n}const Zy={35678:["2d","float"],35680:["cube","float"],35679:["3d","float"],35682:["3d","depth"],36289:["2d-array","float"],36292:["2d-array","depth"],36293:["cube","float"],36298:["2d","sint"],36299:["3d","sint"],36300:["cube","sint"],36303:["2d-array","uint"],36306:["2d","uint"],36307:["3d","uint"],36308:["cube","uint"],36311:["2d-array","uint"]};function Qy(s){const e=Zy[s];if(!e)throw new Error("sampler");const[t,n]=e;return{viewDimension:t,sampleType:n}}function Jy(s){if(s[s.length-1]!=="]")return{name:s,length:1,isArray:!1};const t=/([^[]*)(\[[0-9]+\])?/.exec(s);if(!t||t.length<2)throw new Error(`Failed to parse GLSL uniform name ${s}`);return{name:t[1],length:t[2]?1:0,isArray:!!t[2]}}function Gy(s,e,t,n){const r=s;let i=n;i===!0&&(i=1),i===!1&&(i=0);const o=typeof i=="number"?[i]:i;switch(t){case 35678:case 35680:case 35679:case 35682:case 36289:case 36292:case 36293:case 36298:case 36299:case 36300:case 36303:case 36306:case 36307:case 36308:case 36311:if(typeof n!="number")throw new Error("samplers must be set to integers");return s.uniform1i(e,n);case 5126:return s.uniform1fv(e,o);case 35664:return s.uniform2fv(e,o);case 35665:return s.uniform3fv(e,o);case 35666:return s.uniform4fv(e,o);case 5124:return s.uniform1iv(e,o);case 35667:return s.uniform2iv(e,o);case 35668:return s.uniform3iv(e,o);case 35669:return s.uniform4iv(e,o);case 35670:return s.uniform1iv(e,o);case 35671:return s.uniform2iv(e,o);case 35672:return s.uniform3iv(e,o);case 35673:return s.uniform4iv(e,o);case 5125:return r.uniform1uiv(e,o,1);case 36294:return r.uniform2uiv(e,o,2);case 36295:return r.uniform3uiv(e,o,3);case 36296:return r.uniform4uiv(e,o,4);case 35674:return s.uniformMatrix2fv(e,!1,o);case 35675:return s.uniformMatrix3fv(e,!1,o);case 35676:return s.uniformMatrix4fv(e,!1,o);case 35685:return r.uniformMatrix2x3fv(e,!1,o);case 35686:return r.uniformMatrix2x4fv(e,!1,o);case 35687:return r.uniformMatrix3x2fv(e,!1,o);case 35688:return r.uniformMatrix3x4fv(e,!1,o);case 35689:return r.uniformMatrix4x2fv(e,!1,o);case 35690:return r.uniformMatrix4x3fv(e,!1,o)}throw new Error("Illegal uniform")}function eT(s){return qc(s)!==null||typeof s=="number"||typeof s=="boolean"}function tT(s){const e={bindings:{},uniforms:{}};return Object.keys(s).forEach(t=>{const n=s[t];eT(n)?e.uniforms[t]=n:e.bindings[t]=n}),e}function sT(s){switch(s){case"point-list":return 0;case"line-list":return 1;case"line-strip":return 3;case"triangle-list":return 4;case"triangle-strip":return 5;default:throw new Error(s)}}function nT(s){switch(s){case"point-list":return 0;case"line-list":return 1;case"line-strip":return 1;case"triangle-list":return 4;case"triangle-strip":return 4;default:throw new Error(s)}}const Qo=4;class rT extends Pt{device;handle;vs;fs;introspectedLayout;uniforms={};bindings={};varyings=null;_uniformCount=0;_uniformSetters={};constructor(e,t){super(e,t),this.device=e,this.handle=this.props.handle||this.device.gl.createProgram(),this.device.setSpectorMetadata(this.handle,{id:this.props.id}),this.vs=t.vs,this.fs=t.fs;const{varyings:n,bufferMode:r=35981}=t;n&&n.length>0&&(this.varyings=n,this.device.gl.transformFeedbackVaryings(this.handle,n,r)),this._linkShaders(),C.time(1,`RenderPipeline ${this.id} - shaderLayout introspection`)(),this.introspectedLayout=zy(this.device.gl,this.handle),C.timeEnd(1,`RenderPipeline ${this.id} - shaderLayout introspection`)(),this.shaderLayout=iT(this.introspectedLayout,t.shaderLayout)}destroy(){this.handle&&(this.device.gl.deleteProgram(this.handle),this.destroyed=!0)}setBindings(e,t){for(const[n,r]of Object.entries(e)){const i=this.shaderLayout.bindings.find(o=>o.name===n)||this.shaderLayout.bindings.find(o=>o.name===`${n}Uniforms`);if(!i){const o=this.shaderLayout.bindings.map(a=>`"${a.name}"`).join(", ");t?.disableWarnings||C.warn(`No binding "${n}" in render pipeline "${this.id}", expected one of ${o}`,r)();continue}switch(r||C.warn(`Unsetting binding "${n}" in render pipeline "${this.id}"`)(),i.type){case"uniform":if(!(r instanceof es)&&!(r.buffer instanceof es))throw new Error("buffer value");break;case"texture":if(!(r instanceof St||r instanceof ts||r instanceof Gt))throw new Error("texture value");break;case"sampler":C.warn(`Ignoring sampler ${n}`)();break;default:throw new Error(i.type)}this.bindings[n]=r}}draw(e){const{renderPass:t,parameters:n=this.props.parameters,topology:r=this.props.topology,vertexArray:i,vertexCount:o,instanceCount:a,isInstanced:c=!1,firstVertex:l=0,transformFeedback:u}=e,h=sT(r),f=!!i.indexBuffer,g=i.indexBuffer?.glIndexType;if(this.linkStatus!=="success")return C.info(2,`RenderPipeline:${this.id}.draw() aborted - waiting for shader linking`)(),!1;if(!this._areTexturesRenderable())return C.info(2,`RenderPipeline:${this.id}.draw() aborted - textures not yet loaded`)(),!1;this.device.gl.useProgram(this.handle),i.bindBeforeRender(t),u&&u.begin(this.props.topology),this._applyBindings(),this._applyUniforms();const _=t;return Ay(this.device,n,_.glParameters,()=>{f&&c?this.device.gl.drawElementsInstanced(h,o||0,g,l,a||0):f?this.device.gl.drawElements(h,o||0,g,l):c?this.device.gl.drawArraysInstanced(h,l,o||0,a||0):this.device.gl.drawArrays(h,l,o||0),u&&u.end()}),i.unbindAfterRender(t),!0}setUniformsWebGL(e){const{bindings:t}=tT(e);Object.keys(t).forEach(n=>{C.warn(`Unsupported value "${JSON.stringify(t[n])}" used in setUniforms() for key ${n}. Use setBindings() instead?`)()}),Object.assign(this.uniforms,e)}async _linkShaders(){const{gl:e}=this.device;if(e.attachShader(this.handle,this.vs.handle),e.attachShader(this.handle,this.fs.handle),C.time(Qo,`linkProgram for ${this.id}`)(),e.linkProgram(this.handle),C.timeEnd(Qo,`linkProgram for ${this.id}`)(),C.level,!this.device.features.has("compilation-status-async-webgl")){const n=this._getLinkStatus();this._reportLinkStatus(n);return}C.once(1,"RenderPipeline linking is asynchronous")(),await this._waitForLinkComplete(),C.info(2,`RenderPipeline ${this.id} - async linking complete: ${this.linkStatus}`)();const t=this._getLinkStatus();this._reportLinkStatus(t)}async _reportLinkStatus(e){switch(e){case"success":return;default:switch(this.vs.compilationStatus){case"error":throw this.vs.debugShader(),new Error(`Error during compilation of shader ${this.vs.id}`);case"pending":this.vs.asyncCompilationStatus.then(()=>this.vs.debugShader());break}switch(this.fs?.compilationStatus){case"error":throw this.fs.debugShader(),new Error(`Error during compilation of shader ${this.fs.id}`);case"pending":this.fs.asyncCompilationStatus.then(()=>this.fs.debugShader());break}const t=this.device.gl.getProgramInfoLog(this.handle);throw new Error(`Error during ${e}: ${t}`)}}_getLinkStatus(){const{gl:e}=this.device;return e.getProgramParameter(this.handle,35714)?(e.validateProgram(this.handle),e.getProgramParameter(this.handle,35715)?(this.linkStatus="success","success"):(this.linkStatus="error","validation")):(this.linkStatus="error","linking")}async _waitForLinkComplete(){const e=async r=>await new Promise(i=>setTimeout(i,r));if(!this.device.features.has("compilation-status-async-webgl")){await e(10);return}const{gl:n}=this.device;for(;;){if(n.getProgramParameter(this.handle,37297))return;await e(10)}}_areTexturesRenderable(){let e=!0;for(const t of this.shaderLayout.bindings)!this.bindings[t.name]&&!this.bindings[t.name.replace(/Uniforms$/,"")]&&(C.warn(`Binding ${t.name} not found in ${this.id}`)(),e=!1);return e}_applyBindings(){if(this.linkStatus!=="success")return;const{gl:e}=this.device;e.useProgram(this.handle);let t=0,n=0;for(const r of this.shaderLayout.bindings){const i=this.bindings[r.name]||this.bindings[r.name.replace(/Uniforms$/,"")];if(!i)throw new Error(`No value for binding ${r.name} in ${this.id}`);switch(r.type){case"uniform":const{name:o}=r,a=e.getUniformBlockIndex(this.handle,o);if(a===4294967295)throw new Error(`Invalid uniform block name ${o}`);e.uniformBlockBinding(this.handle,n,a),i instanceof es?e.bindBufferBase(35345,n,i.handle):e.bindBufferRange(35345,n,i.buffer.handle,i.offset||0,i.size||i.buffer.byteLength-i.offset),n+=1;break;case"texture":if(!(i instanceof St||i instanceof ts||i instanceof Gt))throw new Error("texture");let c;if(i instanceof St)c=i.texture;else if(i instanceof ts)c=i;else if(i instanceof Gt&&i.colorAttachments[0]instanceof St)C.warn("Passing framebuffer in texture binding may be deprecated. Use fbo.colorAttachments[0] instead")(),c=i.colorAttachments[0].texture;else throw new Error("No texture");e.activeTexture(33984+t),e.bindTexture(c.glTarget,c.handle),t+=1;break;case"sampler":break;case"storage":case"read-only-storage":throw new Error(`binding type '${r.type}' not supported in WebGL`)}}}_applyUniforms(){for(const e of this.shaderLayout.uniforms||[]){const{name:t,location:n,type:r,textureUnit:i}=e,o=this.uniforms[t]??i;o!==void 0&&Gy(this.device.gl,n,r,o)}}}function iT(s,e){const t={...s,attributes:s.attributes.map(n=>({...n}))};for(const n of e?.attributes||[]){const r=t.attributes.find(i=>i.name===n.name);r?(r.type=n.type||r.type,r.stepMode=n.stepMode||r.stepMode):C.warn(`shader layout attribute ${n.name} not present in shader`)}return t}class oT extends Fr{device;commands=[];constructor(e){super(e,{}),this.device=e}submitCommands(e=this.commands){for(const t of e)switch(t.name){case"copy-buffer-to-buffer":aT(this.device,t.options);break;case"copy-buffer-to-texture":cT(this.device,t.options);break;case"copy-texture-to-buffer":lT(this.device,t.options);break;case"copy-texture-to-texture":uT(this.device,t.options);break;default:throw new Error(t.name)}}}function aT(s,e){const t=e.sourceBuffer,n=e.destinationBuffer;s.gl.bindBuffer(36662,t.handle),s.gl.bindBuffer(36663,n.handle),s.gl.copyBufferSubData(36662,36663,e.sourceOffset??0,e.destinationOffset??0,e.size),s.gl.bindBuffer(36662,null),s.gl.bindBuffer(36663,null)}function cT(s,e){throw new Error("Not implemented")}function lT(s,e){const{sourceTexture:t,mipLevel:n=0,aspect:r="all",width:i=e.sourceTexture.width,height:o=e.sourceTexture.height,depthOrArrayLayers:a=0,origin:c=[0,0],destinationBuffer:l,byteOffset:u=0,bytesPerRow:h,rowsPerImage:f}=e;if(r!=="all")throw new Error("aspect not supported in WebGL");if(n!==0||a!==0||h||f)throw new Error("not implemented");const{framebuffer:g,destroyFramebuffer:_}=_l(t);let w;try{const A=l,S=i||g.width,I=o||g.height,x=al(g.colorAttachments[0].texture.props.format),E=x.format,P=x.type;s.gl.bindBuffer(35051,A.handle),w=s.gl.bindFramebuffer(36160,g.handle),s.gl.readPixels(c[0],c[1],S,I,E,P,u)}finally{s.gl.bindBuffer(35051,null),w!==void 0&&s.gl.bindFramebuffer(36160,w),_&&g.destroy()}}function uT(s,e){const{sourceTexture:t,destinationMipLevel:n=0,origin:r=[0,0],destinationOrigin:i=[0,0],destinationTexture:o}=e;let{width:a=e.destinationTexture.width,height:c=e.destinationTexture.height}=e;const{framebuffer:l,destroyFramebuffer:u}=_l(t),[h,f]=r,[g,_,w]=i,A=s.gl.bindFramebuffer(36160,l.handle);let S=null,I;if(o instanceof ts)S=o,a=Number.isFinite(a)?a:S.width,c=Number.isFinite(c)?c:S.height,S.bind(0),I=S.glTarget;else throw new Error("invalid destination");switch(I){case 3553:case 34067:s.gl.copyTexSubImage2D(I,n,g,_,h,f,a,c);break;case 35866:case 32879:s.gl.copyTexSubImage3D(I,n,g,_,w,h,f,a,c);break}S&&S.unbind(),s.gl.bindFramebuffer(36160,A),u&&l.destroy()}function _l(s){if(s instanceof z){const{width:e,height:t,id:n}=s;return{framebuffer:s.device.createFramebuffer({id:`framebuffer-for-${n}`,width:e,height:t,colorAttachments:[s]}),destroyFramebuffer:!0}}return{framebuffer:s,destroyFramebuffer:!1}}class hT extends Dr{device;commandBuffer;constructor(e,t){super(e,t),this.device=e,this.commandBuffer=new oT(e)}destroy(){}finish(){this.commandBuffer.submitCommands()}copyBufferToBuffer(e){this.commandBuffer.commands.push({name:"copy-buffer-to-buffer",options:e})}copyBufferToTexture(e){this.commandBuffer.commands.push({name:"copy-buffer-to-texture",options:e})}copyTextureToBuffer(e){this.commandBuffer.commands.push({name:"copy-texture-to-buffer",options:e})}copyTextureToTexture(e){this.commandBuffer.commands.push({name:"copy-texture-to-texture",options:e})}pushDebugGroup(e){}popDebugGroup(){}insertDebugMarker(e){}resolveQuerySet(e,t,n){}}function fT(s){const{target:e,source:t,start:n=0,count:r=1}=s,i=t.length,o=r*i;let a=0;for(let c=n;a<i;a++)e[c++]=t[a];for(;a<o;)a<o-a?(e.copyWithin(n+a,n,n+a),a*=2):(e.copyWithin(n+a,n,n+o-a),a=o);return s.target}class oi extends Br{get[Symbol.toStringTag](){return"VertexArray"}device;handle;buffer=null;bufferValue=null;static isConstantAttributeZeroSupported(e){return kl()==="Chrome"}constructor(e,t){super(e,t),this.device=e,this.handle=this.device.gl.createVertexArray()}destroy(){super.destroy(),this.buffer&&this.buffer?.destroy(),this.handle&&(this.device.gl.deleteVertexArray(this.handle),this.handle=void 0)}setIndexBuffer(e){const t=e;if(t&&t.glTarget!==34963)throw new Error("Use .setBuffer()");this.device.gl.bindVertexArray(this.handle),this.device.gl.bindBuffer(34963,t?t.handle:null),this.indexBuffer=t,this.device.gl.bindVertexArray(null)}setBuffer(e,t){const n=t;if(n.glTarget===34963)throw new Error("Use .setIndexBuffer()");const{size:r,type:i,stride:o,offset:a,normalized:c,integer:l,divisor:u}=this._getAccessor(e);this.device.gl.bindVertexArray(this.handle),this.device.gl.bindBuffer(34962,n.handle),l?this.device.gl.vertexAttribIPointer(e,r,i,o,a):this.device.gl.vertexAttribPointer(e,r,i,c,o,a),this.device.gl.bindBuffer(34962,null),this.device.gl.enableVertexAttribArray(e),this.device.gl.vertexAttribDivisor(e,u||0),this.attributes[e]=n,this.device.gl.bindVertexArray(null)}setConstantWebGL(e,t){this._enable(e,!1),this.attributes[e]=t}bindBeforeRender(){this.device.gl.bindVertexArray(this.handle),this._applyConstantAttributes()}unbindAfterRender(){this.device.gl.bindVertexArray(null)}_applyConstantAttributes(){for(let e=0;e<this.maxVertexAttributes;++e){const t=this.attributes[e];ArrayBuffer.isView(t)&&this.device.setConstantAttributeWebGL(e,t)}}_getAccessor(e){const t=this.attributeInfos[e];if(!t)throw new Error(`Unknown attribute location ${e}`);const n=ol(t.bufferDataType);return{size:t.bufferComponents,type:n,stride:t.byteStride,offset:t.byteOffset,normalized:t.normalized,integer:t.integer,divisor:t.stepMode==="instance"?1:0}}_enable(e,t=!0){const r=oi.isConstantAttributeZeroSupported(this.device)||e!==0;(t||r)&&(e=Number(e),this.device.gl.bindVertexArray(this.handle),t?this.device.gl.enableVertexAttribArray(e):this.device.gl.disableVertexAttribArray(e),this.device.gl.bindVertexArray(null))}getConstantBuffer(e,t){const n=dT(t),r=n.byteLength*e,i=n.length*e;if(this.buffer&&r!==this.buffer.byteLength)throw new Error(`Buffer size is immutable, byte length ${r} !== ${this.buffer.byteLength}.`);let o=!this.buffer;if(this.buffer=this.buffer||this.device.createBuffer({byteLength:r}),o=o||!pT(n,this.bufferValue),o){const a=Td(t.constructor,i);fT({target:a,source:n,start:0,count:i}),this.buffer.write(a),this.bufferValue=t}return this.buffer}}function dT(s){return Array.isArray(s)?new Float32Array(s):s}function pT(s,e){if(!s||!e||s.length!==e.length||s.constructor!==e.constructor)return!1;for(let t=0;t<s.length;++t)if(s[t]!==e[t])return!1;return!0}class gT extends Ur{device;gl;handle;layout;buffers={};unusedBuffers={};bindOnUse=!0;_bound=!1;constructor(e,t){super(e,t),this.device=e,this.gl=e.gl,this.handle=this.props.handle||this.gl.createTransformFeedback(),this.layout=this.props.layout,t.buffers&&this.setBuffers(t.buffers),Object.seal(this)}destroy(){this.gl.deleteTransformFeedback(this.handle),super.destroy()}begin(e="point-list"){this.gl.bindTransformFeedback(36386,this.handle),this.bindOnUse&&this._bindBuffers(),this.gl.beginTransformFeedback(nT(e))}end(){this.gl.endTransformFeedback(),this.bindOnUse&&this._unbindBuffers(),this.gl.bindTransformFeedback(36386,null)}setBuffers(e){this.buffers={},this.unusedBuffers={},this.bind(()=>{for(const t in e)this.setBuffer(t,e[t])})}setBuffer(e,t){const n=this._getVaryingIndex(e),{buffer:r,byteLength:i,byteOffset:o}=this._getBufferRange(t);if(n<0){this.unusedBuffers[e]=r,C.warn(`${this.id} unusedBuffers varying buffer ${e}`)();return}this.buffers[n]={buffer:r,byteLength:i,byteOffset:o},this.bindOnUse||this._bindBuffer(n,r,o,i)}getBuffer(e){if(Jo(e))return this.buffers[e]||null;const t=this._getVaryingIndex(e);return t>=0?this.buffers[t]:null}bind(e=this.handle){if(typeof e!="function")return this.gl.bindTransformFeedback(36386,e),this;let t;return this._bound?t=e():(this.gl.bindTransformFeedback(36386,this.handle),this._bound=!0,t=e(),this._bound=!1,this.gl.bindTransformFeedback(36386,null)),t}unbind(){this.bind(null)}_getBufferRange(e){if(e instanceof es)return{buffer:e,byteOffset:0,byteLength:e.byteLength};const{buffer:t,byteOffset:n=0,byteLength:r=e.buffer.byteLength}=e;return{buffer:t,byteOffset:n,byteLength:r}}_getVaryingIndex(e){if(Jo(e))return Number(e);for(const t of this.layout.varyings)if(e===t.name)return t.location;return-1}_bindBuffers(){for(const e in this.buffers){const{buffer:t,byteLength:n,byteOffset:r}=this._getBufferRange(this.buffers[e]);this._bindBuffer(Number(e),t,r,n)}}_unbindBuffers(){for(const e in this.buffers)this.gl.bindBufferBase(35982,Number(e),null)}_bindBuffer(e,t,n=0,r){const i=t&&t.handle;!i||r===void 0?this.gl.bindBufferBase(35982,e,i):this.gl.bindBufferRange(35982,e,i,n,r)}}function Jo(s){return typeof s=="number"?Number.isInteger(s):/^\d+$/.test(s)}class _T extends Lr{device;handle;target=null;_queryPending=!1;_pollingPromise=null;get[Symbol.toStringTag](){return"Query"}constructor(e,t){if(super(e,t),this.device=e,t.count>1)throw new Error("WebGL QuerySet can only have one value");this.handle=this.device.gl.createQuery(),Object.seal(this)}destroy(){this.device.gl.deleteQuery(this.handle)}beginTimestampQuery(){return this._begin(35007)}endTimestampQuery(){this._end()}beginOcclusionQuery(e){return this._begin(e?.conservative?36202:35887)}endOcclusionQuery(){this._end()}beginTransformFeedbackQuery(){return this._begin(35976)}endTransformFeedbackQuery(){this._end()}async resolveQuery(){return[await this.pollQuery()]}_begin(e){this._queryPending||(this.target=e,this.device.gl.beginQuery(this.target,this.handle))}_end(){this._queryPending||this.target&&(this.device.gl.endQuery(this.target),this.target=null,this._queryPending=!0)}isResultAvailable(){if(!this._queryPending)return!1;const e=this.device.gl.getQueryParameter(this.handle,34919);return e&&(this._queryPending=!1),e}isTimerDisjoint(){return this.device.gl.getParameter(36795)}getResult(){return this.device.gl.getQueryParameter(this.handle,34918)}getTimerMilliseconds(){return this.getResult()/1e6}pollQuery(e=Number.POSITIVE_INFINITY){if(this._pollingPromise)return this._pollingPromise;let t=0;return this._pollingPromise=new Promise((n,r)=>{const i=()=>{this.isResultAvailable()?(n(this.getResult()),this._pollingPromise=null):t++>e?(r("Timed out"),this._pollingPromise=null):requestAnimationFrame(i)};requestAnimationFrame(i)}),this._pollingPromise}}class Rt extends Ke{type="webgl";handle;features;limits;info;canvasContext;lost;_resolveContextLost;gl;debug=!1;_canvasSizeInfo={clientWidth:0,clientHeight:0,devicePixelRatio:1};_extensions={};_polyfilled=!1;spectorJS;constructor(e){super({...e,id:e.id||by("webgl-device")});const t=Ke._getCanvasContextProps(e);if(!t)throw new Error("WebGLDevice requires props.createCanvasContext to be set");let n=t.canvas?.gl?.device;if(n)throw new Error(`WebGL context already attached to device ${n.id}`);this.canvasContext=new ay(this,t),this.lost=new Promise(u=>{this._resolveContextLost=u});const r={...e.webgl};t.alphaMode==="premultiplied"&&(r.premultipliedAlpha=!0),e.powerPreference!==void 0&&(r.powerPreference=e.powerPreference);const o=this.props._handle||$b(this.canvasContext.canvas,{onContextLost:u=>this._resolveContextLost?.({reason:"destroyed",message:"Entered sleep mode, or too many apps or browser tabs are using the GPU."}),onContextRestored:u=>console.log("WebGL context restored")},r);if(!o)throw new Error("WebGL context creation failed");if(n=o.device,n){if(e._reuseDevices)return C.log(1,`Not creating a new Device, instead returning a reference to Device ${n.id} already attached to WebGL context`,n)(),n._reused=!0,n;throw new Error(`WebGL context already attached to device ${n.id}`)}this.handle=o,this.gl=o,this.spectorJS=uy({...this.props,gl:this.handle}),this.gl.device=this,this.gl._version=2,this.info=Wb(this.gl,this._extensions),this.limits=new ry(this.gl),this.features=new ny(this.gl,this._extensions,this.props._disabledFeatures),this.props._initializeFeatures&&this.features.initializeFeatures(),t.autoResize!==!1&&this.canvasContext.resize(),new ot(this.gl,{log:(...u)=>C.log(1,...u)()}).trackState(this.gl,{copyState:!1});const c=e.debugWebGL||e.debug,l=e.debugWebGL;c&&(this.gl=dy(this.gl,{debugWebGL:c,traceWebGL:l}),C.warn("WebGL debug mode activated. Performance reduced.")(),e.debugWebGL&&(C.level=Math.max(C.level,1)))}destroy(){!this.props._reuseDevices&&!this._reused&&delete this.gl.device}get isLost(){return this.gl.isContextLost()}createCanvasContext(e){throw new Error("WebGL only supports a single canvas")}createBuffer(e){const t=this._normalizeBufferProps(e);return new es(this,t)}createTexture(e){return new ts(this,e)}createExternalTexture(e){throw new Error("createExternalTexture() not implemented")}createSampler(e){return new br(this,e)}createShader(e){return new vy(this,e)}createFramebuffer(e){return new Gt(this,e)}createVertexArray(e){return new oi(this,e)}createTransformFeedback(e){return new gT(this,e)}createQuerySet(e){return new _T(this,e)}createRenderPipeline(e){return new rT(this,e)}beginRenderPass(e){return new $y(this,e)}createComputePipeline(e){throw new Error("ComputePipeline not supported in WebGL")}beginComputePass(e){throw new Error("ComputePass not supported in WebGL")}renderPass=null;createCommandEncoder(e={}){return new hT(this,e)}submit(){this.renderPass?.end(),this.renderPass=null}readPixelsToArrayWebGL(e,t){return Fy(e,t)}readPixelsToBufferWebGL(e,t){return By(e,t)}setParametersWebGL(e){Lt(this.gl,e)}getParametersWebGL(e){return rl(this.gl,e)}withParametersWebGL(e,t){return Gs(this.gl,e,t)}resetWebGL(){C.warn("WebGLDevice.resetWebGL is deprecated, use only for debugging")(),Fb(this.gl)}_getDeviceSpecificTextureFormatCapabilities(e){return Gb(this.gl,e,this._extensions)}loseDevice(){let e=!1;const n=this.getExtension("WEBGL_lose_context").WEBGL_lose_context;return n&&(e=!0,n.loseContext()),this._resolveContextLost?.({reason:"destroyed",message:"Application triggered context loss"}),e}pushState(){ot.get(this.gl).push()}popState(){ot.get(this.gl).pop()}setSpectorMetadata(e,t){e.__SPECTOR_Metadata=t}getGLKey(e,t){const n=Number(e);for(const r in this.gl)if(this.gl[r]===n)return`GL.${r}`;return t?.emptyIfUnknown?"":String(e)}getGLKeys(e){const t={emptyIfUnknown:!0};return Object.entries(e).reduce((n,[r,i])=>(n[`${r}:${this.getGLKey(r,t)}`]=`${i}:${this.getGLKey(i,t)}`,n),{})}_constants;setConstantAttributeWebGL(e,t){const n=this.limits.maxVertexAttributes;this._constants=this._constants||new Array(n).fill(null);const r=this._constants[e];switch(r&&TT(r,t)&&C.info(1,`setConstantAttributeWebGL(${e}) could have been skipped, value unchanged`)(),this._constants[e]=t,t.constructor){case Float32Array:mT(this,e,t);break;case Int32Array:bT(this,e,t);break;case Uint32Array:yT(this,e,t);break;default:throw new Error("constant")}}getExtension(e){return Ut(this.gl,e,this._extensions),this._extensions}}function mT(s,e,t){switch(t.length){case 1:s.gl.vertexAttrib1fv(e,t);break;case 2:s.gl.vertexAttrib2fv(e,t);break;case 3:s.gl.vertexAttrib3fv(e,t);break;case 4:s.gl.vertexAttrib4fv(e,t);break}}function bT(s,e,t){s.gl.vertexAttribI4iv(e,t)}function yT(s,e,t){s.gl.vertexAttribI4uiv(e,t)}function TT(s,e){if(!s||!e||s.length!==e.length||s.constructor!==e.constructor)return!1;for(let t=0;t<s.length;++t)if(s[t]!==e[t])return!1;return!0}const wT={WEBGL_depth_texture:{UNSIGNED_INT_24_8_WEBGL:34042},OES_element_index_uint:{},OES_texture_float:{},OES_texture_half_float:{HALF_FLOAT_OES:5131},EXT_color_buffer_float:{},OES_standard_derivatives:{FRAGMENT_SHADER_DERIVATIVE_HINT_OES:35723},EXT_frag_depth:{},EXT_blend_minmax:{MIN_EXT:32775,MAX_EXT:32776},EXT_shader_texture_lod:{}},vT=s=>({drawBuffersWEBGL(e){return s.drawBuffers(e)},COLOR_ATTACHMENT0_WEBGL:36064,COLOR_ATTACHMENT1_WEBGL:36065,COLOR_ATTACHMENT2_WEBGL:36066,COLOR_ATTACHMENT3_WEBGL:36067}),AT=s=>({VERTEX_ARRAY_BINDING_OES:34229,createVertexArrayOES(){return s.createVertexArray()},deleteVertexArrayOES(e){return s.deleteVertexArray(e)},isVertexArrayOES(e){return s.isVertexArray(e)},bindVertexArrayOES(e){return s.bindVertexArray(e)}}),xT=s=>({VERTEX_ATTRIB_ARRAY_DIVISOR_ANGLE:35070,drawArraysInstancedANGLE(...e){return s.drawArraysInstanced(...e)},drawElementsInstancedANGLE(...e){return s.drawElementsInstanced(...e)},vertexAttribDivisorANGLE(...e){return s.vertexAttribDivisor(...e)}});function ET(s=!0){const e=HTMLCanvasElement.prototype;if(!s&&e.originalGetContext){e.getContext=e.originalGetContext,e.originalGetContext=void 0;return}e.originalGetContext=e.getContext,e.getContext=function(t,n){if(t==="webgl"||t==="experimental-webgl"){const r=this.originalGetContext("webgl2",n);return r instanceof HTMLElement&&ST(r),r}return this.originalGetContext(t,n)}}function ST(s){s.getExtension("EXT_color_buffer_float");const e={...wT,WEBGL_disjoint_timer_query:s.getExtension("EXT_disjoint_timer_query_webgl2"),WEBGL_draw_buffers:vT(s),OES_vertex_array_object:AT(s),ANGLE_instanced_arrays:xT(s)},t=s.getExtension;s.getExtension=function(r){const i=t.call(s,r);return i||(r in e?e[r]:null)};const n=s.getSupportedExtensions;s.getSupportedExtensions=function(){return(n.apply(s)||[])?.concat(Object.keys(e))}}const xs=1;class RT extends Zf{type="webgl";constructor(){super(),Ke.defaultProps={...Ke.defaultProps,...ii},Rt.adapter=this}isSupported(){return typeof WebGL2RenderingContext<"u"}enforceWebGL2(e){ET(e)}async attach(e){if(e instanceof Rt)return e;if(e?.device instanceof Ke)return e.device;if(!IT(e))throw new Error("Invalid WebGL2RenderingContext");return new Rt({_handle:e,createCanvasContext:{canvas:e.canvas,autoResize:!1}})}async create(e={}){C.groupCollapsed(xs,"WebGLDevice created")();const t=[];(e.debugWebGL||e.debug)&&t.push(fy()),e.debugSpectorJS&&t.push(ly(e));const n=await Promise.allSettled(t);for(const o of n)o.status==="rejected"&&C.error(`Failed to initialize debug libraries ${o.reason}`)();const r=new Rt(e),i=`${r._reused?"Reusing":"Created"} device with WebGL2 ${r.debug?"debug ":""}context: ${r.info.vendor}, ${r.info.renderer} for canvas: ${r.canvasContext.id}`;return C.probe(xs,i)(),C.table(xs,r.info)(),C.groupEnd(xs)(),r}}function IT(s){return typeof WebGL2RenderingContext<"u"&&s instanceof WebGL2RenderingContext?!0:!!(s&&Number.isFinite(s._version))}const Go=new RT;function je(){}const CT=({isDragging:s})=>s?"grabbing":"grab",ml={id:"",width:"100%",height:"100%",style:null,viewState:null,initialViewState:null,pickingRadius:0,layerFilter:null,parameters:{},parent:null,device:null,deviceProps:{},gl:null,canvas:null,layers:[],effects:[],views:null,controller:null,useDevicePixels:!0,touchAction:"none",eventRecognizerOptions:{},_framebuffer:null,_animate:!1,_pickable:!0,_typedArrayManagerProps:{},_customRender:null,widgets:[],onDeviceInitialized:je,onWebGLInitialized:je,onResize:je,onViewStateChange:je,onInteractionStateChange:je,onBeforeRender:je,onAfterRender:je,onLoad:je,onError:s=>Y.error(s.message,s.cause)(),onHover:null,onClick:null,onDragStart:null,onDrag:null,onDragEnd:null,_onMetrics:null,getCursor:CT,getTooltip:null,debug:!1,drawPickingColors:!1};class bl{constructor(e){this.width=0,this.height=0,this.userData={},this.device=null,this.canvas=null,this.viewManager=null,this.layerManager=null,this.effectManager=null,this.deckRenderer=null,this.deckPicker=null,this.eventManager=null,this.widgetManager=null,this.tooltip=null,this.animationLoop=null,this.cursorState={isHovering:!1,isDragging:!1},this.stats=new tn({id:"deck.gl"}),this.metrics={fps:0,setPropsTime:0,updateAttributesTime:0,framesRedrawn:0,pickTime:0,pickCount:0,gpuTime:0,gpuTimePerFrame:0,cpuTime:0,cpuTimePerFrame:0,bufferMemory:0,textureMemory:0,renderbufferMemory:0,gpuMemory:0},this._metricsCounter=0,this._needsRedraw="Initial render",this._pickRequest={mode:"hover",x:-1,y:-1,radius:0,event:null},this._lastPointerDownInfo=null,this._onPointerMove=n=>{const{_pickRequest:r}=this;if(n.type==="pointerleave")r.x=-1,r.y=-1,r.radius=0;else{if(n.leftButton||n.rightButton)return;{const i=n.offsetCenter;if(!i)return;r.x=i.x,r.y=i.y,r.radius=this.props.pickingRadius}}this.layerManager&&(this.layerManager.context.mousePosition={x:r.x,y:r.y}),r.event=n},this._onEvent=n=>{const r=lr[n.type],i=n.offsetCenter;if(!r||!i||!this.layerManager)return;const o=this.layerManager.getLayers(),a=this.deckPicker.getLastPickedObject({x:i.x,y:i.y,layers:o,viewports:this.getViewports(i)},this._lastPointerDownInfo),{layer:c}=a,l=c&&(c[r]||c.props[r]),u=this.props[r];let h=!1;l&&(h=l.call(c,a,n)),h||(u?.(a,n),this.widgetManager.onEvent(a,n))},this._onPointerDown=n=>{if(this.device?.type==="webgpu")return;const r=n.offsetCenter,i=this._pick("pickObject","pickObject Time",{x:r.x,y:r.y,radius:this.props.pickingRadius});this._lastPointerDownInfo=i.result[0]||i.emptyInfo},this.props={...ml,...e},e=this.props,e.viewState&&e.initialViewState&&Y.warn("View state tracking is disabled. Use either `initialViewState` for auto update or `viewState` for manual update.")(),this.viewState=this.props.initialViewState,e.device&&(this.device=e.device);let t=this.device;!t&&e.gl&&(e.gl instanceof WebGLRenderingContext&&Y.error("WebGL1 context not supported.")(),t=Go.attach(e.gl)),t||(t=Gn.createDevice({type:"best-available",_reuseDevices:!0,adapters:[Go],...e.deviceProps,createCanvasContext:{canvas:this._createCanvas(e),useDevicePixels:this.props.useDevicePixels,autoResize:!1}})),this.animationLoop=this._createAnimationLoop(t,e),this.setProps(e),e._typedArrayManagerProps&&is.setOptions(e._typedArrayManagerProps),this.animationLoop.start()}finalize(){this.animationLoop?.stop(),this.animationLoop?.destroy(),this.animationLoop=null,this._lastPointerDownInfo=null,this.layerManager?.finalize(),this.layerManager=null,this.viewManager?.finalize(),this.viewManager=null,this.effectManager?.finalize(),this.effectManager=null,this.deckRenderer?.finalize(),this.deckRenderer=null,this.deckPicker?.finalize(),this.deckPicker=null,this.eventManager?.destroy(),this.eventManager=null,this.widgetManager?.finalize(),this.widgetManager=null,!this.props.canvas&&!this.props.device&&!this.props.gl&&this.canvas&&(this.canvas.parentElement?.removeChild(this.canvas),this.canvas=null)}setProps(e){this.stats.get("setProps Time").timeStart(),"onLayerHover"in e&&Y.removed("onLayerHover","onHover")(),"onLayerClick"in e&&Y.removed("onLayerClick","onClick")(),e.initialViewState&&!Re(this.props.initialViewState,e.initialViewState,3)&&(this.viewState=e.initialViewState),Object.assign(this.props,e),this._setCanvasSize(this.props);const t=Object.create(this.props);Object.assign(t,{views:this._getViews(),width:this.width,height:this.height,viewState:this._getViewState()}),this.animationLoop?.setProps(t),this.layerManager&&(this.viewManager.setProps(t),this.layerManager.activateViewport(this.getViewports()[0]),this.layerManager.setProps(t),this.effectManager.setProps(t),this.deckRenderer.setProps(t),this.deckPicker.setProps(t),this.widgetManager.setProps(t)),this.stats.get("setProps Time").timeEnd()}needsRedraw(e={clearRedrawFlags:!1}){if(!this.layerManager)return!1;if(this.props._animate)return"Deck._animate";let t=this._needsRedraw;e.clearRedrawFlags&&(this._needsRedraw=!1);const n=this.viewManager.needsRedraw(e),r=this.layerManager.needsRedraw(e),i=this.effectManager.needsRedraw(e),o=this.deckRenderer.needsRedraw(e);return t=t||n||r||i||o,t}redraw(e){if(!this.layerManager)return;let t=this.needsRedraw({clearRedrawFlags:!0});t=e||t,t&&(this.stats.get("Redraw Count").incrementCount(),this.props._customRender?this.props._customRender(t):this._drawLayers(t))}get isInitialized(){return this.viewManager!==null}getViews(){return ue(this.viewManager),this.viewManager.views}getViewports(e){return ue(this.viewManager),this.viewManager.getViewports(e)}getCanvas(){return this.canvas}pickObject(e){const t=this._pick("pickObject","pickObject Time",e).result;return t.length?t[0]:null}pickMultipleObjects(e){return e.depth=e.depth||10,this._pick("pickObject","pickMultipleObjects Time",e).result}pickObjects(e){return this._pick("pickObjects","pickObjects Time",e)}_addResources(e,t=!1){for(const n in e)this.layerManager.resourceManager.add({resourceId:n,data:e[n],forceUpdate:t})}_removeResources(e){for(const t of e)this.layerManager.resourceManager.remove(t)}_addDefaultEffect(e){this.effectManager.addDefaultEffect(e)}_addDefaultShaderModule(e){this.layerManager.addDefaultShaderModule(e)}_removeDefaultShaderModule(e){this.layerManager?.removeDefaultShaderModule(e)}_pick(e,t,n){ue(this.deckPicker);const{stats:r}=this;r.get("Pick Count").incrementCount(),r.get(t).timeStart();const i=this.deckPicker[e]({layers:this.layerManager.getLayers(n),views:this.viewManager.getViews(),viewports:this.getViewports(n),onViewportActive:this.layerManager.activateViewport,effects:this.effectManager.getEffects(),...n});return r.get(t).timeEnd(),i}_createCanvas(e){let t=e.canvas;return typeof t=="string"&&(t=document.getElementById(t),ue(t)),t||(t=document.createElement("canvas"),t.id=e.id||"deckgl-overlay",(e.parent||document.body).appendChild(t)),Object.assign(t.style,e.style),t}_setCanvasSize(e){if(!this.canvas)return;const{width:t,height:n}=e;if(t||t===0){const r=Number.isFinite(t)?`${t}px`:t;this.canvas.style.width=r}if(n||n===0){const r=Number.isFinite(n)?`${n}px`:n;this.canvas.style.position=e.style?.position||"absolute",this.canvas.style.height=r}}_updateCanvasSize(){const{canvas:e}=this;if(!e)return;const t=e.clientWidth??e.width,n=e.clientHeight??e.height;(t!==this.width||n!==this.height)&&(this.width=t,this.height=n,this.viewManager?.setProps({width:t,height:n}),this.layerManager?.activateViewport(this.getViewports()[0]),this.props.onResize({width:t,height:n}))}_createAnimationLoop(e,t){const{gl:n,onError:r,useDevicePixels:i}=t;return new Mm({device:e,useDevicePixels:i,autoResizeDrawingBuffer:!n,autoResizeViewport:!1,onInitialize:o=>this._setDevice(o.device),onRender:this._onRenderFrame.bind(this),onError:r})}_getViewState(){return this.props.viewState||this.viewState}_getViews(){const{views:e}=this.props,t=Array.isArray(e)?e:e?[e]:[new tl({id:"default-view"})];return t.length&&this.props.controller&&(t[0].props.controller=this.props.controller),t}_onContextLost(){const{onError:e}=this.props;this.animationLoop&&e&&e(new Error("WebGL context is lost"))}_pickAndCallback(){if(this.device?.type==="webgpu")return;const{_pickRequest:e}=this;if(e.event){const{result:t,emptyInfo:n}=this._pick("pickObject","pickObject Time",e);this.cursorState.isHovering=t.length>0;let r=n,i=!1;for(const o of t)r=o,i=o.layer?.onHover(o,e.event)||i;i||(this.props.onHover?.(r,e.event),this.widgetManager.onHover(r,e.event)),e.event=null}}_updateCursor(){const e=this.props.parent||this.canvas;e&&(e.style.cursor=this.props.getCursor(this.cursorState))}_setDevice(e){if(this.device=e,!this.animationLoop)return;this.canvas||(this.canvas=this.device.canvasContext?.canvas),this.device.type==="webgl"&&this.device.setParametersWebGL({blend:!0,blendFunc:[770,771,1,771],polygonOffsetFill:!0,depthTest:!0,depthFunc:515}),this.props.onDeviceInitialized(this.device),this.device.type==="webgl"&&this.props.onWebGLInitialized(this.device.gl);const t=new Yc;t.play(),this.animationLoop.attachTimeline(t),this.eventManager=new c_(this.props.parent||this.canvas,{touchAction:this.props.touchAction,recognizers:Object.keys(To).map(r=>{const[i,o,a,c]=To[r],l=this.props.eventRecognizerOptions?.[r],u={...o,...l,event:r};return{recognizer:new i(u),recognizeWith:a,requestFailure:c}}),events:{pointerdown:this._onPointerDown,pointermove:this._onPointerMove,pointerleave:this._onPointerMove}});for(const r in lr)this.eventManager.on(r,this._onEvent);this.viewManager=new tb({timeline:t,eventManager:this.eventManager,onViewStateChange:this._onViewStateChange.bind(this),onInteractionStateChange:this._onInteractionStateChange.bind(this),views:this._getViews(),viewState:this._getViewState(),width:this.width,height:this.height});const n=this.viewManager.getViewports()[0];this.layerManager=new eb(this.device,{deck:this,stats:this.stats,viewport:n,timeline:t}),this.effectManager=new bb({deck:this,device:this.device}),this.deckRenderer=new wb(this.device),this.deckPicker=new Rb(this.device),this.widgetManager=new Pb({deck:this,parentElement:this.canvas?.parentElement}),this.widgetManager.addDefault(new Ob),this.setProps(this.props),this._updateCanvasSize(),this.props.onLoad()}_drawLayers(e,t){const{device:n,gl:r}=this.layerManager.context;this.props.onBeforeRender({device:n,gl:r});const i={target:this.props._framebuffer,layers:this.layerManager.getLayers(),viewports:this.viewManager.getViewports(),onViewportActive:this.layerManager.activateViewport,views:this.viewManager.getViews(),pass:"screen",effects:this.effectManager.getEffects(),...t};this.deckRenderer?.renderLayers(i),i.pass==="screen"&&this.widgetManager.onRedraw({viewports:i.viewports,layers:i.layers}),this.props.onAfterRender({device:n,gl:r})}_onRenderFrame(){this._getFrameStats(),this._metricsCounter++%60===0&&(this._getMetrics(),this.stats.reset(),Y.table(4,this.metrics)(),this.props._onMetrics&&this.props._onMetrics(this.metrics)),this._updateCanvasSize(),this._updateCursor(),this.layerManager.updateLayers(),this.device?.type!=="webgpu"&&this._pickAndCallback(),this.redraw(),this.viewManager&&this.viewManager.updateViewStates()}_onViewStateChange(e){const t=this.props.onViewStateChange(e)||e.viewState;this.viewState&&(this.viewState={...this.viewState,[e.viewId]:t},this.props.viewState||this.viewManager&&this.viewManager.setProps({viewState:this.viewState}))}_onInteractionStateChange(e){this.cursorState.isDragging=e.isDragging||!1,this.props.onInteractionStateChange(e)}_getFrameStats(){const{stats:e}=this;e.get("frameRate").timeEnd(),e.get("frameRate").timeStart();const t=this.animationLoop.stats;e.get("GPU Time").addTime(t.get("GPU Time").lastTiming),e.get("CPU Time").addTime(t.get("CPU Time").lastTiming)}_getMetrics(){const{metrics:e,stats:t}=this;e.fps=t.get("frameRate").getHz(),e.setPropsTime=t.get("setProps Time").time,e.updateAttributesTime=t.get("Update Attributes").time,e.framesRedrawn=t.get("Redraw Count").count,e.pickTime=t.get("pickObject Time").time+t.get("pickMultipleObjects Time").time+t.get("pickObjects Time").time,e.pickCount=t.get("Pick Count").count,e.gpuTime=t.get("GPU Time").time,e.cpuTime=t.get("CPU Time").time,e.gpuTimePerFrame=t.get("GPU Time").getAverageTime(),e.cpuTimePerFrame=t.get("CPU Time").getAverageTime();const n=Gn.stats.get("Memory Usage");e.bufferMemory=n.get("Buffer Memory").count,e.textureMemory=n.get("Texture Memory").count,e.renderbufferMemory=n.get("Renderbuffer Memory").count,e.gpuMemory=n.get("GPU Memory").count}}bl.defaultProps=ml;bl.VERSION=ef;function PT(s){switch(s){case"float64":return Float64Array;case"uint8":case"unorm8":return Uint8ClampedArray;default:return Qa(s)}}const MT=Za;function Es(s,e,t){const n=t==="webgpu"&&e.type==="uint8"?"unorm8":e.type;return{attribute:s,format:e.size>1?`${n}x${e.size}`:e.type,byteOffset:e.offset||0}}function st(s){return s.stride||s.size*s.bytesPerElement}function OT(s,e){return s.type===e.type&&s.size===e.size&&st(s)===st(e)&&(s.offset||0)===(e.offset||0)}function yr(s,e){e.offset&&Y.removed("shaderAttribute.offset","vertexOffset, elementOffset")();const t=st(s),n=e.vertexOffset!==void 0?e.vertexOffset:s.vertexOffset||0,r=e.elementOffset||0,i=n*t+r*s.bytesPerElement+(s.offset||0);return{...e,offset:i,stride:t}}function kT(s,e){const t=yr(s,e);return{high:t,low:{...t,offset:t.offset+s.size*4}}}class NT{constructor(e,t,n){this._buffer=null,this.device=e,this.id=t.id||"",this.size=t.size||1;const r=t.logicalType||t.type,i=r==="float64";let{defaultValue:o}=t;o=Number.isFinite(o)?[o]:o||new Array(this.size).fill(0);let a;i?a="float32":!r&&t.isIndexed?a="uint32":a=r||"float32";let c=PT(r||a);this.doublePrecision=i,i&&t.fp64===!1&&(c=Float32Array),this.value=null,this.settings={...t,defaultType:c,defaultValue:o,logicalType:r,type:a,normalized:a.includes("norm"),size:this.size,bytesPerElement:c.BYTES_PER_ELEMENT},this.state={...n,externalBuffer:null,bufferAccessor:this.settings,allocatedValue:null,numInstances:0,bounds:null,constant:!1}}get isConstant(){return this.state.constant}get buffer(){return this._buffer}get byteOffset(){const e=this.getAccessor();return e.vertexOffset?e.vertexOffset*st(e):0}get numInstances(){return this.state.numInstances}set numInstances(e){this.state.numInstances=e}delete(){this._buffer&&(this._buffer.delete(),this._buffer=null),is.release(this.state.allocatedValue)}getBuffer(){return this.state.constant?null:this.state.externalBuffer||this._buffer}getValue(e=this.id,t=null){const n={};if(this.state.constant){const r=this.value;if(t){const i=yr(this.getAccessor(),t),o=i.offset/r.BYTES_PER_ELEMENT,a=i.size||this.size;n[e]=r.subarray(o,o+a)}else n[e]=r}else n[e]=this.getBuffer();return this.doublePrecision&&(this.value instanceof Float64Array?n[`${e}64Low`]=n[e]:n[`${e}64Low`]=new Float32Array(this.size)),n}_getBufferLayout(e=this.id,t=null){const n=this.getAccessor(),r=[],i={name:this.id,byteStride:st(n),attributes:r};if(this.doublePrecision){const o=kT(n,t||{});r.push(Es(e,{...n,...o.high},this.device.type),Es(`${e}64Low`,{...n,...o.low},this.device.type))}else if(t){const o=yr(n,t);r.push(Es(e,{...n,...o},this.device.type))}else r.push(Es(e,n,this.device.type));return i}setAccessor(e){this.state.bufferAccessor=e}getAccessor(){return this.state.bufferAccessor}getBounds(){if(this.state.bounds)return this.state.bounds;let e=null;if(this.state.constant&&this.value){const t=Array.from(this.value);e=[t,t]}else{const{value:t,numInstances:n,size:r}=this,i=n*r;if(t&&i&&t.length>=i){const o=new Array(r).fill(1/0),a=new Array(r).fill(-1/0);for(let c=0;c<i;)for(let l=0;l<r;l++){const u=t[c++];u<o[l]&&(o[l]=u),u>a[l]&&(a[l]=u)}e=[o,a]}}return this.state.bounds=e,e}setData(e){const{state:t}=this;let n;ArrayBuffer.isView(e)?n={value:e}:e instanceof q?n={buffer:e}:n=e;const r={...this.settings,...n};if(ArrayBuffer.isView(n.value)){if(!n.type)if(this.doublePrecision&&n.value instanceof Float64Array)r.type="float32";else{const o=MT(n.value);r.type=r.normalized?o.replace("int","norm"):o}r.bytesPerElement=n.value.BYTES_PER_ELEMENT,r.stride=st(r)}if(t.bounds=null,n.constant){let i=n.value;if(i=this._normalizeValue(i,[],0),this.settings.normalized&&(i=this.normalizeConstant(i)),!(!t.constant||!this._areValuesEqual(i,this.value)))return!1;t.externalBuffer=null,t.constant=!0,this.value=ArrayBuffer.isView(i)?i:new Float32Array(i)}else if(n.buffer){const i=n.buffer;t.externalBuffer=i,t.constant=!1,this.value=n.value||null}else if(n.value){this._checkExternalBuffer(n);let i=n.value;t.externalBuffer=null,t.constant=!1,this.value=i;let{buffer:o}=this;const a=st(r),c=(r.vertexOffset||0)*a;if(this.doublePrecision&&i instanceof Float64Array&&(i=Nn(i,r)),this.settings.isIndexed){const u=this.settings.defaultType;i.constructor!==u&&(i=new u(i))}const l=i.byteLength+c+a*2;(!o||o.byteLength<l)&&(o=this._createBuffer(l)),o.write(i,c)}return this.setAccessor(r),!0}updateSubBuffer(e={}){this.state.bounds=null;const t=this.value,{startOffset:n=0,endOffset:r}=e;this.buffer.write(this.doublePrecision&&t instanceof Float64Array?Nn(t,{size:this.size,startIndex:n,endIndex:r}):t.subarray(n,r),n*t.BYTES_PER_ELEMENT+this.byteOffset)}allocate(e,t=!1){const{state:n}=this,r=n.allocatedValue,i=is.allocate(r,e+1,{size:this.size,type:this.settings.defaultType,copy:t});this.value=i;const{byteOffset:o}=this;let{buffer:a}=this;return(!a||a.byteLength<i.byteLength+o)&&(a=this._createBuffer(i.byteLength+o),t&&r&&a.write(r instanceof Float64Array?Nn(r,this):r,o)),n.allocatedValue=i,n.constant=!1,n.externalBuffer=null,this.setAccessor(this.settings),!0}_checkExternalBuffer(e){const{value:t}=e;if(!ArrayBuffer.isView(t))throw new Error(`Attribute ${this.id} value is not TypedArray`);const n=this.settings.defaultType;let r=!1;if(this.doublePrecision&&(r=t.BYTES_PER_ELEMENT<4),r)throw new Error(`Attribute ${this.id} does not support ${t.constructor.name}`);!(t instanceof n)&&this.settings.normalized&&!("normalized"in e)&&Y.warn(`Attribute ${this.id} is normalized`)()}normalizeConstant(e){switch(this.settings.type){case"snorm8":return new Float32Array(e).map(t=>(t+128)/255*2-1);case"snorm16":return new Float32Array(e).map(t=>(t+32768)/65535*2-1);case"unorm8":return new Float32Array(e).map(t=>t/255);case"unorm16":return new Float32Array(e).map(t=>t/65535);default:return e}}_normalizeValue(e,t,n){const{defaultValue:r,size:i}=this.settings;if(Number.isFinite(e))return t[n]=e,t;if(!e){let o=i;for(;--o>=0;)t[n+o]=r[o];return t}switch(i){case 4:t[n+3]=Number.isFinite(e[3])?e[3]:r[3];case 3:t[n+2]=Number.isFinite(e[2])?e[2]:r[2];case 2:t[n+1]=Number.isFinite(e[1])?e[1]:r[1];case 1:t[n+0]=Number.isFinite(e[0])?e[0]:r[0];break;default:let o=i;for(;--o>=0;)t[n+o]=Number.isFinite(e[o])?e[o]:r[o]}return t}_areValuesEqual(e,t){if(!e||!t)return!1;const{size:n}=this;for(let r=0;r<n;r++)if(e[r]!==t[r])return!1;return!0}_createBuffer(e){this._buffer&&this._buffer.destroy();const{isIndexed:t,type:n}=this.settings;return this._buffer=this.device.createBuffer({...this._buffer?.props,id:this.id,usage:(t?q.INDEX:q.VERTEX)|q.COPY_DST,indexType:t?n:void 0,byteLength:e}),this._buffer}}const ea=[],ta=[];function DT(s,e=0,t=1/0){let n=ea;const r={index:-1,data:s,target:[]};return s?typeof s[Symbol.iterator]=="function"?n=s:s.length>0&&(ta.length=s.length,n=ta):n=ea,(e>0||Number.isFinite(t))&&(n=(Array.isArray(n)?n:Array.from(n)).slice(e,t),r.index=e-1),{iterable:n,objectInfo:r}}function yl(s){return s&&s[Symbol.asyncIterator]}function FT(s,e){const{size:t,stride:n,offset:r,startIndices:i,nested:o}=e,a=s.BYTES_PER_ELEMENT,c=n?n/a:t,l=r?r/a:0,u=Math.floor((s.length-l)/c);return(h,{index:f,target:g})=>{if(!i){const S=f*c+l;for(let I=0;I<t;I++)g[I]=s[S+I];return g}const _=i[f],w=i[f+1]||u;let A;if(o){A=new Array(w-_);for(let S=_;S<w;S++){const I=S*c+l;g=new Array(t);for(let x=0;x<t;x++)g[x]=s[I+x];A[S-_]=g}}else if(c===t)A=s.subarray(_*t+l,w*t+l);else{A=new s.constructor((w-_)*t);let S=0;for(let I=_;I<w;I++){const x=I*c+l;for(let E=0;E<t;E++)A[S++]=s[x+E]}}return A}}const BT=[],Ms=[[0,1/0]];function UT(s,e){if(s===Ms||(e[0]<0&&(e[0]=0),e[0]>=e[1]))return s;const t=[],n=s.length;let r=0;for(let i=0;i<n;i++){const o=s[i];o[1]<e[0]?(t.push(o),r=i+1):o[0]>e[1]?t.push(o):e=[Math.min(o[0],e[0]),Math.max(o[1],e[1])]}return t.splice(r,0,e),t}const LT={interpolation:{duration:0,easing:s=>s},spring:{stiffness:.05,damping:.5}};function Tl(s,e){if(!s)return null;Number.isFinite(s)&&(s={type:"interpolation",duration:s});const t=s.type||"interpolation";return{...LT[t],...e,...s,type:t}}class wl extends NT{constructor(e,t){super(e,t,{startIndices:null,lastExternalBuffer:null,binaryValue:null,binaryAccessor:null,needsUpdate:!0,needsRedraw:!1,layoutChanged:!1,updateRanges:Ms}),this.constant=!1,this.settings.update=t.update||(t.accessor?this._autoUpdater:void 0),Object.seal(this.settings),Object.seal(this.state),this._validateAttributeUpdaters()}get startIndices(){return this.state.startIndices}set startIndices(e){this.state.startIndices=e}needsUpdate(){return this.state.needsUpdate}needsRedraw({clearChangedFlags:e=!1}={}){const t=this.state.needsRedraw;return this.state.needsRedraw=t&&!e,t}layoutChanged(){return this.state.layoutChanged}setAccessor(e){var t;(t=this.state).layoutChanged||(t.layoutChanged=!OT(e,this.getAccessor())),super.setAccessor(e)}getUpdateTriggers(){const{accessor:e}=this.settings;return[this.id].concat(typeof e!="function"&&e||[])}supportsTransition(){return!!this.settings.transition}getTransitionSetting(e){if(!e||!this.supportsTransition())return null;const{accessor:t}=this.settings,n=this.settings.transition,r=Array.isArray(t)?e[t.find(i=>e[i])]:e[t];return Tl(r,n)}setNeedsUpdate(e=this.id,t){if(this.state.needsUpdate=this.state.needsUpdate||e,this.setNeedsRedraw(e),t){const{startRow:n=0,endRow:r=1/0}=t;this.state.updateRanges=UT(this.state.updateRanges,[n,r])}else this.state.updateRanges=Ms}clearNeedsUpdate(){this.state.needsUpdate=!1,this.state.updateRanges=BT}setNeedsRedraw(e=this.id){this.state.needsRedraw=this.state.needsRedraw||e}allocate(e){const{state:t,settings:n}=this;return n.noAlloc?!1:n.update?(super.allocate(e,t.updateRanges!==Ms),!0):!1}updateBuffer({numInstances:e,data:t,props:n,context:r}){if(!this.needsUpdate())return!1;const{state:{updateRanges:i},settings:{update:o,noAlloc:a}}=this;let c=!0;if(o){for(const[l,u]of i)o.call(r,this,{data:t,startRow:l,endRow:u,props:n,numInstances:e});if(this.value)if(this.constant||!this.buffer||this.buffer.byteLength<this.value.byteLength+this.byteOffset)this.setData({value:this.value,constant:this.constant}),this.constant=!1;else for(const[l,u]of i){const h=Number.isFinite(l)?this.getVertexOffset(l):0,f=Number.isFinite(u)?this.getVertexOffset(u):a||!Number.isFinite(e)?this.value.length:e*this.size;super.updateSubBuffer({startOffset:h,endOffset:f})}this._checkAttributeArray()}else c=!1;return this.clearNeedsUpdate(),this.setNeedsRedraw(),c}setConstantValue(e){return this.device.type==="webgpu"||e===void 0||typeof e=="function"?!1:(this.setData({constant:!0,value:e})&&this.setNeedsRedraw(),this.clearNeedsUpdate(),!0)}setExternalBuffer(e){const{state:t}=this;return e?(this.clearNeedsUpdate(),t.lastExternalBuffer===e||(t.lastExternalBuffer=e,this.setNeedsRedraw(),this.setData(e)),!0):(t.lastExternalBuffer=null,!1)}setBinaryValue(e,t=null){const{state:n,settings:r}=this;if(!e)return n.binaryValue=null,n.binaryAccessor=null,!1;if(r.noAlloc)return!1;if(n.binaryValue===e)return this.clearNeedsUpdate(),!0;if(n.binaryValue=e,this.setNeedsRedraw(),r.transform||t!==this.startIndices){ArrayBuffer.isView(e)&&(e={value:e});const o=e;ue(ArrayBuffer.isView(o.value),`invalid ${r.accessor}`);const a=!!o.size&&o.size!==this.size;return n.binaryAccessor=FT(o.value,{size:o.size||this.size,stride:o.stride,offset:o.offset,startIndices:t,nested:a}),!1}return this.clearNeedsUpdate(),this.setData(e),!0}getVertexOffset(e){const{startIndices:t}=this;return(t?e<t.length?t[e]:this.numInstances:e)*this.size}getValue(){const e=this.settings.shaderAttributes,t=super.getValue();if(!e)return t;for(const n in e)Object.assign(t,super.getValue(n,e[n]));return t}getBufferLayout(e){this.state.layoutChanged=!1;const t=this.settings.shaderAttributes,n=super._getBufferLayout(),{stepMode:r}=this.settings;if(r==="dynamic"?n.stepMode=e?e.isInstanced?"instance":"vertex":"instance":n.stepMode=r??"vertex",!t)return n;for(const i in t){const o=super._getBufferLayout(i,t[i]);n.attributes.push(...o.attributes)}return n}_autoUpdater(e,{data:t,startRow:n,endRow:r,props:i,numInstances:o}){if(e.constant&&this.context.device.type!=="webgpu")return;const{settings:a,state:c,value:l,size:u,startIndices:h}=e,{accessor:f,transform:g}=a;let _=c.binaryAccessor||(typeof f=="function"?f:i[f]);typeof _!="function"&&(_=()=>_),ue(typeof _=="function",`accessor "${f}" is not a function`);let w=e.getVertexOffset(n);const{iterable:A,objectInfo:S}=DT(t,n,r);for(const I of A){S.index++;let x=_(I,S);if(g&&(x=g.call(this,x)),h){const E=(S.index<h.length-1?h[S.index+1]:o)-h[S.index];if(x&&Array.isArray(x[0])){let P=w;for(const M of x)e._normalizeValue(M,l,P),P+=u}else x&&x.length>u?l.set(x,w):(e._normalizeValue(x,S.target,0),Km({target:l,source:S.target,start:w,count:E}));w+=E*u}else e._normalizeValue(x,l,w),w+=u}}_validateAttributeUpdaters(){const{settings:e}=this;if(!(e.noAlloc||typeof e.update=="function"))throw new Error(`Attribute ${this.id} missing update or accessor`)}_checkAttributeArray(){const{value:e}=this,t=Math.min(4,this.size);if(e&&e.length>=t){let n=!0;switch(t){case 4:n=n&&Number.isFinite(e[3]);case 3:n=n&&Number.isFinite(e[2]);case 2:n=n&&Number.isFinite(e[1]);case 1:n=n&&Number.isFinite(e[0]);break;default:n=!1}if(!n)throw new Error(`Illegal attribute generated for ${this.id}`)}}}function Hn(s){const{source:e,target:t,start:n=0,size:r,getData:i}=s,o=s.end||t.length,a=e.length,c=o-n;if(a>c){t.set(e.subarray(0,c),n);return}if(t.set(e,n),!i)return;let l=a;for(;l<c;){const u=i(l,e);for(let h=0;h<r;h++)t[n+l]=u[h]||0,l++}}function VT({source:s,target:e,size:t,getData:n,sourceStartIndices:r,targetStartIndices:i}){if(!r||!i)return Hn({source:s,target:e,size:t,getData:n}),e;let o=0,a=0;const c=n&&((u,h)=>n(u+a,h)),l=Math.min(r.length,i.length);for(let u=1;u<l;u++){const h=r[u]*t,f=i[u]*t;Hn({source:s.subarray(o,h),target:e,start:a,end:f,size:t,getData:c}),o=h,a=f}return a<e.length&&Hn({source:[],target:e,start:a,size:t,getData:c}),e}function $T(s){const{device:e,settings:t,value:n}=s,r=new wl(e,t);return r.setData({value:n instanceof Float64Array?new Float64Array(0):new Float32Array(0),normalized:t.normalized}),r}function vl(s){switch(s){case 1:return"float";case 2:return"vec2";case 3:return"vec3";case 4:return"vec4";default:throw new Error(`No defined attribute type for size "${s}"`)}}function Al(s){switch(s){case 1:return"float32";case 2:return"float32x2";case 3:return"float32x3";case 4:return"float32x4";default:throw new Error("invalid type size")}}function xl(s){s.push(s.shift())}function WT(s,e){const{doublePrecision:t,settings:n,value:r,size:i}=s,o=t&&r instanceof Float64Array?2:1;let a=0;const{shaderAttributes:c}=s.settings;if(c)for(const l of Object.values(c))a=Math.max(a,l.vertexOffset??0);return(n.noAlloc?r.length:(e+a)*i)*o}function El({device:s,source:e,target:t}){return(!t||t.byteLength<e.byteLength)&&(t?.destroy(),t=s.createBuffer({byteLength:e.byteLength,usage:e.usage})),t}function Sl({device:s,buffer:e,attribute:t,fromLength:n,toLength:r,fromStartIndices:i,getData:o=a=>a}){const a=t.doublePrecision&&t.value instanceof Float64Array?2:1,c=t.size*a,l=t.byteOffset,u=t.settings.bytesPerElement<4?l/t.settings.bytesPerElement*4:l,h=t.startIndices,f=i&&h,g=t.isConstant;if(!f&&e&&n>=r)return e;const _=t.value instanceof Float64Array?Float32Array:t.value.constructor,w=g?t.value:new _(t.getBuffer().readSyncWebGL(l,r*_.BYTES_PER_ELEMENT).buffer);if(t.settings.normalized&&!g){const x=o;o=(E,P)=>t.normalizeConstant(x(E,P))}const A=g?(x,E)=>o(w,E):(x,E)=>o(w.subarray(x+l,x+l+c),E),S=e?new Float32Array(e.readSyncWebGL(u,n*4).buffer):new Float32Array(0),I=new Float32Array(r);return VT({source:S,target:I,sourceStartIndices:i,targetStartIndices:h,size:c,getData:A}),(!e||e.byteLength<I.byteLength+u)&&(e?.destroy(),e=s.createBuffer({byteLength:I.byteLength+u,usage:35050})),e.write(I,u),e}class Rl{constructor({device:e,attribute:t,timeline:n}){this.buffers=[],this.currentLength=0,this.device=e,this.transition=new un(n),this.attribute=t,this.attributeInTransition=$T(t),this.currentStartIndices=t.startIndices}get inProgress(){return this.transition.inProgress}start(e,t,n=1/0){this.settings=e,this.currentStartIndices=this.attribute.startIndices,this.currentLength=WT(this.attribute,t),this.transition.start({...e,duration:n})}update(){const e=this.transition.update();return e&&this.onUpdate(),e}setBuffer(e){this.attributeInTransition.setData({buffer:e,normalized:this.attribute.settings.normalized,value:this.attributeInTransition.value})}cancel(){this.transition.cancel()}delete(){this.cancel();for(const e of this.buffers)e.destroy();this.buffers.length=0}}class jT extends Rl{constructor({device:e,attribute:t,timeline:n}){super({device:e,attribute:t,timeline:n}),this.type="interpolation",this.transform=YT(e,t)}start(e,t){const n=this.currentLength,r=this.currentStartIndices;if(super.start(e,t,e.duration),e.duration<=0){this.transition.cancel();return}const{buffers:i,attribute:o}=this;xl(i),i[0]=Sl({device:this.device,buffer:i[0],attribute:o,fromLength:n,toLength:this.currentLength,fromStartIndices:r,getData:e.enter}),i[1]=El({device:this.device,source:i[0],target:i[1]}),this.setBuffer(i[1]);const{transform:a}=this,c=a.model;let l=Math.floor(this.currentLength/o.size);Il(o)&&(l/=2),c.setVertexCount(l),o.isConstant?(c.setAttributes({aFrom:i[0]}),c.setConstantAttributes({aTo:o.value})):c.setAttributes({aFrom:i[0],aTo:o.getBuffer()}),a.transformFeedback.setBuffers({vCurrent:i[1]})}onUpdate(){const{duration:e,easing:t}=this.settings,{time:n}=this.transition;let r=n/e;t&&(r=t(r));const{model:i}=this.transform,o={time:r};i.shaderInputs.setProps({interpolation:o}),this.transform.run({discard:!0})}delete(){super.delete(),this.transform.destroy()}}const HT=`uniform interpolationUniforms {
  float time;
} interpolation;
`,sa={name:"interpolation",vs:HT,uniformTypes:{time:"f32"}},zT=`#version 300 es
#define SHADER_NAME interpolation-transition-vertex-shader

in ATTRIBUTE_TYPE aFrom;
in ATTRIBUTE_TYPE aTo;
out ATTRIBUTE_TYPE vCurrent;

void main(void) {
  vCurrent = mix(aFrom, aTo, interpolation.time);
  gl_Position = vec4(0.0);
}
`,XT=`#version 300 es
#define SHADER_NAME interpolation-transition-vertex-shader

in ATTRIBUTE_TYPE aFrom;
in ATTRIBUTE_TYPE aFrom64Low;
in ATTRIBUTE_TYPE aTo;
in ATTRIBUTE_TYPE aTo64Low;
out ATTRIBUTE_TYPE vCurrent;
out ATTRIBUTE_TYPE vCurrent64Low;

vec2 mix_fp64(vec2 a, vec2 b, float x) {
  vec2 range = sub_fp64(b, a);
  return sum_fp64(a, mul_fp64(range, vec2(x, 0.0)));
}

void main(void) {
  for (int i=0; i<ATTRIBUTE_SIZE; i++) {
    vec2 value = mix_fp64(vec2(aFrom[i], aFrom64Low[i]), vec2(aTo[i], aTo64Low[i]), interpolation.time);
    vCurrent[i] = value.x;
    vCurrent64Low[i] = value.y;
  }
  gl_Position = vec4(0.0);
}
`;function Il(s){return s.doublePrecision&&s.value instanceof Float64Array}function YT(s,e){const t=e.size,n=vl(t),r=Al(t),i=e.getBufferLayout();return Il(e)?new Bt(s,{vs:XT,bufferLayout:[{name:"aFrom",byteStride:8*t,attributes:[{attribute:"aFrom",format:r,byteOffset:0},{attribute:"aFrom64Low",format:r,byteOffset:4*t}]},{name:"aTo",byteStride:8*t,attributes:[{attribute:"aTo",format:r,byteOffset:0},{attribute:"aTo64Low",format:r,byteOffset:4*t}]}],modules:[og,sa],defines:{ATTRIBUTE_TYPE:n,ATTRIBUTE_SIZE:t},moduleSettings:{},varyings:["vCurrent","vCurrent64Low"],bufferMode:35980,disableWarnings:!0}):new Bt(s,{vs:zT,bufferLayout:[{name:"aFrom",format:r},{name:"aTo",format:i.attributes[0].format}],modules:[sa],defines:{ATTRIBUTE_TYPE:n},varyings:["vCurrent"],disableWarnings:!0})}class qT extends Rl{constructor({device:e,attribute:t,timeline:n}){super({device:e,attribute:t,timeline:n}),this.type="spring",this.texture=e3(e),this.framebuffer=t3(e,this.texture),this.transform=GT(e,t)}start(e,t){const n=this.currentLength,r=this.currentStartIndices;super.start(e,t);const{buffers:i,attribute:o}=this;for(let c=0;c<2;c++)i[c]=Sl({device:this.device,buffer:i[c],attribute:o,fromLength:n,toLength:this.currentLength,fromStartIndices:r,getData:e.enter});i[2]=El({device:this.device,source:i[0],target:i[2]}),this.setBuffer(i[1]);const{model:a}=this.transform;a.setVertexCount(Math.floor(this.currentLength/o.size)),o.isConstant?a.setConstantAttributes({aTo:o.value}):a.setAttributes({aTo:o.getBuffer()})}onUpdate(){const{buffers:e,transform:t,framebuffer:n,transition:r}=this,i=this.settings;t.model.setAttributes({aPrev:e[0],aCur:e[1]}),t.transformFeedback.setBuffers({vNext:e[2]});const o={stiffness:i.stiffness,damping:i.damping};t.model.shaderInputs.setProps({spring:o}),t.run({framebuffer:n,discard:!1,parameters:{viewport:[0,0,1,1]},clearColor:[0,0,0,0]}),xl(e),this.setBuffer(e[1]),this.device.readPixelsToArrayWebGL(n)[0]>0||r.end()}delete(){super.delete(),this.transform.destroy(),this.texture.destroy(),this.framebuffer.destroy()}}const KT=`uniform springUniforms {
  float damping;
  float stiffness;
} spring;
`,ZT={name:"spring",vs:KT,uniformTypes:{damping:"f32",stiffness:"f32"}},QT=`#version 300 es
#define SHADER_NAME spring-transition-vertex-shader

#define EPSILON 0.00001

in ATTRIBUTE_TYPE aPrev;
in ATTRIBUTE_TYPE aCur;
in ATTRIBUTE_TYPE aTo;
out ATTRIBUTE_TYPE vNext;
out float vIsTransitioningFlag;

ATTRIBUTE_TYPE getNextValue(ATTRIBUTE_TYPE cur, ATTRIBUTE_TYPE prev, ATTRIBUTE_TYPE dest) {
  ATTRIBUTE_TYPE velocity = cur - prev;
  ATTRIBUTE_TYPE delta = dest - cur;
  ATTRIBUTE_TYPE force = delta * spring.stiffness;
  ATTRIBUTE_TYPE resistance = velocity * spring.damping;
  return force - resistance + velocity + cur;
}

void main(void) {
  bool isTransitioning = length(aCur - aPrev) > EPSILON || length(aTo - aCur) > EPSILON;
  vIsTransitioningFlag = isTransitioning ? 1.0 : 0.0;

  vNext = getNextValue(aCur, aPrev, aTo);
  gl_Position = vec4(0, 0, 0, 1);
  gl_PointSize = 100.0;
}
`,JT=`#version 300 es
#define SHADER_NAME spring-transition-is-transitioning-fragment-shader

in float vIsTransitioningFlag;

out vec4 fragColor;

void main(void) {
  if (vIsTransitioningFlag == 0.0) {
    discard;
  }
  fragColor = vec4(1.0);
}`;function GT(s,e){const t=vl(e.size),n=Al(e.size);return new Bt(s,{vs:QT,fs:JT,bufferLayout:[{name:"aPrev",format:n},{name:"aCur",format:n},{name:"aTo",format:e.getBufferLayout().attributes[0].format}],varyings:["vNext"],modules:[ZT],defines:{ATTRIBUTE_TYPE:t},parameters:{depthCompare:"always",blendColorOperation:"max",blendColorSrcFactor:"one",blendColorDstFactor:"one",blendAlphaOperation:"max",blendAlphaSrcFactor:"one",blendAlphaDstFactor:"one"}})}function e3(s){return s.createTexture({data:new Uint8Array(4),format:"rgba8unorm",mipmaps:!1,width:1,height:1})}function t3(s,e){return s.createFramebuffer({id:"spring-transition-is-transitioning-framebuffer",width:1,height:1,colorAttachments:[e]})}const s3={interpolation:jT,spring:qT};class n3{constructor(e,{id:t,timeline:n}){if(!e)throw new Error("AttributeTransitionManager is constructed without device");this.id=t,this.device=e,this.timeline=n,this.transitions={},this.needsRedraw=!1,this.numInstances=1}finalize(){for(const e in this.transitions)this._removeTransition(e)}update({attributes:e,transitions:t,numInstances:n}){this.numInstances=n||1;for(const r in e){const i=e[r],o=i.getTransitionSetting(t);o&&this._updateAttribute(r,i,o)}for(const r in this.transitions){const i=e[r];(!i||!i.getTransitionSetting(t))&&this._removeTransition(r)}}hasAttribute(e){const t=this.transitions[e];return t&&t.inProgress}getAttributes(){const e={};for(const t in this.transitions){const n=this.transitions[t];n.inProgress&&(e[t]=n.attributeInTransition)}return e}run(){if(this.numInstances===0)return!1;for(const t in this.transitions)this.transitions[t].update()&&(this.needsRedraw=!0);const e=this.needsRedraw;return this.needsRedraw=!1,e}_removeTransition(e){this.transitions[e].delete(),delete this.transitions[e]}_updateAttribute(e,t,n){const r=this.transitions[e];let i=!r||r.type!==n.type;if(i){r&&this._removeTransition(e);const o=s3[n.type];o?this.transitions[e]=new o({attribute:t,timeline:this.timeline,device:this.device}):(Y.error(`unsupported transition type '${n.type}'`)(),i=!1)}(i||t.needsRedraw())&&(this.needsRedraw=!0,this.transitions[e].start(n,this.numInstances))}}const na="attributeManager.invalidate",r3="attributeManager.updateStart",i3="attributeManager.updateEnd",o3="attribute.updateStart",a3="attribute.allocate",c3="attribute.updateEnd";class l3{constructor(e,{id:t="attribute-manager",stats:n,timeline:r}={}){this.mergeBoundsMemoized=us(bm),this.id=t,this.device=e,this.attributes={},this.updateTriggers={},this.needsRedraw=!0,this.userData={},this.stats=n,this.attributeTransitionManager=new n3(e,{id:`${t}-transitions`,timeline:r}),Object.seal(this)}finalize(){for(const e in this.attributes)this.attributes[e].delete();this.attributeTransitionManager.finalize()}getNeedsRedraw(e={clearRedrawFlags:!1}){const t=this.needsRedraw;return this.needsRedraw=this.needsRedraw&&!e.clearRedrawFlags,t&&this.id}setNeedsRedraw(){this.needsRedraw=!0}add(e){this._add(e)}addInstanced(e){this._add(e,{stepMode:"instance"})}remove(e){for(const t of e)this.attributes[t]!==void 0&&(this.attributes[t].delete(),delete this.attributes[t])}invalidate(e,t){const n=this._invalidateTrigger(e,t);fe(na,this,e,n)}invalidateAll(e){for(const t in this.attributes)this.attributes[t].setNeedsUpdate(t,e);fe(na,this,"all")}update({data:e,numInstances:t,startIndices:n=null,transitions:r,props:i={},buffers:o={},context:a={}}){let c=!1;fe(r3,this),this.stats&&this.stats.get("Update Attributes").timeStart();for(const l in this.attributes){const u=this.attributes[l],h=u.settings.accessor;u.startIndices=n,u.numInstances=t,i[l]&&Y.removed(`props.${l}`,`data.attributes.${l}`)(),u.setExternalBuffer(o[l])||u.setBinaryValue(typeof h=="string"?o[h]:void 0,e.startIndices)||typeof h=="string"&&!o[h]&&u.setConstantValue(i[h])||u.needsUpdate()&&(c=!0,this._updateAttribute({attribute:u,numInstances:t,data:e,props:i,context:a})),this.needsRedraw=this.needsRedraw||u.needsRedraw()}c&&fe(i3,this,t),this.stats&&this.stats.get("Update Attributes").timeEnd(),this.attributeTransitionManager.update({attributes:this.attributes,numInstances:t,transitions:r})}updateTransition(){const{attributeTransitionManager:e}=this,t=e.run();return this.needsRedraw=this.needsRedraw||t,t}getAttributes(){return{...this.attributes,...this.attributeTransitionManager.getAttributes()}}getBounds(e){const t=e.map(n=>this.attributes[n]?.getBounds());return this.mergeBoundsMemoized(t)}getChangedAttributes(e={clearChangedFlags:!1}){const{attributes:t,attributeTransitionManager:n}=this,r={...n.getAttributes()};for(const i in t){const o=t[i];o.needsRedraw(e)&&!n.hasAttribute(i)&&(r[i]=o)}return r}getBufferLayouts(e){return Object.values(this.getAttributes()).map(t=>t.getBufferLayout(e))}_add(e,t){for(const n in e){const r=e[n],i={...r,id:n,size:r.isIndexed&&1||r.size||1,...t};this.attributes[n]=new wl(this.device,i)}this._mapUpdateTriggersToAttributes()}_mapUpdateTriggersToAttributes(){const e={};for(const t in this.attributes)this.attributes[t].getUpdateTriggers().forEach(r=>{e[r]||(e[r]=[]),e[r].push(t)});this.updateTriggers=e}_invalidateTrigger(e,t){const{attributes:n,updateTriggers:r}=this,i=r[e];return i&&i.forEach(o=>{const a=n[o];a&&a.setNeedsUpdate(a.id,t)}),i}_updateAttribute(e){const{attribute:t,numInstances:n}=e;if(fe(o3,t),t.constant){t.setConstantValue(t.value);return}t.allocate(n)&&fe(a3,t,n),t.updateBuffer(e)&&(this.needsRedraw=!0,fe(c3,t,n))}}class u3 extends un{get value(){return this._value}_onUpdate(){const{time:e,settings:{fromValue:t,toValue:n,duration:r,easing:i}}=this,o=i(e/r);this._value=Hs(t,n,o)}}const ra=1e-5;function ia(s,e,t,n,r){const i=e-s,a=(t-e)*r,c=-i*n;return a+c+i+e}function h3(s,e,t,n,r){if(Array.isArray(t)){const i=[];for(let o=0;o<t.length;o++)i[o]=ia(s[o],e[o],t[o],n,r);return i}return ia(s,e,t,n,r)}function oa(s,e){if(Array.isArray(s)){let t=0;for(let n=0;n<s.length;n++){const r=s[n]-e[n];t+=r*r}return Math.sqrt(t)}return Math.abs(s-e)}class f3 extends un{get value(){return this._currValue}_onUpdate(){const{fromValue:e,toValue:t,damping:n,stiffness:r}=this.settings,{_prevValue:i=e,_currValue:o=e}=this;let a=h3(i,o,t,n,r);const c=oa(a,t),l=oa(a,o);c<ra&&l<ra&&(a=t,this.end()),this._prevValue=o,this._currValue=a}}const d3={interpolation:u3,spring:f3};class p3{constructor(e){this.transitions=new Map,this.timeline=e}get active(){return this.transitions.size>0}add(e,t,n,r){const{transitions:i}=this;if(i.has(e)){const c=i.get(e),{value:l=c.settings.fromValue}=c;t=l,this.remove(e)}if(r=Tl(r),!r)return;const o=d3[r.type];if(!o){Y.error(`unsupported transition type '${r.type}'`)();return}const a=new o(this.timeline);a.start({...r,fromValue:t,toValue:n}),i.set(e,a)}remove(e){const{transitions:t}=this;t.has(e)&&(t.get(e).cancel(),t.delete(e))}update(){const e={};for(const[t,n]of this.transitions)n.update(),e[t]=n.value,n.inProgress||this.remove(t);return e}clear(){for(const e of this.transitions.keys())this.remove(e)}}function g3(s){const e=s[it];for(const t in e){const n=e[t],{validate:r}=n;if(r&&!r(s[t],n))throw new Error(`Invalid prop ${t}: ${s[t]}`)}}function _3(s,e){const t=Cl({newProps:s,oldProps:e,propTypes:s[it],ignoreProps:{data:null,updateTriggers:null,extensions:null,transitions:null}}),n=b3(s,e);let r=!1;return n||(r=y3(s,e)),{dataChanged:n,propsChanged:t,updateTriggersChanged:r,extensionsChanged:T3(s,e),transitionsChanged:m3(s,e)}}function m3(s,e){if(!s.transitions)return!1;const t={},n=s[it];let r=!1;for(const i in s.transitions){const o=n[i],a=o&&o.type;(a==="number"||a==="color"||a==="array")&&Tr(s[i],e[i],o)&&(t[i]=!0,r=!0)}return r?t:!1}function Cl({newProps:s,oldProps:e,ignoreProps:t={},propTypes:n={},triggerName:r="props"}){if(e===s)return!1;if(typeof s!="object"||s===null)return`${r} changed shallowly`;if(typeof e!="object"||e===null)return`${r} changed shallowly`;for(const i of Object.keys(s))if(!(i in t)){if(!(i in e))return`${r}.${i} added`;const o=Tr(s[i],e[i],n[i]);if(o)return`${r}.${i} ${o}`}for(const i of Object.keys(e))if(!(i in t)){if(!(i in s))return`${r}.${i} dropped`;if(!Object.hasOwnProperty.call(s,i)){const o=Tr(s[i],e[i],n[i]);if(o)return`${r}.${i} ${o}`}}return!1}function Tr(s,e,t){let n=t&&t.equal;return n&&!n(s,e,t)||!n&&(n=s&&e&&s.equals,n&&!n.call(s,e))?"changed deeply":!n&&e!==s?"changed shallowly":null}function b3(s,e){if(e===null)return"oldProps is null, initial diff";let t=!1;const{dataComparator:n,_dataDiff:r}=s;return n?n(s.data,e.data)||(t="Data comparator detected a change"):s.data!==e.data&&(t="A new data container was supplied"),t&&r&&(t=r(s.data,e.data)||t),t}function y3(s,e){if(e===null)return{all:!0};if("all"in s.updateTriggers&&aa(s,e,"all"))return{all:!0};const t={};let n=!1;for(const r in s.updateTriggers)r!=="all"&&aa(s,e,r)&&(t[r]=!0,n=!0);return n?t:!1}function T3(s,e){if(e===null)return!0;const t=e.extensions,{extensions:n}=s;if(n===t)return!1;if(!t||!n||n.length!==t.length)return!0;for(let r=0;r<n.length;r++)if(!n[r].equals(t[r]))return!0;return!1}function aa(s,e,t){let n=s.updateTriggers[t];n=n??{};let r=e.updateTriggers[t];return r=r??{},Cl({oldProps:r,newProps:n,triggerName:t})}const w3="count(): argument not an object",v3="count(): argument not a container";function A3(s){if(!E3(s))throw new Error(w3);if(typeof s.count=="function")return s.count();if(Number.isFinite(s.size))return s.size;if(Number.isFinite(s.length))return s.length;if(x3(s))return Object.keys(s).length;throw new Error(v3)}function x3(s){return s!==null&&typeof s=="object"&&s.constructor===Object}function E3(s){return s!==null&&typeof s=="object"}function ca(s,e){if(!e)return s;const t={...s,...e};if("defines"in e&&(t.defines={...s.defines,...e.defines}),"modules"in e&&(t.modules=(s.modules||[]).concat(e.modules),e.modules.some(n=>n.name==="project64"))){const n=t.modules.findIndex(r=>r.name==="project32");n>=0&&t.modules.splice(n,1)}if("inject"in e)if(!s.inject)t.inject=e.inject;else{const n={...s.inject};for(const r in e.inject)n[r]=(n[r]||"")+e.inject[r];t.inject=n}return t}const S3={minFilter:"linear",mipmapFilter:"linear",magFilter:"linear",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge"},wr={};function R3(s,e,t,n){if(t instanceof z)return t;t.constructor&&t.constructor.name!=="Object"&&(t={data:t});let r=null;t.compressed&&(r={minFilter:"linear",mipmapFilter:t.data.length>1?"nearest":"linear"});const i=e.createTexture({...t,sampler:{...S3,...r,...n},mipmaps:!0});return wr[i.id]=s,i}function I3(s,e){!e||!(e instanceof z)||wr[e.id]===s&&(e.delete(),delete wr[e.id])}const C3={boolean:{validate(s,e){return!0},equal(s,e,t){return!!s==!!e}},number:{validate(s,e){return Number.isFinite(s)&&(!("max"in e)||s<=e.max)&&(!("min"in e)||s>=e.min)}},color:{validate(s,e){return e.optional&&!s||vr(s)&&(s.length===3||s.length===4)},equal(s,e,t){return Re(s,e,1)}},accessor:{validate(s,e){const t=en(s);return t==="function"||t===en(e.value)},equal(s,e,t){return typeof e=="function"?!0:Re(s,e,1)}},array:{validate(s,e){return e.optional&&!s||vr(s)},equal(s,e,t){const{compare:n}=t,r=Number.isInteger(n)?n:n?1:0;return n?Re(s,e,r):s===e}},object:{equal(s,e,t){if(t.ignore)return!0;const{compare:n}=t,r=Number.isInteger(n)?n:n?1:0;return n?Re(s,e,r):s===e}},function:{validate(s,e){return e.optional&&!s||typeof s=="function"},equal(s,e,t){return!t.compare&&t.ignore!==!1||s===e}},data:{transform:(s,e,t)=>{if(!s)return s;const{dataTransform:n}=t.props;return n?n(s):typeof s.shape=="string"&&s.shape.endsWith("-table")&&Array.isArray(s.data)?s.data:s}},image:{transform:(s,e,t)=>{const n=t.context;return!n||!n.device?null:R3(t.id,n.device,s,{...e.parameters,...t.props.textureParameters})},release:(s,e,t)=>{I3(t.id,s)}}};function P3(s){const e={},t={},n={};for(const[r,i]of Object.entries(s)){const o=i?.deprecatedFor;if(o)n[r]=Array.isArray(o)?o:[o];else{const a=M3(r,i);e[r]=a,t[r]=a.value}}return{propTypes:e,defaultProps:t,deprecatedProps:n}}function M3(s,e){switch(en(e)){case"object":return jt(s,e);case"array":return jt(s,{type:"array",value:e,compare:!1});case"boolean":return jt(s,{type:"boolean",value:e});case"number":return jt(s,{type:"number",value:e});case"function":return jt(s,{type:"function",value:e,compare:!0});default:return{name:s,type:"unknown",value:e}}}function jt(s,e){return"type"in e?{name:s,...C3[e.type],...e}:"value"in e?{name:s,type:en(e.value),...e}:{name:s,type:"object",value:e}}function vr(s){return Array.isArray(s)||ArrayBuffer.isView(s)}function en(s){return vr(s)?"array":s===null?"null":typeof s}function O3(s,e){let t;for(let i=e.length-1;i>=0;i--){const o=e[i];"extensions"in o&&(t=o.extensions)}const n=Ar(s.constructor,t),r=Object.create(n);r[Js]=s,r[ut]={},r[qe]={};for(let i=0;i<e.length;++i){const o=e[i];for(const a in o)r[a]=o[a]}return Object.freeze(r),r}const k3="_mergedDefaultProps";function Ar(s,e){if(!(s instanceof hn.constructor))return{};let t=k3;if(e)for(const r of e){const i=r.constructor;i&&(t+=`:${i.extensionName||i.name}`)}const n=Pl(s,t);return n||(s[t]=N3(s,e||[]))}function N3(s,e){if(!s.prototype)return null;const n=Object.getPrototypeOf(s),r=Ar(n),i=Pl(s,"defaultProps")||{},o=P3(i),a=Object.assign(Object.create(null),r,o.defaultProps),c=Object.assign(Object.create(null),r?.[it],o.propTypes),l=Object.assign(Object.create(null),r?.[Ln],o.deprecatedProps);for(const u of e){const h=Ar(u.constructor);h&&(Object.assign(a,h),Object.assign(c,h[it]),Object.assign(l,h[Ln]))}return D3(a,s),B3(a,c),F3(a,l),a[it]=c,a[Ln]=l,e.length===0&&!ai(s,"_propTypes")&&(s._propTypes=c),a}function D3(s,e){const t=L3(e);Object.defineProperties(s,{id:{writable:!0,value:t}})}function F3(s,e){for(const t in e)Object.defineProperty(s,t,{enumerable:!1,set(n){const r=`${this.id}: ${t}`;for(const i of e[t])ai(this,i)||(this[i]=n);Y.deprecated(r,e[t].join("/"))()}})}function B3(s,e){const t={},n={};for(const r in e){const i=e[r],{name:o,value:a}=i;i.async&&(t[o]=a,n[o]=U3(o))}s[Ct]=t,s[ut]={},Object.defineProperties(s,n)}function U3(s){return{enumerable:!0,set(e){typeof e=="string"||e instanceof Promise||yl(e)?this[ut][s]=e:this[qe][s]=e},get(){if(this[qe]){if(s in this[qe])return this[qe][s]||this[Ct][s];if(s in this[ut]){const e=this[Js]&&this[Js].internalState;if(e&&e.hasAsyncProp(s))return e.getAsyncProp(s)||this[Ct][s]}}return this[Ct][s]}}}function ai(s,e){return Object.prototype.hasOwnProperty.call(s,e)}function Pl(s,e){return ai(s,e)&&s[e]}function L3(s){const e=s.componentName;return e||Y.warn(`${s.name}.componentName not specified`)(),e||s.name}let V3=0;class hn{constructor(...e){this.props=O3(this,e),this.id=this.props.id,this.count=V3++}clone(e){const{props:t}=this,n={};for(const r in t[Ct])r in t[qe]?n[r]=t[qe][r]:r in t[ut]&&(n[r]=t[ut][r]);return new this.constructor({...t,...n,...e})}}hn.componentName="Component";hn.defaultProps={};const $3=Object.freeze({});class W3{constructor(e){this.component=e,this.asyncProps={},this.onAsyncPropUpdated=()=>{},this.oldProps=null,this.oldAsyncProps=null}finalize(){for(const e in this.asyncProps){const t=this.asyncProps[e];t&&t.type&&t.type.release&&t.type.release(t.resolvedValue,t.type,this.component)}this.asyncProps={},this.component=null,this.resetOldProps()}getOldProps(){return this.oldAsyncProps||this.oldProps||$3}resetOldProps(){this.oldAsyncProps=null,this.oldProps=this.component?this.component.props:null}hasAsyncProp(e){return e in this.asyncProps}getAsyncProp(e){const t=this.asyncProps[e];return t&&t.resolvedValue}isAsyncPropLoading(e){if(e){const t=this.asyncProps[e];return!!(t&&t.pendingLoadCount>0&&t.pendingLoadCount!==t.resolvedLoadCount)}for(const t in this.asyncProps)if(this.isAsyncPropLoading(t))return!0;return!1}reloadAsyncProp(e,t){this._watchPromise(e,Promise.resolve(t))}setAsyncProps(e){this.component=e[Js]||this.component;const t=e[qe]||{},n=e[ut]||e,r=e[Ct]||{};for(const i in t){const o=t[i];this._createAsyncPropData(i,r[i]),this._updateAsyncProp(i,o),t[i]=this.getAsyncProp(i)}for(const i in n){const o=n[i];this._createAsyncPropData(i,r[i]),this._updateAsyncProp(i,o)}}_fetch(e,t){return null}_onResolve(e,t){}_onError(e,t){}_updateAsyncProp(e,t){if(this._didAsyncInputValueChange(e,t)){if(typeof t=="string"&&(t=this._fetch(e,t)),t instanceof Promise){this._watchPromise(e,t);return}if(yl(t)){this._resolveAsyncIterable(e,t);return}this._setPropValue(e,t)}}_freezeAsyncOldProps(){if(!this.oldAsyncProps&&this.oldProps){this.oldAsyncProps=Object.create(this.oldProps);for(const e in this.asyncProps)Object.defineProperty(this.oldAsyncProps,e,{enumerable:!0,value:this.oldProps[e]})}}_didAsyncInputValueChange(e,t){const n=this.asyncProps[e];return t===n.resolvedValue||t===n.lastValue?!1:(n.lastValue=t,!0)}_setPropValue(e,t){this._freezeAsyncOldProps();const n=this.asyncProps[e];n&&(t=this._postProcessValue(n,t),n.resolvedValue=t,n.pendingLoadCount++,n.resolvedLoadCount=n.pendingLoadCount)}_setAsyncPropValue(e,t,n){const r=this.asyncProps[e];r&&n>=r.resolvedLoadCount&&t!==void 0&&(this._freezeAsyncOldProps(),r.resolvedValue=t,r.resolvedLoadCount=n,this.onAsyncPropUpdated(e,t))}_watchPromise(e,t){const n=this.asyncProps[e];if(n){n.pendingLoadCount++;const r=n.pendingLoadCount;t.then(i=>{this.component&&(i=this._postProcessValue(n,i),this._setAsyncPropValue(e,i,r),this._onResolve(e,i))}).catch(i=>{this._onError(e,i)})}}async _resolveAsyncIterable(e,t){if(e!=="data"){this._setPropValue(e,t);return}const n=this.asyncProps[e];if(!n)return;n.pendingLoadCount++;const r=n.pendingLoadCount;let i=[],o=0;for await(const a of t){if(!this.component)return;const{dataTransform:c}=this.component.props;c?i=c(a,i):i=i.concat(a),Object.defineProperty(i,"__diff",{enumerable:!1,value:[{startRow:o,endRow:i.length}]}),o=i.length,this._setAsyncPropValue(e,i,r)}this._onResolve(e,i)}_postProcessValue(e,t){const n=e.type;return n&&this.component&&(n.release&&n.release(e.resolvedValue,n,this.component),n.transform)?n.transform(t,n,this.component):t}_createAsyncPropData(e,t){if(!this.asyncProps[e]){const r=this.component&&this.component.props[it];this.asyncProps[e]={type:r&&r[e],lastValue:null,resolvedValue:t,pendingLoadCount:0,resolvedLoadCount:0}}}}class j3 extends W3{constructor({attributeManager:e,layer:t}){super(t),this.attributeManager=e,this.needsRedraw=!0,this.needsUpdate=!0,this.subLayers=null,this.usesPickingColorCache=!1}get layer(){return this.component}_fetch(e,t){const n=this.layer,r=n?.props.fetch;return r?r(t,{propName:e,layer:n}):super._fetch(e,t)}_onResolve(e,t){const n=this.layer;if(n){const r=n.props.onDataLoad;e==="data"&&r&&r(t,{propName:e,layer:n})}}_onError(e,t){const n=this.layer;n&&n.raiseError(t,`loading ${e} of ${this.layer}`)}}const H3="layer.changeFlag",z3="layer.initialize",X3="layer.update",Y3="layer.finalize",q3="layer.matched",la=2**24-1,K3=Object.freeze([]),Z3=us(({oldViewport:s,viewport:e})=>s.equals(e));let xe=new Uint8ClampedArray(0);const Q3={data:{type:"data",value:K3,async:!0},dataComparator:{type:"function",value:null,optional:!0},_dataDiff:{type:"function",value:s=>s&&s.__diff,optional:!0},dataTransform:{type:"function",value:null,optional:!0},onDataLoad:{type:"function",value:null,optional:!0},onError:{type:"function",value:null,optional:!0},fetch:{type:"function",value:(s,{propName:e,layer:t,loaders:n,loadOptions:r,signal:i})=>{const{resourceManager:o}=t.context;r=r||t.getLoadOptions(),n=n||t.props.loaders,i&&(r={...r,fetch:{...r?.fetch,signal:i}});let a=o.contains(s);return!a&&!r&&(o.add({resourceId:s,data:Yn(s,n),persistent:!1}),a=!0),a?o.subscribe({resourceId:s,onChange:c=>t.internalState?.reloadAsyncProp(e,c),consumerId:t.id,requestId:e}):Yn(s,n,r)}},updateTriggers:{},visible:!0,pickable:!1,opacity:{type:"number",min:0,max:1,value:1},operation:"draw",onHover:{type:"function",value:null,optional:!0},onClick:{type:"function",value:null,optional:!0},onDragStart:{type:"function",value:null,optional:!0},onDrag:{type:"function",value:null,optional:!0},onDragEnd:{type:"function",value:null,optional:!0},coordinateSystem:W.DEFAULT,coordinateOrigin:{type:"array",value:[0,0,0],compare:!0},modelMatrix:{type:"array",value:null,compare:!0,optional:!0},wrapLongitude:!1,positionFormat:"XYZ",colorFormat:"RGBA",parameters:{type:"object",value:{},optional:!0,compare:2},loadOptions:{type:"object",value:null,optional:!0,ignore:!0},transitions:null,extensions:[],loaders:{type:"array",value:[],optional:!0,ignore:!0},getPolygonOffset:{type:"function",value:({layerIndex:s})=>[0,-s*100]},highlightedObjectIndex:null,autoHighlight:!1,highlightColor:{type:"accessor",value:[0,0,128,128]}};class Ml extends hn{constructor(){super(...arguments),this.internalState=null,this.lifecycle=Tt.NO_STATE,this.parent=null}static get componentName(){return Object.prototype.hasOwnProperty.call(this,"layerName")?this.layerName:""}get root(){let e=this;for(;e.parent;)e=e.parent;return e}toString(){return`${this.constructor.layerName||this.constructor.name}({id: '${this.props.id}'})`}project(e){ue(this.internalState);const t=this.internalState.viewport||this.context.viewport,n=Xc(e,{viewport:t,modelMatrix:this.props.modelMatrix,coordinateOrigin:this.props.coordinateOrigin,coordinateSystem:this.props.coordinateSystem}),[r,i,o]=Wc(n,t.pixelProjectionMatrix);return e.length===2?[r,i]:[r,i,o]}unproject(e){return ue(this.internalState),(this.internalState.viewport||this.context.viewport).unproject(e)}projectPosition(e,t){ue(this.internalState);const n=this.internalState.viewport||this.context.viewport;return xm(e,{viewport:n,modelMatrix:this.props.modelMatrix,coordinateOrigin:this.props.coordinateOrigin,coordinateSystem:this.props.coordinateSystem,...t})}get isComposite(){return!1}get isDrawable(){return!0}setState(e){this.setChangeFlags({stateChanged:!0}),Object.assign(this.state,e),this.setNeedsRedraw()}setNeedsRedraw(){this.internalState&&(this.internalState.needsRedraw=!0)}setNeedsUpdate(){this.internalState&&(this.context.layerManager.setNeedsUpdate(String(this)),this.internalState.needsUpdate=!0)}get isLoaded(){return this.internalState?!this.internalState.isAsyncPropLoading():!1}get wrapLongitude(){return this.props.wrapLongitude}isPickable(){return this.props.pickable&&this.props.visible}getModels(){const e=this.state;return e&&(e.models||e.model&&[e.model])||[]}setShaderModuleProps(...e){for(const t of this.getModels())t.shaderInputs.setProps(...e)}getAttributeManager(){return this.internalState&&this.internalState.attributeManager}getCurrentLayer(){return this.internalState&&this.internalState.layer}getLoadOptions(){return this.props.loadOptions}use64bitPositions(){const{coordinateSystem:e}=this.props;return e===W.DEFAULT||e===W.LNGLAT||e===W.CARTESIAN}onHover(e,t){return this.props.onHover&&this.props.onHover(e,t)||!1}onClick(e,t){return this.props.onClick&&this.props.onClick(e,t)||!1}nullPickingColor(){return[0,0,0]}encodePickingColor(e,t=[]){return t[0]=e+1&255,t[1]=e+1>>8&255,t[2]=e+1>>8>>8&255,t}decodePickingColor(e){ue(e instanceof Uint8Array);const[t,n,r]=e;return t+n*256+r*65536-1}getNumInstances(){return Number.isFinite(this.props.numInstances)?this.props.numInstances:this.state&&this.state.numInstances!==void 0?this.state.numInstances:A3(this.props.data)}getStartIndices(){return this.props.startIndices?this.props.startIndices:this.state&&this.state.startIndices?this.state.startIndices:null}getBounds(){return this.getAttributeManager()?.getBounds(["positions","instancePositions"])}getShaders(e){e=ca(e,{disableWarnings:!0,modules:this.context.defaultShaderModules});for(const t of this.props.extensions)e=ca(e,t.getShaders.call(this,t));return e}shouldUpdateState(e){return e.changeFlags.propsOrDataChanged}updateState(e){const t=this.getAttributeManager(),{dataChanged:n}=e.changeFlags;if(n&&t)if(Array.isArray(n))for(const r of n)t.invalidateAll(r);else t.invalidateAll();if(t){const{props:r}=e,i=this.internalState.hasPickingBuffer,o=Number.isInteger(r.highlightedObjectIndex)||r.pickable||r.extensions.some(a=>a.getNeedsPickingBuffer.call(this,a));if(i!==o){this.internalState.hasPickingBuffer=o;const{pickingColors:a,instancePickingColors:c}=t.attributes,l=a||c;l&&(o&&l.constant&&(l.constant=!1,t.invalidate(l.id)),!l.value&&!o&&(l.constant=!0,l.value=[0,0,0]))}}}finalizeState(e){for(const n of this.getModels())n.destroy();const t=this.getAttributeManager();t&&t.finalize(),this.context&&this.context.resourceManager.unsubscribe({consumerId:this.id}),this.internalState&&(this.internalState.uniformTransitions.clear(),this.internalState.finalize())}draw(e){for(const t of this.getModels())t.draw(e.renderPass)}getPickingInfo({info:e,mode:t,sourceLayer:n}){const{index:r}=e;return r>=0&&Array.isArray(this.props.data)&&(e.object=this.props.data[r]),e}raiseError(e,t){t&&(e=new Error(`${t}: ${e.message}`,{cause:e})),this.props.onError?.(e)||this.context?.onError?.(e,this)}getNeedsRedraw(e={clearRedrawFlags:!1}){return this._getNeedsRedraw(e)}needsUpdate(){return this.internalState?this.internalState.needsUpdate||this.hasUniformTransition()||this.shouldUpdateState(this._getUpdateParams()):!1}hasUniformTransition(){return this.internalState?.uniformTransitions.active||!1}activateViewport(e){if(!this.internalState)return;const t=this.internalState.viewport;this.internalState.viewport=e,(!t||!Z3({oldViewport:t,viewport:e}))&&(this.setChangeFlags({viewportChanged:!0}),this.isComposite?this.needsUpdate()&&this.setNeedsUpdate():this._update())}invalidateAttribute(e="all"){const t=this.getAttributeManager();t&&(e==="all"?t.invalidateAll():t.invalidate(e))}updateAttributes(e){let t=!1;for(const n in e)e[n].layoutChanged()&&(t=!0);for(const n of this.getModels())this._setModelAttributes(n,e,t)}_updateAttributes(){const e=this.getAttributeManager();if(!e)return;const t=this.props,n=this.getNumInstances(),r=this.getStartIndices();e.update({data:t.data,numInstances:n,startIndices:r,props:t,transitions:t.transitions,buffers:t.data.attributes,context:this});const i=e.getChangedAttributes({clearChangedFlags:!0});this.updateAttributes(i)}_updateAttributeTransition(){const e=this.getAttributeManager();e&&e.updateTransition()}_updateUniformTransition(){const{uniformTransitions:e}=this.internalState;if(e.active){const t=e.update(),n=Object.create(this.props);for(const r in t)Object.defineProperty(n,r,{value:t[r]});return n}return this.props}calculateInstancePickingColors(e,{numInstances:t}){if(e.constant)return;const n=Math.floor(xe.length/4);if(this.internalState.usesPickingColorCache=!0,n<t){t>la&&Y.warn("Layer has too many data objects. Picking might not be able to distinguish all objects.")(),xe=is.allocate(xe,t,{size:4,copy:!0,maxCount:Math.max(t,la)});const r=Math.floor(xe.length/4),i=[0,0,0];for(let o=n;o<r;o++)this.encodePickingColor(o,i),xe[o*4+0]=i[0],xe[o*4+1]=i[1],xe[o*4+2]=i[2],xe[o*4+3]=0}e.value=xe.subarray(0,t*4)}_setModelAttributes(e,t,n=!1){if(!Object.keys(t).length)return;if(n){const a=this.getAttributeManager();e.setBufferLayout(a.getBufferLayouts(e)),t=a.getAttributes()}const r=e.userData?.excludeAttributes||{},i={},o={};for(const a in t){if(r[a])continue;const c=t[a].getValue();for(const l in c){const u=c[l];u instanceof q?t[a].settings.isIndexed?e.setIndexBuffer(u):i[l]=u:u&&(o[l]=u)}}e.setAttributes(i),e.setConstantAttributes(o)}disablePickingIndex(e){const t=this.props.data;if(!("attributes"in t)){this._disablePickingIndex(e);return}const{pickingColors:n,instancePickingColors:r}=this.getAttributeManager().attributes,i=n||r,o=i&&t.attributes&&t.attributes[i.id];if(o&&o.value){const a=o.value,c=this.encodePickingColor(e);for(let l=0;l<t.length;l++){const u=i.getVertexOffset(l);a[u]===c[0]&&a[u+1]===c[1]&&a[u+2]===c[2]&&this._disablePickingIndex(l)}}else this._disablePickingIndex(e)}_disablePickingIndex(e){const{pickingColors:t,instancePickingColors:n}=this.getAttributeManager().attributes,r=t||n;if(!r)return;const i=r.getVertexOffset(e),o=r.getVertexOffset(e+1);r.buffer.write(new Uint8Array(o-i),i)}restorePickingColors(){const{pickingColors:e,instancePickingColors:t}=this.getAttributeManager().attributes,n=e||t;n&&(this.internalState.usesPickingColorCache&&n.value.buffer!==xe.buffer&&(n.value=xe.subarray(0,n.value.length)),n.updateSubBuffer({startOffset:0}))}_initialize(){ue(!this.internalState),ue(Number.isFinite(this.props.coordinateSystem)),fe(z3,this);const e=this._getAttributeManager();e&&e.addInstanced({instancePickingColors:{type:"uint8",size:4,noAlloc:!0,update:this.calculateInstancePickingColors}}),this.internalState=new j3({attributeManager:e,layer:this}),this._clearChangeFlags(),this.state={},Object.defineProperty(this.state,"attributeManager",{get:()=>(Y.deprecated("layer.state.attributeManager","layer.getAttributeManager()")(),e)}),this.internalState.uniformTransitions=new p3(this.context.timeline),this.internalState.onAsyncPropUpdated=this._onAsyncPropUpdated.bind(this),this.internalState.setAsyncProps(this.props),this.initializeState(this.context);for(const t of this.props.extensions)t.initializeState.call(this,this.context,t);this.setChangeFlags({dataChanged:"init",propsChanged:"init",viewportChanged:!0,extensionsChanged:!0}),this._update()}_transferState(e){fe(q3,this,this===e);const{state:t,internalState:n}=e;this!==e&&(this.internalState=n,this.state=t,this.internalState.setAsyncProps(this.props),this._diffProps(this.props,this.internalState.getOldProps()))}_update(){const e=this.needsUpdate();if(fe(X3,this,e),!e)return;const t=this.props,n=this.context,r=this.internalState,i=n.viewport,o=this._updateUniformTransition();r.propsInTransition=o,n.viewport=r.viewport||i,this.props=o;try{const a=this._getUpdateParams(),c=this.getModels();if(n.device)this.updateState(a);else try{this.updateState(a)}catch{}for(const u of this.props.extensions)u.updateState.call(this,a,u);this.setNeedsRedraw(),this._updateAttributes();const l=this.getModels()[0]!==c[0];this._postUpdate(a,l)}finally{n.viewport=i,this.props=t,this._clearChangeFlags(),r.needsUpdate=!1,r.resetOldProps()}}_finalize(){fe(Y3,this),this.finalizeState(this.context);for(const e of this.props.extensions)e.finalizeState.call(this,this.context,e)}_drawLayer({renderPass:e,shaderModuleProps:t=null,uniforms:n={},parameters:r={}}){this._updateAttributeTransition();const i=this.props,o=this.context;this.props=this.internalState.propsInTransition||i;try{t&&this.setShaderModuleProps(t);const{getPolygonOffset:a}=this.props,c=a&&a(n)||[0,0];o.device instanceof Rt&&o.device.setParametersWebGL({polygonOffset:c});for(const l of this.getModels())l.device.type==="webgpu"?l.setParameters({...l.parameters,...r}):l.setParameters(r);if(o.device instanceof Rt)o.device.withParametersWebGL(r,()=>{const l={renderPass:e,shaderModuleProps:t,uniforms:n,parameters:r,context:o};for(const u of this.props.extensions)u.draw.call(this,l,u);this.draw(l)});else{const l={renderPass:e,shaderModuleProps:t,uniforms:n,parameters:r,context:o};for(const u of this.props.extensions)u.draw.call(this,l,u);this.draw(l)}}finally{this.props=i}}getChangeFlags(){return this.internalState?.changeFlags}setChangeFlags(e){if(!this.internalState)return;const{changeFlags:t}=this.internalState;for(const r in e)if(e[r]){let i=!1;switch(r){case"dataChanged":const o=e[r],a=t[r];o&&Array.isArray(a)&&(t.dataChanged=Array.isArray(o)?a.concat(o):o,i=!0);default:t[r]||(t[r]=e[r],i=!0)}i&&fe(H3,this,r,e)}const n=!!(t.dataChanged||t.updateTriggersChanged||t.propsChanged||t.extensionsChanged);t.propsOrDataChanged=n,t.somethingChanged=n||t.viewportChanged||t.stateChanged}_clearChangeFlags(){this.internalState.changeFlags={dataChanged:!1,propsChanged:!1,updateTriggersChanged:!1,viewportChanged:!1,stateChanged:!1,extensionsChanged:!1,propsOrDataChanged:!1,somethingChanged:!1}}_diffProps(e,t){const n=_3(e,t);if(n.updateTriggersChanged)for(const r in n.updateTriggersChanged)n.updateTriggersChanged[r]&&this.invalidateAttribute(r);if(n.transitionsChanged)for(const r in n.transitionsChanged)this.internalState.uniformTransitions.add(r,t[r],e[r],e.transitions?.[r]);return this.setChangeFlags(n)}validateProps(){g3(this.props)}updateAutoHighlight(e){this.props.autoHighlight&&!Number.isInteger(this.props.highlightedObjectIndex)&&this._updateAutoHighlight(e)}_updateAutoHighlight(e){const t={highlightedObjectColor:e.picked?e.color:null},{highlightColor:n}=this.props;e.picked&&typeof n=="function"&&(t.highlightColor=n(e)),this.setShaderModuleProps({picking:t}),this.setNeedsRedraw()}_getAttributeManager(){const e=this.context;return new l3(e.device,{id:this.props.id,stats:e.stats,timeline:e.timeline})}_postUpdate(e,t){const{props:n,oldProps:r}=e,i=this.state.model;i?.isInstanced&&i.setInstanceCount(this.getNumInstances());const{autoHighlight:o,highlightedObjectIndex:a,highlightColor:c}=n;if(t||r.autoHighlight!==o||r.highlightedObjectIndex!==a||r.highlightColor!==c){const l={};Array.isArray(c)&&(l.highlightColor=c),(t||r.autoHighlight!==o||a!==r.highlightedObjectIndex)&&(l.highlightedObjectColor=Number.isFinite(a)&&a>=0?this.encodePickingColor(a):null),this.setShaderModuleProps({picking:l})}}_getUpdateParams(){return{props:this.props,oldProps:this.internalState.getOldProps(),context:this.context,changeFlags:this.internalState.changeFlags}}_getNeedsRedraw(e){if(!this.internalState)return!1;let t=!1;t=t||this.internalState.needsRedraw&&this.id;const n=this.getAttributeManager(),r=n?n.getNeedsRedraw(e):!1;if(t=t||r,t)for(const i of this.props.extensions)i.onNeedsRedraw.call(this,i);return this.internalState.needsRedraw=this.internalState.needsRedraw&&!e.clearRedrawFlags,t}_onAsyncPropUpdated(){this._diffProps(this.props,this.internalState.getOldProps()),this.setNeedsUpdate()}}Ml.defaultProps=Q3;Ml.layerName="Layer";export{Jr as $,rm as A,Qs as B,hb as C,bl as D,it as E,fe as F,fw as G,Yn as H,DT as I,is as J,FT as K,zc as L,ws as M,q as N,Zr as O,me as P,Re as Q,ca as R,sw as S,xm as T,Ys as U,hs as V,Ft as W,Bt as X,l3 as Y,iw as Z,Wc as _,Zs as a,Dt as a0,M_ as a1,fr as a2,G3 as a3,tw as a4,lw as a5,N_ as a6,cw as a7,rt as a8,C_ as a9,Kr as aa,zs as ab,nr as ac,to as ad,pp as ae,D_ as af,B_ as ag,De as b,kp as c,nw as d,Yp as e,$c as f,el as g,pb as h,Ye as i,nb as j,tl as k,ew as l,hw as m,Ks as n,kn as o,Jc as p,Y as q,ue as r,rw as s,ls as t,ln as u,C as v,Ml as w,aw as x,uw as y,W as z};
