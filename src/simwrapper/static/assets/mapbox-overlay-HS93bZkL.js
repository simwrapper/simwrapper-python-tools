import{V as Y,M as x,f as W,a as $,b as H,P as J,s as I,c as K,l as Q,d as ee,t as te,e as ne,C as se,g as oe,h as ie,i as A,m as re,j as ae,W as le,k as ce,D as C,n as de,u as he,o as O,p as ue,q as P}from"./layer-T9N9JmIf.js";const m=Math.PI/180,F=180/Math.PI,E=6370972,y=256;function pe(){const t=y/E,e=Math.PI/180*y;return{unitsPerMeter:[t,t,t],unitsPerMeter2:[0,0,0],metersPerUnit:[1/t,1/t,1/t],unitsPerDegree:[e,e,t],unitsPerDegree2:[0,0,0],degreesPerUnit:[1/e,1/e,1/t]}}class fe extends Y{constructor(e={}){const{longitude:n=0,zoom:a=0,nearZMultiplier:i=.5,farZMultiplier:o=1,resolution:s=10}=e;let{latitude:r=0,height:l,altitude:c=1.5,fovy:d}=e;r=Math.max(Math.min(r,x),-x),l=l||1,d?c=W(d):d=$(c);const h=1/Math.PI/Math.cos(r*Math.PI/180),u=Math.pow(2,a)*h,f=e.nearZ??i,_=e.farZ??(c+y*2*u/l)*o,p=new H().lookAt({eye:[0,-c,0],up:[0,0,1]});p.rotateX(r*m),p.rotateZ(-n*m),p.scale(u/l),super({...e,height:l,viewMatrix:p,longitude:n,latitude:r,zoom:a,distanceScales:pe(),fovy:d,focalDistance:c,near:f,far:_}),this.scale=u,this.latitude=r,this.longitude=n,this.resolution=s}get projectionMode(){return J.GLOBE}getDistanceScales(){return this.distanceScales}getBounds(e={}){const n={targetZ:e.z||0},a=this.unproject([0,this.height/2],n),i=this.unproject([this.width/2,0],n),o=this.unproject([this.width,this.height/2],n),s=this.unproject([this.width/2,this.height],n);return o[0]<this.longitude&&(o[0]+=360),a[0]>this.longitude&&(a[0]-=360),[Math.min(a[0],o[0],i[0],s[0]),Math.min(a[1],o[1],i[1],s[1]),Math.max(a[0],o[0],i[0],s[0]),Math.max(a[1],o[1],i[1],s[1])]}unproject(e,{topLeft:n=!0,targetZ:a}={}){const[i,o,s]=e,r=n?o:this.height-o,{pixelUnprojectionMatrix:l}=this;let c;if(Number.isFinite(s))c=S(l,[i,r,s,1]);else{const f=S(l,[i,r,-1,1]),_=S(l,[i,r,1,1]),p=((a||0)/E+1)*y,g=I(K([],f,_)),v=I(f),b=I(_),z=4*((4*v*b-(g-v-b)**2)/16)/g,B=Math.sqrt(v-z),X=Math.sqrt(Math.max(0,p*p-z)),U=(B-X)/Math.sqrt(g);c=Q([],f,_,U)}const[d,h,u]=this.unprojectPosition(c);return Number.isFinite(s)?[d,h,u]:Number.isFinite(a)?[d,h,a]:[d,h]}projectPosition(e){const[n,a,i=0]=e,o=n*m,s=a*m,r=Math.cos(s),l=(i/E+1)*y;return[Math.sin(o)*r*l,-Math.cos(o)*r*l,Math.sin(s)*l]}unprojectPosition(e){const[n,a,i]=e,o=ee(e),s=Math.asin(i/o),l=Math.atan2(n,-a)*F,c=s*F,d=(o/y-1)*E;return[l,c,d]}projectFlat(e){return e}unprojectFlat(e){return e}panByPosition(e,n){const a=this.unproject(n);return{longitude:e[0]-a[0]+this.longitude,latitude:e[1]-a[1]+this.latitude}}}function S(t,e){const n=te([],e,t);return ne(n,n,1/n[3]),n}class _e extends ie{applyConstraints(e){const{maxZoom:n,minZoom:a,zoom:i}=e;e.zoom=A(i,a,n);const{longitude:o,latitude:s}=e;return(o<-180||o>180)&&(e.longitude=re(o+180,360)-180),e.latitude=A(s,-x,x),e}}class ge extends se{constructor(){super(...arguments),this.ControllerState=_e,this.transition={transitionDuration:300,transitionInterpolator:new oe(["longitude","latitude","zoom"])},this.dragMode="pan"}setProps(e){super.setProps(e),this.dragRotate=!1,this.touchRotate=!1}}class V extends ae{constructor(e={}){super(e)}getViewportType(e){return e.zoom>12?le:fe}get ControllerType(){return ge}}V.displayName="GlobeView";const k=512,ye=Math.PI/180;function T({map:t,gl:e,deck:n}){if(t.__deck)return t.__deck;const a=n?.props._customRender,i=n?.props.onLoad,o={...n?.props,_customRender:()=>{t.triggerRepaint(),a?.("")}};o.parameters={...j(t,!0),...o.parameters},o.views||(o.views=D(t));let s;return(!n||n.props.gl===e)&&(Object.assign(o,{gl:e,width:null,height:null,touchAction:"unset",viewState:M(t)}),n?.isInitialized?Z(n,t):o.onLoad=()=>{i?.(),Z(s,t)}),n?(s=n,n.setProps(o),n.userData.isExternal=!0):(s=new C(o),t.on("remove",()=>{N(t)})),s.userData.mapboxLayers=new Set,t.__deck=s,t.on("render",()=>{s.isInitialized&&Ee(s,t)}),s}function Z(t,e){const n=()=>{t.isInitialized?xe(t,e):e.off("move",n)};e.on("move",n)}function N(t){t.__deck?.finalize(),t.__deck=null}function j(t,e){const n=e?{depthWriteEnabled:!0,depthCompare:"less-equal",depthBias:0,blend:!0,blendColorSrcFactor:"src-alpha",blendColorDstFactor:"one-minus-src-alpha",blendAlphaSrcFactor:"one",blendAlphaDstFactor:"one-minus-src-alpha",blendColorOperation:"add",blendAlphaOperation:"add"}:{};return q(t)==="globe"&&(n.cullMode="back"),n}function ve(t,e){t.userData.mapboxLayers.add(e),R(t)}function Me(t,e){t.userData.mapboxLayers.delete(e),R(t)}function be(t,e){R(t)}function me(t,e,n,a){let{currentViewport:i}=t.userData,o=!1;i||(i=G(t,e,a),t.userData.currentViewport=i,o=!0),t.isInitialized&&t._drawLayers("mapbox-repaint",{viewports:[i],layerFilter:s=>(!t.props.layerFilter||t.props.layerFilter(s))&&(n.id===s.layer.id||s.layer.props.operation.includes("terrain")),clearStack:o,clearCanvas:!1})}function q(t){const e=t.getProjection?.(),n=e?.type||e?.name;if(n==="globe")return"globe";if(n&&n!=="mercator")throw new Error("Unsupported projection");return"mercator"}function D(t){return q(t)==="globe"?new V({id:"mapbox"}):new ce({id:"mapbox"})}function M(t){const{lng:e,lat:n}=t.getCenter(),a={longitude:(e+540)%360-180,latitude:n,zoom:t.getZoom(),bearing:t.getBearing(),pitch:t.getPitch(),padding:t.getPadding(),repeat:t.getRenderWorldCopies()};return t.getTerrain?.()&&we(t,a),a}function we(t,e){if(t.getFreeCameraOptions){const{position:n}=t.getFreeCameraOptions();if(!n||n.z===void 0)return;const a=t.transform.height,{longitude:i,latitude:o,pitch:s}=e,r=n.x*k,l=(1-n.y)*k,c=n.z*k,d=de([i,o]),h=r-d[0],u=l-d[1],f=Math.sqrt(h*h+u*u),_=s*ye,p=1.5*a,g=_<.001?p*Math.cos(_)/c:p*Math.sin(_)/f;e.zoom=Math.log2(g);const v=p*Math.cos(_)/g,b=c-v;e.position=[0,0,b/he(o)]}else typeof t.transform.elevation=="number"&&(e.position=[0,0,t.transform.elevation])}function G(t,e,n){const a=M(e),i=D(e);n&&(i.props.nearZMultiplier=.2);const o=n?.nearZ??e.transform._nearZ,s=n?.farZ??e.transform._farZ;return Number.isFinite(o)&&(a.nearZ=o/e.transform.height,a.farZ=s/e.transform.height),i.makeViewport({width:t.width,height:t.height,viewState:a})}function Ee(t,e){const{mapboxLayers:n,isExternal:a}=t.userData;if(a){const i=Array.from(n,d=>d.id),s=O(t.props.layers,Boolean).some(d=>d&&!i.includes(d.id));let r=t.getViewports();const l=r.findIndex(d=>d.id==="mapbox"),c=r.length>1||l<0;(s||c)&&(l>=0&&(r=r.slice(),r[l]=G(t,e)),t._drawLayers("mapbox-repaint",{viewports:r,layerFilter:d=>(!t.props.layerFilter||t.props.layerFilter(d))&&(d.viewport.id!=="mapbox"||!i.includes(d.layer.id)),clearCanvas:!1}))}t.userData.currentViewport=null}function xe(t,e){t.setProps({viewState:M(e)}),t.needsRedraw({clearRedrawFlags:!0})}function R(t){if(t.userData.isExternal)return;const e=[];t.userData.mapboxLayers.forEach(n=>{const a=n.props.type,i=new a(n.props);e.push(i)}),t.setProps({layers:e})}class De{constructor(e){if(!e.id)throw new Error("Layer must have an unique id");this.id=e.id,this.type="custom",this.renderingMode=e.renderingMode||"3d",this.slot=e.slot,this.map=null,this.deck=null,this.props=e}onAdd(e,n){this.map=e,this.deck=T({map:e,gl:n,deck:this.props.deck}),ve(this.deck,this)}onRemove(){this.deck&&Me(this.deck,this)}setProps(e){Object.assign(this.props,e,{id:this.id}),this.deck&&be(this.deck)}render(e,n){me(this.deck,this.map,this,n)}}const L="__UNDEFINED__";function w(t,e,n,a){if(!t||!e||!t.style||!t.style._loaded)return;const i=O(a,Boolean);if(n!==a){const r=O(n,Boolean),l=new Set(r.map(c=>c.id));for(const c of i)l.delete(c.id);for(const c of l)t.getLayer(c)&&t.removeLayer(c)}for(const r of i){const l=t.getLayer(r.id);l?(l.implementation||l).setProps(r.props):t.addLayer(new De({id:r.id,deck:e,slot:r.props.slot}),r.props.beforeId)}const o=t.style._order,s={};for(const r of i){let{beforeId:l}=r.props;(!l||!o.includes(l))&&(l=L),s[l]=s[l]||[],s[l].push(r.id)}for(const r in s){const l=s[r];let c=r===L?o.length:o.indexOf(r),d=r===L?void 0:r;for(let h=l.length-1;h>=0;h--){const u=l[h],f=o.indexOf(u);f!==c-1&&(t.moveLayer(u,d),f>c&&c++),c--,d=u}}}class Se{constructor(e){this._handleStyleChange=()=>{w(this._map,this._deck,this._props.layers,this._props.layers)},this._updateContainerSize=()=>{if(this._map&&this._container){const{clientWidth:i,clientHeight:o}=this._map.getContainer();Object.assign(this._container.style,{width:`${i}px`,height:`${o}px`})}},this._updateViewState=()=>{const i=this._deck,o=this._map;i&&o&&(i.setProps({views:this._props.views||D(o),viewState:M(o)}),i.isInitialized&&i.redraw())},this._handleMouseEvent=i=>{const o=this._deck;if(!o||!o.isInitialized)return;const s={type:i.type,offsetCenter:i.point,srcEvent:i},r=this._lastMouseDownPoint;switch(!i.point&&r&&(s.deltaX=i.originalEvent.clientX-r.clientX,s.deltaY=i.originalEvent.clientY-r.clientY,s.offsetCenter={x:r.x+s.deltaX,y:r.y+s.deltaY}),s.type){case"mousedown":o._onPointerDown(s),this._lastMouseDownPoint={...i.point,clientX:i.originalEvent.clientX,clientY:i.originalEvent.clientY};break;case"dragstart":s.type="panstart",o._onEvent(s);break;case"drag":s.type="panmove",o._onEvent(s);break;case"dragend":s.type="panend",o._onEvent(s);break;case"click":s.tapCount=1,o._onEvent(s);break;case"dblclick":s.type="click",s.tapCount=2,o._onEvent(s);break;case"mousemove":s.type="pointermove",o._onPointerMove(s);break;case"mouseout":s.type="pointerleave",o._onPointerMove(s);break;default:return}};const{interleaved:n=!1,...a}=e;this._interleaved=n,this._props=a}setProps(e){this._interleaved&&e.layers&&w(this._map,this._deck,this._props.layers,e.layers),Object.assign(this._props,e),this._deck&&this._map&&this._deck.setProps({...this._props,parameters:{...j(this._map,this._interleaved),...this._props.parameters}})}onAdd(e){return this._map=e,this._interleaved?this._onAddInterleaved(e):this._onAddOverlaid(e)}_onAddOverlaid(e){const n=document.createElement("div");return Object.assign(n.style,{position:"absolute",left:0,top:0,textAlign:"initial",pointerEvents:"none"}),this._container=n,this._deck=new C({...this._props,parent:n,parameters:{...j(e,!1),...this._props.parameters},views:this._props.views||D(e),viewState:M(e)}),e.on("resize",this._updateContainerSize),e.on("render",this._updateViewState),e.on("mousedown",this._handleMouseEvent),e.on("dragstart",this._handleMouseEvent),e.on("drag",this._handleMouseEvent),e.on("dragend",this._handleMouseEvent),e.on("mousemove",this._handleMouseEvent),e.on("mouseout",this._handleMouseEvent),e.on("click",this._handleMouseEvent),e.on("dblclick",this._handleMouseEvent),this._updateContainerSize(),n}_onAddInterleaved(e){const n=e.painter.context.gl;return n instanceof WebGLRenderingContext&&ue.warn("Incompatible basemap library. See: https://deck.gl/docs/api-reference/mapbox/overview#compatibility")(),this._deck=T({map:e,gl:n,deck:new C({...this._props,gl:n})}),e.on("styledata",this._handleStyleChange),w(e,this._deck,[],this._props.layers),document.createElement("div")}onRemove(){const e=this._map;e&&(this._interleaved?this._onRemoveInterleaved(e):this._onRemoveOverlaid(e)),this._deck=void 0,this._map=void 0,this._container=void 0}_onRemoveOverlaid(e){e.off("resize",this._updateContainerSize),e.off("render",this._updateViewState),e.off("mousedown",this._handleMouseEvent),e.off("dragstart",this._handleMouseEvent),e.off("drag",this._handleMouseEvent),e.off("dragend",this._handleMouseEvent),e.off("mousemove",this._handleMouseEvent),e.off("mouseout",this._handleMouseEvent),e.off("click",this._handleMouseEvent),e.off("dblclick",this._handleMouseEvent),this._deck?.finalize()}_onRemoveInterleaved(e){e.off("styledata",this._handleStyleChange),w(e,this._deck,this._props.layers,[]),N(e)}getDefaultPosition(){return"top-left"}pickObject(e){return P(this._deck),this._deck.pickObject(e)}pickMultipleObjects(e){return P(this._deck),this._deck.pickMultipleObjects(e)}pickObjects(e){return P(this._deck),this._deck.pickObjects(e)}finalize(){this._map&&this._map.removeControl(this)}getCanvas(){return this._map?this._interleaved?this._map.getCanvas():this._deck.getCanvas():null}}export{Se as M};
